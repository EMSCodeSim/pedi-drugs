
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pediatric Drug Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial; padding: 20px; background: #eef9ff; }
    select, input, button {
      padding: 10px; margin: 5px 5px 10px 0; font-size: 1rem;
    }
    .dropdown { border: 1px solid #007; margin-top: 10px; background: #f5faff; border-radius: 5px; }
    .dropdown-header { background: #007; color: white; padding: 10px; cursor: pointer; font-weight: bold; }
    .dropdown-body { display: none; padding: 10px; }
    .highlight { background-color: yellow; font-weight: bold; }
    .button-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
    .warning { color: red; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
<h2>Pediatric Drug Calculator</h2>

<label>Chief Complaint:</label>
<select id="complaintSelect"><option value="">-- Select Complaint --</option></select>

<br><label>Age:</label>
<input type="number" id="ageValue" placeholder="Age" />
<select id="ageUnit">
  <option value="years">Years</option>
  <option value="months">Months</option>
  <option value="days">Days</option>
</select>

<br><label>Weight:</label>
<input type="number" id="weightValue" />
<select id="weightUnit">
  <option value="kg">kg</option>
  <option value="lb">lb</option>
</select>

<div class="button-row">
  <button onclick="loadMedications()">Find Medications</button>
  <button onclick="loadAllMedications()">All Medications</button>
</div>

<div id="medList"></div>

<script>
let allMeds = {};
let editableConcentrations = {};

function getAgeInYears() {
  const val = parseFloat(document.getElementById("ageValue").value);
  const unit = document.getElementById("ageUnit").value;
  return unit === "months" ? val / 12 : unit === "days" ? val / 365 : val;
}

function getWeightInKg() {
  const weight = parseFloat(document.getElementById("weightValue").value);
  const unit = document.getElementById("weightUnit").value;
  return unit === "lb" ? weight / 2.2046 : weight;
}

function isMedInAgeRange(med, ageY) {
  const range = med["Age Range"]?.toLowerCase() || "";
  return range.includes("all") || (range.includes("adult") && ageY >= 18) || (range.includes("pediatric") && ageY < 18);
}

function loadMedications() {
  const ageY = getAgeInYears();
  const weightInKg = getWeightInKg();
  const complaint = document.getElementById("complaintSelect").value;
  if (!complaint || !allMeds[complaint]) return;
  const meds = allMeds[complaint].filter(med => isMedInAgeRange(med, ageY));
  displayMedications(meds, ageY, weightInKg);
}

function loadAllMedications() {
  const ageY = getAgeInYears();
  const weightInKg = getWeightInKg();
  const allMatches = [];
  for (let section in allMeds) {
    allMatches.push(...allMeds[section].filter(med => isMedInAgeRange(med, ageY)));
  }
  displayMedications(allMatches, ageY, weightInKg);
}

function displayMedications(meds, ageY, weightInKg) {
  const medList = document.getElementById("medList");
  medList.innerHTML = "";
  meds.forEach((med, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "dropdown";
    const header = document.createElement("div");
    header.className = "dropdown-header";
    header.textContent = `${med.Medication} (${med.Route})`;
    const body = document.createElement("div");
    body.className = "dropdown-body";

    let calcHtml = "";
    const concentrationKey = `${med.Medication}_${index}`;
    let concentration = editableConcentrations[concentrationKey] || med.Concentration;

    if (med.Dose?.toLowerCase().includes("mg/kg") || med.Dose?.toLowerCase().includes("mcg/kg")) {
      const perKg = parseFloat(med.Dose.match(/\d+\.?\d*/)[0]);
      const isMcg = med.Dose.includes("mcg");
      const doseMg = isMcg ? (perKg * weightInKg) / 1000 : perKg * weightInKg;
      const conc = parseFloat(concentration?.match(/\d+\.?\d*/));
      const volume = doseMg / conc;
      calcHtml = `
        <div><strong>Calculation:</strong><br>
        ${weightInKg.toFixed(1)} kg × ${perKg}${isMcg ? " mcg/kg" : " mg/kg"} = 
        <span class="highlight">${doseMg.toFixed(2)} mg</span><br>
        ${doseMg.toFixed(2)} mg ÷ ${conc} = 
        <span class="highlight">${volume.toFixed(2)} mL</span><br>
        <button onclick="editConcentration('${concentrationKey}', '${med.Concentration}')">Edit Concentration</button>
        <div class='warning'>⚠️ Confirm all calculations before administering medications.</div>
        </div>
      `;
    }

    body.innerHTML = `
      <strong>Indication:</strong> ${med.Indication}<br>
      <strong>Dose:</strong> ${med.Dose}<br>
      <strong>Concentration:</strong> <span id="conc_${concentrationKey}">${concentration}</span><br>
      <strong>Contraindication:</strong> ${med.Contraindication}<br>
      ${calcHtml}
    `;
    header.onclick = () => {
      body.style.display = body.style.display === "block" ? "none" : "block";
    };
    wrapper.appendChild(header);
    wrapper.appendChild(body);
    medList.appendChild(wrapper);
  });
}

function editConcentration(key, originalConc) {
  const newConc = prompt("Enter new concentration:", originalConc);
  if (newConc) {
    editableConcentrations[key] = newConc;
    loadMedications();
  }
}

fetch("./medications_by_complaint.json")
  .then(res => res.json())
  .then(data => {
    allMeds = data;
    const select = document.getElementById("complaintSelect");
    Object.keys(data).forEach(k => {
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = k;
      select.appendChild(opt);
    });
  });
</script>
</body>
</html>
