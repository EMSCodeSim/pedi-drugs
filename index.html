
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pediatric Drug Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial; padding: 20px; background: #eef9ff; }
    .dropdown { border: 1px solid #007; margin-top: 10px; background: #f5faff; border-radius: 5px; }
    .dropdown-header { background: #007; color: white; padding: 10px; cursor: pointer; font-weight: bold; }
    .dropdown-body { display: none; padding: 10px; }
    .highlight { background-color: yellow; font-weight: bold; }
  </style>
</head>
<body>
<h2>Pediatric Drug Calculator</h2>

<label for="complaintSelect">Chief Complaint:</label>
<select id="complaintSelect"></select>

<div>
  <input type="number" id="ageValue" placeholder="Age" />
  <select id="ageUnit">
    <option value="years">Years</option>
    <option value="months">Months</option>
    <option value="days">Days</option>
  </select>
</div>

<label>Weight:</label>
<div>
  <input type="number" id="weightValue" />
  <select id="weightUnit">
    <option value="kg">kg</option>
    <option value="lb">lb</option>
  </select>
  <select id="broselowColor" style="display:none;">
    <option value="3">Gray (3 kg)</option>
    <option value="5">Pink (5 kg)</option>
    <option value="8">Red (8 kg)</option>
    <option value="10">Purple (10 kg)</option>
    <option value="12">Yellow (12 kg)</option>
    <option value="14">White (14 kg)</option>
    <option value="18">Blue (18 kg)</option>
    <option value="22">Orange (22 kg)</option>
    <option value="26">Green (26 kg)</option>
    <option value="30">Lt Green (30 kg)</option>
  </select>
</div>

<button onclick="loadMedications()">Find Medications</button>
<div id="medList"></div>

<script>
let allMeds = {};

document.getElementById("ageValue").addEventListener("input", checkAgeForBroselow);
document.getElementById("ageUnit").addEventListener("change", checkAgeForBroselow);
document.getElementById("broselowColor").addEventListener("change", function() {
  document.getElementById("weightValue").value = this.value;
  document.getElementById("weightUnit").value = "kg";
});

function checkAgeForBroselow() {
  const age = parseFloat(document.getElementById("ageValue").value);
  const unit = document.getElementById("ageUnit").value;
  const ageY = unit === "months" ? age / 12 : unit === "days" ? age / 365 : age;
  document.getElementById("broselowColor").style.display = ageY <= 12 ? "inline-block" : "none";
}

function loadMedications() {
  const ageVal = parseFloat(document.getElementById("ageValue").value);
  const ageUnit = document.getElementById("ageUnit").value;
  const complaint = document.getElementById("complaintSelect").value;
  const weight = parseFloat(document.getElementById("weightValue").value);
  const weightUnit = document.getElementById("weightUnit").value;
  const weightInKg = weightUnit === "lb" ? weight / 2.2046 : weight;
  const ageY = ageUnit === "months" ? ageVal / 12 : ageUnit === "days" ? ageVal / 365 : ageVal;
  const medList = document.getElementById("medList");
  medList.innerHTML = "";

  if (!complaint || !allMeds[complaint]) {
    medList.innerHTML = "<div class='warning'>Please select a chief complaint and enter age.</div>";
    return;
  }

  const meds = allMeds[complaint].filter(med => {
    const range = med["Age Range"]?.toLowerCase() || "";
    return range.includes("all") || (range.includes("adult") && ageY >= 18) || (range.includes("pediatric") && ageY < 18);
  });

  meds.forEach(med => {
    const div = document.createElement("div");
    div.className = "dropdown";
    const header = document.createElement("div");
    header.className = "dropdown-header";
    header.textContent = `${med.Medication} (${med.Route})`;
    const body = document.createElement("div");
    body.className = "dropdown-body";

    let calcHtml = "";
    if (med.Dose?.toLowerCase().includes("mg/kg") || med.Dose?.toLowerCase().includes("mcg/kg")) {
      const perKg = parseFloat(med.Dose.match(/\d+\.?\d*/)[0]);
      const isMcg = med.Dose.includes("mcg");
      const doseMg = isMcg ? (perKg * weightInKg) / 1000 : perKg * weightInKg;
      const conc = parseFloat(med.Concentration?.match(/\d+\.?\d*/));
      const volume = doseMg / conc;
      calcHtml = `
        <br><strong>Calculation:</strong><br>
        ${weightInKg.toFixed(1)} kg ร ${perKg}${isMcg ? " mcg/kg" : " mg/kg"} = 
        <span class="highlight">${doseMg.toFixed(2)} mg</span><br>
        ${doseMg.toFixed(2)} mg รท ${conc} = 
        <span class="highlight">${volume.toFixed(2)} mL</span>
      `;
    }

    body.innerHTML = `
      <strong>Indication:</strong> ${med.Indication}<br>
      <strong>Dose:</strong> ${med.Dose}<br>
      <strong>Concentration:</strong> ${med.Concentration}<br>
      <strong>Contraindication:</strong> ${med.Contraindication}<br>
      ${calcHtml}
    `;
    header.onclick = () => {
      body.style.display = body.style.display === "block" ? "none" : "block";
    };
    div.appendChild(header);
    div.appendChild(body);
    medList.appendChild(div);
  });
}

fetch("./medications_by_complaint.json")
  .then(res => res.json())
  .then(data => {
    allMeds = data;
    const select = document.getElementById("complaintSelect");
    Object.keys(data).forEach(k => {
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = k;
      select.appendChild(opt);
    });
  });
</script>
</body>
</html>
