<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pediatric Drug Lookup (Denver Metro EMS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #eef9ff; padding: 20px; font-size: 1em; }
    label, select, input, button {
      margin: 10px 0; padding: 10px; font-size: 1em;
    }
    .input-group { display: flex; align-items: center; gap: 10px; }
    .input-short { width: 100px; }
    .section { background: #d9f0ff; padding: 15px; margin-top: 15px; border-left: 4px solid #0077cc; }
    .medication { background: #fff; margin-top: 10px; padding: 10px; border: 1px solid #ccc; }
    .medication h4 { margin: 0 0 5px 0; }
    .warning { color: red; font-weight: bold; }
  </style>
</head>
<body>

<h2>Pediatric Drug Lookup (Denver Metro EMS)</h2>

<label>Chief Complaint</label><br>
<select id="complaintSelect">
  <option value="">-- Select --</option>
</select>

<div class="input-group">
  <input type="number" id="ageValue" class="input-short" placeholder=" " min="0">
  <select id="ageUnit" class="input-short">
    <option value="years">Years</option>
    <option value="months">Months</option>
    <option value="days">Days</option>
  </select>
</div>

<label>Weight</label><br>
<div class="input-group">
  <input type="number" id="weightValue" class="input-short" placeholder="Auto-estimated" step="0.1">
  <select id="weightUnit" class="input-short">
    <option value="kg">kg</option>
    <option value="lb">lb</option>
  </select>
</div>

  <input type="number" id="ageValue" class="input-short" placeholder=" " min="0">
  <select id="ageUnit" class="input-short">
    <option value="years">Years</option>
    <option value="months">Months</option>
    <option value="days">Days</option>
  </select>
</div>

<button onclick="loadMedications()">Find Medications</button>

<div id="medList" class="section"></div>

<script>
let allMeds = {};

fetch("./medications_by_complaint_with_age_first.json")
  .then(res => res.json())
  .then(data => {
    allMeds = data;
    const complaintSelect = document.getElementById("complaintSelect");
    Object.keys(data).forEach(complaint => {
      const option = document.createElement("option");
      option.value = complaint;
      option.textContent = complaint;
      complaintSelect.appendChild(option);
    });
  })
  .catch(err => {
    document.getElementById("medList").innerHTML = "<div class='warning'>Failed to load medication data.</div>";
    console.error("JSON fetch error:", err);
  });

function convertAgeToYears(age, unit) {
  if (unit === "days") return age / 365;
  if (unit === "months") return age / 12;
  return age;
}

function loadMedications() {
  const complaint = document.getElementById("complaintSelect").value;
  const ageVal = parseFloat(document.getElementById("ageValue").value);
  const ageUnit = document.getElementById("ageUnit").value;
  const ageY = convertAgeToYears(ageVal || 0, ageUnit);
  const medList = document.getElementById("medList");
  medList.innerHTML = "";

  if (!complaint || !allMeds[complaint]) {
    medList.innerHTML = "<div class='warning'>Please select a chief complaint and enter age.</div>";
    return;
  }

  const matches = allMeds[complaint].filter(med => {
    const range = med.age_range.toLowerCase();
    return (
      range.includes("all") ||
      (range.includes("adult") && ageY >= 18) ||
      (range.includes("pediatric") && ageY < 18) ||
      (range.includes("<") && ageY < parseInt(range.match(/\d+/))) ||
      (range.includes(">") && ageY > parseInt(range.match(/\d+/))) ||
      (range.includes("-") && ageY >= parseInt(range.split("-")[0]) && ageY <= parseInt(range.split("-")[1]))
    );
  });

  if (matches.length === 0) {
    medList.innerHTML = "<div class='warning'>No medications found for this age and complaint.</div>";
    return;
  }

  matches.forEach(med => {
    const div = document.createElement("div");
    div.className = "medication";
    div.innerHTML = `
      <h4>${med.medication} (${med.route})</h4>
      <strong>Age Range:</strong> ${med.age_range}<br>
      <strong>Indication:</strong> ${med.indication}<br>
      <strong>Dose:</strong> ${med.dose}<br>
      <strong>Concentration:</strong> ${med.concentration}<br>
      <strong>Max Dose:</strong> ${med.max_dose}<br>
      <strong>Max Doses:</strong> ${med.max_doses}<br>
      <strong>Call-In:</strong> ${med.call_in}<br>
      <strong>Contraindication:</strong> ${med.contraindication}<br>
      ${med.drip_setup && med.drip_setup !== "N/A" ? `<strong>Drip Setup:</strong> ${med.drip_setup}` : ""}
    `;
    medList.appendChild(div);
  });
}

function estimateWeight(age, unit) {
  let kg;
  if (unit === "years") {
    kg = 2 * age + 8;
  } else if (unit === "months") {
    kg = (age / 2) + 4;
  } else {
    kg = (age / 365) * 10 + 3; // crude estimate for days
  }
  document.getElementById("weightValue").value = kg.toFixed(1);
}

document.getElementById("ageValue").addEventListener("input", () => {
  const age = parseFloat(document.getElementById("ageValue").value) || 0;
  const unit = document.getElementById("ageUnit").value;
  estimateWeight(age, unit);
});
document.getElementById("ageUnit").addEventListener("change", () => {
  const age = parseFloat(document.getElementById("ageValue").value) || 0;
  const unit = document.getElementById("ageUnit").value;
  estimateWeight(age, unit);
});

</script>

</body>
</html>
