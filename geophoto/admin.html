<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Instructor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{--bg:#0b0f14;--bg2:#0d121c;--panel:#0f1624;--text:#eaf2ff;--muted:#94a3b8;--edge:rgba(255,255,255,.12)}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(165deg,var(--bg2),var(--bg));color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(12,16,24,.75);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--edge)}
    .bar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .title{font-weight:900}
    main{max-width:1100px;margin:10px auto;padding:0 12px;display:grid;gap:12px}
    @media(min-width:900px){main{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 20%),linear-gradient(180deg,#0f1624,#0e1420);
      border:1px solid var(--edge);border-radius:16px;padding:12px}
    label{font-weight:700}
    .input,select{width:100%;padding:10px 12px;border-radius:12px;background:#0b1322;color:var(--text);
      border:1px solid var(--edge)}
    .btn{appearance:none;border:1px solid var(--edge);background:#132136;color:#fff;border-radius:12px;
      padding:10px 14px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{display:inline-block;border:1px solid var(--edge);border-radius:999px;padding:6px 10px;color:#d5e3ff;
      font-size:12px;margin-left:6px}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
    .thumb{border:1px solid var(--edge);border-radius:14px;overflow:hidden;cursor:pointer;background:#0d1526}
    .thumb .img{height:92px;display:grid;place-items:center}
    .thumb .img img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .img.noimg{background:#061321;color:#9fb3d9;font-weight:800}
    .thumb .label{position:absolute;inset:auto 8px 8px auto;background:rgba(0,0,0,.45);border-radius:8px;padding:2px 6px}
    .tcap{padding:8px 10px;font-size:12px;color:#d5e3ff}
    #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:99}
    #status{font-size:12px;color:#9fb3d9;margin-left:6px}
    .viewer{display:grid;gap:8px}
    .viewer .frame{aspect-ratio:16/9;background:#020a14;border:1px solid var(--edge);border-radius:14px;display:grid;place-items:center;overflow:hidden}
    .viewer .frame img{max-width:100%;max-height:100%;object-fit:contain}
  </style>
</head>
<body>
  <div id="errbar"></div>

  <header>
    <div class="bar">
      <div class="title">FireOps SIM — Instructor</div>
      <div class="pill" id="sessionBadge">session: default</div>
      <div class="pill" id="helloPill">hello: —</div>
      <div class="pill" id="status">idle</div>
    </div>
  </header>

  <main>
    <section class="card">
      <h3 style="margin:0">Choose Session & Scenario</h3>
      <div style="display:grid;gap:8px;margin-top:6px">
        <div>
          <label>Session</label>
          <input id="sessionInput" class="input" placeholder="e.g., station5" />
        </div>
        <div>
          <label>Scenario</label>
          <select id="scenarioSelect" class="input">
            <option value="">Loading…</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="reloadBtn">Reload Scenarios</button>
          <button class="btn" id="subscribeBtn">Subscribe</button>
          <button class="btn" id="clearBtn">Clear Users</button>
        </div>
      </div>

      <h4 style="margin:12px 0 6px">Slides</h4>
      <div id="thumbs" class="grid"></div>
    </section>

    <section class="card viewer">
      <h3 style="margin:0">Live Preview</h3>
      <div class="frame">
        <img id="currentImg" alt="current" />
      </div>
      <div id="currentCaption" style="min-height:1.4em;color:#dfe8ff"></div>
    </section>
  </main>

  <!-- Firebase (modules) -->
  <script type="module">
    /* ---------- tiny helpers ---------- */
    const $ = (id)=>document.getElementById(id);
    const say = (m)=>{ $('status').textContent = m; };
    const err = (m)=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; setTimeout(()=> b.style.display='none', 4200); };
    const qs = new URLSearchParams(location.search);

    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref as dbRef, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getStorage, ref as stRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",            // real bucket
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);
    const storage = getStorage(appFB, "gs://dailyquiz-d5279.appspot.com");
    const auth = getAuth(appFB);

    async function ensureAuthed(){
      if (auth.currentUser) return auth.currentUser;
      await signInAnonymously(auth);
      await new Promise(res => onAuthStateChanged(auth, u=>u && res(), { once:true }));
      return auth.currentUser;
    }

    /* ---------- Paths (must match viewer) ---------- */
    const FORCE_BUCKET = "dailyquiz-d5279.appspot.com";
    const manualPath = (s)=>`geophoto/manual/${s}/current`;
    const helloPath  = (s)=>`geophoto/manual/${s}/hello`;

    /* ---------- Normalize stops like the viewer ---------- */
    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      const arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>({
        title: s.title||s.name||'',
        caption: s.caption||s.text||'',
        imageURL: s.imageURL||s.url||s.photoURL||'',
        storagePath: s.storagePath||'',
        gsUri: s.gsUri||'',
        imageData: s.imageData||null
      }));
    }

    /* Convert various forms to a shareable URL for the viewer */
    async function toShareableURL(stop){
      if (stop.imageURL) return stop.imageURL;
      if (stop.gsUri){
        const ref = stRef(storage, stop.gsUri);
        return await getDownloadURL(ref);
      }
      if (stop.storagePath){
        const ref = stRef(storage, `gs://${FORCE_BUCKET}/${stop.storagePath}`);
        return await getDownloadURL(ref);
      }
      if (stop.imageData && stop.imageData.data){
        const fmt = (stop.imageData.format==='jpeg'||stop.imageData.format==='jpg')?'jpeg':'png';
        return `data:image/${fmt};base64,${stop.imageData.data}`;
      }
      return '';
    }

    /* ---------- UI wiring ---------- */
    const sessionInput   = $('sessionInput');
    const scenarioSelect = $('scenarioSelect');
    const thumbsEl       = $('thumbs');
    const currentImg     = $('currentImg');
    const currentCaption = $('currentCaption');
    const sessionBadge   = $('sessionBadge');
    const helloPill      = $('helloPill');

    // prefill session from ?session=
    sessionInput.value = (qs.get('session') || 'default').trim();

    async function loadScenarios(){
      await ensureAuthed();
      say('loading…');

      const out = [];

      // Prefer geophoto/scenarios, then scenarios (same as viewer)
      try{
        const a = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/geophoto/scenarios.json',{cache:'no-store'});
        if(a.ok){
          const ja = await a.json()||{};
          for(const [id,s] of Object.entries(ja)){ out.push({ id, ...(s||{}), stops: normalizeStops(s?.stops) }); }
        }
      }catch{}
      try{
        const b = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios.json',{cache:'no-store'});
        if(b.ok){
          const jb = await b.json()||{};
          for(const [id,s] of Object.entries(jb)){ if(!out.some(x=>x.id===id)){ out.push({ id, ...(s||{}), stops: normalizeStops(s?.stops) }); } }
        }
      }catch{}

      out.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

      // Populate dropdown
      scenarioSelect.innerHTML = '<option value="">Select a scenario…</option>';
      out.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id; o.textContent=sc.title || sc.name || '(untitled)';
        o.dataset.dispatch = sc.dispatch || sc.notes || '';
        o.dataset.stops = JSON.stringify(sc.stops||[]);
        scenarioSelect.appendChild(o);
      });

      say(out.length ? `loaded ${out.length}` : 'no scenarios');
      // preselect ?id
      const pre = qs.get('id'); if (pre && out.some(s=>s.id===pre)) scenarioSelect.value = pre;

      renderThumbs();
    }

    function renderThumbs(){
      thumbsEl.innerHTML = '';
      const id = scenarioSelect.value;
      if (!id) return;

      const opt = scenarioSelect.selectedOptions[0];
      const stops = JSON.parse(opt.dataset.stops||'[]');
      const dispatchText = (opt.dataset.dispatch||'').trim();

      // Dispatch slide card (no image)
      if (dispatchText){
        const d = document.createElement('div');
        d.className='thumb'; d.title='Dispatch';
        const imgWrap=document.createElement('div'); imgWrap.className='img noimg'; imgWrap.textContent='Dispatch';
        const cap = document.createElement('div'); cap.className='tcap'; cap.innerHTML=`<strong>Dispatch</strong><br>${dispatchText}`;
        d.appendChild(imgWrap); d.appendChild(cap);
        d.addEventListener('click', ()=> pushFrame(sessionInput.value.trim().toLowerCase()||'default', {title:'Dispatch', caption:dispatchText, imageURL:''}));
        thumbsEl.appendChild(d);
      }

      // Photo stops
      stops.forEach((st)=>{
        const card=document.createElement('div'); card.className='thumb';
        const imgWrap=document.createElement('div'); imgWrap.className='img';
        const img=document.createElement('img'); img.alt=st.title||'';
        img.src = st.imageURL || ''; imgWrap.appendChild(img);
        const cap=document.createElement('div'); cap.className='tcap';
        cap.innerHTML=`<strong>${st.title||'Untitled'}</strong><br>${st.caption||''}`;
        card.appendChild(imgWrap); card.appendChild(cap);
        card.addEventListener('click', ()=> pushFrame(sessionInput.value.trim().toLowerCase()||'default', st));
        thumbsEl.appendChild(card);
      });
    }

    /* Live subscribe to show what users will see (nice for confidence) */
    let currentRef = null, helloRef = null;
    function subscribe(sessionRaw){
      const session = (sessionRaw||'default').trim().toLowerCase();
      $('sessionBadge').textContent = 'session: ' + session;

      if(currentRef) currentRef.off();
      if(helloRef)   helloRef.off();

      currentRef = dbRef(db, manualPath(session));
      helloRef   = dbRef(db, helloPath(session));

      onValue(helloRef, snap=>{
        const v=snap.val()||{}; helloPill.textContent = 'hello: ' + (v.instructorPing ? new Date(v.instructorPing).toLocaleTimeString() : '—');
      });

      onValue(currentRef, snap=>{
        const v = snap.val();
        if (!v || v.clear){
          currentImg.src=''; currentCaption.textContent=''; say('Waiting…'); return;
        }
        currentImg.src = v.image || v.imageURL || '';
        currentCaption.textContent = (v.title ? (v.title + ' — ') : '') + (v.caption || '');
        say('Showing: ' + (v.title || '(untitled)'));
      });
    }

    /* Send a frame exactly how the viewer expects it */
    async function pushFrame(sessionRaw, stop){
      const session = (sessionRaw||'default').trim().toLowerCase();
      await ensureAuthed();

      // heartbeat
      await set(dbRef(db, helloPath(session)), { instructorPing: Date.now() });

      // decide the best shareable image
      const shareURL = await toShareableURL(stop);

      const payload = {
        kind: 'slide',
        ts: Date.now(),
        title: stop.title || '',
        caption: stop.caption || '',
        // The viewer accepts either field; include both for robustness
        imageURL: shareURL,
        image: shareURL.startsWith('data:') ? shareURL : ''  // only put data URLs into "image"
      };

      try{
        await set(dbRef(db, manualPath(session)), payload);
        say('Sent: ' + (payload.title || '(untitled)'));
      }catch(e){
        err('Error sending frame: ' + (e.message||e));
      }
    }

    async function clearUsers(sessionRaw){
      const session = (sessionRaw||'default').trim().toLowerCase();
      await ensureAuthed();
      try{
        await set(dbRef(db, helloPath(session)), { instructorPing: Date.now() });
        await set(dbRef(db, manualPath(session)), { clear:true, ts: Date.now() });
        say('Cleared');
      }catch(e){
        err('Error clearing: '+(e.message||e));
      }
    }

    // Wire controls
    $('reloadBtn').onclick = ()=> loadScenarios();
    $('subscribeBtn').onclick = ()=> subscribe(sessionInput.value);
    $('clearBtn').onclick = ()=> clearUsers(sessionInput.value);
    $('scenarioSelect').onchange = renderThumbs;

    // boot
    (async ()=>{
      try{
        await ensureAuthed();
      }catch(_){}
      await loadScenarios();
      subscribe(sessionInput.value);
      // send a heartbeat every 20s while the page is open
      setInterval(()=> set(dbRef(db, helloPath((sessionInput.value||'default').trim().toLowerCase())), { instructorPing: Date.now() })["catch"](()=>{}), 20000);
    })();
  </script>
</body>
</html>
