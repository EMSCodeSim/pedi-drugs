<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FireOps SIM ‚Äî Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{ --bg:#0b0f14; --bg2:#0e1421; --card:#0f1624; --edge:rgba(255,255,255,.10); --text:#eaf2ff; --muted:#93a0b5; --blue:#0a84ff; }
*{ box-sizing:border-box }
html,body{ margin:0; height:100%; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--text); background:
  radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
  radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
  linear-gradient(165deg, var(--bg2), var(--bg) 55%) }
.topbar{ position:sticky; top:0; z-index:20; background:rgba(12,15,22,.78); backdrop-filter:blur(6px) saturate(120%); border-bottom:1px solid rgba(255,255,255,.08) }
.topnav{ max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:10px; align-items:center }
.brand{ font-weight:900 }
.spacer{ flex:1 }
.btn{ appearance:none; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,#142238,#0f1930); color:#fff; border-radius:12px; padding:9px 12px; font-weight:800; cursor:pointer }
.btn[disabled]{ opacity:.6; cursor:not-allowed }
.tag{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); color:var(--muted) }

main{ max-width:1200px; margin:16px auto 40px; padding:0 16px; display:grid; grid-template-columns:340px 1fr; gap:12px }
.card{ background:var(--card); border:1px solid var(--edge); border-radius:16px; padding:12px; min-height:120px }
label{ display:block; margin:8px 0 6px 2px; font-size:12px; color:var(--muted) }
.input, select, textarea{ width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:#0c1322; color:#eaf2ff }
textarea{ min-height:80px }
.row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); gap:10px }
.thumb{ width:100%; height:90px; object-fit:cover; border-radius:10px; background:#0a1a2a; border:1px solid rgba(255,255,255,.14) }
.small{ font-size:12px; opacity:.85 }
hr{ border:none; height:1px; background:rgba(255,255,255,.08); margin:12px 0 }

#errbar{ position:fixed; left:10px; bottom:10px; background:#2b0d0d; color:#ffd7d7; border:1px solid #7a2b2b; border-radius:12px; padding:8px 12px; display:none; z-index:9999 }
#okbar{ position:fixed; left:10px; bottom:56px; background:#0f2a19; color:#d8ffe2; border:1px solid #2c7a4b; border-radius:12px; padding:8px 12px; display:none; z-index:9999 }

/* loading overlay */
#loader{ position:fixed; inset:0; display:none; place-items:center; z-index:99; background:rgba(6,12,20,.55); backdrop-filter:blur(2px) }
.spinner{ width:42px; height:42px; border-radius:999px; border:4px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite }
@keyframes spin{ to{ transform:rotate(360deg) } }

/* modal */
#photoModal{ position:fixed; inset:0; display:none; place-items:center; z-index:999; background:rgba(5,10,18,.6); backdrop-filter:blur(2px) }
.modal-card{ width:min(760px,96vw); background:var(--card); border:1px solid var(--edge); border-radius:16px; padding:14px }
.modal-head{ display:flex; align-items:center; gap:8px; margin-bottom:8px }
.modal-body{ display:grid; grid-template-columns:220px 1fr; gap:12px }
.modal-body img{ width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.12); aspect-ratio: 4 / 3; object-fit:cover }
.modal-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px }
</style>
</head>
<body>
<div id="errbar"></div><div id="okbar"></div>
<div id="loader"><div class="spinner"></div></div>

<div class="topbar">
  <div class="topnav">
    <div class="brand">FireOps SIM ‚Äî Admin</div>
    <div class="spacer"></div>
    <button id="showCreate" class="btn">Create Scenario</button>
    <button id="showEdit" class="btn">Edit Scenario</button>
    <a class="btn" href="./advanced-editor.html">Open Advanced Editor</a>
  </div>
</div>

<main>
  <!-- LEFT: Create -->
  <section class="card" id="createPane">
    <h3>Create Scenario</h3>
    <label>Title</label>
    <input id="cTitle" class="input" placeholder="e.g., Apartment Fire ‚Äî 5th St" />
    <label>Description</label>
    <textarea id="cDesc" placeholder="Short description‚Ä¶"></textarea>
    <div class="row">
      <button id="createBtn" class="btn">Create</button>
      <span id="createStatus" class="tag">Ready</span>
    </div>
    <hr />
    <h4>Add Photos (auto GPS)</h4>

    <!-- Hidden inputs: camera vs library -->
    <input id="cFilesCam" type="file" accept="image/*" capture="environment" multiple style="display:none" />
    <input id="cFilesLib" type="file" accept="image/*" multiple style="display:none" />

    <div class="row">
      <button id="cBtnCam" class="btn">üì∑ Take Photo</button>
      <button id="cBtnLib" class="btn">üñºÔ∏è Choose from Library</button>
    </div>

    <div class="small" style="margin:6px 0">Photos are resized to max <b>1600px</b> (thumbs at <b>480px</b>) to save space & speed up loads.</div>
    <div id="cUploads" class="grid"></div>
  </section>

  <!-- RIGHT: Edit -->
  <section class="card" id="editPane" style="display:none">
    <h3>Edit Scenario</h3>
    <label>Select a scenario</label>
    <select id="eSelect"><option value="">Loading‚Ä¶</option></select>
    <div class="row" style="margin-top:6px">
      <button id="refreshBtn" class="btn">Refresh</button>
      <span id="eStatus" class="tag">‚Äî</span>
    </div>

    <hr />
    <div class="row" style="margin-bottom:6px">
      <div style="flex:1">
        <label>Title</label>
        <input id="eTitle" class="input" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="saveMeta" class="btn">Save Scenario</button>
      </div>
    </div>
    <label>Description</label>
    <textarea id="eDesc"></textarea>

    <hr />
    <h4>Add Photos (auto GPS)</h4>

    <!-- Hidden inputs: camera vs library -->
    <input id="eFilesCam" type="file" accept="image/*" capture="environment" multiple style="display:none" />
    <input id="eFilesLib" type="file" accept="image/*" multiple style="display:none" />

    <div class="row">
      <button id="eBtnCam" class="btn">üì∑ Take Photo</button>
      <button id="eBtnLib" class="btn">üñºÔ∏è Choose from Library</button>
    </div>

    <div id="eUploads" class="grid" style="margin-top:8px"></div>

    <hr />
    <h4>Existing Stops</h4>
    <div id="stopsGrid" class="grid"></div>
  </section>
</main>

<!-- Photo editor modal -->
<div id="photoModal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="brand">Edit Photo</div>
      <div class="spacer"></div>
      <button id="pmClose" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <img id="pmPreview" src="" alt="preview"/>
      <div>
        <label>Title</label>
        <input id="pmTitle" class="input" />
        <label>Caption / Notes</label>
        <textarea id="pmCaption"></textarea>
        <div class="row">
          <div style="flex:1">
            <label>Latitude</label>
            <input id="pmLat" class="input" placeholder="e.g. 39.7392" />
          </div>
          <div style="flex:1">
            <label>Longitude</label>
            <input id="pmLng" class="input" placeholder="-104.9903" />
          </div>
        </div>
        <div class="row">
          <button id="pmUseMyLoc" class="btn">Use My Location</button>
          <span id="pmGpsStatus" class="tag">‚Äî</span>
        </div>
        <label>Radius (meters)</label>
        <input id="pmRadius" class="input" type="number" min="1" step="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="pmSave" class="btn">Save Photo</button>
    </div>
  </div>
</div>

<!-- Firebase (modules) -->
<script type="module">
/* ---------- UI helpers ---------- */
const $ = (id)=>document.getElementById(id);
const show = (id, on)=> $(id).style.display = on ? '' : 'none';
const ok = (m)=>{ const b=$('okbar'); b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 2400); };
const err= (m)=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 4200); };
const loading = (on)=>{ $('loader').style.display = on ? 'grid' : 'none'; };

/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref as dbRef, set, push, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as stRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain:"dailyquiz-d5279.firebaseapp.com",
  databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId:"dailyquiz-d5279",
  storageBucket:"dailyquiz-d5279.firebasestorage.app",
  appId:"1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId:"G-19DVN7NNH7"
};
const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);
const storage = getStorage(appFB, "gs://dailyquiz-d5279.firebasestorage.app");
const auth = getAuth(appFB);

async function ensureAuthed(){
  if (auth.currentUser) return auth.currentUser;
  await signInAnonymously(auth);
  await new Promise(res => onAuthStateChanged(auth, u=>u && res(), { once:true }));
  return auth.currentUser;
}
ensureAuthed().catch(()=>{});

/* ---------- Resize helpers (upload minimal size) ---------- */
const ORIG_MAX_EDGE = 1600;  // longest side
const THUMB_MAX_EDGE = 480;
const JPEG_QUALITY   = 0.82;

async function fileToBitmap(file){
  if ('createImageBitmap' in window) {
    try{
      return await createImageBitmap(file, { imageOrientation: 'from-image' });
    }catch(_){}
  }
  const url = URL.createObjectURL(file);
  const img = new Image(); img.decoding='async'; img.src=url;
  await img.decode(); URL.revokeObjectURL(url);
  return img;
}
function scaleDims(w, h, maxEdge){
  const s = Math.min(1, maxEdge / Math.max(w, h));
  return { w: Math.round(w*s), h: Math.round(h*s) };
}
async function bitmapToBlob(bmp, maxEdge, quality=JPEG_QUALITY, type='image/jpeg'){
  const { w, h } = scaleDims(bmp.width, bmp.height, maxEdge);
  const c = ('OffscreenCanvas' in window) ? new OffscreenCanvas(w, h) : Object.assign(document.createElement('canvas'), { width:w, height:h });
  if (!('width' in c)) { c.width = w; c.height = h; }
  const ctx = c.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(bmp, 0, 0, w, h);
  const blob = await (c.convertToBlob ? c.convertToBlob({ type, quality }) : new Promise(res => c.toBlob(res, type, quality)));
  return { blob, width:w, height:h };
}

/* ---------- Location helpers ---------- */
async function getCoords(){
  if (!('geolocation' in navigator)) return null;
  try{
    return await new Promise((resolve)=> {
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: +pos.coords.latitude.toFixed(6), lng: +pos.coords.longitude.toFixed(6), accuracy: pos.coords.accuracy }),
        _ => resolve(null),
        { enableHighAccuracy:true, maximumAge:60000, timeout:10000 }
      );
    });
  }catch{ return null; }
}

/* ---------- Data helpers ---------- */
const ROOT='scenarios';
let scenarios=[];
function coerceStops(sc){
  if (Array.isArray(sc?.stops)) return sc.stops;
  if (Array.isArray(sc?.photos)) return sc.photos;
  if (Array.isArray(sc?.images)) return sc.images;
  return [];
}
function setStops(sc, stops){
  if (Array.isArray(sc?.stops)) sc.stops = stops;
  else if (Array.isArray(sc?.photos)) sc.photos = stops;
  else if (Array.isArray(sc?.images)) sc.images = stops;
  else sc.stops = stops;
}
function populateEditList(){
  const sel=$('eSelect'); sel.innerHTML='<option value="">Select‚Ä¶</option>';
  scenarios.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=(s.title||'(untitled)') + (s.active?'':' (inactive)');
    sel.appendChild(o);
  });
}
async function loadScenarios(){
  const snap = await get(dbRef(db, ROOT));
  const obj = snap.exists() ? (snap.val()||{}) : {};
  scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
              .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  populateEditList();
}
onValue(dbRef(db, ROOT), snap=>{
  const obj=snap.val()||{};
  scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
              .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  populateEditList();
  const cur = $('eSelect').value;
  if (cur) renderScenario(cur);
});
await loadScenarios();

/* ---------- Pane toggles ---------- */
$('showCreate').onclick=()=>{ show('createPane',true); show('editPane',false); };
$('showEdit').onclick =()=>{ show('createPane',false); show('editPane',true); };

/* ---------- Create Scenario ---------- */
let createdId=null;
$('createBtn').onclick = async ()=>{
  try{
    const title = $('cTitle').value.trim() || '(untitled)';
    const desc  = $('cDesc').value.trim() || '';
    $('createBtn').disabled = true;
    $('createStatus').textContent='Creating‚Ä¶';
    const id = (push(dbRef(db, ROOT))).key;
    const rec = { id, title, description: desc, createdAt: Date.now(), active:true, stops: [] };
    await set(dbRef(db, `${ROOT}/${id}`), rec);
    createdId = id;
    $('createStatus').textContent='Created ‚úì';
    ok('Scenario created');
    await loadScenarios();
    $('eSelect').value = id;
    $('eTitle').value  = title;
    $('eDesc').value   = desc;
    renderScenario(id);
  }catch(e){ err('Create failed: '+(e.message||e)); }
  finally{ $('createBtn').disabled = false; }
};

/* ----- unified upload handler with auto-GPS ----- */
async function processFilesForScenario(files, scenarioId, uploadsContainerId){
  if (!files?.length) return;
  await ensureAuthed();
  loading(true);
  try{
    // get location once per selection (better UX)
    const coords = await getCoords();

    for (const file of files){
      const card = document.createElement('div');
      card.innerHTML = `<div class="tag small">New photo</div>`;
      $(uploadsContainerId).prepend(card);
      const status = (t)=>{ card.querySelector('.tag').textContent=t; };

      try{
        status('Decoding‚Ä¶');
        const bmp = await fileToBitmap(file);

        status('Resizing‚Ä¶');
        const { blob: fullBlob, width, height } = await bitmapToBlob(bmp, ORIG_MAX_EDGE, JPEG_QUALITY, 'image/jpeg');
        const { blob: thumbBlob }               = await bitmapToBlob(bmp, THUMB_MAX_EDGE, 0.8, 'image/jpeg');

        const ts = Date.now();
        const basePath = `scenarios/${scenarioId}/${ts}`;
        const fullRef  = stRef(storage, `${basePath}.jpg`);
        const thumbRef = stRef(storage, `scenarios/${scenarioId}/thumbs/${ts}.jpg`);
        const meta = { contentType: 'image/jpeg', cacheControl: 'public,max-age=31536000,immutable' };

        status('Uploading full‚Ä¶'); await uploadBytes(fullRef,  fullBlob,  meta);
        status('Uploading thumb‚Ä¶'); await uploadBytes(thumbRef, thumbBlob, meta);

        status('Finalizing‚Ä¶');
        const imageURL = await getDownloadURL(fullRef);
        const thumbURL = await getDownloadURL(thumbRef);

        status('Saving to DB‚Ä¶');
        const snap = await get(dbRef(db, `${ROOT}/${scenarioId}`));
        const sc = snap.val();
        const stops = coerceStops(sc);
        const stop = {
          type:'photo',
          title:'', caption:'',
          lat: coords?.lat ?? null,
          lng: coords?.lng ?? null,
          locAccuracy: coords?.accuracy ?? null,
          radiusMeters:50,
          imageURL, thumbURL,
          storagePath:`${basePath}.jpg`, thumbPath:`scenarios/${scenarioId}/thumbs/${ts}.jpg`,
          gsUri:`gs://dailyquiz-d5279.firebasestorage.app/${basePath}.jpg`,
          width, height,
          overlays:[]
        };
        stops.push(stop);
        setStops(sc, stops);
        await set(dbRef(db, `${ROOT}/${scenarioId}`), sc);
        status(coords ? 'Uploaded ‚úì (GPS set)' : 'Uploaded ‚úì (no GPS)');
      }catch(ex){
        status('Failed'); err('Upload failed: '+(ex.message||ex));
      }
    }
    ok('All selected photos processed.');
  }finally{
    loading(false);
  }
}

/* ---------- Create pane: add photos ---------- */
$('cBtnCam').onclick = ()=> $('cFilesCam').click();
$('cBtnLib').onclick = ()=> $('cFilesLib').click();

$('cFilesCam').addEventListener('change', async (e)=>{
  if (!createdId){ err('Create a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), createdId, 'cUploads');
  e.target.value='';
});
$('cFilesLib').addEventListener('change', async (e)=>{
  if (!createdId){ err('Create a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), createdId, 'cUploads');
  e.target.value='';
});

/* ---------- Edit pane ---------- */
$('refreshBtn').onclick = loadScenarios;

$('eSelect').onchange = ()=>{ const id=$('eSelect').value; if (id) renderScenario(id); };

async function renderScenario(id){
  const s = scenarios.find(x=>x.id===id); if (!s){ $('eStatus').textContent='Not found'; return; }
  $('eTitle').value = s.title||'';
  $('eDesc').value  = s.description||'';
  $('eStatus').textContent = `${(s._stops||[]).length} photo(s)`;
  const grid = $('stopsGrid'); grid.innerHTML='';
  if (!s._stops?.length){ grid.innerHTML='<div class="small tag">No photos yet</div>'; return; }

  s._stops.forEach((st, idx)=>{
    const el = document.createElement('div');
    const thumb = st.thumbURL || st.imageURL || '';
    const hasGPS = (st.lat!=null && st.lng!=null);
    el.innerHTML = `
      <img class="thumb" src="${thumb}" alt="thumb" />
      <div class="small" style="margin-top:6px">${st.title||('Stop '+(idx+1))}</div>
      <div class="row" style="margin-top:6px">
        <span class="tag small">${hasGPS ? 'GPS ‚úì' : 'GPS ‚Äî'}</span>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" data-edit="${idx}">Edit</button>
        <button class="btn" data-gps="${idx}">Set GPS</button>
        <button class="btn" data-del="${idx}" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
      </div>
    `;

    // Delete
    el.querySelector('[data-del]').onclick = async ()=>{
      try{
        loading(true);
        const snap = await get(dbRef(db, `${ROOT}/${id}`));
        const sc = snap.val(); const arr = coerceStops(sc);
        arr.splice(idx,1); setStops(sc, arr);
        await set(dbRef(db, `${ROOT}/${id}`), sc);
        ok('Stop deleted'); await loadScenarios(); renderScenario(id);
      }catch(e){ err('Delete failed: '+(e.message||e)); }
      finally{ loading(false); }
    };

    // Inline set GPS
    el.querySelector('[data-gps]').onclick = async ()=>{
      const coords = await getCoords();
      if (!coords){ err('Could not get GPS (permission or signal).'); return; }
      try{
        loading(true);
        const snap = await get(dbRef(db, `${ROOT}/${id}`));
        const sc = snap.val(); const arr = coerceStops(sc);
        if (!arr[idx]) return;
        arr[idx].lat = coords.lat; arr[idx].lng = coords.lng; arr[idx].locAccuracy = coords.accuracy ?? null;
        setStops(sc, arr);
        await set(dbRef(db, `${ROOT}/${id}`), sc);
        ok('GPS saved'); await loadScenarios(); renderScenario(id);
      }catch(e){ err('Save GPS failed: '+(e.message||e)); }
      finally{ loading(false); }
    };

    // Edit
    el.querySelector('[data-edit]').onclick = ()=> openPhotoEditor(id, idx);

    grid.appendChild(el);
  });
}

/* Scenario meta save */
$('saveMeta').onclick = async ()=>{
  try{
    const id=$('eSelect').value; if(!id) return;
    loading(true);
    const snap = await get(dbRef(db, `${ROOT}/${id}`));
    const sc = snap.val()||{};
    sc.title = $('eTitle').value.trim()||'(untitled)';
    sc.description = $('eDesc').value.trim()||'';
    await set(dbRef(db, `${ROOT}/${id}`), sc);
    ok('Scenario saved');
    await loadScenarios(); $('eSelect').value=id; renderScenario(id);
  }catch(e){ err('Save failed: '+(e.message||e)); }
  finally{ loading(false); }
};

/* Edit pane: add photos */
$('eBtnCam').onclick = ()=> $('eFilesCam').click();
$('eBtnLib').onclick = ()=> $('eFilesLib').click();

$('eFilesCam').addEventListener('change', async (e)=>{
  const id=$('eSelect').value; if(!id){ err('Select a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), id, 'eUploads');
  await loadScenarios(); $('eSelect').value=id; renderScenario(id);
  e.target.value='';
});
$('eFilesLib').addEventListener('change', async (e)=>{
  const id=$('eSelect').value; if(!id){ err('Select a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), id, 'eUploads');
  await loadScenarios(); $('eSelect').value=id; renderScenario(id);
  e.target.value='';
});

/* ---------- Photo editor modal ---------- */
let pmCtx = { scenarioId:null, index:-1 };

function openPhotoEditor(scenarioId, index){
  pmCtx = { scenarioId, index };
  const s = scenarios.find(x=>x.id===scenarioId); if(!s) return;
  const st = (s._stops||[])[index]; if(!st) return;

  $('pmPreview').src = st.imageURL || st.thumbURL || '';
  $('pmTitle').value = st.title || '';
  $('pmCaption').value = st.caption || '';
  $('pmLat').value = (st.lat ?? '').toString();
  $('pmLng').value = (st.lng ?? '').toString();
  $('pmRadius').value = (st.radiusMeters ?? 50);

  $('pmGpsStatus').textContent = (st.lat!=null && st.lng!=null) ? 'GPS ‚úì' : 'GPS ‚Äî';
  $('photoModal').style.display = 'grid';
}
$('pmClose').onclick = ()=>{ $('photoModal').style.display='none'; };

$('pmUseMyLoc').onclick = async ()=>{
  $('pmGpsStatus').textContent = 'Getting GPS‚Ä¶';
  const coords = await getCoords();
  if (!coords){ $('pmGpsStatus').textContent='GPS failed'; err('Could not get GPS.'); return; }
  $('pmLat').value = coords.lat;
  $('pmLng').value = coords.lng;
  $('pmGpsStatus').textContent = 'GPS ‚úì';
};

$('pmSave').onclick = async ()=>{
  const { scenarioId, index } = pmCtx; if (!scenarioId || index<0) return;
  try{
    loading(true);
    const snap = await get(dbRef(db, `${ROOT}/${scenarioId}`));
    const sc = snap.val(); const arr = coerceStops(sc);
    const st = arr[index]; if (!st) throw new Error('Photo not found');

    st.title = $('pmTitle').value.trim();
    st.caption = $('pmCaption').value.trim();
    const lat = $('pmLat').value.trim(); const lng = $('pmLng').value.trim();
    st.lat = lat==='' ? null : Number(lat);
    st.lng = lng==='' ? null : Number(lng);
    st.radiusMeters = Math.max(1, parseInt(($('pmRadius').value||'50'),10));
    setStops(sc, arr);
    await set(dbRef(db, `${ROOT}/${scenarioId}`), sc);
    ok('Photo saved');
    $('photoModal').style.display='none';
    await loadScenarios(); $('eSelect').value=scenarioId; renderScenario(scenarioId);
  }catch(e){ err('Save photo failed: '+(e.message||e)); }
  finally{ loading(false); }
};
</script>
</body>
</html>
