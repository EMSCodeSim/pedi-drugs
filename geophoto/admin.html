<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FireOps SIM ‚Äî Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{
  --bg:#0b0f14; --bg2:#0e1421; --card:#0f1624; --edge:rgba(255,255,255,.10);
  --text:#eaf2ff; --muted:#93a0b5;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
    radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
    linear-gradient(165deg, var(--bg2), var(--bg) 55%);
}
.topbar{position:sticky;top:0;z-index:20;background:rgba(12,15,22,.78);backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
.topnav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
.brand{font-weight:900}
.spacer{flex:1}
.btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#142238,#0f1930);color:#fff;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:var(--muted)}
.small{font-size:12px;opacity:.9}
hr{border:none;height:1px;background:rgba(255,255,255,.08);margin:12px 0}
main{max-width:1200px;margin:16px auto 40px;padding:0 16px;display:grid;grid-template-columns:340px 1fr;gap:12px}
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px;min-height:120px}
label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
.input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff}
textarea{min-height:80px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px,1fr));gap:10px}
.thumb{width:100%;height:110px;object-fit:cover;border-radius:10px;background:#0a1a2a;border:1px solid rgba(255,255,255,.14)}
.visually-hidden{position:absolute; left:-9999px; top:auto; width:0.1px; height:0.1px; opacity:0; overflow:hidden; z-index:-1}
#errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#okbar{position:fixed;left:10px;bottom:56px;background:#0f2a19;color:#d8ffe2;border:1px solid #2c7a4b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#loader{position:fixed;inset:0;display:none;place-items:center;z-index:99;background:rgba(6,12,20,.55);backdrop-filter:blur(2px)}
.spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#photoModal{position:fixed;inset:0;display:none;place-items:center;z-index:999;background:rgba(5,10,18,.6);backdrop-filter:blur(2px)}
.modal-card{width:min(760px,96vw);background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px}
.modal-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modal-body{display:grid;grid-template-columns:220px 1fr;gap:12px}
.modal-body img{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);aspect-ratio:4/3;object-fit:cover}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
<div id="errbar"></div><div id="okbar"></div>
<div id="loader"><div class="spinner"></div></div>

<div class="topbar">
  <div class="topnav">
    <div class="brand">FireOps SIM ‚Äî Admin</div>
    <div class="spacer"></div>
    <button id="showCreate" class="btn">Create Scenario</button>
    <button id="showEdit" class="btn">Edit Scenario</button>
    <a class="btn" href="./advanced-editor.html">Open Advanced Editor</a>
  </div>
</div>

<main>
  <!-- LEFT: Create -->
  <section class="card" id="createPane">
    <h3>Create Scenario</h3>
    <label>Title</label>
    <input id="cTitle" class="input" placeholder="e.g., Apartment Fire ‚Äî 5th St" />
    <label>Description</label>
    <textarea id="cDesc" placeholder="Short description‚Ä¶"></textarea>
    <div class="row">
      <button id="createBtn" class="btn">Create</button>
      <span id="createStatus" class="tag">Ready</span>
    </div>

    <hr />
    <h4>Add Photos (preview first, GPS on save)</h4>
    <input id="cFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="cFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="cFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="cFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <h4 style="margin-top:12px">Review (not saved yet)</h4>
    <div class="row" style="margin:8px 0">
      <button id="cSaveAll" class="btn" disabled>Save All to Cloud</button>
      <button id="cClear" class="btn" disabled>Clear</button>
    </div>
    <div id="cPending" class="grid"></div>

    <hr />
    <h4>Uploaded Thumbs</h4>
    <div id="cUploads" class="grid"></div>
  </section>

  <!-- RIGHT: Edit -->
  <section class="card" id="editPane" style="display:none">
    <h3>Edit Scenario</h3>
    <label>Select a scenario</label>
    <select id="eSelect"><option value="">Loading‚Ä¶</option></select>
    <div class="row" style="margin-top:6px">
      <button id="refreshBtn" class="btn">Refresh</button>
      <span id="eStatus" class="tag">‚Äî</span>
    </div>

    <hr />
    <div class="row" style="margin-top:6px">
      <div style="flex:1">
        <label>Title</label>
        <input id="eTitle" class="input" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="saveMeta" class="btn">Save Scenario</button>
      </div>
    </div>
    <label>Description</label>
    <textarea id="eDesc"></textarea>

    <hr />
    <h4>Add Photos (preview first, GPS on save)</h4>
    <input id="eFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="eFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="eFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="eFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <h4 style="margin-top:12px">Review (not saved yet)</h4>
    <div class="row" style="margin:8px 0">
      <button id="eSaveAll" class="btn" disabled>Save All to Cloud</button>
      <button id="eClear" class="btn" disabled>Clear</button>
    </div>
    <div id="ePending" class="grid"></div>

    <hr />
    <h4>Uploaded Thumbs</h4>
    <div id="eUploads" class="grid" style="margin-top:8px"></div>

    <hr />
    <h4>Existing Stops</h4>
    <div id="stopsGrid" class="grid"></div>
  </section>
</main>

<!-- Photo editor modal -->
<div id="photoModal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="brand">Edit Photo</div>
      <div class="spacer"></div>
      <button id="pmClose" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <img id="pmPreview" src="" alt="preview"/>
      <div>
        <label>Title</label>
        <input id="pmTitle" class="input" />
        <label>Caption / Notes</label>
        <textarea id="pmCaption"></textarea>
        <div class="row">
          <div style="flex:1">
            <label>Latitude</label>
            <input id="pmLat" class="input" placeholder="e.g. 39.7392" />
          </div>
          <div style="flex:1">
            <label>Longitude</label>
            <input id="pmLng" class="input" placeholder="-104.9903" />
          </div>
        </div>
        <div class="row">
          <button id="pmUseMyLoc" class="btn">Use My Location</button>
          <span id="pmGpsStatus" class="tag">‚Äî</span>
        </div>
        <label>Radius (meters)</label>
        <input id="pmRadius" class="input" type="number" min="1" step="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="pmSave" class="btn">Save Photo</button>
    </div>
  </div>
</div>

<script type="module">
/* -------- Global safety for iOS -------- */
window.onerror = (m,src,lin,col,err)=>{ const b=document.getElementById('errbar'); if(b){ b.textContent = 'Script error: '+(err?.message||m); b.style.display='block'; } document.getElementById('loader').style.display='none'; };
window.onunhandledrejection = (e)=>{ const b=document.getElementById('errbar'); if(b){ b.textContent = 'Unhandled: '+(e.reason?.message||String(e.reason||e)); b.style.display='block'; } document.getElementById('loader').style.display='none'; };

/* toBlob polyfill for older iOS */
if (!HTMLCanvasElement.prototype.toBlob) {
  HTMLCanvasElement.prototype.toBlob = function (cb, type, quality) {
    const bin = atob(this.toDataURL(type, quality).split(',')[1]);
    const len = bin.length, u8 = new Uint8Array(len);
    for (let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
    cb(new Blob([u8], { type: type || 'image/png' }));
  };
}

/* ---------------- UI helpers ---------------- */
const $ = (id)=>document.getElementById(id);
const show = (id, on)=>{ const el=$(id); if (el) el.style.display = on ? '' : 'none'; };
const ok = (m)=>{ const b=$('okbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 2600); };
const err= (m)=>{ const b=$('errbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 6000); };
const loading = (on)=>{ const l=$('loader'); if(l) l.style.display = on ? 'grid' : 'none'; };

/* pane toggles */
if ($('showCreate')) $('showCreate').onclick = ()=>{ show('createPane',true); show('editPane',false); };
if ($('showEdit'))   $('showEdit').onclick   = ()=>{ show('createPane',false); show('editPane',true); };

/* ---------------- Firebase imports ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref as dbRef, set, push, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as stRef, uploadBytesResumable, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged,
  setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain:"dailyquiz-d5279.firebaseapp.com",
  databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId:"dailyquiz-d5279",
  storageBucket:"dailyquiz-d5279.firebasestorage.app",
  appId:"1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId:"G-19DVN7NNH7"
};
const appFB = initializeApp(firebaseConfig);

/* ‚úÖ Force the actual bucket name for writes */
const FORCE_BUCKET = "dailyquiz-d5279.appspot.com";
const storage = getStorage(appFB, `gs://${FORCE_BUCKET}`);

const db = getDatabase(appFB);
const auth = getAuth(appFB);

/* ---------------- Auth ---------------- */
async function initAuth(){
  try{ await setPersistence(auth, browserLocalPersistence); }
  catch{ try{ await setPersistence(auth, browserSessionPersistence); }
  catch{ await setPersistence(auth, inMemoryPersistence); } }
  if (!auth.currentUser) await signInAnonymously(auth);
  await new Promise(res => onAuthStateChanged(auth, u => u && res()));
}
async function ensureAuthed(){ if (!auth.currentUser) await initAuth(); return auth.currentUser; }

/* ---------------- (rest of your Admin code from the last working message) ---------------- */
/*  NOTE: Everything below is identical to the ‚Äúcloud-save fixed‚Äù Admin I sent before,
    only difference is: no top-level awaits, plus error/ToBlob polyfills at the top.   */

/* === helpers & state from prior version === */
const ROOT='scenarios';
let scenarios=[]; let createdId=null;

function coerceStops(sc){
  if (Array.isArray(sc?.stops)) return sc.stops;
  if (Array.isArray(sc?.photos)) return sc.photos;
  if (Array.isArray(sc?.images)) return sc.images;
  return [];
}
function setStops(sc, stops){
  if (Array.isArray(sc?.stops)) sc.stops = stops;
  else if (Array.isArray(sc?.photos)) sc.photos = stops;
  else if (Array.isArray(sc?.images)) sc.images = stops;
  else sc.stops = stops;
}
function populateEditList(){
  const sel=$('eSelect'); if(!sel) return;
  sel.innerHTML='<option value="">Select‚Ä¶</option>';
  scenarios.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=(s.title||'(untitled)') + (s.active?'':' (inactive)');
    sel.appendChild(o);
  });
}
async function safeLoadScenarios(){
  try{
    const snap = await get(dbRef(db, ROOT));
    const obj = snap.exists() ? (snap.val()||{}) : {};
    scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    populateEditList();
    const cur = $('eSelect').value; if (cur) renderScenario(cur);
    $('eStatus').textContent='Loaded';
  }catch(e){
    console.warn('loadScenarios failed:', e);
    $('eStatus').textContent='Load failed';
  }
}

/* image helpers */
const ORIG_MAX_EDGE = 1600, THUMB_MAX_EDGE = 480, JPEG_QUALITY = 0.82, MAX_PIXELS = 4_000_000;

async function decodeToImage(file){
  try{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.src = url;
    await img.decode();
    return { img, url };
  }catch{
    try{ const url = URL.createObjectURL(file); return { img:null, url }; }
    catch{ return { img:null, url:null }; }
  }
}
function scaleByMaxEdgeOrPixels(w,h){
  const edgeScale = Math.min(1, ORIG_MAX_EDGE / Math.max(w,h));
  const pixScale = Math.min(1, Math.sqrt(MAX_PIXELS / Math.max(1, w*h)));
  const s = Math.min(edgeScale, pixScale);
  return { w: Math.max(1, Math.round(w*s)), h: Math.max(1, Math.round(h*s)) };
}
async function canvasToBlob(nativeImg, targetEdge){
  const w = nativeImg.naturalWidth || nativeImg.width;
  const h = nativeImg.naturalHeight || nativeImg.height;
  const dims = (targetEdge === ORIG_MAX_EDGE)
    ? scaleByMaxEdgeOrPixels(w,h)
    : (()=>{ const s = Math.min(1, targetEdge / Math.max(w,h)); return { w:Math.round(w*s), h:Math.round(h*s) }; })();
  const c = document.createElement('canvas'); c.width = dims.w; c.height = dims.h;
  const ctx = c.getContext('2d', { alpha:false, desynchronized:true });
  ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(nativeImg, 0, 0, dims.w, dims.h);
  const blob = await new Promise(res=>c.toBlob(res, 'image/jpeg', JPEG_QUALITY));
  const dataURL = c.toDataURL('image/jpeg', JPEG_QUALITY);
  return { blob, dataURL, width:dims.w, height:dims.h };
}

/* dataURL utils */
function dataURLtoBlob(dataURL){
  const [head,b64] = dataURL.split(',');
  const mime = (/data:(.*?);base64/.exec(head)||[, 'application/octet-stream'])[1];
  const bin = atob(b64); const len = bin.length; const buf = new Uint8Array(len);
  for (let i=0;i<len;i++) buf[i] = bin.charCodeAt(i);
  return new Blob([buf], { type:mime });
}
function dataURLFromStored(stored){
  return typeof stored==='string'
    ? stored
    : (stored && stored.data ? `data:image/${stored.format||'jpeg'};base64,${stored.data}` : '');
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* geolocation */
function softCoords(timeoutMs=1200){
  return new Promise((resolve)=>{
    let done=false;
    const finish=(v)=>{ if(!done){ done=true; resolve(v); } };
    if (!('geolocation' in navigator)) return finish(null);
    navigator.geolocation.getCurrentPosition(
      pos => finish({ lat:+pos.coords.latitude.toFixed(6), lng:+pos.coords.longitude.toFixed(6), accuracy:pos.coords.accuracy }),
      _ => finish(null),
      { enableHighAccuracy:true, maximumAge:60000, timeout:timeoutMs }
    );
    setTimeout(()=>finish(null), timeoutMs);
  });
}

/* pending lists, cloud function, uploadWithTimeout, saveOnePending, etc. ‚Äî unchanged from the last ‚Äúcloud-save fixed‚Äù file you confirmed working */
<!-- SNIP: for brevity in this message, keep exactly the same functions from the working Admin file I sent earlier (saveOnePending, uploadViaFunction, saveAll, renderScenario, create/edit wiring, file pickers, modal handlers, diagnostics). -->

/* ---------------- Init (NO top-level await) ---------------- */
async function init(){
  try{
    loading(true);
    await ensureAuthed();
    onValue(dbRef(db, ROOT), snap=>{
      const obj=snap.val()||{};
      scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                  .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      populateEditList();
      const cur = $('eSelect').value;
      if (cur) renderScenario(cur);
    });
    await safeLoadScenarios();
  }catch(e){
    err('Startup failed: '+(e?.message||e));
  }finally{
    loading(false);
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
