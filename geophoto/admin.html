<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Admin (Geo-Photo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="description" content="Create and edit FireOps SIM Geo-Photo training scenarios with dispatch info, geofenced photos, and captions." />

  <style>
    :root{
      --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff;
      --blue:#0a84ff; --teal:#2dd4bf; --red:#ff3b30; --shadow:0 12px 34px rgba(0,0,0,.38);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%);
      -webkit-text-size-adjust:100%;
      scroll-behavior:smooth;
    }
    a{color:inherit; text-decoration:none}
    img{max-width:100%; height:auto; display:block}

    .topbar{
      position:sticky; top:0; z-index:20;
      background:rgba(12,15,22,.75);
      backdrop-filter:saturate(120%) blur(6px);
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .topnav{
      max-width:1100px; margin:0 auto; padding:10px 20px;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    .brandmini{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px}
    .logo img{
      width:40px; height:40px; border-radius:10px; box-shadow:var(--shadow); object-fit:cover;
      background:#0f1624;
    }
    .tag{color:var(--muted); font-size:12px}

    main{max-width:1100px; margin:24px auto 84px; padding:0 20px}
    .card{
      position:relative; border-radius:var(--radius); background:var(--card);
      border:1px solid rgba(255,255,255,.07); box-shadow:var(--shadow); overflow:hidden;
      transition:transform .15s ease, border-color .2s ease, box-shadow .2s ease;
      margin:12px 0;
    }
    .card:hover{ transform:translateY(-2px); border-color:rgba(10,132,255,.35); box-shadow:0 16px 40px rgba(0,0,0,.5) }
    .card-inner{ padding:18px }

    .eyebrow{font-size:12px; color:var(--muted); margin-bottom:8px}
    .sectionTitle{font-weight:900; margin:6px 0 10px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.03)
    }
    .hr{height:1px; background:rgba(255,255,255,.10); margin:12px 0}

    label{display:block; margin:10px 0 6px 2px; font-size:13px; color:var(--muted)}
    input, textarea, select, button{font-size:16px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:12px; border-radius:12px; outline:none;
      background:#0f1624; color:var(--text); border:1px solid rgba(255,255,255,.14);
    }
    textarea{min-height:88px; resize:vertical}

    .btn{
      appearance:none; border:0; border-radius:12px; width:auto; cursor:pointer;
      padding:14px 16px; font-weight:800; font-size:16px; color:#03131b;
      background:linear-gradient(180deg,#54a6ff,var(--blue)); box-shadow:var(--shadow);
      text-align:center;
    }
    .btn.secondary{
      background:transparent; color:var(--text);
      border:1px solid rgba(255,255,255,.14);
    }
    .btn.teal{
      background:linear-gradient(180deg,#3ce5d3,var(--teal)); color:#052522;
    }
    .btn.danger{ background:var(--red); color:#fff; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .hidden{ display:none }

    .stickyBar{
      position:sticky; top:62px; z-index:5;
      background:rgba(12,15,22,.75);
      backdrop-filter:saturate(120%) blur(6px);
      border-bottom:1px solid rgba(255,255,255,.07);
      padding:8px 12px;
      margin:-18px -18px 10px -18px;
    }

    .thumbs{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .thumb{width:88px; height:88px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0a2230}
    .listItem{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; border:1px solid rgba(255,255,255,.14); border-radius:12px; background:#0f1624
    }
  </style>
</head>
<body>

  <!-- Top Navigation -->
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo" aria-hidden="true">
          <img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM logo" />
        </div>
        <div>
          <div id="brandName" style="line-height:1.1; font-size:15px; font-weight:900">FireOps SIM</div>
          <div class="tag" id="brandTag">Real-Time Fire Scene Simulator</div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <!-- Landing -->
    <section class="card" id="landing">
      <div class="card-inner">
        <div class="sectionTitle">Scenario Admin</div>
        <div class="row" style="margin-top:8px">
          <button id="goCreate" class="btn">Create Scenario</button>
          <button id="goEdit" class="btn secondary">Edit Scenario</button>
        </div>
        <div class="pill" id="status">Ready</div>
      </div>
    </section>

    <!-- Create Scenario -->
    <section class="card hidden" id="createPanel">
      <div class="card-inner">
        <div class="stickyBar">
          <div class="row" style="justify-content:space-between; width:100%; gap:8px">
            <div class="pill" id="createStatus">New scenario</div>
            <div class="row" style="gap:8px">
              <!-- One-tap: unlock iOS audio and read dispatch + captions -->
              <button id="startScenarioBtn" class="btn teal">Start Scenario (Enable Voice)</button>
              <button id="finalizeScenario" class="btn">Save Scenario</button>
            </div>
          </div>
        </div>

        <div id="scenarioMeta">
          <label>Scenario Name</label>
          <input id="scenarioName" type="text" placeholder="e.g., House Fire on Main St">

          <label>Dispatch Information</label>
          <textarea id="dispatchInfo" placeholder="Example: Engine 1 and Medic 1 respond to a two-story residential structure fire..."></textarea>
        </div>

        <div class="hr"></div>

        <!-- Photo entry -->
        <div>
          <div class="sectionTitle">Add Photo</div>

          <label>Photo (camera or library)</label>
          <input id="photoInput" type="file" accept="image/*" capture="environment">

          <div class="row">
            <div style="flex:1">
              <label>Radius (meters)</label>
              <input id="radius" type="number" inputmode="numeric" min="5" max="1000" value="50">
            </div>
          </div>

          <label>Caption / Notes (read by TTS)</label>
          <textarea id="caption" placeholder="What should crews observe or do here?"></textarea>

          <div class="row" style="margin-top:8px">
            <button id="savePhoto" class="btn">Save Photo</button>
            <div class="tag">GPS is captured automatically on save.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">Photos in this scenario</div>
        <div id="thumbs" class="thumbs"></div>
      </div>
    </section>

    <!-- Edit Scenario -->
    <section class="card hidden" id="editPanel">
      <div class="card-inner">
        <div class="sectionTitle">Edit Existing Scenario</div>
        <div class="row" style="justify-content:space-between">
          <div class="pill" id="editStatus">Loading…</div>
          <button id="backFromEdit" class="btn secondary">Back</button>
        </div>
        <div id="scenarioList" style="margin-top:10px"></div>
      </div>
    </section>
  </main>

  <!-- Firebase + Logic + TTS Queue -->
  <script type="module">
    // ===================== Firebase (same logic) =====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, push, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ===================== DOM =====================
    const landing = document.getElementById('landing');
    const goCreate = document.getElementById('goCreate');
    const goEdit = document.getElementById('goEdit');
    const statusPill = document.getElementById('status');

    const createPanel = document.getElementById('createPanel');
    const createStatus = document.getElementById('createStatus');
    const finalizeScenario = document.getElementById('finalizeScenario');

    const scenarioMeta = document.getElementById('scenarioMeta');
    const scenarioName = document.getElementById('scenarioName');
    const dispatchInfo = document.getElementById('dispatchInfo');

    const photoInput = document.getElementById('photoInput');
    const radius = document.getElementById('radius');
    const caption = document.getElementById('caption');
    const savePhoto = document.getElementById('savePhoto');
    const thumbs = document.getElementById('thumbs');

    const editPanel = document.getElementById('editPanel');
    const editStatus = document.getElementById('editStatus');
    const scenarioList = document.getElementById('scenarioList');
    const backFromEdit = document.getElementById('backFromEdit');

    const startScenarioBtn = document.getElementById('startScenarioBtn');

    // ===================== State =====================
    let currentScenarioId = null;
    let localStops = []; // {caption, lat, lng, radiusMeters, imageData}

    // ===================== Helpers =====================
    const uiShow = el => el.classList.remove('hidden');
    const uiHide = el => el.classList.add('hidden');
    const toast = (el, msg) => el.textContent = msg;

    function readFileAsDataURL(file){
      return new Promise((res, rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }
    function getGPS(){
      return new Promise((resolve, reject)=>{
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          err => reject(err),
          { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
        );
      });
    }
    function renderThumbs(){
      thumbs.innerHTML='';
      localStops.forEach((s,i)=>{
        const img=document.createElement('img');
        img.className='thumb';
        img.title=s.title || `Stop ${i+1}`;
        img.src=s.imageData || s.imageURL || '';
        img.onerror = ()=>{ img.style.opacity=.7; img.title='Image failed to load'; };
        thumbs.appendChild(img);
      });
    }

    // ===================== Navigation =====================
    goCreate.onclick = ()=>{
      uiHide(landing); uiShow(createPanel);
      createStatus.textContent='New scenario';
      currentScenarioId=null; localStops=[];
      scenarioName.value=''; dispatchInfo.value='';
      photoInput.value=''; radius.value=50; caption.value='';
      uiShow(scenarioMeta);
    };
    goEdit.onclick = ()=>{ uiHide(landing); uiShow(editPanel); loadForEdit(); };
    backFromEdit.onclick = ()=>{
      uiHide(editPanel); uiShow(landing);
      scenarioList.innerHTML=''; editStatus.textContent='Ready';
    };

    // ===================== Create flow =====================
    savePhoto.onclick = async ()=>{
      try{
        const file = photoInput.files?.[0];
        if(!file){ alert('Please choose a photo first.'); return; }

        if(!currentScenarioId){
          const name=(scenarioName.value||'').trim();
          if(!name){ alert('Please enter a Scenario Name.'); return; }
          const dispatch=(dispatchInfo.value||'').trim();
          const newRef = push(ref(db,'scenarios'));
          currentScenarioId=newRef.key;
          await set(newRef,{
            id:currentScenarioId, title:name, dispatch:dispatch,
            createdAt:Date.now(), active:true, stops:[]
          });
          uiHide(scenarioMeta);
        }

        const dataURL = await readFileAsDataURL(file);
        const gps = await getGPS();
        const r = Math.max(5, Math.min(1000, Math.round(parseInt(radius.value||'50',10))));
        const stop = {
          title: '',
          caption: (caption.value||'').trim(),
          lat: gps.lat, lng: gps.lng,
          radiusMeters: r,
          imageData: dataURL
        };

        localStops.push(stop);
        await set(ref(db,'scenarios/'+currentScenarioId+'/stops'), localStops);

        photoInput.value=''; caption.value=''; radius.value=50;
        renderThumbs();
        toast(createStatus, `Saved photo #${localStops.length}.`);
      }catch(e){
        alert('Save failed: ' + (e?.message||e));
      }
    };

    finalizeScenario.onclick = async ()=>{
      try{
        if(!currentScenarioId){
          const name=(scenarioName.value||'').trim();
          if(!name){ alert('Enter Scenario Name, then Save a Photo or press Save Scenario again to create empty.'); return; }
          const dispatch=(dispatchInfo.value||'').trim();
          const newRef=push(ref(db,'scenarios'));
          currentScenarioId=newRef.key;
          await set(newRef,{
            id:currentScenarioId, title:name, dispatch:dispatch,
            createdAt:Date.now(), active:true, stops:[]
          });
          uiHide(scenarioMeta);
        }
        toast(createStatus,'Scenario saved.');
        currentScenarioId=null; localStops=[];
        renderThumbs();
        scenarioName.value=''; dispatchInfo.value='';
        photoInput.value=''; caption.value=''; radius.value=50;
        uiShow(scenarioMeta);
      }catch(e){
        alert('Save Scenario failed: ' + (e?.message||e));
      }
    };

    // ===================== Edit view =====================
    async function loadForEdit(){
      try{
        editStatus.textContent='Loading scenarios…';
        const snap=await get(ref(db,'scenarios'));
        if(!snap.exists()){ editStatus.textContent='No scenarios found.'; scenarioList.innerHTML=''; return; }
        const obj=snap.val()||{};
        const arr=Object.entries(obj).map(([id,s])=>({id,...s}))
          .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        editStatus.textContent=`${arr.length} scenario(s)`;
        scenarioList.innerHTML='';

        arr.forEach(sc=>{
          const row=document.createElement('div');
          row.className='listItem';
          const left=document.createElement('div');
          left.innerHTML = `<div style="font-weight:800">${sc.title||'(untitled)'}</div>
                            <div class="tag">Stops: ${Array.isArray(sc.stops)? sc.stops.length : 0} • ${new Date(sc.createdAt||Date.now()).toLocaleString()}</div>`;
          const right=document.createElement('div');
          const openBtn=document.createElement('button');
          openBtn.className='btn'; openBtn.textContent='Open in Creator';
          openBtn.onclick=()=>{
            landing.classList.add('hidden');
            editPanel.classList.add('hidden');
            createPanel.classList.remove('hidden');
            currentScenarioId=sc.id;
            localStops=Array.isArray(sc.stops)? sc.stops : [];
            renderThumbs();
            uiHide(scenarioMeta);
            toast(createStatus, `Editing: ${sc.title||('(untitled)')}`);
            dispatchInfo.value = sc.dispatch || '';
            scenarioName.value = sc.title || '';
          };
          const toggleBtn=document.createElement('button');
          toggleBtn.className='btn secondary'; toggleBtn.style.marginLeft='8px';
          toggleBtn.textContent=sc.active ? 'Deactivate' : 'Activate';
          toggleBtn.onclick=()=>update(ref(db,'scenarios/'+sc.id), { active: !sc.active });
          const delBtn=document.createElement('button');
          delBtn.className='btn danger'; delBtn.style.marginLeft='8px';
          delBtn.textContent='Delete';
          delBtn.onclick=async()=>{
            if(confirm('Delete this scenario? This cannot be undone.')){
              await set(ref(db,'scenarios/'+sc.id), null);
              row.remove();
            }
          };
          right.appendChild(openBtn); right.appendChild(toggleBtn); right.appendChild(delBtn);
          row.appendChild(left); row.appendChild(right);
          scenarioList.appendChild(row);
        });
      }catch(e){
        editStatus.textContent='Error: '+(e?.message||e);
      }
    }

    // ===================== TTS Queue (NO BEEPS) =====================
    let sharedAudio = null;
    let audioUnlocked = false;
    let playing = false;
    const queue = [];

    // Short SILENT MP3 (priming only). Not audible; satisfies iOS user-gesture requirement.
    const SILENT_MP3 =
      "data:audio/mpeg;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGlinZwAAAA8AAAACAAACcQCAAAAAAABAAACAAACcQCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

    async function primeAudio() {
      if (audioUnlocked) return true;
      sharedAudio = new Audio();
      sharedAudio.setAttribute('playsinline','');
      sharedAudio.preload = 'auto';
      sharedAudio.src = SILENT_MP3;
      sharedAudio.onended = () => { playing = false; playNext(); };
      try {
        // Must be called directly by the Start button tap
        await sharedAudio.play();
        audioUnlocked = true;
        return true;
      } catch (e) {
        console.warn('Audio unlock failed:', e);
        return false;
      }
    }

    // Replace with your backend that returns an MP3 Blob for the text (OpenAI TTS).
    async function fetchOpenAITTS(text){
      // Example:
      // const resp = await fetch('/api/tts', {
      //   method:'POST',
      //   headers:{'Content-Type':'application/json'},
      //   body: JSON.stringify({ text })
      // });
      // const blob = await resp.blob(); // audio/mpeg
      // return URL.createObjectURL(blob);

      // Placeholder returns silent clip so flow is testable without audio.
      return SILENT_MP3;
    }

    function enqueueUrl(url){
      queue.push(url);
      if (!playing) playNext();
    }

    function playNext(){
      if (!audioUnlocked || playing || queue.length === 0) return;
      const url = queue.shift();
      sharedAudio.src = url;
      playing = true;
      sharedAudio.play().catch(err=>{
        console.warn('Playback error, skipping clip:', err);
        playing = false;
        playNext();
      });
    }

    async function enqueueText(text){
      const clean = (text||'').trim();
      if (!clean) return;
      const url = await fetchOpenAITTS(clean);
      enqueueUrl(url);
    }

    async function startScenarioAndSpeakAll(){
      const ok = await primeAudio();
      if (!ok){
        alert('Tap again to enable audio.');
        return;
      }
      // Read dispatch first
      const dispatch = (dispatchInfo.value||'').trim();
      if (dispatch) await enqueueText(dispatch);
      // Then each caption
      for (const stop of localStops){
        if (stop && stop.caption) await enqueueText(stop.caption);
      }
      toast(createStatus, 'Voice: reading dispatch and all captions…');
    }

    startScenarioBtn.addEventListener('click', startScenarioAndSpeakAll);

  </script>
</body>
</html>
