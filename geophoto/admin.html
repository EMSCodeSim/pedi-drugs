<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Advanced Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#eaf2ff;background:#0b0f14}
    .wrap{max-width:1200px;margin:16px auto;padding:0 16px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:#0f1a2e;color:#fff;border:1px solid rgba(255,255,255,.14);cursor:pointer}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:#94a3b8}
    .grid{display:grid;grid-template-columns:320px 1fr 360px;gap:12px}
    .card{background:#0f1624;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    label{display:block;margin:8px 0 4px 2px;font-size:12px;color:#94a3b8}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0d2430;color:#eaf2ff}
    #c{display:block;width:100%;height:62vh;background:#061621;border:1px solid rgba(255,255,255,.12);border-radius:12px}
    #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999}
    @media (max-width:1200px){ .grid{grid-template-columns:1fr} #c{height:56vh} }
  </style>
</head>
<body>
  <div id="errbar"></div>
  <div class="wrap">
    <div class="bar" style="justify-content:space-between;margin-bottom:10px">
      <div class="pill" id="status">Loading…</div>
      <div class="bar">
        <button class="btn" id="refresh">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <label>Scenario</label>
        <select id="scenarioSel"><option value="">Select…</option></select>

        <div style="height:8px"></div>
        <div class="pill">Stops</div>
        <div id="stopList" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>

        <div style="height:10px"></div>
        <div class="pill">Selected Stop</div>
        <label>Title</label><input id="stopTitle">
        <label>Caption</label><textarea id="stopCaption"></textarea>

        <div class="bar" style="margin-top:8px">
          <button class="btn" id="saveMeta">Save Meta</button>
          <button class="btn" id="deleteStop">Delete</button>
        </div>
        <div id="metaMsg" class="pill" style="margin-top:8px">Ready</div>

        <div style="height:12px"></div>
        <div class="pill">Replace photo (local preview)</div>
        <div class="bar"><input type="file" accept="image/*" id="replaceFile"><button class="btn" id="replaceApply">Preview</button></div>
      </div>

      <div class="card">
        <div class="bar" style="margin-bottom:8px">
          <button class="btn" id="fit">Fit</button>
          <span class="pill" id="cInfo">Canvas</span>
          <button class="btn" id="saveImage">Save Image</button>
          <button class="btn" id="exportPNG">Export PNG</button>
        </div>
        <canvas id="c"></canvas>
      </div>

      <div class="card">
        <div class="pill">GPS</div>
        <div class="bar"><button class="btn" id="useGPS">Use my location</button></div>
        <div class="bar" style="margin-top:8px"><div style="flex:1"><label>Lat</label><input id="stopLat"></div><div style="flex:1"><label>Lng</label><input id="stopLng"></div></div>
        <label>Radius (m)</label><input id="stopRadius" value="50">
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous"></script>
  <script type="module">
  const errbar=document.getElementById('errbar'); const ERR=m=>{errbar.textContent=m;errbar.style.display='block';};

  (async ()=>{
    try{
      const [{ initializeApp }] = await Promise.all([ import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js') ]);
      const [{ getDatabase, ref, onValue, get, set }] = await Promise.all([ import('https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js') ]);
      const [{ getStorage, ref:stRef, uploadString, getDownloadURL }] = await Promise.all([ import('https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js') ]);
      const [{ getAuth, onAuthStateChanged, signInAnonymously }] = await Promise.all([ import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js') ]);

      const firebaseConfig = {
        apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
        authDomain:"dailyquiz-d5279.firebaseapp.com",
        databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
        projectId:"dailyquiz-d5279",
        storageBucket:"dailyquiz-d5279.appspot.com",
        appId:"1:94577748034:web:c032d3a1d72db1313de5db",
        measurementId:"G-19DVN7NNH7"
      };
      const app = initializeApp(firebaseConfig);
      const db  = getDatabase(app);
      const storage = getStorage(app);
      const auth = getAuth(app);
      const BUCKET = app.options?.storageBucket || (firebaseConfig.projectId + '.appspot.com');

      let STORAGE_ENABLED = true;
      async function ensureAuthed(){
        if (auth.currentUser) return auth.currentUser;
        try{
          await signInAnonymously(auth);
          return await new Promise(res=>{ const off=onAuthStateChanged(auth,u=>{ if(u){ off(); res(u);} }); });
        }catch(e){
          const code=e?.code||'';
          if (code==='auth/configuration-not-found' || code==='auth/operation-not-allowed'){
            STORAGE_ENABLED=false; document.getElementById('cInfo').textContent='Saving inline (Auth not enabled)';
            return null;
          }
          throw e;
        }
      }

      // DOM
      const status=document.getElementById('status'); const scenarioSel=document.getElementById('scenarioSel'); const stopList=document.getElementById('stopList'); const refresh=document.getElementById('refresh');
      const stopTitle=document.getElementById('stopTitle'); const stopCaption=document.getElementById('stopCaption'); const metaMsg=document.getElementById('metaMsg');
      const stopLat=document.getElementById('stopLat'); const stopLng=document.getElementById('stopLng'); const stopRadius=document.getElementById('stopRadius'); const useGPS=document.getElementById('useGPS');
      const replaceFile=document.getElementById('replaceFile'); const replaceApply=document.getElementById('replaceApply'); // <- fixed const
      const fit=document.getElementById('fit'); const saveImage=document.getElementById('saveImage'); const exportPNG=document.getElementById('exportPNG'); const cInfo=document.getElementById('cInfo');
      const deleteStop=document.getElementById('deleteStop');

      const ROOT='scenarios'; let scenarios=[], current=null, stopIndex=-1;

      const fabricCanvas = new fabric.Canvas('c', { backgroundColor:'#061621', preserveObjectStacking:true }); let baseImage=null;
      function fitCanvas(){ const el=document.getElementById('c'); const h=Math.max(380, window.innerHeight-320); el.style.height=h+'px'; fabricCanvas.setHeight(h); fabricCanvas.calcOffset(); fabricCanvas.requestRenderAll(); } fitCanvas(); addEventListener('resize',fitCanvas);
      function setBaseFromURL(url){ return new Promise((res,rej)=>{ fabric.Image.fromURL(url, img=>{ if(!img){rej(new Error('Load failed'));return;}
        if(baseImage) fabricCanvas.remove(baseImage); baseImage=img; baseImage.set({ selectable:false, evented:false, erasable:false });
        const cw=fabricCanvas.getWidth(), ch=fabricCanvas.getHeight(); const sc=Math.min(cw/img.width, ch/img.height); baseImage.scale(sc); baseImage.set({ left:(cw-img.width*sc)/2, top:(ch-img.height*sc)/2 }); fabricCanvas.add(baseImage); baseImage.moveTo(0); fabricCanvas.requestRenderAll(); cInfo.textContent=`Image ${img.width}×${img.height}`; res(); }, { crossOrigin:'anonymous' }); }); }
      function imgURLFromStored(v){ return (typeof v==='string' && v.startsWith('data:') || typeof v==='string' && v.startsWith('http')) ? v :
                                     (v?.data ? `data:image/${(v.format==='jpeg'?'jpeg':'png')};base64,${v.data}` : ''); }

      function stopsOf(sc){ return Array.isArray(sc?.stops) ? sc.stops : Array.isArray(sc?.photos) ? sc.photos : []; }
      function setStops(sc, stops){ if (Array.isArray(sc?.stops)) sc.stops=stops; else if (Array.isArray(sc?.photos)) sc.photos=stops; else sc.stops=stops; }

      async function loadScenarios(){
        try{ const snap=await get(ref(db,ROOT)); const obj=snap.exists()? (snap.val()||{}):{}; scenarios=Object.entries(obj).map(([id,s])=>({id,_raw:s,_stops:stopsOf(s),...s})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
          scenarioSel.innerHTML='<option value="">Select…</option>'; scenarios.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=(s.title||'(untitled)'); scenarioSel.appendChild(o); });
          status.textContent=`${scenarios.length} scenario(s) loaded`;
        }catch(e){ status.textContent='Error: '+(e?.message||e); ERR(e?.message||e); }
      }
      function renderThumbs(){ stopList.innerHTML=''; if(!current) return; current._stops.forEach((s,i)=>{ const img=document.createElement('img'); img.style.cssText='width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,.14);cursor:pointer';
        img.src = imgURLFromStored(s.imageURL || s.imageData) || ''; img.title=s.title||`Stop ${i+1}`; img.onclick=()=>loadStop(i); stopList.appendChild(img); }); }

      scenarioSel.onchange=()=>{ const id=scenarioSel.value; current=scenarios.find(s=>s.id===id)||null; stopIndex=-1; renderThumbs(); fabricCanvas.clear(); baseImage=null; };
      refresh.onclick=loadScenarios;

      async function loadStop(i){
        const s=current?._stops[i]; if(!s) return; stopIndex=i; stopTitle.value=s.title||''; stopCaption.value=s.caption||'';
        stopLat.value=(s.lat??''); stopLng.value=(s.lng??''); stopRadius.value=(s.radiusMeters??50);
        const src=imgURLFromStored(s.imageURL||s.imageData); if(!src){ metaMsg.textContent='No image.'; return; }
        await setBaseFromURL(src);
      }

      function serializeOverlays(){ // (none for this minimal build)
        return [];
      }

      async function saveStopMeta(){
        try{
          if(!current || stopIndex<0) throw new Error('Select a stop.');
          const s={ ...current._stops[stopIndex] };
          s.title=stopTitle.value.trim(); s.caption=stopCaption.value.trim();
          s.lat = stopLat.value.trim()===''? null : parseFloat(stopLat.value);
          s.lng = stopLng.value.trim()===''? null : parseFloat(stopLng.value);
          s.radiusMeters = Math.max(5, Math.min(1000, Math.round(parseInt(stopRadius.value||'50',10))));
          s.overlays = serializeOverlays();
          const next=[...current._stops]; next[stopIndex]=s;
          const updated={ ...current._raw }; setStops(updated,next);
          await set(ref(db,`${ROOT}/${current.id}`), updated);
          current._raw=updated; current._stops=next; renderThumbs(); metaMsg.textContent='Meta saved.';
        }catch(e){ metaMsg.textContent='Error: '+(e?.message||e); }
      }
      document.getElementById('saveMeta').onclick=saveStopMeta;

      // Save Image (to Cloud when possible, otherwise inline)
      function encodeCanvas(){ const url=fabricCanvas.toDataURL({ format:'jpeg', quality:0.9 }); return { format:'jpeg', data:url.split(',')[1], dataURL:url }; }
      async function uploadEditedToStorage(dataURL, scenarioId, idx){
        await ensureAuthed(); if(!STORAGE_ENABLED) return null;
        const ts=Date.now(); const path=`scenarios/${scenarioId}/${ts}_edited_${idx}.jpg`; const refObj=stRef(storage,path);
        await uploadString(refObj,dataURL,'data_url'); const url=await getDownloadURL(refObj); const gsUri=`gs://${BUCKET}/${path}`; return {url,path,gsUri};
      }
      async function persistImage(){
        try{
          if(!current || stopIndex<0) throw new Error('Select a stop first.');
          const enc=encodeCanvas(); let cloud=null;
          try{ cloud=await uploadEditedToStorage(`data:image/${enc.format};base64,${enc.data}`, current.id, stopIndex); }catch(_){ STORAGE_ENABLED=false; }
          const s={ ...current._stops[stopIndex] };
          if (cloud){ s.imageURL=cloud.url; s.storagePath=cloud.path; s.gsUri=cloud.gsUri; s.imageData=null; metaMsg.textContent='Saved to Cloud Storage.'; }
          else { s.imageURL=null; s.storagePath=null; s.gsUri=null; s.imageData={ format:enc.format, data:enc.data }; metaMsg.textContent='Saved inline (Auth not enabled).'; }
          s.overlays = serializeOverlays();
          const next=[...current._stops]; next[stopIndex]=s; const updated={ ...current._raw }; setStops(updated,next);
          await set(ref(db,`${ROOT}/${current.id}`), updated); current._raw=updated; current._stops=next; renderThumbs();
        }catch(e){ metaMsg.textContent='Error: '+(e?.message||e); }
      }
      saveImage.onclick=persistImage;

      exportPNG.onclick=()=>{ const url=fabricCanvas.toDataURL({format:'png',quality:1}); const a=document.createElement('a'); a.href=url; a.download='edited.png'; a.click(); };
      fit.onclick=()=>{ if(!baseImage) return; setBaseFromURL(baseImage.toDataURL({})); };

      // GPS + replace preview
      useGPS.onclick=()=>navigator.geolocation.getCurrentPosition(p=>{ stopLat.value=p.coords.latitude.toFixed(6); stopLng.value=p.coords.longitude.toFixed(6); metaMsg.textContent='GPS captured.'; }, e=>{ metaMsg.textContent='GPS error: '+e.message; }, {enableHighAccuracy:true, timeout:10000});
      const readAsDataURL=f=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
      replaceApply.onclick=async()=>{ const f=replaceFile.files?.[0]; if(!f){ metaMsg.textContent='Choose a file first.'; return; } const data=await readAsDataURL(f); await setBaseFromURL(data); };

      // Delete stop
      deleteStop.onclick=async()=>{ try{
        if(!current || stopIndex<0) return; if(!confirm('Delete this stop?')) return;
        const next=[...current._stops]; next.splice(stopIndex,1); const updated={ ...current._raw }; setStops(updated,next);
        await set(ref(db,`${ROOT}/${current.id}`), updated); current._stops=next; stopIndex=-1; fabricCanvas.clear(); baseImage=null; renderThumbs(); metaMsg.textContent='Deleted.';
      }catch(e){ metaMsg.textContent='Error: '+(e?.message||e); } };

      // Live updates
      onValue(ref(db,ROOT), snap=>{
        const v=snap.val()||{}; scenarios=Object.entries(v).map(([id,s])=>({id,_raw:s,_stops:stopsOf(s),...s})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        const curId=scenarioSel.value; scenarioSel.innerHTML='<option value="">Select…</option>'; scenarios.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.title||'(untitled)'; scenarioSel.appendChild(o); });
        if(curId){ scenarioSel.value=curId; current=scenarios.find(s=>s.id===curId)||null; renderThumbs(); }
        status.textContent=`${scenarios.length} scenario(s) loaded`;
      });

      await loadScenarios();

    }catch(e){ ERR(e?.message||e); }
  })();
  </script>
</body>
</html>
