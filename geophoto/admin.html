<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Geo Scenarios — Admin</title>
<style>
  :root{
    --bg:#0a0f14; --surface:#0f1820; --panel:#142431;
    --text:#eaf7fb; --muted:#9bc6d2; --border:#244656;
    --primary:#1fa3ff; --primaryText:#04131c;
    --accent:#2dd4bf; --accentText:#042e2a;
    --danger:#ff6b6b; --dangerText:#2a0a0a;
    --br:16px; --pad:14px; --gap:12px; --shadow:0 6px 24px rgba(0,0,0,.45);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f4fbff; --surface:#ffffff; --panel:#ffffff;
      --text:#0b1e27; --muted:#4f6b78; --border:#d3e5ec;
      --primary:#0077cc; --primaryText:#ffffff;
      --accent:#00a38c; --accentText:#ffffff;
      --danger:#d93b3b; --dangerText:#ffffff;
      --shadow:0 6px 24px rgba(0,0,0,.08);
    }
    body{background:linear-gradient(180deg,#eef7fc,#ffffff 30%)}
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
  header{position:sticky;top:0;z-index:20;padding:10px 14px;background:color-mix(in hsl, var(--bg) 88%, transparent);backdrop-filter:blur(6px) saturate(1.05);border-bottom:1px solid var(--border)}
  h1{font-size:20px;margin:0}
  .wrap{max-width:900px;margin:0 auto;padding:12px 14px calc(80px + env(safe-area-inset-bottom))}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--br);box-shadow:var(--shadow);padding:var(--pad);margin:var(--gap) 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .stickyBar{position:sticky;top:56px;z-index:19;background:color-mix(in hsl, var(--bg) 85%, transparent);backdrop-filter:blur(6px) saturate(1.05);border-bottom:1px solid var(--border);padding:8px 0;margin:0 -14px 12px}
  .stickyBar .inner{max-width:900px;margin:0 auto;padding:0 14px;display:flex;gap:10px}
  .btn{appearance:none;border:0;border-radius:12px;padding:13px 14px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .btn.primary{background:var(--primary);color:var(--primaryText)}
  .btn.accent{background:var(--accent);color:var(--accentText)}
  .btn.ghost{background:transparent;color:var(--text);border:2px dashed var(--border)}
  .btn.danger{background:var(--danger);color:var(--dangerText)}
  label{display:block;margin:10px 0 6px 2px;font-size:13px;color:var(--muted)}
  input,textarea,select{width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:16px;outline:none}
  input:focus,textarea:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 2px color-mix(in srgb, var(--primary) 30%, transparent)}
  textarea{min-height:84px;resize:vertical}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr 1fr}
  @media (max-width:680px){.g2,.g3{grid-template-columns:1fr}}
  .hint{color:var(--muted);font-size:13px;margin:6px 2px}
  .thumb{width:82px;height:82px;border-radius:12px;object-fit:cover;background:#0b2130;border:1px solid var(--border)}
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(82px,1fr));gap:10px}
  .media{width:100%;height:auto;border-radius:14px;background:#0a2230;border:1px solid var(--border)}
  .divider{height:1px;background:var(--border);opacity:.6;margin:12px 0}
  #error{white-space:pre-wrap;background:#241113;border:1px solid #7b2b2b;color:#ffd6d6;padding:.75rem;border-radius:12px;display:none}
</style>
</head>
<body>
<header><h1>Geo Scenarios — Admin</h1></header>

<div class="wrap">
  <!-- Mode chooser -->
  <div class="card" id="modeCard">
    <div class="row">
      <button id="btnCreateMode" class="btn primary" style="flex:1">Create Scenario</button>
      <button id="btnEditMode" class="btn ghost" style="flex:1">Edit Scenario</button>
    </div>
    <p class="hint">Choose what you want to do.</p>
  </div>

  <!-- Sticky actions (Create mode) -->
  <div id="stickyActions" class="stickyBar" style="display:none">
    <div class="inner">
      <button id="topAddPhoto" class="btn accent" style="flex:1">Add Photo</button>
      <button id="topEndScenario" class="btn primary" style="flex:1">End Scenario</button>
    </div>
  </div>

  <!-- Create Scenario pane -->
  <div id="createPane" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Create Scenario</h3>

    <!-- Scenario name + Dispatch (first time only) -->
    <div id="scenarioNameBlock">
      <label>Scenario name</label>
      <input id="scTitle" placeholder="e.g., Station Tour A" />
      <label>Dispatch information</label>
      <textarea id="dispatchInfo" placeholder="Call details, unit assignments, address, notes…"></textarea>
      <label class="hint">These fields are required only once. They’ll be hidden after the first photo is saved.</label>
      <div class="divider"></div>
    </div>

    <!-- Add Photo flow -->
    <div id="photoFlow">
      <label>Photo (camera)</label>
      <input id="file" type="file" accept="image/*" capture="environment" />
      <img id="preview" class="media" style="display:none" alt="Preview" />

      <div class="grid g2">
        <div><label>Latitude</label><input id="lat" readonly placeholder="Auto-captured…" /></div>
        <div><label>Longitude</label><input id="lng" readonly placeholder="Auto-captured…" /></div>
      </div>
      <div class="row">
        <button id="retryGPS" class="btn ghost" style="width:auto">Retry GPS</button>
        <span id="gpsStatus" class="hint">Waiting for photo to request location…</span>
      </div>

      <div class="grid g3">
        <div><label>Radius (meters)</label><input id="radius" type="number" value="50" min="5" step="5" /></div>
        <div><label>Stop title (optional)</label><input id="stopTitle" placeholder="Short label" /></div>
        <div><label>…or Image URL</label><input id="imageUrl" placeholder="https://…" /></div>
      </div>

      <label>Text / Caption (optional)</label>
      <textarea id="caption" placeholder="What should the user read at this stop?"></textarea>
      <p id="sizeInfo" class="hint"></p>

      <div class="row" style="margin-top:8px">
        <button id="savePhoto" class="btn accent" style="flex:1">Save Photo</button>
      </div>
    </div>

    <div class="divider"></div>

    <h4 style="margin:0 0 8px">Photos in this scenario</h4>
    <div id="gallery" class="gallery"></div>
    <p id="countNote" class="hint">0 photo(s)</p>
  </div>

  <!-- Edit Scenario pane -->
  <div id="editPane" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Edit Scenario</h3>

    <!-- List view -->
    <div id="editListView">
      <div id="scList"></div>
      <div id="editBlock" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <label>Scenario name</label>
        <input id="editTitle" />
        <label>Dispatch information</label>
        <textarea id="editDispatch"></textarea>
        <label>Active?</label>
        <select id="editActive"><option value="true">Yes</option><option value="false">No</option></select>

        <div class="divider"></div>
        <div class="row" style="justify-content:space-between">
          <h4 style="margin:0">Photos</h4>
          <button id="editAddPhoto" class="btn accent" style="width:auto">Add Photo</button>
        </div>
        <div id="editGallery" class="gallery" style="margin-top:8px"></div>

        <div class="row" style="margin-top:10px">
          <button id="saveScenarioChanges" class="btn primary" style="flex:1">Save Scenario Changes</button>
          <button id="backToList" class="btn ghost" style="flex:1">Back</button>
        </div>
        <p id="editStatus" class="hint"></p>
      </div>
    </div>

    <!-- Stop editor view (shows when a thumbnail is tapped) -->
    <div id="stopEditorView" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h4 style="margin:0">Edit Photo</h4>
        <button id="backToScenario" class="btn ghost" style="width:auto">Back to Scenario</button>
      </div>

      <img id="se_preview" class="media" alt="Preview" />
      <div class="grid g2" style="margin-top:8px">
        <div><label>Latitude</label><input id="se_lat" /></div>
        <div><label>Longitude</label><input id="se_lng" /></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="se_useGPS" class="btn primary" style="width:auto">Use my location</button>
        <span id="se_gpsStatus" class="hint"></span>
      </div>

      <div class="grid g3" style="margin-top:8px">
        <div><label>Radius (m)</label><input id="se_radius" type="number" min="5" step="5" /></div>
        <div><label>Stop title</label><input id="se_title" /></div>
        <div><label>Replace photo</label><input id="se_file" type="file" accept="image/*" capture="environment" /></div>
      </div>
      <label class="hint">…or Image URL</label>
      <input id="se_url" placeholder="https://…">

      <label style="margin-top:8px">Caption / Text</label>
      <textarea id="se_caption"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="se_saveStop" class="btn primary" style="flex:1">Save Stop Changes</button>
        <button id="se_deleteStop" class="btn danger" style="flex:1">Delete Stop</button>
      </div>
      <p id="se_info" class="hint"></p>
    </div>
  </div>

  <div id="error"></div>
</div>

<script type="module">
(async () => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const showErr = (e) => { const box=$('error'); box.style.display='block'; box.textContent=String(e && e.stack?e.stack:e); console.error(e); };
  const compressToDataURL = async (file, maxDim=1280, quality=0.72) => {
    const img = new Image(); const rdr = new FileReader();
    const data = await new Promise((res, rej)=>{ rdr.onload=()=>res(rdr.result); rdr.onerror=rej; rdr.readAsDataURL(file); });
    await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=data; });
    let { width:w, height:h } = img;
    if (w>h && w>maxDim) { h = Math.round(h*(maxDim/w)); w = maxDim; }
    else if (h>w && h>maxDim) { w = Math.round(w*(maxDim/h)); h = maxDim; }
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    c.getContext('2d').drawImage(img,0,0,w,h);
    return c.toDataURL('image/jpeg', quality);
  };
  const makeThumb = (src) => {
    const img = document.createElement('img'); img.className='thumb'; img.alt='thumb'; img.src=src || '';
    img.onerror = () => { img.src="data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='#0a2230'/><text x='50%' y='50%' fill='#9ecbd6' font-size='12' text-anchor='middle'>No image</text></svg>"); };
    return img;
  };
  const setPreviewSafe = (imgEl, stop) => {
    imgEl.src = stop.imageData || stop.imageURL || '';
    imgEl.onerror = () => {
      imgEl.src = "data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='100%' height='100%' fill='#0a2230'/><text x='50%' y='50%' fill='#9ecbd6' font-size='18' text-anchor='middle'>Image failed to load</text></svg>");
    };
  };

  // ---------- Firebase (RTDB only) ----------
  const [{ initializeApp }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js") ]);
  const [{ getDatabase, ref, onValue, push, set, update }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js") ]);
  const firebaseConfig = {
    apiKey: "AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
    authDomain: "dailyquiz-d5279.firebaseapp.com",
    databaseURL: "https://dailyquiz-d5279-default-rtdb.firebaseio.com",
    projectId: "dailyquiz-d5279",
    appId: "1:94577748034:web:c032d3a1d72db1313de5db",
    measurementId: "G-19DVN7NNH7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- UI refs ----------
  const modeCard = $('modeCard');
  const btnCreateMode = $('btnCreateMode');
  const btnEditMode = $('btnEditMode');

  const stickyActions = $('stickyActions');
  const topAddPhoto = $('topAddPhoto');
  const topEndScenario = $('topEndScenario');

  const createPane = $('createPane');
  const scenarioNameBlock = $('scenarioNameBlock');

  const scTitle = $('scTitle');
  const dispatchInfo = $('dispatchInfo');

  const file = $('file');
  const preview = $('preview');
  const lat = $('lat');
  const lng = $('lng');
  const gpsStatus = $('gpsStatus');
  const retryGPS = $('retryGPS');
  const radius = $('radius');
  const stopTitle = $('stopTitle');
  const imageUrl = $('imageUrl');
  const caption = $('caption');
  const savePhoto = $('savePhoto');
  const sizeInfo = $('sizeInfo');
  const gallery = $('gallery');
  const countNote = $('countNote');

  const editPane = $('editPane');
  const editListView = $('editListView');
  const scList = $('scList');
  const editBlock = $('editBlock');
  const editTitle = $('editTitle');
  const editDispatch = $('editDispatch');
  const editActive = $('editActive');
  const editGallery = $('editGallery');
  const editAddPhoto = $('editAddPhoto');
  const saveScenarioChanges = $('saveScenarioChanges');
  const backToList = $('backToList');
  const editStatus = $('editStatus');

  const stopEditorView = $('stopEditorView');
  const se_preview = $('se_preview');
  const se_lat = $('se_lat');
  const se_lng = $('se_lng');
  const se_useGPS = $('se_useGPS');
  const se_gpsStatus = $('se_gpsStatus');
  const se_radius = $('se_radius');
  const se_title = $('se_title');
  const se_file = $('se_file');
  const se_url = $('se_url');
  const se_caption = $('se_caption');
  const se_saveStop = $('se_saveStop');
  const se_deleteStop = $('se_deleteStop');
  const backToScenario = $('backToScenario');
  const se_info = $('se_info');

  // ---------- State ----------
  let createState = {
    scenarioNamed: false,
    scenarioTitle: '',
    dispatchInfo: '',
    photos: []
  };
  let scenarioList = [];
  let editingScenario = null;
  let editingStopIndex = -1; // index being edited (in stop editor)

  // ---------- Mode switching ----------
  function showCreate() {
    modeCard.style.display = 'none';
    editPane.style.display = 'none';
    createPane.style.display = 'block';
    stickyActions.style.display = 'block';
    scenarioNameBlock.style.display = createState.scenarioNamed ? 'none' : 'block';
  }
  function showEdit() {
    modeCard.style.display = 'none';
    createPane.style.display = 'none';
    stickyActions.style.display = 'none';
    editPane.style.display = 'block';
    stopEditorView.style.display = 'none';
    editListView.style.display = 'block';
    renderScenarioList();
  }
  btnCreateMode.onclick = showCreate;
  btnEditMode.onclick = showEdit;

  // ---------- Create flow ----------
  function resetPhotoForm(keepScenario=true) {
    if (!keepScenario) {
      createState = { scenarioNamed:false, scenarioTitle:'', dispatchInfo:'', photos:[] };
      scTitle.value = '';
      dispatchInfo.value = '';
      scenarioNameBlock.style.display = 'block';
      gallery.innerHTML = '';
      countNote.textContent = '0 photo(s)';
    }
    file.value = '';
    preview.style.display = 'none';
    imageUrl.value = '';
    stopTitle.value = '';
    caption.value = '';
    radius.value = 50;
    lat.value = ''; lng.value = '';
    sizeInfo.textContent = '';
    gpsStatus.textContent = 'Waiting for photo to request location…';
  }
  function renderCreateGallery() {
    gallery.innerHTML = '';
    createState.photos.forEach(p => gallery.appendChild(makeThumb(p.imageData || p.imageURL)));
    countNote.textContent = `${createState.photos.length} photo(s)`;
  }
  async function captureGPS(targetLatEl, targetLngEl, statusEl) {
    if (statusEl) statusEl.textContent = 'Requesting GPS…';
    return new Promise((resolve) => {
      const onOk = (pos)=>{ targetLatEl.value = pos.coords.latitude.toFixed(6); targetLngEl.value = pos.coords.longitude.toFixed(6); if(statusEl) statusEl.textContent = `GPS ok (±${Math.round(pos.coords.accuracy)}m)`; resolve(true); };
      const onErr = (err)=>{ if(statusEl) statusEl.textContent = 'Location error: ' + err.message; resolve(false); };
      try { navigator.geolocation.getCurrentPosition(onOk, onErr, { enableHighAccuracy:true, timeout:10000, maximumAge:0 }); }
      catch (e) { if(statusEl) statusEl.textContent = 'Geolocation not supported'; resolve(false); }
    });
  }

  // Auto-GPS when a photo file is picked (create)
  file.onchange = async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    sizeInfo.textContent = 'Compressing image…';
    try {
      const dataURL = await compressToDataURL(f);
      preview.src = dataURL; preview.style.display = 'block';
      const bytes = Math.ceil((dataURL.length - 'data:image/jpeg;base64,'.length) * 3/4);
      sizeInfo.textContent = `Image ~${Math.round(bytes/1024)} KB`;
      await captureGPS(lat, lng, gpsStatus);
      savePhoto.dataset.pendingImageData = dataURL;
      savePhoto.dataset.pendingImageURL = '';
    } catch (err) { sizeInfo.textContent = 'Failed to process image.'; }
  };
  retryGPS.onclick = async () => { await captureGPS(lat, lng, gpsStatus); };

  // Sticky actions
  topAddPhoto.onclick = () => { resetPhotoForm(true); window.scrollTo({ top: 0, behavior: 'smooth' }); file.focus(); };
  topEndScenario.onclick = async () => {
    try {
      if (!createState.scenarioNamed) throw new Error('Name the scenario and enter dispatch info first.');
      if (!createState.photos.length) throw new Error('Add at least one photo.');
      const newRef = push(ref(db, 'scenarios'));
      await set(newRef, {
        title: createState.scenarioTitle,
        dispatch: createState.dispatchInfo,
        notes: '',
        active: true,
        createdAt: Date.now(),
        stops: createState.photos
      });
      resetPhotoForm(false);
      alert('Scenario saved!');
    } catch (e) { alert(e.message || e); }
  };

  // Save Photo (create)
  savePhoto.onclick = async () => {
    try {
      if (!createState.scenarioNamed) {
        const title = scTitle.value.trim(); if (!title) throw new Error('Please name the scenario.');
        createState.scenarioTitle = title;
        createState.dispatchInfo = (dispatchInfo.value || '').trim();
        createState.scenarioNamed = true;
        scenarioNameBlock.style.display = 'none';
      }
      const inlineData = savePhoto.dataset.pendingImageData || '';
      const url = (imageUrl.value || '').trim();
      if (!inlineData && !url) throw new Error('Choose a photo or paste an image URL.');
      const la = parseFloat(lat.value), ln = parseFloat(lng.value);
      if (Number.isNaN(la) || Number.isNaN(ln)) throw new Error('GPS not available yet. Tap Retry GPS.');
      const r = Math.max(5, parseInt(radius.value || '50', 10));
      const stop = {
        title: (stopTitle.value || '').trim(),
        caption: (caption.value || '').trim(),
        lat: la, lng: ln, radiusMeters: r,
        active: true, createdAt: Date.now(),
        imageData: inlineData || null, imageURL: inlineData ? null : url
      };
      createState.photos.push(stop);
      renderCreateGallery();
      delete savePhoto.dataset.pendingImageData; delete savePhoto.dataset.pendingImageURL;
      resetPhotoForm(true);
      alert('Photo saved to scenario.');
    } catch (e) { alert(e.message || e); }
  };

  // ---------- Edit list ----------
  onValue(ref(db, 'scenarios'), (snap) => {
    const val = snap.val() || {};
    scenarioList = Object.entries(val).map(([id, s]) => ({ id, ...s }))
      .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    if (editPane.style.display !== 'none') renderScenarioList();
  }, showErr);

  function renderScenarioList() {
    const list = $('scList'); list.innerHTML = '';
    editBlock.style.display = 'none';
    stopEditorView.style.display = 'none';
    editListView.style.display = 'block';
    if (!scenarioList.length) { editStatus.textContent = 'No scenarios yet.'; return; }
    editStatus.textContent = `${scenarioList.length} scenario(s)`;
    scenarioList.forEach(sc => {
      const row = document.createElement('div'); row.className = 'row'; row.style.padding='8px 0';
      const first = (sc.stops && sc.stops[0]) || {};
      row.appendChild(makeThumb(first.imageData || first.imageURL));
      const meta = document.createElement('div'); meta.style.flex='1';
      meta.innerHTML = `<div style="font-weight:800">${sc.title || '(untitled)'}</div>
                        <div class="hint">${(sc.stops?.length || 0)} photo(s) • ${sc.active ? 'Active' : 'Inactive'}</div>
                        ${sc.dispatch ? `<div class="hint">Dispatch: ${String(sc.dispatch).slice(0,160)}</div>` : ''}`;
      row.appendChild(meta);
      const openBtn = document.createElement('button'); openBtn.className='btn ghost'; openBtn.textContent='Open';
      openBtn.onclick = () => openEditor(sc.id);
      row.appendChild(openBtn);
      list.appendChild(row);
    });
  }

  function openEditor(id) {
    const sc = scenarioList.find(s => s.id === id);
    if (!sc) { editStatus.textContent = 'Scenario not found.'; return; }
    editingScenario = JSON.parse(JSON.stringify(sc));
    editBlock.style.display = 'block';
    editTitle.value = editingScenario.title || '';
    editDispatch.value = editingScenario.dispatch || '';
    editActive.value = editingScenario.active ? 'true' : 'false';

    // thumbnails
    editGallery.innerHTML = '';
    (editingScenario.stops || []).forEach((st, idx) => {
      const t = makeThumb(st.imageData || st.imageURL);
      t.style.cursor = 'pointer';
      t.title = 'Tap to edit';
      t.onclick = () => openStopEditor(idx);
      editGallery.appendChild(t);
    });
  }

  // Add Photo (Edit mode) → adds a new stop and immediately opens Stop Editor
  editAddPhoto.onclick = () => {
    if (!editingScenario) return;
    (editingScenario.stops ||= []).push({
      title:'', caption:'', lat:'', lng:'', radiusMeters:50, active:true, createdAt:Date.now(), imageData:null, imageURL:''
    });
    openStopEditor(editingScenario.stops.length - 1);
  };

  // Stop editor
  function openStopEditor(index) {
    editingStopIndex = index;
    const st = editingScenario.stops[index];
    if (!st) return;
    editListView.style.display = 'none';
    stopEditorView.style.display = 'block';
    setPreviewSafe(se_preview, st);
    se_lat.value = st.lat ?? '';
    se_lng.value = st.lng ?? '';
    se_radius.value = st.radiusMeters ?? 50;
    se_title.value = st.title ?? '';
    se_url.value = st.imageURL ?? '';
    se_caption.value = st.caption ?? '';
    se_info.textContent = '';
    se_file.value = '';
  }

  backToScenario.onclick = () => {
    stopEditorView.style.display = 'none';
    editListView.style.display = 'block';
    // re-render thumbs in case image changed
    openEditor(editingScenario.id);
  };

  se_useGPS.onclick = async () => {
    await captureGPS(se_lat, se_lng, se_gpsStatus);
  };

  se_file.onchange = async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    se_info.textContent = 'Compressing image…';
    const data = await compressToDataURL(f);
    se_preview.src = data;
    se_info.textContent = `New image selected (~${Math.round((data.length - 'data:image/jpeg;base64,'.length) * 3/4 / 1024)} KB). Not saved yet.`;
    se_preview.dataset.newImageData = data; // temp stash
  };

  se_saveStop.onclick = async () => {
    try{
      if (!editingScenario || editingStopIndex < 0) return;
      const st = editingScenario.stops[editingStopIndex];
      st.lat = parseFloat(se_lat.value);
      st.lng = parseFloat(se_lng.value);
      if (Number.isNaN(st.lat) || Number.isNaN(st.lng)) throw new Error('Please provide valid GPS coordinates or use “Use my location”.');
      st.radiusMeters = Math.max(5, parseInt(se_radius.value || '50', 10));
      st.title = (se_title.value || '').trim();
      st.caption = (se_caption.value || '').trim();
      const url = (se_url.value || '').trim();
      // prefer newly uploaded image, otherwise keep URL if provided
      if (se_preview.dataset.newImageData) {
        st.imageData = se_preview.dataset.newImageData;
        st.imageURL = null;
      } else if (url) {
        st.imageURL = url;
        if (!st.imageData) st.imageData = null;
      }
      // Persist *only this scenario* (full payload write for simplicity)
      const { id, ...payload } = editingScenario;
      await set(ref(db, 'scenarios/' + editingScenario.id), payload);
      se_preview.dataset.newImageData = '';
      se_info.textContent = 'Saved!';
    }catch(err){ se_info.textContent = String(err.message || err); }
  };

  se_deleteStop.onclick = async () => {
    try{
      if (!editingScenario || editingStopIndex < 0) return;
      editingScenario.stops.splice(editingStopIndex, 1);
      const { id, ...payload } = editingScenario;
      await set(ref(db, 'scenarios/' + editingScenario.id), payload);
      // Back to scenario list view for that scenario
      stopEditorView.style.display = 'none';
      editListView.style.display = 'block';
      openEditor(editingScenario.id);
    }catch(err){ se_info.textContent = String(err.message || err); }
  };

  // Scenario meta save
  saveScenarioChanges.onclick = async () => {
    try{
      if (!editingScenario) return;
      editingScenario.title = editTitle.value.trim() || '(untitled)';
      editingScenario.dispatch = (editDispatch.value || '').trim();
      editingScenario.active = (editActive.value === 'true');
      const { id, ...payload } = editingScenario;
      await set(ref(db, 'scenarios/' + editingScenario.id), payload);
      alert('Scenario changes saved.');
    }catch(err){ alert(err.message || err); }
  };
  backToList.onclick = () => { editBlock.style.display = 'none'; };

  // ---------- Start on chooser ----------
})();
</script>
</body>
</html>
