<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Scenario Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14;--bg2:#0d121c;--panel:#0f1624;
      --text:#eaf2ff;--muted:#9fb2d6;--edge:rgba(255,255,255,.14);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 12% -8%, rgba(10,132,255,.22), transparent 60%),
                 radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.16), transparent 60%),
                 linear-gradient(165deg,var(--bg2),var(--bg) 55%);
      overflow-x:hidden}
    header{position:sticky;top:0;z-index:10;background:rgba(12,16,24,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--edge)}
    .bar{max-width:1100px;margin:0 auto;padding:12px;display:flex;gap:10px;align-items:center;justify-content:center}
    .brand{font-weight:900}
    main{max-width:1100px;margin:14px auto 30px;padding:0 12px;display:grid;gap:12px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 26%),linear-gradient(180deg,#0f1624,#0e1420);
      border:1px solid var(--edge);border-radius:16px;padding:14px}
    .hidden{display:none !important}
    label{display:block;font-weight:700;margin-top:8px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;background:#0b1322;color:#eaf2ff;border:1px solid var(--edge)}
    textarea{min-height:90px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--edge);background:#132136;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted)}
    .barWrap{height:10px;border:1px solid var(--edge);border-radius:8px;background:#0c1322;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#2484ff,#63dbff)}
    .preview{width:100%;max-height:70vh;display:grid;place-items:center;background:#050e19;border:1px solid var(--edge);border-radius:14px;overflow:hidden}
    .preview img{max-width:100%;max-height:70vh;object-fit:contain;display:block}
    /* Gallery */
    #gallery{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
    .gItem{border:1px solid var(--edge);border-radius:12px;overflow:hidden;background:#0b1322}
    .gItem img{width:100%;height:100%;object-fit:cover;display:block;aspect-ratio:1/1}
    .gCap{padding:6px 8px;font-size:12px;color:var(--muted)}
    /* Toast/overlay */
    #errbar{position:fixed;left:12px;bottom:12px;z-index:99;display:none;padding:10px 12px;border-radius:12px;border:1px solid #7a2b2b;background:#2b0d0d;color:#ffd7d7}
    #loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,12,20,.55);backdrop-filter:blur(2px);z-index:98}
    .spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="errbar"></div>
  <div id="loader"><div class="spinner"></div></div>

  <header>
    <div class="bar">
      <div class="brand">FireOps SIM — Scenario Builder</div>
    </div>
  </header>

  <main>
    <!-- STEP 1 -->
    <section id="step1" class="card">
      <h3 style="margin:0">Step 1 — Scenario details</h3>
      <div class="hint">Enter a name and (optional) dispatch. Create the scenario to continue.</div>
      <label>Scenario Name</label>
      <input id="sTitle" placeholder="e.g., House Fire — Elm St.">
      <label>Dispatch (optional)</label>
      <textarea id="sDispatch" placeholder="Engine 1, Engine 2, Medic 1…"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="createBtn" class="btn">Create Scenario</button>
        <span id="s1Status" class="hint">idle</span>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card hidden">
      <h3 style="margin:0 0 6px">Step 2 — Add a photo stop</h3>
      <div class="hint">Take a photo, choose from your photo library, or upload a file. GPS is added automatically.</div>

      <div class="row" style="margin:8px 0 6px">
        <button id="btnCamera" class="btn">Take Photo</button>
        <button id="btnLibrary" class="btn">Choose from Library</button>
        <button id="btnUpload" class="btn">Upload File</button>
      </div>
      <input id="inCamera"  type="file" accept="image/*" capture="environment" class="hidden">
      <input id="inLibrary" type="file" accept="image/*" class="hidden">
      <input id="inUpload"  type="file" accept="image/*" class="hidden">

      <div id="workArea" class="hidden">
        <div class="preview" style="margin:10px 0">
          <img id="previewImg" alt="preview">
        </div>

        <div class="row">
          <div class="hint" id="imgInfo">Image: —</div>
          <div class="row" style="margin-left:auto">
            <label for="radius" class="hint">Radius (m)</label>
            <input id="radius" type="number" min="1" max="1000" value="5" style="width:110px">
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div id="gpsLine" class="hint">GPS: acquiring…</div>
        </div>

        <div style="margin-top:10px">
          <div class="row" style="justify-content:space-between">
            <span class="hint">Full upload</span><span id="pctFull" class="hint">0%</span>
          </div>
          <div class="barWrap"><div id="barFull" class="bar"></div></div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <span class="hint">Thumbnail</span><span id="pctThumb" class="hint">0%</span>
          </div>
          <div class="barWrap"><div id="barThumb" class="bar"></div></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="saveBtn" class="btn">Save Photo</button>
          <button id="resetBtn" class="btn ghost">Choose another</button>
          <span id="saveStatus" class="hint">waiting</span>
        </div>

        <div id="afterSave" class="hidden" style="margin-top:8px">
          <button id="addAnotherBtn" class="btn">Add another photo</button>
          <span class="hint">Repeat to add more stops.</span>
        </div>
      </div>
    </section>

    <!-- BOTTOM GALLERY -->
    <section id="galleryCard" class="card hidden">
      <h3 style="margin:0 0 6px">Photos in this scenario</h3>
      <div id="gallery"></div>
      <div id="galleryEmpty" class="hint">No photos yet.</div>
    </section>
  </main>

  <!-- Firebase (modules) -->
  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const show = (el, on)=> (typeof el==='string'?$(el):el).classList.toggle('hidden', !on);
    const sayErr = (m)=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 5000); };
    const busy = (on)=> $('loader').style.display = on ? 'grid' : 'none';

    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref as dbRef, push, update, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const cfg = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const app = initializeApp(cfg);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app, "gs://dailyquiz-d5279.appspot.com");

    async function ensureAuthed(){
      if (auth.currentUser) return auth.currentUser;
      await signInAnonymously(auth);
      await new Promise(res=> onAuthStateChanged(auth, u=>u && res(), {once:true}));
      return auth.currentUser;
    }
    ensureAuthed().catch(()=>{});

    /* ---------- Imaging ---------- */
    const FULL_EDGE=1280, FULL_Q=0.75, THUMB_EDGE=480, THUMB_Q=0.8;

    const readAsDataURL = f => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    const loadImage = src => new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; });
    function downscale(img, maxEdge, q){
      const s = Math.min(1, maxEdge/Math.max(img.width, img.height));
      const c = document.createElement('canvas'); c.width=Math.round(img.width*s); c.height=Math.round(img.height*s);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      return c.toDataURL('image/jpeg', q);
    }
    function dataURLtoBlob(u){ const [h,b64]=u.split(','); const mime=(/data:(.*?);base64/).exec(h)[1]; const bin=atob(b64), a=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) a[i]=bin.charCodeAt(i); return new Blob([a],{type:mime}); }

    /* ---------- State ---------- */
    let scenarioId=null, pendingFile=null, pendingImg=null, pendingFullDataURL=null, pendingThumbDataURL=null, pendingGeo=null;
    let localStops=[];

    const sTitle = $('sTitle'), sDispatch=$('sDispatch');

    function gate(){
      show('step2', !!scenarioId);
      show('galleryCard', !!scenarioId);
      renderGallery();
    }

    /* ---------- Gallery render ---------- */
    function renderGallery(){
      const host=$('gallery');
      const empty=$('galleryEmpty');
      host.innerHTML='';
      if(!Array.isArray(localStops) || localStops.length===0){
        empty.textContent='No photos yet.';
        show(empty, true);
        return;
      }
      show(empty, false);
      localStops.forEach((s, i)=>{
        const card=document.createElement('div'); card.className='gItem';
        const img=document.createElement('img'); img.src=s.thumbURL||s.imageURL||''; img.alt=s.caption||('Stop '+(i+1));
        const cap=document.createElement('div'); cap.className='gCap'; cap.textContent=s.caption||('Stop '+(i+1));
        card.appendChild(img); card.appendChild(cap); host.appendChild(card);
      });
    }

    /* ---------- Step 1: Create ---------- */
    $('createBtn').onclick = async ()=>{
      try{
        await ensureAuthed();
        const title=(sTitle.value||'').trim();
        if(!title){ $('s1Status').textContent='enter a name'; return; }
        $('s1Status').textContent='creating…';

        const id = push(dbRef(db,'scenarios')).key;
        const base = {
          id, title, dispatch:(sDispatch.value||'').trim(),
          description:(sDispatch.value||'').trim(),
          createdAt: Date.now(), active:true, stops:[]
        };
        const multi={}; multi[`scenarios/${id}`]=base; multi[`geophoto/scenarios/${id}`]=base;
        await update(dbRef(db), multi);

        scenarioId=id;
        localStops=[]; // new scenario
        $('s1Status').textContent='created ✓';
        gate();
      }catch(e){
        $('s1Status').textContent='error';
        sayErr(e.message||String(e));
      }
    };

    /* ---------- Step 2: Pickers ---------- */
    const open = id => $(id).click();
    $('btnCamera').onclick  = ()=> open('inCamera');
    $('btnLibrary').onclick = ()=> open('inLibrary');
    $('btnUpload').onclick  = ()=> open('inUpload');

    async function onPick(file){
      if(!file || !scenarioId) return;
      pendingFile=file;
      try{
        const dataURL = await readAsDataURL(file);
        const img = await loadImage(dataURL);
        pendingImg=img;
        // Reduced + thumb
        pendingFullDataURL  = downscale(img, FULL_EDGE,  FULL_Q);
        pendingThumbDataURL = downscale(img, THUMB_EDGE, THUMB_Q);

        $('previewImg').src = pendingFullDataURL;
        $('imgInfo').textContent = `Original: ${img.width}×${img.height} → Saving ~${Math.round(Math.max(img.width,img.height) > FULL_EDGE ? FULL_EDGE : Math.max(img.width,img.height))} px`;
        show('workArea', true);
        $('saveStatus').textContent='ready';
        $('pctFull').textContent='0%'; $('barFull').style.width='0%';
        $('pctThumb').textContent='0%'; $('barThumb').style.width='0%';

        // Auto GPS
        $('gpsLine').textContent='GPS: acquiring…';
        pendingGeo=null;
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            p=>{ pendingGeo={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:Math.round(p.coords.accuracy||0)}; $('gpsLine').textContent=`GPS: ${pendingGeo.lat.toFixed(6)}, ${pendingGeo.lng.toFixed(6)} ±${pendingGeo.accuracy||'–'} m`; },
            _=>{ $('gpsLine').textContent='GPS: unavailable'; },
            {enableHighAccuracy:true,timeout:8000,maximumAge:0}
          );
        }else{
          $('gpsLine').textContent='GPS: not supported';
        }
      }catch(e){
        sayErr('Could not read image: '+(e.message||e));
      }
    }
    $('inCamera').addEventListener('change', e=> onPick(e.target.files?.[0]));
    $('inLibrary').addEventListener('change',e=> onPick(e.target.files?.[0]));
    $('inUpload').addEventListener('change', e=> onPick(e.target.files?.[0]));

    $('resetBtn').onclick = ()=>{
      pendingFile=pendingImg=pendingFullDataURL=pendingThumbDataURL=null;
      $('previewImg').src=''; show('workArea',false); show('afterSave',false);
      $('pctFull').textContent='0%'; $('barFull').style.width='0%';
      $('pctThumb').textContent='0%'; $('barThumb').style.width='0%';
      $('radius').value='5';
    };

    /* ---------- Upload helpers ---------- */
    function watchTask(task, which){
      return new Promise((res,rej)=>{
        const killer = setTimeout(()=>{ try{task.cancel();}catch{} rej(new Error('Upload timed out')); }, 60000);
        task.on('state_changed',
          s=>{
            const pct=Math.round(100*s.bytesTransferred/s.totalBytes);
            if(which==='full'){ $('pctFull').textContent=pct+'%'; $('barFull').style.width=pct+'%'; }
            else { $('pctThumb').textContent=pct+'%'; $('barThumb').style.width=pct+'%'; }
          },
          e=>{ clearTimeout(killer); rej(e); },
          ()=>{ clearTimeout(killer); res(); }
        );
      });
    }

    async function uploadBlobs(ts, fullDataURL, thumbDataURL){
      await ensureAuthed(); // ensure before uploading

      const fullRef  = stRef(storage, `scenarios/${scenarioId}/${ts}.jpg`);
      const thmbRef  = stRef(storage, `scenarios/${scenarioId}/thumbs/${ts}.jpg`);
      const meta     = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };

      try{
        const fullTask  = uploadBytesResumable(fullRef,  dataURLtoBlob(fullDataURL), meta);
        await watchTask(fullTask,'full');

        const thumbTask = uploadBytesResumable(thmbRef,  dataURLtoBlob(thumbDataURL), meta);
        await watchTask(thumbTask,'thumb');

        const imageURL = await getDownloadURL(fullRef);
        const thumbURL = await getDownloadURL(thmbRef).catch(()=>imageURL);
        return { imageURL, thumbURL, storagePath: fullRef.fullPath, gsUri:`gs://${cfg.storageBucket}/${fullRef.fullPath}` };
      }catch(e1){
        // Fallback to your function with ID token (Advanced Editor style)
        try{
          const u = await ensureAuthed(); const token = u ? await u.getIdToken() : null;
          const resp = await fetch('https://us-central1-dailyquiz-d5279.cloudfunctions.net/uploadScenarioImage', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{}) },
            body: JSON.stringify({ scenarioId, fileName: `${ts}.jpg`, dataURL: fullDataURL })
          });
          if(!resp.ok) throw new Error('Function HTTP '+resp.status);
          const j = await resp.json(); if(!j.ok) throw new Error(j.error||'Function error');
          return { imageURL:j.url, thumbURL:j.url, storagePath:j.path, gsUri:j.gsUri };
        }catch(e2){
          // Final fallback: inline (ensures progress even if network rules block)
          return { imageData:{format:'jpeg', data: fullDataURL.split(',')[1]}, thumbURL: thumbDataURL };
        }
      }
    }

    async function appendStopToDB(stop){
      // Pull latest stops to avoid overwriting
      let stops=[];
      try{
        const snap = await get(dbRef(db, `scenarios/${scenarioId}/stops`));
        stops = snap.exists()? (snap.val()||[]) : [];
      }catch{}
      stops.push(stop);
      const multi={};
      multi[`scenarios/${scenarioId}/stops`] = stops;
      multi[`geophoto/scenarios/${scenarioId}/stops`] = stops;
      await update(dbRef(db), multi);
      localStops = stops;
      renderGallery();
    }

    /* ---------- Save Photo ---------- */
    $('saveBtn').onclick = async ()=>{
      if(!(scenarioId && pendingFullDataURL)) return;
      try{
        busy(true);
        $('saveStatus').textContent='uploading…'; show('afterSave',false);

        const ts = Date.now();
        const cloud = await uploadBlobs(ts, pendingFullDataURL, pendingThumbDataURL);

        const r = Math.max(1, Math.min(1000, parseInt(($('radius').value||'5'),10) || 5));
        const stop = {
          type:'photo', title:'', caption:'',
          imageURL: cloud.imageURL || '',
          thumbURL: cloud.thumbURL || '',
          storagePath: cloud.storagePath || '',
          gsUri: cloud.gsUri || '',
          imageData: cloud.imageData || null,
          lat: pendingGeo?.lat ?? null, lng: pendingGeo?.lng ?? null, accuracy: pendingGeo?.accuracy ?? null,
          radiusMeters:r, overlays:[], at: ts
        };

        await appendStopToDB(stop);

        $('saveStatus').textContent='saved ✓';
        show('afterSave', true);
      }catch(e){
        $('saveStatus').textContent='error';
        sayErr(e.message||String(e));
      }finally{
        busy(false);
      }
    };

    /* ---------- Add another ---------- */
    $('addAnotherBtn').onclick = ()=>{
      pendingFile=pendingImg=pendingFullDataURL=pendingThumbDataURL=null;
      $('previewImg').src=''; show('workArea',false); show('afterSave',false);
      $('pctFull').textContent='0%'; $('barFull').style.width='0%';
      $('pctThumb').textContent='0%'; $('barThumb').style.width='0%';
      $('radius').value='5';
    };
  </script>
</body>
</html>
