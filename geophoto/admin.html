<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FireOps SIM ‚Äî Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{ --bg:#0b0f14; --bg2:#0e1421; --card:#0f1624; --edge:rgba(255,255,255,.10); --text:#eaf2ff; --muted:#93a0b5; --red:#7a2b2b; --green:#2c7a4b; }
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
    radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
    linear-gradient(165deg, var(--bg2), var(--bg) 55%);
}
.topbar{position:sticky;top:0;z-index:20;background:rgba(12,15,22,.78);backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
.topnav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
.brand{font-weight:900}
.version{font-size:12px;color:var(--muted)}
.spacer{flex:1}
.btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#142238,#0f1930);color:#fff;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn-danger{background:#2a0f14;border-color:var(--red)}
.tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:var(--muted)}
.small{font-size:12px;opacity:.9}
hr{border:none;height:1px;background:rgba(255,255,255,.08);margin:12px 0}
main{max-width:1200px;margin:16px auto 40px;padding:0 16px;display:grid;grid-template-columns:340px 1fr;gap:12px}
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px;min-height:120px}
label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
.input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff}
textarea{min-height:80px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px,1fr));gap:10px}
.thumb{width:100%;height:110px;object-fit:cover;border-radius:10px;background:#0a1a2a;border:1px solid rgba(255,255,255,.14)}
.visually-hidden{position:absolute; left:-9999px; top:auto; width:0.1px; height:0.1px; opacity:0; overflow:hidden; z-index:-1}
#errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid var(--red);border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#okbar{position:fixed;left:10px;bottom:56px;background:#0f2a19;color:#d8ffe2;border:1px solid var(--green);border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#loader{position:fixed;inset:0;display:none;place-items:center;z-index:99;background:rgba(6,12,20,.55);backdrop-filter:blur(2px)}
.spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* modal */
#photoModal{position:fixed;inset:0;display:none;place-items:center;z-index:999;background:rgba(5,10,18,.6);backdrop-filter:blur(2px)}
.modal-card{width:min(760px,96vw);background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px}
.modal-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modal-body{display:grid;grid-template-columns:220px 1fr;gap:12px}
.modal-body img{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);aspect-ratio:4/3;object-fit:cover}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
<div id="errbar"></div><div id="okbar"></div>
<div id="loader"><div class="spinner"></div></div>

<div class="topbar">
  <div class="topnav">
    <div class="brand">FireOps SIM ‚Äî Admin</div>
    <span class="version">v2025-09-04a</span>
    <div class="spacer"></div>
    <button id="showCreate" class="btn">Create Scenario</button>
    <button id="showEdit" class="btn">Edit Scenario</button>
    <a class="btn" href="./advanced-editor.html">Open Advanced Editor</a>
  </div>
</div>

<main>
  <!-- LEFT: Create -->
  <section class="card" id="createPane">
    <h3>Create Scenario</h3>
    <label>Title</label>
    <input id="cTitle" class="input" placeholder="e.g., Apartment Fire ‚Äî 5th St" />
    <label>Description</label>
    <textarea id="cDesc" placeholder="Short description‚Ä¶"></textarea>
    <div class="row">
      <button id="createBtn" class="btn">Create</button>
      <span id="createStatus" class="tag">Ready</span>
    </div>

    <hr />
    <h4>Add Photos (preview first, GPS on save)</h4>
    <input id="cFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="cFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="cFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="cFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <h4 style="margin-top:12px">Review (not saved yet)</h4>
    <div class="small">Tap <b>Save</b> on a photo (or <b>Save All</b>) to upload to the cloud.</div>
    <div class="row" style="margin:8px 0">
      <button id="cSaveAll" class="btn" disabled>Save All to Cloud</button>
      <button id="cClear" class="btn" disabled>Clear</button>
    </div>
    <div id="cPending" class="grid"></div>

    <hr />
    <h4>Uploaded Thumbs</h4>
    <div id="cUploads" class="grid"></div>
  </section>

  <!-- RIGHT: Edit -->
  <section class="card" id="editPane" style="display:none">
    <h3>Edit Scenario</h3>
    <label>Select a scenario</label>
    <select id="eSelect"><option value="">Loading‚Ä¶</option></select>
    <div class="row" style="margin-top:6px">
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="deleteScenario" class="btn btn-danger">Delete Scenario</button>
      <span id="eStatus" class="tag">‚Äî</span>
    </div>

    <hr />
    <div class="row" style="margin-top:6px">
      <div style="flex:1">
        <label>Title</label>
        <input id="eTitle" class="input" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="saveMeta" class="btn">Save Scenario</button>
      </div>
    </div>
    <label>Description</label>
    <textarea id="eDesc"></textarea>

    <hr />
    <h4>Add Photos (preview first, GPS on save)</h4>
    <input id="eFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="eFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="eFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="eFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <h4 style="margin-top:12px">Review (not saved yet)</h4>
    <div class="small">Tap <b>Save</b> to upload. Use <b>Use My Location</b> to attach GPS before saving.</div>
    <div class="row" style="margin:8px 0">
      <button id="eSaveAll" class="btn" disabled>Save All to Cloud</button>
      <button id="eClear" class="btn" disabled>Clear</button>
    </div>
    <div id="ePending" class="grid"></div>

    <hr />
    <h4>Uploaded Thumbs</h4>
    <div id="eUploads" class="grid" style="margin-top:8px"></div>

    <hr />
    <h4>Existing Stops</h4>
    <div id="stopsGrid" class="grid"></div>
  </section>
</main>

<!-- Photo editor modal -->
<div id="photoModal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="brand">Edit Photo</div>
      <div class="spacer"></div>
      <button id="pmClose" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <img id="pmPreview" src="" alt="preview"/>
      <div>
        <label>Title</label>
        <input id="pmTitle" class="input" />
        <label>Caption / Notes</label>
        <textarea id="pmCaption"></textarea>
        <div class="row">
          <div style="flex:1">
            <label>Latitude</label>
            <input id="pmLat" class="input" placeholder="e.g. 39.7392" />
          </div>
          <div style="flex:1">
            <label>Longitude</label>
            <input id="pmLng" class="input" placeholder="-104.9903" />
          </div>
        </div>
        <div class="row">
          <button id="pmUseMyLoc" class="btn">Use My Location</button>
          <span id="pmGpsStatus" class="tag">‚Äî</span>
        </div>
        <label>Radius (meters)</label>
        <input id="pmRadius" class="input" type="number" min="1" step="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="pmSave" class="btn">Save Photo</button>
    </div>
  </div>
</div>

<script type="module">
/* ---------- iOS safety & polyfills ---------- */
window.onerror = function(m,src,lin,col,err){ var b=document.getElementById('errbar'); if(b){ b.textContent='Script error: '+(err&&err.message?err.message:m); b.style.display='block'; } document.getElementById('loader').style.display='none'; };
window.onunhandledrejection = function(e){ var b=document.getElementById('errbar'); if(b){ b.textContent='Unhandled: '+(e && e.reason && e.reason.message ? e.reason.message : String(e && e.reason ? e.reason : e)); b.style.display='block'; } document.getElementById('loader').style.display='none'; };
if (!HTMLCanvasElement.prototype.toBlob) {
  HTMLCanvasElement.prototype.toBlob = function (cb, type, quality) {
    var bin = atob(this.toDataURL(type, quality).split(',')[1]);
    var len = bin.length, u8 = new Uint8Array(len);
    for (var i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
    cb(new Blob([u8], { type: type || 'image/png' }));
  };
}
if (!Object.entries) { Object.entries = function(obj){ var keys = Object.keys(obj); var out=[]; for (var i=0;i<keys.length;i++){ out.push([keys[i], obj[keys[i]]]); } return out; }; }

/* ---------- UI helpers ---------- */
function $(id){ return document.getElementById(id); }
function show(id,on){ var el=$(id); if(el) el.style.display = on ? '' : 'none'; }
function ok(m){ var b=$('okbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(function(){ b.style.display='none'; }, 2600); }
function err(m){ var b=$('errbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(function(){ b.style.display='none'; }, 6000); }
function loading(on){ var l=$('loader'); if(l) l.style.display = on ? 'grid' : 'none'; }

/* Nav buttons */
$('showCreate').onclick = function(){ show('createPane',true); show('editPane',false); };
$('showEdit').onclick = function(){ show('createPane',false); show('editPane',true); };

/* ---------- Firebase (modular SDK) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref as dbRef, set, push, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as stRef, uploadBytesResumable, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

/* Firebase config */
var firebaseConfig = {
  apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain:"dailyquiz-d5279.firebaseapp.com",
  databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId:"dailyquiz-d5279",
  storageBucket:"dailyquiz-d5279.firebasestorage.app",
  appId:"1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId:"G-19DVN7NNH7"
};
var appFB = initializeApp(firebaseConfig);
/* Always write to the real bucket */
var FORCE_BUCKET = "dailyquiz-d5279.appspot.com";
var storage = getStorage(appFB, "gs://"+FORCE_BUCKET);
var db = getDatabase(appFB);
var auth = getAuth(appFB);

/* ---------- Auth ---------- */
async function initAuth(){
  try{ await setPersistence(auth, browserLocalPersistence); }
  catch(e1){ try{ await setPersistence(auth, browserSessionPersistence); }
  catch(e2){ await setPersistence(auth, inMemoryPersistence); } }
  if (!auth.currentUser) await signInAnonymously(auth);
  await new Promise(function(res){ onAuthStateChanged(auth, function(u){ if(u) res(); }); });
}
async function ensureAuthed(){ if (!auth.currentUser) await initAuth(); return auth.currentUser; }

/* ---------- Data helpers ---------- */
var ROOT = 'scenarios';
var scenarios = [];
var createdId = null;

function coerceStops(sc){
  if (sc && Array.isArray(sc.stops)) return sc.stops;
  if (sc && Array.isArray(sc.photos)) return sc.photos;
  if (sc && Array.isArray(sc.images)) return sc.images;
  return [];
}
function setStops(sc, stops){
  if (!sc) return;
  if (Array.isArray(sc.stops)) sc.stops = stops;
  else if (Array.isArray(sc.photos)) sc.photos = stops;
  else if (Array.isArray(sc.images)) sc.images = stops;
  else sc.stops = stops;
}
function populateEditList(){
  var sel=$('eSelect'); if(!sel) return;
  sel.innerHTML='<option value="">Select‚Ä¶</option>';
  for (var i=0;i<scenarios.length;i++){
    var s=scenarios[i];
    var o=document.createElement('option');
    o.value=s.id; o.textContent=(s.title||'(untitled)') + (s.active? '':' (inactive)');
    sel.appendChild(o);
  }
}
async function safeLoadScenarios(){
  try{
    var snap = await get(dbRef(db, ROOT));
    var obj = snap.exists() ? (snap.val()||{}) : {};
    var arr = [];
    var entries = Object.entries(obj);
    for (var i=0;i<entries.length;i++){
      var id = entries[i][0]; var s = entries[i][1];
      arr.push({ id:id, _raw:s, _stops:coerceStops(s), title:s && s.title, description:s && s.description, createdAt:s && s.createdAt, active:(s && (s.active!==false)) });
    }
    arr.sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); });
    scenarios = arr;
    populateEditList();
    var cur = $('eSelect').value; if (cur) renderScenario(cur);
    $('eStatus').textContent='Loaded';
  }catch(e){
    $('eStatus').textContent='Load failed';
    console.warn('loadScenarios failed:', e);
  }
}

/* ---------- Image helpers (iOS-safe) ---------- */
var ORIG_MAX_EDGE = 1600, THUMB_MAX_EDGE = 480, JPEG_QUALITY = 0.82, MAX_PIXELS = 4000000;

function loadImageURL(url){
  return new Promise(function(resolve,reject){
    var img = new Image();
    img.onload = function(){ resolve(img); };
    img.onerror = function(){ reject(new Error('image load error')); };
    img.src = url;
  });
}
async function decodeToImage(file){
  try{
    var url = URL.createObjectURL(file);
    var img = await loadImageURL(url);
    return { img:img, url:url };
  }catch(e){
    try{
      var url2 = URL.createObjectURL(file);
      return { img:null, url:url2 };
    }catch(e2){
      return { img:null, url:null };
    }
  }
}
function scaleByMaxEdgeOrPixels(w,h){
  var edgeScale = Math.min(1, ORIG_MAX_EDGE / Math.max(w,h));
  var pixScale = Math.min(1, Math.sqrt(MAX_PIXELS / Math.max(1, w*h)));
  var s = Math.min(edgeScale, pixScale);
  return { w: Math.max(1, Math.round(w*s)), h: Math.max(1, Math.round(h*s)) };
}
async function canvasToBlob(nativeImg, targetEdge){
  var w = nativeImg.naturalWidth || nativeImg.width;
  var h = nativeImg.naturalHeight || nativeImg.height;
  var dims;
  if (targetEdge === ORIG_MAX_EDGE){
    dims = scaleByMaxEdgeOrPixels(w,h);
  } else {
    var s = Math.min(1, targetEdge / Math.max(w,h));
    dims = { w:Math.round(w*s), h:Math.round(h*s) };
  }
  var c = document.createElement('canvas'); c.width = dims.w; c.height = dims.h;
  var ctx = c.getContext('2d', { alpha:false });
  ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(nativeImg, 0, 0, dims.w, dims.h);
  var blob = await new Promise(function(res){ c.toBlob(res, 'image/jpeg', JPEG_QUALITY); });
  var dataURL = c.toDataURL('image/jpeg', JPEG_QUALITY);
  return { blob:blob, dataURL:dataURL, width:dims.w, height:dims.h };
}
function dataURLFromStored(stored){
  if (typeof stored === 'string') return stored;
  if (stored && stored.data){ return 'data:image/'+(stored.format||'jpeg')+';base64,'+stored.data; }
  return '';
}
function fileToDataURL(file){
  return new Promise(function(res,rej){
    var fr = new FileReader();
    fr.onload = function(){ res(fr.result); };
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* ---------- Geolocation ---------- */
function softCoords(timeoutMs){
  timeoutMs = timeoutMs || 1200;
  return new Promise(function(resolve){
    var done=false;
    function finish(v){ if(!done){ done=true; resolve(v); } }
    if (!('geolocation' in navigator)) return finish(null);
    navigator.geolocation.getCurrentPosition(
      function(pos){ finish({ lat:+pos.coords.latitude.toFixed(6), lng:+pos.coords.longitude.toFixed(6), accuracy:pos.coords.accuracy }); },
      function(){ finish(null); },
      { enableHighAccuracy:true, maximumAge:60000, timeout:timeoutMs }
    );
    setTimeout(function(){ finish(null); }, timeoutMs+100);
  });
}

/* ---------- Pending review lists ---------- */
var pendingCreate = []; // {file,url,title,caption,lat,lng}
var pendingEdit   = [];

function enablePendingButtons(scope){
  var has = (scope==='c') ? pendingCreate.length>0 : pendingEdit.length>0;
  $(scope+'SaveAll').disabled = !has;
  $(scope+'Clear').disabled   = !has;
}
function addPending(files, scope){
  var list = (scope==='c') ? pendingCreate : pendingEdit;
  for (var i=0;i<files.length;i++){
    list.push({ file:files[i], url:null, title:'', caption:'', lat:null, lng:null });
  }
  renderPending(scope);
}
function renderPending(scope){
  var list = (scope==='c') ? pendingCreate : pendingEdit;
  var container = $(scope+'Pending');
  container.innerHTML='';
  for (var i=0;i<list.length;i++){
    (function(i){
      var p = list[i];
      if (!p.url){ try{ p.url = URL.createObjectURL(p.file); }catch(e) { p.url=''; } }
      var card = document.createElement('div');
      card.style.cssText='padding:8px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:#0f1624';
      card.innerHTML =
        '<img class="thumb" src="'+p.url+'" alt="preview" onerror="this.replaceWith(Object.assign(document.createElement(\\'div\\'),{className:\\'tag small\\',textContent:\\'(Preview not supported)\\'}))" />' +
        '<div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">' +
          '<input class="input ptitle" placeholder="Optional title" value="'+(p.title||'')+'">' +
          '<input class="input pcaption" placeholder="Optional caption" value="'+(p.caption||'')+'">' +
        '</div>' +
        '<div class="row" style="justify-content:space-between;margin-top:6px">' +
          '<span class="tag small" data-status>Ready</span>' +
          '<div class="row">' +
            '<button class="btn" data-gps>Use My Location</button>' +
            '<button class="btn" data-save>Save</button>' +
            '<button class="btn btn-danger" data-del>Discard</button>' +
          '</div>' +
        '</div>';
      container.appendChild(card);
      card.querySelector('.ptitle').oninput = function(e){ p.title=e.target.value; };
      card.querySelector('.pcaption').oninput = function(e){ p.caption=e.target.value; };
      card.querySelector('[data-del]').onclick = function(){
        try{ if (p.url) URL.revokeObjectURL(p.url); }catch(e){}
        list.splice(i,1); renderPending(scope); enablePendingButtons(scope);
      };
      card.querySelector('[data-gps]').onclick = async function(){
        var status = card.querySelector('[data-status]');
        status.textContent='Getting GPS‚Ä¶';
        var c = await softCoords(2000);
        if (c){ p.lat=c.lat; p.lng=c.lng; status.textContent='GPS ‚úì'; } else { status.textContent='GPS ‚Äî'; err('Could not get GPS.'); }
      };
      card.querySelector('[data-save]').onclick = function(){ saveOnePending(scope, i, card); };
    })(i);
  }
  enablePendingButtons(scope);
}

/* ---------- Cloud Function fallback ---------- */
var FUNCTION_UPLOAD_URL = 'https://us-central1-dailyquiz-d5279.cloudfunctions.net/uploadScenarioImage';
async function uploadViaFunction(dataURL, scenarioId, fileName){
  var resp = await fetch(FUNCTION_UPLOAD_URL, {
    method:'POST', headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ scenarioId:scenarioId, fileName:fileName, dataURL:dataURL })
  });
  if (!resp.ok){ var txt = await resp.text(); var e = new Error('Function HTTP '+resp.status+' '+txt); e.code='save/function-http'; throw e; }
  var json = await resp.json();
  if (!json.ok){ var e2 = new Error('Function error: '+(json.error||'unknown')); e2.code='save/function-error'; throw e2; }
  return { url: json.url, path: json.path, gsUri: json.gsUri, via:'function' };
}

/* ---------- Upload helpers ---------- */
function extFromType(t){
  if (!t) return '.jpg';
  var lt = String(t).toLowerCase();
  if (lt.indexOf('jpeg')>=0 || lt.indexOf('jpg')>=0) return '.jpg';
  if (lt.indexOf('png')>=0) return '.png';
  if (lt.indexOf('heic')>=0 || lt.indexOf('heif')>=0) return '.heic';
  if (lt.indexOf('webp')>=0) return '.webp';
  return '.jpg';
}
async function autoCreateIfNeeded(){
  if (createdId) return createdId;
  await ensureAuthed();
  var title = ($('cTitle') && $('cTitle').value ? $('cTitle').value.trim() : '') || '(untitled)';
  var desc  = ($('cDesc') && $('cDesc').value ? $('cDesc').value.trim() : '') || '';
  var id = (push(dbRef(db, ROOT))).key;
  try{
    await set(dbRef(db, ROOT + '/' + id), { id:id, title:title, description:desc, createdAt:Date.now(), active:true, stops: [] });
    createdId = id;
    ok('Scenario created');
    await safeLoadScenarios();
    $('showEdit').click();
    $('eSelect').value = id; $('eTitle').value = title; $('eDesc').value = desc;
    renderScenario(id);
    return id;
  }catch(e){
    err('Create failed (DB rules?): '+(e && (e.code||e.message) ? (e.code||e.message) : e));
    throw e;
  }
}
function uploadWithTimeout(fullRef, blob, metadata, onProgress){
  return new Promise(function(resolve,reject){
    var task = uploadBytesResumable(fullRef, blob, metadata);
    var killer = setTimeout(function(){
      try{ task.cancel(); }catch(e){}
      var er = new Error('Timed out while uploading'); er.code='save/timeout-upload'; reject(er);
    }, 45000);
    task.on('state_changed',
      function(s){ if (onProgress){ onProgress(Math.round((s.bytesTransferred/s.totalBytes)*100)); } },
      function(e){ clearTimeout(killer); reject(e); },
      function(){ clearTimeout(killer); resolve(); }
    );
  });
}

/* ---------- Save one / all ---------- */
async function saveOnePending(scope, idx, cardEl){
  var list = (scope==='c') ? pendingCreate : pendingEdit;
  var p = list[idx]; if (!p) return;
  var status = cardEl.querySelector('[data-status]');
  var scenarioId = (scope==='c') ? await autoCreateIfNeeded() : $('eSelect').value;
  if (!scenarioId){ err('Select a scenario first.'); return; }

  try{
    await ensureAuthed();
    status.textContent='Preparing‚Ä¶';

    var usedOriginal=false, width=0, height=0, fullBlob=null, dataURL=null, thumbBlob=null;

    var preview = await decodeToImage(p.file);
    if (preview.img){
      var full = await canvasToBlob(preview.img, ORIG_MAX_EDGE);
      fullBlob = full.blob; dataURL = full.dataURL; width=full.width; height=full.height;
      var th   = await canvasToBlob(preview.img, THUMB_MAX_EDGE);
      thumbBlob = th.blob;
    }else{
      usedOriginal = true;
      fullBlob = p.file;
      dataURL = await fileToDataURL(p.file);
    }

    var coords = (p.lat!=null && p.lng!=null) ? {lat:p.lat,lng:p.lng} : await softCoords(1200);
    var ts = Date.now();
    var basePath = 'scenarios/'+scenarioId+'/'+ts;
    var ext = usedOriginal ? extFromType(p.file.type) : '.jpg';
    var fullRef  = stRef(storage, basePath+ext);
    var thumbRef = stRef(storage, 'scenarios/'+scenarioId+'/thumbs/'+ts+'.jpg');
    var metaFull = { contentType: (usedOriginal && p.file.type) ? p.file.type : 'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };
    var metaThmb = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };

    status.textContent='Uploading 0%‚Ä¶';
    var cloud=null;
    try{
      await uploadWithTimeout(fullRef, fullBlob, metaFull, function(pct){ status.textContent='Uploading '+pct+'%‚Ä¶'; });
      if (thumbBlob){ try{ await uploadBytes(thumbRef, thumbBlob, metaThmb); }catch(e3){} }
      var imageURL = await getDownloadURL(fullRef);
      var thumbURL = imageURL;
      if (thumbBlob){ try{ thumbURL = await getDownloadURL(thumbRef); }catch(e4){} }
      cloud = { url:imageURL, thumbURL:thumbURL, path:fullRef.fullPath, gsUri:'gs://'+FORCE_BUCKET+'/'+fullRef.fullPath, via:'storage' };
    }catch(e1){
      status.textContent = 'Direct failed. Trying server‚Ä¶';
      try{
        var fileName = ts+'.jpg';
        var res = await uploadViaFunction(dataURL, scenarioId, fileName);
        cloud = { url:res.url, thumbURL:res.url, path:res.path, gsUri:res.gsUri, via:'function' };
      }catch(e2){
        cloud = null; // inline fallback
      }
    }

    var stop = {
      type:'photo',
      title: p.title || '',
      caption: p.caption || '',
      lat: coords && coords.lat!=null ? coords.lat : null,
      lng: coords && coords.lng!=null ? coords.lng : null,
      radiusMeters:50,
      width: width, height: height, overlays:[]
    };
    if (cloud){
      stop.imageURL   = cloud.url;
      stop.thumbURL   = cloud.thumbURL || cloud.url;
      stop.storagePath= cloud.path;
      stop.gsUri      = cloud.gsUri;
    }else{
      stop.imageData  = { format:'jpeg', data: (dataURL||'').split(',')[1] || '' };
    }

    status.textContent='Saving to DB‚Ä¶';
    var snap = await get(dbRef(db, ROOT+'/'+scenarioId));
    var sc = snap.val() || {};
    var stops = coerceStops(sc);
    stops.push(stop);
    setStops(sc, stops);
    await set(dbRef(db, ROOT+'/'+scenarioId), sc);

    status.textContent = cloud ? 'Saved ‚úì' : 'Saved inline ‚úì';
    ok(cloud ? 'Photo saved to cloud' : 'Photo saved (inline backup)');

    var uploads = $(scope+'Uploads');
    if (uploads){
      var img = document.createElement('img');
      img.className='thumb';
      img.src = cloud ? (stop.thumbURL || stop.imageURL) : ('data:image/jpeg;base64,'+stop.imageData.data);
      uploads.prepend(img);
    }

    try{ if (p.url) URL.revokeObjectURL(p.url); }catch(e){}
    list.splice(idx,1);
    renderPending(scope); enablePendingButtons(scope);

    await safeLoadScenarios();
    if ($('eSelect')){ $('eSelect').value = scenarioId; renderScenario(scenarioId); }

  }catch(ex){
    var code = ex && ex.code ? ex.code : '';
    var msg  = ex && ex.message ? ex.message : String(ex);
    if ((msg||'').match(/app.?check/i)) err('Blocked by App Check enforcement. Add App Check or disable enforcement.');
    else if (code.indexOf('unauthorized')>=0 || /PERMISSION_DENIED/i.test(msg)) err('Permission denied saving photo. Check Storage/DB rules.');
    else err('Save failed: ' + (code || msg));
    status.textContent='Failed';
  }
}
async function saveAll(scope){
  var list = (scope==='c') ? pendingCreate : pendingEdit;
  var i=0;
  while (i<list.length){
    var card = $(scope+'Pending').children[i];
    await saveOnePending(scope, i, card);
    if ($(scope+'Pending').children[i] === card){ i++; }
  }
}

/* ---------- Render & edit ---------- */
function renderScenario(id){
  var s = null;
  for (var i=0;i<scenarios.length;i++){ if (scenarios[i].id===id){ s=scenarios[i]; break; } }
  if (!s){ $('eStatus').textContent='Not found'; $('stopsGrid').innerHTML=''; return; }
  $('eTitle').value = s.title||'';
  $('eDesc').value  = s.description||'';
  $('eStatus').textContent = (s._stops && s._stops.length ? s._stops.length : 0) + ' photo(s)';
  var grid = $('stopsGrid'); grid.innerHTML='';
  if (!(s._stops && s._stops.length)){ grid.innerHTML='<div class="small tag">No photos yet</div>'; return; }

  for (var idx=0; idx<s._stops.length; idx++){
    (function(idx){
      var st = s._stops[idx];
      var thumb = (st && (st.thumbURL || st.imageURL)) || dataURLFromStored(st && st.imageData) || '';
      var hasGPS = !!(st && st.lat!=null && st.lng!=null);
      var el = document.createElement('div');
      el.innerHTML =
        '<img class="thumb" src="'+thumb+'" alt="thumb" />' +
        '<div class="small" style="margin-top:6px">'+(st.title||('Stop '+(idx+1)))+'</div>' +
        '<div class="row" style="margin-top:6px"><span class="tag small">'+(hasGPS?'GPS ‚úì':'GPS ‚Äî')+'</span></div>' +
        '<div class="row" style="margin-top:6px">' +
          '<button class="btn" data-edit>Edit</button>' +
          '<button class="btn" data-gps>Set GPS</button>' +
          '<button class="btn btn-danger" data-del>Delete</button>' +
        '</div>';
      grid.appendChild(el);

      el.querySelector('[data-edit]').onclick = function(){ openPhotoEditor(id, idx); };

      el.querySelector('[data-del]').onclick = async function(){
        try{
          loading(true);
          await ensureAuthed();
          var snap = await get(dbRef(db, ROOT+'/'+id));
          var sc = snap.val(); var arr = coerceStops(sc);
          var removed = arr.splice(idx,1)[0]; setStops(sc, arr);
          await set(dbRef(db, ROOT+'/'+id), sc);
          var paths = [];
          if (removed && removed.storagePath) paths.push(removed.storagePath);
          if (removed && removed.thumbPath)   paths.push(removed.thumbPath);
          if (removed && removed.gsUri)       paths.push(removed.gsUri);
          for (var j=0;j<paths.length;j++){ try{ await deleteObject(stRef(storage, paths[j])); }catch(e){} }
          ok('Stop deleted');
          await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
        }catch(e){ err('Delete failed: '+(e.message||e)); }
        finally{ loading(false); }
      };

      el.querySelector('[data-gps]').onclick = async function(){
        var coords = await softCoords(2000);
        if (!coords){ err('Could not get GPS (permission/signal).'); return; }
        try{
          loading(true);
          await ensureAuthed();
          var snap = await get(dbRef(db, ROOT+'/'+id));
          var sc = snap.val(); var arr = coerceStops(sc);
          if (!arr[idx]) return;
          arr[idx].lat = coords.lat; arr[idx].lng = coords.lng; arr[idx].locAccuracy = coords.accuracy || null;
          setStops(sc, arr);
          await set(dbRef(db, ROOT+'/'+id), sc);
          ok('GPS saved');
          await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
        }catch(e){ err('Save GPS failed: '+(e.message||e)); }
        finally{ loading(false); }
      };
    })(idx);
  }
}

/* ---------- Photo editor modal ---------- */
var pmCtx = { scenarioId:null, index:-1 };
function openPhotoEditor(scenarioId, index){
  pmCtx = { scenarioId:scenarioId, index:index };
  var s=null; for (var i=0;i<scenarios.length;i++){ if (scenarios[i].id===scenarioId){ s=scenarios[i]; break; } }
  if(!s) return;
  var st = (s._stops||[])[index]; if(!st) return;
  $('pmPreview').src = st.imageURL || st.thumbURL || dataURLFromStored(st.imageData) || '';
  $('pmTitle').value = st.title || '';
  $('pmCaption').value = st.caption || '';
  $('pmLat').value = (st.lat!=null ? String(st.lat) : '');
  $('pmLng').value = (st.lng!=null ? String(st.lng) : '');
  $('pmRadius').value = (st.radiusMeters!=null ? String(st.radiusMeters) : '50');
  $('pmGpsStatus').textContent = (st.lat!=null && st.lng!=null) ? 'GPS ‚úì' : 'GPS ‚Äî';
  $('photoModal').style.display = 'grid';
}
$('pmClose').onclick = function(){ $('photoModal').style.display='none'; };
$('pmUseMyLoc').onclick = async function(){
  $('pmGpsStatus').textContent = 'Getting GPS‚Ä¶';
  var coords = await softCoords(2000);
  if (!coords){ $('pmGpsStatus').textContent='GPS failed'; err('Could not get GPS.'); return; }
  $('pmLat').value = coords.lat; $('pmLng').value = coords.lng; $('pmGpsStatus').textContent = 'GPS ‚úì';
};
$('pmSave').onclick = async function(){
  var scenarioId = pmCtx.scenarioId, index = pmCtx.index; if (!scenarioId || index<0) return;
  try{
    loading(true);
    await ensureAuthed();
    var snap = await get(dbRef(db, ROOT+'/'+scenarioId));
    var sc = snap.val(); var arr = coerceStops(sc);
    var st = arr[index]; if (!st) throw new Error('Photo not found');
    st.title = ($('pmTitle').value||'').trim();
    st.caption = ($('pmCaption').value||'').trim();
    var lat = ($('pmLat').value||'').trim(); var lng = ($('pmLng').value||'').trim();
    st.lat = lat==='' ? null : Number(lat);
    st.lng = lng==='' ? null : Number(lng);
    var rad = parseInt(($('pmRadius').value||'50'),10); if (!(rad>0)) rad = 50; st.radiusMeters = rad;
    setStops(sc, arr);
    await set(dbRef(db, ROOT+'/'+scenarioId), sc);
    ok('Photo saved');
    $('photoModal').style.display='none';
    await safeLoadScenarios(); $('eSelect').value=scenarioId; renderScenario(scenarioId);
  }catch(e){
    var msg = e && (e.code||e.message) ? (e.code||e.message) : e;
    if (String(msg).indexOf('PERMISSION_DENIED')>=0) { err('Save photo failed: DB rules block writes to "/scenarios".'); }
    else { err('Save photo failed: '+msg); }
  }finally{ loading(false); }
};

/* ---------- Create / Edit wiring ---------- */
$('createBtn').onclick = async function(){
  try{
    await ensureAuthed();
    loading(true);
    var title = ($('cTitle').value||'').trim() || '(untitled)';
    var desc  = ($('cDesc').value||'').trim() || '';
    $('createBtn').disabled = true; $('createStatus').textContent='Creating‚Ä¶';
    var id = (push(dbRef(db, ROOT))).key;
    await set(dbRef(db, ROOT+'/'+id), { id:id, title:title, description:desc, createdAt:Date.now(), active:true, stops: [] });
    createdId = id;
    $('createStatus').textContent='Created ‚úì';
    ok('Scenario created');
    await safeLoadScenarios();
    $('showEdit').click();
    $('eSelect').value = id; $('eTitle').value = title; $('eDesc').value = desc;
    renderScenario(id);
  }catch(e){
    var msg = e && (e.code||e.message) ? (e.code||e.message) : e;
    if (String(msg).indexOf('PERMISSION_DENIED')>=0) err('Create failed: DB rules block writes to "/scenarios".');
    else err('Create failed: ' + msg);
  }finally{
    $('createBtn').disabled = false; loading(false);
  }
};

$('refreshBtn').onclick = async function(){ await ensureAuthed(); await safeLoadScenarios(); };
$('eSelect').onchange = function(){ var id=$('eSelect').value; if (id) renderScenario(id); };

$('saveMeta').onclick = async function(){
  try{
    await ensureAuthed();
    var id=$('eSelect').value; if(!id) return;
    loading(true);
    var snap = await get(dbRef(db, ROOT+'/'+id));
    var sc = snap.val()||{};
    sc.title = ($('eTitle').value||'').trim()||'(untitled)';
    sc.description = ($('eDesc').value||'').trim()||'';
    await set(dbRef(db, ROOT+'/'+id), sc);
    ok('Scenario saved');
    await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
  }catch(e){
    var msg = e && (e.code||e.message) ? (e.code||e.message) : e;
    if (String(msg).indexOf('PERMISSION_DENIED')>=0) err('Save failed: DB rules block writes to "/scenarios".');
    else err('Save failed: '+msg);
  }finally{ loading(false); }
};

/* Delete Scenario */
$('deleteScenario').onclick = async function(){
  try{
    var id=$('eSelect').value; if(!id){ err('Select a scenario first.'); return; }
    var s=null; for (var i=0;i<scenarios.length;i++){ if (scenarios[i].id===id){ s=scenarios[i]; break; } }
    var go = confirm('Delete scenario "'+((s && s.title)||id)+'" and its photos? This cannot be undone.');
    if (!go) return;
    loading(true);
    await ensureAuthed();

    var paths = [];
    var stops = s && s._stops ? s._stops : [];
    for (var j=0;j<stops.length;j++){
      var st = stops[j];
      if (st && st.storagePath) paths.push(st.storagePath);
      if (st && st.thumbPath)   paths.push(st.thumbPath);
      if (st && st.gsUri)       paths.push(st.gsUri);
    }
    for (var k=0;k<paths.length;k++){ try{ await deleteObject(stRef(storage, paths[k])); }catch(e){} }

    await remove(dbRef(db, ROOT+'/'+id));
    ok('Scenario deleted');

    await safeLoadScenarios();
    $('eSelect').value=''; $('stopsGrid').innerHTML=''; $('eTitle').value=''; $('eDesc').value=''; $('eStatus').textContent='‚Äî';
  }catch(e){
    err('Delete scenario failed: '+(e.message||e));
  }finally{
    loading(false);
  }
};

/* ---------- File input listeners ---------- */
function onFilesPicked(e, scope){
  var files = Array.from(e.target.files||[]);
  if (!files.length) return;
  addPending(files, scope);
  enablePendingButtons(scope);
  e.target.value='';
}
$('cFilesCam').addEventListener('change', function(e){ onFilesPicked(e,'c'); });
$('cFilesLib').addEventListener('change', function(e){ onFilesPicked(e,'c'); });
$('eFilesCam').addEventListener('change', function(e){ onFilesPicked(e,'e'); });
$('eFilesLib').addEventListener('change', function(e){ onFilesPicked(e,'e'); });

$('cSaveAll').onclick = function(){ saveAll('c'); };
$('eSaveAll').onclick = function(){ saveAll('e'); };
$('cClear').onclick = function(){
  for (var i=0;i<pendingCreate.length;i++){ try{ if(pendingCreate[i].url) URL.revokeObjectURL(pendingCreate[i].url);}catch(e){} }
  pendingCreate = []; renderPending('c'); enablePendingButtons('c');
};
$('eClear').onclick = function(){
  for (var i=0;i<pendingEdit.length;i++){ try{ if(pendingEdit[i].url) URL.revokeObjectURL(pendingEdit[i].url);}catch(e){} }
  pendingEdit = []; renderPending('e'); enablePendingButtons('e');
};

/* ---------- Init ---------- */
async function init(){
  try{
    loading(true);
    await ensureAuthed();
    onValue(dbRef(db, ROOT), function(snap){
      var obj=snap.val()||{};
      var arr=[]; var entries = Object.entries(obj);
      for (var i=0;i<entries.length;i++){
        var id = entries[i][0], s = entries[i][1];
        arr.push({ id:id, _raw:s, _stops:coerceStops(s), title:s && s.title, description:s && s.description, createdAt:s && s.createdAt, active:(s && (s.active!==false)) });
      }
      arr.sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); });
      scenarios = arr;
      populateEditList();
      var cur = $('eSelect').value; if (cur) renderScenario(cur);
    });
    await safeLoadScenarios();
  }catch(e){
    err('Startup failed: '+(e && e.message ? e.message : e));
  }finally{
    loading(false);
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
