<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geo-Photo Scenario Admin</title>
<style>
  :root{--bg:#0b1e27;--card:#102b36;--border:#1c3a47;--accent:#2aa3b5;--text:#ffffff}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  header{background:#0a6370;padding:14px 16px;border-radius:12px;margin:12px 0}
  h2{margin:0}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0}
  label{display:block;margin:.5rem 0 .25rem}
  input,textarea,select,button{width:100%;padding:.8rem;font-size:1rem;border-radius:10px;border:1px solid var(--border);background:#0f3542;color:#e7fbff}
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;gap:.75rem}
  .row2{grid-template-columns:1fr 1fr}
  .row3{grid-template-columns:1fr 1fr 1fr}
  .btn{background:var(--accent);color:#00151b;border:0;cursor:pointer}
  .btn-inline{width:auto}
  .hint{opacity:.85;font-size:.95rem}
  .small{opacity:.8;font-size:.9rem}
  img{max-width:100%;display:block;border-radius:12px;margin:.5rem 0}
  #error{white-space:pre-wrap;background:#2b1b1b;border:1px solid #4b2a2a;padding:.75rem;border-radius:.5rem;color:#ffd6d6;margin-top:.75rem;display:none}
  .stop{display:grid;grid-template-columns:92px 1fr auto;gap:10px;align-items:center;background:#0f3542;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px}
  .thumb{width:92px;height:92px;object-fit:cover;border-radius:8px;background:#0a2230}
  .btnbar{display:flex;gap:10px;flex-wrap:wrap}
</style>
<noscript><strong>This page requires JavaScript.</strong></noscript>
</head>
<body>
<div class="wrap">
  <header><h2>Create Scenario</h2></header>

  <!-- Scenario meta -->
  <div class="card">
    <label>Scenario Title</label>
    <input id="scTitle" placeholder="e.g., Station Tour A">
    <label>Scenario Notes (optional)</label>
    <textarea id="scNotes" placeholder="What this scenario is aboutâ€¦"></textarea>
    <label>Active?</label>
    <select id="scActive">
      <option value="true" selected>Yes</option>
      <option value="false">No</option>
    </select>
  </div>

  <!-- Stop form -->
  <div class="card">
    <h3 style="margin-top:0">Add Location & Photo</h3>

    <div class="row row2">
      <div>
        <label>Latitude</label>
        <input id="lat" readonly>
      </div>
      <div>
        <label>Longitude</label>
        <input id="lng" readonly>
      </div>
    </div>
    <button id="btnLoc" class="btn" style="margin-top:8px">Use my current location</button>
    <p class="small">Stand where this photo should appear, then tap the button above.</p>

    <div class="row row3">
      <div>
        <label>Radius (meters)</label>
        <input id="radius" type="number" value="50" min="5" step="5">
      </div>
      <div>
        <label>Stop Title (optional)</label>
        <input id="stopTitle" placeholder="Short label for this stop">
      </div>
      <div>
        <label>Photo file</label>
        <input id="file" type="file" accept="image/*" capture="environment">
      </div>
    </div>

    <img id="preview" style="display:none" alt="Preview"/>

    <label class="small">â€¦or paste a public image URL (optional)</label>
    <input id="imageUrl" placeholder="https://â€¦ (optional)">

    <label>Caption / Text shown with the photo (optional)</label>
    <textarea id="caption" placeholder="What should the user read at this stop?"></textarea>

    <p class="small" id="sizeInfo"></p>

    <!-- Flow buttons appear after the first photo/URL is present -->
    <div class="btnbar">
      <button id="btnAddAnother" class="btn btn-inline" style="display:none">Add another location</button>
      <button id="btnEndScenario" class="btn btn-inline" style="display:none">End scenario</button>
      <button id="btnQuickAdd" class="btn btn-inline">Add this location</button>
    </div>

    <p id="msgAdd" class="hint"></p>
  </div>

  <!-- Current stops list -->
  <div class="card">
    <h3 style="margin-top:0">Stops in this Scenario</h3>
    <div id="stopsList"></div>
    <p class="small" id="countNote">0 stops</p>
  </div>

  <div class="card">
    <div id="error"></div>
  </div>
</div>

<script type="module">
(async () => {
  const showErr = (e) => {
    const box = document.getElementById('error');
    box.style.display = 'block';
    box.textContent = String(e && e.stack ? e.stack : e);
    console.error(e);
  };

  try {
    // Firebase RTDB
    const [{ initializeApp }] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"),
    ]);
    const [{ getDatabase, ref, push, set }] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js"),
    ]);

    // Config (RTDB only)
    const firebaseConfig = {
      apiKey: "AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain: "dailyquiz-d5279.firebaseapp.com",
      databaseURL: "https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId: "dailyquiz-d5279",
      appId: "1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId: "G-19DVN7NNH7"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---- UI refs
    const el = id => document.getElementById(id);
    const scTitle = el('scTitle'), scNotes = el('scNotes'), scActive = el('scActive');
    const latEl = el('lat'), lngEl = el('lng'), radiusEl = el('radius'), stopTitle = el('stopTitle');
    const fileEl = el('file'), urlEl = el('imageUrl'), captionEl = el('caption');
    const preview = el('preview'), sizeInfo = el('sizeInfo');
    const stopsList = el('stopsList'), countNote = el('countNote');
    const msgAdd = el('msgAdd');
    const btnQuickAdd = el('btnQuickAdd');
    const btnAddAnother = el('btnAddAnother');
    const btnEndScenario = el('btnEndScenario');

    // ---- helpers
    function renderStops() {
      stopsList.innerHTML = "";
      stops.forEach((s, i) => {
        const row = document.createElement('div');
        row.className = 'stop';
        const img = document.createElement('img');
        img.className = 'thumb';
        img.src = s.imageData || s.imageURL || "";
        img.alt = 'thumb';
        const meta = document.createElement('div');
        meta.innerHTML = `<div><strong>${s.title || '(no title)'}</strong></div>
                          <div class="small">Lat ${s.lat}, Lng ${s.lng}, R ${s.radiusMeters}m</div>
                          <div class="small">${(s.caption||'').slice(0,120)}</div>`;
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.className = 'btn';
        del.style.width = '90px';
        del.onclick = () => { stops.splice(i,1); renderStops(); };
        row.appendChild(img); row.appendChild(meta); row.appendChild(del);
        stopsList.appendChild(row);
      });
      countNote.textContent = `${stops.length} stop(s)`;
    }

    async function fileToCompressedDataURL(file, maxDim = 1280, quality = 0.7) {
      const img = new Image();
      const reader = new FileReader();
      const data = await new Promise((res, rej) => { reader.onload = () => res(reader.result); reader.onerror = rej; reader.readAsDataURL(file); });
      await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = data; });
      const canvas = document.createElement('canvas');
      let { width, height } = img;
      if (width > height && width > maxDim) { height = Math.round(height * (maxDim/width)); width = maxDim; }
      else if (height > width && height > maxDim) { width = Math.round(width * (maxDim/height)); height = maxDim; }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,width,height);
      return canvas.toDataURL('image/jpeg', quality);
    }

    function showFlowButtonsIfReady() {
      const hasImage = !!dataURL || !!urlEl.value.trim();
      btnAddAnother.style.display = hasImage ? 'inline-block' : 'none';
      btnEndScenario.style.display = hasImage || stops.length ? 'inline-block' : 'none';
    }

    // ---- state
    let dataURL = null;
    let stops = [];

    // ---- events
    el('btnLoc').onclick = () => {
      navigator.geolocation.getCurrentPosition(
        p => { latEl.value = p.coords.latitude.toFixed(6); lngEl.value = p.coords.longitude.toFixed(6); },
        e => { msgAdd.textContent = "Location error: " + e.message; },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    };

    fileEl.onchange = async (e) => {
      try {
        const f = e.target.files?.[0];
        if (!f) return;
        msgAdd.textContent = "Compressing imageâ€¦";
        dataURL = await fileToCompressedDataURL(f, 1280, 0.7);
        preview.src = dataURL; preview.style.display = 'block';
        const bytes = Math.ceil((dataURL.length - 'data:image/jpeg;base64,'.length) * 3/4);
        sizeInfo.textContent = `Compressed image ~${Math.round(bytes/1024)} KB`;
        msgAdd.textContent = "";
        showFlowButtonsIfReady();
      } catch (err) { msgAdd.textContent = "Failed to process image."; }
    };

    urlEl.addEventListener('input', showFlowButtonsIfReady);

    function captureStopFromForm() {
      const lat = parseFloat(latEl.value), lng = parseFloat(lngEl.value);
      const radius = Math.max(5, parseInt(radiusEl.value || "50", 10));
      const sTitle = stopTitle.value.trim();
      const caption = captionEl.value.trim();
      const imageURL = urlEl.value.trim();
      if (Number.isNaN(lat) || Number.isNaN(lng)) throw new Error("Set a location first.");
      if (!dataURL && !imageURL) throw new Error("Choose a photo or paste an image URL.");
      return {
        title: sTitle, caption,
        lat, lng, radiusMeters: radius, active: true,
        createdAt: Date.now(),
        imageData: dataURL || null,
        imageURL: imageURL || null
      };
    }

    function clearStopForm() {
      stopTitle.value = ""; captionEl.value = ""; urlEl.value = "";
      fileEl.value = ""; dataURL = null; preview.style.display = 'none'; sizeInfo.textContent = "";
      msgAdd.textContent = "";
      showFlowButtonsIfReady();
    }

    // Quick add (adds to the list; you can keep adding)
    btnQuickAdd.onclick = () => {
      try {
        const stop = captureStopFromForm();
        stops.push(stop);
        renderStops();
        clearStopForm();
        // After first add, reveal the â€œAdd another / End scenarioâ€ flow
        btnAddAnother.style.display = 'inline-block';
        btnEndScenario.style.display = 'inline-block';
        msgAdd.textContent = "Location added.";
      } catch (e) { msgAdd.textContent = e.message; }
    };

    // After first photo, allow â€œAdd another locationâ€ (adds current stop then clears form)
    btnAddAnother.onclick = () => {
      try {
        const stop = captureStopFromForm();
        stops.push(stop);
        renderStops();
        clearStopForm();
        msgAdd.textContent = "Location added. You can add another.";
      } catch (e) { msgAdd.textContent = e.message; }
    };

    // End scenario â†’ save scenario with all collected stops
    btnEndScenario.onclick = async () => {
      try {
        if (!scTitle.value.trim()) throw new Error("Scenario title is required.");
        // If the stop form currently has data, capture it as the last stop
        if (dataURL || urlEl.value.trim()){
          const lastStop = captureStopFromForm();
          stops.push(lastStop);
        }
        if (!stops.length) throw new Error("Add at least one location.");
        msgAdd.textContent = "Saving scenarioâ€¦";

        const newRef = push(ref(db, "scenarios"));
        await set(newRef, {
          title: scTitle.value.trim(),
          notes: scNotes.value.trim(),
          active: (scActive.value === "true"),
          createdAt: Date.now(),
          stops
        });

        msgAdd.textContent = "Scenario saved! ðŸŽ‰";
        // reset everything
        scTitle.value = ""; scNotes.value = ""; scActive.value = "true";
        stops = []; renderStops(); clearStopForm();
        btnAddAnother.style.display = 'none'; btnEndScenario.style.display = 'none';
      } catch (e) { msgAdd.textContent = e.message; }
    };

    // initial
    renderStops(); showFlowButtonsIfReady();

  } catch (e) {
    showErr(e);
  }
})();
</script>
</body>
</html>
