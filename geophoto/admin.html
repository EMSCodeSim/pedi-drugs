<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Geo-Photo — Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />

<style>
  :root{
    /* MATCH HOME PAGE THEME — these are defaults; can be overridden by window.BRAND.colors */
    --bg:#0b0f14; --bg2:#101726;
    --card:#121823; --panel:#0f1624;
    --text:#eaf2ff; --muted:#8ea0b3;
    --border:rgba(255,255,255,.10);
    --blue:#0a84ff; --teal:#2dd4bf; --red:#ff3b30;
    --shadow:0 12px 34px rgba(0,0,0,.38);
    --radius:18px; --radiusSm:14px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f5fbff; --bg2:#ffffff;
      --card:#ffffff; --panel:#ffffff;
      --text:#0b1e27; --muted:#4f6b78;
      --border:#d6e9f1; --shadow:0 12px 34px rgba(0,0,0,.08);
      --blue:#0a5cff; --teal:#13bfa6; --red:#e53935;
    }
  }

  *{box-sizing:border-box}
  html,body{
    margin:0; padding:0; color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:
      radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.24), transparent 60%),
      radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.18), transparent 60%),
      linear-gradient(165deg, var(--bg2), var(--bg) 55%);
    -webkit-text-size-adjust:100%;
  }
  a{color:inherit; text-decoration:none}

  /* TOP BAR — same structure as index */
  .topbar{
    position:sticky; top:0; z-index:30;
    background:rgba(12,15,22,.75);
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid rgba(255,255,255,.07);
  }
  .topnav{
    max-width:1100px; margin:0 auto; padding:12px 16px;
    display:flex; align-items:center; gap:14px; flex-wrap:wrap;
  }
  .brandmini{display:flex; align-items:center; gap:12px}
  .logoWrap{
    width:40px; height:40px; border-radius:10px; overflow:hidden;
    display:grid; place-items:center; background:linear-gradient(145deg, var(--blue), #3da0ff);
    box-shadow:var(--shadow);
  }
  .logoWrap img{width:100%; height:100%; object-fit:cover; display:block}
  .logoFallback{color:#fff; font-weight:900; letter-spacing:.4px}
  .brandtext{line-height:1.1}
  .brandname{font-weight:900; font-size:15px}
  .brandtag{color:var(--muted); font-size:12px}

  /* WRAPPER / CARDS */
  main{max-width:1100px; margin:18px auto 84px; padding:0 16px}
  .card{
    border-radius:var(--radius); background:var(--card);
    border:1px solid var(--border); box-shadow:var(--shadow);
    padding:16px; margin:12px 0; overflow:hidden;
    transition:transform .15s ease, border-color .2s ease, box-shadow .2s ease;
  }
  .card:hover{ transform:translateY(-1px); border-color:rgba(10,132,255,.28); box-shadow:0 16px 40px rgba(0,0,0,.5) }

  .sectionTitle{font-weight:900; margin:6px 0 10px}
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border); color:var(--muted); background:rgba(255,255,255,.03)
  }
  .note{color:var(--muted); font-size:12px}
  .hr{height:1px; background:var(--border); margin:12px 0}

  /* FORMS (match index feel) */
  label{display:block; margin:10px 0 6px 2px; font-size:13px; color:var(--muted)}
  input, textarea, select, button{font-size:16px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; padding:12px; border-radius:12px; outline:none;
    background:var(--panel); color:var(--text); border:1px solid var(--border);
  }
  textarea{min-height:88px; resize:vertical}

  .btn{
    appearance:none; border:0; border-radius:12px; cursor:pointer; font-weight:800;
    padding:12px 14px; box-shadow:var(--shadow); width:auto;
  }
  .btn.primary{background:linear-gradient(180deg,#54a6ff,var(--blue)); color:#03131b}
  .btn.teal{background:linear-gradient(180deg,#3ce5d3,var(--teal)); color:#052522}
  .btn.ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14)}
  .btn.danger{background:var(--red); color:#fff}
  .btn:active{transform:translateY(1px)}

  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(280px,1fr))}
  .hidden{display:none}

  /* STICKY BAR in Create panel (same vibe as index hero glass) */
  .stickyBar{
    position:sticky; top:64px; z-index:5;
    background:rgba(12,15,22,.75);
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid rgba(255,255,255,.07);
    margin:-16px -16px 10px; padding:8px 12px;
  }

  /* Thumbnails */
  .thumbs{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  .thumb{width:88px; height:88px; object-fit:cover; border-radius:12px; border:1px solid var(--border); background:#0a2230}

  /* Scenario list (edit) */
  .listItem{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel)
  }
</style>
</head>
<body>

<!-- TOP BAR (mirrors index header) -->
<div class="topbar">
  <div class="topnav">
    <div class="brandmini">
      <div class="logoWrap" aria-label="Logo">
        <!-- If BRAND.logo is set, we'll inject an <img>. Otherwise show initials. -->
        <span id="logoFallback" class="logoFallback">FS</span>
      </div>
      <div class="brandtext">
        <div id="brandName" class="brandname">FireOps SIM</div>
        <div id="brandTag" class="brandtag">Geo-Photo Training Scenarios</div>
      </div>
    </div>
  </div>
</div>

<main>
  <!-- Landing -->
  <section class="card" id="landing">
    <div class="sectionTitle">Choose an action</div>
    <div class="row" style="margin-top:8px">
      <button id="goCreate" class="btn primary">Create Scenario</button>
      <button id="goEdit" class="btn ghost">Edit Scenario</button>
    </div>
    <div class="pill" id="status">Ready</div>
  </section>

  <!-- Create Scenario -->
  <section class="card hidden" id="createPanel">
    <div class="stickyBar">
      <div class="row" style="justify-content:space-between">
        <div class="pill" id="createStatus">New scenario</div>
        <button id="finalizeScenario" class="btn teal">Save Scenario</button>
      </div>
    </div>

    <!-- Meta (collapses after first photo save) -->
    <div id="scenarioMeta">
      <label>Scenario Name</label>
      <input id="scenarioName" type="text" placeholder="e.g., House Fire on Main St">

      <label>Dispatch Information</label>
      <textarea id="dispatchInfo" placeholder="Example: Engine 1, Engine 2, Medic 1 respond to ..."></textarea>
    </div>

    <div class="hr"></div>

    <!-- Photo entry -->
    <div>
      <div class="sectionTitle">Add Photo</div>

      <label>Photo (camera or library)</label>
      <input id="photoInput" type="file" accept="image/*" capture="environment">

      <div class="row">
        <div style="flex:1">
          <label>Radius (meters)</label>
          <input id="radius" type="number" inputmode="numeric" min="5" max="1000" value="50">
        </div>
        <!-- Short Label intentionally removed -->
      </div>

      <label>Caption / Notes (read by TTS)</label>
      <textarea id="caption" placeholder="What should crews observe or do here?"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="savePhoto" class="btn primary">Save Photo</button>
        <div class="note">GPS is captured automatically on save.</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="sectionTitle">Photos in this scenario</div>
    <div id="thumbs" class="thumbs"></div>
  </section>

  <!-- Edit Scenario -->
  <section class="card hidden" id="editPanel">
    <div class="sectionTitle">Edit Existing Scenario</div>
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="editStatus">Loading…</div>
      <button id="backFromEdit" class="btn ghost">Back</button>
    </div>
    <div id="scenarioList"></div>
  </section>
</main>

<!-- Firebase + Logic (unchanged functionality) -->
<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, push, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
    authDomain:"dailyquiz-d5279.firebaseapp.com",
    databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
    projectId:"dailyquiz-d5279",
    appId:"1:94577748034:web:c032d3a1d72db1313de5db",
    measurementId:"G-19DVN7NNH7"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // === Branding sync with index ===
  const DEFAULT_BRAND = {
    name: 'FireOps SIM',
    tag: 'Geo-Photo Training Scenarios',
    initials: 'FS',
    logo: null, // e.g. '/assets/logo/fireopssim-logo.svg' — if set, image will be shown
    colors: null // { bg, bg2, card, panel, text, muted, border, blue, teal, red }
  };
  const BRAND = Object.assign({}, DEFAULT_BRAND, (window.BRAND || {}));

  // Apply brand text
  document.getElementById('brandName').textContent = BRAND.name || DEFAULT_BRAND.name;
  document.getElementById('brandTag').textContent  = BRAND.tag  || DEFAULT_BRAND.tag;

  // Apply logo image if provided (matches index behavior)
  (function applyLogo(){
    const wrap = document.querySelector('.logoWrap');
    const fallback = document.getElementById('logoFallback');
    if (BRAND.logo) {
      const img = new Image();
      img.alt = BRAND.name || 'Logo';
      img.onload = ()=>{ wrap.innerHTML=''; wrap.appendChild(img); };
      img.onerror = ()=>{ fallback.textContent = (BRAND.initials||DEFAULT_BRAND.initials); };
      img.src = BRAND.logo;
    } else {
      fallback.textContent = BRAND.initials || DEFAULT_BRAND.initials;
    }
  })();

  // Apply color overrides if index sets BRAND.colors
  if (BRAND.colors && typeof BRAND.colors === 'object') {
    const m = new Map(Object.entries(BRAND.colors));
    m.forEach((v,k)=>{ if (v) document.documentElement.style.setProperty(`--${k}`, v); });
  }

  // === DOM refs
  const landing = document.getElementById('landing');
  const goCreate = document.getElementById('goCreate');
  const goEdit = document.getElementById('goEdit');
  const statusPill = document.getElementById('status');

  const createPanel = document.getElementById('createPanel');
  const createStatus = document.getElementById('createStatus');
  const finalizeScenario = document.getElementById('finalizeScenario');

  const scenarioMeta = document.getElementById('scenarioMeta');
  const scenarioName = document.getElementById('scenarioName');
  const dispatchInfo = document.getElementById('dispatchInfo');

  const photoInput = document.getElementById('photoInput');
  const radius = document.getElementById('radius');
  const caption = document.getElementById('caption');
  const savePhoto = document.getElementById('savePhoto');
  const thumbs = document.getElementById('thumbs');

  const editPanel = document.getElementById('editPanel');
  const editStatus = document.getElementById('editStatus');
  const scenarioList = document.getElementById('scenarioList');
  const backFromEdit = document.getElementById('backFromEdit');

  // === State
  let currentScenarioId = null;
  let localStops = [];

  // === Helpers (unchanged)
  const uiShow = el => el.classList.remove('hidden');
  const uiHide = el => el.classList.add('hidden');
  const toast = (el, msg) => el.textContent = msg;

  function readFileAsDataURL(file){
    return new Promise((res, rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej;
      r.readAsDataURL(file);
    });
  }
  function getGPS(){
    return new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        err => reject(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }
  function renderThumbs(){
    thumbs.innerHTML='';
    localStops.forEach((s,i)=>{
      const img=document.createElement('img');
      img.className='thumb';
      img.title=s.title || `Stop ${i+1}`;
      img.src=s.imageData || s.imageURL || '';
      img.onerror = ()=>{ img.style.opacity=.7; img.title='Image failed to load'; };
      thumbs.appendChild(img);
    });
  }

  // === Navigation
  goCreate.onclick = ()=>{
    uiHide(landing); uiShow(createPanel);
    createStatus.textContent='New scenario';
    currentScenarioId=null; localStops=[];
    scenarioName.value=''; dispatchInfo.value='';
    photoInput.value=''; radius.value=50; caption.value='';
    uiShow(scenarioMeta); // visible until first photo saved
  };
  goEdit.onclick = ()=>{ uiHide(landing); uiShow(editPanel); loadForEdit(); };
  backFromEdit.onclick = ()=>{
    uiHide(editPanel); uiShow(landing);
    scenarioList.innerHTML=''; editStatus.textContent='Ready';
  };

  // === Create flow (unchanged logic; no short label)
  savePhoto.onclick = async ()=>{
    try{
      const file = photoInput.files?.[0];
      if(!file){ alert('Please choose a photo first.'); return; }

      // Make scenario shell on first save
      if(!currentScenarioId){
        const name=(scenarioName.value||'').trim();
        if(!name){ alert('Please enter a Scenario Name.'); return; }
        const dispatch=(dispatchInfo.value||'').trim();
        const newRef = push(ref(db,'scenarios'));
        currentScenarioId=newRef.key;
        await set(newRef,{
          id:currentScenarioId,
          title:name,
          dispatch:dispatch,
          createdAt:Date.now(),
          active:true,
          stops:[]
        });
        uiHide(scenarioMeta); // collapse after first save
      }

      const dataURL = await readFileAsDataURL(file);
      const gps = await getGPS();
      const r = Math.max(5, Math.min(1000, Math.round(parseInt(radius.value||'50',10))));
      const stop = {
        title: '',                 // short label removed
        caption: (caption.value||'').trim(),
        lat: gps.lat, lng: gps.lng,
        radiusMeters: r,
        imageData: dataURL
      };

      localStops.push(stop);
      await set(ref(db,'scenarios/'+currentScenarioId+'/stops'), localStops);

      // reset photo fields
      photoInput.value=''; caption.value=''; radius.value=50;
      renderThumbs();
      toast(createStatus, `Saved photo #${localStops.length}.`);
    }catch(e){
      alert('Save failed: ' + (e?.message||e));
    }
  };

  // === Save Scenario (unchanged)
  finalizeScenario.onclick = async ()=>{
    try{
      if(!currentScenarioId){
        const name=(scenarioName.value||'').trim();
        if(!name){ alert('Enter Scenario Name, then Save a Photo or press Save Scenario again to create empty.'); return; }
        const dispatch=(dispatchInfo.value||'').trim();
        const newRef=push(ref(db,'scenarios'));
        currentScenarioId=newRef.key;
        await set(newRef,{
          id:currentScenarioId,
          title:name, dispatch:dispatch,
          createdAt:Date.now(), active:true, stops:[]
        });
        uiHide(scenarioMeta);
      }
      toast(createStatus,'Scenario saved.');
      // reset for new create
      currentScenarioId=null; localStops=[];
      renderThumbs();
      scenarioName.value=''; dispatchInfo.value='';
      photoInput.value=''; caption.value=''; radius.value=50;
      uiShow(scenarioMeta);
    }catch(e){
      alert('Save Scenario failed: ' + (e?.message||e));
    }
  };

  // === Edit view (unchanged)
  async function loadForEdit(){
    try{
      editStatus.textContent='Loading scenarios…';
      const snap=await get(ref(db,'scenarios'));
      if(!snap.exists()){ editStatus.textContent='No scenarios found.'; scenarioList.innerHTML=''; return; }
      const obj=snap.val()||{};
      const arr=Object.entries(obj).map(([id,s])=>({id,...s}))
        .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      editStatus.textContent=`${arr.length} scenario(s)`;
      scenarioList.innerHTML='';

      arr.forEach(sc=>{
        const row=document.createElement('div');
        row.className='listItem';
        const left=document.createElement('div');
        left.innerHTML = `<div style="font-weight:800">${sc.title||'(untitled)'}</div>
                          <div class="note">Stops: ${Array.isArray(sc.stops)? sc.stops.length : 0} • ${new Date(sc.createdAt||Date.now()).toLocaleString()}</div>`;
        const right=document.createElement('div');
        const openBtn=document.createElement('button');
        openBtn.className='btn primary'; openBtn.textContent='Open in Creator';
        openBtn.onclick=()=>{
          // load into creator for additional photos
          document.getElementById('landing').classList.add('hidden');
          document.getElementById('editPanel').classList.add('hidden');
          document.getElementById('createPanel').classList.remove('hidden');
          currentScenarioId=sc.id;
          localStops=Array.isArray(sc.stops)? sc.stops : [];
          renderThumbs();
          uiHide(scenarioMeta); // editing existing keeps meta hidden
          toast(createStatus, `Editing: ${sc.title||'(untitled)'}`);
        };
        const toggleBtn=document.createElement('button');
        toggleBtn.className='btn ghost'; toggleBtn.style.marginLeft='8px';
        toggleBtn.textContent=sc.active ? 'Deactivate' : 'Activate';
        toggleBtn.onclick=()=>update(ref(db,'scenarios/'+sc.id), { active: !sc.active });
        const delBtn=document.createElement('button');
        delBtn.className='btn danger'; delBtn.style.marginLeft='8px';
        delBtn.textContent='Delete';
        delBtn.onclick=async()=>{
          if(confirm('Delete this scenario? This cannot be undone.')){
            await set(ref(db,'scenarios/'+sc.id), null);
            row.remove();
          }
        };
        right.appendChild(openBtn); right.appendChild(toggleBtn); right.appendChild(delBtn);
        row.appendChild(left); row.appendChild(right);
        scenarioList.appendChild(row);
      });
    }catch(e){
      editStatus.textContent='Error: '+(e?.message||e);
    }
  }
</script>
</body>
</html>
