<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geo-Photo Admin</title>
<style>
  :root{--bg:#0b1e27;--card:#102b36;--border:#1c3a47;--accent:#2aa3b5;--text:#ffffff}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  header{background:#0a6370;padding:14px 16px;border-radius:12px;margin:12px 0}
  h2{margin:0}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0}
  label{display:block;margin:.5rem 0 .25rem}
  input,button{width:100%;padding:.8rem;font-size:1rem;border-radius:10px;border:1px solid var(--border);background:#0f3542;color:#e7fbff}
  input[readonly]{opacity:.8}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
  .btn{background:var(--accent);color:#00151b;border:0}
  .hint{opacity:.85;font-size:.95rem}
  img{max-width:100%;display:block;border-radius:12px;margin:.5rem 0}
  #error{white-space:pre-wrap;background:#2b1b1b;border:1px solid #4b2a2a;padding:.75rem;border-radius:.5rem;color:#ffd6d6;margin-top:.75rem;display:none}
</style>
<noscript><strong>This page requires JavaScript.</strong></noscript>
</head>
<body>
<div class="wrap">
  <header><h2>Geo-Photo Admin</h2></header>

  <div class="card">
    <div class="row">
      <div>
        <label>Title</label>
        <input id="title" placeholder="Short label">
      </div>
      <div>
        <label>Radius (meters)</label>
        <input id="radius" type="number" value="40" min="5" step="5">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Latitude</label>
        <input id="lat" readonly>
      </div>
      <div>
        <label>Longitude</label>
        <input id="lng" readonly>
      </div>
    </div>

    <button id="btnLoc" class="btn">Use my current location</button>
    <p class="hint">Stand at the spot where the photo should appear, then tap the button above.</p>

    <label>Photo</label>
    <input id="file" type="file" accept="image/*" capture="environment">
    <img id="preview" style="display:none" alt="Preview"/>

    <button id="btnSave" class="btn">Save Spot</button>
    <p id="msg" class="hint"></p>
    <div id="error"></div>
  </div>
</div>

<script type="module">
(async () => {
  const showErr = (e) => {
    const box = document.getElementById('error');
    box.style.display = 'block';
    box.textContent = String(e && e.stack ? e.stack : e);
    console.error(e);
  };

  try {
    // Firebase imports
    const [{ initializeApp }] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"),
    ]);
    const [
      { getFirestore, collection, addDoc, serverTimestamp },
      { getStorage, ref: sRef, uploadBytes, getDownloadURL },
    ] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"),
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js"),
    ]);

    // Your Firebase config (fixed storageBucket)
    const firebaseConfig = {
      apiKey: "AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain: "dailyquiz-d5279.firebaseapp.com",
      databaseURL: "https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId: "dailyquiz-d5279",
      storageBucket: "dailyquiz-d5279.appspot.com",
      messagingSenderId: "94577748034",
      appId: "1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId: "G-19DVN7NNH7"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI
    const el = id => document.getElementById(id);
    const title = el('title'), radius = el('radius'), lat = el('lat'), lng = el('lng');
    const file = el('file'), preview = el('preview'), msg = el('msg');

    el('btnLoc').onclick = () => {
      try {
        navigator.geolocation.getCurrentPosition(
          p => { lat.value = p.coords.latitude.toFixed(6); lng.value = p.coords.longitude.toFixed(6); },
          e => { msg.textContent = "Location error: " + e.message; },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      } catch (e) { showErr(e); }
    };

    file.onchange = e => {
      try {
        const f = e.target.files?.[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = () => { preview.src = r.result; preview.style.display = 'block'; };
        r.readAsDataURL(f);
      } catch (e) { showErr(e); }
    };

    el('btnSave').onclick = async () => {
      try {
        msg.textContent = "Uploading...";
        const f = file.files?.[0];
        if (!f) throw new Error("Choose a photo");
        if (!lat.value || !lng.value) throw new Error("Set a location");

        // Upload image
        const path = `photos/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
        const imgRef = sRef(storage, path);
        await uploadBytes(imgRef, f);
        const url = await getDownloadURL(imgRef);

        // Save spot
        await addDoc(collection(db, "spots"), {
          title: title.value || "Untitled",
          lat: parseFloat(lat.value),
          lng: parseFloat(lng.value),
          radiusMeters: Math.max(5, parseInt(radius.value || "25", 10)),
          imageURL: url,
          active: true,
          createdAt: Date.now(),
          createdAtSrv: serverTimestamp()
        });

        msg.textContent = "Saved! ðŸŽ‰";
        file.value = ""; preview.style.display = "none"; title.value = "";
      } catch (e) { msg.textContent = "Error saving."; showErr(e); }
    };
  } catch (e) {
    showErr(e);
  }
})();
</script>
</body>
</html>
