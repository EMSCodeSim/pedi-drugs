<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Create Scenario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --bg2:#0e1421; --card:#0f1624; --edge:rgba(255,255,255,.12);
      --text:#eaf2ff; --muted:#9fb2d6; --a1:#54a6ff; --a2:#0a84ff; --ok:#16a34a; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;color:var(--text);
      background:radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.24), transparent 60%),
                 radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.15), transparent 60%),
                 linear-gradient(165deg,var(--bg2),var(--bg) 55%);
      overflow-x:hidden;}
    .topbar{position:sticky;top:0;z-index:40;background:rgba(12,15,22,.78);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08)}
    .topnav{max-width:1000px;margin:0 auto;padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:900}
    .spacer{flex:1;min-width:0}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,#15233a,#0f1930);
      color:#fff;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent}
    .btn.ok{background:linear-gradient(180deg,#20c46b,#0fa36b);border-color:#178b56}
    .pill{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.16);border-radius:999px;color:var(--muted);
      overflow-wrap:anywhere;white-space:normal}
    main{max-width:1000px;margin:16px auto 40px;padding:0 12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px}
    label{display:block;margin:10px 0 6px 2px;font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff;
      font-size:16px}
    textarea{min-height:90px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0}
    .hint{font-size:12px;color:var(--muted);overflow-wrap:anywhere}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .thumb{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#0a1727}
    .thumb.na{display:grid;place-items:center;font-size:12px;color:#9fb2d6}
    .section{padding:10px;border:1px dashed rgba(255,255,255,.14);border-radius:12px;background:rgba(255,255,255,.02)}
    .hidden{display:none !important}
    #snack{position:fixed;left:12px;bottom:12px;z-index:99;display:none;padding:10px 12px;border-radius:12px;border:1px solid #2c7a4b;background:#0f2a19;color:#d8ffe2}
    #errbar{position:fixed;left:12px;bottom:60px;z-index:99;display:none;padding:10px 12px;border-radius:12px;border:1px solid #7a2b2b;background:#2b0d0d;color:#ffd7d7}
    #loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,12,20,.55);backdrop-filter:blur(2px);z-index:98}
    .spinner{width:44px;height:44px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:840px){ main{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
    a[aria-disabled="true"]{pointer-events:none;opacity:.5}
    .bar{height:10px;border-radius:8px;background:#0d1727;border:1px solid rgba(255,255,255,.14);overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#2484ff,#63dbff)}
  </style>
</head>
<body>
  <div id="loader"><div class="spinner"></div></div>
  <div id="errbar"></div>
  <div id="snack"></div>

  <div class="topbar">
    <div class="topnav">
      <div class="brand">FireOps SIM — Create Scenario</div>
      <div class="spacer"></div>
      <a class="btn" href="./advanced-editor.html">Open Advanced Editor</a>
    </div>
  </div>

  <main>
    <section class="card">
      <h3 style="margin:0 0 8px">New Scenario</h3>

      <!-- Step 1 -->
      <div class="section" id="step1">
        <b>Step 1 — Name & Dispatch</b>
        <label>Scenario Name <span class="hint">(required)</span></label>
        <input id="sTitle" placeholder="e.g., MVC — Ridgeview & Co Rd 25" autocomplete="off" />
        <label>Dispatch (optional)</label>
        <textarea id="sDispatch" placeholder="Engine 181, respond to MVC with injuries, 2 vehicles, fuel leak, WB lane blocked."></textarea>
        <div class="row" style="margin-top:8px">
          <button id="createBtn" class="btn">Create</button>
          <span id="step1Status" class="pill">idle</span>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="section hidden" id="step2" style="margin-top:12px">
        <b>Step 2 — Add a Photo</b>
        <div class="hint" style="margin:4px 0 10px">Take a picture, choose from library, or upload a file.</div>
        <div class="grid">
          <button id="btnCamera" class="btn">Take Photo</button>
          <button id="btnLibrary" class="btn">Choose from Library</button>
          <button id="btnUpload" class="btn">Upload File</button>
        </div>
        <input id="inCamera"  class="hidden" type="file" accept="image/*" capture="environment">
        <input id="inLibrary" class="hidden" type="file" accept="image/*">
        <input id="inUpload"  class="hidden" type="file" accept="image/*">

        <div id="previewWrap" class="row hidden" style="margin-top:10px;align-items:flex-start">
          <img id="thumb" class="thumb" alt="">
          <div style="min-width:200px;max-width:100%">
            <div class="row" style="gap:6px">
              <label for="sizePreset" class="hint">Save size</label>
              <select id="sizePreset" style="width:auto">
                <option value="800">Small (800px)</option>
                <option value="1280" selected>Auto (1280px)</option>
                <option value="1600">Large (1600px)</option>
                <option value="1920">XL (1920px)</option>
              </select>
              <span class="hint">JPEG • quality 0.75</span>
            </div>
            <div id="imgInfo" class="hint" style="margin-top:4px">Image: —</div>
            <hr style="border:none;height:1px;background:rgba(255,255,255,.08);margin:10px 0">
            <div id="locChoice" class="hidden">
              <div class="hint" style="margin-bottom:6px">Set location for this stop:</div>
              <div class="row">
                <button id="btnUseGPS" class="btn">Use my current location</button>
                <button id="btnManualLoc" class="btn ghost">Enter manually</button>
              </div>
            </div>
            <div id="locGPS" class="hidden" style="margin-top:8px">
              <div id="gpsLine" class="hint">GPS: waiting…</div>
              <div class="row" style="margin-top:6px">
                <button id="btnRefreshGPS" class="btn">Refresh</button>
                <button id="btnClearGPS" class="btn ghost">Clear</button>
              </div>
            </div>
            <div id="locManual" class="hidden" style="margin-top:8px">
              <label>Latitude</label><input id="latIn" inputmode="decimal" placeholder="e.g., 38.987654" autocomplete="off">
              <label>Longitude</label><input id="lngIn" inputmode="decimal" placeholder="-104.876543" autocomplete="off">
              <label>Accuracy (m) <span class="hint">(optional)</span></label><input id="accIn" inputmode="numeric" placeholder="e.g., 12" autocomplete="off">
              <div class="row" style="margin-top:6px">
                <button id="btnSaveManual" class="btn ok">Save Location</button>
                <button id="btnManualBack" class="btn ghost">Back</button>
              </div>
            </div>

            <!-- Progress UI -->
            <div id="progWrap" class="hidden" style="margin-top:10px">
              <div class="row" style="justify-content:space-between">
                <div class="hint">Upload progress (full)</div>
                <div id="progPctFull" class="hint">0%</div>
              </div>
              <div class="bar"><span id="progBarFull"></span></div>
              <div class="row" style="justify-content:space-between;margin-top:6px">
                <div class="hint">Upload progress (thumb)</div>
                <div id="progPctThumb" class="hint">0%</div>
              </div>
              <div class="bar"><span id="progBarThumb"></span></div>
            </div>

            <!-- Self-test -->
            <div class="row" style="margin-top:12px">
              <button id="btnSelfTest" class="btn ghost">Self-Test Upload</button>
              <span id="selfTestOut" class="hint"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="section hidden" id="step3" style="margin-top:12px">
        <b>Step 3 — Upload & Save</b>
        <div class="hint" style="margin:4px 0 10px">We’ll upload the photo (full + thumbnail) and write the stop to the database.</div>
        <div class="row">
          <button id="saveBtn" class="btn" disabled>Save to Cloud</button>
          <a id="openEditor" class="btn ghost" href="./advanced-editor.html" aria-disabled="true">Open in Advanced Editor</a>
          <span id="saveStatus" class="pill">idle</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">Tips</h3>
      <ul style="margin:8px 0 0 14px; padding:0 0 0 4px; line-height:1.5">
        <li>Default save size is <b>1280px</b> max edge (good for phones & projectors).</li>
        <li>If you see <code>storage/unauthorized</code> / <code>permission-denied</code>, fix Storage rules or enable App Check here.</li>
        <li>HEIC: if the browser can’t decode, we’ll upload the original (no compression possible client-side).</li>
      </ul>
      <hr style="border:none;height:1px;background:rgba(255,255,255,.08);margin:12px 0">
      <div id="debug" class="hint"></div>
    </section>
  </main>

  <script type="module">
    // ---------- helpers ----------
    const $ = (id)=>document.getElementById(id);
    const show = (el, on)=> (typeof el==='string' ? $(el) : el).classList.toggle('hidden', !on);
    const snack = (m)=>{ const b=$('snack'); b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 2400); };
    const errBar= (m)=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 7000); };
    const setKV = (id, t)=> $(id).textContent = t;

    // ---------- Firebase ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    // If App Check is enforced for Storage/DB, UNCOMMENT next lines and add your site key:
    // import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref as dbRef, get, push, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const app = initializeApp(firebaseConfig);
    // self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; // dev only
    // initializeAppCheck(app, { provider: new ReCaptchaV3Provider('YOUR_RECAPTCHA_V3_SITE_KEY'), isTokenAutoRefreshEnabled: true });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    async function ensureAuthed(){
      if (auth.currentUser) return auth.currentUser;
      await signInAnonymously(auth);
      return await new Promise((resolve,reject)=>{
        const unsub = onAuthStateChanged(auth, (u)=>{ if (u){ unsub(); resolve(u);} }, reject);
      });
    }

    // ---------- image pipeline ----------
    const QUALITY = 0.75; // slightly smaller by default
    function getMaxEdge(){ return parseInt(($('sizePreset').value||'1280'),10) || 1280; }

    async function fileToBitmap(file){
      try{
        if ('createImageBitmap' in window){
          return await createImageBitmap(file, { imageOrientation:'from-image' });
        }
      }catch{}
      const url = URL.createObjectURL(file);
      try{
        const img = new Image(); img.decoding='async'; img.src=url; await img.decode();
        img.width = img.naturalWidth; img.height = img.naturalHeight;
        return img;
      } finally { URL.revokeObjectURL(url); }
    }
    const scale = (w,h,max)=>{ const s=Math.min(1,max/Math.max(w,h)); return {w:Math.round(w*s),h:Math.round(h*s)}; };
    async function toBlob(bmp,maxEdge,quality=QUALITY,type='image/jpeg'){
      const w0=bmp.width||bmp.naturalWidth, h0=bmp.height||bmp.naturalHeight;
      const {w,h}=scale(w0,h0,maxEdge);
      const c=('OffscreenCanvas' in window) ? new OffscreenCanvas(w,h) : Object.assign(document.createElement('canvas'),{width:w,height:h});
      if(!('width' in c)){ c.width=w; c.height=h; }
      const g=c.getContext('2d'); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';
      g.drawImage(bmp,0,0,w,h);
      const blob = await (c.convertToBlob ? c.convertToBlob({type,quality}) : new Promise((res,rej)=>c.toBlob(b=>b?res(b):rej(new Error('toBlob failed')),type,quality)));
      return {blob,width:w,height:h};
    }

    // ---------- state ----------
    let createdId=null, createdTitle='', createdDispatch='';
    let pendingFile=null, pendingMeta=null;
    let pendingGeo=null;

    function gateSteps(){
      const step2 = !!createdId;
      const hasPhoto = !!pendingFile;
      show('step2', step2);
      show('previewWrap', hasPhoto);
      show('locChoice', hasPhoto);
      show('step3', !!createdId);
      $('saveBtn').disabled = !(createdId && pendingFile);
      $('openEditor').setAttribute('aria-disabled', createdId ? 'false':'true');
    }

    // ---------- Step 1 ----------
    $('createBtn').onclick = async ()=>{
      try{
        await ensureAuthed();
        const title = $('sTitle').value.trim();
        const dispatch = $('sDispatch').value.trim();
        if (!title){ errBar('Please enter a scenario name.'); return; }

        $('createBtn').disabled = true;
        $('step1Status').textContent = 'creating…';

        const id = (push(dbRef(db, 'scenarios'))).key;
        const base = { id, title, description: dispatch || '', dispatch: dispatch || '', createdAt: Date.now(), active: true, stops: [] };

        const multi = {};
        multi[`scenarios/${id}`] = base;
        multi[`geophoto/scenarios/${id}`] = base;
        await update(dbRef(db), multi);

        createdId=id; createdTitle=title; createdDispatch=dispatch;
        $('step1Status').textContent = 'created ✓';
        snack('Scenario created — add a photo');
      }catch(e){
        const msg = e?.code || e?.message || String(e);
        errBar(/permission|denied/i.test(msg)
          ? 'DB rules are blocking creates. Allow admin writes to "/scenarios/**" & "/geophoto/scenarios/**".'
          : 'Create failed: ' + msg);
      }finally{
        $('createBtn').disabled = false;
        gateSteps();
      }
    };

    // ---------- Step 2: choose/take/upload ----------
    const openInput = (id)=> $(id).click();
    $('btnCamera').onclick = ()=> openInput('inCamera');
    $('btnLibrary').onclick= ()=> openInput('inLibrary');
    $('btnUpload').onclick = ()=> openInput('inUpload');

    async function onFilePicked(file){
      if (!file){ return; }
      if (!createdId){ errBar('Create the scenario first.'); return; }

      let bmp=null, previewOK=true;
      try{ bmp = await fileToBitmap(file); }catch{ previewOK=false; }

      pendingFile = file;
      if (previewOK){
        const obj = URL.createObjectURL(file);
        $('thumb').classList.remove('na'); $('thumb').src = obj;
        setTimeout(()=>URL.revokeObjectURL(obj), 60000);
        const w=bmp.width||bmp.naturalWidth, h=bmp.height||bmp.naturalHeight;
        setKV('imgInfo', `Original: ${w}×${h} • ${(file.size/1024/1024).toFixed(2)} MB • ${file.type||'image'}`);
      }else{
        $('thumb').classList.add('na'); $('thumb').removeAttribute('src'); $('thumb').textContent='Preview not available';
        setKV('imgInfo', `File: ${(file.size/1024/1024).toFixed(2)} MB • ${file.type||'file'} — preview not available; will upload original`);
      }

      pendingGeo = null; setKV('gpsLine', 'GPS: waiting…');
      show('previewWrap', true); show('locChoice', true); show('locGPS', false); show('locManual', false);
      gateSteps();
    }

    $('inCamera').addEventListener('change', (e)=> onFilePicked(e.target.files?.[0]));
    $('inLibrary').addEventListener('change', (e)=> onFilePicked(e.target.files?.[0]));
    $('inUpload').addEventListener('change', (e)=> onFilePicked(e.target.files?.[0]));

    // GPS / manual location
    $('btnUseGPS').onclick = ()=>{ show('locManual', false); show('locGPS', true); getGPSFix(true); };
    $('btnManualLoc').onclick = ()=>{ show('locGPS', false); show('locManual', true); };
    $('btnManualBack').onclick = ()=>{ show('locManual', false); show('locChoice', true); };
    $('btnSaveManual').onclick = ()=>{
      const lat = parseFloat(($('latIn').value||'').trim());
      const lng = parseFloat(($('lngIn').value||'').trim());
      const acc = parseInt(($('accIn').value||'').trim(),10);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)){ errBar('Enter valid latitude & longitude.'); return; }
      pendingGeo = { lat, lng, accuracy: Number.isFinite(acc)?acc:null, at: Date.now() };
      snack('Manual location saved.');
      show('locManual', false); show('locChoice', true);
      setKV('gpsLine', `GPS (manual): ${lat.toFixed(6)}, ${lng.toFixed(6)}${Number.isFinite(acc)?' ±'+acc+'m':''}`);
    };

    function getGPSFix(force=false){
      if (!navigator.geolocation){ setKV('gpsLine','GPS not available on this device/browser.'); return; }
      setKV('gpsLine','Getting GPS fix…');
      const opts={enableHighAccuracy:true,timeout:10000,maximumAge:force?0:60000};
      navigator.geolocation.getCurrentPosition(
        (p)=>{
          const {latitude,longitude,accuracy}=p.coords||{};
          pendingGeo={lat:latitude,lng:longitude,accuracy:Math.round(accuracy||0),at:Date.now()};
          setKV('gpsLine',`GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} ±${Math.round(accuracy||0)} m`);
        },
        (e)=>{ setKV('gpsLine',`GPS failed (${e.code||''}) — you can enter manually`); },
        opts
      );
    }
    $('btnRefreshGPS').onclick = ()=> getGPSFix(true);
    $('btnClearGPS').onclick   = ()=>{ pendingGeo=null; setKV('gpsLine','GPS: cleared'); };

    // ---------- Self-test upload (rules/App Check quick check) ----------
    $('btnSelfTest').onclick = async ()=>{
      try{
        await ensureAuthed();
        const png = await (async ()=>{
          const c=document.createElement('canvas'); c.width=1; c.height=1;
          const g=c.getContext('2d'); g.fillStyle='#fff'; g.fillRect(0,0,1,1);
          const b = await new Promise(res=>c.toBlob(res,'image/png',1));
          return b;
        })();
        const ts = Date.now();
        const ref = stRef(storage, `scenarios/_selftest/selftest-${ts}.png`);
        const task = uploadBytesResumable(ref, png, {contentType:'image/png',cacheControl:'public,max-age=60'});
        const out=$('selfTestOut'); out.textContent='…';
        task.on('state_changed', ()=>{}, (err)=>{
          out.textContent = `Error: ${err.code} — ${err.message}`;
          errBar(`Self-test failed: ${err.code} — ${err.message} (check Storage rules / App Check)`);
        }, async ()=>{
          const url = await getDownloadURL(ref);
          out.textContent = 'OK ✓';
          snack('Self-test upload success');
          console.log('Self-test URL:', url);
        });
      }catch(e){ errBar(`Self-test threw: ${e.code||e.message}`); }
    };

    // ---------- Step 3: upload + DB write ----------
    $('saveBtn').onclick = async ()=>{
      if (!(createdId && pendingFile)){ errBar('Need a scenario and a photo.'); return; }

      try{
        await ensureAuthed();

        show('progWrap', true);
        setKV('progPctFull','0%'); $('progBarFull').style.width='0%';
        setKV('progPctThumb','0%'); $('progBarThumb').style.width='0%';
        $('saveStatus').textContent='preparing image…';

        // Prepare images (compress if possible, else upload original)
        let fullBlob=null, thumbBlob=null, imgW=null, imgH=null, usedOriginal=false;
        const maxEdge = getMaxEdge(); // 800/1280/1600/1920

        try{
          const bmp = await fileToBitmap(pendingFile);
          const full = await toBlob(bmp, maxEdge, QUALITY, 'image/jpeg');
          const thmb = await toBlob(bmp, 320, 0.78, 'image/jpeg'); // smaller thumb for phones
          fullBlob = full.blob; thumbBlob = thmb.blob; imgW=full.width; imgH=full.height;
          const est = (fullBlob.size/1024/1024).toFixed(2);
          setKV('imgInfo', `Save as: ${imgW}×${imgH} • ~${est} MB (JPEG q=${QUALITY})`);
        }catch{
          usedOriginal = true;
          setKV('imgInfo', `Saving original (browser can’t convert). Size: ${(pendingFile.size/1024/1024).toFixed(2)} MB`);
        }

        const ts = Date.now();
        const basePath = `scenarios/${createdId}/${ts}`;
        const fullRef  = stRef(storage, `${basePath}.jpg`);
        const thumbRef = stRef(storage, `scenarios/${createdId}/thumbs/${ts}.jpg`);
        const metaJpg  = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };
        const metaOrig = { contentType: pendingFile.type || 'application/octet-stream', cacheControl:'public,max-age=31536000,immutable' };

        const watch = (task, which)=> new Promise((res,rej)=>{
          if(!task){ res(); return; }
          task.on('state_changed',
            (snap)=>{
              const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
              if(which==='full'){ setKV('progPctFull', pct+'%'); $('progBarFull').style.width = pct+'%'; }
              else { setKV('progPctThumb', pct+'%'); $('progBarThumb').style.width = pct+'%'; }
            },
            (err)=> rej(err),
            ()=> res()
          );
        });

        $('saveStatus').textContent='uploading…';
        let fullTask, thumbTask;
        if (usedOriginal){
          fullTask = uploadBytesResumable(fullRef, pendingFile, metaOrig);
          // best-effort thumb
          try{
            const bmp2 = await fileToBitmap(pendingFile);
            const t2 = await toBlob(bmp2, 320, 0.78, 'image/jpeg');
            thumbTask = uploadBytesResumable(thumbRef, t2.blob, metaJpg);
          }catch{/* skip thumb */}
        }else{
          fullTask  = uploadBytesResumable(fullRef, fullBlob,  metaJpg);
          thumbTask = uploadBytesResumable(thumbRef, thumbBlob, metaJpg);
        }

        await watch(fullTask,'full');
        await watch(thumbTask,'thumb');

        const imageURL = await getDownloadURL(fullRef);
        let thumbURL=null; try{ thumbURL=await getDownloadURL(thumbRef);}catch{}

        $('saveStatus').textContent='saving…';
        const snap = await get(dbRef(db, `scenarios/${createdId}`));
        const sc = snap.exists() ? snap.val() : { id: createdId, title: createdTitle, dispatch: createdDispatch, createdAt: Date.now(), active:true, stops: [] };
        const stops = Array.isArray(sc.stops) ? sc.stops : [];
        stops.push({
          type:'photo', title:'', caption:'',
          imageURL, thumbURL,
          storagePath:`${basePath}.jpg`, thumbPath: thumbURL ? `scenarios/${createdId}/thumbs/${ts}.jpg` : null,
          width: imgW, height: imgH,
          lat: pendingGeo?.lat ?? null, lng: pendingGeo?.lng ?? null, accuracy: pendingGeo?.accuracy ?? null,
          at: ts, overlays:[]
        });
        sc.stops = stops;

        const multi = {};
        multi[`scenarios/${createdId}`] = sc;
        multi[`geophoto/scenarios/${createdId}`] = sc;
        await update(dbRef(db), multi);

        $('saveStatus').textContent='saved ✓';
        snack('Photo saved to cloud.');
        // reset for another
        pendingFile=null; pendingGeo=null;
        $('thumb').src=''; $('thumb').classList.remove('na'); setKV('gpsLine','GPS: —');
        setKV('progPctFull','0%'); $('progBarFull').style.width = '0%';
        setKV('progPctThumb','0%'); $('progBarThumb').style.width = '0%';
        show('progWrap', false); show('previewWrap', false);
        gateSteps();
      }catch(e){
        const code = e?.code || '';
        const msg  = e?.message || String(e);
        $('saveStatus').textContent='error';
        let hint = '';
        if (/unauthorized|permission|denied/i.test(code+msg)) {
          hint = ' — Check Storage rules for "scenarios/**" and App Check enforcement.';
        } else if (/appcheck/i.test(msg)) {
          hint = ' — App Check token missing/invalid; enable App Check here or disable enforcement temporarily.';
        } else if (/quota|limit/i.test(code+msg)) {
          hint = ' — Bucket quota exceeded; clear files or upgrade.';
        }
        errBar(`Upload failed: ${code || 'error'} — ${msg}${hint}`);
        console.error('Upload error:', e);
      }
    };

    // boot
    (async ()=>{
      try{
        const u = await ensureAuthed();
        $('debug').textContent = `Auth: ${u.uid.slice(0,8)} • DB: ${firebaseConfig.databaseURL} • Bucket: ${firebaseConfig.storageBucket}`;
      }catch(_){}
      gateSteps();
    })();
  </script>
</body>
</html>
