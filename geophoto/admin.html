<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Geo-Photo — Admin</title>
<style>
  :root{
    --bg:#081016; --surface:#0f1820; --panel:#0d2430; --text:#e6f6fb; --muted:#86b6c5;
    --accent:#2dd4bf; --accent2:#0a84ff; --danger:#ff6b6b; --border:#1f3945;
    --br:14px; --shadow:0 8px 26px rgba(0,0,0,.35);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5fbff; --surface:#ffffff; --panel:#ffffff; --text:#0b1e27; --muted:#4f6b78; --border:#d7e7ee; --shadow:0 8px 26px rgba(0,0,0,.08) }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px) saturate(1.05);background:color-mix(in hsl, var(--bg) 82%, transparent);border-bottom:1px solid var(--border);padding:10px 14px}
  h1{margin:0;font-size:18px}
  main{max-width:860px;margin:0 auto;padding:12px 14px 60px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--br);box-shadow:var(--shadow);padding:14px;margin:12px 0}
  label{display:block;margin:10px 0 6px 2px;font-size:13px;color:var(--muted)}
  input,textarea,select,button{font-size:16px}
  input[type="text"],input[type="number"],textarea,select{
    width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none
  }
  textarea{min-height:80px;resize:vertical}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:800;box-shadow:var(--shadow)}
  .btn.primary{background:var(--accent);color:#042a28}
  .btn.blue{background:var(--accent2);color:#021627}
  .btn.ghost{background:transparent;color:var(--text);border:2px dashed var(--border)}
  .btn.danger{background:var(--danger);color:#2a0d0d}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .hidden{display:none}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .thumb{width:80px;height:80px;border-radius:10px;border:1px solid var(--border);object-fit:cover;background:#0a2230}
  .listItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--panel)}
  .sectionTitle{font-weight:900;margin:6px 0}
  .hr{height:1px;background:var(--border);opacity:.6;margin:12px 0}
  /* sticky actions (top of create panel) */
  .stickyBar{position:sticky;top:54px;z-index:5;background:color-mix(in hsl, var(--bg) 92%, transparent);border-bottom:1px solid var(--border);padding:8px 0;margin:-6px -4px 8px -4px}
  .note{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header><h1>Geo-Photo — Admin</h1></header>

<main>
  <!-- Landing -->
  <div class="card" id="landing">
    <div class="sectionTitle">Choose an action</div>
    <div class="row" style="margin-top:8px">
      <button id="goCreate" class="btn primary">Create Scenario</button>
      <button id="goEdit" class="btn ghost">Edit Scenario</button>
    </div>
    <div class="pill" id="status">Ready</div>
  </div>

  <!-- Create Scenario -->
  <div class="card hidden" id="createPanel">
    <div class="stickyBar">
      <div class="row" style="justify-content:space-between">
        <div class="pill" id="createStatus">New scenario</div>
        <!-- Top “Add Photo” button removed as requested -->
        <button id="finalizeScenario" class="btn blue">Save Scenario</button>
      </div>
    </div>

    <!-- FIRST STEP: name + dispatch (auto-collapse after first photo save) -->
    <div id="scenarioMeta">
      <label>Scenario Name</label>
      <input id="scenarioName" type="text" placeholder="e.g., House Fire on Main St">

      <label>Dispatch Information</label>
      <textarea id="dispatchInfo" placeholder="Example: Engine 1, Engine 2, Medic 1 respond to ..."></textarea>
    </div>

    <div class="hr"></div>

    <!-- Photo entry -->
    <div>
      <div class="sectionTitle">Add Photo</div>
      <label>Photo (camera or library)</label>
      <input id="photoInput" type="file" accept="image/*" capture="environment">

      <div class="row">
        <div style="flex:1">
          <label>Radius (meters)</label>
          <input id="radius" type="number" inputmode="numeric" min="5" max="1000" value="50">
        </div>
        <div style="flex:1">
          <label>Short Label (optional)</label>
          <input id="shotLabel" type="text" placeholder="Front door, Alpha side...">
        </div>
      </div>

      <label>Caption / Notes (read by TTS)</label>
      <textarea id="caption" placeholder="What should crews observe or do here?"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="savePhoto" class="btn primary">Save Photo</button>
        <div class="note">GPS is captured automatically on save.</div>
      </div>
      <!-- “Retry GPS” button removed as requested -->
    </div>

    <div class="hr"></div>

    <div class="sectionTitle">Photos in this scenario</div>
    <div id="thumbs" class="thumbs"></div>
  </div>

  <!-- Edit Scenario -->
  <div class="card hidden" id="editPanel">
    <div class="sectionTitle">Edit Existing Scenario</div>
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="editStatus">Loading…</div>
      <button id="backFromEdit" class="btn ghost">Back</button>
    </div>
    <div id="scenarioList"></div>
  </div>
</main>

<!-- Firebase + Logic -->
<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, push, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
    authDomain:"dailyquiz-d5279.firebaseapp.com",
    databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
    projectId:"dailyquiz-d5279",
    appId:"1:94577748034:web:c032d3a1d72db1313de5db",
    measurementId:"G-19DVN7NNH7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM
  const landing = document.getElementById('landing');
  const goCreate = document.getElementById('goCreate');
  const goEdit = document.getElementById('goEdit');
  const statusPill = document.getElementById('status');

  const createPanel = document.getElementById('createPanel');
  const createStatus = document.getElementById('createStatus');
  const finalizeScenario = document.getElementById('finalizeScenario');

  const scenarioMeta = document.getElementById('scenarioMeta');
  const scenarioName = document.getElementById('scenarioName');
  const dispatchInfo = document.getElementById('dispatchInfo');

  const photoInput = document.getElementById('photoInput');
  const radius = document.getElementById('radius');
  const shotLabel = document.getElementById('shotLabel');
  const caption = document.getElementById('caption');
  const savePhoto = document.getElementById('savePhoto');
  const thumbs = document.getElementById('thumbs');

  const editPanel = document.getElementById('editPanel');
  const editStatus = document.getElementById('editStatus');
  const scenarioList = document.getElementById('scenarioList');
  const backFromEdit = document.getElementById('backFromEdit');

  // State
  let currentScenarioId = null;
  let localStops = [];

  // Helpers
  function uiShow(el){ el.classList.remove('hidden'); }
  function uiHide(el){ el.classList.add('hidden'); }
  function toast(el, msg){ el.textContent = msg; }

  function readFileAsDataURL(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  function getGPS(){
    return new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        err => reject(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  function renderThumbs(){
    thumbs.innerHTML = '';
    localStops.forEach((s, i)=>{
      const img = document.createElement('img');
      img.className = 'thumb';
      img.title = (s.title || `Stop ${i+1}`);
      img.src = s.imageData || s.imageURL || '';
      thumbs.appendChild(img);
    });
  }

  // Navigation
  goCreate.onclick = ()=>{
    uiHide(landing); uiShow(createPanel);
    createStatus.textContent = 'New scenario';
    currentScenarioId = null; localStops = [];
    scenarioName.value = ''; dispatchInfo.value = '';
    photoInput.value = ''; radius.value = 50; shotLabel.value=''; caption.value='';
    uiShow(scenarioMeta); // visible until first photo is saved
  };

  goEdit.onclick = ()=>{
    uiHide(landing); uiShow(editPanel);
    loadForEdit();
  };

  backFromEdit.onclick = ()=>{
    uiHide(editPanel); uiShow(landing);
    scenarioList.innerHTML = '';
    editStatus.textContent = 'Ready';
  };

  // Create scenario flow
  savePhoto.onclick = async ()=>{
    try{
      const file = photoInput.files?.[0];
      if(!file){ alert('Please choose a photo first.'); return; }

      // If first time: create scenario shell with name/dispatch
      if(!currentScenarioId){
        const name = (scenarioName.value || '').trim();
        if(!name){ alert('Please enter a Scenario Name.'); return; }
        const dispatch = (dispatchInfo.value || '').trim();
        const newRef = push(ref(db, 'scenarios'));
        currentScenarioId = newRef.key;
        await set(newRef, {
          id: currentScenarioId,
          title: name,
          dispatch: dispatch,
          createdAt: Date.now(),
          active: true,
          stops: []
        });
        // Collapse meta after first save (keep old behavior)
        uiHide(scenarioMeta);
      }

      // Prepare image + GPS
      const dataURL = await readFileAsDataURL(file);
      const gps = await getGPS();
      const r = Math.max(5, Math.min(1000, Math.round(parseInt(radius.value || '50', 10))));
      const stop = {
        title: (shotLabel.value || '').trim(),
        caption: (caption.value || '').trim(),
        lat: gps.lat,
        lng: gps.lng,
        radiusMeters: r,
        imageData: dataURL
      };
      // Push into local state and RTDB
      localStops.push(stop);
      await set(ref(db, 'scenarios/' + currentScenarioId + '/stops'), localStops);

      // Clear photo-specific fields
      photoInput.value=''; shotLabel.value=''; caption.value=''; radius.value=50;
      renderThumbs();
      toast(createStatus, `Saved photo #${localStops.length}.`);
    } catch (e){
      alert('Save failed: ' + (e?.message || e));
    }
  };

  // Finalize scenario (rename from End Scenario ➜ Save Scenario)
  finalizeScenario.onclick = async ()=>{
    try{
      if(!currentScenarioId){
        // No photos saved yet: if the user wants to save anyway, create an empty scenario shell.
        const name = (scenarioName.value || '').trim();
        if(!name){ alert('Enter Scenario Name, then Save a Photo or press Save Scenario again to create empty.'); return; }
        const dispatch = (dispatchInfo.value || '').trim();
        const newRef = push(ref(db, 'scenarios'));
        currentScenarioId = newRef.key;
        await set(newRef, {
          id: currentScenarioId,
          title: name,
          dispatch: dispatch,
          createdAt: Date.now(),
          active: true,
          stops: []
        });
        uiHide(scenarioMeta);
      } else {
        // Optionally allow quick rename/dispatch update from the (now hidden) meta using current stored values
        // Nothing required here; stops already up to date in RTDB.
      }
      toast(createStatus, 'Scenario saved.');
      // Reset UI for a fresh create, preserving “old logic” flow
      currentScenarioId = null; localStops = [];
      renderThumbs();
      scenarioName.value = ''; dispatchInfo.value = '';
      photoInput.value=''; shotLabel.value=''; caption.value=''; radius.value=50;
      uiShow(scenarioMeta);
    } catch(e){
      alert('Save Scenario failed: ' + (e?.message || e));
    }
  };

  // Edit scenario (kept from old logic; quick loader with basic actions)
  async function loadForEdit(){
    try{
      editStatus.textContent = 'Loading scenarios…';
      const snap = await get(ref(db, 'scenarios'));
      if(!snap.exists()){ editStatus.textContent = 'No scenarios found.'; scenarioList.innerHTML=''; return; }
      const obj = snap.val() || {};
      const arr = Object.entries(obj).map(([id, s])=>({id, ...s})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      editStatus.textContent = `${arr.length} scenario(s)`;
      scenarioList.innerHTML = '';
      arr.forEach(sc=>{
        const row = document.createElement('div');
        row.className = 'listItem';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:800">${sc.title || '(untitled)'}</div>
                          <div class="note">Stops: ${Array.isArray(sc.stops)? sc.stops.length : 0} • ${new Date(sc.createdAt||Date.now()).toLocaleString()}</div>`;
        const right = document.createElement('div');
        const btnOpen = document.createElement('button');
        btnOpen.className='btn primary'; btnOpen.textContent='Open in Creator';
        btnOpen.onclick = async ()=>{
          // Load into creator for additional photos (old logic)
          uiHide(editPanel); uiShow(createPanel);
          currentScenarioId = sc.id;
          localStops = Array.isArray(sc.stops) ? sc.stops : [];
          renderThumbs();
          // Meta stays hidden while editing existing scenarios
          uiHide(scenarioMeta);
          toast(createStatus, `Editing: ${sc.title || '(untitled)'}`);
        };
        const btnDisable = document.createElement('button');
        btnDisable.className='btn ghost'; btnDisable.textContent = sc.active ? 'Deactivate' : 'Activate';
        btnDisable.style.marginLeft='8px';
        btnDisable.onclick = ()=> update(ref(db,'scenarios/'+sc.id), { active: !sc.active });
        const btnDelete = document.createElement('button');
        btnDelete.className='btn danger'; btnDelete.textContent='Delete';
        btnDelete.style.marginLeft='8px';
        btnDelete.onclick = async ()=>{
          if(confirm('Delete this scenario? This cannot be undone.')){
            await set(ref(db,'scenarios/'+sc.id), null);
            row.remove();
          }
        };
        right.appendChild(btnOpen); right.appendChild(btnDisable); right.appendChild(btnDelete);
        row.appendChild(left); row.appendChild(right);
        scenarioList.appendChild(row);
      });
    } catch(e){
      editStatus.textContent = 'Error: ' + (e?.message || e);
    }
  }
</script>
</body>
</html>
