<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Admin (Geo-Photo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --bg2:#0d121c; --panel:#0f1624; --text:#eaf2ff; --muted:#94a3b8;
      --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.14); --accent:#0a84ff; --danger:#ef4444
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;height:100%;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%);
    }
    .topbar{position:sticky;top:0;z-index:20;background:rgba(12,15,22,.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--edge2)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:800;font-size:18px}
    .badge{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#0a84ff,#54a6ff);display:grid;place-items:center;color:#fff;font-weight:900}
    .spacer{flex:1}
    .btn{
      appearance:none;border:1px solid var(--edge2);
      background:linear-gradient(180deg,#122036,#0f1a2e);
      color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px
    }
    .btn.secondary{background:linear-gradient(180deg,#0f1a2e,#0e1829)}
    .btn.danger{background:linear-gradient(180deg,#2a0f14,#1f0f12);border-color:rgba(255,71,71,.25)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;display:none;animation:spin 1s linear infinite}
    .btn.saving .spinner{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}

    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 26%), linear-gradient(180deg,#0e1524,#0e131e);
      border:1px solid var(--edge);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px;margin:16px
    }
    .hidden{display:none}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){ .grid{grid-template-columns:1.25fr .75fr} }
    label{font-weight:700}
    .input,textarea{width:100%;padding:10px 12px;border-radius:12px;background:#0c1322;color:#eaf2ff;border:1px solid var(--edge2)}
    textarea{min-height:86px}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumbWrap{position:relative;border:1px solid var(--edge2);border-radius:12px;overflow:hidden;background:#0e1624}
    .thumb{width:100%}
    .del{position:absolute;right:8px;bottom:8px}
    .tag{color:var(--muted);font-size:12px}
    .listItem{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 10px;border-radius:12px;border:1px solid var(--edge)}
    #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999}
    .statusLine{margin-top:6px;padding:8px 10px;border-radius:10px;font-size:13px;background:rgba(255,255,255,.04);border:1px solid var(--edge2)}
    .statusLine.good{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08)}
    .statusLine.warn{border-color:rgba(234,179,8,.35);background:rgba(234,179,8,.08)}
    .statusLine.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .small{font-size:12px;opacity:.85}
    code.inline{background:#0d1424;border:1px solid var(--edge2);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div id="errbar"></div>

  <div class="topbar">
    <div class="wrap">
      <div class="logo"><div class="badge">F</div><div>FireOps SIM — Admin</div></div>
      <div class="spacer"></div>
      <button class="btn" id="goCreate">Create</button>
      <button class="btn secondary" id="goEdit">Edit</button>
      <button class="btn secondary" id="goDiag">Diagnostics</button>
    </div>
  </div>

  <main class="grid">
    <!-- Create -->
    <section class="panel hidden" id="createPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Create Scenario</h3>
        <button class="btn secondary" id="backFromCreate">Back</button>
      </div>

      <div class="tag">Enter name/dispatch, then create now or just save a photo (we’ll create the scenario for you).</div>

      <div style="margin-top:10px">
        <label>Scenario Name</label>
        <input class="input" id="scenarioName" placeholder="e.g., House Fire — Elm St." />
      </div>
      <div style="margin-top:10px">
        <label>Dispatch Information</label>
        <textarea id="dispatchInfo" placeholder="Engine 1, Engine 2, Medic 1 to..."></textarea>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="createNow"><span class="spinner"></span><span>Create Scenario Now</span></button>
        <div id="createStatus" class="tag">Ready</div>
      </div>

      <hr style="border-color:rgba(255,255,255,.08)">

      <div style="margin-top:6px"><label>Add Photo Stop</label>
        <input type="file" id="photoInput" accept="image/*;capture=camera">
      </div>
      <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:8px">
        <div><label>Caption (optional)</label><input class="input" id="caption" placeholder="e.g., Alpha side"></div>
        <div><label>Radius (meters)</label><input class="input" id="radius" type="number" min="5" max="1000" value="50"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="savePhoto"><span class="spinner" id="saveSpin"></span><span id="saveLabel">Save Photo</span></button>
        <button class="btn secondary" id="finishAndReturn">Done</button>
      </div>

      <div id="saveSteps" class="statusLine small">Waiting to save…</div>
      <div class="thumbs" id="thumbs" style="margin-top:10px"></div>
    </section>

    <!-- Edit -->
    <section class="panel hidden" id="editPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Edit Existing</h3>
        <div style="display:flex;gap:8px">
          <button class="btn" id="quickNew">➕ New Scenario</button>
          <button class="btn secondary" id="backFromEdit">Back</button>
        </div>
      </div>
      <div class="tag" id="editStatus">Loading…</div>
      <div id="scenarioList" style="margin-top:8px"></div>
    </section>

    <!-- Diagnostics -->
    <section class="panel hidden" id="diagPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Diagnostics</h3>
        <button class="btn secondary" id="backFromDiag">Back</button>
      </div>
      <div class="tag">Connectivity checks and a tiny real upload to Cloud Storage.</div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button class="btn" id="runDiag"><span class="spinner"></span><span>Run Cloud Test</span></button>
        <div id="diagStatus" class="tag">Idle</div>
      </div>
      <div id="diagLog" class="statusLine small" style="margin-top:8px">—</div>
    </section>

    <!-- Landing -->
    <section class="panel" id="landing">
      <h3 style="margin:0 0 6px 0">Manage Scenarios</h3>
      <div class="tag">Choose an action:</div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn" id="landingCreate">Create</button>
        <button class="btn secondary" id="landingEdit">Edit</button>
        <button class="btn secondary" id="landingDiag">Diagnostics</button>
      </div>
    </section>
  </main>

  <!-- Boot script (buttons always work) -->
  <script>
    (function boot(){
      const errbar=document.getElementById('errbar');
      function showErr(m){ try{errbar.textContent=m;errbar.style.display='block';}catch(_){} }

      const landing=document.getElementById('landing');
      const createPanel=document.getElementById('createPanel');
      const editPanel=document.getElementById('editPanel');
      const diagPanel=document.getElementById('diagPanel');
      const editStatus=document.getElementById('editStatus');
      function uiShow(el){ el.classList.remove('hidden'); el.style.display='';}
      function uiHide(el){ el.classList.add('hidden'); el.style.display='none';}

      function goCreate(){ uiHide(landing); uiHide(editPanel); uiHide(diagPanel); uiShow(createPanel); }
      function goEdit(){ uiHide(landing); uiHide(createPanel); uiHide(diagPanel); uiShow(editPanel); (window.loadForEdit||function(){ editStatus.textContent='Firebase not initialized yet.'; })(); }
      function goDiag(){ uiHide(landing); uiHide(createPanel); uiHide(editPanel); uiShow(diagPanel); }

      const bind=(id,fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',fn,{passive:true}); };
      bind('goCreate',goCreate); bind('landingCreate',goCreate);
      bind('goEdit',goEdit);     bind('landingEdit',goEdit);
      bind('goDiag',goDiag);     bind('landingDiag',goDiag);
      bind('backFromCreate',()=>{ uiHide(createPanel); uiHide(editPanel); uiHide(diagPanel); uiShow(landing); });
      bind('backFromEdit',()=>{ uiHide(editPanel); uiHide(createPanel); uiHide(diagPanel); uiShow(landing); editStatus.textContent='Ready'; });
      bind('backFromDiag',()=>{ uiHide(diagPanel); uiHide(createPanel); uiHide(editPanel); uiShow(landing); const s=document.getElementById('diagStatus'); const l=document.getElementById('diagLog'); if(s) s.textContent='Idle'; if(l) l.textContent='—'; });

      window.addEventListener('error', e=>showErr('JS error: '+(e.message||e.error)));
      window.addEventListener('unhandledrejection', e=>showErr('Promise error: '+(e.reason&&e.reason.message||e.reason)));
      window.__adminBootOk = true;
    })();
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <!-- App script -->
  <script>
  (function app(){
    const FUNCTION_UPLOAD_URL = 'https://us-central1-dailyquiz-d5279.cloudfunctions.net/uploadScenarioImage';

    const errbar=document.getElementById('errbar');
    const showErr=m=>{ try{errbar.textContent=m;errbar.style.display='block';}catch(_){} };

    const saveSteps=document.getElementById('saveSteps');
    const createStatus=document.getElementById('createStatus');
    const scenarioList=document.getElementById('scenarioList');
    function step(msg, cls){ if(!saveSteps) return; cls=cls||''; saveSteps.className=('statusLine small '+cls).trim(); saveSteps.innerHTML=msg; }

    if (typeof firebase === 'undefined' || !firebase.initializeApp) {
      showErr('Firebase SDK not loaded');
      window.loadForEdit = function(){ const el=document.getElementById('editStatus'); if(el) el.textContent='Firebase not loaded.'; };
      return;
    }

    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.firebasestorage.app",   /* <<<< UPDATED */
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };

    try{ firebase.initializeApp(firebaseConfig); }
    catch(e){ showErr('Firebase init failed: ' + (e && e.message || e)); return; }

    const db = firebase.database();
    const storage = firebase.storage();
    const auth = firebase.auth();
    const BUCKET = firebaseConfig.storageBucket || (firebaseConfig.projectId + '.firebasestorage.app');

    auth.onAuthStateChanged(function(){});
    async function ensureAuthed(){
      if (auth.currentUser) return auth.currentUser;
      try{
        await auth.signInAnonymously();
        return new Promise(function(resolve){ const off=auth.onAuthStateChanged(function(u){ if(u){ off(); resolve(u);} }); });
      }catch(e){ return null; }
    }

    const scenarioName=document.getElementById('scenarioName');
    const dispatchInfo=document.getElementById('dispatchInfo');
    const photoInput=document.getElementById('photoInput');
    const caption=document.getElementById('caption');
    const radius=document.getElementById('radius');
    const thumbs=document.getElementById('thumbs');
    const createNowBtn=document.getElementById('createNow');
    const savePhotoBtn=document.getElementById('savePhoto');
    const saveLabel=document.getElementById('saveLabel');
    const runDiagBtn=document.getElementById('runDiag');
    const diagStatus=document.getElementById('diagStatus');
    const diagLog=document.getElementById('diagLog');

    let currentScenarioId=null;
    let localStops=[];

    function setSaving(isSaving,label){
      if(savePhotoBtn) savePhotoBtn.disabled=isSaving;
      if(createNowBtn)  createNowBtn.disabled=isSaving;
      const e1=document.getElementById('goEdit'), e2=document.getElementById('goDiag');
      if(e1) e1.disabled=isSaving; if(e2) e2.disabled=isSaving;
      if(savePhotoBtn) savePhotoBtn.classList.toggle('saving', !!isSaving);
      if(saveLabel) saveLabel.textContent = label || (isSaving ? 'Saving…' : 'Save Photo');
    }
    function withTimeout(promise, ms, code){
      return Promise.race([
        promise,
        new Promise(function(_,_rej){ setTimeout(function(){ var e=new Error('Timed out after '+ms+'ms'); e.code=code||'timeout'; _rej(e); }, ms); })
      ]);
    }
    function readFileAsDataURL(f){ return new Promise(function(res,rej){ const r=new FileReader(); r.onload=function(){res(r.result)}; r.onerror=rej; r.readAsDataURL(f); }); }
    function loadImage(src){ return new Promise(function(res,rej){ const i=new Image(); i.onload=function(){res(i)}; i.onerror=rej; i.crossOrigin='anonymous'; i.src=src; }); }
    function toCanvas(img,maxW, maxH){ maxW=maxW||1920; maxH=maxH||1920; const c=document.createElement('canvas'); const s=Math.min(maxW/img.width,maxH/img.height,1); c.width=Math.round(img.width*s); c.height=Math.round(img.height*s); c.getContext('2d').drawImage(img,0,0,c.width,c.height); return c; }
    function encodeSmart(c){ const url=c.toDataURL('image/jpeg',0.85); return 'data:image/jpeg;base64,'+url.split(',')[1]; }
    function dataURLFromStored(v){ return (typeof v==='string') ? v : (v && v.data ? 'data:image/'+(v.format||'jpeg')+';base64,'+v.data : ''); }
    function getGPS(){
      return new Promise(function(resolve){
        if (!navigator.geolocation) return resolve({lat:null,lng:null, note:'no-geolocation'});
        var done=false; function finish(v){ if(!done){ done=true; resolve(v);} }
        navigator.geolocation.getCurrentPosition(
          function(p){ finish({lat:p.coords.latitude,lng:p.coords.longitude}); },
          function(){ finish({lat:null,lng:null, note:'denied-or-error'}); },
          {enableHighAccuracy:true,timeout:3000,maximumAge:0}
        );
        setTimeout(function(){ finish({lat:null,lng:null, note:'timeout'}); }, 3000);
      });
    }
    function explainError(e){
      var code = (e && e.code) || '';
      if ((code||'').indexOf('timeout')>=0) return 'Network/device took too long to respond.';
      if (code.indexOf('auth/configuration-not-found')>=0 || code.indexOf('auth/operation-not-allowed')>=0) return 'Anonymous Auth not enabled.';
      if (code.indexOf('storage/unauthorized')>=0 || code.indexOf('permission-denied')>=0) return 'Storage rules or App Check denied the write.';
      if (code.indexOf('storage/quota-exceeded')>=0) return 'Bucket quota exceeded.';
      if (code.indexOf('save/function-')>=0) return 'Server upload failed.';
      return 'Unexpected error while saving photo.';
    }
    function renderThumbs(){
      if(!thumbs) return;
      thumbs.innerHTML='';
      localStops.forEach(function(s,i){
        var wrap=document.createElement('div'); wrap.className='thumbWrap';
        var img=document.createElement('img'); img.className='thumb'; img.src=s.imageURL || dataURLFromStored(s.imageData) || ''; img.title=s.caption||('Stop '+(i+1));
        var del=document.createElement('button'); del.className='btn danger del'; del.textContent='Delete';
        del.onclick=function(){ deleteStopAt(i); };
        wrap.appendChild(img); wrap.appendChild(del); thumbs.appendChild(wrap);
      });
    }

    async function createScenarioRecord(){
      var name=(scenarioName && scenarioName.value||'').trim();
      if(!name) throw new Error('Please enter a Scenario Name');
      var dispatch=(dispatchInfo && dispatchInfo.value||'').trim();
      var newRef=db.ref('scenarios').push();
      currentScenarioId=newRef.key;
      await newRef.set({ id:currentScenarioId, title:name, dispatch:dispatch, createdAt:Date.now(), active:true, stops:[] });
      if(createStatus) createStatus.textContent='Scenario created.';
      return currentScenarioId;
    }

    if (document.getElementById('createNow')) {
      document.getElementById('createNow').addEventListener('click', async function(){
        try{ setSaving(true,'Creating…'); await createScenarioRecord(); step('Scenario created. You can now add photos.','good'); }
        catch(e){ step('Could not create scenario: ' + (e && e.message || e),'bad'); showErr(e && e.message || String(e)); }
        finally{ setSaving(false,'Create Scenario Now'); }
      });
    }
    if (document.getElementById('quickNew')) {
      document.getElementById('quickNew').addEventListener('click', async function(){
        setTimeout(async function(){
          try{
            if(scenarioName && !scenarioName.value) scenarioName.value='New Scenario';
            setSaving(true,'Creating…'); await createScenarioRecord(); step('Scenario created.','good');
          }catch(e){ step('Could not create scenario: ' + (e && e.message || e),'bad'); showErr(e && e.message || String(e)); }
          finally{ setSaving(false,'Create Scenario Now'); }
        },0);
      });
    }

    function dataURLtoBlob(dataURL){
      var parts=dataURL.split(','), head=parts[0], b64=parts[1];
      var mime=(/data:(.*?);base64/.exec(head)||[, 'application/octet-stream'])[1];
      var bin=atob(b64), len=bin.length, buf=new Uint8Array(len);
      for(var i=0;i<len;i++) buf[i]=bin.charCodeAt(i);
      return new Blob([buf], {type:mime});
    }
    async function uploadToStorage(dataURL, scenarioId){
      await ensureAuthed();
      var path='scenarios/'+scenarioId+'/'+Date.now()+'.jpg';
      var refObj=storage.ref(path);
      var blob=dataURLtoBlob(dataURL);
      var metadata={ contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };
      var task=refObj.put(blob, metadata);

      return await new Promise(function(resolve,reject){
        var killer=setTimeout(function(){ try{ task.cancel(); }catch(_){} var e=new Error('Timed out while uploading'); e.code='save/timeout-upload'; reject(e); }, 45000);
        task.on('state_changed',
          function(snap){ var pct=Math.round(100*snap.bytesTransferred/snap.totalBytes); step('Uploading to Cloud Storage… '+pct+'%'); },
          function(err){ clearTimeout(killer); reject(err); },
          async function(){ clearTimeout(killer); try{
              var url=await withTimeout(refObj.getDownloadURL(), 6000, 'save/timeout-url');
              resolve({ url:url, path:path, gsUri:'gs://'+BUCKET+'/'+path });
            }catch(e){ reject(e); }
          }
        );
      });
    }
    async function uploadViaFunction(dataURL, scenarioId){
      var payload = { scenarioId: scenarioId, fileName: Date.now() + '.jpg', dataURL: dataURL };
      var resp = await withTimeout(fetch(FUNCTION_UPLOAD_URL, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      }), 25000, 'save/timeout-fn');

      if (!resp.ok) {
        var txt = await resp.text().catch(()=> '');
        var e = new Error('Function HTTP ' + resp.status + ' ' + txt);
        e.code = 'save/function-http';
        throw e;
      }
      var json = await resp.json();
      if (!json.ok) {
        var e2 = new Error('Function error: ' + (json.error || 'unknown'));
        e2.code = 'save/function-error';
        throw e2;
      }
      return { url: json.url, path: json.path, gsUri: json.gsUri, via: 'function' };
    }

    if (document.getElementById('savePhoto')) {
      document.getElementById('savePhoto').addEventListener('click', async function(){
        var killTimer=setTimeout(function(){ setSaving(false); }, 25000);
        setSaving(true);
        try{
          step('Checking selected file…');
          var file=photoInput && photoInput.files && photoInput.files[0];
          if(!file){ step('Please choose a photo first.','warn'); setSaving(false); clearTimeout(killTimer); return; }

          if(!currentScenarioId){
            step('Creating scenario record…');
            try{ await createScenarioRecord(); }
            catch(e){ step('Could not create scenario: ' + (e && e.message || e),'bad'); setSaving(false); clearTimeout(killTimer); return; }
          }

          step('Compressing photo…');
          var raw=await readFileAsDataURL(file);
          var img=await loadImage(raw);
          var c=toCanvas(img);
          var dataURL=encodeSmart(c);

          step('Uploading to Cloud Storage…');
          var cloud=null, cloudErr=null;

          try { cloud = await uploadToStorage(dataURL, currentScenarioId); }
          catch(e) {
            cloudErr = e;
            step('Direct upload failed (' + (e.code || e) + '). Trying server upload…');
            try { cloud = await uploadViaFunction(dataURL, currentScenarioId); }
            catch(e2) { cloudErr = e2; }
          }

          step('Saving metadata to database…');
          var gps=await getGPS();
          var r=Math.max(5, Math.min(1000, Math.round(parseInt((radius && radius.value)||'50',10))));
          var stop={ caption:(caption && caption.value||'').trim(), lat:gps.lat, lng:gps.lng, radiusMeters:r };

          if (cloud){
            stop.imageURL=cloud.url; stop.storagePath=cloud.path; stop.gsUri=cloud.gsUri;
            step('Photo saved'+(cloud.via==='function'?' via server':'')+' and metadata written.','good');
          } else {
            var reason=cloudErr ? (explainError(cloudErr)+' <br><span class="small">(code: '+(cloudErr.code||'n/a')+')</span>') : 'Unknown reason.';
            stop.imageData={ format:'jpeg', data=dataURL.split(',')[1] };
            step('Saved photo inline. <b>Queued for server upload</b>.<br>Reason: '+reason,'warn');
          }

          localStops.push(stop);
          await withTimeout(db.ref('scenarios/'+currentScenarioId+'/stops').set(localStops), 8000, 'save/timeout-db');

          if(caption) caption.value=''; if(radius) radius.value=50; if(photoInput) photoInput.value='';
          renderThumbs();
        }catch(e){
          step('Save failed: '+(e && e.message || e),'bad'); showErr(e && e.message || String(e));
        }finally{
          clearTimeout(killTimer);
          setSaving(false);
        }
      });
    }

    if (document.getElementById('finishAndReturn')) {
      document.getElementById('finishAndReturn').addEventListener('click', function(){
        const landing=document.getElementById('landing'), createPanel=document.getElementById('createPanel');
        if(landing&&createPanel){ createPanel.classList.add('hidden'); landing.classList.remove('hidden'); landing.style.display=''; }
      });
    }

    async function deleteStopAt(i){
      if(i<0||i>=localStops.length) return;
      if(!confirm('Delete this photo?')) return;
      var s=localStops[i];
      try{
        if (s && (s.gsUri || s.storagePath)){
          await ensureAuthed();
          var refObj = s.gsUri ? storage.refFromURL(s.gsUri) : storage.ref(s.storagePath);
          await refObj.delete();
        }
      }catch(_){}
      localStops.splice(i,1);
      await db.ref('scenarios/'+currentScenarioId+'/stops').set(localStops);
      renderThumbs();
    }

    window.loadForEdit = async function(){
      try{
        const editStatus=document.getElementById('editStatus');
        if(editStatus) editStatus.textContent='Loading…';
        var snap=await db.ref('scenarios').get();
        if(!snap.exists()){ scenarioList.innerHTML=''; if(editStatus) editStatus.textContent='No scenarios found.'; return; }
        var obj=snap.val()||{};
        var arr=Object.keys(obj).map(function(id){ return Object.assign({id:id}, obj[id]); }).sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); });
        if(editStatus) editStatus.textContent=arr.length+' scenario(s)';
        scenarioList.innerHTML='';
        arr.forEach(function(sc){
          var row=document.createElement('div'); row.className='listItem';
          var left=document.createElement('div');
          left.innerHTML='<div style="font-weight:800">'+(sc.title||'(untitled)')+'</div>'+
            '<div class="tag">Stops: '+(Array.isArray(sc.stops)? sc.stops.length : 0)+' • '+new Date(sc.createdAt||Date.now()).toLocaleString()+'</div>';
          var right=document.createElement('div');
          var open=document.createElement('button'); open.className='btn'; open.textContent='Open';
          open.onclick=function(){
            const landing=document.getElementById('landing'), editPanel=document.getElementById('editPanel'), createPanel=document.getElementById('createPanel');
            currentScenarioId=sc.id; localStops=Array.isArray(sc.stops)? sc.stops:[]; if(scenarioName) scenarioName.value=sc.title||''; if(dispatchInfo) dispatchInfo.value=sc.dispatch||'';
            if(landing&&editPanel&&createPanel){ landing.classList.add('hidden'); editPanel.classList.add('hidden'); createPanel.classList.remove('hidden'); createPanel.style.display=''; }
            renderThumbs(); step('Editing existing scenario.');
          };
          var toggle=document.createElement('button'); toggle.className='btn secondary'; toggle.style.marginLeft='8px'; toggle.textContent=sc.active?'Deactivate':'Activate';
          toggle.onclick=function(){ db.ref('scenarios/'+sc.id).update({active:!sc.active}); };
          var del=document.createElement('button'); del.className='btn danger'; del.style.marginLeft='8px'; del.textContent='Delete';
          del.onclick=async function(){
            if(!confirm('Delete this scenario?')) return;
            try{ await ensureAuthed(); }catch(_){}
            if(Array.isArray(sc.stops)){
              for(var k=0;k<sc.stops.length;k++){
                try{
                  var s=sc.stops[k];
                  var refObj = s && s.gsUri ? storage.refFromURL(s.gsUri) : (s && s.storagePath ? storage.ref(s.storagePath) : null);
                  if(refObj) await refObj.delete();
                }catch(_){}
              }
            }
            await db.ref('scenarios/'+sc.id).set(null); row.remove();
          };
          right.appendChild(open); right.appendChild(toggle); right.appendChild(del);
          row.appendChild(left); row.appendChild(right); scenarioList.appendChild(row);
        });
      }catch(e){
        const editStatus=document.getElementById('editStatus');
        if(editStatus) editStatus.textContent='Error: '+(e && e.message || e);
        showErr(e && e.message || String(e));
      }
    };

    function setDiagSaving(is,label){
      var b=runDiagBtn; if(!b) return;
      b.disabled=is; b.classList.toggle('saving', !!is);
      b.querySelector('span:last-child').textContent = label || (is ? 'Running…' : 'Run Cloud Test');
    }
    function logDiag(line, cls){ if(!diagLog) return; cls=cls||''; diagLog.className=('statusLine small '+cls).trim(); diagLog.innerHTML=(diagLog.innerHTML==='—'?'':diagLog.innerHTML+'<br>')+line; }
    async function runDiagnostics(){
      if(!runDiagBtn) return;
      setDiagSaving(true); if(diagStatus) diagStatus.textContent='Running…'; if(diagLog) diagLog.textContent='—';
      try{
        await withTimeout(fetch('https://firebasestorage.googleapis.com/generate_204', {cache:'no-store'}), 6000, 'diag/timeout-generate204');
        logDiag('1) Reachability (generate_204): <b>OK</b>','good');
      }catch(e){ logDiag('1) Reachability (generate_204): <b>FAILED</b> — '+(e.code||e),'bad'); }
      try{
        var r = await withTimeout(fetch('https://firebasestorage.googleapis.com/v0/b/'+BUCKET+'/o?maxResults=1', {cache:'no-store'}), 8000, 'diag/timeout-bucket');
        logDiag('2) Bucket endpoint: <b>HTTP '+r.status+'</b> (401/403 is OK for reachability)', (r.ok||r.status===401||r.status===403)?'good':'warn');
      }catch(e){ logDiag('2) Bucket endpoint: <b>FAILED</b> — '+(e.code||e),'bad'); }
      try{
        var png1x1='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwoB9oPy2kAAAAAASUVORK5CYII=';
        var result = await uploadViaFunction(png1x1, 'diagnostics');
        logDiag('3) Tiny upload (server): <b>SUCCESS</b> → <code class="inline">'+result.path+'</code>', 'good');
      }catch(e){
        logDiag('3) Tiny upload (server): <b>FAILED</b> — '+explainError(e)+' <span class="small">(code: '+(e.code||'n/a')+')</span>','bad');
      }
      setDiagSaving(false); if(diagStatus) diagStatus.textContent='Done';
    }
    if (runDiagBtn) runDiagBtn.addEventListener('click', runDiagnostics);

  })(); // app()
  </script>
</body>
</html>
