<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Admin (Geo-Photo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14; --bg2:#0d121c; --panel:#0f1624; --text:#eaf2ff; --muted:#94a3b8; --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.14); --accent:#0a84ff; --danger:#ef4444 }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:
      radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
      radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
      linear-gradient(165deg, var(--bg2), var(--bg) 55%)}
    .topbar{position:sticky;top:0;z-index:20;background:rgba(12,15,22,.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--edge2)}
    .wrap{max-width:1050px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:800;font-size:18px}
    .badge{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#0a84ff,#54a6ff);display:grid;place-items:center;color:#fff;font-weight:900}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--edge2);background:linear-gradient(180deg,#122036,#0f1a2e);color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn.secondary{background:linear-gradient(180deg,#0f1a2e,#0e1829)} .btn.danger{background:linear-gradient(180deg,#2a0f14,#1f0f12);border-color:rgba(255,71,71,.25)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;display:none;animation:spin 1s linear infinite}
    .btn.saving .spinner{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 26%), linear-gradient(180deg,#0e1524,#0e131e);border:1px solid var(--edge);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px;margin:16px}
    .hidden{display:none} .grid{display:grid;gap:14px} @media(min-width:860px){ .grid{grid-template-columns:1.2fr .8fr} }
    label{font-weight:700} .input,textarea{width:100%;padding:10px 12px;border-radius:12px;background:#0c1322;color:#eaf2ff;border:1px solid var(--edge2)} textarea{min-height:86px}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumbWrap{position:relative;border:1px solid var(--edge2);border-radius:12px;overflow:hidden;background:#0e1624}
    .thumb{width:100%} .del{position:absolute;right:8px;bottom:8px}
    .tag{color:var(--muted);font-size:12px}
    .listItem{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 10px;border-radius:12px;border:1px solid var(--edge)}
    #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999}
    .statusLine{margin-top:6px;padding:8px 10px;border-radius:10px;font-size:13px;background:rgba(255,255,255,.04);border:1px solid var(--edge2)}
    .statusLine.good{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08)}
    .statusLine.warn{border-color:rgba(234,179,8,.35);background:rgba(234,179,8,.08)}
    .statusLine.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .small{font-size:12px;opacity:.85}
  </style>
</head>
<body>
  <div id="errbar"></div>

  <div class="topbar">
    <div class="wrap">
      <div class="logo"><div class="badge">F</div><div>FireOps SIM — Admin</div></div>
      <div class="spacer"></div>
      <button class="btn" id="goCreate">Create Scenario</button>
      <button class="btn secondary" id="goEdit">Edit Existing</button>
    </div>
  </div>

  <main class="grid">
    <section class="panel hidden" id="createPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Create Scenario</h3>
        <button class="btn secondary" id="backFromCreate">Back</button>
      </div>

      <div class="tag">Enter name/dispatch, then create now or just save a photo (we’ll create the scenario for you).</div>

      <div style="margin-top:10px">
        <label>Scenario Name</label>
        <input class="input" id="scenarioName" placeholder="e.g., House Fire — Elm St." />
      </div>
      <div style="margin-top:10px">
        <label>Dispatch Information</label>
        <textarea id="dispatchInfo" placeholder="Engine 1, Engine 2, Medic 1 to..."></textarea>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="createNow"><span class="spinner"></span><span>Create Scenario Now</span></button>
        <div id="createStatus" class="tag">Ready</div>
      </div>

      <hr style="border-color:rgba(255,255,255,.08)">

      <div style="margin-top:6px"><label>Add Photo Stop</label>
        <input type="file" id="photoInput" accept="image/*;capture=camera">
      </div>
      <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:8px">
        <div><label>Caption (optional)</label><input class="input" id="caption" placeholder="e.g., Alpha side"></div>
        <div><label>Radius (meters)</label><input class="input" id="radius" type="number" min="5" max="1000" value="50"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="savePhoto"><span class="spinner" id="saveSpin"></span><span id="saveLabel">Save Photo</span></button>
        <button class="btn secondary" id="finishAndReturn">Done</button>
      </div>

      <div id="saveSteps" class="statusLine small">Waiting to save…</div>

      <div class="thumbs" id="thumbs" style="margin-top:10px"></div>
    </section>

    <section class="panel hidden" id="editPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Edit Existing</h3>
        <div style="display:flex;gap:8px">
          <button class="btn" id="quickNew">➕ New Scenario</button>
          <button class="btn secondary" id="backFromEdit">Back</button>
        </div>
      </div>
      <div class="tag" id="editStatus">Loading…</div>
      <div id="scenarioList" style="margin-top:8px"></div>
    </section>

    <section class="panel" id="landing">
      <h3 style="margin:0 0 6px 0">Manage Scenarios</h3>
      <div class="tag">Choose an action:</div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn" id="landingCreate">Create Scenario</button>
        <button class="btn secondary" id="landingEdit">Edit Existing</button>
      </div>
    </section>
  </main>

  <script type="module">
  // Safety: default stub so "Edit Existing" never throws even if init fails
  window.loadForEdit = function(){ document.getElementById('editStatus').textContent = 'Firebase not initialized yet.'; };

  // Error HUD
  const errbar=document.getElementById('errbar');
  const showErr=m=>{errbar.textContent=m;errbar.style.display='block';};
  window.addEventListener('unhandledrejection', e=>showErr('Promise error: ' + (e.reason?.message || e.reason)));
  window.addEventListener('error', e=>showErr('JS error: ' + (e.message || e.error)));

  // Nav
  const landing=document.getElementById('landing');
  const createPanel=document.getElementById('createPanel');
  const editPanel=document.getElementById('editPanel');
  const scenarioList=document.getElementById('scenarioList');
  const editStatus=document.getElementById('editStatus');
  const createStatus=document.getElementById('createStatus');
  const saveSteps=document.getElementById('saveSteps');
  const uiShow=el=>{el.classList.remove('hidden'); el.style.display='';};
  const uiHide=el=>{el.classList.add('hidden'); el.style.display='none';};
  const goCreate=()=>{ uiHide(landing); uiHide(editPanel); uiShow(createPanel); };
  const goEdit=()=>{ uiHide(landing); uiHide(createPanel); uiShow(editPanel); window.loadForEdit(); };
  document.getElementById('goCreate').onclick=goCreate;
  document.getElementById('goEdit').onclick=goEdit;
  document.getElementById('landingCreate').onclick=goCreate;
  document.getElementById('landingEdit').onclick=goEdit;
  document.getElementById('backFromCreate').onclick=()=>{ uiHide(createPanel); uiHide(editPanel); uiShow(landing); };
  document.getElementById('backFromEdit').onclick=()=>{ uiHide(editPanel); uiHide(createPanel); uiShow(landing); scenarioList.innerHTML=''; editStatus.textContent='Ready'; };

  // Firebase (no App Check here to avoid process polyfill issues)
  try{
    const [{ initializeApp }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js") ]);
    const [{ getDatabase, ref:dbRef, push, set, get, update }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js") ]);
    const [{ getStorage, ref:stRef, uploadString, getDownloadURL, deleteObject }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js") ]);
    const [{ getAuth, onAuthStateChanged, signInAnonymously }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js") ]);

    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const BUCKET = app.options?.storageBucket || (firebaseConfig.projectId + ".appspot.com");

    onAuthStateChanged(auth,()=>{});
    async function ensureAuthed(){
      if (auth.currentUser) return auth.currentUser;
      try{
        await signInAnonymously(auth);
        return await new Promise(res=>{ const off=onAuthStateChanged(auth,u=>{ if(u){ off(); res(u);} });});
      }catch(e){ return null; }
    }

    // DOM
    const scenarioName=document.getElementById('scenarioName');
    const dispatchInfo=document.getElementById('dispatchInfo');
    const photoInput=document.getElementById('photoInput');
    const caption=document.getElementById('caption');
    const radius=document.getElementById('radius');
    const thumbs=document.getElementById('thumbs');
    const createNowBtn=document.getElementById('createNow');
    const savePhotoBtn=document.getElementById('savePhoto');
    const saveLabel=document.getElementById('saveLabel');
    const doneBtn=document.getElementById('finishAndReturn');
    const quickNewBtn=document.getElementById('quickNew');

    // State
    let currentScenarioId=null;
    let localStops=[];

    // Helpers
    const readFileAsDataURL=f=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    const loadImage=src=>new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.crossOrigin='anonymous'; i.src=src; });
    function toCanvas(img,maxW=1920,maxH=1920){ const c=document.createElement('canvas'); const s=Math.min(maxW/img.width,maxH/img.height,1); c.width=Math.round(img.width*s); c.height=Math.round(img.height*s); c.getContext('2d').drawImage(img,0,0,c.width,c.height); return c; }
    function encodeSmart(c){ const url=c.toDataURL('image/jpeg',0.85); return `data:image/jpeg;base64,${url.split(',')[1]}`; }
    function dataURLFromStored(v){ return (typeof v==='string') ? v : (v?.data ? `data:image/${(v.format||'jpeg')};base64,${v.data}` : ''); }
    function step(msg, cls=''){ saveSteps.className = `statusLine small ${cls}`.trim(); saveSteps.innerHTML = msg; }
    function setSaving(isSaving,label){
      savePhotoBtn.toggleAttribute('disabled', isSaving);
      createNowBtn.toggleAttribute('disabled', isSaving);
      document.getElementById('goEdit').toggleAttribute('disabled', isSaving);
      savePhotoBtn.classList.toggle('saving', isSaving);
      saveLabel.textContent = label || (isSaving ? 'Saving…' : 'Save Photo');
    }
    // Hard timeout helper
    const withTimeout = (p, ms, code='timeout') => Promise.race([
      p,
      new Promise((_,rej)=>setTimeout(()=>{ const e=new Error(`Timed out after ${ms}ms`); e.code=code; rej(e); }, ms))
    ]);

    // GPS with fast fallback (3s)
    const getGPS=()=>new Promise(resolve=>{
      if (!navigator.geolocation) return resolve({lat:null,lng:null, note:'no-geolocation'});
      let done=false;
      const finish=(v)=>{ if(!done){ done=true; resolve(v);} };
      navigator.geolocation.getCurrentPosition(
        p=>finish({lat:p.coords.latitude,lng:p.coords.longitude}),
        _=>finish({lat:null,lng:null, note:'denied-or-error'}),
        {enableHighAccuracy:true,timeout:3000,maximumAge:0}
      );
      setTimeout(()=>finish({lat:null,lng:null, note:'timeout'}), 3000);
    });

    function renderThumbs(){
      thumbs.innerHTML='';
      localStops.forEach((s,i)=>{
        const wrap=document.createElement('div'); wrap.className='thumbWrap';
        const img=document.createElement('img'); img.className='thumb'; img.src=s.imageURL || dataURLFromStored(s.imageData) || ''; img.title=s.caption||`Stop ${i+1}`;
        const del=document.createElement('button'); del.className='btn danger del'; del.textContent='Delete';
        del.onclick=async()=>{ await deleteStopAt(i); };
        wrap.appendChild(img); wrap.appendChild(del); thumbs.appendChild(wrap);
      });
    }

    function explainError(e){
      const code = e?.code || '';
      const msg  = e?.message || String(e);
      if (code.includes('auth/configuration-not-found') || code.includes('auth/operation-not-allowed')) return 'Anonymous Auth not enabled.';
      if (code.includes('storage/unauthorized') || code.includes('permission-denied')) return 'Storage rules or App Check denied the write.';
      if ((code||'').includes('timeout')) return 'Network/device took too long to respond.';
      if (code.includes('storage/quota-exceeded')) return 'Bucket quota exceeded.';
      return 'Unexpected error while saving photo.';
    }

    async function createScenarioRecord(){
      const name=(scenarioName.value||'').trim();
      if(!name) throw new Error('Please enter a Scenario Name');
      const dispatch=(dispatchInfo.value||'').trim();
      const newRef = push(dbRef(db,'scenarios'));
      currentScenarioId = newRef.key;
      await set(newRef,{ id:currentScenarioId, title:name, dispatch:dispatch, createdAt:Date.now(), active:true, stops:[] });
      createStatus.textContent='Scenario created.';
      return currentScenarioId;
    }

    document.getElementById('createNow').onclick = async ()=>{
      try{ setSaving(true,'Creating…'); await createScenarioRecord(); step('Scenario created. You can now add photos.','good'); }
      catch(e){ step('Could not create scenario: ' + (e?.message||e),'bad'); showErr(e?.message||String(e)); }
      finally{ setSaving(false,'Create Scenario Now'); }
    };

    document.getElementById('quickNew').onclick = async ()=>{
      goCreate();
      setTimeout(async()=>{
        try{
          if(!scenarioName.value) scenarioName.value = 'New Scenario';
          setSaving(true,'Creating…'); await createScenarioRecord(); step('Scenario created.','good');
        }catch(e){ step('Could not create scenario: ' + (e?.message||e),'bad'); showErr(e?.message||String(e)); }
        finally{ setSaving(false,'Create Scenario Now'); }
      },0);
    };

    async function uploadToStorage(dataURL, scenarioId){
      await ensureAuthed();
      const path = `scenarios/${scenarioId}/${Date.now()}.jpg`;
      const refObj = stRef(storage, path);
      await withTimeout(uploadString(refObj, dataURL, 'data_url'), 12000, 'save/timeout-upload');
      const url = await withTimeout(getDownloadURL(refObj), 6000, 'save/timeout-url');
      return { url, path, gsUri:`gs://${BUCKET}/${path}` };
    }

    document.getElementById('savePhoto').onclick = async ()=>{
      // safety: kill spinner after 25s no matter what
      let killTimer = setTimeout(()=>setSaving(false), 25000);

      setSaving(true);
      try{
        step('Checking selected file…');
        const file=photoInput.files?.[0];
        if(!file){ step('Please choose a photo first.', 'warn'); setSaving(false); clearTimeout(killTimer); return; }

        if(!currentScenarioId){
          step('Creating scenario record…');
          try{ await createScenarioRecord(); }
          catch(e){ step('Could not create scenario: ' + (e?.message||e), 'bad'); setSaving(false); clearTimeout(killTimer); return; }
        }

        step('Compressing photo…');
        const raw=await readFileAsDataURL(file);
        const img=await loadImage(raw);
        const c=toCanvas(img);
        const dataURL=encodeSmart(c);

        step('Uploading to Cloud Storage…');
        let cloud=null, cloudErr=null;
        try{ cloud = await uploadToStorage(dataURL, currentScenarioId); }
        catch(e){ cloudErr = e; }

        step('Saving metadata to database…');
        const gps = await getGPS();
        const r = Math.max(5, Math.min(1000, Math.round(parseInt(radius.value||'50',10))));
        const stop = { caption:(caption.value||'').trim(), lat:gps.lat, lng:gps.lng, radiusMeters:r };

        if (cloud){
          stop.imageURL=cloud.url; stop.storagePath=cloud.path; stop.gsUri=cloud.gsUri;
          step('Photo uploaded to Cloud Storage and saved.', 'good');
        } else {
          const reason = cloudErr ? `${explainError(cloudErr)} <br><span class="small">(code: ${cloudErr.code || 'n/a'})</span>` : 'Unknown reason.';
          stop.imageData={ format:'jpeg', data:dataURL.split(',')[1] };
          step(`Saved photo inline. Cloud upload failed because: <br>${reason}`, 'warn');
        }

        localStops.push(stop);
        try{
          await withTimeout(set(dbRef(db,`scenarios/${currentScenarioId}/stops`), localStops), 8000, 'save/timeout-db');
        }catch(e){
          step('Saved image, but database write timed out/failed. You may need to retry. <br><span class="small">Reason: '+(e?.code||e)+'</span>','bad');
          throw e;
        }

        caption.value=''; radius.value=50; photoInput.value='';
        renderThumbs();
      }catch(e){
        step('Save failed: ' + (e?.message||e), 'bad'); showErr(e?.message||String(e));
      }finally{
        clearTimeout(killTimer);
        setSaving(false);
      }
    };

    document.getElementById('finishAndReturn').onclick = ()=>{ uiHide(createPanel); uiShow(landing); };

    async function deleteStopAt(i){
      if(i<0||i>=localStops.length) return;
      if(!confirm('Delete this photo?')) return;
      const s=localStops[i];
      try{
        if (s?.gsUri || s?.storagePath){
          await ensureAuthed();
          const refObj = s.gsUri ? stRef(storage,s.gsUri) : stRef(storage,s.storagePath);
          await deleteObject(refObj);
        }
      }catch(_){}
      localStops.splice(i,1);
      await set(dbRef(db,`scenarios/${currentScenarioId}/stops`), localStops);
      renderThumbs();
    }

    async function loadForEditImpl(){
      try{
        editStatus.textContent='Loading…';
        const snap=await get(dbRef(db,'scenarios'));
        if(!snap.exists()){ scenarioList.innerHTML=''; editStatus.textContent='No scenarios found.'; return; }
        const arr=Object.entries(snap.val()||{}).map(([id,s])=>({id,...s})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        editStatus.textContent=`${arr.length} scenario(s)`;
        scenarioList.innerHTML='';
        arr.forEach(sc=>{
          const row=document.createElement('div'); row.className='listItem';
          const left=document.createElement('div');
          left.innerHTML = `<div style="font-weight:800">${sc.title||'(untitled)'}</div>
                            <div class="tag">Stops: ${Array.isArray(sc.stops)? sc.stops.length : 0} • ${new Date(sc.createdAt||Date.now()).toLocaleString()}</div>`;
          const right=document.createElement('div');
          const open=document.createElement('button'); open.className='btn'; open.textContent='Open';
          open.onclick=async()=>{
            currentScenarioId=sc.id; localStops=Array.isArray(sc.stops)? sc.stops:[]; scenarioName.value=sc.title||''; dispatchInfo.value=sc.dispatch||'';
            uiHide(landing); uiHide(editPanel); uiShow(createPanel); renderThumbs(); saveSteps.textContent='Editing existing scenario.';
          };
          const toggle=document.createElement('button'); toggle.className='btn secondary'; toggle.style.marginLeft='8px'; toggle.textContent=sc.active?'Deactivate':'Activate';
          toggle.onclick=()=>update(dbRef(db,`scenarios/${sc.id}`),{active:!sc.active});
          const del=document.createElement('button'); del.className='btn danger'; del.style.marginLeft='8px'; del.textContent='Delete';
          del.onclick=async()=>{ if(!confirm('Delete this scenario?')) return;
            try{ await ensureAuthed(); }catch(_){}
            if(Array.isArray(sc.stops)){ for(const s of sc.stops){ try{
              const refObj = s?.gsUri ? stRef(storage,s.gsUri) : s?.storagePath ? stRef(storage,s.storagePath) : null; if(refObj) await deleteObject(refObj);
            }catch(_){}} }
            await set(dbRef(db,`scenarios/${sc.id}`), null); row.remove();
          };
          right.appendChild(open); right.appendChild(toggle); right.appendChild(del);
          row.appendChild(left); row.appendChild(right); scenarioList.appendChild(row);
        });
      }catch(e){ editStatus.textContent='Error: '+(e?.message||e); showErr(e?.message||String(e)); }
    }
    window.loadForEdit = loadForEditImpl;

  }catch(e){
    showErr('Firebase init failed: '+(e?.message||e));
  }
  </script>
</body>
</html>
