<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps / EMS — Scenario Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1624; --text:#eaf2ff; --muted:#94a3b8;
      --edge: rgba(255,255,255,.08); --edge2: rgba(255,255,255,.14);
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0f14,rgba(11,15,20,.8));border-bottom:1px solid var(--edge2);z-index:9}
    .wrap{max-width:920px;margin:0 auto;padding:12px}
    h1{font-size:20px;margin:6px 0 2px}
    .sub{color:var(--muted);font-size:12px}

    .status{display:flex;gap:8px;align-items:center;margin-top:8px}
    .pill{padding:4px 8px;border-radius:999px;background:var(--edge2);color:var(--muted);font-size:12px}
    .pill.good{background:rgba(34,197,94,.1);color:var(--ok)}
    .pill.warn{background:rgba(245,158,11,.08);color:var(--warn)}
    .pill.bad{background:rgba(239,68,68,.08);color:var(--err)}

    nav{display:flex;gap:8px;margin:12px 0 6px}
    .tab{border:1px solid var(--edge2);background:var(--panel);padding:8px 10px;border-radius:10px;cursor:pointer}
    .tab.active{outline:2px solid var(--accent);}

    .card{border:1px solid var(--edge2);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));padding:14px;border-radius:14px;box-shadow:0 0 0 1px var(--edge) inset}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input[type=text], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--edge2);background:#0c131f;color:var(--text)}
    textarea{min-height:80px;resize:vertical}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--edge2);background:#132031;color:var(--text);cursor:pointer}
    .btn.primary{background:#0f2a4a; border-color:#164777}
    .btn.red{background:#3b1111;border-color:#5a1a1a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .fine{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr} }

    .hidden{display:none!important}

    .toastz{position:fixed;right:10px;bottom:10px;display:flex;flex-direction:column;gap:8px;z-index:99}
    .toast{padding:10px 12px;background:#132031;border:1px solid var(--edge2);border-left:4px solid var(--edge2);border-radius:10px;max-width:72vw}
    .toast.ok{border-left-color:var(--ok)}
    .toast.err{border-left-color:var(--err)}
    .toast.warn{border-left-color:var(--warn)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}

    .uploader{border:1px dashed var(--edge2);border-radius:12px;padding:12px}
    .preview{display:flex;gap:10px;align-items:center}
    .preview img{max-width:120px;max-height:90px;border-radius:8px;border:1px solid var(--edge)}
    progress{width:100%;height:10px}
    .list{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .item{border:1px solid var(--edge2);border-radius:10px;padding:8px}
  </style>

  <!-- Firebase SDKs (compat for simplest drop-in) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- Optional: App Check (uncomment + configure if enforcement is ON)
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script>
  -->
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Scenario Admin</h1>
      <div class="sub">Create scenarios, upload photos, and edit details. Phone-friendly.</div>
      <div class="status">
        <div id="stBoot" class="pill warn">booting…</div>
        <div id="stFB" class="pill">firebase</div>
        <div id="stAuth" class="pill">auth</div>
        <div id="stReady" class="pill">ready</div>
      </div>
      <nav>
        <button id="tabCreate" class="tab active">Create</button>
        <button id="tabEdit" class="tab">Edit / Upload</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- CREATE -->
    <section id="paneCreate" class="card">
      <h2 style="margin-top:6px">Create Scenario</h2>
      <div class="grid">
        <div>
          <label>Title</label>
          <input id="cTitle" type="text" placeholder="Example: MVC on County Rd 25" />
        </div>
        <div>
          <label>Description (optional)</label>
          <input id="cDesc" type="text" placeholder="Short note or goal for this scenario" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="createBtn" class="btn primary">Create</button>
        <span id="createStatus" class="fine"></span>
      </div>
      <div class="fine mono" style="margin-top:10px">
        Writes to Realtime DB at <b>/scenarios/{id}</b>. Requires Anonymous Auth enabled and DB rules allowing authenticated writes.
      </div>
    </section>

    <!-- EDIT -->
    <section id="paneEdit" class="card hidden">
      <h2 style="margin-top:6px">Edit Scenario & Photos</h2>

      <div class="grid">
        <div>
          <label>Select Scenario</label>
          <div class="row" style="align-items:center">
            <select id="eSelect"></select>
            <button id="refreshList" class="btn">Refresh</button>
          </div>
        </div>
        <div>
          <label>Quick Actions</label>
          <div class="row">
            <button id="btnDeleteScenario" class="btn red">Delete Scenario</button>
            <button id="btnOpenCreate" class="btn">New Scenario</button>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>Title</label>
          <input id="eTitle" type="text" placeholder="Scenario title" />
        </div>
        <div>
          <label>Description</label>
          <input id="eDesc" type="text" placeholder="Scenario description" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveMeta" class="btn primary">Save Details</button>
        <span id="metaStatus" class="fine"></span>
      </div>

      <hr style="margin:16px 0;border-color:var(--edge2)">

      <div class="uploader">
        <label>Upload Photo (downscales on device for speed)</label>
        <div class="row" style="align-items:flex-start">
          <input id="file" type="file" accept="image/*" capture="environment" class="btn" />
          <div class="preview">
            <img id="thumb" alt="" class="hidden">
            <div class="fine" id="imgInfo"></div>
          </div>
        </div>
        <div style="margin-top:8px">
          <progress id="prog" max="100" value="0" class="hidden"></progress>
          <div id="upStatus" class="fine"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="uploadBtn" class="btn primary" disabled>Save Photo</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Photos in Scenario</label>
        <div id="photoList" class="list"></div>
      </div>

      <div class="fine mono" style="margin-top:10px">
        Upload path: <b>storage: scenarios/{scenarioId}/{photoId}.jpg</b> and DB at <b>/scenarios/{scenarioId}/photos/{photoId}</b>.
      </div>
    </section>
  </main>

  <div class="toastz" id="toasts"></div>

  <script>
  // ---------- Small helpers ----------
  const $ = (id)=>document.getElementById(id);
  const show = (el, on)=>{ if(typeof el==='string') el=$(el); el.classList.toggle('hidden',!on); }
  const setPill = (el, state, text) => {
    el.className = 'pill ' + (state||'');
    if(text) el.textContent = text;
  };
  const toast = (msg, type='warn', ms=3500)=>{
    const t = document.createElement('div');
    t.className = 'toast ' + (type||'warn');
    t.textContent = msg;
    $('toasts').appendChild(t);
    setTimeout(()=>t.remove(), ms);
  };
  const ok = (m)=>toast(m,'ok',2500);
  const err = (m)=>toast(m,'err',5000);
  const diag = (m)=>console.log('[admin]', m);

  const ROOT = '/scenarios';
  let app, auth, db, storage/*, appCheck*/;
  let currentScenario = null;
  let createdId = null;
  let _authReady = false;

  // ---------- Firebase init ----------
  setPill($('stBoot'),'warn','booting…');

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  try{
    app = firebase.initializeApp(firebaseConfig);
    // Optional App Check (uncomment if enforced)
    /*
    appCheck = firebase.appCheck();
    appCheck.activate('YOUR_RECAPTCHA_SITE_KEY', true); // true = auto-token refresh
    */
    auth = firebase.auth();
    db = firebase.database();
    storage = firebase.storage();
    setPill($('stFB'),'good','firebase ok');
  }catch(e){
    setPill($('stFB'),'bad','firebase error');
    err('Firebase init failed: ' + (e.message||e));
  }

  // Anonymous auth (required for writes)
  function ensureAuthed(){
    if(_authReady && auth.currentUser) return Promise.resolve(auth.currentUser);
    return new Promise(function(resolve,reject){
      const unsub = auth.onAuthStateChanged(function(u){
        if(u){ _authReady = true; setPill($('stAuth'),'good','authed'); setPill($('stReady'),'good','ready'); unsub(); resolve(u); }
      });
      auth.signInAnonymously().catch(function(e){
        setPill($('stAuth'),'bad','auth error');
        reject(e);
      });
    });
  }

  // ---------- Tabs ----------
  function activate(tab){
    $('tabCreate').classList.toggle('active', tab==='create');
    $('tabEdit').classList.toggle('active', tab==='edit');
    show('paneCreate', tab==='create');
    show('paneEdit', tab==='edit');
  }
  $('tabCreate').onclick = ()=>activate('create');
  $('tabEdit').onclick = ()=>{
    activate('edit');
    // Always refresh scenarios when opening Edit
    ensureAuthed().then(safeLoadScenarios).catch(e=>err('Load failed: ' + (e.message||e)));
  };

  $('btnOpenCreate').onclick = ()=>{ activate('create'); };

  // ---------- Create Scenario ----------
  $('createBtn').onclick = function(){
    $('createBtn').disabled = true;
    $('createStatus').textContent = 'Creating…';
    ensureAuthed()
      .then(function(){
        const title = ($('cTitle').value||'').trim() || '(untitled)';
        const desc  = ($('cDesc').value||'').trim() || '';
        const ref   = db.ref(ROOT).push();
        const id    = ref.key;
        return ref.set({ id, title, description: desc, createdAt: Date.now(), active:true, photos:{} })
          .then(function(){
            createdId = id;
            ok('Scenario created');
            $('createStatus').textContent = 'Created ✓';
            // Jump to edit and prefill
            return safeLoadScenarios().then(function(){
              activate('edit');
              $('eSelect').value = id;
              $('eTitle').value = title;
              $('eDesc').value = desc;
              currentScenario = id;
              renderScenarioPhotos(id);
            });
          });
      })
      .catch(function(e){
        const msg = (e && (e.code||e.message)) || String(e);
        if(String(msg).includes('operation-not-allowed')){
          err('Anonymous Auth disabled. Enable in Firebase Auth → Sign-in method → Anonymous.');
        }else if(String(msg).includes('PERMISSION_DENIED')){
          err('DB rules block writes to "/scenarios".');
        }else{
          err('Create failed: ' + msg);
        }
      })
      .finally(function(){
        $('createBtn').disabled = false;
      });
  };

  // ---------- Edit: load list, save meta, delete ----------
  function safeLoadScenarios(){
    return db.ref(ROOT).orderByChild('createdAt').limitToLast(500).get().then(function(snap){
      const sel = $('eSelect');
      sel.innerHTML = '';
      const list = [];
      snap.forEach(ch=>list.push(ch.val()));
      list.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
      if(!list.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='(no scenarios)'; sel.appendChild(opt); currentScenario=null; return; }
      list.forEach(sc=>{
        const opt=document.createElement('option');
        opt.value=sc.id; opt.textContent=sc.title || ('(untitled) '+sc.id);
        sel.appendChild(opt);
      });
      // Keep selection if possible
      const keep = currentScenario || (createdId) || (list[list.length-1].id);
      sel.value = keep;
      currentScenario = sel.value || null;
      // Fill meta fields
      const sc = list.find(x=>x.id===currentScenario) || {};
      $('eTitle').value = sc.title || '';
      $('eDesc').value  = sc.description || '';
      renderScenarioPhotos(currentScenario);
    });
  }

  $('refreshList').onclick = ()=> ensureAuthed().then(safeLoadScenarios);

  $('eSelect').onchange = function(){
    currentScenario = this.value || null;
    renderScenarioPhotos(currentScenario);
  };

  $('saveMeta').onclick = function(){
    if(!currentScenario){ err('No scenario selected'); return; }
    $('saveMeta').disabled = true;
    $('metaStatus').textContent = 'Saving…';
    const title = ($('eTitle').value||'').trim() || '(untitled)';
    const desc  = ($('eDesc').value||'').trim() || '';
    db.ref(`${ROOT}/${currentScenario}`).update({ title, description: desc })
      .then(()=>{ ok('Saved'); $('metaStatus').textContent = 'Saved ✓'; })
      .catch(e=>err('Save failed: ' + (e.message||e)))
      .finally(()=>{ $('saveMeta').disabled = false; });
  };

  $('btnDeleteScenario').onclick = function(){
    if(!currentScenario){ err('No scenario selected'); return; }
    if(!confirm('Delete this scenario and all its photos?')) return;
    const id = currentScenario;
    $('btnDeleteScenario').disabled = true;
    // Delete DB branch then attempt storage folder cleanup (best-effort: list by prefix)
    db.ref(`${ROOT}/${id}`).remove()
      .then(function(){
        // Try to delete storage files under scenarios/{id}/
        const prefix = `scenarios/${id}/`;
        storage.ref().child(prefix).listAll().then(res=>{
          const del = [];
          res.items.forEach(it=>del.push(it.delete().catch(()=>{})));
          return Promise.all(del);
        }).catch(()=>{}); // ignore listing errors
        ok('Scenario deleted');
        currentScenario = null;
        return safeLoadScenarios();
      })
      .catch(e=>err('Delete failed: ' + (e.message||e)))
      .finally(()=>{ $('btnDeleteScenario').disabled = false; });
  };

  // ---------- Photo handling ----------
  const MAX_DIM = 1600;   // downscale longer side for speed/storage
  const JPEG_Q  = 0.82;

  let pendingBlob = null;
  let pendingMeta = null;

  $('file').onchange = async function(){
    resetUploadUI();
    const f = this.files && this.files[0];
    if(!f){ return; }
    try{
      const {blob, w, h, type} = await downscaleImageFile(f, MAX_DIM, JPEG_Q);
      pendingBlob = blob;
      pendingMeta = {contentType: type||'image/jpeg'};
      $('thumb').src = URL.createObjectURL(blob);
      show('thumb', true);
      $('imgInfo').textContent = `${w}×${h} (compressed) • ${(blob.size/1024/1024).toFixed(2)} MB`;
      $('uploadBtn').disabled = !currentScenario;
      if(!currentScenario){ err('Select a scenario first.'); }
    }catch(e){
      err('Could not read image: ' + (e.message||e));
      pendingBlob = null; pendingMeta=null;
    }
  };

  $('uploadBtn').onclick = function(){
    if(!currentScenario){ err('Select a scenario first'); return; }
    if(!pendingBlob){ err('Choose a photo first'); return; }
    $('uploadBtn').disabled = true;
    $('upStatus').textContent = 'Uploading…';
    show('prog', true); $('prog').value = 0;

    const photoId = db.ref().push().key;
    const path = `scenarios/${currentScenario}/${photoId}.jpg`;
    const ref  = storage.ref().child(path);

    uploadWithProgress(ref, pendingBlob, pendingMeta, function(pct){
      $('prog').value = pct;
      $('upStatus').textContent = `Uploading… ${pct}%`;
    }).then(function(){
      return ref.getDownloadURL().then(function(url){
        const rec = { id: photoId, path, url, uploadedAt: Date.now() };
        return db.ref(`${ROOT}/${currentScenario}/photos/${photoId}`).set(rec).then(function(){
          ok('Photo saved');
          resetUploadUI();
          renderScenarioPhotos(currentScenario);
        });
      });
    }).catch(function(e){
      const msg = (e && (e.code||e.message)) || String(e);
      if(String(msg).includes('app-check') || String(msg).includes('blocked by AppCheck')){
        err('Blocked by App Check enforcement (enable App Check in this page or disable enforcement while testing).');
      }else if(String(msg).includes('unauthorized')){
        err('Storage rules rejected the write. Ensure authenticated write is allowed for "scenarios/**".');
      }else{
        err('Upload failed: ' + msg);
      }
    }).finally(function(){
      $('uploadBtn').disabled = false;
    });
  };

  function resetUploadUI(){
    show('prog', false); $('prog').value = 0;
    $('upStatus').textContent = '';
    $('imgInfo').textContent = '';
    $('thumb').src = ''; show('thumb', false);
  }

  function renderScenarioPhotos(id){
    const box = $('photoList');
    box.innerHTML = '';
    if(!id){ return; }
    db.ref(`${ROOT}/${id}/photos`).get().then(function(snap){
      if(!snap.exists()){ box.innerHTML = '<div class="fine">(no photos yet)</div>'; return; }
      const all = snap.val()||{};
      const arr = Object.values(all).sort((a,b)=>(a.uploadedAt||0)-(b.uploadedAt||0));
      arr.forEach(p=>{
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div class="row" style="align-items:center">
            <img src="${p.url}" alt="" style="max-width:100px;max-height:80px;border-radius:8px;border:1px solid var(--edge)" />
            <div class="fine mono" style="flex:1;word-break:break-all">${p.path}</div>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn red" data-del="${p.id}">Delete</button>
            <a class="btn" href="${p.url}" target="_blank" rel="noopener">Open</a>
          </div>
        `;
        box.appendChild(div);
      });
      // wire deletes
      box.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = function(){
          const pid = this.getAttribute('data-del');
          if(!confirm('Delete this photo?')) return;
          const path = `scenarios/${id}/${pid}.jpg`;
          storage.ref().child(path).delete().catch(()=>{});
          db.ref(`${ROOT}/${id}/photos/${pid}`).remove().then(()=>{
            ok('Photo deleted');
            renderScenarioPhotos(id);
          });
        };
      });
    });
  }

  // Upload with 120s timeout + progress
  function uploadWithProgress(storageRef, blob, metadata, onProgress){
    return new Promise(function(resolve,reject){
      const task = storageRef.put(blob, metadata);
      const killer = setTimeout(function(){ try{ task.cancel(); }catch(e){} reject(new Error('Timed out while uploading')); }, 120000);
      task.on('state_changed',
        function(s){ try{ if (onProgress){ onProgress(Math.round((s.bytesTransferred/s.totalBytes)*100)); } }catch(_){ }
        , function(e){ clearTimeout(killer); reject(e); }
        , function(){ clearTimeout(killer); resolve(); }
      );
    });
  }

  // Downscale image file to max dimension, return blob+size
  function downscaleImageFile(file, maxDim, quality){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = function(ev){
        const img = new Image();
        img.onload = function(){
          let {width:w, height:h} = img;
          const scale = Math.min(1, maxDim / Math.max(w,h));
          const outW = Math.round(w*scale), outH = Math.round(h*scale);
          const canvas = document.createElement('canvas');
          canvas.width = outW; canvas.height = outH;
          const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
          ctx.drawImage(img, 0, 0, outW, outH);
          canvas.toBlob(function(blob){
            if(!blob) return reject(new Error('Canvas toBlob failed'));
            resolve({blob, w:outW, h:outH, type: 'image/jpeg'});
          }, 'image/jpeg', quality||0.82);
        };
        img.onerror = ()=>reject(new Error('Invalid image'));
        img.src = ev.target.result;
      };
      reader.onerror = ()=>reject(new Error('Read failed'));
      reader.readAsDataURL(file);
    });
  }

  // ---------- Kick off ----------
  window.addEventListener('load', function(){
    setPill($('stBoot'),'good','booted');
    // Initial auth + prime UI
    ensureAuthed().then(()=>{
      // land on Create; user can switch
      activate('create');
    }).catch(e=>{
      err('Auth failed: ' + (e.message||e));
    });
  });
  </script>
</body>
</html>
