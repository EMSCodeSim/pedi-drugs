<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FireOps SIM ‚Äî Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{
  --bg:#0b0f14; --bg2:#0e1421; --card:#0f1624; --edge:rgba(255,255,255,.10);
  --text:#eaf2ff; --muted:#93a0b5; --blue:#0a84ff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
    radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
    linear-gradient(165deg, var(--bg2), var(--bg) 55%);
}
.topbar{position:sticky;top:0;z-index:20;background:rgba(12,15,22,.78);backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
.topnav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
.brand{font-weight:900}
.spacer{flex:1}
.btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#142238,#0f1930);color:#fff;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:var(--muted)}
.small{font-size:12px;opacity:.9}
hr{border:none;height:1px;background:rgba(255,255,255,.08);margin:12px 0}

main{max-width:1200px;margin:16px auto 40px;padding:0 16px;display:grid;grid-template-columns:340px 1fr;gap:12px}
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px;min-height:120px}
label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
.input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff}
textarea{min-height:80px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(120px,1fr));gap:10px}
.thumb{width:100%;height:90px;object-fit:cover;border-radius:10px;background:#0a1a2a;border:1px solid rgba(255,255,255,.14)}
.visually-hidden{position:absolute !important;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}

/* toasts */
#errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#okbar{position:fixed;left:10px;bottom:56px;background:#0f2a19;color:#d8ffe2;border:1px solid #2c7a4b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}

/* lightweight loader only for init/DB saves */
#loader{position:fixed;inset:0;display:none;place-items:center;z-index:99;background:rgba(6,12,20,.55);backdrop-filter:blur(2px)}
.spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* modal */
#photoModal{position:fixed;inset:0;display:none;place-items:center;z-index:999;background:rgba(5,10,18,.6);backdrop-filter:blur(2px)}
.modal-card{width:min(760px,96vw);background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px}
.modal-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modal-body{display:grid;grid-template-columns:220px 1fr;gap:12px}
.modal-body img{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);aspect-ratio:4/3;object-fit:cover}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
<div id="errbar"></div><div id="okbar"></div>
<div id="loader"><div class="spinner"></div></div>

<div class="topbar">
  <div class="topnav">
    <div class="brand">FireOps SIM ‚Äî Admin</div>
    <div class="spacer"></div>
    <button id="showCreate" class="btn">Create Scenario</button>
    <button id="showEdit" class="btn">Edit Scenario</button>
    <a class="btn" href="./advanced-editor.html">Open Advanced Editor</a>
  </div>
</div>

<main>
  <!-- LEFT: Create -->
  <section class="card" id="createPane">
    <h3>Create Scenario</h3>
    <label>Title</label>
    <input id="cTitle" class="input" placeholder="e.g., Apartment Fire ‚Äî 5th St" />
    <label>Description</label>
    <textarea id="cDesc" placeholder="Short description‚Ä¶"></textarea>
    <div class="row">
      <button id="createBtn" class="btn">Create</button>
      <span id="createStatus" class="tag">Ready</span>
    </div>
    <hr />
    <h4>Add Photos (auto GPS)</h4>

    <!-- iPhone-safe pickers -->
    <input id="cFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="cFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="cFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="cFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>
    <div class="small" style="margin:6px 0">Photos are resized to max <b>1600px</b> (thumbs <b>480px</b>).</div>
    <div id="cUploads" class="grid"></div>
  </section>

  <!-- RIGHT: Edit -->
  <section class="card" id="editPane" style="display:none">
    <h3>Edit Scenario</h3>
    <label>Select a scenario</label>
    <select id="eSelect"><option value="">Loading‚Ä¶</option></select>
    <div class="row" style="margin-top:6px">
      <button id="refreshBtn" class="btn">Refresh</button>
      <span id="eStatus" class="tag">‚Äî</span>
    </div>

    <hr />
    <div class="row" style="margin-top:6px">
      <div style="flex:1">
        <label>Title</label>
        <input id="eTitle" class="input" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="saveMeta" class="btn">Save Scenario</button>
      </div>
    </div>
    <label>Description</label>
    <textarea id="eDesc"></textarea>

    <hr />
    <h4>Add Photos (auto GPS)</h4>
    <input id="eFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="eFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="eFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="eFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <div id="eUploads" class="grid" style="margin-top:8px"></div>

    <hr />
    <h4>Existing Stops</h4>
    <div id="stopsGrid" class="grid"></div>
  </section>

  <!-- DIAGNOSTICS -->
  <section class="card" id="diagPane">
    <h3>Diagnostics</h3>
    <div class="row">
      <button id="diagAuth" class="btn">Check Auth</button>
      <button id="diagStorage" class="btn">Test Storage Write</button>
      <button id="diagDB" class="btn">Test DB Write</button>
    </div>
    <pre id="diagOut" class="small" style="margin-top:8px; white-space:pre-wrap"></pre>
  </section>
</main>

<!-- Photo editor modal -->
<div id="photoModal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="brand">Edit Photo</div>
      <div class="spacer"></div>
      <button id="pmClose" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <img id="pmPreview" src="" alt="preview"/>
      <div>
        <label>Title</label>
        <input id="pmTitle" class="input" />
        <label>Caption / Notes</label>
        <textarea id="pmCaption"></textarea>
        <div class="row">
          <div style="flex:1">
            <label>Latitude</label>
            <input id="pmLat" class="input" placeholder="e.g. 39.7392" />
          </div>
          <div style="flex:1">
            <label>Longitude</label>
            <input id="pmLng" class="input" placeholder="-104.9903" />
          </div>
        </div>
        <div class="row">
          <button id="pmUseMyLoc" class="btn">Use My Location</button>
          <span id="pmGpsStatus" class="tag">‚Äî</span>
        </div>
        <label>Radius (meters)</label>
        <input id="pmRadius" class="input" type="number" min="1" step="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="pmSave" class="btn">Save Photo</button>
    </div>
  </div>
</div>

<script type="module">
/* ---------------- UI helpers ---------------- */
const $ = (id)=>document.getElementById(id);
const show = (id, on)=>{ const el=$(id); if (el) el.style.display = on ? '' : 'none'; };
const ok = (m)=>{ const b=$('okbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 2600); };
const err= (m)=>{ const b=$('errbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 6000); };
const loading = (on)=>{ const l=$('loader'); if(l) l.style.display = on ? 'grid' : 'none'; };
function logDiag(...args){
  const out = $('diagOut');
  const line = args.map(a => (typeof a==='object'? JSON.stringify(a,null,2) : String(a))).join(' ');
  console.log('[DIAG]', ...args);
  if (out) out.textContent += line + '\n';
}

/* pane toggles */
if ($('showCreate')) $('showCreate').onclick = ()=>{ show('createPane',true); show('editPane',false); };
if ($('showEdit'))   $('showEdit').onclick   = ()=>{ show('createPane',false); show('editPane',true); };

/* ---------------- Firebase imports ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref as dbRef, set, push, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged,
  setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain:"dailyquiz-d5279.firebaseapp.com",
  databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId:"dailyquiz-d5279",
  storageBucket:"dailyquiz-d5279.firebasestorage.app",  // console shows this; we normalize for gs:// below
  appId:"1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId:"G-19DVN7NNH7"
};

const appFB = initializeApp(firebaseConfig);

/* ‚úÖ Normalize bucket for gs:// (writes must use *.appspot.com) */
let bucketName = (firebaseConfig.storageBucket || `${firebaseConfig.projectId}.appspot.com`)
  .replace('.firebasestorage.app', '.appspot.com');
const storage = getStorage(appFB, `gs://${bucketName}`);

const db = getDatabase(appFB);
const auth = getAuth(appFB);

/* ---------------- Auth (iOS Private Browsing safe) ---------------- */
async function initAuth(){
  try{ await setPersistence(auth, browserLocalPersistence); }
  catch{ try{ await setPersistence(auth, browserSessionPersistence); }
  catch{ await setPersistence(auth, inMemoryPersistence); } }
  if (!auth.currentUser) await signInAnonymously(auth);
  await new Promise(res => onAuthStateChanged(auth, u => u && res(), { once:true }));
}
async function ensureAuthed(){ if (!auth.currentUser) await initAuth(); return auth.currentUser; }

/* ---------------- Data helpers ---------------- */
const ROOT='scenarios';
let scenarios=[]; let createdId=null;

function coerceStops(sc){
  if (Array.isArray(sc?.stops)) return sc.stops;
  if (Array.isArray(sc?.photos)) return sc.photos;
  if (Array.isArray(sc?.images)) return sc.images;
  return [];
}
function setStops(sc, stops){
  if (Array.isArray(sc?.stops)) sc.stops = stops;
  else if (Array.isArray(sc?.photos)) sc.photos = stops;
  else if (Array.isArray(sc?.images)) sc.images = stops;
  else sc.stops = stops;
}
function populateEditList(){
  const sel=$('eSelect'); if(!sel) return;
  sel.innerHTML='<option value="">Select‚Ä¶</option>';
  scenarios.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=(s.title||'(untitled)') + (s.active?'':' (inactive)');
    sel.appendChild(o);
  });
}
async function safeLoadScenarios(){
  try{
    const snap = await get(dbRef(db, ROOT));
    const obj = snap.exists() ? (snap.val()||{}) : {};
    scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    populateEditList();
    const cur = $('eSelect').value; if (cur) renderScenario(cur);
    $('eStatus').textContent='Loaded';
  }catch(e){
    console.warn('loadScenarios failed:', e);
    $('eStatus').textContent='Load failed';
  }
}

/* ---------------- Image helpers (no OffscreenCanvas / no createImageBitmap) ---------------- */
const ORIG_MAX_EDGE = 1600, THUMB_MAX_EDGE = 480, JPEG_QUALITY = 0.82, MAX_PIXELS = 4_000_000;

async function decodeToImage(file){
  try{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.src = url;
    await img.decode();
    URL.revokeObjectURL(url);
    return img;
  }catch{ return null; }
}
function scaleByMaxEdgeOrPixels(w,h){
  const edgeScale = Math.min(1, ORIG_MAX_EDGE / Math.max(w,h));
  const pixScale = Math.min(1, Math.sqrt(MAX_PIXELS / Math.max(1, w*h)));
  const s = Math.min(edgeScale, pixScale);
  return { w: Math.max(1, Math.round(w*s)), h: Math.max(1, Math.round(h*s)) };
}
async function canvasToBlob(img, targetEdge){
  const dims = (targetEdge === ORIG_MAX_EDGE)
    ? scaleByMaxEdgeOrPixels(img.naturalWidth || img.width, img.naturalHeight || img.height)
    : (()=>{ const s = Math.min(1, targetEdge / Math.max(img.naturalWidth||img.width, img.naturalHeight||img.height));
             return { w: Math.round((img.naturalWidth||img.width)*s), h: Math.round((img.naturalHeight||img.height)*s) }; })();
  const c = document.createElement('canvas'); c.width = dims.w; c.height = dims.h;
  const ctx = c.getContext('2d', { alpha:false, desynchronized:true });
  ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(img, 0, 0, dims.w, dims.h);
  const blob = await new Promise(res=>c.toBlob(res, 'image/jpeg', JPEG_QUALITY));
  return { blob, width:dims.w, height:dims.h };
}

/* ---------------- Geolocation (soft timeout; non-blocking) ---------------- */
function softCoords(timeoutMs=1200){
  return new Promise((resolve)=>{
    let done=false;
    const finish=(v)=>{ if(!done){ done=true; resolve(v); } };
    if (!('geolocation' in navigator)) return finish(null);
    navigator.geolocation.getCurrentPosition(
      pos => finish({ lat:+pos.coords.latitude.toFixed(6), lng:+pos.coords.longitude.toFixed(6), accuracy:pos.coords.accuracy }),
      _ => finish(null),
      { enableHighAccuracy:true, maximumAge:60000, timeout:timeoutMs }
    );
    setTimeout(()=>finish(null), timeoutMs); // soft race timeout
  });
}

/* ---------------- Upload flow (sequential, resumable, yields to UI) ---------------- */
async function processFilesForScenario(files, scenarioId, uploadsContainerId){
  if (!files?.length) return;
  await ensureAuthed();

  // soft-start GPS
  const gpsPromise = softCoords(1200);

  for (const file of files){
    await new Promise(r=>setTimeout(r,0)); // allow UI to breathe

    const card = document.createElement('div');
    const tag = document.createElement('div');
    tag.className = 'tag small';
    tag.textContent = 'Preparing‚Ä¶';
    card.appendChild(tag);
    $(uploadsContainerId).prepend(card);
    const status = (t)=>{ tag.textContent=t; };

    try{
      let img = await decodeToImage(file);
      let fullBlob, thumbBlob, width=0, height=0, usedOriginal=false;

      if (img){
        status('Resizing‚Ä¶');
        const full = await canvasToBlob(img, ORIG_MAX_EDGE);
        fullBlob = full.blob; width = full.width; height = full.height;
        const thumb = await canvasToBlob(img, THUMB_MAX_EDGE);
        thumbBlob = thumb.blob;
      } else {
        status('Using original (no decode)‚Ä¶');
        fullBlob = file; usedOriginal = true;
        try{
          const previewImg = await decodeToImage(file);
          if (previewImg){
            const t = await canvasToBlob(previewImg, THUMB_MAX_EDGE);
            thumbBlob = t.blob;
          }
        }catch{}
      }

      const coords = await Promise.race([gpsPromise, Promise.resolve(null)]);
      const ts = Date.now();
      const extByType = (t)=> {
        if (!t) return '.bin';
        const lt = t.toLowerCase();
        if (lt.includes('jpeg') || lt.includes('jpg')) return '.jpg';
        if (lt.includes('png')) return '.png';
        if (lt.includes('heic') || lt.includes('heif')) return '.heic';
        if (lt.includes('webp')) return '.webp';
        return '.bin';
      };
      const basePath = `scenarios/${scenarioId}/${ts}`;
      const fullRef  = stRef(storage, `${basePath}${usedOriginal ? extByType(file.type) : '.jpg'}`);
      const thumbRef = stRef(storage, `scenarios/${scenarioId}/thumbs/${ts}.jpg`);
      const metaFull = { contentType: usedOriginal ? (file.type || 'application/octet-stream') : 'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };
      const metaThmb = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };

      status('Uploading 0%‚Ä¶');
      await new Promise((resolve, reject)=>{
        const task = uploadBytesResumable(fullRef, fullBlob, metaFull);
        task.on('state_changed',
          s=>{ const pct = Math.round((s.bytesTransferred/s.totalBytes)*100); status(`Uploading ${pct}%‚Ä¶`); },
          err2=>reject(err2),
          ()=>resolve()
        );
      });

      if (thumbBlob){
        await new Promise((resolve, reject)=>{
          const t2 = uploadBytesResumable(thumbRef, thumbBlob, metaThmb);
          t2.on('state_changed', null, reject, resolve);
        });
      }

      status('Finalizing‚Ä¶');
      const imageURL = await getDownloadURL(fullRef);
      const thumbURL = thumbBlob ? await getDownloadURL(thumbRef) : imageURL;

      status('Saving‚Ä¶');
      const snap = await get(dbRef(db, `${ROOT}/${scenarioId}`));
      const sc = snap.val();
      const stops = coerceStops(sc);
      stops.push({
        type:'photo', title:'', caption:'',
        lat: coords?.lat ?? null, lng: coords?.lng ?? null, locAccuracy: coords?.accuracy ?? null,
        radiusMeters:50,
        imageURL, thumbURL,
        storagePath: fullRef.fullPath, thumbPath: thumbBlob ? thumbRef.fullPath : null,
        gsUri:`gs://${bucketName}/${fullRef.fullPath}`,
        width, height, overlays:[]
      });
      setStops(sc, stops);
      await set(dbRef(db, `${ROOT}/${scenarioId}`), sc);

      status(coords ? 'Uploaded ‚úì (GPS set)' : 'Uploaded ‚úì');
    }catch(ex){
      const code = ex?.code || '';
      const msg  = ex?.message || String(ex);
      console.error('UPLOAD ERROR:', ex);
      logDiag('UPLOAD ERROR code:', code, 'message:', msg);
      logDiag('Expected bucket:', `gs://${bucketName}`);
      if (code.includes('unauthorized') || code.includes('permission') || msg.includes('PERMISSION_DENIED')){
        err('Upload failed: permission denied. Open Diagnostics ‚Üí Test Storage/DB for exact error.');
      } else {
        err('Upload failed: ' + (code || msg));
      }
      status('Failed');
    }
  }

  ok('Photos processed.');
}

/* ---------------- Render & edit ---------------- */
function renderScenario(id){
  const s = scenarios.find(x=>x.id===id);
  if (!s){ $('eStatus').textContent='Not found'; $('stopsGrid').innerHTML=''; return; }
  $('eTitle').value = s.title||'';
  $('eDesc').value  = s.description||'';
  $('eStatus').textContent = `${(s._stops||[]).length} photo(s)`;
  const grid = $('stopsGrid'); grid.innerHTML='';
  if (!s._stops?.length){ grid.innerHTML='<div class="small tag">No photos yet</div>'; return; }

  s._stops.forEach((st, idx)=>{
    const el = document.createElement('div');
    const thumb = st.thumbURL || st.imageURL || '';
    const hasGPS = (st.lat!=null && st.lng!=null);
    el.innerHTML = `
      <img class="thumb" src="${thumb}" alt="thumb" />
      <div class="small" style="margin-top:6px">${st.title||('Stop '+(idx+1))}</div>
      <div class="row" style="margin-top:6px">
        <span class="tag small">${hasGPS ? 'GPS ‚úì' : 'GPS ‚Äî'}</span>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" data-edit="${idx}">Edit</button>
        <button class="btn" data-gps="${idx}">Set GPS</button>
        <button class="btn" data-del="${idx}" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
      </div>
    `;

    el.querySelector('[data-del]').onclick = async ()=>{
      try{
        loading(true);
        await ensureAuthed();
        const snap = await get(dbRef(db, `${ROOT}/${id}`));
        const sc = snap.val(); const arr = coerceStops(sc);
        arr.splice(idx,1); setStops(sc, arr);
        await set(dbRef(db, `${ROOT}/${id}`), sc);
        ok('Stop deleted');
        await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
      }catch(e){ err('Delete failed: '+(e.message||e)); }
      finally{ loading(false); }
    };

    el.querySelector('[data-gps]').onclick = async ()=>{
      const coords = await softCoords(2000);
      if (!coords){ err('Could not get GPS (permission/signal).'); return; }
      try{
        loading(true);
        await ensureAuthed();
        const snap = await get(dbRef(db, `${ROOT}/${id}`));
        const sc = snap.val(); const arr = coerceStops(sc);
        if (!arr[idx]) return;
        arr[idx].lat = coords.lat; arr[idx].lng = coords.lng; arr[idx].locAccuracy = coords.accuracy ?? null;
        setStops(sc, arr);
        await set(dbRef(db, `${ROOT}/${id}`), sc);
        ok('GPS saved');
        await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
      }catch(e){ err('Save GPS failed: '+(e.message||e)); }
      finally{ loading(false); }
    };

    el.querySelector('[data-edit]').onclick = ()=> openPhotoEditor(id, idx);

    grid.appendChild(el);
  });
}

/* ---------------- Create / Edit wiring ---------------- */
if ($('createBtn')) $('createBtn').onclick = async ()=>{
  try{
    await ensureAuthed();
    loading(true);
    const title = $('cTitle').value.trim() || '(untitled)';
    const desc  = $('cDesc').value.trim() || '';
    $('createBtn').disabled = true; $('createStatus').textContent='Creating‚Ä¶';
    const id = (push(dbRef(db, ROOT))).key;
    const rec = { id, title, description: desc, createdAt: Date.now(), active:true, stops: [] };
    await set(dbRef(db, `${ROOT}/${id}`), rec);
    createdId = id;
    $('createStatus').textContent='Created ‚úì';
    ok('Scenario created');
    await safeLoadScenarios();
    $('showEdit').click();
    $('eSelect').value = id;
    $('eTitle').value  = title;
    $('eDesc').value   = desc;
    renderScenario(id);
  }catch(e){
    const msg = e?.code || e?.message || e;
    if (String(msg).includes('PERMISSION_DENIED')) {
      err('Create failed: DB rules block writes to "/scenarios". Enable auth writes.');
    } else {
      err('Create failed: ' + msg);
    }
  }finally{
    $('createBtn').disabled = false; loading(false);
  }
};

if ($('refreshBtn')) $('refreshBtn').onclick = async ()=>{ await ensureAuthed(); await safeLoadScenarios(); };
if ($('eSelect')) $('eSelect').onchange = ()=>{ const id=$('eSelect').value; if (id) renderScenario(id); };

if ($('saveMeta')) $('saveMeta').onclick = async ()=>{
  try{
    await ensureAuthed();
    const id=$('eSelect').value; if(!id) return;
    loading(true);
    const snap = await get(dbRef(db, `${ROOT}/${id}`));
    const sc = snap.val()||{};
    sc.title = $('eTitle').value.trim()||'(untitled)';
    sc.description = $('eDesc').value.trim()||'';
    await set(dbRef(db, `${ROOT}/${id}`), sc);
    ok('Scenario saved');
    await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
  }catch(e){
    const msg = e?.code || e?.message || e;
    if (String(msg).includes('PERMISSION_DENIED')) {
      err('Save failed: DB rules block writes to "/scenarios".');
    } else { err('Save failed: '+msg); }
  }finally{ loading(false); }
};

/* ---------------- File input listeners ---------------- */
if ($('cFilesCam')) $('cFilesCam').addEventListener('change', async (e)=>{
  if (!createdId){ err('Create a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), createdId, 'cUploads');
  e.target.value='';
});
if ($('cFilesLib')) $('cFilesLib').addEventListener('change', async (e)=>{
  if (!createdId){ err('Create a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), createdId, 'cUploads');
  e.target.value='';
});
if ($('eFilesCam')) $('eFilesCam').addEventListener('change', async (e)=>{
  const id=$('eSelect').value; if(!id){ err('Select a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), id, 'eUploads');
  await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
  e.target.value='';
});
if ($('eFilesLib')) $('eFilesLib').addEventListener('change', async (e)=>{
  const id=$('eSelect').value; if(!id){ err('Select a scenario first.'); e.target.value=''; return; }
  await processFilesForScenario(Array.from(e.target.files||[]), id, 'eUploads');
  await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
  e.target.value='';
});

/* ---------------- Photo editor modal ---------------- */
let pmCtx = { scenarioId:null, index:-1 };
function openPhotoEditor(scenarioId, index){
  pmCtx = { scenarioId, index };
  const s = scenarios.find(x=>x.id===scenarioId); if(!s) return;
  const st = (s._stops||[])[index]; if(!st) return;
  $('pmPreview').src = st.imageURL || st.thumbURL || '';
  $('pmTitle').value = st.title || '';
  $('pmCaption').value = st.caption || '';
  $('pmLat').value = (st.lat ?? '').toString();
  $('pmLng').value = (st.lng ?? '').toString();
  $('pmRadius').value = (st.radiusMeters ?? 50);
  $('pmGpsStatus').textContent = (st.lat!=null && st.lng!=null) ? 'GPS ‚úì' : 'GPS ‚Äî';
  $('photoModal').style.display = 'grid';
}
if ($('pmClose')) $('pmClose').onclick = ()=>{ $('photoModal').style.display='none'; };
if ($('pmUseMyLoc')) $('pmUseMyLoc').onclick = async ()=>{
  $('pmGpsStatus').textContent = 'Getting GPS‚Ä¶';
  const coords = await softCoords(2000);
  if (!coords){ $('pmGpsStatus').textContent='GPS failed'; err('Could not get GPS.'); return; }
  $('pmLat').value = coords.lat; $('pmLng').value = coords.lng; $('pmGpsStatus').textContent = 'GPS ‚úì';
};
if ($('pmSave')) $('pmSave').onclick = async ()=>{
  const { scenarioId, index } = pmCtx; if (!scenarioId || index<0) return;
  try{
    loading(true);
    await ensureAuthed();
    const snap = await get(dbRef(db, `${ROOT}/${scenarioId}`));
    const sc = snap.val(); const arr = coerceStops(sc);
    const st = arr[index]; if (!st) throw new Error('Photo not found');
    st.title = $('pmTitle').value.trim();
    st.caption = $('pmCaption').value.trim();
    const lat = $('pmLat').value.trim(); const lng = $('pmLng').value.trim();
    st.lat = lat==='' ? null : Number(lat);
    st.lng = lng==='' ? null : Number(lng);
    st.radiusMeters = Math.max(1, parseInt(($('pmRadius').value||'50'),10));
    setStops(sc, arr);
    await set(dbRef(db, `${ROOT}/${scenarioId}`), sc);
    ok('Photo saved');
    $('photoModal').style.display='none';
    await safeLoadScenarios(); $('eSelect').value=scenarioId; renderScenario(scenarioId);
  }catch(e){
    const msg = e?.code || e?.message || e;
    if (String(msg).includes('PERMISSION_DENIED')) {
      err('Save photo failed: DB rules block writes to "/scenarios".');
    } else { err('Save photo failed: '+msg); }
  }finally{ loading(false); }
};

/* ---------------- Diagnostics buttons ---------------- */
async function makeTinyJPEG(){
  const c = document.createElement('canvas'); c.width=2; c.height=2;
  const ctx = c.getContext('2d'); ctx.fillStyle = '#888'; ctx.fillRect(0,0,2,2);
  return await new Promise(res=>c.toBlob(res,'image/jpeg',0.7));
}
if ($('diagAuth')) $('diagAuth').onclick = async ()=>{
  try{ const u = await ensureAuthed(); logDiag('Auth OK. uid:', u?.uid || '(none)'); }
  catch(e){ logDiag('Auth FAILED:', e?.code || e?.message || String(e)); }
};
if ($('diagStorage')) $('diagStorage').onclick = async ()=>{
  try{
    const u = await ensureAuthed(); logDiag('User uid:', u?.uid || '(none)');
    const ts = Date.now(); const testPath = `scenarios/__diag__/ping-${ts}.jpg`;
    const blob = await makeTinyJPEG();
    const ref1 = stRef(storage, testPath);
    logDiag('Bucket target:', `gs://${bucketName}`);
    logDiag('Uploading:', testPath, 'contentType=image/jpeg');
    await new Promise((resolve, reject)=>{
      const task = uploadBytesResumable(ref1, blob, { contentType:'image/jpeg' });
      task.on('state_changed', null, reject, resolve);
    });
    const url = await getDownloadURL(ref1);
    logDiag('Storage WRITE OK. URL:', url);
  }catch(e){
    logDiag('Storage WRITE FAILED:', e?.code || e?.message || String(e));
    logDiag('Hint: ensure rules allow image/* under /scenarios/** and bucket is appspot.com');
  }
};
if ($('diagDB')) $('diagDB').onclick = async ()=>{
  try{
    const u = await ensureAuthed();
    const id = `__diag__-${Date.now()}`;
    await set(dbRef(db, `${ROOT}/${id}`), { id, createdAt: Date.now(), title:'__diag__', stops:[] });
    logDiag('DB WRITE OK at:', `${ROOT}/${id}`);
  }catch(e){
    logDiag('DB WRITE FAILED:', e?.code || e?.message || String(e));
    logDiag('Hint: DB rules must allow auth writes to /scenarios/**');
  }
};

/* ---------------- Init (auth first, then subscribe) ---------------- */
(async function init(){
  try{
    loading(true);
    await ensureAuthed();
    onValue(dbRef(db, ROOT), snap=>{
      const obj=snap.val()||{};
      scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                  .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      populateEditList();
      const cur = $('eSelect').value;
      if (cur) renderScenario(cur);
    });
    await safeLoadScenarios();
  }catch(e){
    err('Startup failed: '+(e?.message||e));
  }finally{
    loading(false);
  }
})();
</script>
</body>
</html>
