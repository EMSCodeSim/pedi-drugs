<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FireOps SIM ‚Äî Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{
  --bg:#0b0f14; --bg2:#0e1421; --card:#0f1624; --edge:rgba(255,255,255,.10);
  --text:#eaf2ff; --muted:#93a0b5;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
    radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
    linear-gradient(165deg, var(--bg2), var(--bg) 55%);
}
.topbar{position:sticky;top:0;z-index:20;background:rgba(12,15,22,.78);backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
.topnav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
.brand{font-weight:900}
.spacer{flex:1}
.btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#142238,#0f1930);color:#fff;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:var(--muted)}
.small{font-size:12px;opacity:.9}
hr{border:none;height:1px;background:rgba(255,255,255,.08);margin:12px 0}
main{max-width:1200px;margin:16px auto 40px;padding:0 16px;display:grid;grid-template-columns:340px 1fr;gap:12px}
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px;min-height:120px}
label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
.input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff}
textarea{min-height:80px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px,1fr));gap:10px}
.thumb{width:100%;height:110px;object-fit:cover;border-radius:10px;background:#0a1a2a;border:1px solid rgba(255,255,255,.14)}
.visually-hidden{position:absolute; left:-9999px; top:auto; width:0.1px; height:0.1px; opacity:0; overflow:hidden; z-index:-1}
#errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#okbar{position:fixed;left:10px;bottom:56px;background:#0f2a19;color:#d8ffe2;border:1px solid #2c7a4b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;max-width:90vw}
#loader{position:fixed;inset:0;display:none;place-items:center;z-index:99;background:rgba(6,12,20,.55);backdrop-filter:blur(2px)}
.spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#photoModal{position:fixed;inset:0;display:none;place-items:center;z-index:999;background:rgba(5,10,18,.6);backdrop-filter:blur(2px)}
.modal-card{width:min(760px,96vw);background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px}
.modal-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modal-body{display:grid;grid-template-columns:220px 1fr;gap:12px}
.modal-body img{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);aspect-ratio:4/3;object-fit:cover}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
<div id="errbar"></div><div id="okbar"></div>
<div id="loader"><div class="spinner"></div></div>

<div class="topbar">
  <div class="topnav">
    <div class="brand">FireOps SIM ‚Äî Admin</div>
    <div class="spacer"></div>
    <button id="showCreate" class="btn">Create Scenario</button>
    <button id="showEdit" class="btn">Edit Scenario</button>
    <a class="btn" href="./advanced-editor.html">Open Advanced Editor</a>
  </div>
</div>

<main>
  <!-- LEFT: Create -->
  <section class="card" id="createPane">
    <h3>Create Scenario</h3>
    <label>Title</label>
    <input id="cTitle" class="input" placeholder="e.g., Apartment Fire ‚Äî 5th St" />
    <label>Description</label>
    <textarea id="cDesc" placeholder="Short description‚Ä¶"></textarea>
    <div class="row">
      <button id="createBtn" class="btn">Create</button>
      <span id="createStatus" class="tag">Ready</span>
    </div>

    <hr />
    <h4>Add Photos (preview first, GPS on save)</h4>
    <input id="cFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="cFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="cFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="cFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <h4 style="margin-top:12px">Review (not saved yet)</h4>
    <div class="small">Tap <b>Save</b> on a photo (or <b>Save All</b>) to upload to the cloud.</div>
    <div class="row" style="margin:8px 0">
      <button id="cSaveAll" class="btn" disabled>Save All to Cloud</button>
      <button id="cClear" class="btn" disabled>Clear</button>
    </div>
    <div id="cPending" class="grid"></div>

    <hr />
    <h4>Uploaded Thumbs</h4>
    <div id="cUploads" class="grid"></div>
  </section>

  <!-- RIGHT: Edit -->
  <section class="card" id="editPane" style="display:none">
    <h3>Edit Scenario</h3>
    <label>Select a scenario</label>
    <select id="eSelect"><option value="">Loading‚Ä¶</option></select>
    <div class="row" style="margin-top:6px">
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="deleteScenario" class="btn" style="background:#2a0f14;border-color:#7a2b2b">Delete Scenario</button>
      <span id="eStatus" class="tag">‚Äî</span>
    </div>

    <hr />
    <div class="row" style="margin-top:6px">
      <div style="flex:1">
        <label>Title</label>
        <input id="eTitle" class="input" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="saveMeta" class="btn">Save Scenario</button>
      </div>
    </div>
    <label>Description</label>
    <textarea id="eDesc"></textarea>

    <hr />
    <h4>Add Photos (preview first, GPS on save)</h4>
    <input id="eFilesCam" class="visually-hidden" type="file" accept="image/*" capture="environment" multiple />
    <input id="eFilesLib" class="visually-hidden" type="file" accept="image/*" multiple />
    <div class="row">
      <label for="eFilesCam" class="btn">üì∑ Take Photo</label>
      <label for="eFilesLib" class="btn">üñºÔ∏è Choose from Library</label>
    </div>

    <h4 style="margin-top:12px">Review (not saved yet)</h4>
    <div class="small">Tap <b>Save</b> to upload. Use <b>Use My Location</b> to attach GPS before saving.</div>
    <div class="row" style="margin:8px 0">
      <button id="eSaveAll" class="btn" disabled>Save All to Cloud</button>
      <button id="eClear" class="btn" disabled>Clear</button>
    </div>
    <div id="ePending" class="grid"></div>

    <hr />
    <h4>Uploaded Thumbs</h4>
    <div id="eUploads" class="grid" style="margin-top:8px"></div>

    <hr />
    <h4>Existing Stops</h4>
    <div id="stopsGrid" class="grid"></div>
  </section>
</main>

<!-- Photo editor modal -->
<div id="photoModal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="brand">Edit Photo</div>
      <div class="spacer"></div>
      <button id="pmClose" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <img id="pmPreview" src="" alt="preview"/>
      <div>
        <label>Title</label>
        <input id="pmTitle" class="input" />
        <label>Caption / Notes</label>
        <textarea id="pmCaption"></textarea>
        <div class="row">
          <div style="flex:1">
            <label>Latitude</label>
            <input id="pmLat" class="input" placeholder="e.g. 39.7392" />
          </div>
          <div style="flex:1">
            <label>Longitude</label>
            <input id="pmLng" class="input" placeholder="-104.9903" />
          </div>
        </div>
        <div class="row">
          <button id="pmUseMyLoc" class="btn">Use My Location</button>
          <span id="pmGpsStatus" class="tag">‚Äî</span>
        </div>
        <label>Radius (meters)</label>
        <input id="pmRadius" class="input" type="number" min="1" step="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="pmSave" class="btn">Save Photo</button>
    </div>
  </div>
</div>

<script type="module">
/* -------- iOS safety & error surfacing -------- */
window.onerror = (m,src,lin,col,err)=>{ const b=document.getElementById('errbar'); if(b){ b.textContent = 'Script error: '+(err?.message||m); b.style.display='block'; } document.getElementById('loader').style.display='none'; };
window.onunhandledrejection = (e)=>{ const b=document.getElementById('errbar'); if(b){ b.textContent = 'Unhandled: '+(e.reason?.message||String(e.reason||e)); b.style.display='block'; } document.getElementById('loader').style.display='none'; };
if (!HTMLCanvasElement.prototype.toBlob) {
  HTMLCanvasElement.prototype.toBlob = function (cb, type, quality) {
    const bin = atob(this.toDataURL(type, quality).split(',')[1]);
    const len = bin.length, u8 = new Uint8Array(len);
    for (let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
    cb(new Blob([u8], { type: type || 'image/png' }));
  };
}

/* ---------------- UI helpers ---------------- */
const $ = (id)=>document.getElementById(id);
const show = (id, on)=>{ const el=$(id); if (el) el.style.display = on ? '' : 'none'; };
const ok = (m)=>{ const b=$('okbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 2600); };
const err= (m)=>{ const b=$('errbar'); if(!b) return; b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 6000); };
const loading = (on)=>{ const l=$('loader'); if(l) l.style.display = on ? 'grid' : 'none'; };
function logDiag(...args){ console.log('[DIAG]', ...args); }

/* pane toggles */
if ($('showCreate')) $('showCreate').onclick = ()=>{ show('createPane',true); show('editPane',false); };
if ($('showEdit'))   $('showEdit').onclick   = ()=>{ show('createPane',false); show('editPane',true); };

/* ---------------- Firebase imports ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref as dbRef, set, push, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as stRef, uploadBytesResumable, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged,
  setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain:"dailyquiz-d5279.firebaseapp.com",
  databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId:"dailyquiz-d5279",
  storageBucket:"dailyquiz-d5279.firebasestorage.app",
  appId:"1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId:"G-19DVN7NNH7"
};
const appFB = initializeApp(firebaseConfig);

/* ‚úÖ Force actual bucket (writes) */
const FORCE_BUCKET = "dailyquiz-d5279.appspot.com";
const storage = getStorage(appFB, `gs://${FORCE_BUCKET}`);

const db = getDatabase(appFB);
const auth = getAuth(appFB);

/* ---------------- Auth (no top-level await) ---------------- */
async function initAuth(){
  try{ await setPersistence(auth, browserLocalPersistence); }
  catch{ try{ await setPersistence(auth, browserSessionPersistence); }
  catch{ await setPersistence(auth, inMemoryPersistence); } }
  if (!auth.currentUser) await signInAnonymously(auth);
  await new Promise(res => onAuthStateChanged(auth, u => u && res()));
}
async function ensureAuthed(){ if (!auth.currentUser) await initAuth(); return auth.currentUser; }

/* ---------------- Data helpers ---------------- */
const ROOT='scenarios';
let scenarios=[]; let createdId=null;

function coerceStops(sc){
  if (Array.isArray(sc?.stops)) return sc.stops;
  if (Array.isArray(sc?.photos)) return sc.photos;
  if (Array.isArray(sc?.images)) return sc.images;
  return [];
}
function setStops(sc, stops){
  if (Array.isArray(sc?.stops)) sc.stops = stops;
  else if (Array.isArray(sc?.photos)) sc.photos = stops;
  else if (Array.isArray(sc?.images)) sc.images = stops;
  else sc.stops = stops;
}
function populateEditList(){
  const sel=$('eSelect'); if(!sel) return;
  sel.innerHTML='<option value="">Select‚Ä¶</option>';
  scenarios.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=(s.title||'(untitled)') + (s.active?'':' (inactive)');
    sel.appendChild(o);
  });
}
async function safeLoadScenarios(){
  try{
    const snap = await get(dbRef(db, ROOT));
    const obj = snap.exists() ? (snap.val()||{}) : {};
    scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    populateEditList();
    const cur = $('eSelect').value; if (cur) renderScenario(cur);
    $('eStatus').textContent='Loaded';
  }catch(e){
    console.warn('loadScenarios failed:', e);
    $('eStatus').textContent='Load failed';
  }
}

/* ---------------- Image helpers ---------------- */
const ORIG_MAX_EDGE = 1600, THUMB_MAX_EDGE = 480, JPEG_QUALITY = 0.82, MAX_PIXELS = 4_000_000;

async function decodeToImage(file){
  try{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.src = url;
    await img.decode();
    return { img, url };
  }catch{
    try{ const url = URL.createObjectURL(file); return { img:null, url }; }
    catch{ return { img:null, url:null }; }
  }
}
function scaleByMaxEdgeOrPixels(w,h){
  const edgeScale = Math.min(1, ORIG_MAX_EDGE / Math.max(w,h));
  const pixScale = Math.min(1, Math.sqrt(MAX_PIXELS / Math.max(1, w*h)));
  const s = Math.min(edgeScale, pixScale);
  return { w: Math.max(1, Math.round(w*s)), h: Math.max(1, Math.round(h*s)) };
}
async function canvasToBlob(nativeImg, targetEdge){
  const w = nativeImg.naturalWidth || nativeImg.width;
  const h = nativeImg.naturalHeight || nativeImg.height;
  const dims = (targetEdge === ORIG_MAX_EDGE)
    ? scaleByMaxEdgeOrPixels(w,h)
    : (()=>{ const s = Math.min(1, targetEdge / Math.max(w,h)); return { w:Math.round(w*s), h:Math.round(h*s) }; })();
  const c = document.createElement('canvas'); c.width = dims.w; c.height = dims.h;
  const ctx = c.getContext('2d', { alpha:false, desynchronized:true });
  ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(nativeImg, 0, 0, dims.w, dims.h);
  const blob = await new Promise(res=>c.toBlob(res, 'image/jpeg', JPEG_QUALITY));
  const dataURL = c.toDataURL('image/jpeg', JPEG_QUALITY);
  return { blob, dataURL, width:dims.w, height:dims.h };
}

/* ---------------- DataURL / Blob utils ---------------- */
function dataURLtoBlob(dataURL){
  const [head,b64] = dataURL.split(',');
  const mime = (/data:(.*?);base64/.exec(head)||[, 'application/octet-stream'])[1];
  const bin = atob(b64); const len = bin.length; const buf = new Uint8Array(len);
  for (let i=0;i<len;i++) buf[i] = bin.charCodeAt(i);
  return new Blob([buf], { type:mime });
}
function dataURLFromStored(stored){
  return typeof stored==='string'
    ? stored
    : (stored && stored.data ? `data:image/${stored.format||'jpeg'};base64,${stored.data}` : '');
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* ---------------- Geolocation (soft timeout; non-blocking) ---------------- */
function softCoords(timeoutMs=1200){
  return new Promise((resolve)=>{
    let done=false;
    const finish=(v)=>{ if(!done){ done=true; resolve(v); } };
    if (!('geolocation' in navigator)) return finish(null);
    navigator.geolocation.getCurrentPosition(
      pos => finish({ lat:+pos.coords.latitude.toFixed(6), lng:+pos.coords.longitude.toFixed(6), accuracy:pos.coords.accuracy }),
      _ => finish(null),
      { enableHighAccuracy:true, maximumAge:60000, timeout:timeoutMs }
    );
    setTimeout(()=>finish(null), timeoutMs);
  });
}

/* ---------------- Pending review lists ---------------- */
let pendingCreate = []; // {file,url,title,caption,lat,lng}
let pendingEdit   = [];

function enablePendingButtons(scope){
  const has = (scope==='c') ? pendingCreate.length>0 : pendingEdit.length>0;
  $(`${scope}SaveAll`).disabled = !has;
  $(`${scope}Clear`).disabled   = !has;
}
function addPending(files, scope){
  const list = (scope==='c') ? pendingCreate : pendingEdit;
  for (const f of files){
    list.push({ file:f, url:null, title:'', caption:'', lat:null, lng:null });
  }
  renderPending(scope);
}
async function renderPending(scope){
  const list = (scope==='c') ? pendingCreate : pendingEdit;
  const container = $(`${scope}Pending`);
  container.innerHTML='';
  list.forEach((p, i)=>{
    if (!p.url){ try{ p.url = URL.createObjectURL(p.file); }catch{ p.url=''; } }
    const card = document.createElement('div');
    card.className='pcard';
    card.style.cssText='padding:8px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:#0f1624';
    card.innerHTML=`
      <img class="thumb" src="${p.url}" alt="preview" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'tag small',textContent:'(Preview not supported)'}))" />
      <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
        <input class="input ptitle" placeholder="Optional title" value="${p.title || ''}">
        <input class="input pcaption" placeholder="Optional caption" value="${p.caption || ''}">
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <span class="tag small" data-status>Ready</span>
        <div class="row">
          <button class="btn" data-gps>Use My Location</button>
          <button class="btn" data-save>Save</button>
          <button class="btn" data-del style="background:#2a0f14;border-color:#7a2b2b">Discard</button>
        </div>
      </div>`;
    card.querySelector('.ptitle').oninput = e=>{ p.title=e.target.value; };
    card.querySelector('.pcaption').oninput = e=>{ p.caption=e.target.value; };
    card.querySelector('[data-del]').onclick = ()=>{
      try{ if (p.url) URL.revokeObjectURL(p.url); }catch{}
      list.splice(i,1); renderPending(scope); enablePendingButtons(scope);
    };
    card.querySelector('[data-gps]').onclick = async ()=>{
      const status = card.querySelector('[data-status]');
      status.textContent='Getting GPS‚Ä¶';
      const c = await softCoords(2000);
      if (c){ p.lat=c.lat; p.lng=c.lng; status.textContent='GPS ‚úì'; } else { status.textContent='GPS ‚Äî'; err('Could not get GPS.'); }
    };
    card.querySelector('[data-save]').onclick = ()=> saveOnePending(scope, i, card);
    container.appendChild(card);
  });
  enablePendingButtons(scope);
}

/* ---------------- Cloud Function fallback (server-side upload) ---------------- */
const FUNCTION_UPLOAD_URL = 'https://us-central1-dailyquiz-d5279.cloudfunctions.net/uploadScenarioImage';
async function uploadViaFunction(dataURL, scenarioId, fileName){
  const resp = await fetch(FUNCTION_UPLOAD_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ scenarioId, fileName, dataURL })
  });
  if (!resp.ok) {
    const txt = await resp.text();
    const e = new Error(`Function HTTP ${resp.status} ${txt}`); e.code='save/function-http'; throw e;
  }
  const json = await resp.json();
  if (!json.ok) {
    const e = new Error(`Function error: ${json.error||'unknown'}`); e.code='save/function-error'; throw e;
  }
  return { url: json.url, path: json.path, gsUri: json.gsUri, via:'function' };
}

/* ---------------- Upload helpers ---------------- */
function extFromType(t){
  if (!t) return '.jpg';
  const lt = t.toLowerCase();
  if (lt.includes('jpeg')||lt.includes('jpg')) return '.jpg';
  if (lt.includes('png')) return '.png';
  if (lt.includes('heic')||lt.includes('heif')) return '.heic';
  if (lt.includes('webp')) return '.webp';
  return '.jpg';
}
async function autoCreateIfNeeded(){
  if (createdId) return createdId;
  await ensureAuthed();
  const title = $('cTitle')?.value?.trim() || '(untitled)';
  const desc  = $('cDesc')?.value?.trim() || '';
  const id = (push(dbRef(db, ROOT))).key;
  await set(dbRef(db, `${ROOT}/${id}`), { id, title, description: desc, createdAt: Date.now(), active:true, stops: [] });
  createdId = id;
  ok('Scenario created');
  await safeLoadScenarios();
  $('showEdit').click();
  $('eSelect').value = id; $('eTitle').value = title; $('eDesc').value = desc;
  renderScenario(id);
  return id;
}
async function uploadWithTimeout(fullRef, blob, metadata, onProgress){
  return new Promise((resolve,reject)=>{
    const task = uploadBytesResumable(fullRef, blob, metadata);
    const killer = setTimeout(()=>{
      try{ task.cancel(); }catch{}
      reject(Object.assign(new Error('Timed out while uploading'), { code:'save/timeout-upload' }));
    }, 45000);
    task.on('state_changed',
      s=>{ if (onProgress) onProgress(Math.round((s.bytesTransferred/s.totalBytes)*100)); },
      e=>{ clearTimeout(killer); reject(e); },
      ()=>{ clearTimeout(killer); resolve(); }
    );
  });
}

/* ---------------- Save one / all (Storage ‚Üí Function ‚Üí Inline) ---------------- */
async function saveOnePending(scope, idx, cardEl){
  const list = (scope==='c') ? pendingCreate : pendingEdit;
  const p = list[idx]; if (!p) return;
  const status = cardEl.querySelector('[data-status]');

  let scenarioId = (scope==='c') ? await autoCreateIfNeeded() : $('eSelect').value;
  if (!scenarioId){ err('Select a scenario first.'); return; }

  try{
    await ensureAuthed();
    status.textContent='Preparing‚Ä¶';

    // Build JPEG blob + dataURL if possible; else use original file + dataURL.
    let usedOriginal=false, width=0, height=0, fullBlob=null, dataURL=null, thumbBlob=null;

    const preview = await decodeToImage(p.file);
    if (preview.img){
      const full = await canvasToBlob(preview.img, ORIG_MAX_EDGE);
      fullBlob = full.blob; dataURL = full.dataURL; width=full.width; height=full.height;
      const th   = await canvasToBlob(preview.img, THUMB_MAX_EDGE);
      thumbBlob = th.blob;
    }else{
      usedOriginal = true;
      fullBlob = p.file;
      dataURL = await fileToDataURL(p.file);
    }

    const coords = (p.lat!=null && p.lng!=null) ? {lat:p.lat,lng:p.lng} : await softCoords(1200);
    const ts = Date.now();
    const basePath = `scenarios/${scenarioId}/${ts}`;
    const ext = usedOriginal ? extFromType(p.file.type) : '.jpg';
    const fullRef  = stRef(storage, `${basePath}${ext}`);
    const thumbRef = stRef(storage, `scenarios/${scenarioId}/thumbs/${ts}.jpg`);
    const metaFull = { contentType: (usedOriginal && p.file.type) ? p.file.type : 'image/jpeg',  cacheControl:'public,max-age=31536000,immutable' };
    const metaThmb = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };

    // Try direct Storage (resumable) first
    status.textContent='Uploading 0%‚Ä¶';
    let cloud=null;
    try{
      await uploadWithTimeout(fullRef, fullBlob, metaFull, pct=>status.textContent=`Uploading ${pct}%‚Ä¶`);
      if (thumbBlob){
        try{ await uploadBytes(thumbRef, thumbBlob, metaThmb); }catch(e){ logDiag('Thumb upload failed (non-fatal):', e?.code||'', e?.message||''); }
      }
      const imageURL = await getDownloadURL(fullRef);
      let thumbURL = imageURL;
      if (thumbBlob){
        try{ thumbURL = await getDownloadURL(thumbRef); }catch{}
      }
      cloud = { url:imageURL, thumbURL, path:fullRef.fullPath, gsUri:`gs://${FORCE_BUCKET}/${fullRef.fullPath}`, via:'storage' };
    }catch(e1){
      // Fallback to Cloud Function
      status.textContent = `Direct upload failed (${e1.code||e1.message||'err'}). Trying server‚Ä¶`;
      try{
        const fileName = `${ts}.jpg`;
        const res = await uploadViaFunction(dataURL, scenarioId, fileName);
        cloud = { url:res.url, thumbURL:res.url, path:res.path, gsUri:res.gsUri, via:'function' };
      }catch(e2){
        // Final fallback: inline base64 in DB
        logDiag('Function upload failed:', e2?.code||'', e2?.message||'');
        cloud = null;
      }
    }

    // Build stop
    const stop = {
      type:'photo',
      title: p.title || '',
      caption: p.caption || '',
      lat: coords?.lat ?? null,
      lng: coords?.lng ?? null,
      radiusMeters:50,
      width, height, overlays:[]
    };
    if (cloud){
      stop.imageURL   = cloud.url;
      stop.thumbURL   = cloud.thumbURL || cloud.url;
      stop.storagePath= cloud.path;
      stop.gsUri      = cloud.gsUri;
    }else{
      stop.imageData = { format:'jpeg', data: (dataURL||'').split(',')[1] || '' };
    }

    status.textContent='Saving to DB‚Ä¶';
    const snap = await get(dbRef(db, `${ROOT}/${scenarioId}`));
    const sc = snap.val() || {};
    const stops = coerceStops(sc);
    stops.push(stop);
    setStops(sc, stops);
    await set(dbRef(db, `${ROOT}/${scenarioId}`), sc);

    status.textContent = cloud ? 'Saved ‚úì' : 'Saved inline ‚úì';
    ok(cloud ? 'Photo saved to cloud' : 'Photo saved (inline backup)');

    // show in uploaded thumbs area
    const uploads = document.getElementById(`${scope}Uploads`);
    if (uploads) {
      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = cloud ? (stop.thumbURL || stop.imageURL) : dataURLFromStored(stop.imageData);
      uploads.prepend(img);
    }

    // cleanup pending entry
    try{ if (p.url) URL.revokeObjectURL(p.url); }catch{}
    list.splice(idx,1);
    renderPending(scope);
    enablePendingButtons(scope);

    // refresh data so ‚ÄúExisting Stops‚Äù shows the new photo
    await safeLoadScenarios();
    const sel = document.getElementById('eSelect');
    if (sel) { sel.value = scenarioId; renderScenario(scenarioId); }

  }catch(ex){
    const code = ex?.code || '';
    const msg  = ex?.message || String(ex);
    if (/app.?check/i.test(msg)) err('Blocked by App Check enforcement. Add App Check or disable enforcement.');
    else if (code.includes('unauthorized') || /PERMISSION_DENIED/i.test(msg)) err('Permission denied saving photo. Check Storage/DB rules.');
    else err('Save failed: ' + (code || msg));
    status.textContent='Failed';
  }
}
async function saveAll(scope){
  const list = (scope==='c') ? pendingCreate : pendingEdit;
  for (let i=0; i<list.length; ){
    const card = $(`${scope}Pending`).children[i];
    await saveOnePending(scope, i, card);
    if ($(`${scope}Pending`).children[i] === card) i++;
  }
}

/* ---------------- Render & edit ---------------- */
function renderScenario(id){
  const s = scenarios.find(x=>x.id===id);
  if (!s){ $('eStatus').textContent='Not found'; $('stopsGrid').innerHTML=''; return; }
  $('eTitle').value = s.title||'';
  $('eDesc').value  = s.description||'';
  $('eStatus').textContent = `${(s._stops||[]).length} photo(s)`;
  const grid = $('stopsGrid'); grid.innerHTML='';
  if (!s._stops?.length){ grid.innerHTML='<div class="small tag">No photos yet</div>'; return; }

  s._stops.forEach((st, idx)=>{
    const thumb = st.thumbURL || st.imageURL || dataURLFromStored(st.imageData) || '';
    const hasGPS = (st.lat!=null && st.lng!=null);
    const el = document.createElement('div');
    el.innerHTML = `
      <img class="thumb" src="${thumb}" alt="thumb" />
      <div class="small" style="margin-top:6px">${st.title||('Stop '+(idx+1))}</div>
      <div class="row" style="margin-top:6px">
        <span class="tag small">${hasGPS ? 'GPS ‚úì' : 'GPS ‚Äî'}</span>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" data-edit="${idx}">Edit</button>
        <button class="btn" data-gps="${idx}">Set GPS</button>
        <button class="btn" data-del="${idx}" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
      </div>
    `;

    el.querySelector('[data-del]').onclick = async ()=>{
      try{
        loading(true);
        await ensureAuthed();
        const snap = await get(dbRef(db, `${ROOT}/${id}`));
        const sc = snap.val(); const arr = coerceStops(sc);
        const removed = arr.splice(idx,1)[0]; setStops(sc, arr);
        await set(dbRef(db, `${ROOT}/${id}`), sc);
        // best-effort delete storage files
        const paths = [removed?.storagePath, removed?.thumbPath, removed?.gsUri].filter(Boolean);
        for (const pth of paths){ try{ await deleteObject(stRef(storage, pth)); }catch{} }
        ok('Stop deleted');
        await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
      }catch(e){ err('Delete failed: '+(e.message||e)); }
      finally{ loading(false); }
    };

    el.querySelector('[data-gps]').onclick = async ()=>{
      const coords = await softCoords(2000);
      if (!coords){ err('Could not get GPS (permission/signal).'); return; }
      try{
        loading(true);
        await ensureAuthed();
        const snap = await get(dbRef(db, `${ROOT}/${id}`));
        const sc = snap.val(); const arr = coerceStops(sc);
        if (!arr[idx]) return;
        arr[idx].lat = coords.lat; arr[idx].lng = coords.lng; arr[idx].locAccuracy = coords.accuracy ?? null;
        setStops(sc, arr);
        await set(dbRef(db, `${ROOT}/${id}`), sc);
        ok('GPS saved');
        await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
      }catch(e){ err('Save GPS failed: '+(e.message||e)); }
      finally{ loading(false); }
    };

    el.querySelector('[data-edit]').onclick = ()=> openPhotoEditor(id, idx);
    grid.appendChild(el);
  });
}

/* ---------------- Create / Edit wiring ---------------- */
if ($('createBtn')) $('createBtn').onclick = async ()=>{
  try{
    await ensureAuthed();
    loading(true);
    const title = $('cTitle').value.trim() || '(untitled)';
    const desc  = $('cDesc').value.trim() || '';
    $('createBtn').disabled = true; $('createStatus').textContent='Creating‚Ä¶';
    const id = (push(dbRef(db, ROOT))).key;
    await set(dbRef(db, `${ROOT}/${id}`), { id, title, description: desc, createdAt: Date.now(), active:true, stops: [] });
    createdId = id;
    $('createStatus').textContent='Created ‚úì';
    ok('Scenario created');
    await safeLoadScenarios();
    $('showEdit').click();
    $('eSelect').value = id; $('eTitle').value = title; $('eDesc').value = desc;
    renderScenario(id);
  }catch(e){
    const msg = e?.code || e?.message || e;
    if (String(msg).includes('PERMISSION_DENIED')) err('Create failed: DB rules block writes to "/scenarios".');
    else err('Create failed: ' + msg);
  }finally{
    $('createBtn').disabled = false; loading(false);
  }
};

if ($('refreshBtn')) $('refreshBtn').onclick = async ()=>{ await ensureAuthed(); await safeLoadScenarios(); };
if ($('eSelect')) $('eSelect').onchange = ()=>{ const id=$('eSelect').value; if (id) renderScenario(id); };

if ($('saveMeta')) $('saveMeta').onclick = async ()=>{
  try{
    await ensureAuthed();
    const id=$('eSelect').value; if(!id) return;
    loading(true);
    const snap = await get(dbRef(db, `${ROOT}/${id}`));
    const sc = snap.val()||{};
    sc.title = $('eTitle').value.trim()||'(untitled)';
    sc.description = $('eDesc').value.trim()||'';
    await set(dbRef(db, `${ROOT}/${id}`), sc);
    ok('Scenario saved');
    await safeLoadScenarios(); $('eSelect').value=id; renderScenario(id);
  }catch(e){
    const msg = e?.code || e?.message || e;
    if (String(msg).includes('PERMISSION_DENIED')) err('Save failed: DB rules block writes to "/scenarios".');
    else err('Save failed: '+msg);
  }finally{ loading(false); }
};

/* ---- Delete Scenario (Edit pane) ---- */
if ($('deleteScenario')) $('deleteScenario').onclick = async ()=>{
  try{
    const id=$('eSelect').value; if(!id){ err('Select a scenario first.'); return; }
    const s = scenarios.find(x=>x.id===id);
    const go = confirm(`Delete scenario "${s?.title||id}" and its photos? This cannot be undone.`);
    if (!go) return;
    loading(true);
    await ensureAuthed();

    // best-effort delete storage files
    const paths = new Set();
    (s?._stops||[]).forEach(st=>{
      if (st.storagePath) paths.add(st.storagePath);
      if (st.thumbPath)   paths.add(st.thumbPath);
      if (st.gsUri)       paths.add(st.gsUri);
    });
    for (const p of paths){ try{ await deleteObject(stRef(storage, p)); }catch{} }

    // remove DB node
    await remove(dbRef(db, `${ROOT}/${id}`));
    ok('Scenario deleted');

    await safeLoadScenarios();
    $('eSelect').value='';
    $('stopsGrid').innerHTML='';
    $('eTitle').value=''; $('eDesc').value='';
    $('eStatus').textContent='‚Äî';
  }catch(e){
    err('Delete scenario failed: '+(e.message||e));
  }finally{
    loading(false);
  }
};

/* ---------------- File input listeners (preview-first) ---------------- */
function onFilesPicked(e, scope){
  const files = Array.from(e.target.files||[]);
  if (!files.length) return;
  addPending(files, scope);
  enablePendingButtons(scope);
  e.target.value=''; // reset
}
if ($('cFilesCam')) $('cFilesCam').addEventListener('change', (e)=>onFilesPicked(e,'c'));
if ($('cFilesLib')) $('cFilesLib').addEventListener('change', (e)=>onFilesPicked(e,'c'));
if ($('eFilesCam')) $('eFilesCam').addEventListener('change', (e)=>onFilesPicked(e,'e'));
if ($('eFilesLib')) $('eFilesLib').addEventListener('change', (e)=>onFilesPicked(e,'e'));

if ($('cSaveAll')) $('cSaveAll').onclick = ()=> saveAll('c');
if ($('eSaveAll')) $('eSaveAll').onclick = ()=> saveAll('e');
if ($('cClear')) $('cClear').onclick = ()=>{
  pendingCreate.forEach(p=>{try{ if(p.url) URL.revokeObjectURL(p.url);}catch{}});
  pendingCreate = []; renderPending('c'); enablePendingButtons('c');
};
if ($('eClear')) $('eClear').onclick = ()=>{
  pendingEdit.forEach(p=>{try{ if(p.url) URL.revokeObjectURL(p.url);}catch{}});
  pendingEdit = []; renderPending('e'); enablePendingButtons('e');
};

/* ---------------- Photo editor modal ---------------- */
let pmCtx = { scenarioId:null, index:-1 };
function openPhotoEditor(scenarioId, index){
  pmCtx = { scenarioId, index };
  const s = scenarios.find(x=>x.id===scenarioId); if(!s) return;
  const st = (s._stops||[])[index]; if(!st) return;
  $('pmPreview').src = st.imageURL || st.thumbURL || dataURLFromStored(st.imageData) || '';
  $('pmTitle').value = st.title || '';
  $('pmCaption').value = st.caption || '';
  $('pmLat').value = (st.lat ?? '').toString();
  $('pmLng').value = (st.lng ?? '').toString();
  $('pmRadius').value = (st.radiusMeters ?? 50);
  $('pmGpsStatus').textContent = (st.lat!=null && st.lng!=null) ? 'GPS ‚úì' : 'GPS ‚Äî';
  $('photoModal').style.display = 'grid';
}
if ($('pmClose')) $('pmClose').onclick = ()=>{ $('photoModal').style.display='none'; };
if ($('pmUseMyLoc')) $('pmUseMyLoc').onclick = async ()=>{
  $('pmGpsStatus').textContent = 'Getting GPS‚Ä¶';
  const coords = await softCoords(2000);
  if (!coords){ $('pmGpsStatus').textContent='GPS failed'; err('Could not get GPS.'); return; }
  $('pmLat').value = coords.lat; $('pmLng').value = coords.lng; $('pmGpsStatus').textContent = 'GPS ‚úì';
};
if ($('pmSave')) $('pmSave').onclick = async ()=>{
  const { scenarioId, index } = pmCtx; if (!scenarioId || index<0) return;
  try{
    loading(true);
    await ensureAuthed();
    const snap = await get(dbRef(db, `${ROOT}/${scenarioId}`));
    const sc = snap.val(); const arr = coerceStops(sc);
    const st = arr[index]; if (!st) throw new Error('Photo not found');
    st.title = $('pmTitle').value.trim();
    st.caption = $('pmCaption').value.trim();
    const lat = $('pmLat').value.trim(); const lng = $('pmLng').value.trim();
    st.lat = lat==='' ? null : Number(lat);
    st.lng = lng==='' ? null : Number(lng);
    st.radiusMeters = Math.max(1, parseInt(($('pmRadius').value||'50'),10));
    setStops(sc, arr);
    await set(dbRef(db, `${ROOT}/${scenarioId}`), sc);
    ok('Photo saved');
    $('photoModal').style.display='none';
    await safeLoadScenarios(); $('eSelect').value=scenarioId; renderScenario(scenarioId);
  }catch(e){
    const msg = e?.code || e?.message || e;
    if (String(msg).includes('PERMISSION_DENIED')) {
      err('Save photo failed: DB rules block writes to "/scenarios".');
    } else { err('Save photo failed: '+msg); }
  }finally{ loading(false); }
};

/* ---------------- Init (no top-level await) ---------------- */
async function init(){
  try{
    loading(true);
    await ensureAuthed();
    onValue(dbRef(db, ROOT), snap=>{
      const obj=snap.val()||{};
      scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                  .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      populateEditList();
      const cur = $('eSelect').value;
      if (cur) renderScenario(cur);
    });
    await safeLoadScenarios();
  }catch(e){
    err('Startup failed: '+(e?.message||e));
  }finally{
    loading(false);
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
