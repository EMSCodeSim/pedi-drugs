<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FireOps SIM — Admin (Editor-style Cloud Save)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b0f14">
  <style>
    :root{--bg:#0b0f14;--bg2:#0d121c;--panel:#0f1624;--text:#eaf2ff;--muted:#94a3b8;--edge:rgba(255,255,255,.12);--edge2:rgba(255,255,255,.18)}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 15% -10%, rgba(10,132,255,.25), transparent 60%),
                 radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.17), transparent 60%),
                 linear-gradient(165deg,var(--bg2),var(--bg) 55%)}
    header{position:sticky;top:0;z-index:10;background:rgba(12,15,22,.78);backdrop-filter:blur(8px);border-bottom:1px solid var(--edge2)}
    .bar{max-width:1100px;margin:0 auto;padding:12px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:900}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--edge2);background:linear-gradient(180deg,#122036,#0f1a2e);color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:linear-gradient(180deg,#0f1a2e,#0d1627)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
    @media(min-width:900px){main{grid-template-columns:1.15fr .85fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 26%),linear-gradient(180deg,#0e1524,#0e131e);
      border:1px solid var(--edge);border-radius:18px;padding:14px}
    label{font-weight:700}
    .input,textarea{width:100%;padding:10px 12px;border-radius:12px;background:#0c1322;color:#eaf2ff;border:1px solid var(--edge2)}
    textarea{min-height:86px}
    .status{margin-top:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--edge2);background:rgba(255,255,255,.04);font-size:13px}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumbWrap{position:relative;border:1px solid var(--edge2);border-radius:12px;overflow:hidden;background:#0e1624}
    .thumb{width:100%}
    .del{position:absolute;right:8px;bottom:8px}
    .tag{color:var(--muted);font-size:12px}
    #errbar{position:fixed;left:12px;bottom:12px;z-index:99;display:none;padding:10px 12px;border-radius:12px;border:1px solid #7a2b2b;background:#2b0d0d;color:#ffd7d7}
    #loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,12,20,.55);backdrop-filter:blur(2px);z-index:99}
    .spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="errbar"></div>
  <div id="loader"><div class="spinner"></div></div>

  <header>
    <div class="bar">
      <div class="brand">FireOps SIM — Admin</div>
      <div class="spacer"></div>
      <span id="authPill" class="tag">Auth: connecting…</span>
      <span id="env" class="tag"></span>
    </div>
  </header>

  <main>
    <!-- Create / Add Photo -->
    <section class="card">
      <h3 style="margin:0">Create Scenario</h3>
      <div class="tag">Writes to <code>scenarios/**</code> and <code>geophoto/scenarios/**</code>. Photos go to <code>scenarios/&lt;id&gt;/&lt;ts&gt;.jpg</code>.</div>

      <div style="margin-top:10px">
        <label>Scenario Name</label>
        <input class="input" id="scenarioName" placeholder="e.g., House Fire — Elm St.">
      </div>
      <div style="margin-top:10px">
        <label>Dispatch (optional)</label>
        <textarea id="dispatchInfo" placeholder="Engine 1, Engine 2, Medic 1…"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="createNow">Create Scenario</button>
        <span id="createStatus" class="tag">idle</span>
      </div>

      <hr style="border-color:rgba(255,255,255,.08)">

      <div style="margin-top:6px">
        <label>Add Photo Stop</label>
        <input type="file" id="photoInput" accept="image/*" capture="environment">
      </div>
      <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:8px">
        <div><label>Caption (optional)</label><input class="input" id="caption" placeholder="e.g., Alpha side"></div>
        <div><label>Radius (m)</label><input class="input" id="radius" type="number" min="5" max="1000" value="50"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="savePhoto">Save Photo</button>
        <span id="saveStatus" class="tag">waiting</span>
      </div>

      <div id="steps" class="status">—</div>
      <div class="thumbs" id="thumbs" style="margin-top:10px"></div>
    </section>

    <!-- Existing scenarios -->
    <section class="card">
      <h3 style="margin:0">Existing</h3>
      <div id="listStatus" class="tag">Loading…</div>
      <div id="scenarioList" style="margin-top:8px"></div>
    </section>
  </main>

  <!-- Firebase (modules, same family as Advanced Editor) -->
  <script type="module">
    const $=id=>document.getElementById(id);
    const showErr=m=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; };
    const showLoad=on=>{ $('loader').style.display=on?'grid':'none'; };
    const setStep=m=>{ $('steps').textContent=m; };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref as dbRef, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getStorage, ref as stRef, uploadBytesResumable, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    /* ---- Config (bucket forced to appspot) ---- */
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);
    const FORCE_BUCKET = "dailyquiz-d5279.appspot.com";
    const storage = getStorage(appFB, `gs://${FORCE_BUCKET}`);
    const auth = getAuth(appFB);
    $('env').textContent = `DB ok • Bucket: ${FORCE_BUCKET}`;

    /* ---- Auth: same robust flow as Advanced Editor ---- */
    async function ensureAuthed(){
      try{ await setPersistence(auth, browserLocalPersistence); }
      catch{ try{ await setPersistence(auth, browserSessionPersistence); }
      catch{ await setPersistence(auth, inMemoryPersistence); } }
      if (!auth.currentUser){
        await signInAnonymously(auth);
        await new Promise(res=>{ const u=onAuthStateChanged(auth, x=>x && (u(), res())); });
      }
      $('authPill').textContent = `Auth: anon ✔ (${auth.currentUser.uid.slice(0,8)})`;
      return auth.currentUser;
    }
    async function getIdToken(force=false){
      try{ const u=auth.currentUser||await ensureAuthed(); return await u.getIdToken(force); }
      catch{return null;}
    }

    /* ---- Cloud Function fallback (with ID token) ---- */
    const FUNCTION_UPLOAD_URL = 'https://us-central1-dailyquiz-d5279.cloudfunctions.net/uploadScenarioImage';
    async function uploadViaFunction(dataURL, scenarioId, fileName){
      const idt = await getIdToken().catch(()=>null);
      const resp = await fetch(FUNCTION_UPLOAD_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(idt?{Authorization:`Bearer ${idt}`}:{}) },
        body: JSON.stringify({ scenarioId, fileName, dataURL })
      });
      if(!resp.ok){ throw new Error(`Function HTTP ${resp.status}`); }
      const j=await resp.json();
      if(!j.ok){ throw new Error(`Function error: ${j.error||'unknown'}`); }
      return { url:j.url, path:j.path, gsUri:j.gsUri, via:'function' };
    }

    /* ---- Image utilities (phone-friendly) ---- */
    const MAX_EDGE=1280, JPEG_Q=0.75, THUMB_EDGE=480;
    const readAsDataURL=f=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    const loadImage=src=>new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; });
    function toCanvas(img,max=MAX_EDGE){ const c=document.createElement('canvas'); const s=Math.min(1,max/Math.max(img.width,img.height)); c.width=Math.round(img.width*s); c.height=Math.round(img.height*s); c.getContext('2d').drawImage(img,0,0,c.width,c.height); return c; }
    const canvasToDataURL=c=>c.toDataURL('image/jpeg',JPEG_Q);
    function makeThumb(dataURL){ return new Promise(async res=>{ const i=new Image(); i.onload=()=>{ const s=Math.min(1,THUMB_EDGE/Math.max(i.width,i.height)); const c=document.createElement('canvas'); c.width=i.width*s; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); res(c.toDataURL('image/jpeg',0.8)); }; i.src=dataURL; }); }
    function dataURLtoBlob(u){ const [h,b64]=u.split(','); const mime=(/data:(.*?);base64/).exec(h)[1]; const bin=atob(b64), a=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) a[i]=bin.charCodeAt(i); return new Blob([a],{type:mime}); }
    function uploadWithTimeout(ref, blob, metadata){ return new Promise((resolve,reject)=>{ const t=uploadBytesResumable(ref,blob,metadata); const kill=setTimeout(()=>{ try{t.cancel();}catch{} reject(Object.assign(new Error('Timed out while uploading'),{code:'save/timeout-upload'})); },45000); t.on('state_changed', s=>{ $('saveStatus').textContent = `upload ${Math.round(100*s.bytesTransferred/s.totalBytes)}%`; }, e=>{ clearTimeout(kill); reject(e); }, ()=>{ clearTimeout(kill); resolve(); }); }); }

    /* ---- State ---- */
    let currentScenarioId=null, localStops=[];
    const scenarioName=$('scenarioName'), dispatchInfo=$('dispatchInfo');
    const photoInput=$('photoInput'), caption=$('caption'), radius=$('radius');
    const thumbs=$('thumbs'), scenarioList=$('scenarioList'), listStatus=$('listStatus');

    /* ---- DB helpers (mirror like viewer) ---- */
    function baseScenario(id){
      const dispatch=(dispatchInfo?.value||'').trim();
      return { id, title:(scenarioName?.value||'').trim(), dispatch, description:dispatch, createdAt:Date.now(), active:true, stops:[] };
    }
    async function mirrorUpdate(multi){ await update(dbRef(db), multi); }
    async function createScenarioRecord(){
      const title=(scenarioName?.value||'').trim();
      if(!title) throw new Error('Please enter a Scenario Name');
      await ensureAuthed();
      const id = (await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js")).push(dbRef(db,'scenarios')).key;
      const base = baseScenario(id);
      await mirrorUpdate({ [`scenarios/${id}`]:base, [`geophoto/scenarios/${id}`]:base });
      currentScenarioId=id; return id;
    }

    /* ---- UI actions ---- */
    $('createNow').onclick = async ()=>{
      try{ $('createStatus').textContent='creating…'; await createScenarioRecord(); $('createStatus').textContent='created ✓'; setStep('Scenario created. You can now add photos.'); loadList(); }
      catch(e){ $('createStatus').textContent='error'; showErr(e.message||e); setStep('Create failed.'); }
    };

    $('savePhoto').onclick = async ()=>{
      try{
        $('saveStatus').textContent='preparing…'; setStep('Checking selection…');
        const f = photoInput?.files?.[0]; if(!f){ $('saveStatus').textContent='no file'; setStep('Pick a photo first.'); return; }
        showLoad(true);
        if(!currentScenarioId){
          if(!scenarioName.value.trim()) scenarioName.value = 'New Scenario ' + new Date().toLocaleString();
          $('createStatus').textContent='creating…';
          await createScenarioRecord(); $('createStatus').textContent='created ✓';
        }
        await ensureAuthed();

        setStep('Compressing photo…');
        const dataURL = canvasToDataURL(toCanvas(await loadImage(await readAsDataURL(f))));
        const thumbURL = await makeThumb(dataURL);

        const ts = Date.now();
        const fullRef  = stRef(storage, `scenarios/${currentScenarioId}/${ts}.jpg`);
        const thmbRef  = stRef(storage, `scenarios/${currentScenarioId}/thumbs/${ts}.jpg`);
        const meta     = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };

        let cloud=null;
        try{
          await uploadWithTimeout(fullRef, dataURLtoBlob(dataURL), meta);
          try{ await uploadBytes(thmbRef, dataURLtoBlob(thumbURL), meta); }catch{}
          const url = await getDownloadURL(fullRef);
          const turl= await getDownloadURL(thmbRef).catch(()=>url);
          cloud = { url, thumbURL:turl, path:fullRef.fullPath, gsUri:`gs://${FORCE_BUCKET}/${fullRef.fullPath}`, via:'storage' };
        }catch(e1){
          // Same fallback strategy as Advanced Editor
          try{
            const res = await uploadViaFunction(dataURL, currentScenarioId, `${ts}.jpg`);
            cloud = { url:res.url, thumbURL:res.url, path:res.path, gsUri:res.gsUri, via:'function' };
          }catch(e2){
            cloud = null; // final fallback: inline
          }
        }

        setStep('Saving to database…');
        const r = Math.max(5, Math.min(1000, parseInt((radius?.value)||'50',10)||50));
        const stop = {
          type:'photo',
          title:'',
          caption:(caption?.value)||'',
          radiusMeters:r,
          overlays:[],
          at:ts
        };
        if (cloud){
          stop.imageURL=cloud.url; stop.thumbURL=cloud.thumbURL||cloud.url; stop.storagePath=cloud.path; stop.gsUri=cloud.gsUri;
        }else{
          stop.imageData={ format:'jpeg', data:dataURL.split(',')[1] };
        }
        localStops.push(stop);
        await mirrorUpdate({
          [`scenarios/${currentScenarioId}/stops`]: localStops,
          [`geophoto/scenarios/${currentScenarioId}/stops`]: localStops
        });

        $('saveStatus').textContent='saved ✓'; setStep('Photo saved.');
        if(caption) caption.value=''; if(radius) radius.value=50; if(photoInput) photoInput.value='';
        renderThumbs(); loadList();
      }catch(e){
        $('saveStatus').textContent='error'; setStep('Save failed.'); showErr(e.message||e);
      }finally{
        showLoad(false);
      }
    };

    /* ---- Thumbs & list ---- */
    function renderThumbs(){
      const wrap=$('thumbs'); wrap.innerHTML='';
      localStops.forEach((s,i)=>{
        const w=document.createElement('div'); w.className='thumbWrap';
        const img=document.createElement('img'); img.className='thumb'; img.src=s.thumbURL||s.imageURL||''; img.alt=s.caption||('Stop '+(i+1));
        const del=document.createElement('button'); del.className='btn del'; del.textContent='Delete';
        del.onclick=async ()=>{
          if(!confirm('Delete this photo?')) return;
          try{
            await ensureAuthed();
            if(s.storagePath){ try{ await deleteObject(stRef(storage, s.storagePath)); }catch{} }
            localStops.splice(i,1);
            await mirrorUpdate({
              [`scenarios/${currentScenarioId}/stops`]: localStops,
              [`geophoto/scenarios/${currentScenarioId}/stops`]: localStops
            });
            renderThumbs();
          }catch(e){ showErr(e.message||e); }
        };
        w.appendChild(img); w.appendChild(del); wrap.appendChild(w);
      });
    }

    async function loadList(){
      try{
        $('listStatus').textContent='Loading…';
        await ensureAuthed();
        const [geo,plain] = await Promise.all([
          fetch(firebaseConfig.databaseURL+'/geophoto/scenarios.json',{cache:'no-store'}).then(r=>r.ok?r.json():{}).catch(()=>({})),
          fetch(firebaseConfig.databaseURL+'/scenarios.json',{cache:'no-store'}).then(r=>r.ok?r.json():{}).catch(()=>({}))
        ]);
        const map={...geo}; Object.keys(plain||{}).forEach(id=>{ if(!map[id]) map[id]=plain[id]; });
        const list = Object.keys(map).map(id=>({ id, title:map[id]?.title||'(untitled)', createdAt:map[id]?.createdAt||0, active:map[id]?.active!==false, stops:(map[id]?.stops||[]) }))
                     .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        $('listStatus').textContent = list.length ? `${list.length} scenario(s)` : 'No scenarios yet.';
        const host=$('scenarioList'); host.innerHTML='';
        list.forEach(sc=>{
          const row=document.createElement('div'); row.style.cssText='display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--edge);border-radius:12px;margin-bottom:8px';
          const L=document.createElement('div'); L.innerHTML=`<div style="font-weight:800">${sc.title}</div><div class="tag">Stops: ${(sc.stops||[]).length}</div>`;
          const R=document.createElement('div');
          const open=document.createElement('button'); open.className='btn secondary'; open.textContent='Open';
          open.onclick=()=>{ currentScenarioId=sc.id; scenarioName.value=sc.title||''; localStops=sc.stops||[]; renderThumbs(); window.scrollTo({top:0,behavior:'smooth'}); };
          const togg=document.createElement('button'); togg.className='btn secondary'; togg.style.marginLeft='8px'; togg.textContent=sc.active?'Deactivate':'Activate';
          togg.onclick=async ()=>{ await ensureAuthed(); await mirrorUpdate({[`scenarios/${sc.id}/active`]:!sc.active,[`geophoto/scenarios/${sc.id}/active`]:!sc.active}); loadList(); };
          const del=document.createElement('button'); del.className='btn'; del.style.marginLeft='8px'; del.textContent='Delete';
          del.onclick=async ()=>{
            if(!confirm('Delete this scenario?')) return;
            await ensureAuthed();
            // best-effort storage cleanup
            for(const s of (sc.stops||[])){ if(s?.storagePath){ try{ await deleteObject(stRef(storage,s.storagePath)); }catch{} } }
            await mirrorUpdate({[`scenarios/${sc.id}`]:null,[`geophoto/scenarios/${sc.id}`]:null});
            loadList();
          };
          R.appendChild(open); R.appendChild(togg); R.appendChild(del);
          row.appendChild(L); row.appendChild(R); host.appendChild(row);
        });
      }catch(e){ $('listStatus').textContent='Error'; showErr(e.message||e); }
    }

    // boot
    (async ()=>{ try{ await ensureAuthed(); await loadList(); }catch(e){ showErr(e.message||e); }})();
  </script>
</body>
</html>
