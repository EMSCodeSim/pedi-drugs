<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FireOps SIM ‚Äî Advanced Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{
  --bg:#0b0f14;--bg2:#0e1421;--card:#0f1624;--edge:rgba(255,255,255,.10);
  --text:#eaf2ff;--muted:#93a0b5;--blue:#0a84ff;--red:#ff3b30;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:
  radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
  radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
  linear-gradient(165deg, var(--bg2), var(--bg) 55%)}
a{color:inherit}

.topbar{position:sticky;top:0;z-index:40;background:rgba(12,15,22,.78);backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
.topnav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
.brand{font-weight:900}
.spacer{flex:1}
.btn{appearance:none;border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg,#142238,#0f1930);color:#fff;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}

main{max-width:1200px;margin:16px auto 40px;padding:0 16px}
.app{display:grid;grid-template-columns:320px 1fr 420px;gap:12px;align-items:start}
.col{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px;min-height:140px}
.col.side{overflow:auto;max-height:calc(100vh - 160px)}
.hidden{display:none!important}

label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
.input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff}
textarea{min-height:80px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted)}

.thumb{width:58px;height:58px;border-radius:8px;border:1px solid rgba(255,255,255,.14);object-fit:cover;background:#0a1a2a;cursor:pointer}
.thumb.active{outline:3px solid #2dd4bf}

.canvasWrap{position:relative;border:1px solid rgba(255,255,255,.12);border-radius:12px;overflow:hidden;background:#061621}
#c{width:100%;height:calc(100vh - 280px);display:block}

.sectionTitle{font-weight:900;margin:4px 0}
.divider{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
.small{font-size:12px;opacity:.85}
#errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999}

/* Collapsible edit drawer + full-canvas mode */
#editDrawer summary{cursor:pointer;list-style:none;padding:8px 10px;border:1px solid rgba(255,255,255,.14);border-radius:10px;background:#0c1528;font-weight:800}
#editDrawer[open] summary{background:#0e1a30}
.app.canvasOnly{grid-template-columns:1fr}
.app.canvasOnly .side{display:none}
#expandHint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div id="errbar"></div>

<div class="topbar">
  <div class="topnav">
    <div class="brand">FireOps SIM ‚Äî Advanced Editor</div>
    <div class="spacer"></div>
    <button id="toggleCanvas" class="btn">Expand Canvas</button>
  </div>
</div>

<main>
  <div class="app" id="app">
    <!-- LEFT: Scenario & meta -->
    <div class="col side" id="leftCol">
      <div class="row" style="justify-content:space-between">
        <div class="pill" id="statusPill">Loading‚Ä¶</div>
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>

      <label>Scenario</label>
      <select id="scenarioSel"><option value="">Select scenario‚Ä¶</option></select>

      <div class="divider"></div>
      <div class="sectionTitle">Scenario Dispatch</div>
      <label>Dispatch Text</label>
      <textarea id="scenarioDispatch" placeholder="Engine 1 to‚Ä¶"></textarea>
      <div class="row">
        <label class="pill"><input type="checkbox" id="scenarioDispatchTTS" /> Read via TTS</label>
        <button class="btn" id="saveScenarioMeta">Save Scenario</button>
      </div>
      <div id="scenarioMetaMsg" class="pill small" style="margin-top:6px">Ready</div>

      <div class="divider"></div>
      <div class="sectionTitle">Photos / Slides</div>
      <div class="row" id="stopList"></div>

      <div class="divider"></div>
      <div class="sectionTitle">Selected stop meta</div>
      <label>Title</label><input class="input" id="stopTitle" />
      <label>Caption</label><textarea id="stopCaption"></textarea>
      <div class="row">
        <div style="flex:1"><label>Latitude</label><input class="input" id="stopLat" /></div>
        <div style="flex:1"><label>Longitude</label><input class="input" id="stopLng" /></div>
      </div>
      <label>Radius (meters)</label><input class="input" id="stopRadius" value="50" />
      <div class="row" style="margin-top:6px">
        <button class="btn" id="useGPS">Use my location</button>
        <button class="btn" id="saveMeta">Save Meta</button>
      </div>
      <div id="metaMsg" class="pill small" style="margin-top:6px">Ready</div>

      <div class="divider"></div>
      <div class="row">
        <input id="replaceFile" type="file" accept="image/*" />
        <button class="btn" id="replaceApply">Replace Image (local preview)</button>
        <button class="btn" id="saveImage">Save Image to Cloud</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="addTextSlide">+ Add Text Slide</button>
        <button class="btn" id="exportPNG">Export PNG</button>
        <button class="btn" id="deleteStop" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
      </div>
    </div>

    <!-- CENTER: Canvas -->
    <div class="col">
      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="fit">Fit</button>
        <button class="btn" id="zoomIn">Zoom +</button>
        <button class="btn" id="zoomOut">Zoom ‚àí</button>
        <button class="btn" id="rotateL">Rotate ‚ü≤</button>
        <button class="btn" id="rotateR">Rotate ‚ü≥</button>
        <span class="pill" id="canvasInfo">Canvas</span>
        <span id="expandHint" class="spacer">Tip: ‚ÄúExpand Canvas‚Äù to hide the side menus.</span>
      </div>
      <div class="canvasWrap"><canvas id="c"></canvas></div>
    </div>

    <!-- RIGHT: Collapsible edit drawer -->
    <div class="col side" id="rightCol">
      <details id="editDrawer" open>
        <summary>Editing Tools (collapse/expand)</summary>
        <div style="margin-top:10px">
          <div class="sectionTitle">Overlays</div>
          <div class="row" style="gap:6px; flex-wrap:nowrap; overflow:auto">
            <button class="btn" data-cat="fire">üî• Fire</button>
            <button class="btn" data-cat="smoke">üå´Ô∏è Smoke</button>
            <button class="btn" data-cat="people">üßç People</button>
            <button class="btn" data-cat="cars">üöó Cars</button>
            <button class="btn" data-cat="hazard">‚ö†Ô∏è Hazard</button>
          </div>
          <div id="overlayShelf" style="margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>

          <div class="divider"></div>
          <div class="sectionTitle">Brush / Stamps</div>
          <div class="row">
            <button class="btn" id="brushFire">üî• Fire Brush</button>
            <button class="btn" id="brushSmoke">üå´Ô∏è Smoke Brush</button>
            <button class="btn" id="brushErase">üßΩ Erase Stamps</button>
            <button class="btn" id="brushOff">‚úñ Off</button>
          </div>
          <label>Brush Size <span id="brushSizeReadout" class="pill" style="margin-left:6px">120 px</span></label>
          <input id="brushSize" type="range" min="24" max="320" step="4" value="120" />

          <div class="divider"></div>
          <div class="sectionTitle">Text Boxes (on photo)</div>
          <div class="row"><button class="btn" id="addTextbox">+ Add Text Box</button></div>
          <label>Selected Text</label><textarea id="tbContent" placeholder="Type notes‚Ä¶"></textarea>
          <label>Font Size</label><input id="tbFont" type="range" min="12" max="72" step="1" value="24" />
          <label>Background Opacity</label><input id="tbBgOpacity" type="range" min="0" max="1" step="0.05" value="0.6" />
          <div class="row" style="margin-top:6px">
            <button class="btn" id="tbApply">Apply</button>
            <button class="btn" id="tbDelete" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
          </div>

          <div class="divider"></div>
          <div class="sectionTitle">Transform Selected</div>
          <div class="row">
            <button class="btn" id="flipSelH">Flip H</button>
            <button class="btn" id="flipSelV">Flip V</button>
            <button class="btn" id="bringFront">Bring Front</button>
            <button class="btn" id="sendBack">Send Back</button>
            <button class="btn" id="deleteObj" style="background:#2a0f14;border-color:#7a2b2b">Delete Overlay</button>
          </div>
        </div>
      </details>
    </div>
  </div>
</main>

<!-- Fabric -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous"></script>
<!-- Firebase (modules) -->
<script type="module">
/* ---------- Helpers ---------- */
const $ = (id)=>document.getElementById(id);
const ERR = (msg)=>{ const b=$('errbar'); b.textContent = msg; b.style.display='block'; };

/* ---------- UI Basics ---------- */
const appGrid = $('app');
$('toggleCanvas').onclick = ()=>{
  const on = !appGrid.classList.contains('canvasOnly');
  appGrid.classList.toggle('canvasOnly', on);
  $('toggleCanvas').textContent = on ? 'Show Editor' : 'Expand Canvas';
  // Refit canvas when toggling
  fitCanvas();
};

/* ---------- Firebase (project: dailyquiz-d5279) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref as dbRef, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as stRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain:"dailyquiz-d5279.firebaseapp.com",
  databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId:"dailyquiz-d5279",
  storageBucket:"dailyquiz-d5279.firebasestorage.app",   // <-- new bucket host
  appId:"1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId:"G-19DVN7NNH7"
};
const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);
// Use explicit gs:// URL to be crystal-clear which bucket we hit
const storage = getStorage(appFB, "gs://dailyquiz-d5279.firebasestorage.app");
const auth = getAuth(appFB);

// Anonymous auth (required by your Storage rules)
async function ensureAuthed(){
  if (auth.currentUser) return auth.currentUser;
  await signInAnonymously(auth);
  await new Promise(res=> onAuthStateChanged(auth, u=> u && res(), { once:true }));
  return auth.currentUser;
}

/* ---------- Canvas setup ---------- */
const f = new fabric.Canvas('c', { backgroundColor:'#061621', preserveObjectStacking:true });
let baseImage = null;
function fitCanvas(){
  const reserved = 220; // topbar + margins
  const targetH = Math.max(420, window.innerHeight - reserved);
  $('c').style.height = targetH + 'px';
  f.setHeight(targetH);
  const mid = document.querySelector('.app:not(.canvasOnly) .col:nth-child(2)') || document.querySelector('.col:nth-child(2)');
  const w = (mid?.clientWidth || 900) - 24;
  f.setWidth(w);
  if (baseImage && baseImage.type==='rect'){
    baseImage.set({ left:0, top:0, width:f.getWidth(), height:f.getHeight() });
    const t = f.getObjects('textbox').find(o=>o.isBaseText);
    if (t){
      t.set({
        width: Math.floor(f.getWidth()*0.8),
        left: Math.floor(f.getWidth()*0.1),
        top:  Math.floor(f.getHeight()*0.2)
      });
    }
  }
  f.calcOffset(); f.requestRenderAll();
}
fitCanvas(); addEventListener('resize', fitCanvas);

function setBaseFromURL(url){
  return new Promise((resolve,reject)=>{
    fabric.Image.fromURL(url, img=>{
      if(!img){ reject(new Error('Image load failed')); return; }
      if (baseImage) f.remove(baseImage);
      baseImage = img; baseImage.selectable=false; baseImage.evented=false; baseImage.set('erasable', false);
      const cw=f.getWidth(), ch=f.getHeight();
      const s=Math.min(cw/img.width, ch/img.height);
      img.scale(s); img.set({ left:(cw-img.width*s)/2, top:(ch-img.height*s)/2, crossOrigin:'anonymous' });
      f.add(img); img.moveTo(0); f.requestRenderAll();
      $('canvasInfo').textContent=`Image ${Math.round(img.width)}√ó${Math.round(img.height)}`;
      resolve();
    }, { crossOrigin:'anonymous' });
  });
}
function setBaseAsTextSlide(text, fontSize){
  f.clear();
  const rect = new fabric.Rect({ left:0, top:0, width:f.getWidth(), height:f.getHeight(), fill:'#000', selectable:false, evented:false, erasable:false });
  baseImage = rect;
  const tb = new fabric.Textbox(text||'', {
    width: Math.floor(f.getWidth()*0.8),
    left: Math.floor(f.getWidth()*0.1),
    top:  Math.floor(f.getHeight()*0.2),
    fontSize: fontSize||34, fill:'#fff', textAlign:'center',
    fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif',
    selectable:false, evented:false, erasable:false
  });
  tb.isBaseText=true;
  f.add(rect); f.add(tb); rect.moveTo(0); f.requestRenderAll();
  $('canvasInfo').textContent='Text slide';
}
function toDataURLFromStored(v){
  if (typeof v==='string') return v;
  if (!v || !v.data) return '';
  const fmt = v.format==='jpeg' ? 'jpeg' : 'png';
  return `data:image/${fmt};base64,${v.data}`;
}

/* ---------- Scenario & stop data ---------- */
const ROOT = 'scenarios';
let scenarios=[], current=null, stopIndex=-1;

function coerceStops(sc){
  if (Array.isArray(sc?.stops)) return sc.stops;
  if (Array.isArray(sc?.photos)) return sc.photos;
  if (Array.isArray(sc?.images)) return sc.images;
  return [];
}
function setStops(sc, stops){
  if (Array.isArray(sc?.stops)) sc.stops = stops;
  else if (Array.isArray(sc?.photos)) sc.photos = stops;
  else if (Array.isArray(sc?.images)) sc.images = stops;
  else sc.stops = stops;
}

function status(msg){ $('statusPill').textContent = msg; }
function populateList(){
  const sel=$('scenarioSel'); sel.innerHTML='<option value="">Select scenario‚Ä¶</option>';
  scenarios.forEach(sc=>{
    const o=document.createElement('option');
    o.value=sc.id; o.textContent=(sc.title||'(untitled)') + (sc.active?'':' (inactive)');
    sel.appendChild(o);
  });
}
async function loadScenarios(){
  try{
    const snap = await get(dbRef(db, ROOT));
    const obj = snap.exists() ? (snap.val()||{}) : {};
    scenarios = Object.entries(obj).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
                .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    populateList();
    status(`${scenarios.length} scenario(s) loaded`);
  }catch(e){ status('Error: '+(e.message||e)); ERR(e.message||e); }
}
onValue(dbRef(db, ROOT), snap=>{
  const v=snap.val()||{};
  scenarios = Object.entries(v).map(([id,s])=>({ id, _raw:s, _stops:coerceStops(s), ...s }))
              .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  populateList();
  if (current){
    const fresh = scenarios.find(x=>x.id===current.id);
    if (fresh){ current=fresh; renderThumbs(); }
  }
  status(`${scenarios.length} scenario(s) loaded`);
});
await loadScenarios();
$('refreshBtn').onclick = loadScenarios;

function renderThumbs(){
  const wrap = $('stopList'); wrap.innerHTML='';
  if (!current || !current._stops?.length){ wrap.innerHTML='<div class="pill small">No photos/slides</div>'; return; }
  current._stops.forEach((s,i)=>{
    const img=document.createElement('img'); img.className='thumb'+(i===stopIndex?' active':'');
    const src = (s?.type==='text') ? textThumb(s?.text||s?.title||'') : toDataURLFromStored(s.imageURL || s.imageData);
    img.src = src; img.title = (s.title||`Stop ${i+1}`) + (s?.type==='text'?' (Text slide)':'');
    img.onerror=()=>{ img.src = textThumb(s?.title||''); };
    img.onclick = ()=>loadStop(i);
    wrap.appendChild(img);
  });
}
function textThumb(text){
  const t=(text||'TEXT').split('\n')[0].slice(0,18);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'>
    <rect width='100%' height='100%' fill='#000'/>
    <rect x='6' y='6' width='68' height='20' rx='6' fill='#0a84ff'/>
    <text x='40' y='21' fill='#001' font-size='12' text-anchor='middle' font-weight='700'>TEXT</text>
    <text x='40' y='50' fill='#fff' font-size='10' text-anchor='middle'>${t.replace(/&/g,'&amp;')}</text>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}

$('scenarioSel').onchange = async ()=>{
  const id = $('scenarioSel').value;
  current = scenarios.find(s=>s.id===id) || null;
  stopIndex=-1;
  renderThumbs();
  applyScenarioMetaUI();
  f.clear(); baseImage=null; fitCanvas();
};

function applyScenarioMetaUI(){
  if (!current){ $('scenarioDispatch').value=''; $('scenarioDispatchTTS').checked=false; return; }
  const raw=current._raw || {};
  $('scenarioDispatch').value = raw.dispatchText || '';
  $('scenarioDispatchTTS').checked = !!raw.dispatchTTS;
}
$('saveScenarioMeta').onclick = async ()=>{
  try{
    if(!current) throw new Error('Select a scenario first.');
    const updated = Object.assign({}, current._raw, {
      dispatchText: $('scenarioDispatch').value.trim(),
      dispatchTTS: !!$('scenarioDispatchTTS').checked
    });
    await set(dbRef(db, `${ROOT}/${current.id}`), updated);
    current._raw = updated;
    $('scenarioMetaMsg').textContent = 'Scenario saved.';
  }catch(e){ $('scenarioMetaMsg').textContent = 'Error: '+(e.message||e); }
};

$('addTextSlide').onclick = async ()=>{
  try{
    if(!current) throw new Error('Select a scenario first.');
    const next = current._stops.slice();
    next.push({ type:'text', title:'Text Slide', text:'New slide text', fontSize:34, manual:true, tts:true, lat:null, lng:null, radiusMeters:50, overlays:[] });
    const updated = Object.assign({}, current._raw); setStops(updated, next);
    await set(dbRef(db, `${ROOT}/${current.id}`), updated);
    current._raw=updated; current._stops=next;
    renderThumbs(); stopIndex=next.length-1; await loadStop(stopIndex);
    $('scenarioMetaMsg').textContent='Text slide added.';
  }catch(e){ $('scenarioMetaMsg').textContent='Error: '+(e.message||e); }
};

async function loadStop(i){
  if (!current) return;
  const s=current._stops[i]; if(!s) return;
  stopIndex=i;
  $('stopTitle').value = s.title||'';
  $('stopCaption').value = s.caption||'';
  $('stopLat').value = s.lat??'';
  $('stopLng').value = s.lng??'';
  $('stopRadius').value = (s.radiusMeters ?? s.radius ?? 50);
  Array.from($('stopList').children).forEach((n,idx)=>n.classList.toggle('active', idx===i));
  f.clear(); baseImage=null;
  if (s.type==='text'){ setBaseAsTextSlide(s.text||'', s.fontSize||34); }
  else {
    const src = toDataURLFromStored(s.imageURL || s.imageData);
    if (!src){ $('metaMsg').textContent='No image in this stop.'; return; }
    await setBaseFromURL(src);
  }
  // Rehydrate overlays
  if (Array.isArray(s.overlays)){
    for (const ov of s.overlays){
      if (ov?.kind==='text'){
        const tb = new fabric.Textbox(ov.text||'', {
          left:ov.left||100, top:ov.top||100, scaleX:ov.scaleX||1, scaleY:ov.scaleY||1,
          angle:ov.angle||0, opacity:ov.opacity??1, fontSize:ov.fontSize||24, fill:ov.fill||'#fff',
          backgroundColor:ov.backgroundColor||'rgba(0,0,0,0.6)', padding:ov.padding??8,
          cornerStyle:'circle', transparentCorners:false, editable:true
        }); tb._kind='text'; f.add(tb);
      } else if (ov?.src){
        await new Promise(res=>{
          fabric.Image.fromURL(ov.src, img=>{
            img.set({ left:ov.left||0, top:ov.top||0, scaleX:ov.scaleX||1, scaleY:ov.scaleY||1,
                      angle:ov.angle||0, opacity:ov.opacity??1, flipX:!!ov.flipX, flipY:!!ov.flipY,
                      erasable:true, cornerStyle:'circle', transparentCorners:false });
            f.add(img); res();
          }, { crossOrigin:'anonymous' });
        });
      }
    }
    f.requestRenderAll();
  }
}

/* Save meta (plus overlays) */
function serializeOverlays(){
  const out=[];
  f.getObjects().forEach(o=>{
    if (o===baseImage || o.isBaseText) return;
    if (o.type==='image'){
      out.push({
        kind:'image',
        src:o.getSrc ? o.getSrc() : (o._originalElement?.src || o.src || ''),
        left:o.left||0, top:o.top||0, scaleX:o.scaleX||1, scaleY:o.scaleY||1,
        angle:o.angle||0, opacity:o.opacity??1, flipX:!!o.flipX, flipY:!!o.flipY
      });
    } else if (o.type==='textbox'){
      out.push({
        kind:'text', text:o.text||'', left:o.left||0, top:o.top||0, scaleX:o.scaleX||1, scaleY:o.scaleY||1,
        angle:o.angle||0, opacity:o.opacity??1, fontSize:o.fontSize||24, fill:o.fill||'#fff',
        backgroundColor:o.backgroundColor||'rgba(0,0,0,0.6)', padding:o.padding??8
      });
    }
  });
  return out;
}

$('useGPS').onclick = ()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    $('stopLat').value = p.coords.latitude.toFixed(6);
    $('stopLng').value = p.coords.longitude.toFixed(6);
    $('metaMsg').textContent='GPS captured.';
  }, e=>{ $('metaMsg').textContent='GPS error: '+e.message; }, { enableHighAccuracy:true, timeout:10000 });
};

$('saveMeta').onclick = async ()=>{
  try{
    if(!current || stopIndex<0) throw new Error('Select a stop first.');
    const s = Object.assign({}, current._stops[stopIndex]);
    s.title = $('stopTitle').value.trim();
    s.caption = $('stopCaption').value.trim();
    if (s.type==='text'){
      // Keep current text slide (use canvas buttons to preview), no extra fields here
    }
    const lat = $('stopLat').value.trim()==='' ? null : parseFloat($('stopLat').value);
    const lng = $('stopLng').value.trim()==='' ? null : parseFloat($('stopLng').value);
    s.lat = lat; s.lng = lng;
    s.radiusMeters = Math.max(5, Math.min(1000, Math.round(parseInt($('stopRadius').value||'50',10))));
    s.overlays = serializeOverlays();

    const next=current._stops.slice(); next[stopIndex]=s;
    const updated=Object.assign({}, current._raw); setStops(updated,next);
    await set(dbRef(db, `${ROOT}/${current.id}`), updated);
    current._raw = updated; current._stops = next;
    renderThumbs();
    $('metaMsg').textContent='Meta saved.';
  }catch(e){ $('metaMsg').textContent = String(e.message||e); }
};

/* Replace preview (local only) */
function readAsDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
$('replaceApply').onclick = async ()=>{
  const fsel = $('replaceFile').files?.[0];
  if(!fsel){ $('metaMsg').textContent='Choose a file first.'; return; }
  const data = await readAsDataURL(fsel);
  await setBaseFromURL(data);
};

/* Export + Save to Cloud */
function encodeCanvas(){
  const MAX = 9_000_000;
  let url = f.toDataURL({ format:'png', quality:1, multiplier:1 });
  let b64 = url.split(',')[1]||'';
  const bytes = (s)=>Math.floor((s.length*3)/4);
  if (bytes(b64)<=MAX) return url;
  const steps=[0.95,0.9,0.85,0.8,0.75,0.7];
  for (const q of steps){
    url = f.toDataURL({ format:'jpeg', quality:q, multiplier:1 });
    b64 = url.split(',')[1]||'';
    if (bytes(b64)<=MAX) return url;
  }
  return f.toDataURL({ format:'jpeg', quality:0.65, multiplier:0.85 });
}
$('exportPNG').onclick = ()=>{
  const url = encodeCanvas();
  const a=document.createElement('a'); a.href=url; a.download='image-edited.'+(url.includes('image/png')?'png':'jpg'); a.click();
};
async function uploadEditedToStorage(dataURL, scenarioId, idx){
  await ensureAuthed();
  const ts = Date.now();
  const path = `scenarios/${scenarioId}/${ts}_edited_${idx}.jpg`;
  const obj = stRef(storage, path);
  await uploadString(obj, dataURL, 'data_url');
  const url = await getDownloadURL(obj);
  return { url, path, gsUri: `gs://dailyquiz-d5279.firebasestorage.app/${path}` };
}
$('saveImage').onclick = async ()=>{
  try{
    if(!current || stopIndex<0) throw new Error('Select a stop first.');
    const dataURL = encodeCanvas();
    const { url, path, gsUri } = await uploadEditedToStorage(dataURL, current.id, stopIndex);
    // Persist URL + overlays; drop inline data if present
    const s = Object.assign({}, current._stops[stopIndex]);
    s.imageURL = url; s.storagePath = path; s.gsUri = gsUri; s.imageData = null;
    s.overlays = serializeOverlays();
    const next=current._stops.slice(); next[stopIndex]=s;
    const updated=Object.assign({}, current._raw); setStops(updated,next);
    await set(dbRef(db, `${ROOT}/${current.id}`), updated);
    current._raw=updated; current._stops=next;
    renderThumbs();
    $('metaMsg').textContent='Image saved to Cloud & linked.';
  }catch(e){ $('metaMsg').textContent='Save failed: '+(e.message||e); }
};

/* Canvas utilities */
$('fit').onclick = ()=>{ if (baseImage && baseImage.type==='image'){ setBaseFromURL(baseImage.getSrc ? baseImage.getSrc() : baseImage._originalElement?.src || '') } else if (baseImage && baseImage.type==='rect'){ const t=f.getObjects('textbox').find(o=>o.isBaseText); setBaseAsTextSlide(t?t.text:'', t?t.fontSize:34); } };
$('zoomIn').onclick = ()=> f.setZoom(f.getZoom()*1.1);
$('zoomOut').onclick = ()=> f.setZoom(f.getZoom()/1.1);
$('rotateL').onclick = ()=>{ if(baseImage && baseImage.rotate){ baseImage.rotate((baseImage.angle||0)-90); f.requestRenderAll(); } };
$('rotateR').onclick = ()=>{ if(baseImage && baseImage.rotate){ baseImage.rotate((baseImage.angle||0)+90); f.requestRenderAll(); } };

/* Text boxes on photo */
function selTB(){ const o=f.getActiveObject(); return (o && o.type==='textbox' && !o.isBaseText) ? o : null; }
$('addTextbox').onclick = ()=>{
  const tb = new fabric.Textbox('Double-click to edit', {
    left: Math.max(10, (f.getWidth()*0.5)-120),
    top:  Math.max(10, (f.getHeight()*0.5)-30),
    width: 240, fontSize: 24, fill:'#fff', backgroundColor:'rgba(0,0,0,0.6)', padding:8,
    cornerStyle:'circle', transparentCorners:false, editable:true
  });
  f.add(tb); f.setActiveObject(tb); $('tbContent').value=tb.text;
};
$('tbApply').onclick = ()=>{
  const tb=selTB(); if(!tb){ alert('Select a text box first.'); return; }
  tb.set({ text:$('tbContent').value, fontSize:parseInt($('tbFont').value,10)||24, backgroundColor:`rgba(0,0,0,${parseFloat($('tbBgOpacity').value)||0.6})` });
  f.requestRenderAll();
};
$('tbDelete').onclick = ()=>{ const tb=selTB(); if(tb){ f.remove(tb); f.discardActiveObject(); f.requestRenderAll(); } };
f.on('selection:created', syncTB); f.on('selection:updated', syncTB);
function syncTB(){ const tb=selTB(); if(tb){ $('tbContent').value=tb.text||''; $('tbFont').value=tb.fontSize||24; const m=tb.backgroundColor||'rgba(0,0,0,0.6)'; const op=(m.match(/rgba?\([^,]+,[^,]+,[^,]+,([\d.]+)\)/)||[])[1]; $('tbBgOpacity').value=op?parseFloat(op):0.6; } }

/* Overlays (thumb shelf) */
const OVERLAY_BASE='https://fireopssim.com/geophoto/overlays/';
const FOLDER={ fire:'fire', smoke:'smoke', people:'people', cars:'cars', hazard:'hazard' };
const EXT=['png','webp','jpg','jpeg'];
async function listOverlays(cat){
  // Try manifest first
  try{
    const r = await fetch(`${OVERLAY_BASE}manifest.json`, { cache:'no-store' });
    if (r.ok){ const j = await r.json(); if (Array.isArray(j[FOLDER[cat]])) return j[FOLDER[cat]]; }
  }catch{}
  // Fallback: HEAD probing a simple seq
  const prefix = {fire:'fire', smoke:'smoke', people:'person', cars:'car', hazard:'hazard'}[cat]||'img';
  const found=[]; let miss=0;
  for(let i=1;i<=60 && miss<5;i++){
    let hit=false;
    for(const ext of EXT){
      const url = `${OVERLAY_BASE}${FOLDER[cat]}/${prefix}${i}.${ext}`;
      try{ const h=await fetch(url,{method:'HEAD',cache:'no-store'}); if(h.ok){ found.push(`${prefix}${i}.${ext}`); hit=true; break; } }catch{}
    }
    miss = hit ? 0 : miss+1;
  }
  return found;
}
function renderShelf(cat){
  const shelf=$('overlayShelf'); shelf.innerHTML='';
  listOverlays(cat).then(files=>{
    if(!files.length){ shelf.innerHTML='<div class="pill small">No overlays found</div>'; return; }
    files.forEach(name=>{
      const url=`${OVERLAY_BASE}${FOLDER[cat]}/${name}`;
      const cell=document.createElement('div'); cell.style.border='1px solid rgba(255,255,255,.14)'; cell.style.borderRadius='10px'; cell.style.padding='4px'; cell.style.background='#0b2130';
      const img=new Image(); img.src=url; img.alt=name; img.style.width='100%'; img.style.display='block';
      img.onclick=()=> addOverlay(url);
      cell.appendChild(img); shelf.appendChild(cell);
    });
  });
}
function addOverlay(src){
  fabric.Image.fromURL(src, img=>{
    const cw=f.getWidth(), ch=f.getHeight(), targetW=cw*0.28, scale=targetW/img.width;
    img.scale(scale);
    img.set({ left:cw/2-(img.width*img.scaleX)/2, top:ch/2-(img.height*img.scaleY)/2,
              cornerStyle:'circle', transparentCorners:false, shadow:'rgba(0,0,0,0.35) 0 6px 16px', erasable:true });
    f.add(img); f.setActiveObject(img); f.requestRenderAll();
  }, { crossOrigin:'anonymous' });
}
Array.from(document.querySelectorAll('#rightCol [data-cat]')).forEach(b=>{
  b.addEventListener('click', ()=> renderShelf(b.dataset.cat));
});
renderShelf('fire');

/* Simple stamp/erase brush (images) */
let brushMode='off', pointerDown=false, lastStamp=null;
const brushSize=$('brushSize'), brushSizeReadout=$('brushSizeReadout');
brushSize.oninput=()=> brushSizeReadout.textContent=(parseInt(brushSize.value,10)||120)+' px';
$('brushFire').onclick = ()=> brushMode='fire';
$('brushSmoke').onclick= ()=> brushMode='smoke';
$('brushErase').onclick= ()=> brushMode='erase';
$('brushOff').onclick  = ()=> brushMode='off';
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
async function randomOverlay(cat){
  const files = await listOverlays(cat); if(!files.length) return null;
  const i=Math.floor(Math.random()*files.length);
  return `${OVERLAY_BASE}${FOLDER[cat]}/${files[i]}`;
}
async function stampAt(p, cat){
  const file = await randomOverlay(cat); if(!file) return;
  const R = (parseInt(brushSize.value,10)||120)/2;
  if (lastStamp && dist(p,lastStamp) < R*0.6) return; lastStamp=p;
  fabric.Image.fromURL(file, img=>{
    const baseW=img.width||200, scale=(R*2)/baseW, j=0.75+Math.random()*0.5;
    img.scale(scale*j);
    img.set({ left:p.x-(img.width*img.scaleX)/2, top:p.y-(img.height*img.scaleY)/2, angle:(Math.random()*30-15),
              opacity:0.9, cornerStyle:'circle', transparentCorners:false, erasable:true, selectable:false, evented:false });
    f.add(img); f.requestRenderAll();
  }, { crossOrigin:'anonymous' });
}
function eraseStampsAt(p){
  const R=(parseInt(brushSize.value,10)||120)/2;
  const targets = f.getObjects('image').filter(o => o!==baseImage);
  for (const obj of targets){
    const cx=obj.left + (obj.width*obj.scaleX)/2, cy=obj.top + (obj.height*obj.scaleY)/2;
    if (Math.hypot(cx-p.x, cy-p.y) <= R) f.remove(obj);
  }
  f.requestRenderAll();
}
f.on('mouse:down', (e)=>{ pointerDown=true; const p=f.getPointer(e.e); if(brushMode==='fire') stampAt(p,'fire'); else if(brushMode==='smoke') stampAt(p,'smoke'); else if(brushMode==='erase') eraseStampsAt(p); });
f.on('mouse:move', (e)=>{ if(!pointerDown) return; const p=f.getPointer(e.e); if(brushMode==='fire') stampAt(p,'fire'); else if(brushMode==='smoke') stampAt(p,'smoke'); else if(brushMode==='erase') eraseStampsAt(p); });
f.on('mouse:up', ()=>{ pointerDown=false; });

/* Transform / order / delete selected overlay */
$('bringFront').onclick = ()=>{ const o=f.getActiveObject(); if(o && o!==baseImage){ o.bringToFront(); f.requestRenderAll(); } };
$('sendBack').onclick  = ()=>{ const o=f.getActiveObject(); if(o && o!==baseImage){ o.sendToBack(); if(baseImage) baseImage.sendToBack(); f.requestRenderAll(); } };
$('deleteObj').onclick = ()=>{ const o=f.getActiveObject(); if(o && o!==baseImage){ f.remove(o); f.discardActiveObject(); f.requestRenderAll(); } };
$('flipSelH').onclick  = ()=>{ const o=f.getActiveObject(); if(o && o!==baseImage){ o.set('flipX', !o.flipX); f.requestRenderAll(); } };
$('flipSelV').onclick  = ()=>{ const o=f.getActiveObject(); if(o && o!==baseImage){ o.set('flipY', !o.flipY); f.requestRenderAll(); } };

/* Delete stop (list + DB only; does not delete the cloud file here) */
$('deleteStop').onclick = async ()=>{
  if(!current || stopIndex<0) return;
  if(!confirm('Delete this photo/slide from the scenario?')) return;
  const next=current._stops.slice(); next.splice(stopIndex,1);
  const updated=Object.assign({}, current._raw); setStops(updated,next);
  await set(dbRef(db, `${ROOT}/${current.id}`), updated);
  current._stops=next; stopIndex=-1; f.clear(); baseImage=null; renderThumbs();
  $('metaMsg').textContent='Photo/slide deleted.';
};

/* Save selected text slide preview without DB write */
$('exportPNG'); // (handler above)
</script>
</body>
</html>
