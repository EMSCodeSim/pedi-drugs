<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Advanced Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff; --blue:#0a84ff; --teal:#2dd4bf; --red:#ff3b30; --shadow:0 12px 34px rgba(0,0,0,.38); --radius:18px }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:
      radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
      radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
      linear-gradient(165deg, var(--bg2), var(--bg) 55%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif }
    img{max-width:100%; display:block}
    .topbar{position:sticky; top:0; z-index:30; background:rgba(12,15,22,.75); backdrop-filter:blur(6px); border-bottom:1px solid rgba(255,255,255,.08)}
    .topnav{max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
    .brand{display:flex; gap:12px; align-items:center; font-weight:900}
    .brand .logo{width:40px; height:40px; border-radius:10px; background:#0f1624; box-shadow:var(--shadow)}
    .card{background:#121823; border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .grid{max-width:1200px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns: 260px 1fr 300px; gap:12px}
    .col{display:flex; flex-direction:column; gap:12px}
    .panel{padding:14px}
    label{font-size:12px; color:#a9bed8; display:block; margin:8px 0 6px}
    input, textarea, select{width:100%; padding:10px 12px; border-radius:12px; background:#0f1624; color:var(--text); border:1px solid rgba(255,255,255,.14); font-size:14px}
    textarea{min-height:74px; resize:vertical}
    .btn{appearance:none; border:0; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer; background:linear-gradient(180deg,#54a6ff,var(--blue)); color:#03131b; box-shadow:var(--shadow)}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.16)}
    .btn.danger{background:var(--red); color:#fff}
    .status{font-size:12px; color:#8ea0b3}

    #stageWrap{position:relative; background:#000; border-radius:14px; border:1px solid rgba(255,255,255,.12); min-height:60vh; display:flex; align-items:center; justify-content:center; overflow:hidden}
    #baseImg{width:100%; height:100%; object-fit:contain; background:#000}
    #overlayCanvas{position:absolute; inset:0}
    .thumbs{display:flex; flex-wrap:wrap; gap:8px}
    .thumb{width:88px; height:88px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0a2230; cursor:pointer}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    #overlayMenu{display:grid; grid-template-columns:repeat(auto-fill,minmax(60px,1fr)); gap:8px; margin-top:8px}
    .overlayBtn{background:#0f1624;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .overlayBtn img{width:100%;height:100%;object-fit:contain}
    #savingHUD{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:60}
    #savingHUD .modal{background:#0e1524; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; box-shadow:var(--shadow); min-width:240px; text-align:center}
    .spin{width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin .9s linear infinite; display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brand"><img class="logo" src="/assets/logo/fire-ops-sim.png" alt=""/><div>FireOps SIM — Advanced Editor</div></div>
      <div class="row">
        <select id="scenarioSelect"><option value="">Loading scenarios…</option></select>
        <button id="backBtn" class="btn secondary">Back</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="col">
      <div class="card panel">
        <div class="row" style="justify-content:space-between"><strong>Photo Meta</strong><span id="leftStatus" class="status">Ready</span></div>
        <label>Title</label>
        <input id="metaTitle"/>
        <label>Caption</label>
        <textarea id="metaCaption"></textarea>
        <div class="row">
          <div style="flex:1"><label>Latitude</label><input id="metaLat" type="number" step="0.000001"/></div>
          <div style="flex:1"><label>Longitude</label><input id="metaLng" type="number" step="0.000001"/></div>
        </div>
        <label>Radius (m)</label>
        <input id="metaRadius" type="number" min="1" max="1000"/>
        <button id="saveMeta" class="btn" style="margin-top:8px">Save Meta</button>
      </div>

      <div class="card panel">
        <strong>Photos</strong>
        <div id="thumbs" class="thumbs" style="margin-top:8px"></div>
      </div>

      <div class="card panel">
        <strong>Overlays</strong>
        <div id="overlayMenu"></div>
      </div>
    </div>

    <div class="col">
      <div id="stageWrap" class="card">
        <img id="baseImg" alt="Selected photo" />
        <canvas id="overlayCanvas"></canvas>
      </div>
    </div>

    <div class="col">
      <div class="card panel">
        <strong>Overlay Tools</strong>
        <div class="row"><button id="flipH" class="btn secondary">Flip H</button><button id="flipV" class="btn secondary">Flip V</button><button id="clearAll" class="btn danger">Clear All</button></div>
        <div class="row" style="margin-top:8px"><input id="eraserToggle" type="checkbox"/> <label for="eraserToggle">Eraser</label><label style="margin-left:auto">Size <input id="brushSize" type="range" min="4" max="64" value="18"/></label><label>Opacity <input id="brushOpacity" type="range" min="0.1" max="1" step="0.05" value="1"/></label></div>
        <button id="saveImageToRTDB" class="btn" style="margin-top:8px">Save Image to RTDB</button>
      </div>
    </div>
  </div>

  <div id="savingHUD"><div class="modal"><div class="spin"></div><div>Saving…</div></div></div>

  <script type="module">
    const overlayMenu=$('overlayMenu');
    const overlayList=[
      'people/person1.png','people/person2.png','people/person3.png',
      'cars/car1.png','cars/car2.png','cars/car3.png','cars/car4.png',
      'fire/fire1.png','fire/fire2.png','fire/fire3.png','fire/fire4.png','fire/fire5.png','fire/fire6.png','fire/fire7.png','fire/fire8.png',
      'smoke/smoke1.png','smoke/smoke2.png','smoke/smoke3.png','smoke/smoke4.png']
      .map(p=>`https://fireopssim.com/geophoto/overlays/${p}`);

    overlayList.forEach(url=>{
      const btn=document.createElement('div');
      btn.className='overlayBtn';
      const img=document.createElement('img'); img.src=url; btn.appendChild(img);
      btn.onclick=()=>addOverlay(url);
      overlayMenu.appendChild(btn);
    });

    function addOverlay(url){
      const s=stops[idx]; if(!s) return; ensureOverlayModel(s);
      s.overlays.push({id:Date.now(), type:'bitmap', x:0.3, y:0.3, w:0.4, h:0.4, flipH:false, flipV:false, opacity:1, data:{format:'png',data:url}});
      drawOverlays(); saveOverlaysDebounced();
    }
  </script>
</body>
</html>
