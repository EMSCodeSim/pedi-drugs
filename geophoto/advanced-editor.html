<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo Scenarios ‚Äî Advanced Editor (Desktop)</title>
<style>
  :root{
    --bg:#0a0f14; --panel:#0f1820; --surface:#0f1820; --muted:#9bc6d2; --text:#eaf7fb; --border:#244656;
    --accent:#2dd4bf; --accentText:#042e2a; --danger:#ff6b6b; --warn:#ffc857; --br:14px; --shadow:0 8px 28px rgba(0,0,0,.45);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5fbff; --panel:#ffffff; --surface:#ffffff; --muted:#4f6b78; --text:#0b1e27; --border:#d3e5ec; --shadow:0 8px 28px rgba(0,0,0,.08) }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:10px 14px;border-bottom:1px solid var(--border);background:color-mix(in hsl, var(--bg) 88%, transparent);backdrop-filter:blur(6px)}
  h1{margin:0;font-size:18px}
  .app{display:grid;grid-template-columns:320px 1fr 320px;gap:12px;padding:12px;max-height:calc(100vh - 58px)}
  .col{background:var(--surface);border:1px solid var(--border);border-radius:var(--br);box-shadow:var(--shadow);padding:12px;overflow:auto}
  label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
  select,input,textarea,button{font-size:14px}
  select,input[type="text"],textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0d2430;color:var(--text);outline:none
  }
  textarea{min-height:72px;resize:vertical}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;background:var(--accent);color:var(--accentText);font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:transparent;color:var(--text);border:2px dashed var(--border)}
  .btn.warn{background:var(--warn);color:#2a1d00}
  .btn.danger{background:var(--danger);color:#2a0a0a}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid var(--border);cursor:pointer}
  .thumb.active{outline:3px solid var(--accent)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  .spacer{height:10px}
  .sectionTitle{font-weight:800;margin:6px 0}
  .canvasWrap{position:relative;background:#061621;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  #c{display:block;width:100%;height:calc(100vh - 160px);background:transparent}
  .bar{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:var(--border);opacity:.6;margin:10px 0}
  .hidden{display:none}
  .desktopGate{max-width:740px;margin:48px auto;background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}

  /* Readability overrides for inputs/dropdowns/placeholders */
  select, input, textarea { color: var(--text) !important; background: var(--panel) !important; border-color: var(--border) !important; }
  select option { color: #0b1e27; }
  @media (prefers-color-scheme: dark){ select option { color:#eaf7fb; background:#0d2430; } }
  ::placeholder { color: color-mix(in srgb, var(--muted) 90%, transparent); opacity: 1; }

  /* Overlay shelf */
  .olThumb {
    width: 100%; aspect-ratio: 1/1; border-radius: 10px; border:1px solid var(--border);
    background:#0b2130; display:flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .olThumb img { max-width: 88%; max-height: 88%; display:block; }
  .ol-tab.active { outline:3px solid var(--accent); }
</style>
</head>
<body>
<header><h1>Geo Scenarios ‚Äî Advanced Editor (Desktop Only)</h1></header>

<div id="gate" class="desktopGate hidden">
  <h2 style="margin:0 0 8px">Use a computer to edit</h2>
  <p>This advanced editor is intended for desktop/laptop. If you‚Äôre on a touchscreen laptop or a narrow window, you can still proceed.</p>
  <div class="row" style="margin-top:10px">
    <button id="forceGo" class="btn">Continue anyway</button>
  </div>
  <p class="pill" id="gateInfo">Gate check‚Ä¶</p>
</div>

<div id="app" class="app hidden">
  <!-- Left: load/select -->
  <div class="col" id="leftCol">
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="statusPill">Loading‚Ä¶</div>
      <button id="refresh" class="btn secondary">Refresh</button>
    </div>
    <label>Scenario</label>
    <select id="scenarioSel"><option value="">Loading‚Ä¶</option></select>
    <div class="spacer"></div>
    <div class="row">
      <div class="pill" id="metaTitle">(title)</div>
      <div class="pill" id="metaDispatch">Dispatch: (none)</div>
    </div>
    <div class="divider"></div>
    <div class="sectionTitle">Photos in scenario</div>
    <div id="stopList" class="row"></div>
    <div class="divider"></div>
    <div class="sectionTitle">Selected stop meta</div>
    <label>Title</label><input id="stopTitle" type="text" placeholder="Stop title">
    <label>Caption</label><textarea id="stopCaption" placeholder="Caption / text"></textarea>
    <div class="row">
      <div style="flex:1">
        <label>Latitude</label><input id="stopLat" type="text" placeholder="e.g. 39.7392">
      </div>
      <div style="flex:1">
        <label>Longitude</label><input id="stopLng" type="text" placeholder="-104.9903">
      </div>
    </div>
    <label>Radius (meters)</label><input id="stopRadius" type="text" placeholder="50">
    <div class="row" style="margin-top:6px">
      <button id="useGPS" class="btn secondary">Use my location</button>
      <button id="saveMeta" class="btn">Save Meta</button>
    </div>
    <div id="metaMsg" class="pill" style="margin-top:6px">Ready</div>
    <div class="divider"></div>
    <div class="row">
      <input id="replaceFile" type="file" accept="image/*">
      <button id="replaceApply" class="btn">Replace Image</button>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="deleteStop" class="btn danger">Delete This Photo</button>
      <button id="exportPNG" class="btn secondary">Export PNG</button>
    </div>
  </div>

  <!-- Center: canvas -->
  <div class="col">
    <div class="bar" style="margin-bottom:8px">
      <button id="fit" class="btn secondary">Fit</button>
      <button id="zoomIn" class="btn secondary">Zoom +</button>
      <button id="zoomOut" class="btn secondary">Zoom ‚àí</button>
      <button id="rotateL" class="btn secondary">Rotate ‚ü≤</button>
      <button id="rotateR" class="btn secondary">Rotate ‚ü≥</button>
      <button id="flipH" class="btn secondary">Flip H</button>
      <button id="flipV" class="btn secondary">Flip V</button>
      <span class="pill" id="canvasInfo">Canvas</span>
      <button id="saveImage" class="btn">Save Image to RTDB</button>
    </div>
    <div class="canvasWrap">
      <canvas id="c"></canvas>
    </div>
  </div>

  <!-- Right: crop + overlays -->
  <div class="col">
    <div class="sectionTitle">Crop</div>
    <div class="row">
      <button id="cropStart" class="btn warn">Start Crop</button>
      <button id="cropApply" class="btn">Apply</button>
      <button id="cropCancel" class="btn secondary">Cancel</button>
    </div>
    <div class="divider"></div>

    <div class="sectionTitle">Overlays</div>
    <div class="row" style="gap:6px; flex-wrap:nowrap; overflow:auto">
      <button class="btn secondary ol-tab" data-cat="fire">üî• Fire</button>
      <button class="btn secondary ol-tab" data-cat="smoke">üå´Ô∏è Smoke</button>
      <button class="btn secondary ol-tab" data-cat="people">üßç People</button>
      <button class="btn secondary ol-tab" data-cat="cars">üöó Cars</button>
      <button class="btn secondary ol-tab" data-cat="hazard">‚ö†Ô∏è Hazard</button>
    </div>
    <div id="overlayShelf" style="margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>

    <label style="margin-top:10px">Selected overlay opacity</label>
    <input id="overlayOpacity" type="range" min="0.05" max="1" step="0.05" value="1">
    <div class="row" style="margin-top:8px">
      <button id="bringFront" class="btn secondary">Bring to Front</button>
      <button id="sendBack" class="btn secondary">Send to Back</button>
      <button id="deleteObj" class="btn danger">Delete Selected</button>
    </div>

    <div class="divider"></div>
    <div class="sectionTitle">Hints</div>
    <ul style="margin:6px 0 0 18px; color:var(--muted)">
      <li>Drag overlays to move; handles to rotate/resize.</li>
      <li>Use <b>Save Image to RTDB</b> to commit edits.</li>
      <li>Crop is non-destructive until you click <b>Apply</b>.</li>
    </ul>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="module">
(async () => {
  // ----- Desktop gate (relaxed) -----
  const gate=document.getElementById('gate');
  const app=document.getElementById('app');
  const gateInfo=document.getElementById('gateInfo');
  const forceGo=document.getElementById('forceGo');

  const urlForce = new URLSearchParams(location.search).get('force') === '1';
  function decideGate(){
    const coarse = matchMedia('(pointer: coarse)').matches;
    const narrow = window.innerWidth < 1024;
    gateInfo.textContent = `pointer: ${coarse?'coarse':'fine'} ‚Ä¢ width: ${window.innerWidth}px`;
    if (urlForce || (!narrow)) { gate.classList.add('hidden'); app.classList.remove('hidden'); return; }
    gate.classList.remove('hidden'); app.classList.add('hidden');
  }
  forceGo.onclick=()=>{ history.replaceState(null,'',location.pathname); app.classList.remove('hidden'); gate.classList.add('hidden'); };
  decideGate();
  window.addEventListener('resize', decideGate);

  // ----- Firebase -----
  const [{ initializeApp }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js") ]);
  const [{ getDatabase, ref, onValue, get, set }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js") ]);
  const firebaseConfig = {
    apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
    authDomain:"dailyquiz-d5279.firebaseapp.com",
    databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
    projectId:"dailyquiz-d5279",
    appId:"1:94577748034:web:c032d3a1d72db1313de5db",
    measurementId:"G-19DVN7NNH7"
  };
  const appFB = initializeApp(firebaseConfig);
  const db = getDatabase(appFB);

  // ----- DOM refs -----
  const statusPill=document.getElementById('statusPill');
  const scenarioSel=document.getElementById('scenarioSel');
  const stopList=document.getElementById('stopList');
  const refreshBtn=document.getElementById('refresh');

  const metaTitle=document.getElementById('metaTitle');
  const metaDispatch=document.getElementById('metaDispatch');

  const stopTitle=document.getElementById('stopTitle');
  const stopCaption=document.getElementById('stopCaption');
  const stopLat=document.getElementById('stopLat');
  const stopLng=document.getElementById('stopLng');
  const stopRadius=document.getElementById('stopRadius');
  const useGPS=document.getElementById('useGPS');
  const saveMeta=document.getElementById('saveMeta');
  const metaMsg=document.getElementById('metaMsg');

  const replaceFile=document.getElementById('replaceFile');
  const replaceApply=document.getElementById('replaceApply');
  const deleteStop=document.getElementById('deleteStop');
  const exportPNG=document.getElementById('exportPNG');

  const cInfo=document.getElementById('canvasInfo');
  const fitBtn=document.getElementById('fit');
  const zoomIn=document.getElementById('zoomIn');
  const zoomOut=document.getElementById('zoomOut');
  const rotateL=document.getElementById('rotateL');
  const rotateR=document.getElementById('rotateR');
  const flipH=document.getElementById('flipH');
  const flipV=document.getElementById('flipV');
  const saveImage=document.getElementById('saveImage');

  const cropStart=document.getElementById('cropStart');
  const cropApply=document.getElementById('cropApply');
  const cropCancel=document.getElementById('cropCancel');

  const overlayShelf = document.getElementById('overlayShelf');
  const tabBtns = Array.from(document.querySelectorAll('.ol-tab'));
  const overlayOpacity=document.getElementById('overlayOpacity');
  const bringFront=document.getElementById('bringFront');
  const sendBack=document.getElementById('sendBack');
  const deleteObj=document.getElementById('deleteObj');

  // ----- State -----
  let scenarios=[], current=null, stopIndex=-1;
  let fabricCanvas, baseImage=null, cropRect=null, cropMode=false;

  // ----- Fabric canvas -----
  fabricCanvas = new fabric.Canvas('c', { backgroundColor:'#061621', preserveObjectStacking:true, selection:true });
  function fitCanvas(){
    fabricCanvas.setHeight(window.innerHeight - 160);
    fabricCanvas.setWidth(document.querySelector('.col:nth-child(2)').clientWidth - 24);
    fabricCanvas.calcOffset();
    fabricCanvas.requestRenderAll();
  }
  fitCanvas();
  window.addEventListener('resize', fitCanvas);

  function setBaseImageFromDataURL(dataURL){
    return new Promise((resolve,reject)=>{
      fabric.Image.fromURL(dataURL, (img)=>{
        if (!img) { reject(new Error('Image load failed')); return; }
        if (baseImage) fabricCanvas.remove(baseImage);
        baseImage = img;
        baseImage.selectable=false; baseImage.evented=false;
        const cw=fabricCanvas.getWidth(), ch=fabricCanvas.getHeight();
        const scale=Math.min(cw/img.width, ch/img.height);
        baseImage.scale(scale);
        baseImage.set({ left:(cw - img.width*scale)/2, top:(ch - img.height*scale)/2 });
        fabricCanvas.add(baseImage);
        baseImage.moveTo(0);
        fabricCanvas.requestRenderAll();
        cInfo.textContent=`Image ${Math.round(img.width)}√ó${Math.round(img.height)} (scale ${scale.toFixed(2)})`;
        resolve();
      }, { crossOrigin:'anonymous' });
    });
  }
  const dataURLFromCanvas = () => fabricCanvas.toDataURL({ format:'png', quality:0.92 });

  // ----- Scenario loading (robust with diagnostics) -----
  function showStatus(msg){ statusPill.textContent = msg; }
  function populateList(){
    scenarioSel.innerHTML = '<option value="">Select scenario‚Ä¶</option>';
    scenarios.forEach(sc => {
      const o=document.createElement('option');
      o.value=sc.id;
      o.textContent=(sc.title||'(untitled)') + (sc.active? '':' (inactive)');
      scenarioSel.appendChild(o);
    });
  }
  function renderStopsThumbs(){
    stopList.innerHTML='';
    if(!current?.stops?.length){ stopList.innerHTML='<div class="pill">No photos</div>'; return; }
    current.stops.forEach((s,idx)=>{
      const img=document.createElement('img');
      img.className='thumb'+(idx===stopIndex?' active':'');
      img.src=s.imageData||s.imageURL||'';
      img.title=s.title||`Stop ${idx+1}`;
      img.onerror=()=>{ img.src="data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='#0a2230'/><text x='50%' y='50%' fill='#9ecbd6' font-size='10' text-anchor='middle'>no image</text></svg>"); };
      img.onclick=()=>loadStop(idx);
      stopList.appendChild(img);
    });
  }
  function updateMetaHeader(){
    metaTitle.textContent=current ? (current.title||'(untitled)') : '(title)';
    metaDispatch.textContent='Dispatch: ' + (current?.dispatch ? String(current.dispatch).slice(0,120) : '(none)');
  }

  try {
    const scenariosRef = ref(db,'scenarios');
    onValue(scenariosRef, snap=>{
      const v = snap.val() || {};
      scenarios = Object.entries(v).map(([id,s])=>({id,...s})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      populateList();
      showStatus(`${scenarios.length} scenario(s) loaded`);
      if (current) {
        const fresh=scenarios.find(sc=>sc.id===current.id);
        if (fresh){ current=fresh; renderStopsThumbs(); updateMetaHeader(); }
      }
    }, err => { showStatus('RTDB onValue error: '+(err?.message||err)); });

    // one-time get with timeout (diagnostics)
    const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error('RTDB timeout (8s)')),8000));
    await Promise.race([ get(scenariosRef), timeout ]).then(snap=>{
      if (!snap.exists()) showStatus('Connected but /scenarios is empty.');
    }).catch(e=> showStatus('RTDB connection issue: '+e.message));
  } catch (e) {
    showStatus('Firebase init/permission error: ' + (e?.message||e));
  }

  refreshBtn.onclick = populateList;

  // ----- Select scenario & load stop -----
  scenarioSel.onchange = ()=>{
    const id=scenarioSel.value;
    current = scenarios.find(s=>s.id===id) || null;
    stopIndex=-1;
    updateMetaHeader();
    renderStopsThumbs();
    fabricCanvas.clear(); baseImage=null; cropRect=null; cropMode=false;
    fitCanvas();
  };

  async function loadStop(idx){
    if(!current) return;
    const s=current.stops[idx]; if(!s) return;
    stopIndex=idx;
    stopTitle.value=s.title||'';
    stopCaption.value=s.caption||'';
    stopLat.value=(s.lat ?? '').toString();
    stopLng.value=(s.lng ?? '').toString();
    stopRadius.value=(s.radiusMeters ?? 50).toString();
    Array.from(stopList.children).forEach((n,i)=>n.classList.toggle('active', i===idx));
    fabricCanvas.clear(); baseImage=null; cropRect=null; cropMode=false;
    const src=s.imageData||s.imageURL;
    if(!src){ metaMsg.textContent='No image in this stop.'; return; }
    await setBaseImageFromDataURL(src);
  }

  // ----- Meta save / GPS -----
  useGPS.onclick=()=>{
    navigator.geolocation.getCurrentPosition(p=>{
      stopLat.value=p.coords.latitude.toFixed(6);
      stopLng.value=p.coords.longitude.toFixed(6);
      metaMsg.textContent='GPS captured.';
    }, e=>{ metaMsg.textContent='GPS error: '+e.message; }, { enableHighAccuracy:true, timeout:10000 });
  };
  saveMeta.onclick=async()=>{
    try{
      if(!current || stopIndex<0) throw new Error('Select a stop first.');
      const s=current.stops[stopIndex];
      s.title=stopTitle.value.trim();
      s.caption=stopCaption.value.trim();
      s.lat=parseFloat(stopLat.value);
      s.lng=parseFloat(stopLng.value);
      s.radiusMeters=Math.max(5, parseInt(stopRadius.value||'50',10));
      if(Number.isNaN(s.lat)||Number.isNaN(s.lng)) throw new Error('Invalid GPS coordinates.');
      const { id, ...payload } = current;
      await set(ref(db,'scenarios/'+current.id), payload);
      metaMsg.textContent='Meta saved.';
    }catch(err){ metaMsg.textContent=String(err.message||err); }
  };

  // ----- Replace / Export / Save image -----
  function readFileAsDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
  replaceApply.onclick=async()=>{
    const f=replaceFile.files?.[0]; if(!f){ metaMsg.textContent='Choose a file first.'; return; }
    const data=await readFileAsDataURL(f);
    await setBaseImageFromDataURL(data);
  };
  exportPNG.onclick=()=>{
    const url=dataURLFromCanvas();
    const a=document.createElement('a'); a.href=url; a.download=(current?.title||'image')+'-edited.png'; a.click();
  };
  saveImage.onclick=async()=>{
    try{
      if(!current || stopIndex<0) throw new Error('Select a stop first.');
      const url=dataURLFromCanvas();
      current.stops[stopIndex].imageData=url;
      current.stops[stopIndex].imageURL=null;
      const { id, ...payload } = current;
      await set(ref(db,'scenarios/'+current.id), payload);
      metaMsg.textContent='Image saved to RTDB.';
      renderStopsThumbs();
    }catch(err){ metaMsg.textContent=String(err.message||err); }
  };

  // ----- Canvas commands -----
  const rebase = ()=>{ if(!baseImage) return; setBaseImageFromDataURL(baseImage.toDataURL({})); };
  fitBtn.onclick=rebase;
  zoomIn.onclick=()=>fabricCanvas.setZoom(fabricCanvas.getZoom()*1.1);
  zoomOut.onclick=()=>fabricCanvas.setZoom(fabricCanvas.getZoom()/1.1);
  rotateL.onclick=()=>{ if(baseImage){ baseImage.rotate((baseImage.angle||0)-90); fabricCanvas.requestRenderAll(); } };
  rotateR.onclick=()=>{ if(baseImage){ baseImage.rotate((baseImage.angle||0)+90); fabricCanvas.requestRenderAll(); } };
  flipH.onclick=()=>{ if(baseImage){ baseImage.toggle('flipX'); fabricCanvas.requestRenderAll(); } };
  flipV.onclick=()=>{ if(baseImage){ baseImage.toggle('flipY'); fabricCanvas.requestRenderAll(); } };

  // ----- Crop workflow -----
  cropStart.onclick=()=>{
    if(!baseImage) return;
    cropMode=true;
    cropRect = new fabric.Rect({
      left: baseImage.left + 20, top: baseImage.top + 20,
      width: Math.min(200, baseImage.getScaledWidth()-40),
      height: Math.min(200, baseImage.getScaledHeight()-40),
      fill: 'rgba(0,0,0,0.15)', stroke:'#2dd4bf', strokeWidth:2, hasRotatingPoint:false
    });
    fabricCanvas.add(cropRect); cropRect.bringToFront(); fabricCanvas.setActiveObject(cropRect);
  };
  cropCancel.onclick=()=>{
    cropMode=false; if(cropRect){ fabricCanvas.remove(cropRect); cropRect=null; } fabricCanvas.discardActiveObject(); fabricCanvas.requestRenderAll();
  };
  cropApply.onclick=()=>{
    if(!baseImage || !cropRect) return;
    const scale = baseImage.scaleX;
    const bx = baseImage.left, by = baseImage.top;
    const rw = cropRect.width * cropRect.scaleX, rh = cropRect.height * cropRect.scaleY;
    const rx = cropRect.left - bx, ry = cropRect.top - by;
    const sx = rx / scale, sy = ry / scale, sw = rw / scale, sh = rh / scale;
    const el = document.createElement('canvas'); el.width=Math.max(1,Math.round(sw)); el.height=Math.max(1,Math.round(sh));
    const ctx = el.getContext('2d');
    const angle = (baseImage.angle||0) % 360;
    if (angle !== 0) {
      const fullURL = fabricCanvas.toDataURL({ format:'png', quality:1 });
      const tmp = new Image(); tmp.onload=()=>{
        const scaleX = tmp.width / fabricCanvas.getWidth();
        const scaleY = tmp.height / fabricCanvas.getHeight();
        ctx.drawImage(tmp, cropRect.left*scaleX, cropRect.top*scaleY, rw*scaleX, rh*scaleY, 0,0, el.width, el.height);
        setBaseImageFromDataURL(el.toDataURL('image/png', 0.95)).then(()=>{ fabricCanvas.remove(cropRect); cropRect=null; cropMode=false; });
      }; tmp.src=fullURL; return;
    } else {
      const base = baseImage.getElement();
      ctx.drawImage(base, sx, sy, sw, sh, 0,0, el.width, el.height);
      setBaseImageFromDataURL(el.toDataURL('image/png', 0.95)).then(()=>{ fabricCanvas.remove(cropRect); cropRect=null; cropMode=false; });
    }
  };

  /* ===== Realistic Overlays (SVG data URIs with multiple choices) ===== */
  const SPRITES = {
    fire: [
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs>
            <radialGradient id="g" cx="50%" cy="60%" r="60%">
              <stop offset="0%" stop-color="#ffe082"/>
              <stop offset="40%" stop-color="#ff8f00"/>
              <stop offset="80%" stop-color="#e65100"/>
              <stop offset="100%" stop-color="#bf360c"/>
            </radialGradient>
            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="6" result="b"/>
              <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
          <path d="M256,480 C200,440 140,380 140,300 c0-64 40-104 70-140 16-20 24-48 18-80 50,40 82,90 82,138 0-36 22-62 50-92-4,44 4,74 20,92 24,26 44,60 44,92 0,80-64,132-168,170z" fill="url(#g)" filter="url(#glow)"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs>
            <radialGradient id="g2" cx="50%" cy="70%" r="70%">
              <stop offset="0%" stop-color="#fff59d"/>
              <stop offset="45%" stop-color="#ff9800"/>
              <stop offset="85%" stop-color="#e65100"/>
            </radialGradient>
            <filter id="glow2"><feGaussianBlur stdDeviation="5"/></filter>
          </defs>
          <path d="M256,480 C176,430 128,360 128,280 c0-70 50-120 92-160 10-10 16-36 14-68 54,44 96,100 96,156 0-22 20-56 54-90-8,46-2,80 18,100 26,26 38,60 38,88 0,86-66,138-184,174z" fill="url(#g2)" filter="url(#glow2)"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs>
            <radialGradient id="g3" cx="50%" cy="60%" r="65%">
              <stop offset="0%" stop-color="#fff3e0"/>
              <stop offset="40%" stop-color="#ffb300"/>
              <stop offset="75%" stop-color="#f57c00"/>
              <stop offset="100%" stop-color="#d84315"/>
            </radialGradient>
          </defs>
          <path d="M256,470 C160,420 120,360 120,290 c0-64 44-106 84-142 16-14 22-44 20-70 42,30 92,92 92,144 0-30 26-66 64-96-8,48 2,78 20,96 24,24 42,58 42,90 0,80-60,126-186,158z" fill="url(#g3)"/>
        </svg>
      `),
    ],
    smoke: [
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs>
            <filter id="blur" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="10"/>
            </filter>
            <radialGradient id="sm" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#ffffff" stop-opacity="0.5"/>
              <stop offset="100%" stop-color="#9ea7ac" stop-opacity="0.2"/>
            </radialGradient>
          </defs>
          <g filter="url(#blur)" fill="url(#sm)">
            <ellipse cx="200" cy="340" rx="120" ry="90"/>
            <ellipse cx="280" cy="300" rx="140" ry="100" opacity="0.8"/>
            <ellipse cx="340" cy="240" rx="110" ry="80" opacity="0.7"/>
          </g>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs>
            <filter id="blur2"><feGaussianBlur stdDeviation="12"/></filter>
            <linearGradient id="sm2" x1="0" x2="0" y1="1" y2="0">
              <stop offset="0%" stop-color="#b0b6bb" stop-opacity="0.2"/>
              <stop offset="100%" stop-color="#ffffff" stop-opacity="0.5"/>
            </linearGradient>
          </defs>
          <path d="M180,440c-40-60 20-90 20-130s-40-50-20-100 80-40 120,0 10,80 30,120 60,40 40,100c-20,60-150,60-190,10z" fill="url(#sm2)" filter="url(#blur2)"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs><filter id="blur3"><feGaussianBlur stdDeviation="8"/></filter></defs>
          <g filter="url(#blur3)" fill="#c7ccd1" fill-opacity="0.25">
            <ellipse cx="180" cy="360" rx="150" ry="60"/>
            <ellipse cx="320" cy="360" rx="160" ry="58"/>
            <ellipse cx="260" cy="330" rx="120" ry="46" fill-opacity="0.3"/>
          </g>
        </svg>
      `),
    ],
    people: [
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 400">
          <g fill="#1de9b6">
            <circle cx="100" cy="60" r="34"/>
            <path d="M60,140 h80 v60 h-20 v120 h-20 v-120 h-20z"/>
            <path d="M60,210 h-30 v-20 h30z"/>
            <path d="M140,210 h30 v-20 h-30z"/>
          </g>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 400">
          <g fill="#e0e0e0">
            <circle cx="100" cy="55" r="32"/>
            <path d="M70,130 h60 v70 h-16 v120 h-28 v-120 h-16z" />
            <path d="M70,210 h-28 v-18 h28z"/>
            <path d="M130,210 h28 v-18 h-28z"/>
          </g>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 400">
          <defs><linearGradient id="vest" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ffea00"/><stop offset="100%" stop-color="#ff6f00"/></linearGradient></defs>
          <g>
            <circle cx="100" cy="58" r="32" fill="#fafafa"/>
            <path d="M60,120 h80 v70 h-24 v120 h-32 v-120 h-24z" fill="url(#vest)"/>
            <rect x="86" y="150" width="28" height="26" fill="#212121"/>
          </g>
        </svg>
      `),
    ],
    cars: [
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 220">
          <rect x="40" y="120" width="420" height="60" rx="20" fill="#90caf9"/>
          <path d="M80,120 c40-50,120-70,220-70 h50 c30,0,50,20,60,70z" fill="#64b5f6"/>
          <circle cx="140" cy="190" r="24" fill="#212121"/><circle cx="360" cy="190" r="24" fill="#212121"/>
          <rect x="220" y="70" width="100" height="40" fill="#e3f2fd"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 520 240">
          <rect x="50" y="120" width="420" height="70" rx="16" fill="#a5d6a7"/>
          <path d="M90,120 c30-60,140-80,240-80 h40 c30,0,60,20,70,80z" fill="#81c784"/>
          <circle cx="150" cy="200" r="26" fill="#263238"/><circle cx="380" cy="200" r="26" fill="#263238"/>
          <rect x="240" y="60" width="110" height="44" fill="#e8f5e9"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 520 240">
          <rect x="50" y="120" width="420" height="66" rx="14" fill="#ef5350"/>
          <path d="M90,120 c30-60,140-80,240-80 h40 c30,0,60,20,70,80z" fill="#e53935"/>
          <circle cx="150" cy="196" r="26" fill="#212121"/><circle cx="380" cy="196" r="26" fill="#212121"/>
          <rect x="240" y="60" width="110" height="44" fill="#ffcdd2"/>
        </svg>
      `),
    ],
    hazard: [
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 128">
          <defs><pattern id="diag" width="40" height="40" patternUnits="userSpaceOnUse" patternTransform="skewX(-20)">
            <rect width="40" height="40" fill="#ffc107"/>
            <path d="M-10,40 0,0 10,0 0,40z M30,40 40,0 50,0 40,40z" fill="#212121" opacity="0.75"/>
          </pattern></defs>
          <rect x="8" y="44" width="496" height="40" fill="url(#diag)" rx="6"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 220">
          <rect x="20" y="180" width="160" height="24" rx="8" fill="#6d4c41"/>
          <path d="M100,20 l60,160 h-120z" fill="#ff6f00"/>
          <rect x="80" y="120" width="40" height="20" fill="#ffcc80"/>
          <rect x="90" y="80" width="20" height="16" fill="#ffe0b2"/>
        </svg>
      `),
      `data:image/svg+xml;utf8,` + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 220">
          <rect x="10" y="10" width="200" height="200" rx="16" fill="#ffeb3b" stroke="#212121" stroke-width="10"/>
          <path d="M110,90 a20,20 0 1,0 0.1,0 z" fill="#212121"/>
          <path d="M110,50 c40,0 40,40 70,40 -30,0 -30,40 -70,40 -40,0 -40-40 -70-40 30,0 30-40 70-40z" fill="none" stroke="#212121" stroke-width="12"/>
        </svg>
      `),
    ],
  };

  function renderShelf(cat) {
    overlayShelf.innerHTML = '';
    const items = SPRITES[cat] || [];
    items.forEach((uri, i) => {
      const div = document.createElement('div');
      div.className = 'olThumb';
      const img = document.createElement('img');
      img.src = uri; img.alt = `${cat}-${i+1}`;
      div.appendChild(img);
      div.onclick = () => addOverlayImage(uri);
      overlayShelf.appendChild(div);
    });
  }
  tabBtns.forEach(btn => btn.onclick = () => {
    tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderShelf(btn.dataset.cat);
  });
  if (tabBtns[0]) { tabBtns[0].classList.add('active'); renderShelf(tabBtns[0].dataset.cat); }

  function addOverlayImage(dataURI) {
    fabric.Image.fromURL(dataURI, img => {
      const cw = fabricCanvas.getWidth(), ch = fabricCanvas.getHeight();
      const targetW = cw * 0.25;
      const scale = targetW / img.width;
      img.scale(scale);
      img.set({
        left: cw/2 - (img.width*scale)/2,
        top:  ch/2 - (img.height*scale)/2,
        cornerStyle:'circle', transparentCorners:false,
        shadow:'rgba(0,0,0,0.35) 0 6px 16px'
      });
      fabricCanvas.add(img);
      fabricCanvas.setActiveObject(img);
      fabricCanvas.requestRenderAll();
    }, { crossOrigin:'anonymous' });
  }

  overlayOpacity.oninput = (e)=>{ const o=fabricCanvas.getActiveObject(); if(o){ o.set('opacity', parseFloat(e.target.value)); fabricCanvas.requestRenderAll(); } };
  bringFront.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o){ o.bringToFront(); fabricCanvas.requestRenderAll(); } };
  sendBack.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o){ o.sendToBack(); if(baseImage) baseImage.sendToBack(); fabricCanvas.requestRenderAll(); } };
  deleteObj.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ fabricCanvas.remove(o); fabricCanvas.discardActiveObject(); fabricCanvas.requestRenderAll(); } };

  // ----- Delete stop -----
  deleteStop.onclick=async()=>{
    try{
      if(!current || stopIndex<0) return;
      if(!confirm('Delete this photo from the scenario?')) return;
      current.stops.splice(stopIndex,1);
      const { id, ...payload } = current;
      await set(ref(db,'scenarios/'+current.id), payload);
      stopIndex=-1; fabricCanvas.clear(); baseImage=null; renderStopsThumbs(); metaMsg.textContent='Photo deleted.';
    }catch(e){ metaMsg.textContent=String(e.message||e); }
  };

})();
</script>
</body>
</html>
