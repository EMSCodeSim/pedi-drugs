<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo Scenarios ‚Äî Advanced Editor (Desktop)</title>
<style>
  :root{
    --bg:#0a0f14; --panel:#0f1820; --surface:#0f1820; --muted:#9bc6d2; --text:#eaf7fb; --border:#244656;
    --accent:#2dd4bf; --accentText:#042e2a; --danger:#ff6b6b; --warn:#ffc857; --br:14px; --shadow:0 8px 28px rgba(0,0,0,.45);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5fbff; --panel:#ffffff; --surface:#ffffff; --muted:#4f6b78; --text:#0b1e27; --border:#d3e5ec; --shadow:0 8px 28px rgba(0,0,0,.08) }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:10px 14px;border-bottom:1px solid var(--border);background:#0d1822}
  h1{margin:0;font-size:18px}
  .app{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;padding:12px;max-height:calc(100vh - 58px)}
  .col{background:var(--surface);border:1px solid var(--border);border-radius:var(--br);box-shadow:var(--shadow);padding:12px;overflow:auto}
  label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
  select,input,textarea,button{font-size:14px}
  select,input[type="text"],textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0d2430;color:var(--text);outline:none
  }
  textarea{min-height:72px;resize:vertical}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;background:var(--accent);color:var(--accentText);font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:transparent;color:var(--text);border:2px dashed var(--border)}
  .btn.warn{background:var(--warn);color:#2a1d00}
  .btn.danger{background:var(--danger);color:#2a0a0a}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid var(--border);cursor:pointer}
  .thumb.active{outline:3px solid var(--accent)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  .spacer{height:10px}
  .sectionTitle{font-weight:800;margin:6px 0}
  .canvasWrap{position:relative;background:#061621;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  #c{display:block;width:100%;height:calc(100vh - 160px);background:transparent}
  .bar{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:var(--border);opacity:.6;margin:10px 0}
  .hidden{display:none}
  .desktopGate{max-width:740px;margin:48px auto;background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}
  /* form readability */
  select, input, textarea { color: var(--text) !important; background: var(--panel) !important; border-color: var(--border) !important; }
  select option { color:#0b1e27; }
  @media (prefers-color-scheme: dark){ select option { color:#eaf7fb; background:#0d2430; } }
  ::placeholder { color: #7fb2c1; opacity: 1; }
  /* overlay shelf */
  .olThumb { width:100%; aspect-ratio:1/1; border-radius:10px; border:1px solid var(--border);
             background:#0b2130; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .olThumb img { max-width:88%; max-height:88%; display:block; }
  .ol-tab.active { outline:3px solid var(--accent); }
  /* error banner */
  #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;max-width:80vw;display:none;z-index:9999}
</style>
</head>
<body>
<header><h1>Geo Scenarios ‚Äî Advanced Editor (Desktop Only)</h1></header>
<div id="errbar"></div>

<!-- Desktop gate -->
<div id="gate" class="desktopGate hidden">
  <h2 style="margin:0 0 8px">Use a computer to edit</h2>
  <p>This advanced editor is intended for desktop/laptop. If you‚Äôre on a touchscreen laptop or a narrow window, you can still proceed.</p>
  <div class="row" style="margin-top:10px">
    <button id="forceGo" class="btn">Continue anyway</button>
  </div>
  <p class="pill" id="gateInfo">Gate check‚Ä¶</p>
</div>

<div id="app" class="app hidden">
  <!-- Left: scenarios + meta -->
  <div class="col" id="leftCol">
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="statusPill">Loading‚Ä¶</div>
      <button id="refresh" class="btn secondary">Refresh</button>
    </div>
    <label>Scenario</label>
    <select id="scenarioSel"><option value="">Loading‚Ä¶</option></select>
    <div class="spacer"></div>
    <div class="row">
      <div class="pill" id="metaTitle">(title)</div>
      <div class="pill" id="metaDispatch">Dispatch: (none)</div>
    </div>
    <div class="divider"></div>
    <div class="sectionTitle">Photos in scenario</div>
    <div id="stopList" class="row"></div>
    <div class="divider"></div>
    <div class="sectionTitle">Selected stop meta</div>
    <label>Title</label><input id="stopTitle" type="text" placeholder="Stop title">
    <label>Caption</label><textarea id="stopCaption" placeholder="Caption / text"></textarea>
    <div class="row">
      <div style="flex:1">
        <label>Latitude</label><input id="stopLat" type="text" placeholder="e.g. 39.7392">
      </div>
      <div style="flex:1">
        <label>Longitude</label><input id="stopLng" type="text" placeholder="-104.9903">
      </div>
    </div>
    <label>Radius (meters)</label><input id="stopRadius" type="text" placeholder="50">
    <div class="row" style="margin-top:6px">
      <button id="useGPS" class="btn secondary">Use my location</button>
      <button id="saveMeta" class="btn">Save Meta</button>
    </div>
    <div id="metaMsg" class="pill" style="margin-top:6px">Ready</div>
    <div class="divider"></div>
    <div class="row">
      <input id="replaceFile" type="file" accept="image/*">
      <button id="replaceApply" class="btn">Replace Image</button>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="deleteStop" class="btn danger">Delete This Photo</button>
      <button id="exportPNG" class="btn secondary">Export PNG</button>
    </div>
  </div>

  <!-- Center: canvas -->
  <div class="col">
    <div class="bar" style="margin-bottom:8px">
      <button id="fit" class="btn secondary">Fit</button>
      <button id="zoomIn" class="btn secondary">Zoom +</button>
      <button id="zoomOut" class="btn secondary">Zoom ‚àí</button>
      <button id="rotateL" class="btn secondary">Rotate ‚ü≤</button>
      <button id="rotateR" class="btn secondary">Rotate ‚ü≥</button>
      <span class="pill" id="canvasInfo">Canvas</span>
      <button id="saveImage" class="btn">Save Image to RTDB</button>
    </div>
    <div class="canvasWrap"><canvas id="c"></canvas></div>
  </div>

  <!-- Right: crop + overlays + eraser + overlay transforms -->
  <div class="col">
    <div class="sectionTitle">Crop</div>
    <div class="row">
      <button id="cropStart" class="btn warn">Start Crop</button>
      <button id="cropApply" class="btn">Apply</button>
      <button id="cropCancel" class="btn secondary">Cancel</button>
    </div>

    <div class="divider"></div>
    <div class="sectionTitle">Overlays</div>
    <div class="row" style="gap:6px; flex-wrap:nowrap; overflow:auto">
      <button class="btn secondary ol-tab" data-cat="fire">üî• Fire</button>
      <button class="btn secondary ol-tab" data-cat="smoke">üå´Ô∏è Smoke</button>
      <button class="btn secondary ol-tab" data-cat="people">üßç People</button>
      <button class="btn secondary ol-tab" data-cat="cars">üöó Cars</button>
      <button class="btn secondary ol-tab" data-cat="hazard">‚ö†Ô∏è Hazard</button>
    </div>
    <div id="overlayShelf" style="margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>

    <label style="margin-top:10px">Hue (selected overlay)</label>
    <input id="overlayHue" type="range" min="-180" max="180" step="1" value="0">

    <label style="margin-top:10px">Opacity</label>
    <input id="overlayOpacity" type="range" min="0.05" max="1" step="0.05" value="1">

    <div class="row" style="margin-top:8px">
      <button id="bringFront" class="btn secondary">Bring to Front</button>
      <button id="sendBack" class="btn secondary">Send to Back</button>
      <button id="deleteObj" class="btn danger">Delete Selected</button>
    </div>

    <div class="divider"></div>
    <div class="sectionTitle">Eraser (selected overlay)</div>
    <div class="row">
      <button id="eraserStart" class="btn warn">Start Erasing</button>
      <button id="eraserDone" class="btn">Finish</button>
      <button id="eraserCancel" class="btn secondary">Cancel</button>
    </div>
    <label style="margin-top:8px">Brush Size</label>
    <input id="eraserSize" type="range" min="5" max="120" step="1" value="30">
    <div class="pill" id="eraserStatus" style="margin-top:6px">Eraser: off</div>

    <div class="divider"></div>
    <div class="sectionTitle">Transform Overlay</div>
    <div class="row">
      <button id="rotSelLeft" class="btn secondary">Rotate ‚àí15¬∞</button>
      <button id="rotSelRight" class="btn secondary">Rotate +15¬∞</button>
      <button id="flipSelH" class="btn secondary">Flip H</button>
      <button id="flipSelV" class="btn secondary">Flip V</button>
    </div>
    <label style="margin-top:8px">Angle</label>
    <input id="rotSelSlider" type="range" min="-180" max="180" step="1" value="0">
  </div>
</div>

<!-- Fabric 5.x -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="module">
/* Error banner helper */
const ERR = (msg) => { const b=document.getElementById('errbar'); b.textContent=msg; b.style.display='block'; };
window.addEventListener('error', e => ERR(e.message));
window.addEventListener('unhandledrejection', e => ERR(String(e.reason?.message||e.reason||e)));

(async () => {
  /* ===== Desktop gate ===== */
  const gate=document.getElementById('gate');
  const app=document.getElementById('app');
  const gateInfo=document.getElementById('gateInfo');
  const forceGo=document.getElementById('forceGo');
  const urlForce = new URLSearchParams(location.search).get('force') === '1';
  function decideGate(){
    const narrow = window.innerWidth < 1024;
    gateInfo.textContent = `width: ${window.innerWidth}px`;
    if (urlForce || !narrow) { gate.classList.add('hidden'); app.classList.remove('hidden'); return; }
    gate.classList.remove('hidden'); app.classList.add('hidden');
  }
  forceGo.onclick=()=>{ history.replaceState(null,'',location.pathname); app.classList.remove('hidden'); gate.classList.add('hidden'); };
  decideGate(); window.addEventListener('resize', decideGate);

  /* ===== Firebase RTDB ===== */
  const [{ initializeApp }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js") ]);
  const [{ getDatabase, ref, onValue, get, set }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js") ]);
  const firebaseConfig = {
    apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
    authDomain:"dailyquiz-d5279.firebaseapp.com",
    databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
    projectId:"dailyquiz-d5279",
    appId:"1:94577748034:web:c032d3a1d72db1313de5db",
    measurementId:"G-19DVN7NNH7"
  };
  const appFB = initializeApp(firebaseConfig);
  const db = getDatabase(appFB);

  /* ===== DOM refs ===== */
  const statusPill=document.getElementById('statusPill');
  const scenarioSel=document.getElementById('scenarioSel');
  const stopList=document.getElementById('stopList');
  const refreshBtn=document.getElementById('refresh');
  const metaTitle=document.getElementById('metaTitle');
  const metaDispatch=document.getElementById('metaDispatch');
  const stopTitle=document.getElementById('stopTitle');
  const stopCaption=document.getElementById('stopCaption');
  const stopLat=document.getElementById('stopLat');
  const stopLng=document.getElementById('stopLng');
  const stopRadius=document.getElementById('stopRadius');
  const useGPS=document.getElementById('useGPS');
  const saveMeta=document.getElementById('saveMeta');
  const metaMsg=document.getElementById('metaMsg');
  const replaceFile=document.getElementById('replaceFile');
  const replaceApply=document.getElementById('replaceApply');
  const deleteStop=document.getElementById('deleteStop');
  const exportPNG=document.getElementById('exportPNG');
  const cInfo=document.getElementById('canvasInfo');
  const fitBtn=document.getElementById('fit');
  const zoomIn=document.getElementById('zoomIn');
  const zoomOut=document.getElementById('zoomOut');
  const rotateL=document.getElementById('rotateL');
  const rotateR=document.getElementById('rotateR');
  const saveImage=document.getElementById('saveImage');
  const cropStart=document.getElementById('cropStart');
  const cropApply=document.getElementById('cropApply');
  const cropCancel=document.getElementById('cropCancel');
  const overlayShelf=document.getElementById('overlayShelf');
  const tabBtns = Array.from(document.querySelectorAll('.ol-tab'));
  const overlayHue=document.getElementById('overlayHue');
  const overlayOpacity=document.getElementById('overlayOpacity');
  const bringFront=document.getElementById('bringFront');
  const sendBack=document.getElementById('sendBack');
  const deleteObj=document.getElementById('deleteObj');
  const eraserStart=document.getElementById('eraserStart');
  const eraserDone=document.getElementById('eraserDone');
  const eraserCancel=document.getElementById('eraserCancel');
  const eraserSize=document.getElementById('eraserSize');
  const eraserStatus=document.getElementById('eraserStatus');
  const rotSelLeft=document.getElementById('rotSelLeft');
  const rotSelRight=document.getElementById('rotSelRight');
  const rotSelSlider=document.getElementById('rotSelSlider');
  const flipSelH=document.getElementById('flipSelH');
  const flipSelV=document.getElementById('flipSelV');

  /* ===== State + canvas ===== */
  let scenarios=[], current=null, stopIndex=-1;
  const fabricCanvas = new fabric.Canvas('c', { backgroundColor:'#061621', preserveObjectStacking:true, selection:true });
  let baseImage=null, cropRect=null, erasing=false;  /* <‚Äî cropRect declared ONCE here */

  function fitCanvas(){
    fabricCanvas.setHeight(window.innerHeight - 160);
    fabricCanvas.setWidth(document.querySelector('.col:nth-child(2)').clientWidth - 24);
    fabricCanvas.calcOffset();
    fabricCanvas.requestRenderAll();
  }
  fitCanvas(); window.addEventListener('resize', fitCanvas);

  function setBaseImageFromDataURL(dataURL){
    return new Promise((resolve,reject)=>{
      fabric.Image.fromURL(dataURL, (img)=>{
        if (!img) { reject(new Error('Image load failed')); return; }
        if (baseImage) fabricCanvas.remove(baseImage);
        baseImage = img;
        baseImage.selectable=false; baseImage.evented=false;
        baseImage.set('erasable', false); // never erasable
        const cw=fabricCanvas.getWidth(), ch=fabricCanvas.getHeight();
        const scale=Math.min(cw/img.width, ch/img.height);
        baseImage.scale(scale);
        baseImage.set({ left:(cw - img.width*scale)/2, top:(ch - img.height*scale)/2 });
        fabricCanvas.add(baseImage);
        baseImage.moveTo(0);
        fabricCanvas.requestRenderAll();
        cInfo.textContent=`Image ${Math.round(img.width)}√ó${Math.round(img.height)} (scale ${scale.toFixed(2)})`;
        resolve();
      }, { crossOrigin:'anonymous' });
    });
  }
  const dataURLFromCanvas = () => fabricCanvas.toDataURL({ format:'png', quality:0.92 }); /* <‚Äî DECLARED ONCE */

  /* ===== Scenarios load ===== */
  function showStatus(msg){ statusPill.textContent = msg; }
  function populateList(){
    scenarioSel.innerHTML = '<option value="">Select scenario‚Ä¶</option>';
    scenarios.forEach(sc => {
      const o=document.createElement('option'); o.value=sc.id;
      o.textContent=(sc.title||'(untitled)') + (sc.active? '':' (inactive)');
      scenarioSel.appendChild(o);
    });
  }
  function renderStopsThumbs(){
    stopList.innerHTML='';
    if(!current?.stops?.length){ stopList.innerHTML='<div class="pill">No photos</div>'; return; }
    current.stops.forEach((s,idx)=>{
      const img=document.createElement('img');
      img.className='thumb'+(idx===stopIndex?' active':'');
      img.src=s.imageData||s.imageURL||'';
      img.title=s.title||`Stop ${idx+1}`;
      img.onerror=()=>{ img.src="data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='#0a2230'/><text x='50%' y='50%' fill='#9ecbd6' font-size='10' text-anchor='middle'>no image</text></svg>"); };
      img.onclick=()=>loadStop(idx);
      stopList.appendChild(img);
    });
  }
  function updateMetaHeader(){
    metaTitle.textContent = current ? (current.title || '(untitled)') : '(title)';
    metaDispatch.textContent = 'Dispatch: ' + (current?.dispatch ? String(current.dispatch).slice(0,120) : '(none)');
  }

  try {
    const scenariosRef = ref(db,'scenarios');
    onValue(scenariosRef, snap=>{
      const v = snap.val() || {};
      scenarios = Object.entries(v).map(([id,s])=>({id,...s})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      populateList();
      showStatus(`${scenarios.length} scenario(s) loaded`);
      if (current) {
        const fresh=scenarios.find(sc=>sc.id===current.id);
        if (fresh){ current=fresh; renderStopsThumbs(); updateMetaHeader(); }
      }
    }, err => showStatus('RTDB onValue error: '+(err?.message||err)));
    const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error('RTDB timeout (8s)')),8000));
    await Promise.race([ get(scenariosRef), timeout ]).then(snap=>{
      if (!snap.exists()) showStatus('Connected but /scenarios is empty.');
    }).catch(e=> showStatus('RTDB connection issue: '+e.message));
  } catch (e) {
    showStatus('Firebase init/permission error: ' + (e?.message||e));
  }
  refreshBtn.onclick = populateList;

  scenarioSel.onchange = ()=>{
    const id=scenarioSel.value;
    current = scenarios.find(s=>s.id===id) || null;
    stopIndex=-1;
    updateMetaHeader();
    renderStopsThumbs();
    fabricCanvas.clear(); baseImage=null; cropRect=null; erasing=false;
    fitCanvas();
  };

  async function loadStop(idx){
    if(!current) return;
    const s=current.stops[idx]; if(!s) return;
    stopIndex=idx;
    stopTitle.value=s.title||'';
    stopCaption.value=s.caption||'';
    stopLat.value=(s.lat ?? '').toString();
    stopLng.value=(s.lng ?? '').toString();
    stopRadius.value=(s.radiusMeters ?? 50).toString();
    Array.from(stopList.children).forEach((n,i)=>n.classList.toggle('active', i===idx));
    fabricCanvas.clear(); baseImage=null; cropRect=null; erasing=false;
    const src=s.imageData||s.imageURL;
    if(!src){ metaMsg.textContent='No image in this stop.'; return; }
    await setBaseImageFromDataURL(src);
  }

  /* ===== Meta save / GPS ===== */
  useGPS.onclick=()=>{
    navigator.geolocation.getCurrentPosition(p=>{
      stopLat.value=p.coords.latitude.toFixed(6);
      stopLng.value=p.coords.longitude.toFixed(6);
      metaMsg.textContent='GPS captured.';
    }, e=>{ metaMsg.textContent='GPS error: '+e.message; }, { enableHighAccuracy:true, timeout:10000 });
  };
  saveMeta.onclick=async()=>{
    try{
      if(!current || stopIndex<0) throw new Error('Select a stop first.');
      const s=current.stops[stopIndex];
      s.title=stopTitle.value.trim();
      s.caption=stopCaption.value.trim();
      s.lat=parseFloat(stopLat.value);
      s.lng=parseFloat(stopLng.value);
      s.radiusMeters=Math.max(5, parseInt(stopRadius.value||'50',10));
      if(Number.isNaN(s.lat)||Number.isNaN(s.lng)) throw new Error('Invalid GPS coordinates.');
      const { id, ...payload } = current;
      await set(ref(db,'scenarios/'+current.id), payload);
      metaMsg.textContent='Meta saved.';
    }catch(err){ metaMsg.textContent=String(err.message||err); }
  };

  /* ===== Replace / Export / Save image ===== */
  function readFileAsDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
  replaceApply.onclick=async()=>{
    const f=replaceFile.files?.[0]; if(!f){ metaMsg.textContent='Choose a file first.'; return; }
    const data=await readFileAsDataURL(f);
    await setBaseImageFromDataURL(data);
  };
  exportPNG.onclick=()=>{
    const url=dataURLFromCanvas();
    const a=document.createElement('a'); a.href=url; a.download=(current?.title||'image')+'-edited.png'; a.click();
  };
  saveImage.onclick=async()=>{
    try{
      if(!current || stopIndex<0) throw new Error('Select a stop first.');
      const url=dataURLFromCanvas();
      current.stops[stopIndex].imageData=url;
      current.stops[stopIndex].imageURL=null;
      const { id, ...payload } = current;
      await set(ref(db,'scenarios/'+current.id), payload);
      metaMsg.textContent='Image saved to RTDB.';
      renderStopsThumbs();
    }catch(err){ metaMsg.textContent=String(err.message||err); }
  };

  /* ===== Canvas commands (background only) ===== */
  const rebase = ()=>{ if(!baseImage) return; setBaseImageFromDataURL(baseImage.toDataURL({})); };
  fitBtn.onclick=rebase;
  zoomIn.onclick=()=>fabricCanvas.setZoom(fabricCanvas.getZoom()*1.1);
  zoomOut.onclick=()=>fabricCanvas.setZoom(fabricCanvas.getZoom()/1.1);
  rotateL.onclick=()=>{ if(baseImage){ baseImage.rotate((baseImage.angle||0)-90); fabricCanvas.requestRenderAll(); } };
  rotateR.onclick=()=>{ if(baseImage){ baseImage.rotate((baseImage.angle||0)+90); fabricCanvas.requestRenderAll(); } };

  /* ===== Crop workflow ===== */
  cropStart.onclick=()=>{
    if(!baseImage) return;
    cropRect = new fabric.Rect({
      left: baseImage.left + 20, top: baseImage.top + 20,
      width: Math.min(240, baseImage.getScaledWidth()-40),
      height: Math.min(240, baseImage.getScaledHeight()-40),
      fill: 'rgba(0,0,0,0.15)', stroke:'#2dd4bf', strokeWidth:2, hasRotatingPoint:false
    });
    fabricCanvas.add(cropRect); cropRect.bringToFront(); fabricCanvas.setActiveObject(cropRect);
  };
  cropCancel.onclick=()=>{ if(cropRect){ fabricCanvas.remove(cropRect); cropRect=null; } fabricCanvas.discardActiveObject(); fabricCanvas.requestRenderAll(); };
  cropApply.onclick=()=>{
    if(!baseImage || !cropRect) return;
    const scale = baseImage.scaleX;
    const bx = baseImage.left, by = baseImage.top;
    const rw = cropRect.width * cropRect.scaleX, rh = cropRect.height * cropRect.scaleY;
    const rx = cropRect.left - bx, ry = cropRect.top - by;
    const sx = rx / scale, sy = ry / scale, sw = rw / scale, sh = rh / scale;
    const el = document.createElement('canvas'); el.width=Math.max(1,Math.round(sw)); el.height=Math.max(1,Math.round(sh));
    const ctx = el.getContext('2d');
    const angle = (baseImage.angle||0) % 360;
    if (angle !== 0) {
      const fullURL = fabricCanvas.toDataURL({ format:'png', quality:1 });
      const tmp = new Image(); tmp.onload=()=>{
        const scaleX = tmp.width / fabricCanvas.getWidth();
        const scaleY = tmp.height / fabricCanvas.getHeight();
        ctx.drawImage(tmp, cropRect.left*scaleX, cropRect.top*scaleY, rw*scaleX, rh*scaleY, 0,0, el.width, el.height);
        setBaseImageFromDataURL(el.toDataURL('image/png', 0.95)).then(()=>{ fabricCanvas.remove(cropRect); cropRect=null; });
      }; tmp.src=fullURL;
    } else {
      const base = baseImage.getElement();
      ctx.drawImage(base, sx, sy, sw, sh, 0,0, el.width, el.height);
      setBaseImageFromDataURL(el.toDataURL('image/png', 0.95)).then(()=>{ fabricCanvas.remove(cropRect); cropRect=null; });
    }
  };

  /* ===== PNG overlays (absolute URLs) ===== */
  const OVERLAY_BASE = 'https://fireopssim.com/geophoto/overlays/';
  const SPRITES = {
    fire   : ['fire1.png','fire2.png','fire_side.png'],
    smoke  : ['smoke1.png','smoke2.png','smoke_ground.png'],
    people : ['people1.png','people2.png'],
    cars   : ['car1.png','car2.png'],
    hazard : ['hazard1.png']
  };
  function resolveSpritePath(uri){ return OVERLAY_BASE + uri; }

  function renderShelf(cat){
    overlayShelf.innerHTML = '';
    const items = SPRITES[cat] || [];
    items.forEach((uri, i) => {
      const div = document.createElement('div');
      div.className = 'olThumb';
      const img = document.createElement('img');
      img.src = resolveSpritePath(uri); img.alt = `${cat}-${i+1}`;
      img.onerror = () => { div.style.opacity = .5; div.title = 'Missing: ' + img.src; };
      div.appendChild(img);
      div.onclick = () => addOverlayImage(resolveSpritePath(uri));
      overlayShelf.appendChild(div);
    });
  }
  tabBtns.forEach(btn => btn.onclick = () => {
    tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderShelf(btn.dataset.cat);
  });
  if (tabBtns[0]) { tabBtns[0].classList.add('active'); renderShelf(tabBtns[0].dataset.cat); }

  function addOverlayImage(src){
    fabric.Image.fromURL(src, img => {
      const cw = fabricCanvas.getWidth(), ch = fabricCanvas.getHeight();
      const targetW = cw * 0.28; const scale = targetW / img.width;
      img.scale(scale);
      img.set({
        left: cw/2 - (img.width*scale)/2,
        top:  ch/2 - (img.height*scale)/2,
        cornerStyle:'circle', transparentCorners:false,
        shadow:'rgba(0,0,0,0.35) 0 6px 16px',
        erasable:true
      });
      fabricCanvas.add(img);
      fabricCanvas.setActiveObject(img);
      rotSelSlider.value = Math.round(img.angle || 0);
      fabricCanvas.requestRenderAll();
    }, { crossOrigin:'anonymous' });
  }

  /* ===== Overlay Hue & Opacity ===== */
  function ensureHueFilter(img){
    img.filters = img.filters || [];
    img.filters = img.filters.filter(f => !(f && f.type === 'HueRotation'));
  }
  overlayHue.oninput = (e)=>{
    const o = fabricCanvas.getActiveObject();
    if (o && o.type === 'image' && o !== baseImage) {
      const deg = parseInt(e.target.value,10) || 0;
      ensureHueFilter(o);
      if (deg !== 0) o.filters.push(new fabric.Image.filters.HueRotation({ rotation: deg * Math.PI/180 }));
      o.applyFilters(); fabricCanvas.requestRenderAll();
    }
  };
  overlayOpacity.oninput = (e)=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ o.set('opacity', parseFloat(e.target.value)); fabricCanvas.requestRenderAll(); } };
  bringFront.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ o.bringToFront(); fabricCanvas.requestRenderAll(); } };
  sendBack.onclick  = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ o.sendToBack(); if(baseImage) baseImage.sendToBack(); fabricCanvas.requestRenderAll(); } };
  deleteObj.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ fabricCanvas.remove(o); fabricCanvas.discardActiveObject(); fabricCanvas.requestRenderAll(); } };

  /* ===== Eraser (selected overlay only) ===== */
  function stopErasing(){
    fabricCanvas.isDrawingMode = false;
    erasing=false;
    eraserStatus.textContent = 'Eraser: off';
  }
  eraserStart.onclick = ()=>{
    const sel = fabricCanvas.getActiveObject();
    if (!sel || sel.type !== 'image' || sel===baseImage) { alert('Select an overlay image first.'); return; }
    if (baseImage) baseImage.set('erasable', false);
    fabricCanvas.getObjects().forEach(o => o.set('erasable', false));
    sel.set('erasable', true);
    fabricCanvas.isDrawingMode = true;
    fabricCanvas.freeDrawingBrush = new fabric.EraserBrush(fabricCanvas);
    fabricCanvas.freeDrawingBrush.width = parseInt(eraserSize.value,10) || 30;
    erasing = true; eraserStatus.textContent = `Eraser: ON (size ${fabricCanvas.freeDrawingBrush.width})`;
  };
  eraserSize.oninput = ()=>{ if (fabricCanvas.freeDrawingBrush) { fabricCanvas.freeDrawingBrush.width = parseInt(eraserSize.value,10)||30; if (erasing) eraserStatus.textContent = `Eraser: ON (size ${fabricCanvas.freeDrawingBrush.width})`; } };
  eraserDone.onclick = stopErasing;
  eraserCancel.onclick = ()=>{ stopErasing(); fabricCanvas.renderAll(); };

  /* ===== Overlay transform (rotate + flip) ===== */
  function rotateSelected(delta){
    const o=fabricCanvas.getActiveObject();
    if (!o || o===baseImage) return;
    o.rotate((o.angle||0)+delta);
    rotSelSlider.value = Math.round(o.angle||0);
    fabricCanvas.requestRenderAll();
  }
  rotSelLeft.onclick = ()=> rotateSelected(-15);
  rotSelRight.onclick = ()=> rotateSelected(+15);
  rotSelSlider.oninput = (e)=>{
    const o=fabricCanvas.getActiveObject();
    if (!o || o===baseImage) return;
    o.rotate(parseInt(e.target.value,10)||0);
    fabricCanvas.requestRenderAll();
  };
  function flipSelected(axis){
    const o=fabricCanvas.getActiveObject();
    if (!o || o===baseImage) return;
    if (axis === 'x') o.set('flipX', !o.flipX);
    if (axis === 'y') o.set('flipY', !o.flipY);
    fabricCanvas.requestRenderAll();
  }
  flipSelH.onclick = ()=> flipSelected('x');
  flipSelV.onclick = ()=> flipSelected('y');

  /* ===== Delete stop ===== */
  deleteStop.onclick=async()=>{
    try{
      if(!current || stopIndex<0) return;
      if(!confirm('Delete this photo from the scenario?')) return;
      current.stops.splice(stopIndex,1);
      const { id, ...payload } = current;
      await set(ref(db,'scenarios/'+current.id), payload);
      stopIndex=-1; fabricCanvas.clear(); baseImage=null; renderStopsThumbs(); metaMsg.textContent='Photo deleted.';
    }catch(e){ metaMsg.textContent=String(e.message||e); }
  };
})();
</script>
</body>
</html>
