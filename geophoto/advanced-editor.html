<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM ‚Äî Advanced Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Advanced editor for FireOps SIM Geo-Photo scenarios with overlays and RTDB save." />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" href="data:," />
  <style>
    :root{ --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff; --blue:#0a84ff; --teal:#2dd4bf; --red:#ff3b30; --shadow:0 12px 34px rgba(0,0,0,.38); --radius:18px; --radiusSm:14px; --border: rgba(255,255,255,.08);} *{box-sizing:border-box}
    html,body{margin:0;padding:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),linear-gradient(165deg, var(--bg2), var(--bg) 55%)}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(12,15,22,.78);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .brandmini{display:flex;align-items:center;gap:12px;font-weight:800}
    .logo img{width:40px;height:40px;border-radius:10px;box-shadow:var(--shadow);object-fit:cover;background:#0f1624}
    .tag{color:var(--muted);font-size:12px}

    main{max-width:1200px;margin:20px auto 80px;padding:0 20px}
    .app{display:grid;grid-template-columns:320px 1fr 380px;gap:12px;align-items:start}
    .col{background:var(--card);border:1px solid var(--border);border-radius:var(--radiusSm);box-shadow:var(--shadow);padding:12px;overflow:auto}
    label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
    select,input,textarea,button{font-size:14px}
    select,input[type="text"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0d2430;color:var(--text);outline:none}
    textarea{min-height:72px;resize:vertical}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:linear-gradient(180deg,#54a6ff,var(--blue));color:#03131b;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18)}
    .btn.warn{background:#ffc857;color:#2a1d00}
    .btn.danger{background:var(--red);color:#ffecec}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.15);cursor:pointer;background:#0b2130}
    .thumb.active{outline:3px solid var(--teal)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted)}
    .sectionTitle{font-weight:800;margin:6px 0}
    .canvasWrap{position:relative;background:#061621;border:1px solid rgba(255,255,255,.12);border-radius:12px;overflow:hidden}
    #c{display:block;width:100%;height:calc(100vh - 360px);background:transparent}
    .bar{display:flex;gap:8px;flex-wrap:wrap}
    .divider{height:1px;background:rgba(255,255,255,.1);opacity:.8;margin:10px 0}

    /* Overlay shelf */
    .olThumb{width:100%;aspect-ratio:1/1;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b2130;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .olThumb img{max-width:88%;max-height:88%;display:block}
    .ol-tab.active{outline:3px solid var(--teal)}

    footer{max-width:1200px;margin:40px auto;padding:18px 20px;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}

    @media (max-width: 1100px){ .app{grid-template-columns:1fr} #c{height:56vh} }
    #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;max-width:80vw;display:none;z-index:9999}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo" aria-hidden="true"><img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM logo" /></div>
        <div>
          <div style="line-height:1.1; font-size:15px; font-weight:900">FireOps SIM</div>
          <div class="tag">Real-Time Fire Scene Simulator</div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <div id="errbar"></div>

    <div id="app" class="app">
      <!-- Left: scenarios + meta -->
      <div class="col" id="leftCol">
        <div class="row" style="justify-content:space-between">
          <div class="pill" id="statusPill">Loading‚Ä¶</div>
          <button id="refresh" class="btn secondary">Refresh</button>
        </div>

        <label>Scenario</label>
        <select id="scenarioSel"><option value="">Select scenario‚Ä¶</option></select>

        <div class="divider"></div>
        <div class="sectionTitle">Photos in scenario</div>
        <div id="stopList" class="row"></div>

        <div class="divider"></div>
        <div class="sectionTitle">Selected stop meta</div>
        <label>Title</label><input id="stopTitle" type="text" />
        <label>Caption</label><textarea id="stopCaption"></textarea>
        <div class="row">
          <div style="flex:1"><label>Latitude</label><input id="stopLat" type="text" /></div>
          <div style="flex:1"><label>Longitude</label><input id="stopLng" type="text" /></div>
        </div>
        <label>Radius (meters)</label><input id="stopRadius" type="text" placeholder="50" />
        <div class="row" style="margin-top:6px">
          <button id="useGPS" class="btn secondary">Use my location</button>
          <button id="saveMeta" class="btn">Save Meta</button>
        </div>
        <div id="metaMsg" class="pill" style="margin-top:6px">Ready</div>

        <div class="divider"></div>
        <div class="row">
          <input id="replaceFile" type="file" accept="image/*" />
          <button id="replaceApply" class="btn">Replace Image</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="deleteStop" class="btn danger">Delete This Photo</button>
          <button id="exportPNG" class="btn secondary">Export PNG</button>
        </div>
      </div>

      <!-- Center: canvas -->
      <div class="col">
        <div class="bar" style="margin-bottom:8px">
          <button id="fit" class="btn secondary">Fit</button>
          <button id="zoomIn" class="btn secondary">Zoom +</button>
          <button id="zoomOut" class="btn secondary">Zoom ‚àí</button>
          <button id="rotateL" class="btn secondary">Rotate ‚ü≤</button>
          <button id="rotateR" class="btn secondary">Rotate ‚ü≥</button>
          <span class="pill" id="canvasInfo">Canvas</span>
          <button id="saveImage" class="btn">Save Image to RTDB</button>
        </div>
        <div class="canvasWrap"><canvas id="c"></canvas></div>
      </div>

      <!-- Right: overlays + eraser + flip -->
      <div class="col" id="rightCol">
        <div class="sectionTitle">Overlays</div>
        <div class="row" style="gap:6px; flex-wrap:nowrap; overflow:auto">
          <button class="btn secondary ol-tab" data-cat="fire">üî• Fire</button>
          <button class="btn secondary ol-tab" data-cat="smoke">üå´Ô∏è Smoke</button>
          <button class="btn secondary ol-tab" data-cat="people">üßç People</button>
          <button class="btn secondary ol-tab" data-cat="cars">üöó Cars</button>
          <button class="btn secondary ol-tab" data-cat="hazard">‚ö†Ô∏è Hazard</button>
        </div>
        <div id="overlayShelf" style="margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>

        <label style="margin-top:10px">Hue (selected overlay)</label>
        <input id="overlayHue" type="range" min="-180" max="180" step="1" value="0" />

        <label style="margin-top:10px">Opacity</label>
        <input id="overlayOpacity" type="range" min="0.05" max="1" step="0.05" value="1" />

        <div class="row" style="margin-top:8px">
          <button id="bringFront" class="btn secondary">Bring to Front</button>
          <button id="sendBack" class="btn secondary">Send to Back</button>
          <button id="deleteObj" class="btn danger">Delete Selected</button>
        </div>

        <div class="divider"></div>
        <div class="sectionTitle">Eraser (selected overlay)</div>
        <div class="row">
          <button id="eraserStart" class="btn warn">Start Erasing</button>
          <button id="eraserDone" class="btn">Finish</button>
          <button id="eraserCancel" class="btn secondary">Cancel</button>
        </div>
        <label style="margin-top:8px">Brush Size</label>
        <input id="eraserSize" type="range" min="5" max="120" step="1" value="30" />
        <div class="pill" id="eraserStatus" style="margin-top:6px">Eraser: off</div>

        <div class="divider"></div>
        <div class="sectionTitle">Transform Overlay</div>
        <div class="row">
          <button id="flipSelH" class="btn secondary">Flip H</button>
          <button id="flipSelV" class="btn secondary">Flip V</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div>¬© <span id="year"></span> FireOps SIM</div>
    <div class="external">Part of the <a href="https://emscodesim.com" rel="noopener">EMS Code Sim</a> training ecosystem</div>
  </footer>

  <!-- Fabric 5.x -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script type="module">
  // Error banner
  const ERR = (msg) => { const b=document.getElementById('errbar'); b.textContent=msg; b.style.display='block'; };
  window.addEventListener('error', e => ERR(e.message));
  window.addEventListener('unhandledrejection', e => ERR(String(e.reason?.message||e.reason||e)));

  (async () => {
    document.getElementById('year').textContent = new Date().getFullYear();

    // Firebase
    const [{ initializeApp }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js") ]);
    const [{ getDatabase, ref, onValue, get, set }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js") ]);
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);

    // DOM
    const statusPill=document.getElementById('statusPill');
    const scenarioSel=document.getElementById('scenarioSel');
    const stopList=document.getElementById('stopList');
    const refreshBtn=document.getElementById('refresh');

    const stopTitle=document.getElementById('stopTitle');
    const stopCaption=document.getElementById('stopCaption');
    const stopLat=document.getElementById('stopLat');
    const stopLng=document.getElementById('stopLng');
    const stopRadius=document.getElementById('stopRadius');
    const useGPS=document.getElementById('useGPS');
    const saveMeta=document.getElementById('saveMeta');
    const metaMsg=document.getElementById('metaMsg');

    const replaceFile=document.getElementById('replaceFile');
    const replaceApply=document.getElementById('replaceApply');
    const deleteStop=document.getElementById('deleteStop');
    const exportPNG=document.getElementById('exportPNG');
    const cInfo=document.getElementById('canvasInfo');
    const fitBtn=document.getElementById('fit');
    const zoomIn=document.getElementById('zoomIn');
    const zoomOut=document.getElementById('zoomOut');
    const rotateL=document.getElementById('rotateL');
    const rotateR=document.getElementById('rotateR');
    const saveImage=document.getElementById('saveImage');

    const overlayShelf=document.getElementById('overlayShelf');
    const tabBtns = Array.from(document.querySelectorAll('.ol-tab'));
    const overlayHue=document.getElementById('overlayHue');
    const overlayOpacity=document.getElementById('overlayOpacity');
    const bringFront=document.getElementById('bringFront');
    const sendBack=document.getElementById('sendBack');
    const deleteObj=document.getElementById('deleteObj');

    const eraserStart=document.getElementById('eraserStart');
    const eraserDone=document.getElementById('eraserDone');
    const eraserCancel=document.getElementById('eraserCancel');
    const eraserSize=document.getElementById('eraserSize');
    const eraserStatus=document.getElementById('eraserStatus');

    const flipSelH=document.getElementById('flipSelH');
    const flipSelV=document.getElementById('flipSelV');

    // Canvas
    const fabricCanvas = new fabric.Canvas('c', { backgroundColor:'#061621', preserveObjectStacking:true, selection:true });
    let baseImage=null, cropRect=null;

    function fitCanvas(){
      const reserved = 260; // header/footer budget
      const targetH = Math.max(380, window.innerHeight - reserved);
      document.getElementById('c').style.height = targetH + 'px';
      fabricCanvas.setHeight(targetH);
      const midCol = document.querySelector('main .col:nth-child(2)');
      const width = (midCol?.clientWidth || 800) - 24;
      fabricCanvas.setWidth(width);
      fabricCanvas.calcOffset();
      fabricCanvas.requestRenderAll();
    }
    fitCanvas(); window.addEventListener('resize', fitCanvas);

    function setBaseImageFromDataURL(dataURL){
      return new Promise((resolve,reject)=>{
        fabric.Image.fromURL(dataURL, (img)=>{
          if (!img) { reject(new Error('Image load failed')); return; }
          if (baseImage) fabricCanvas.remove(baseImage);
          baseImage = img; baseImage.selectable=false; baseImage.evented=false; baseImage.set('erasable', false);
          const cw=fabricCanvas.getWidth(), ch=fabricCanvas.getHeight();
          const scale=Math.min(cw/img.width, ch/img.height);
          baseImage.scale(scale);
          baseImage.set({ left:(cw - img.width*scale)/2, top:(ch - img.height*scale)/2 });
          fabricCanvas.add(baseImage); baseImage.moveTo(0); fabricCanvas.requestRenderAll();
          cInfo.textContent=`Image ${Math.round(img.width)}√ó${Math.round(img.height)} (scale ${scale.toFixed(2)})`;
          resolve();
        }, { crossOrigin:'anonymous' });
      });
    }

    // ---- FULL-RES EXPORT/SAVE ----
    function dataURLFromCanvasFullRes() {
      const zoom = fabricCanvas.getZoom() || 1;
      let multiplier = 1;
      if (baseImage) {
        const s = baseImage.scaleX || 1;
        multiplier = (1 / s) * (1 / zoom);
      }
      multiplier = Math.max(1, Math.min(8, multiplier));
      return fabricCanvas.toDataURL({ format: 'png', quality: 0.95, multiplier });
    }

    exportPNG.onclick = () => {
      const url = dataURLFromCanvasFullRes();
      const a = document.createElement('a');
      a.href = url;
      a.download = (current?.title || 'image') + '-edited.png';
      a.click();
    };

    // ===== Load scenarios (Admin logic: fixed '/scenarios') =====
    function coerceStops(sc){
      if (Array.isArray(sc?.stops))  return sc.stops;
      if (Array.isArray(sc?.photos)) return sc.photos;
      if (Array.isArray(sc?.images)) return sc.images;
      return [];
    }
    function setStops(sc, stops){
      if (Array.isArray(sc?.stops)) sc.stops = stops;
      else if (Array.isArray(sc?.photos)) sc.photos = stops;
      else if (Array.isArray(sc?.images)) sc.images = stops;
      else sc.stops = stops;
    }

    let scenarios=[], current=null, stopIndex=-1;
    const ROOT='scenarios';

    function showStatus(msg){ statusPill.textContent = msg; }
    function populateList(){
      scenarioSel.innerHTML = '<option value="">Select scenario‚Ä¶</option>';
      scenarios.forEach(sc => {
        const o=document.createElement('option'); o.value=sc.id; o.textContent=(sc.title||'(untitled)') + (sc.active? '':' (inactive)');
        scenarioSel.appendChild(o);
      });
    }
    function renderStopsThumbs(){
      stopList.innerHTML='';
      if(!current || !current._stops?.length){ stopList.innerHTML='<div class="pill">No photos</div>'; return; }
      current._stops.forEach((s,idx)=>{
        const img=document.createElement('img');
        img.className='thumb'+(idx===stopIndex?' active':'');
        img.src=s.imageData||s.imageURL||'';
        img.title=s.title||`Stop ${idx+1}`;
        img.onerror=()=>{ img.src="data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='#0a2230'/><text x='50%' y='50%' fill='#9ecbd6' font-size='10' text-anchor='middle'>no image</text></svg>"); };
        img.onclick=()=>loadStop(idx);
        stopList.appendChild(img);
      });
    }

    async function loadScenarios(){
      try{
        showStatus('Loading scenarios‚Ä¶');
        const snap = await get(ref(db, ROOT));
        if (!snap.exists()){
          scenarios = [];
          populateList();
          showStatus('0 scenario(s) loaded');
          return;
        }
        const obj = snap.val() || {};
        scenarios = Object.entries(obj).map(([id, s])=>({
          id, _raw:s, _stops:coerceStops(s), ...s
        })).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        populateList();
        showStatus(`${scenarios.length} scenario(s) loaded`);
      }catch(e){
        showStatus('Error: ' + (e?.message || e));
      }
    }

    function startLive(){
      onValue(ref(db, ROOT), snap=>{
        const v=snap.val()||{};
        scenarios = Object.entries(v).map(([id,s])=>({
          id, _raw:s, _stops:coerceStops(s), ...s
        })).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        populateList();
        if (current){
          const fresh = scenarios.find(sc=>sc.id===current.id);
          if (fresh){ current=fresh; renderStopsThumbs(); }
        }
        showStatus(`${scenarios.length} scenario(s) loaded`);
      }, err=> showStatus('RTDB onValue error: '+(err?.message||err)));
    }

    await loadScenarios();
    startLive();
    refreshBtn.onclick = loadScenarios;

    scenarioSel.onchange = ()=>{
      const id=scenarioSel.value;
      current = scenarios.find(s=>s.id===id) || null;
      stopIndex=-1;
      renderStopsThumbs();
      fabricCanvas.clear(); baseImage=null; cropRect=null;
      fitCanvas();
    };

    async function loadStop(idx){
      if(!current) return;
      const s=current._stops[idx]; if(!s) return;
      stopIndex=idx;
      stopTitle.value=s.title||'';
      stopCaption.value=s.caption||'';
      stopLat.value=(s.lat ?? '').toString();
      stopLng.value=(s.lng ?? '').toString();
      stopRadius.value=(s.radiusMeters ?? s.radius ?? 50).toString();
      Array.from(stopList.children).forEach((n,i)=>n.classList.toggle('active', i===idx));
      fabricCanvas.clear(); baseImage=null; cropRect=null;
      const src=s.imageData||s.imageURL;
      if(!src){ metaMsg.textContent='No image in this stop.'; return; }
      await setBaseImageFromDataURL(src);

      // Rehydrate overlays + erase masks
      if (Array.isArray(s.overlays)) {
        for (const ov of s.overlays){
          if (!ov?.src) continue;
          await new Promise(res=>{
            fabric.Image.fromURL(ov.src, img=>{
              try{
                img.set({
                  left:ov.left||0, top:ov.top||0,
                  scaleX:ov.scaleX||1, scaleY:ov.scaleY||1,
                  angle:ov.angle||0, opacity:ov.opacity??1,
                  flipX:!!ov.flipX, flipY:!!ov.flipY,
                  erasable:true, cornerStyle:'circle', transparentCorners:false
                });

                // Reapply fallback erase mask if present
                if (Array.isArray(ov.erase) && ov.erase.length){
                  const circles = ov.erase.map(e => new fabric.Circle({
                    left: e.x, top: e.y, radius: e.r,
                    originX:'center', originY:'center', absolutePositioned:true
                  }));
                  img.set('clipPath', new fabric.Group(circles, { absolutePositioned:true, inverted:true }));
                }

                fabricCanvas.add(img);
              } finally { res(); }
            }, { crossOrigin:'anonymous' });
          });
        }
        fabricCanvas.requestRenderAll();
      }
    }

    // GPS + Meta save
    useGPS.onclick=()=>{ navigator.geolocation.getCurrentPosition(p=>{ stopLat.value=p.coords.latitude.toFixed(6); stopLng.value=p.coords.longitude.toFixed(6); metaMsg.textContent='GPS captured.'; }, e=>{ metaMsg.textContent='GPS error: '+e.message; }, { enableHighAccuracy:true, timeout:10000 }); };

    function serializeOverlays(){
      const out=[];
      fabricCanvas.getObjects('image').forEach(img=>{
        if (img===baseImage) return;

        // Persist clipPath circles when present (fallback eraser)
        let erase = null;
        if (img.clipPath && img.clipPath.type === 'group' && img.clipPath.inverted) {
          erase = (img.clipPath._objects || []).map(o => ({
            type: o.type,
            x: o.left, y: o.top,
            r: o.radius || 0,
          }));
        }

        out.push({
          src: img.getSrc ? img.getSrc() : img._originalElement?.src || img.src || '',
          left: img.left||0, top: img.top||0,
          scaleX: img.scaleX||1, scaleY: img.scaleY||1,
          angle: img.angle||0, opacity: img.opacity??1,
          flipX: !!img.flipX,  flipY: !!img.flipY,
          erase // array of circles or null
        });
      });
      return out;
    }

    saveMeta.onclick=async()=>{ try{
      if(!current || stopIndex<0) throw new Error('Select a stop first.');
      const s = { ...current._stops[stopIndex] };
      s.title=stopTitle.value.trim();
      s.caption=stopCaption.value.trim();
      s.lat=parseFloat(stopLat.value);
      s.lng=parseFloat(stopLng.value);
      s.radiusMeters=Math.max(5, Math.min(1000, Math.round(parseInt(stopRadius.value||'50',10))));
      if(Number.isNaN(s.lat)||Number.isNaN(s.lng)) throw new Error('Invalid GPS coordinates.');
      s.overlays = serializeOverlays();
      const nextStops = [ ...current._stops ]; nextStops[stopIndex] = s;
      const updated = { ...current._raw };
      setStops(updated, nextStops);
      await set(ref(db, `${ROOT}/${current.id}`), updated);
      current._raw = updated; current._stops = nextStops;
      metaMsg.textContent='Meta saved.';
    }catch(err){ metaMsg.textContent=String(err.message||err); } };

    function readFileAsDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }
    replaceApply.onclick=async()=>{ const f=replaceFile.files?.[0]; if(!f){ metaMsg.textContent='Choose a file first.'; return; } const data=await readFileAsDataURL(f); await setBaseImageFromDataURL(data); };

    async function persistCurrentStopImageAndOverlays(){
      if(!current || stopIndex<0) throw new Error('Select a stop first.');
      const url = dataURLFromCanvasFullRes();
      const s = { ...current._stops[stopIndex] };
      s.imageData=url; s.imageURL=null;
      s.overlays = serializeOverlays();
      const nextStops = [ ...current._stops ]; nextStops[stopIndex] = s;
      const updated = { ...current._raw };
      setStops(updated, nextStops);
      await set(ref(db, `${ROOT}/${current.id}`), updated);
      current._raw = updated; current._stops = nextStops;
      renderStopsThumbs();
      metaMsg.textContent='Image + overlays saved.';
    }
    saveImage.onclick=()=>persistCurrentStopImageAndOverlays().catch(e=> metaMsg.textContent=String(e.message||e));

    // Overlay shelf
    const OVERLAY_BASE='https://fireopssim.com/geophoto/overlays/';
    const SPRITES={ fire:['fire1.png','fire2.png','fire3.png','fire4.png','fire5.png','fire_side.png'], smoke:['smoke1.png','smoke2.png','smoke3.png','smoke_ground.png'], people:['people1.png','people2.png','people3.png'], cars:['car1.png','car2.png','car3.png'], hazard:['hazard1.png','hazard2.png','hazard3.png'] };
    const resolveSpritePath=(cat,name)=>`${OVERLAY_BASE}${cat}/${name}`;
    function renderShelf(cat){ overlayShelf.innerHTML=''; (SPRITES[cat]||[]).forEach((name,i)=>{ const div=document.createElement('div'); div.className='olThumb'; const img=document.createElement('img'); img.src=resolveSpritePath(cat,name); img.alt=`${cat}-${i+1}`; img.onerror=()=>{ div.style.opacity=.5; div.title='Missing: '+img.src; }; div.appendChild(img); div.onclick=()=>addOverlayImage(resolveSpritePath(cat,name)); overlayShelf.appendChild(div); }); }
    tabBtns.forEach(btn => btn.onclick = () => { tabBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderShelf(btn.dataset.cat); });
    if (tabBtns[0]) { tabBtns[0].classList.add('active'); renderShelf(tabBtns[0].dataset.cat); }
    function addOverlayImage(src){ fabric.Image.fromURL(src, img => { const cw=fabricCanvas.getWidth(), ch=fabricCanvas.getHeight(); const targetW=cw*0.28; const scale=targetW/img.width; img.scale(scale); img.set({ left:cw/2-(img.width*scale)/2, top:ch/2-(img.height*scale)/2, cornerStyle:'circle', transparentCorners:false, shadow:'rgba(0,0,0,0.35) 0 6px 16px', erasable:true }); fabricCanvas.add(img); fabricCanvas.setActiveObject(img); fabricCanvas.requestRenderAll(); }, { crossOrigin:'anonymous' }); }

    // Hue/Opacity/Order
    const supportsHue = !!(fabric.Image && fabric.Image.filters && fabric.Image.filters.HueRotation);
    overlayHue.disabled = !supportsHue;
    function ensureHueFilter(img){ img.filters = img.filters || []; img.filters = img.filters.filter(f => !(f && f.type === 'HueRotation')); }
    overlayHue.oninput = (e)=>{ if(!supportsHue) return; const o=fabricCanvas.getActiveObject(); if(o && o.type==='image' && o!==baseImage){ const deg=parseInt(e.target.value,10)||0; ensureHueFilter(o); if (deg !== 0) o.filters.push(new fabric.Image.filters.HueRotation({ rotation: deg * Math.PI/180 })); o.applyFilters(); fabricCanvas.requestRenderAll(); } };
    overlayOpacity.oninput = (e)=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ o.set('opacity', parseFloat(e.target.value)); fabricCanvas.requestRenderAll(); } };
    bringFront.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ o.bringToFront(); fabricCanvas.requestRenderAll(); } };
    sendBack.onclick  = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ o.sendToBack(); if(baseImage) baseImage.sendToBack(); fabricCanvas.requestRenderAll(); } };
    deleteObj.onclick = ()=>{ const o=fabricCanvas.getActiveObject(); if(o && o!==baseImage){ fabricCanvas.remove(o); fabricCanvas.discardActiveObject(); fabricCanvas.requestRenderAll(); } };

    // ---- Eraser (native brush if present; fallback clip-mask otherwise) ----
    let erasing = false, fallbackEraserActive = false, fallbackCircles = [], pointerDown = false;

    function stopErasing(){
      fabricCanvas.isDrawingMode = false;
      erasing = false;
      fallbackEraserActive = false;
      pointerDown = false;
      eraserStatus.textContent = 'Eraser: off';
      fabricCanvas.off('mouse:down', onMouseDownFallback);
      fabricCanvas.off('mouse:move', onMouseMoveFallback);
      fabricCanvas.off('mouse:up',   onMouseUpFallback);
    }

    function ensureOverlaySelected(){
      const sel = fabricCanvas.getActiveObject();
      if (!sel || sel.type!=='image' || sel===baseImage) { alert('Select an overlay image first.'); return null; }
      return sel;
    }

    function applyFallbackCircleAt(sel, canvasPoint, radius){
      const c = new fabric.Circle({ left: canvasPoint.x, top: canvasPoint.y, radius, originX:'center', originY:'center', absolutePositioned:true });
      fallbackCircles.push(c);
      const clipGroup = new fabric.Group(fallbackCircles, { absolutePositioned:true, inverted:true });
      sel.set('clipPath', clipGroup);
    }
    function onMouseDownFallback(opt){ const sel=ensureOverlaySelected(); if(!sel) return; pointerDown = true; const p=fabricCanvas.getPointer(opt.e); const r=(parseInt(eraserSize.value,10)||30)*0.5; applyFallbackCircleAt(sel, p, r); fabricCanvas.requestRenderAll(); }
    function onMouseMoveFallback(opt){ if(!pointerDown) return; const sel=ensureOverlaySelected(); if(!sel) return; const p=fabricCanvas.getPointer(opt.e); const r=(parseInt(eraserSize.value,10)||30)*0.5; applyFallbackCircleAt(sel, p, r); fabricCanvas.requestRenderAll(); }
    function onMouseUpFallback(){ pointerDown = false; }

    eraserStart.onclick = ()=>{
      const sel = ensureOverlaySelected(); if(!sel) return;
      if (fabric.EraserBrush) {
        fabricCanvas.getObjects().forEach(o=>o.set('erasable', false));
        sel.set('erasable', true);
        fabricCanvas.isDrawingMode = true;
        fabricCanvas.freeDrawingBrush = new fabric.EraserBrush(fabricCanvas);
        fabricCanvas.freeDrawingBrush.width = parseInt(eraserSize.value,10)||30;
        erasing = true;
        eraserStatus.textContent = `Eraser: ON (brush ${fabricCanvas.freeDrawingBrush.width})`;
      } else {
        fallbackEraserActive = true;
        fallbackCircles = (sel.clipPath && sel.clipPath._objects) ? [...sel.clipPath._objects] : [];
        fabricCanvas.on('mouse:down', onMouseDownFallback);
        fabricCanvas.on('mouse:move', onMouseMoveFallback);
        fabricCanvas.on('mouse:up',   onMouseUpFallback);
        eraserStatus.textContent = `Eraser: ON (fallback, size ${parseInt(eraserSize.value,10)||30})`;
      }
    };
    eraserSize.oninput = ()=>{ if (fabricCanvas.freeDrawingBrush) { fabricCanvas.freeDrawingBrush.width = parseInt(eraserSize.value,10)||30; if (erasing) eraserStatus.textContent = `Eraser: ON (brush ${fabricCanvas.freeDrawingBrush.width})`; } else if (fallbackEraserActive) { eraserStatus.textContent = `Eraser: ON (fallback, size ${parseInt(eraserSize.value,10)||30})`; } };
    eraserDone.onclick = stopErasing;
    eraserCancel.onclick = ()=>{ stopErasing(); fabricCanvas.renderAll(); };

    // Flip only
    function flipSelected(axis){ const o=fabricCanvas.getActiveObject(); if(!o || o===baseImage) return; if(axis==='x') o.set('flipX', !o.flipX); if(axis==='y') o.set('flipY', !o.flipY); fabricCanvas.requestRenderAll(); }
    flipSelH.onclick=()=>flipSelected('x');
    flipSelV.onclick=()=>flipSelected('y');

    // Canvas utilities
    const rebase=()=>{ if(!baseImage) return; setBaseImageFromDataURL(baseImage.toDataURL({})); };
    fitBtn.onclick=rebase;
    zoomIn.onclick=()=>fabricCanvas.setZoom(fabricCanvas.getZoom()*1.1);
    zoomOut.onclick=()=>fabricCanvas.setZoom(fabricCanvas.getZoom()/1.1);
    rotateL.onclick=()=>{ if(baseImage){ baseImage.rotate((baseImage.angle||0)-90); fabricCanvas.requestRenderAll(); } };
    rotateR.onclick=()=>{ if(baseImage){ baseImage.rotate((baseImage.angle||0)+90); fabricCanvas.requestRenderAll(); } };

    // Delete stop
    deleteStop.onclick=async()=>{ try{ if(!current || stopIndex<0) return; if(!confirm('Delete this photo from the scenario?')) return; current._stops.splice(stopIndex,1); const updated={ ...current._raw }; setStops(updated, current._stops); await set(ref(db, `${ROOT}/${current.id}`), updated); stopIndex=-1; fabricCanvas.clear(); baseImage=null; renderStopsThumbs(); metaMsg.textContent='Photo deleted.'; }catch(e){ metaMsg.textContent=String(e.message||e); } };
  })();
  </script>
</body>
</html>
