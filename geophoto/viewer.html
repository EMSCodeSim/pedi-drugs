<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14; --bar:#0e1421; --text:#eaf2ff; --muted:#9fb2d6; --edge:rgba(255,255,255,.12); --a1:#54a6ff; --a2:#0a84ff; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(14,20,33,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--edge)}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;flex-wrap:wrap}
    .brand{font-weight:900}
    .row{display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap}
    select,input{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--edge);background:#0f1624;color:var(--text);min-width:150px}
    #session{width:120px}
    button{height:40px;padding:0 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,var(--a1),var(--a2));color:#03131b}
    .pill{font-size:12px;padding:6px 10px;border:1px solid var(--edge);border-radius:999px;color:var(--muted);white-space:nowrap;max-width:100%;overflow:hidden;text-overflow:ellipsis}
    #wrap{position:fixed;inset:64px 0 60px 0;display:flex;align-items:center;justify-content:center}
    #img{width:100%;height:100%;object-fit:contain;background:#000}
    #cap{position:fixed;left:0;right:0;bottom:60px;padding:10px 14px;text-align:center;font-size:16px;background:linear-gradient(0deg,rgba(0,0,0,.65),transparent);display:none}
    #bottom{position:fixed;left:0;right:0;bottom:0;padding:8px 10px;display:flex;gap:8px;align-items:center;justify-content:center;background:rgba(14,20,33,.9);border-top:1px solid var(--edge);flex-wrap:wrap}
    @media (max-width:700px){ #wrap{inset:116px 0 60px 0} select{min-width:140px} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="bar">
      <div class="brand">FireOps SIM — Viewer</div>
      <div class="row" style="flex:1;min-width:0">
        <select id="scenario">
          <option value="__manual__">Instructor-led (Manual)</option>
          <option disabled>Loading scenarios…</option>
        </select>
        <input id="session" placeholder="Session" value="default" />
        <button id="start">Start</button>
      </div>
      <div class="row">
        <span id="authPill" class="pill">auth: …</span>
        <span id="pathPill" class="pill">path: …</span>
        <span id="status" class="pill">idle</span>
      </div>
    </div>
  </div>

  <div id="wrap" aria-live="polite">
    <img id="img" alt="Scenario" decoding="async" loading="eager" fetchpriority="high">
    <div id="cap"></div>
  </div>

  <div id="bottom">
    <span id="hint" class="pill"></span>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const sel=$('#scenario'), startBtn=$('#start'), sessionInput=$('#session');
    const img=$('#img'), cap=$('#cap'), statusPill=$('#status'), hint=$('#hint'), authPill=$('#authPill'), pathPill=$('#pathPill');

    // Firebase config (same as Instructor)
    const config = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.firebasestorage.app",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    firebase.initializeApp(config);
    const db=firebase.database(), auth=firebase.auth(), storage=firebase.storage();
    const FORCE_BUCKET="dailyquiz-d5279.appspot.com";

    // State
    let running=false, manualRef=null, helloRef=null, watchId=null;
    let current=null, cache=[], lastIdx=-1, lastTs=0;

    // UI helpers
    const setStatus=t=> statusPill.textContent=t;
    const say=t=> hint.textContent=t||'';
    const qs=new URLSearchParams(location.search);
    if(qs.get('session')) sessionInput.value=qs.get('session');

    // Paths
    function normSession(raw){return (raw||'default').trim().toLowerCase();}
    function manualPath(s){return `geophoto/manual/${normSession(s)}/current`;}
    function helloPath(s){return `geophoto/manual/${normSession(s)}/hello`;}

    function showSlide(title,text,dataURL){
      img.src=dataURL||'';
      const s=(title?title+(text?' — ':''):'')+(text||'');
      cap.textContent=s; cap.style.display=s?'block':'none';
    }

    async function ensureAuthed(){
      return new Promise((resolve,reject)=>{
        const unsub=auth.onAuthStateChanged(u=>{
          if(u){ authPill.textContent=`auth: anon ✓ ${u.uid.slice(0,8)}`; unsub(); resolve(u); }
          else auth.signInAnonymously().catch(e=>{ authPill.textContent=`auth: failed (${e.code||e.message})`; unsub(); reject(e); });
        });
      });
    }

    async function fetchNode(path){ const snap=await db.ref(path).get(); return snap.exists()?snap.val():null; }

    async function loadScenarios(){
      const list=[];
      try{const a=await fetchNode('geophoto/scenarios'); if(a) for(const [id,s] of Object.entries(a)) list.push({id,...(s||{})});}catch{}
      try{const b=await fetchNode('scenarios');          if(b) for(const [id,s] of Object.entries(b)) list.push({id,...(s||{})});}catch{}
      const uniq=new Map(); list.forEach(x=>{if(!uniq.has(x.id)) uniq.set(x.id,x);});
      const arr=Array.from(uniq.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      sel.innerHTML='<option value="__manual__">Instructor-led (Manual)</option>';
      arr.forEach(sc=>{const o=document.createElement('option');o.value=sc.id;o.textContent=sc.title||sc.name||'(untitled)';sel.appendChild(o);});
      if(qs.get('id')&&arr.some(s=>s.id===qs.get('id'))) sel.value=qs.get('id');
    }

    // ---------- Manual mode (sticky, ignore stale/empty) ----------
    function subscribeManual(sessionRaw){
      const s=normSession(sessionRaw);
      pathPill.textContent=`path: ${manualPath(s)}`;
      if(manualRef) try{ manualRef.off(); }catch{}; 
      if(helloRef)  try{ helloRef.off(); }catch{};
      manualRef=db.ref(manualPath(s));
      helloRef =db.ref(helloPath(s));

      helloRef.on('value', snap=>{
        const v=snap.val(); const last=v?.instructorPing? new Date(v.instructorPing).toLocaleTimeString():'—';
        say(`Connected: "${s}". Last hello: ${last}`);
      });

      manualRef.on('value', snap=>{
        const v=snap.val();

        // 1) Only explicit clear blanks the screen
        if (v && v.clear===true){
          lastTs = Date.now();
          showSlide('','',''); setStatus('waiting…'); say('Instructor cleared'); return;
        }

        // 2) Null/empty object: ignore (keep last slide)
        if (!v || (typeof v==='object' && !v.kind && !v.image && !v.title && !v.caption)){
          return;
        }

        // 3) Only accept newer frames with kind:'slide'
        const ts = Number(v.ts||0);
        if (v.kind!=='slide' || (lastTs && ts && ts<=lastTs)) return;

        lastTs = ts || Date.now();
        showSlide(v.title||'', v.caption||'', v.image||v.imageURL||v.url||'');
        setStatus('manual'); say(`Slide: ${v.title||'untitled'}`);
      }, err=>{
        setStatus('read error'); say(`Manual read error: ${err.code||err.message}`);
        console.error('[viewer] manual subscribe error', err);
      });
    }

    // ---------- GPS mode (minimal + preloading) ----------
    function toStorageRefString(v){
      if(!v) return ''; let s=(v+'').trim(); try{s=decodeURIComponent(s);}catch{}
      if(s.startsWith('gs://')) return s;
      let m=s.match(/^https?:\/\/firebasestorage\.googleapis\.com\/v0\/b\/([^/]+)\/o\/([^?]+)/i); if(m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      m=s.match(/^https?:\/\/([^/]+)\.firebasestorage\.app\/o\/([^?]+)/i); if(m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      if(!/^https?:\/\//i.test(s)) return `gs://${FORCE_BUCKET}/${s}`;
      return '';
    }
    async function blobToDataURLViaStorage(pathOrGs){
      const refStr=toStorageRefString(pathOrGs); if(!refStr) return '';
      const ref=storage.refFromURL(refStr); const blob=await ref.getBlob();
      return await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
    }
    function toDataURLFromStored(stored){
      if(!stored) return ''; if(typeof stored==='string') return stored;
      if(stored.data){ const fmt=(stored.format==='jpeg'||stored.format==='jpg')?'jpeg':'png'; return `data:image/${fmt};base64,${stored.data}`;}
      return '';
    }
    function normalizeStops(stopsLike){
      if(!stopsLike) return []; const arr=Array.isArray(stopsLike)?stopsLike:Object.values(stopsLike);
      return arr.map(s=>({title:s.title||s.name||'',caption:s.caption||s.text||'',lat:+(s.lat??s.latitude??s.latDeg),lng:+(s.lng??s.lon??s.long??s.longitude??s.lngDeg),radiusMeters:+(s.radiusMeters??s.radius??s.r)||40,imageDataURL:toDataURLFromStored(s.imageData||s.imageURL||s.imageUrl||s.url||s.photoURL||s.photo),storagePath:s.storagePath||s.thumbPath||'',gsUri:s.gsUri||''}));
    }
    const toRad=x=>x*Math.PI/180; 
    const hav=(aLat,aLng,bLat,bLng)=>{const R=6371000,dLat=toRad(bLat-aLat),dLng=toRad(bLng-aLng);const A=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(A));};
    function inside(stop,la,ln,acc){const d=hav(la,ln,stop.lat,stop.lng);const pad=Math.min(Math.max(+acc||0,0),3);return d<=((+stop.radiusMeters)||0)+pad;}
    async function preloadScenario(stops){
      cache=new Array(stops.length).fill(''); let done=0;
      for(let i=0;i<stops.length;i++){const s=stops[i]; try{
          if(s.imageDataURL) cache[i]=s.imageDataURL;
          else if(s.gsUri)   cache[i]=await blobToDataURLViaStorage(s.gsUri);
          else if(s.storagePath) cache[i]=await blobToDataURLViaStorage(s.storagePath);
        }catch{} done++; setStatus(`preloading ${done}/${stops.length}`);}
      setStatus('ready');
    }
    async function loadScenario(id){
      let sc=await fetchNode(`geophoto/scenarios/${id}`); if(!sc) sc=await fetchNode(`scenarios/${id}`);
      if(!sc) throw new Error('Scenario not found');
      const stops=normalizeStops(sc.stops).filter(s=>Number.isFinite(s.lat)&&Number.isFinite(s.lng));
      current={id,title:sc.title||sc.name||'',dispatch:String(sc.dispatch||sc.notes||''),stops}; await preloadScenario(stops);
    }
    async function startGPS(){
      if(!current||!current.stops.length){say('No stops');return;}
      if(current.dispatch) showSlide('Dispatch',current.dispatch,'');
      if(watchId){try{navigator.geolocation.clearWatch(watchId);}catch{} watchId=null;} lastIdx=-1;
      watchId=navigator.geolocation.watchPosition(p=>{
        const {latitude:la,longitude:ln,accuracy:acc}=p.coords;
        const hits=current.stops.map((st,i)=>({i,st,dist:hav(la,ln,st.lat,st.lng)})).filter(o=>inside(o.st,la,ln,acc)).sort((a,b)=>a.dist-b.dist);
        if(!hits.length) return; const best=hits[0]; if(best.i!==lastIdx){lastIdx=best.i; showSlide(best.st.title||'',best.st.caption||'',cache[best.i]||''); say(`Unlocked: ${best.st.title||('Stop '+(best.i+1))}`);}
      }, err=>{ say(`GPS error: ${err.message}`); }, {enableHighAccuracy:true,maximumAge:0,timeout:20000});
    }

    // Start/Stop
    async function start(){
      if(running) return; await ensureAuthed(); running=true; startBtn.textContent='Stop';
      const val=sel.value, session=(sessionInput.value||'default').trim()||'default';
      if(val==='__manual__'){ setStatus('manual'); subscribeManual(session); return; }
      try{ setStatus('loading…'); await loadScenario(val); showSlide('Dispatch', current.dispatch||'', ''); await startGPS(); }
      catch(e){ setStatus('error'); say(`Scenario load error: ${e.message}`); console.error(e); }
    }
    function stop(){
      running=false; startBtn.textContent='Start';
      if(manualRef) try{manualRef.off();}catch{}; manualRef=null;
      if(helloRef) try{helloRef.off();}catch{}; helloRef=null;
      if(watchId){try{navigator.geolocation.clearWatch(watchId);}catch{}; watchId=null;}
      current=null; cache=[]; lastIdx=-1; lastTs=0;
      img.src=''; cap.textContent=''; cap.style.display='none'; setStatus('idle'); say('');
    }
    startBtn.addEventListener('click', ()=> running?stop():start());

    // Boot
    (async ()=>{
      try{
        await ensureAuthed();
        authPill.title = `db: ${config.databaseURL}`;
        await loadScenarios();
        setStatus('idle'); say('Select Instructor-led or a scenario, then Start.');
        if(qs.get('id')) sel.value=qs.get('id');
      }catch(e){ setStatus('auth failed'); say(`Viewer locked: ${e.code||e.message}`); }
    })();
  })();
  </script>
</body>
</html>
