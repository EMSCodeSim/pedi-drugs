<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM â€” Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    html,body{margin:0;padding:0;height:100%;background:#0b0f14;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow:hidden}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(12,15,22,.78);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center;font-weight:900}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:#c3d3ff;font-size:12px}
    .ok{color:#9ff7c2;border-color:rgba(159,247,194,.35)}
    .bad{color:#ffb3b3;border-color:rgba(255,179,179,.35)}
    .input,select{min-width:180px;padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0f1624;color:#eaf2ff;outline:none}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,#54a6ff,#0a84ff);color:#03131b}
    .btn.secondary{background:transparent;color:#eaf2ff;border:1px solid rgba(255,255,255,.18)}
    #viewerWrap{position:fixed;top:76px;left:0;width:100%;height:calc(100% - 136px);display:flex;justify-content:center;align-items:center}
    #photo{width:100%;height:100%;object-fit:contain;background:#000}
    #caption{position:absolute;left:0;right:0;bottom:60px;text-align:center;font-size:18px;padding:12px 16px;background:linear-gradient(0deg,rgba(0,0,0,.65),transparent);display:none}
    #controlsBar{position:fixed;left:0;right:0;bottom:0;display:flex;gap:10px;align-items:center;justify-content:center;padding:10px;background:rgba(12,15,22,.8);backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,.07)}
    .hint{position:fixed;top:76px;left:0;right:0;text-align:center;font-size:12px;color:#a8c1ff;opacity:.95;padding:6px 10px}
    .hint.bad{color:#ff9b9b}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brand">FireOps SIM â€” Viewer</div>

      <select id="modeSel" class="input" aria-label="Mode">
        <option value="manual">Manual Mode (Instructor)</option>
        <option value="gps">GPS Mode (Geofenced)</option>
      </select>

      <input id="sessionInput" class="input" placeholder="Session (default)" />
      <select id="scenarioSel" class="input" aria-label="Scenario for GPS Mode">
        <option value="">Select scenarioâ€¦</option>
      </select>

      <button id="startBtn" class="btn">Start</button>
      <button id="readBtn" class="btn secondary">ðŸ”Š Read Text</button>

      <span id="authPill" class="pill">auth: â€¦</span>
      <span id="pathPill" class="pill">path: â€¦</span>
      <span id="statusPill" class="pill">status: idle</span>
    </div>
  </div>

  <div id="status" class="hint" role="status" aria-live="polite"></div>

  <div id="viewerWrap" aria-live="polite">
    <img id="photo" alt="Scenario Photo" decoding="async" loading="eager" fetchpriority="high">
    <div id="caption"></div>
  </div>

  <div id="controlsBar">
    <button id="clearBtn" class="btn secondary" type="button">Clear Screen</button>
    <button id="testBtn" class="btn secondary" type="button">Test Slide (manual)</button>
  </div>

  <!-- Firebase (compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const photo = $('photo');
    const caption = $('caption');
    const startBtn = $('startBtn');
    const readBtn = $('readBtn');
    const clearBtn = $('clearBtn');
    const testBtn = $('testBtn');
    const modeSel = $('modeSel');
    const sessionInput = $('sessionInput');
    const scenarioSel = $('scenarioSel');
    const authPill = $('authPill');
    const pathPill = $('pathPill');
    const statusPill = $('statusPill');
    const statusEl = $('status');

    const qs = new URLSearchParams(location.search);
    if (qs.get('mode')) modeSel.value = (qs.get('mode')||'').toLowerCase()==='gps' ? 'gps' : 'manual';
    sessionInput.value = qs.get('session') || 'default';

    // Firebase init
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.firebasestorage.app",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const storage = firebase.storage();
    const FORCE_BUCKET = "dailyquiz-d5279.appspot.com";

    // ---- UI helpers ----
    const setStatus = (msg, bad=false)=>{ statusEl.textContent = msg||''; statusEl.className='hint'+(bad?' bad':''); };
    const setPill = (el, text, good=null)=>{ el.textContent=text; el.className='pill'+(good===true?' ok':good===false?' bad':''); };
    const synthOK = ('speechSynthesis' in window); let lastSpeech = '';
    function speak(t){ if(!synthOK || !t) return; try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); speechSynthesis.speak(u);}catch{} }
    function showSlide(title, text, dataURL){
      if(dataURL){ photo.src=dataURL; } else { photo.src=''; }
      const cap = (title ? title + (text ? ' â€” ' : '') : '') + (text||'');
      caption.textContent = cap;
      caption.style.display = cap ? 'block' : 'none';
      lastSpeech = (title ? (title + '. ') : '') + (text || '');
    }
    function clearScreenUI(){ photo.src=''; caption.textContent=''; caption.style.display='none'; }

    // ---- Auth gate (required under new rules) ----
    async function ensureAuthed(){
      return new Promise((resolve,reject)=>{
        const unsub = auth.onAuthStateChanged(async (u)=>{
          if (u){ setPill(authPill, 'auth: anon âœ“ '+u.uid.slice(0,8), true); unsub(); resolve(u); }
          else{
            try{ await auth.signInAnonymously(); }
            catch(e){ setPill(authPill, 'auth: failed', false); unsub(); reject(e); }
          }
        });
      });
    }

    // ---- Data helpers ----
    function toDataURL(stored){
      if (!stored) return '';
      if (typeof stored === 'string') return stored;
      if (stored.data){
        const fmt = (stored.format==='jpeg'||stored.format==='jpg') ? 'jpeg' : 'png';
        return `data:image/${fmt};base64,${stored.data}`;
      }
      return '';
    }
    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      const arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const num=v=> (v===0||v===null||v===undefined) ? v : parseFloat(v);
        return {
          title: s.title || s.name || '',
          caption: s.caption || s.text || '',
          lat: num(s.lat ?? s.latitude ?? s.latDeg),
          lng: num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg),
          radiusMeters: num(s.radiusMeters ?? s.radius ?? s.r) || 40,
          image: toDataURL(s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo),
          storagePath: s.storagePath || s.thumbPath || '',
          gsUri: s.gsUri || ''
        };
      }).filter(s => typeof s.lat==='number' && typeof s.lng==='number');
    }
    function toStorageRefString(v){
      if(!v) return '';
      let s = (v+'').trim();
      try{ s = decodeURIComponent(s); }catch{}
      if (s.startsWith('gs://')) return s;
      let m = s.match(/^https?:\/\/firebasestorage\.googleapis\.com\/v0\/b\/([^/]+)\/o\/([^?]+)/i);
      if (m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      m = s.match(/^https?:\/\/([^/]+)\.firebasestorage\.app\/o\/([^?]+)/i);
      if (m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      if (!/^https?:\/\//i.test(s)) return `gs://${FORCE_BUCKET}/${s}`;
      return '';
    }
    async function blobToDataURLViaStorage(pathOrGs){
      const refStr = toStorageRefString(pathOrGs);
      if (!refStr) return '';
      const ref = storage.refFromURL(refStr);
      const blob = await ref.getBlob();
      return await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
    }

    async function fetchNode(path){
      const snap = await db.ref(path).get();
      return snap.exists() ? snap.val() : null;
    }

    async function loadAllScenarios(){
      const out=[];
      try{
        const a = await fetchNode('geophoto/scenarios'); if (a) for (const [id,s] of Object.entries(a)) out.push({ id, ...(s||{}) });
      }catch{}
      try{
        const b = await fetchNode('scenarios'); if (b) for (const [id,s] of Object.entries(b)) out.push({ id, ...(s||{}) });
      }catch{}
      // de-dupe
      const map=new Map(); out.forEach(s=>{ if(!map.has(s.id)) map.set(s.id,s); });
      return Array.from(map.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    }
    async function populateScenarioDropdown(){
      const list = await loadAllScenarios();
      scenarioSel.innerHTML = '<option value="">Select scenarioâ€¦</option>';
      list.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id; o.textContent=sc.title || sc.name || '(untitled)';
        scenarioSel.appendChild(o);
      });
      const pre = qs.get('id');
      if (pre && list.some(s=>s.id===pre)) scenarioSel.value = pre;
    }

    // ---- Manual mode ----
    let manualRef=null;
    function subscribeManual(session){
      if (manualRef) try{ manualRef.off(); }catch{}
      const path = `geophoto/manual/${session}/current`;
      setPill(pathPill, 'path: '+path);
      manualRef = db.ref(path);
      manualRef.on('value', snap=>{
        const v = snap.val();
        if (!v || v.clear){
          clearScreenUI();
          setStatus('Waiting for instructorâ€¦');
          setPill(statusPill, 'status: waiting');
          return;
        }
        const img = v.image || v.imageURL || v.url || '';
        showSlide(v.title||'', v.caption||'', img||'');
        setStatus('Showing: '+(v.title || 'slide'));
        setPill(statusPill, 'status: playing', true);
      }, err=>{
        setStatus('Read denied on manual path â€” check rules', true);
        setPill(statusPill, 'status: error', false);
        console.error('[viewer] manual subscribe error', err);
      });
    }
    async function clearManual(session){
      try{ await db.ref(`geophoto/manual/${session}/current`).set({ clear:true }); setStatus('Cleared'); }
      catch(e){ setStatus('Clear failed â€” rules?', true); }
    }
    async function testManual(session){
      const sample = { title:'Test', caption:'If you see this, manual pipe works.', image:'' };
      try{ await db.ref(`geophoto/manual/${session}/current`).set(sample); setStatus('Test sent'); }
      catch(e){ setStatus('Test failed â€” rules?', true); }
    }

    // ---- GPS mode ----
    const toRad = x => x*Math.PI/180;
    const hav=(aLat,aLng,bLat,bLng)=>{ const R=6371000, dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng); const A=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(A)); };
    function inside(stop, la, ln, acc){
      const d = hav(la, ln, stop.lat, stop.lng);
      const pad = Math.min(Math.max(Number(acc)||0, 0), 3);
      return d <= (Number(stop.radiusMeters)||0) + pad;
    }

    let running=false, watchId=null, current=null, lastStopIndex=-1;
    async function loadScenarioById(id){
      let sc = await fetchNode(`geophoto/scenarios/${id}`);
      if(!sc) sc = await fetchNode(`scenarios/${id}`);
      if (!sc) return null;
      const stops = normalizeStops(sc.stops);
      return { id, title: sc.title||sc.name||'', dispatch: sc.dispatch||sc.notes||'', stops, _raw:sc };
    }
    async function resolveStopImage(stop){
      if (stop.image) return stop.image;
      if (stop.gsUri)  { try{ return await blobToDataURLViaStorage(stop.gsUri); }catch{} }
      if (stop.storagePath){ try{ return await blobToDataURLViaStorage(stop.storagePath); }catch{} }
      return '';
    }

    async function startGPS(){
      const id = scenarioSel.value;
      if (!id){ alert('Select a scenario first (GPS mode).'); return; }
      current = await loadScenarioById(id);
      if (!current || !current.stops.length){ alert('Scenario not found or has no stops.'); return; }
      setPill(statusPill, 'status: gps watching');
      setStatus(current.dispatch ? ('Dispatch: '+current.dispatch) : 'GPS mode â€” move toward a stop.');
      showSlide('Dispatch', current.dispatch||'', '');

      if (watchId) { try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId=null; }
      try{
        watchId = navigator.geolocation.watchPosition(async p=>{
          if (!running || !current) return;
          const { latitude:la, longitude:ln, accuracy:acc } = p.coords;
          const hits = current.stops
            .map((st, i) => ({i, st, dist: hav(la, ln, st.lat, st.lng)}))
            .filter(obj => inside(obj.st, la, ln, acc))
            .sort((a,b)=> a.dist - b.dist);
          if (hits.length === 0) return;
          const best = hits[0];
          if (best.i !== lastStopIndex){
            lastStopIndex = best.i;
            const img = await resolveStopImage(best.st);
            showSlide(best.st.title||'', best.st.caption||'', img);
            setStatus('Unlocked: '+(best.st.title || `Stop ${best.i+1}`));
          }
        }, err=>{ setStatus('GPS error: '+err.message, true); }, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
      }catch(e){ setStatus('GPS not permitted', true); }
    }

    // Wake Lock fallback (optional)
    let wakeLock=null, keepAliveVideo=null;
    async function acquireWakeLock(){
      try{ if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=>{ wakeLock=null; }); return; } }catch{}
      if (!keepAliveVideo) {
        keepAliveVideo = document.createElement('video');
        keepAliveVideo.setAttribute('playsinline',''); keepAliveVideo.muted = true; keepAliveVideo.loop = true;
        keepAliveVideo.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAAAAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQA=';
        keepAliveVideo.style.cssText='position:fixed;width:1px;height:1px;opacity:0;pointer-events:none';
        document.body.appendChild(keepAliveVideo);
      }
      try{ await keepAliveVideo.play(); }catch{}
    }
    async function releaseWakeLock(){
      try{ if (wakeLock) { await wakeLock.release(); wakeLock=null; } }catch{}
      try{ if (keepAliveVideo){ await keepAliveVideo.pause(); } }catch{}
    }

    // ---- Start/Stop wiring ----
    function subscribeMode(){
      const mode = modeSel.value;
      if (mode === 'manual'){
        const session = (sessionInput.value || 'default').trim() || 'default';
        subscribeManual(session);
      } else {
        // GPS â€” subscription is the geolocation watcher started later
        if (manualRef) try{ manualRef.off(); }catch{} manualRef=null;
      }
    }
    async function start(){
      if (running) return;
      await ensureAuthed();
      running = true; startBtn.textContent='Stop';
      setPill(statusPill, 'status: starting');
      await acquireWakeLock();

      if (modeSel.value === 'manual'){
        subscribeMode();
        setStatus('Manual mode â€” connected');
      } else {
        await startGPS();
      }
    }
    async function stop(){
      running=false; startBtn.textContent='Start';
      setPill(statusPill, 'status: idle');
      if (manualRef) try{ manualRef.off(); }catch{} manualRef=null;
      if (watchId) { try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId=null; }
      await releaseWakeLock();
      clearScreenUI(); setStatus('Stopped.');
    }

    startBtn.addEventListener('click', ()=> running ? stop() : start());
    readBtn.addEventListener('click', ()=> speak(lastSpeech||'Ready.'));
    clearBtn.addEventListener('click', async ()=>{
      await ensureAuthed();
      const session = (sessionInput.value || 'default').trim() || 'default';
      clearManual(session);
    });
    testBtn.addEventListener('click', async ()=>{
      await ensureAuthed();
      const session = (sessionInput.value || 'default').trim() || 'default';
      testManual(session);
    });
    modeSel.addEventListener('change', ()=> {
      setStatus('');
      setPill(pathPill, 'path: â€¦');
      if (modeSel.value === 'manual'){ scenarioSel.disabled = true; }
      else { scenarioSel.disabled = false; }
    });

    // ---- Boot ----
    (async ()=>{
      setStatus('Connectingâ€¦');
      try{
        await ensureAuthed();
        await populateScenarioDropdown();
        scenarioSel.disabled = (modeSel.value==='manual');
        // auto-start if requested
        const auto = (qs.get('autostart')||'').toLowerCase()==='1';
        if (auto){ start(); }
        setStatus('Ready.');
      }catch(e){
        setStatus('Auth failed â€” viewer locked', true);
      }
    })();
  })();
  </script>
</body>
</html>
