<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Instructor Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1624; --text:#eaf2ff; --muted:#94a3b8;
      --edge: rgba(255,255,255,.08); --edge2: rgba(255,255,255,.14);
      --grad1:#54a6ff; --grad2:#0a84ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:inherit}
    .topbar{position:sticky;top:0;z-index:40;background:rgba(12,15,22,.78);backdrop-filter:blur(6px);border-bottom:1px solid var(--edge)}
    .topnav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brandmini{display:flex;align-items:center;gap:12px;font-weight:800}
    .logo img{width:40px;height:40px;border-radius:10px;box-shadow:0 12px 34px rgba(0,0,0,.38);background:#0f1624}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .input, select{
      background:var(--panel); color:var(--text); border:1px solid var(--edge2); border-radius:10px;
      padding:10px 12px; outline:none; min-width:180px
    }
    .btn{
      appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;
      background:linear-gradient(180deg,var(--grad1),var(--grad2));color:#03131b;box-shadow:0 12px 34px rgba(0,0,0,.38)
    }
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--edge2)}
    .btn.small{padding:8px 12px;border-radius:10px}
    main{max-width:1200px;margin:16px auto;padding:0 16px 40px;display:grid;grid-template-columns:1.1fr 1.2fr;gap:16px}
    @media (max-width:980px){ main{grid-template-columns:1fr;}}
    .panel{
      background:var(--panel); border:1px solid var(--edge); border-radius:16px; overflow:hidden
    }
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--edge);font-size:16px}
    .current-wrap{position:relative;aspect-ratio:16/9;background:#000}
    .current-wrap img{width:100%;height:100%;object-fit:contain;background:#000}
    .current-caption{
      position:absolute;left:0;right:0;bottom:0;padding:10px 14px;
      background:linear-gradient(0deg,rgba(0,0,0,.65),transparent);font-size:14px
    }
    .meta{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 14px;border-top:1px solid var(--edge);color:var(--muted);font-size:13px}
    .thumbs{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:10px
    }
    .thumb{
      border:1px solid var(--edge);border-radius:12px;overflow:hidden;background:#0a0f18;cursor:pointer;display:flex;flex-direction:column;min-height:170px
    }
    .thumb .img{aspect-ratio:16/10;background:#000;position:relative;display:block}
    .thumb .img img{width:100%;height:100%;object-fit:cover}
    /* Fallback "no image" look (used for Dispatch slide) */
    .thumb .img.noimg{
      background:linear-gradient(180deg,rgba(84,166,255,.25),rgba(10,132,255,.12));
      display:grid;place-items:center;
    }
    .thumb .img.noimg .label{
      font-weight:900; letter-spacing:.6px; text-transform:uppercase; opacity:.9;
      padding:6px 10px; border:1px solid var(--edge2); border-radius:999px; backdrop-filter:blur(2px);
    }
    .thumb .tcap{padding:8px 10px;font-size:13px;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .badge{font-size:12px;padding:4px 8px;border:1px solid var(--edge2);border-radius:999px;color:var(--muted)}
    .sp{flex:1}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo"><img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM"></div>
        <div>FireOps SIM — Instructor</div>
      </div>
      <div class="controls">
        <input id="sessionInput" class="input" placeholder="Session (e.g., alpha)" />
        <select id="scenarioSelect" aria-label="Scenario">
          <option value="">Loading scenarios…</option>
        </select>
        <button id="loadBtn" class="btn small" type="button">Load</button>
        <button id="clearBtn" class="btn secondary small" type="button">Clear Screen</button>
      </div>
    </div>
  </div>

  <main>
    <!-- Left: Current Users View -->
    <section class="panel">
      <h2>Current Users View</h2>
      <div class="current-wrap">
        <img id="currentImg" alt="Current user image">
        <div id="currentCaption" class="current-caption"></div>
      </div>
      <div class="meta">
        <div class="row">
          <span class="badge" id="sessionBadge">session: default</span>
          <span class="badge" id="modeBadge">manual</span>
        </div>
        <div id="status" class="row">Waiting…</div>
      </div>
    </section>

    <!-- Right: Thumbnails -->
    <section class="panel">
      <h2>Scenario Thumbnails</h2>
      <div id="thumbs" class="thumbs" aria-live="polite"></div>
    </section>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const sessionInput = $('#sessionInput');
    const scenarioSelect = $('#scenarioSelect');
    const loadBtn = $('#loadBtn');
    const clearBtn = $('#clearBtn');

    const currentImg = $('#currentImg');
    const currentCaption = $('#currentCaption');
    const statusEl = $('#status');
    const sessionBadge = $('#sessionBadge');

    const thumbsEl = $('#thumbs');

    // Firebase init (same project as viewer)
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // utils
    const qs = new URLSearchParams(location.search);
    sessionInput.value = qs.get('session') || 'default';

    function toDataURL(stored){
      if (!stored) return '';
      if (typeof stored === 'string') return stored;
      if (stored.data){
        const fmt = (stored.format === 'jpeg' || stored.format === 'jpg') ? 'jpeg' : 'png';
        return `data:image/${fmt};base64,${stored.data}`;
      }
      return '';
    }
    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      const arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const num=v=> (v===0||v===null) ? v : parseFloat(v);
        return {
          title: s.title || s.name || '',
          caption: s.caption || s.text || '',
          lat: num(s.lat ?? s.latitude ?? s.latDeg),
          lng: num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg),
          radiusMeters: num(s.radiusMeters ?? s.radius ?? s.r) || 40,
          image: toDataURL(s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo)
        };
      });
    }

    async function loadAllScenarios(){
      const out=[];
      try{
        const a = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/geophoto/scenarios.json',{cache:'no-store'});
        if(a.ok){ const ja=await a.json()||{}; for(const [id,s] of Object.entries(ja)){ out.push({ id, ...(s||{}), stops: normalizeStops(s?.stops) }); } }
      }catch{}
      try{
        const b = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios.json',{cache:'no-store'});
        if(b.ok){ const jb=await b.json()||{}; for(const [id,s] of Object.entries(jb)){ out.push({ id, ...(s||{}), stops: normalizeStops(s?.stops) }); } }
      }catch{}
      // de-dup
      const map=new Map(); out.forEach(s=>{ if(!map.has(s.id)) map.set(s.id, s); });
      return Array.from(map.values());
    }

    function populateDropdown(list){
      scenarioSelect.innerHTML = '<option value="">Select a scenario…</option>';
      list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      list.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id;
        o.textContent=sc.title || sc.name || '(untitled)';
        scenarioSelect.appendChild(o);
      });
      // Preselect by ?id if present
      const pre = qs.get('id');
      if (pre && list.some(s=>s.id===pre)) scenarioSelect.value = pre;
    }

    // Live subscription to current users view
    let currentRef = null;
    function subscribeCurrent(session){
      if (currentRef) currentRef.off();
      const path = `geophoto/manual/${session}/current`;
      currentRef = db.ref(path);
      sessionBadge.textContent = 'session: ' + session;

      currentRef.on('value', snap=>{
        const v = snap.val();
        if (!v || v.clear){
          currentImg.src = '';
          currentCaption.textContent = '';
          statusEl.textContent = 'Waiting…';
          return;
        }
        const image = toDataURL(v.image || v.imageURL || v.imageUrl || v.url || v.photoURL || v.photo || '');
        currentImg.src = image || '';
        const capText = (v.title ? (v.title + ' — ') : '') + (v.caption || '');
        currentCaption.textContent = capText;
        statusEl.textContent = 'Showing: ' + (v.title || '(untitled)');
      });
    }

    // Push a frame to users
    async function pushFrame(session, stop){
      const path = `geophoto/manual/${session}/current`;
      const payload = {
        title: stop.title || '',
        caption: stop.caption || '',
        image: stop.image || ''  // can be data URL or https URL; empty => black slide with caption
      };
      try{
        await db.ref(path).set(payload);
        statusEl.textContent = 'Sent: ' + (stop.title || '(untitled)');
      }catch(e){
        statusEl.textContent = 'Error sending frame';
        console.error(e);
      }
    }
    async function clearScreen(session){
      const path = `geophoto/manual/${session}/current`;
      try{
        await db.ref(path).set({ clear:true });
        statusEl.textContent = 'Cleared';
      }catch(e){
        statusEl.textContent = 'Error clearing';
        console.error(e);
      }
    }

    // Build thumbnails grid (adds Dispatch slide first when available)
    function renderThumbs(stops, session, dispatchText){
      thumbsEl.innerHTML = '';

      // 0) Dispatch slide (no image) if provided
      if (dispatchText){
        const dCard = document.createElement('div');
        dCard.className = 'thumb';
        dCard.title = 'Dispatch — ' + dispatchText;

        const dImgWrap = document.createElement('div');
        dImgWrap.className = 'img noimg';
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = 'Dispatch';
        dImgWrap.appendChild(label);

        const dCap = document.createElement('div');
        dCap.className = 'tcap';
        dCap.innerHTML = `<strong>Dispatch</strong><br>${dispatchText}`;

        dCard.appendChild(dImgWrap);
        dCard.appendChild(dCap);
        dCard.addEventListener('click', ()=> pushFrame(session, { title:'Dispatch', caption: dispatchText, image:'' }));
        thumbsEl.appendChild(dCard);
      }

      // 1) Regular stops
      if (!stops || !stops.length){
        // (If no stops AND no dispatch, show empty state)
        if (!dispatchText){
          const empty = document.createElement('div');
          empty.style.cssText = 'padding:12px;color:#94a3b8';
          empty.textContent = 'No stops found for this scenario.';
          thumbsEl.appendChild(empty);
        }
        return;
      }

      stops.forEach((st)=>{
        const card = document.createElement('div');
        card.className = 'thumb';
        card.title = (st.title || 'Untitled') + (st.caption ? (' — ' + st.caption) : '');

        const imgWrap = document.createElement('div');
        imgWrap.className = 'img';
        const hasImg = !!st.image;
        if (hasImg){
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.decoding = 'async';
          img.src = st.image || '';
          img.alt = st.title || 'Scenario image';
          imgWrap.appendChild(img);
        }else{
          imgWrap.classList.add('noimg');
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = (st.title || 'Slide');
          imgWrap.appendChild(label);
        }

        const cap = document.createElement('div');
        cap.className = 'tcap';
        cap.innerHTML = `<strong>${st.title || 'Untitled'}</strong><br>${st.caption || ''}`;

        card.appendChild(imgWrap);
        card.appendChild(cap);

        card.addEventListener('click', ()=> pushFrame(session, st));
        thumbsEl.appendChild(card);
      });
    }

    // Wire UI
    loadBtn.addEventListener('click', async ()=>{
      const session = (sessionInput.value || 'default').trim();
      const scenarioId = scenarioSelect.value;
      if (!scenarioId){ alert('Select a scenario.'); return; }

      // 1) subscribe to current users view for this session
      subscribeCurrent(session);

      // 2) fetch scenario and render thumbs (+ dispatch slide if available)
      let sc=null;
      try{
        const rA = await fetch(`https://dailyquiz-d5279-default-rtdb.firebaseio.com/geophoto/scenarios/${scenarioId}.json`,{cache:'no-store'});
        if(rA.ok) sc = await rA.json();
      }catch{}
      if(!sc){
        try{
          const rB = await fetch(`https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios/${scenarioId}.json`,{cache:'no-store'});
          if(rB.ok) sc = await rB.json();
        }catch{}
      }
      const stops = normalizeStops(sc?.stops) || [];
      const dispatchText = ((sc?.dispatch || sc?.notes || '') + '').trim();
      renderThumbs(stops, session, dispatchText);
      statusEl.textContent = 'Loaded scenario: ' + (sc?.title || sc?.name || scenarioId);
    });

    clearBtn.addEventListener('click', ()=>{
      const session = (sessionInput.value || 'default').trim();
      clearScreen(session);
    });

    // Boot
    (async function boot(){
      const list = await loadAllScenarios();
      populateDropdown(list);
      // Auto-load if both session & id are provided
      const autoId = qs.get('id');
      if (autoId && list.some(s=>s.id===autoId)){
        scenarioSelect.value = autoId;
      }
      subscribeCurrent(sessionInput.value || 'default');
    })();

  })();
  </script>
</body>
</html>
