<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Instructor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14; --panel:#0f1624; --text:#eaf2ff; --muted:#94a3b8; --edge:rgba(255,255,255,.12); --a1:#54a6ff; --a2:#0a84ff; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .topbar{position:sticky;top:0;z-index:40;background:rgba(12,15,22,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--edge)}
    .topnav{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input, select{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--edge);background:#0f1624;color:var(--text);min-width:160px}
    .btn{height:40px;padding:0 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,var(--a1),var(--a2));color:#03131b}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--edge)}
    .pill{font-size:12px;padding:6px 10px;border:1px solid var(--edge);border-radius:999px;color:var(--muted);white-space:nowrap;max-width:100%;overflow:hidden;text-overflow:ellipsis}
    main{max-width:1200px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:1.05fr 1fr;gap:14px}
    @media (max-width:980px){ main{grid-template-columns:1fr} }
    .panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;overflow:hidden}
    .panel h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--edge);font-size:16px}
    .current{position:relative;aspect-ratio:16/9;background:#000}
    .current img{width:100%;height:100%;object-fit:contain}
    .caption{position:absolute;left:0;right:0;bottom:0;padding:10px 12px;background:linear-gradient(0deg,rgba(0,0,0,.65),transparent)}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:10px}
    .thumb{border:1px solid var(--edge);border-radius:12px;background:#0a0f18;cursor:pointer;overflow:hidden}
    .thumb .img{aspect-ratio:16/10;background:#000;display:grid;place-items:center;color:#cbd5e1}
    .thumb .img img{width:100%;height:100%;object-fit:cover}
    .thumb .cap{padding:8px 10px;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="row">
        <strong>FireOps SIM — Instructor</strong>
        <span id="authPill" class="pill">auth: …</span>
        <span id="dbPill"   class="pill">db: …</span>
        <span id="pathPill" class="pill">path: …</span>
      </div>
      <div class="row">
        <input id="sessionInput" class="input" placeholder="Session" value="default" />
        <select id="scenarioSelect" class="input"><option value="">Loading scenarios…</option></select>
        <button id="loadBtn"  class="btn">Load</button>
        <button id="clearBtn" class="btn secondary">Clear</button>
        <button id="helloBtn" class="btn secondary">Hello</button>
        <button id="testBtn"  class="btn secondary">Send Test</button>
        <span id="status" class="pill">idle</span>
      </div>
    </div>
  </div>

  <main>
    <section class="panel">
      <h2>Current Users View</h2>
      <div class="current">
        <img id="currentImg" alt="Current">
        <div id="currentCap" class="caption"></div>
      </div>
    </section>
    <section class="panel">
      <h2>Scenario Thumbnails (click to send)</h2>
      <div id="thumbs" class="thumbs"></div>
    </section>
  </main>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
  <!-- App Check (enable if Enforcement is ON) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>

  <script>
  (function(){
    const $=s=>document.querySelector(s);
    const config = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.firebasestorage.app",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    firebase.initializeApp(config);

    // App Check (uncomment + add your site key if App Check is enforced)
    // self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; // DEV only; remove in prod
    // firebase.appCheck().activate('YOUR_RECAPTCHA_V3_SITE_KEY', true);

    const db=firebase.database(), auth=firebase.auth(), storage=firebase.storage();
    const FORCE_BUCKET="dailyquiz-d5279.appspot.com";

    // UI
    const authPill=$('#authPill'), dbPill=$('#dbPill'), pathPill=$('#pathPill'), statusEl=$('#status');
    const sessionInput=$('#sessionInput'), scenarioSelect=$('#scenarioSelect');
    const loadBtn=$('#loadBtn'), clearBtn=$('#clearBtn'), helloBtn=$('#helloBtn'), testBtn=$('#testBtn');
    const thumbs=$('#thumbs'), currentImg=$('#currentImg'), currentCap=$('#currentCap');
    const setStatus=t=> statusEl.textContent=t;

    // Paths
    function normSession(raw){return (raw||'default').trim().toLowerCase();}
    function manualPath(s){return `geophoto/manual/${normSession(s)}/current`;}
    function helloPath(s){return `geophoto/manual/${normSession(s)}/hello`;}

    // Auth
    async function ensureAuthed(){
      return new Promise((resolve,reject)=>{
        const unsub=auth.onAuthStateChanged(u=>{
          if(u){ authPill.textContent=`auth: anon ✓ ${u.uid.slice(0,8)}`; unsub(); resolve(u); }
          else auth.signInAnonymously().catch(e=>{ authPill.textContent=`auth: failed (${e.code||e.message})`; unsub(); reject(e); });
        });
      });
    }

    // Data helpers
    async function fetchNode(path){ const snap=await db.ref(path).get(); return snap.exists()?snap.val():null; }
    async function loadScenarios(){
      const list=[];
      try{const a=await fetchNode('geophoto/scenarios'); if(a) for(const [id,s] of Object.entries(a)) list.push({id,...(s||{})});}catch(e){ setStatus(`scenarios read err: ${e.code||e.message}`); }
      try{const b=await fetchNode('scenarios');          if(b) for(const [id,s] of Object.entries(b)) list.push({id,...(s||{})});}catch(e){}
      const uniq=new Map(); list.forEach(x=>{if(!uniq.has(x.id))uniq.set(x.id,x);});
      const arr=Array.from(uniq.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      scenarioSelect.innerHTML='<option value="">Select a scenario…</option>';
      arr.forEach(sc=>{const o=document.createElement('option');o.value=sc.id;o.textContent=sc.title||sc.name||'(untitled)';scenarioSelect.appendChild(o);});
      if(arr.length===0) setStatus('no scenarios / rules?');
      return arr;
    }
    function toDataURLFromStored(stored){
      if(!stored) return ''; if(typeof stored==='string') return stored;
      if(stored.data){ const fmt=(stored.format==='jpeg'||stored.format==='jpg')?'jpeg':'png'; return `data:image/${fmt};base64,${stored.data}`;}
      return '';
    }
    function toStorageRefString(v){
      if(!v) return ''; let s=(v+'').trim(); try{s=decodeURIComponent(s);}catch{}
      if(s.startsWith('gs://')) return s;
      let m=s.match(/^https?:\/\/firebasestorage\.googleapis\.com\/v0\/b\/([^/]+)\/o\/([^?]+)/i); if(m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      m=s.match(/^https?:\/\/([^/]+)\.firebasestorage\.app\/o\/([^?]+)/i); if(m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      if(!/^https?:\/\//i.test(s)) return `gs://${FORCE_BUCKET}/${s}`;
      return '';
    }
    async function blobToDataURLViaStorage(pathOrGs){
      const refStr=toStorageRefString(pathOrGs); if(!refStr) return '';
      const ref=storage.refFromURL(refStr); const blob=await ref.getBlob();
      return await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
    }
    async function getStopDataURL(st){
      const inline=toDataURLFromStored(st.imageData||st.imageURL||st.imageUrl||st.url||st.photoURL||st.photo);
      if(inline) return inline;
      if(st.gsUri) try{return await blobToDataURLViaStorage(st.gsUri);}catch{}
      if(st.storagePath) try{return await blobToDataURLViaStorage(st.storagePath);}catch{}
      return '';
    }
    async function compressDataURL(dataURL, maxEdge=1600, q=0.85){
      if(!dataURL) return ''; if(!/^data:image\//i.test(dataURL)) return dataURL;
      const img=new Image(); img.decoding='async'; img.src=dataURL; await img.decode();
      const w=img.naturalWidth,h=img.naturalHeight,s=Math.min(1,maxEdge/Math.max(w,h));
      if(s===1) return dataURL;
      const c=document.createElement('canvas'); c.width=Math.round(w*s); c.height=Math.round(h*s);
      const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
      ctx.drawImage(img,0,0,c.width,c.height); return c.toDataURL('image/jpeg', q);
    }

    // Preview current frame
    let currentRef=null;
    function subscribeCurrent(sessionRaw){
      const s=normSession(sessionRaw); const p=manualPath(s); pathPill.textContent=`path: ${p}`;
      if(currentRef) try{ currentRef.off(); }catch{}; currentRef=db.ref(p);
      currentRef.on('value', snap=>{
        const v=snap.val();
        if(!v||v.clear){ currentImg.src=''; currentCap.textContent=''; setStatus('preview waiting…'); return; }
        currentImg.src=v.image||v.imageURL||v.url||''; currentCap.textContent=(v.title? v.title+' — ':'')+(v.caption||'');
        setStatus('preview: '+(v.title||'slide'));
      }, err=>{ setStatus(`preview read error: ${err.code||err.message}`); console.error(err); });
    }

    // Send slide (UPDATE with ts/kind/by; remove any lingering clear)
    async function sendSlide(payload){
      const p = manualPath(sessionInput.value);
      setStatus('sending…');
      try{
        const u = auth.currentUser || await ensureAuthed();
        const frame = {
          ts: Date.now(),
          kind: 'slide',
          by: u?.uid || 'unknown',
          title: payload.title || '',
          caption: payload.caption || '',
          image: payload.image || '',
          clear: null
        };
        await db.ref(p).update(frame); // update avoids wiping node
        setStatus('sent');
      }catch(e){
        setStatus(`write error: ${e.code||e.message}`);
        console.error('[sendSlide]', e);
      }
    }

    // Thumbnails
    async function renderThumbsForScenario(id){
      thumbs.innerHTML='';
      let sc=await fetchNode(`geophoto/scenarios/${id}`); if(!sc) sc=await fetchNode(`scenarios/${id}`);
      if(!sc){ thumbs.innerHTML='<div class="pill">Scenario not found</div>'; return; }
      const rawStops=(Array.isArray(sc.stops)?sc.stops:Object.values(sc.stops||{}))||[];

      const dispatch=String(sc.dispatch||sc.notes||'').trim();
      if(dispatch){
        const card=document.createElement('div'); card.className='thumb';
        const imgWrap=document.createElement('div'); imgWrap.className='img'; imgWrap.textContent='Dispatch';
        const cap=document.createElement('div'); cap.className='cap'; cap.textContent=dispatch;
        card.appendChild(imgWrap); card.appendChild(cap);
        card.onclick=()=> sendSlide({title:'Dispatch', caption:dispatch, image:''});
        thumbs.appendChild(card);
      }

      for(const raw of rawStops){
        const st={ title:raw.title||raw.name||'', caption:raw.caption||raw.text||'', storagePath:raw.storagePath||raw.thumbPath||'', gsUri:raw.gsUri||'', imageData:raw.imageData, imageURL:raw.imageURL||raw.imageUrl||raw.url||raw.photoURL||raw.photo||'' };
        const card=document.createElement('div'); card.className='thumb';
        const imgWrap=document.createElement('div'); imgWrap.className='img';
        const cap=document.createElement('div'); cap.className='cap'; cap.textContent=(st.title||'')+(st.caption?(' — '+st.caption):'');

        try{
          const url=await getStopDataURL(st);
          if(url){ const im=document.createElement('img'); im.src=url; im.alt=st.title||''; imgWrap.innerHTML=''; imgWrap.appendChild(im); }
        }catch{}

        card.appendChild(imgWrap); card.appendChild(cap);
        card.onclick=async ()=>{
          let dataURL=''; try{ dataURL=await getStopDataURL(st); dataURL=await compressDataURL(dataURL,1600,0.85);}catch{}
          await sendSlide({ title:st.title||'', caption:st.caption||'', image:dataURL||'' });
        };
        thumbs.appendChild(card);
      }
    }

    // Buttons
    loadBtn.onclick=async ()=>{
      try{
        await renderThumbsForScenario(scenarioSelect.value);
        subscribeCurrent(sessionInput.value);
        setStatus('loaded');
      }catch(e){ setStatus(`load error: ${e.code||e.message}`); console.error(e); }
    };

    clearBtn.onclick=async ()=>{
      const p = manualPath(sessionInput.value);
      setStatus('clearing…');
      try{
        await db.ref(p).update({ clear:true, ts: Date.now(), title:null, caption:null, image:null, kind:null, by:null });
        setStatus('cleared');
      }catch(e){ setStatus(`clear error: ${e.code||e.message}`); console.error(e); }
    };

    helloBtn.onclick=async ()=>{
      try{
        const u=auth.currentUser || await ensureAuthed();
        await db.ref(helloPath(sessionInput.value)).update({ instructorPing: Date.now(), from: u.uid });
        setStatus('hello sent');
      }catch(e){ setStatus(`hello error: ${e.code||e.message}`); console.error(e); }
    };

    testBtn.onclick=async ()=>{ await sendSlide({ title:'Test', caption:'If viewers see this, we are connected.', image:'' }); };

    // Boot
    (async ()=>{
      try{
        await ensureAuthed();
        dbPill.textContent=`db: ${config.databaseURL}`;
        await loadScenarios();
        subscribeCurrent(sessionInput.value);
        setStatus('idle');
      }catch(e){
        setStatus(`auth/load error: ${e.code||e.message}`); console.error(e);
      }
    })();
  })();
  </script>
</body>
</html>
