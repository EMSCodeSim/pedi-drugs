<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM â€” Geo Scenarios Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" href="data:," />
  <style>
    :root{ --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff; --blue:#0a84ff; --shadow:0 12px 34px rgba(0,0,0,.38); --radius:18px; }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%);
      -webkit-text-size-adjust:100%; scroll-behavior:smooth;
    }
    a{color:inherit; text-decoration:none}
    img{max-width:100%; height:auto; display:block}

    .topbar{position:sticky; top:0; z-index:20; background:rgba(12,15,22,.75); backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1100px; margin:0 auto; padding:10px 20px; display:flex; align-items:center; gap:14px}
    .brandmini{display:flex; align-items:center; gap:12px; font-weight:800}
    .logo img{width:40px; height:40px; border-radius:10px; box-shadow:var(--shadow); object-fit:cover; background:#0f1624}

    .wrap{max-width:1100px; margin:0 auto; padding:18px 20px 100px}
    .grid{display:grid; gap:14px; grid-template-columns:1fr}
    .card{border-radius:var(--radius); background:var(--card); border:1px solid rgba(255,255,255,.07); box-shadow:var(--shadow); overflow:hidden}
    .card-inner{padding:18px}
    .eyebrow{font-size:12px; color:var(--muted); margin-bottom:8px}
    h1,h2,h3{margin:0} h2{font-size:20px} p,.status{color:var(--muted); font-size:14px; margin:6px 0 0}

    .btn{appearance:none; border:0; border-radius:12px; cursor:pointer; padding:12px 14px; font-weight:800; font-size:15px; color:#03131b; background:linear-gradient(180deg,#54a6ff,var(--blue)); box-shadow:var(--shadow); text-align:center}
    .btn[disabled]{opacity:.65; cursor:not-allowed}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14)}

    select{width:100%; padding:14px 12px; font-size:16px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0f1624; color:var(--text); outline:none}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* Viewer area */
    #viewer .card-inner{padding:10px}
    #scTitle{font-size:18px; margin:0 0 8px 0}

    #photoWrap{
      position:relative;
      width:100%;
      height:calc(100vh - 210px); /* fills available screen below header/controls */
      min-height:60vh;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
      overflow:hidden;
    }
    #photo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain; /* full viewer area without cropping */
      image-rendering:auto;
      background:#000;
    }

    /* overlay controls inside the photo box */
    .overlayBar{
      position:absolute; left:0; right:0; bottom:0;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:8px;
      background:linear-gradient(0deg, rgba(0,0,0,.55), transparent);
    }
    .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:#e7f1ff; background:rgba(0,0,0,.35)}
    .rightBtns{display:flex; gap:8px}
    #pushToRead{display:none} /* only shown on iPhone */

    #caption{font-size:15px; color:#e9f1ff; margin-top:10px}
    #detail{font-size:12px; color:#a8c3df; margin-top:4px}

    footer{max-width:1100px; margin:34px auto; padding:0 20px; color:#aebdd1; font-size:13px; border-top:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap}
    #runTimer{font-size:13px; color:#cfe1ff}
    #debug{font-size:12px; color:#ffdede; margin-top:6px; white-space:pre-wrap}
    #diag{font-size:12px; color:#b6d7ff; margin-top:6px; white-space:pre-wrap}

    .spin{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:640px){
      #photoWrap{height:calc(100vh - 240px)}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo" aria-hidden="true"><img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM logo" /></div>
        <div style="line-height:1.1; font-size:15px; font-weight:900">FireOps SIM</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <article class="card">
        <div class="card-inner">
          <div class="eyebrow">Scenario</div>
          <h2>Select & Start</h2>
          <p>Choose a scenario below, then press Start.</p>
          <div class="row" style="margin-top:10px; width:100%">
            <select id="scenarioSelect" aria-label="Choose a scenario"><option value="">Loadingâ€¦</option></select>
          </div>
          <div class="status" id="status" aria-live="polite" style="margin-top:8px">Connectingâ€¦</div>
          <div id="diag"></div>
          <div id="debug" aria-live="polite"></div>
        </div>
      </article>

      <article class="card" id="viewer" style="display:none">
        <div class="card-inner">
          <h3 id="scTitle">(scenario)</h3>

          <div id="result" style="display:none">
            <div id="photoWrap">
              <img id="photo" alt="Photo for this stop" decoding="async" fetchpriority="high">
              <!-- overlay control bar inside the photo -->
              <div class="overlayBar">
                <button id="stopScenario" class="btn secondary" type="button">Stop Scenario</button>
                <div class="rightBtns">
                  <button id="pushToRead" class="btn secondary" type="button">ðŸ”Š Push to Read</button>
                  <span class="pill" id="runTimer">00:00</span>
                </div>
              </div>
            </div>
            <div id="caption" style="white-space:pre-wrap;"></div>
            <div id="detail"></div>
          </div>
        </div>
      </article>

      <article class="card">
        <div class="card-inner">
          <div class="eyebrow">Run</div>
          <h2>Scenario Controls</h2>
          <p id="ttsNote" class="status">iPhone uses Push-to-Read. Android/Desktop read automatically.</p>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <button id="startScenario" class="btn" type="button">Start Scenario</button>
            <button id="muteToggle" class="btn secondary" type="button">Mute</button>
            <label style="margin-left:auto; color:var(--muted)">Rate
              <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1" />
            </label>
          </div>
        </div>
      </article>
    </div>
  </div>

  <footer>
    <div>Â© <span id="year"></span> FireOps SIM</div>
    <div id="connStatus"></div>
  </footer>

  <!-- Firebase COMPAT ONLY -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const viewer=$('viewer');
    const select=$('scenarioSelect'), status=$('status'), diag=$('diag'), debug=$('debug'), connStatus=$('connStatus');
    const result=$('result'), photo=$('photo'), caption=$('caption'), detail=$('detail'), scTitle=$('scTitle');
    const startBtn=$('startScenario'), muteToggle=$('muteToggle'), rate=$('rate'), runTimer=$('runTimer');
    const pushToRead=$('pushToRead'), stopScenario=$('stopScenario'), ttsNote=$('ttsNote');

    const log = (m)=>{ console.log('[viewer]', m); debug.textContent=String(m); };

    /* Device flags / TTS policy */
    const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const synthOK = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
    const autoSpeak = !isIOS && synthOK;   // Android/Desktop auto
    const buttonSpeak = isIOS && synthOK;  // iPhone uses button
    pushToRead.style.display = buttonSpeak ? '' : 'none';
    ttsNote.textContent = buttonSpeak ? 'iPhone uses Push-to-Read. Android/Desktop read automatically.' : 'Android/Desktop read automatically.';

    /* Firebase */
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref('.info/connected').on('value', snap=>{
      const ok = snap.val() === true;
      connStatus.textContent = ok ? 'Connected' : 'Offline';
      connStatus.style.color = ok ? '#89ffb2' : '#ffdede';
    });

    /* Handle new imageData format {format,data} as data: URL */
    function toDataURLFromStored(val){
      if (!val) return '';
      if (typeof val === 'string') return val;
      if (val && val.data){
        const fmt = (val.format === 'jpeg' || val.format === 'jpg') ? 'jpeg' : 'png';
        return `data:image/${fmt};base64,${val.data}`;
      }
      return '';
    }

    /* Scenario loading */
    let scenarios=[], pathUsed='';
    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      const arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const num = v => (v===0||v===null) ? v : parseFloat(v);
        const lat = num(s.lat ?? s.latitude ?? s.latDeg);
        const lng = num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg);
        const radiusMeters = num(s.radiusMeters ?? s.radius ?? s.r) || 40;
        const title = s.title || s.name || '';
        const caption = s.caption || s.text || s.note || '';
        const image = toDataURLFromStored(s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo || s.img);
        return { ...s, lat, lng, radiusMeters, title, caption, image };
      }).filter(s => typeof s.lat === 'number' && typeof s.lng === 'number');
    }
    function mapSnapshot(val){
      const obj = val || {};
      return Object.entries(obj).map(([id, s])=>({ id, ...(s||{}), stops: normalizeStops(s?.stops) }));
    }
    function populateDropdown(list, sourceLabel){
      list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      select.innerHTML = '<option value="">Select a scenarioâ€¦</option>';
      list.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id;
        o.textContent=sc.title || sc.name || sc.notes || '(untitled)';
        select.appendChild(o);
      });
      status.textContent = list.length ? `${list.length} scenario(s) found` : 'No scenarios yet.';
      pathUsed = sourceLabel || pathUsed;
      diag.textContent = `Loaded from: ${pathUsed || 'â€”'}`;
    }

    const refA = db.ref('geophoto/scenarios');
    const refB = db.ref('scenarios');

    refA.on('value', snap=>{
      const list = mapSnapshot(snap.val());
      if(list.length){ scenarios=list; populateDropdown(list, 'geophoto/scenarios (realtime)'); }
    });
    refB.on('value', snap=>{
      const list = mapSnapshot(snap.val());
      if(!scenarios.length && list.length){ scenarios=list; populateDropdown(list, 'scenarios (realtime)'); }
    });

    // REST fallback after 2s
    setTimeout(async ()=>{
      if (scenarios.length) return;
      try{
        const r = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/geophoto/scenarios.json', {cache:'no-store'});
        if(r.ok){
          const j = await r.json(); const list = mapSnapshot(j);
          if(list.length){ scenarios=list; populateDropdown(list, 'geophoto/scenarios (REST)'); return; }
        }
      }catch{}
      try{
        const r2 = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios.json', {cache:'no-store'});
        if(r2.ok){
          const j2 = await r2.json(); const list2 = mapSnapshot(j2);
          if(list2.length){ scenarios=list2; populateDropdown(list2, 'scenarios (REST)'); return; }
        }
      }catch{}
      if(!scenarios.length){ status.textContent='No scenarios found.'; diag.textContent='Loaded from: none'; }
    }, 2000);

    /* TTS */
    let muted=false, rateVal=1.0; let lastSpeechText='';
    const TTS = (() => {
      if(!synthOK){
        return { unlockOnce:()=>true, say:()=>{}, stop:()=>{}, setRate:()=>{}, setMuted:()=>{} };
      }
      let unlocked=false;
      function chunk(text, max=240){
        const parts=[]; let t=(text||'').replace(/\s+/g,' ').trim();
        const re=/([,;.?!])\s+/g; let last=0, m;
        while((m=re.exec(t)) && (m.index-last) < max){ const piece=t.slice(last, m.index+1).trim(); if(piece) parts.push(piece); last=m.index+1; }
        if(last < t.length) parts.push(t.slice(last));
        return parts.flatMap(p=> p.length<=max ? [p] : p.match(new RegExp('.{1,'+max+'}', 'g')));
      }
      function say(text){
        lastSpeechText = text || '';
        if(!unlocked) return; // iOS waits for gesture
        const q = chunk(text);
        q.forEach(seg=>{
          const u=new SpeechSynthesisUtterance(seg);
          u.rate=rateVal; u.pitch=1; u.volume = muted?0:1;
          try{ speechSynthesis.speak(u); }catch{}
        });
      }
      function unlockOnce(){
        if(unlocked) return true;
        try{ speechSynthesis.cancel(); const prim=new SpeechSynthesisUtterance(' '); prim.volume=0; speechSynthesis.speak(prim); unlocked=true; return true; }catch{ return false; }
      }
      function stop(){ try{ speechSynthesis.cancel(); }catch{} }
      return { unlockOnce, say, stop, setRate:(r)=>{rateVal=r;}, setMuted:(m)=>{muted=m;} };
    })();

    pushToRead.onclick = ()=>{
      TTS.unlockOnce();
      if (lastSpeechText) TTS.say(lastSpeechText);
      else TTS.say('Ready.');
    };

    /* Wake Lock (prevent screen sleep) */
    let wakeLock=null, keepAliveVideo=null;
    async function acquireWakeLock(){
      try{
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
          return;
        }
      }catch{}
      // iOS fallback: play a tiny looping muted video to keep CPU active
      if (!keepAliveVideo) {
        keepAliveVideo = document.createElement('video');
        keepAliveVideo.setAttribute('playsinline','');
        keepAliveVideo.muted=true; keepAliveVideo.loop=true;
        // 1px silent inline video
        keepAliveVideo.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAAAAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQA=';
        keepAliveVideo.style.position='fixed'; keepAliveVideo.style.width='1px'; keepAliveVideo.style.height='1px';
        keepAliveVideo.style.opacity='0'; keepAliveVideo.style.pointerEvents='none';
        document.body.appendChild(keepAliveVideo);
      }
      try{ await keepAliveVideo.play(); }catch{}
    }
    async function releaseWakeLock(){
      try{ if (wakeLock) { await wakeLock.release(); wakeLock=null; } }catch{}
      try{ if (keepAliveVideo){ await keepAliveVideo.pause(); } }catch{}
    }

    /* Geofence + display */
    const toRad = x => x*Math.PI/180;
    const hav=(a,b,c,d)=>{ const R=6371000, dA=toRad(c-a), dB=toRad(d-b);
      return 2*R*Math.asin(Math.sqrt(Math.sin(dA/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dB/2)**2)); };
    function within(hitDist, stopRadius, accuracy){
      const r = (Number(stopRadius)||0) + Math.max(Number(accuracy)||0, 10);
      return hitDist <= r;
    }
    function findHit(stops, la, ln, acc){
      let best=null; (stops||[]).forEach((s,i)=>{
        const d=hav(la,ln,Number(s.lat),Number(s.lng));
        if(within(d, s.radiusMeters, acc)){ if(!best || d<best.dist) best={s,index:i,dist:d}; }
      }); return best;
    }
    function setImage(img, stop){
      img.src = stop.image || "data:image/svg+xml;utf8,"+encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='720'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#9ecbd6' font-size='24' text-anchor='middle'>No image</text></svg>"
      );
      img.onerror=()=>{ img.src="data:image/svg+xml;utf8,"+encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='720'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#9ecbd6' font-size='24' text-anchor='middle'>Image failed to load</text></svg>"
      ); };
    }

    function speakIfAllowed(text){
      lastSpeechText = text || '';
      if (autoSpeak) TTS.say(text);
    }

    function showStop(sc, hit){
      result.style.display='';
      setImage(photo, hit.s);
      caption.textContent=hit.s.caption||'';
      detail.textContent=hit.s.title ? hit.s.title : '';
      const speech = `${hit.s.title ? (hit.s.title+'. ') : ''}${hit.s.caption || ''}`;
      speakIfAllowed(speech);
      viewer.scrollIntoView({behavior:'smooth', block:'start'});
    }

    let current=null, watchId=null, lastStopIndex=-1;

    function openScenarioById(id){
      const sc = scenarios.find(s=>s.id===id);
      if(!sc){ status.textContent='Scenario not found.'; return; }
      current=sc;
      viewer.style.display=''; scTitle.textContent=sc.title||sc.name||sc.notes||'(scenario)';

      result.style.display='none'; caption.textContent=''; detail.textContent='';
      lastStopIndex=-1;

      const intro=(sc.dispatch||sc.notes||sc.title||'').trim();
      speakIfAllowed(intro);

      if(watchId) navigator.geolocation.clearWatch(watchId);
      try{
        watchId=navigator.geolocation.watchPosition(p=>{
          const { latitude:la, longitude:ln, accuracy:acc }=p.coords;
          const hit=findHit((sc.stops||[]), la, ln, acc);
          if(hit && hit.index!==lastStopIndex){
            lastStopIndex=hit.index;
            showStop(sc, hit);
          }
        }, err=>{ /* silent */ }, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
      }catch(e){ /* silent */ }
    }

    /* UI: mute/rate, timer, start/stop */
    muteToggle.onclick=()=>{ const nowMute = (muteToggle.textContent==='Mute'); TTS.setMuted(nowMute); muteToggle.textContent = nowMute ? 'Unmute' : 'Mute'; };
    rate.oninput=e=>{ const r=parseFloat(e.target.value||'1')||1; TTS.setRate(r); };

    function formatTime(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60), sec=s%60; return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); }
    let runInterval=null, startMs=0;
    function startTimer(){ startMs=Date.now(); clearInterval(runInterval); runInterval=setInterval(()=>{ runTimer.textContent=formatTime(Date.now()-startMs); },500); }
    function stopTimer(){ clearInterval(runInterval); runInterval=null; runTimer.textContent='00:00'; }

    async function startScenario(){
      const id=select.value;
      if(!id){ status.textContent='Choose a scenario first.'; return; }
      TTS.unlockOnce();     // primes Android/Desktop and allows iOS after gesture
      await acquireWakeLock();
      startTimer();
      startBtn.textContent='Scenario Running'; startBtn.disabled=true;
      requestAnimationFrame(()=> openScenarioById(id));
    }
    async function stopScenarioNow(){
      viewer.style.display='none';
      try{ navigator.geolocation.clearWatch(watchId); }catch{}
      TTS.stop();
      await releaseWakeLock();
      startBtn.disabled=false; startBtn.textContent='Start Scenario';
      stopTimer();
    }

    startBtn.addEventListener('click', startScenario);
    stopScenario.addEventListener('click', stopScenarioNow);

    // Preselect by ?id=
    (function(){ const pre=new URLSearchParams(location.search).get('id'); if(!pre) return; const iv=setInterval(()=>{ if(select.options.length>1){ clearInterval(iv); select.value=pre; } },200); })();

    /* Misc */
    function resizeViewerArea(){ /* nothing needed; CSS uses viewport height; keep hook if needed later */ }
    window.addEventListener('resize', resizeViewerArea);
    document.getElementById('year').textContent = new Date().getFullYear();
    window.addEventListener('error', e => log('Error: ' + (e.message||e)));
    window.addEventListener('unhandledrejection', e => log('Promise error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));
  })();
  </script>
</body>
</html>
