<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM â€” Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    html,body{margin:0;padding:0;height:100%;background:#0b0f14;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow:hidden}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(12,15,22,.78);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1100px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brandmini{display:flex;align-items:center;gap:12px;font-weight:800}
    .logo img{width:40px;height:40px;border-radius:10px;box-shadow:0 12px 34px rgba(0,0,0,.38);background:#0f1624}
    .header-actions{display:flex;gap:10px;align-items:center}
    #backBtn{appearance:none;border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,#54a6ff,#0a84ff);color:#03131b}
    #scenarioSelect{min-width:240px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0f1624;color:#eaf2ff;outline:none}

    /* Viewer area */
    #viewerWrap{position:fixed;top:60px;left:0;width:100%;height:calc(100% - 120px);display:flex;justify-content:center;align-items:center}
    #photo{width:100%;height:100%;object-fit:cover;background:#000}
    #caption{
      position:absolute;left:0;right:0;bottom:60px;
      text-align:center;font-size:18px;padding:12px 16px;
      background:linear-gradient(0deg,rgba(0,0,0,.65),transparent);
      display:none
    }

    /* Controls (bottom bar) */
    #controlsBar{position:fixed;left:0;right:0;bottom:0;display:flex;gap:10px;align-items:center;justify-content:center;padding:10px;background:rgba(12,15,22,.8);backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,.07)}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,#54a6ff,#0a84ff);color:#03131b;box-shadow:0 12px 34px rgba(0,0,0,.38)}
    .btn.secondary{background:transparent;color:#eaf2ff;border:1px solid rgba(255,255,255,.18)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    @media (max-width:640px){ #caption{font-size:15px} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo"><img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM"></div>
        <div>FireOps SIM</div>
      </div>
      <div class="header-actions">
        <select id="scenarioSelect" aria-label="Choose a scenario">
          <!-- Permanent manual option -->
          <option value="__manual__">Manual â€” Instructor Controlled</option>
          <option value="">Loading scenariosâ€¦</option>
        </select>
        <button id="backBtn" type="button">Back</button>
      </div>
    </div>
  </div>

  <div id="viewerWrap" aria-live="polite">
    <img id="photo" alt="Scenario Photo" decoding="async" fetchpriority="high">
    <div id="caption"></div>
  </div>

  <!-- Scenario Controls: Start/Stop + Read Text -->
  <div id="controlsBar">
    <button id="startBtn" class="btn" type="button">Start</button>
    <button id="readBtn" class="btn secondary" type="button">ðŸ”Š Read Text</button>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const photo = $('photo');
    const caption = $('caption');
    const startBtn = $('startBtn');
    const readBtn = $('readBtn');
    const backBtn = $('backBtn');
    const select = $('scenarioSelect');

    // Back button to main page
    backBtn.addEventListener('click', ()=>{
      if (document.referrer) history.back();
      else window.location.href = '/';
    });

    // Device / TTS policy
    const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const synthOK = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
    const autoSpeak = !isIOS && synthOK;   // Android/Desktop autoplay on entry; iOS needs a gesture
    let lastSpeech = '';

    // Wake Lock (prevent sleep)
    let wakeLock = null, keepAliveVideo = null;
    async function acquireWakeLock(){
      try{
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
          return;
        }
      }catch{}
      // iOS fallback: tiny hidden looping video (no sound)
      if (!keepAliveVideo) {
        keepAliveVideo = document.createElement('video');
        keepAliveVideo.setAttribute('playsinline','');
        keepAliveVideo.muted = true; keepAliveVideo.loop = true;
        keepAliveVideo.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAAAAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQA=';
        keepAliveVideo.style.position='fixed'; keepAliveVideo.style.width='1px'; keepAliveVideo.style.height='1px';
        keepAliveVideo.style.opacity='0'; keepAliveVideo.style.pointerEvents='none';
        document.body.appendChild(keepAliveVideo);
      }
      try{ await keepAliveVideo.play(); }catch{}
    }
    async function releaseWakeLock(){
      try{ if (wakeLock) { await wakeLock.release(); wakeLock=null; } }catch{}
      try{ if (keepAliveVideo){ await keepAliveVideo.pause(); } }catch{}
    }

    // Firebase
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Helpers: {format,data} OR legacy string -> data URL
    function toDataURL(stored){
      if (!stored) return '';
      if (typeof stored === 'string') return stored;
      if (stored.data){
        const fmt = (stored.format === 'jpeg' || stored.format === 'jpg') ? 'jpeg' : 'png';
        return `data:image/${fmt};base64,${stored.data}`;
      }
      return '';
    }

    // Load scenarios into dropdown (from geophoto/scenarios then scenarios)
    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      const arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const num=v=> (v===0||v===null) ? v : parseFloat(v);
        return {
          title: s.title || s.name || '',
          caption: s.caption || s.text || '',
          lat: num(s.lat ?? s.latitude ?? s.latDeg),
          lng: num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg),
          radiusMeters: num(s.radiusMeters ?? s.radius ?? s.r) || 40,
          image: toDataURL(s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo)
        };
      }).filter(s => typeof s.lat==='number' && typeof s.lng==='number');
    }
    function populateDropdown(list){
      // Keep the permanent Manual option, then add a divider-like disabled option (optional), then others.
      const manualOpt = '<option value="__manual__">Manual â€” Instructor Controlled</option>';
      select.innerHTML = manualOpt + '<option value="" disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>';
      list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      list.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id;
        o.textContent=sc.title || sc.name || '(untitled)';
        select.appendChild(o);
      });
    }
    async function loadAllScenarios(){
      const out=[];
      try{
        const a = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/geophoto/scenarios.json',{cache:'no-store'});
        if(a.ok){ const ja=await a.json()||{}; for(const [id,s] of Object.entries(ja)){ out.push({ id, ...(s||{}), stops: normalizeStops(s?.stops) }); } }
      }catch{}
      try{
        const b = await fetch('https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios.json',{cache:'no-store'});
        if(b.ok){ const jb=await b.json()||{}; for(const [id,s] of Object.entries(jb)){ out.push({ id, ...(s||{}), stops: normalizeStops(s?.stops) }); } }
      }catch{}
      const map=new Map(); out.forEach(s=>{ if(!map.has(s.id)) map.set(s.id, s); });
      return Array.from(map.values());
    }

    // Haversine + tight padding (â‰¤ 3 m)
    const toRad = x => x*Math.PI/180;
    const havDistance=(aLat,aLng,bLat,bLng)=>{
      const R=6371000;
      const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const A=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(A));
    };
    function inside(stop, la, ln, acc){
      const d = havDistance(la, ln, stop.lat, stop.lng);
      const pad = Math.min(Math.max(Number(acc)||0, 0), 3);
      return d <= (Number(stop.radiusMeters)||0) + pad;
    }

    // Beep + vibrate when showing a new photo (kept as-is)
    function buzz(){ if ('vibrate' in navigator) { try { navigator.vibrate([220,80,140]); } catch {} } }
    let audioCtx=null;
    function beep(){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type='square'; o.frequency.value=880;
        g.gain.setValueAtTime(0.001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.6, audioCtx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
        o.connect(g).connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.26);
      }catch{}
    }
    function notifyNewPhoto(){ beep(); buzz(); }

    // TTS
    function speak(text){
      if (!synthOK || !text) return;
      try { speechSynthesis.cancel(); } catch {}
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1; u.pitch = 1; u.volume = 1;
      try { speechSynthesis.speak(u); } catch {}
    }

    // UI helpers
    function clearPhoto(){ photo.src=''; caption.style.display='none'; caption.textContent=''; }
    function showStop(stop){
      photo.src = stop.image || '';
      const cap = (stop.title ? stop.title + ' â€” ' : '') + (stop.caption || '');
      caption.textContent = cap;
      caption.style.display = cap ? 'block' : 'none';
      lastSpeech = (stop.title ? stop.title + '. ' : '') + (stop.caption || '');
      if (autoSpeak && lastSpeech) speak(lastSpeech);
      notifyNewPhoto();
    }

    // Start / Stop logic
    let running=false, current=null, watchId=null, lastStopIndex=-1;

    // Manual mode subscription
    let manualRef = null;
    const session = new URLSearchParams(location.search).get('session') || 'default';
    const manualPath = `geophoto/manual/${session}/current`; // instructor will write here

    function startManual(){
      // Read an initial intro (lets iOS unlock audio on Start tap)
      const intro = 'Manual mode. Awaiting instructor.';
      speak(intro); lastSpeech = intro;

      // Subscribe to instructor-controlled node
      manualRef = db.ref(manualPath);
      manualRef.on('value', snap=>{
        const v = snap.val();
        if (!v || v.clear){
          clearPhoto();
          lastSpeech = 'Cleared.';
          return;
        }
        const stop = {
          title: v.title || '',
          caption: v.caption || '',
          image: toDataURL(v.image || v.imageURL || v.imageUrl || v.url || v.photoURL || v.photo || '')
        };
        showStop(stop);
      });
    }
    function stopManual(){
      try{ if (manualRef){ manualRef.off(); manualRef=null; } }catch{}
    }

    async function startScenario(){
      if (running) return;
      const id = select.value;
      if (!id){ alert('Select a scenario first.'); return; }
      running = true;
      startBtn.textContent='Stop';
      await acquireWakeLock();

      // Manual mode path â€” no GPS watcher
      if (id === '__manual__'){
        stopManual(); // safety
        if (watchId) { try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId=null; }
        clearPhoto(); lastStopIndex = -1;
        current = { id: '__manual__', title: 'Manual', stops: [] };
        startManual();
        return;
      }

      // GPS mode (existing logic)
      stopManual(); // ensure no manual listener
      // Load scenario (prefer geophoto path, then fallback)
      let sc=null;
      try{
        const rA = await fetch(`https://dailyquiz-d5279-default-rtdb.firebaseio.com/geophoto/scenarios/${id}.json`,{cache:'no-store'});
        if(rA.ok){ sc = await rA.json(); }
      }catch{}
      if(!sc){
        try{
          const rB = await fetch(`https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios/${id}.json`,{cache:'no-store'});
          if(rB.ok){ sc = await rB.json(); }
        }catch{}
      }
      if (!sc || !sc.stops){ alert('Scenario not found or has no stops.'); stopScenario(); return; }

      current = {
        id,
        title: sc.title || sc.name || '',
        dispatch: sc.dispatch || sc.notes || '',
        stops: normalizeStops(sc.stops)
      };

      // Read dispatch/title first (kept as-is)
      const intro = (current.dispatch || current.title || '').toString().trim();
      if (intro) { speak(intro); lastSpeech = intro; }

      clearPhoto(); lastStopIndex = -1;

      if (watchId) { try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId=null; }
      try{
        watchId = navigator.geolocation.watchPosition(p=>{
          if (!running || !current) return;
          const { latitude:la, longitude:ln, accuracy:acc } = p.coords;

          // Collect all geofence matches, choose closest
          const hits = (current.stops||[])
            .map((st, i) => ({i, st, dist: havDistance(la, ln, st.lat, st.lng)}))
            .filter(obj => inside(obj.st, la, ln, acc))
            .sort((a,b)=> a.dist - b.dist);

          if (hits.length === 0) {
            if (lastStopIndex !== -1) { clearPhoto(); lastStopIndex = -1; }
            return;
          }
          const best = hits[0];
          if (best.i !== lastStopIndex){
            lastStopIndex = best.i;
            showStop(best.st);
          }
        }, err=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
      }catch(e){}
    }

    async function stopScenario(){
      running = false;
      startBtn.textContent='Start';
      stopManual();
      try{ if (watchId) navigator.geolocation.clearWatch(watchId); }catch{}
      watchId=null;
      await releaseWakeLock();
      try{ if (synthOK) speechSynthesis.cancel(); }catch{}
      clearPhoto();
    }

    startBtn.addEventListener('click', ()=> running ? stopScenario() : startScenario());
    readBtn.addEventListener('click', ()=>{ // Repeat or manual trigger on iPhone
      try{ if (audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }catch{}
      speak(lastSpeech || 'Ready.');
    });

    // Boot: load scenarios into dropdown (+ preselect ?id= or ?mode=manual)
    loadAllScenarios().then(list => {
      populateDropdown(list);
      const qs = new URLSearchParams(location.search);
      const pre = qs.get('id');
      const mode = qs.get('mode');
      if (mode === 'manual' || pre === '__manual__') {
        select.value='__manual__';
      } else if (pre && list.some(s=>s.id===pre)) {
        select.value = pre;
      }
    });

  })();
  </script>
</body>
</html>
