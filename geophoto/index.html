<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
  authDomain: "dailyquiz-d5279.firebaseapp.com",
  databaseURL: "https://dailyquiz-d5279-default-rtdb.firebaseio.com",
  projectId: "dailyquiz-d5279",
  storageBucket: "dailyquiz-d5279.firebasestorage.app",
  messagingSenderId: "94577748034",
  appId: "1:94577748034:web:c032d3a1d72db1313de5db",
  measurementId: "G-19DVN7NNH7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let spots = [];
onValue(ref(db, "spots"), snapshot => {
  spots = Object.values(snapshot.val() || {});
});

function haversineMeters(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const R = 6371000;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

navigator.geolocation.watchPosition(pos => {
  const { latitude, longitude } = pos.coords;
  let match = null;
  for (const s of spots) {
    const dist = haversineMeters(latitude, longitude, s.lat, s.lng);
    if (s.active && dist <= s.radiusMeters) {
      match = { spot: s, dist };
      break;
    }
  }
  if (match) {
    document.getElementById("title").textContent = match.spot.title;
    document.getElementById("photo").src = match.spot.imageURL;
    document.getElementById("detail").textContent =
      `Within ${Math.round(match.dist)}m of ${match.spot.title}`;
  }
});
</script>
