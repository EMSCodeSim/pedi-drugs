<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM ‚Äî Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff; --blue:#0a84ff; --shadow:0 12px 34px rgba(0,0,0,.38); }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;background:
      radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
      radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
      linear-gradient(165deg, var(--bg2), var(--bg) 55%); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; -webkit-text-size-adjust:100% }

    .topbar{position:sticky;top:0;z-index:50;background:rgba(12,15,22,.78);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1100px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:14px}
    .brandmini{display:flex;align-items:center;gap:12px;font-weight:800}
    .logo img{width:40px;height:40px;border-radius:10px;box-shadow:var(--shadow);background:#0f1624;object-fit:cover}

    /* Layout */
    #app{position:fixed;inset:60px 0 0 0;display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:10px}
    #scenarioRow{display:flex;gap:10px;align-items:center}
    select{flex:1;min-width:200px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#0f1624;color:var(--text);outline:none;font-size:16px}

    /* Full-screen viewer */
    #viewerWrap{position:relative;width:100%;height:100%;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:#000;overflow:hidden}
    #photo{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000}
    #caption{position:absolute;left:0;right:0;bottom:58px;text-align:center;padding:8px 12px;font-size:16px;background:linear-gradient(0deg,rgba(0,0,0,.55),transparent);display:none}
    /* Overlay control bar inside the photo box */
    #controls{position:absolute;left:0;right:0;bottom:0;display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px;background:linear-gradient(0deg, rgba(0,0,0,.65), transparent)}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,#54a6ff,#0a84ff);color:#03131b;box-shadow:var(--shadow);font-size:15px}
    .btn.secondary{background:transparent;color:#eaf2ff;border:1px solid rgba(255,255,255,.18)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    /* Scenario Controls (only Start/Stop + Read Text) */
    #runRow{display:flex;gap:10px;align-items:center;justify-content:flex-start}
    #note{color:var(--muted);font-size:13px}

    /* iPhone: show Push to Read inside photo; other platforms also keep it for repeat */
    #pushSpeak{display:inline-flex}

    /* Small screens tweak */
    @media (max-width:640px){ #caption{font-size:14px} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo"><img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM"></div>
        <div>FireOps SIM</div>
      </div>
    </div>
  </div>

  <div id="app">
    <!-- Scenario picker (kept minimal; controls are only Start/Stop + Read Text) -->
    <div id="scenarioRow">
      <select id="scenarioSelect" aria-label="Choose a scenario"><option value="">Loading scenarios‚Ä¶</option></select>
      <span id="note">iPhone uses ‚ÄúPush to Read‚Äù. Android/Desktop auto-read and the button repeats.</span>
    </div>

    <!-- Viewer -->
    <div id="viewerWrap" aria-live="polite">
      <img id="photo" alt="Scenario photo" decoding="async" fetchpriority="high">
      <div id="caption"></div>
      <div id="controls">
        <button id="startStop" class="btn">Start</button>
        <button id="pushSpeak" class="btn secondary">üîä Read Text</button>
      </div>
    </div>

    <!-- Slim run row (mirrors the two buttons only, for redundancy if needed) -->
    <div id="runRow">
      <button id="startStopBottom" class="btn">Start</button>
      <button id="pushSpeakBottom" class="btn secondary">üîä Read Text</button>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);

    const select = $('scenarioSelect');
    const photo = $('photo');
    const caption = $('caption');
    const startStop = $('startStop');
    const startStopBottom = $('startStopBottom');
    const pushSpeak = $('pushSpeak');
    const pushSpeakBottom = $('pushSpeakBottom');

    // Device / TTS policy
    const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const synthOK = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
    const autoSpeak = !isIOS && synthOK;     // Android/Desktop autoplay
    // iPhone requires user gesture; "Read Text" triggers it. On Android it repeats speech.

    // Wake Lock (prevent sleep)
    let wakeLock = null, keepAliveVideo=null;
    async function acquireWakeLock(){
      try{
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
          return;
        }
      }catch{}
      // iOS fallback
      if (!keepAliveVideo) {
        keepAliveVideo = document.createElement('video');
        keepAliveVideo.setAttribute('playsinline','');
        keepAliveVideo.muted=true; keepAliveVideo.loop=true;
        keepAliveVideo.src='data:video/mp4;base64,AAAAIGZ0eXBpc29tAAAAAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQA='; // 1px silent
        keepAliveVideo.style.position='fixed'; keepAliveVideo.style.width='1px'; keepAliveVideo.style.height='1px';
        keepAliveVideo.style.opacity='0'; keepAliveVideo.style.pointerEvents='none';
        document.body.appendChild(keepAliveVideo);
      }
      try{ await keepAliveVideo.play(); }catch{}
    }
    async function releaseWakeLock(){
      try{ if (wakeLock) { await wakeLock.release(); wakeLock=null; } }catch{}
      try{ if (keepAliveVideo){ await keepAliveVideo.pause(); } }catch{}
    }

    // Firebase
    const firebaseConfig={apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",authDomain:"dailyquiz-d5279.firebaseapp.com",databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",projectId:"dailyquiz-d5279",appId:"1:94577748034:web:c032d3a1d72db1313de5db",measurementId:"G-19DVN7NNH7"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    // Helpers: new imageData format ‚Üí data URL
    function toDataURL(stored){
      if (!stored) return '';
      if (typeof stored === 'string') return stored;
      if (stored.data){
        const fmt = (stored.format === 'jpeg' || stored.format === 'jpg') ? 'jpeg' : 'png';
        return `data:image/${fmt};base64,${stored.data}`;
      }
      return '';
    }

    // Load scenarios (geophoto/scenarios or scenarios)
    let scenarios=[], current=null, watchId=null, lastStopIndex=-1;
    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      const arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const num=v=> (v===0||v===null) ? v : parseFloat(v);
        return {
          title: s.title || s.name || '',
          caption: s.caption || s.text || '',
          lat: num(s.lat ?? s.latitude ?? s.latDeg),
          lng: num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg),
          radiusMeters: num(s.radiusMeters ?? s.radius ?? s.r) || 40,
          image: toDataURL(s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo)
        };
      }).filter(s => typeof s.lat==='number' && typeof s.lng==='number');
    }
    function populateDropdown(list){
      select.innerHTML='<option value="">Select a scenario‚Ä¶</option>';
      list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      list.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id; o.textContent=sc.title || sc.name || '(untitled)';
        select.appendChild(o);
      });
    }
    function mapSnapshot(val){
      const obj=val||{};
      return Object.entries(obj).map(([id,s])=>({ id, ...(s||{}), stops: normalizeStops(s?.stops) }));
    }
    db.ref('geophoto/scenarios').on('value', snap=>{
      const list=mapSnapshot(snap.val());
      if(list.length){ scenarios=list; populateDropdown(list); }
    });
    db.ref('scenarios').on('value', snap=>{
      const list=mapSnapshot(snap.val());
      if(!scenarios.length && list.length){ scenarios=list; populateDropdown(list); }
    });

    // Geofence math
    const toRad = x => x*Math.PI/180;
    const hav=(a,b,c,d)=>{ const R=6371000, dA=toRad(c-a), dB=toRad(d-b);
      return 2*R*Math.asin(Math.sqrt(Math.sin(dA/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dB/2)**2)); };
    function inside(stop, la, ln, acc){
      const d = hav(la, ln, stop.lat, stop.lng);
      const pad = Math.max(Number(acc)||0, 10); // accuracy padding
      return d <= (Number(stop.radiusMeters)||0) + pad;
    }

    // UI state
    let running=false, lastSpeech='';
    function clearPhoto(){
      photo.src=''; caption.style.display='none'; caption.textContent='';
    }
    function showStop(stop){
      photo.src = stop.image || '';
      caption.textContent = (stop.title ? stop.title + ' ‚Äî ' : '') + (stop.caption || '');
      caption.style.display = caption.textContent ? 'block' : 'none';
      lastSpeech = (stop.title ? stop.title + '. ' : '') + (stop.caption || '');
      if (autoSpeak && lastSpeech) speak(lastSpeech);
    }

    // TTS
    function speak(text){
      if (!synthOK || !text) return;
      try { speechSynthesis.cancel(); } catch {}
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1; u.pitch = 1; u.volume = 1;
      try { speechSynthesis.speak(u); } catch {}
    }
    function unlockTTS(){ // one-time gesture for iOS
      if (!synthOK) return;
      try { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(' '); u.volume = 0; speechSynthesis.speak(u); } catch {}
    }
    function onReadButton(){ unlockTTS(); speak(lastSpeech || 'Ready.'); }

    pushSpeak.addEventListener('click', onReadButton);
    pushSpeakBottom.addEventListener('click', onReadButton);

    // Start/Stop
    async function start(){
      if (running) return;
      const id = select.value;
      if(!id){ alert('Choose a scenario first.'); return; }
      running = true;
      startStop.textContent = 'Stop';
      startStopBottom.textContent = 'Stop';
      await acquireWakeLock();
      current = scenarios.find(s=>s.id===id) || null;
      clearPhoto(); lastStopIndex = -1;

      if (watchId) { try{ navigator.geolocation.clearWatch(watchId); }catch{} }
      try{
        watchId = navigator.geolocation.watchPosition(p=>{
          if (!running || !current) return;
          const { latitude:la, longitude:ln, accuracy:acc } = p.coords;
          // find first stop you are inside of
          const idx = (current.stops||[]).findIndex(st => inside(st, la, ln, acc));
          if (idx === -1) {
            // outside geofence -> hide photo
            if (lastStopIndex !== -1) { clearPhoto(); lastStopIndex = -1; }
            return;
          }
          if (idx !== lastStopIndex){
            lastStopIndex = idx;
            showStop(current.stops[idx]);
          }
        }, err=>{ console.log('GPS error', err); }, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
      }catch(e){ console.log('Geo error', e); }
    }
    async function stop(){
      running = false;
      startStop.textContent = 'Start';
      startStopBottom.textContent = 'Start';
      try{ navigator.geolocation.clearWatch(watchId); }catch{}
      await releaseWakeLock();
      try{ if (synthOK) speechSynthesis.cancel(); }catch{}
      clearPhoto();
    }
    startStop.addEventListener('click', ()=> running ? stop() : start());
    startStopBottom.addEventListener('click', ()=> running ? stop() : start());

    // Fill year, etc.
    // (No footer here, but keeping hook if you add one later)

  })();
  </script>
</body>
</html>
