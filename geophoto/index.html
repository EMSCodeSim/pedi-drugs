<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Geo Scenarios Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" href="data:," />
  <style>
    :root{ --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff; --blue:#0a84ff; --shadow:0 12px 34px rgba(0,0,0,.38); --radius:18px; }
    *{box-sizing:border-box}
    html,body{ margin:0; padding:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%);
      -webkit-text-size-adjust:100%; scroll-behavior:smooth; }
    a{color:inherit; text-decoration:none} img{max-width:100%; height:auto; display:block}

    .topbar{position:sticky; top:0; z-index:20; background:rgba(12,15,22,.75); backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1100px; margin:0 auto; padding:10px 20px; display:flex; align-items:center; gap:14px}
    .brandmini{display:flex; align-items:center; gap:12px; font-weight:800}
    .logo img{width:40px; height:40px; border-radius:10px; box-shadow:var(--shadow); object-fit:cover; background:#0f1624}

    .wrap{max-width:1100px; margin:0 auto; padding:18px 20px 100px}
    .grid{display:grid; gap:14px; grid-template-columns:1fr}
    .card{border-radius:var(--radius); background:var(--card); border:1px solid rgba(255,255,255,.07); box-shadow:var(--shadow); overflow:hidden; transition:transform .15s ease, border-color .2s ease}
    .card:hover{transform:translateY(-2px); border-color:rgba(10,132,255,.35)}
    .card-inner{padding:18px}
    .eyebrow{font-size:12px; color:var(--muted); margin-bottom:8px}
    h1,h2,h3{margin:0} h2{font-size:20px} p,.status{color:var(--muted); font-size:14px; margin:6px 0 0}

    .btn{appearance:none; border:0; border-radius:12px; cursor:pointer; padding:14px 16px; font-weight:800; font-size:16px; color:#03131b; background:linear-gradient(180deg,#54a6ff,var(--blue)); box-shadow:var(--shadow); text-align:center}
    .btn[disabled]{opacity:.65; cursor:not-allowed}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14)}
    select{width:100%; padding:14px 12px; font-size:16px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0f1624; color:var(--text); outline:none}
    input[type="range"]{accent-color:#54a6ff}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    #viewer .card-inner{padding:12px}
    #photoWrap{ margin-top:10px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:#000; overflow:hidden; }
    #photo{ width:100%; height:min(78vh, calc(100vh - 220px)); object-fit:contain; background:#000; }
    #caption{font-size:15px; color:#e9f1ff}

    footer{max-width:1100px; margin:34px auto; padding:0 20px; color:var(--muted); font-size:13px; border-top:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap}
    #runTimer{font-size:13px; color:#cfe1ff}
    #debug{font-size:12px; color:#ffdede; margin-top:6px; white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo" aria-hidden="true"><img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM logo" /></div>
        <div style="line-height:1.1; font-size:15px; font-weight:900">FireOps SIM</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <article class="card">
        <div class="card-inner">
          <div class="eyebrow">Scenario</div>
          <h2>Select & Start</h2>
          <p>Choose a scenario below, then start it to enable audio/voice prompts.</p>
          <div class="row" style="margin-top:10px; width:100%">
            <select id="scenarioSelect" aria-label="Choose a scenario"><option value="">Loading…</option></select>
          </div>
          <div class="status" id="status" aria-live="polite" style="margin-top:8px">Connecting…</div>
          <div id="debug" aria-live="polite"></div>
        </div>
      </article>

      <article class="card" id="viewer" style="display:none">
        <div class="card-inner">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 id="scTitle" style="margin:0; font-size:18px">(scenario)</h3>
            <button id="backBtn" class="btn secondary" type="button">Back</button>
          </div>

          <div class="status" id="dispatchBlock" style="white-space:pre-wrap; margin-top:8px"></div>
          <div class="status" id="geoStatus" style="margin-top:4px">Waiting for location…</div>

          <div id="result" style="display:none">
            <h3 id="stopTitle" style="margin:12px 2px 6px 2px"></h3>
            <div id="photoWrap"><img id="photo" alt="Photo for this stop"></div>
            <div class="status" id="caption" style="white-space:pre-wrap; margin-top:10px"></div>
            <div class="status" id="detail"></div>
          </div>
        </div>
      </article>

      <article class="card">
        <div class="card-inner">
          <div class="eyebrow">Audio & TTS</div>
          <h2>Scenario Controls</h2>
          <p>This enables audio, reads the dispatch, and reads each caption automatically. (No beeps.)</p>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <button id="startScenario" class="btn" type="button">Start Scenario</button>
            <button id="muteToggle" class="btn secondary" type="button">Mute</button>
            <label style="margin-left:auto; color:var(--muted)">Volume
              <input id="vol" type="range" min="0" max="1" step="0.05" value="1" />
            </label>
          </div>
          <div id="runTimer" aria-live="polite" style="margin-top:8px">00:00</div>
        </div>
      </article>
    </div>
  </div>

  <footer>
    <div>© <span id="year"></span> FireOps SIM</div>
    <div id="connStatus"></div>
  </footer>

  <!-- Compat scripts present so we can fall back if needed -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <script type="module">
  (async () => {
    const $ = id => document.getElementById(id);
    const viewer=$('viewer'), backBtn=$('backBtn');
    const select=$('scenarioSelect'), status=$('status'), debug=$('debug'), connStatus=$('connStatus');
    const dispatchBlock=$('dispatchBlock'), geoStatus=$('geoStatus');
    const result=$('result'), stopTitle=$('stopTitle'), photo=$('photo'), caption=$('caption'), detail=$('detail');
    const scTitle=$('scTitle');
    const startBtn=$('startScenario'), muteToggle=$('muteToggle'), vol=$('vol'), runTimer=$('runTimer');
    const log = (m)=>{ console.log('[viewer]', m); debug.textContent=String(m); };

    // ---------- Helpers ----------
    const toRad = x => x*Math.PI/180;
    const hav=(a,b,c,d)=>{ const R=6371000, dA=toRad(c-a), dB=toRad(d-b);
      return 2*R*Math.asin(Math.sqrt(Math.sin(dA/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dB/2)**2)); };
    const num=v=>(v===0||v===null)?v:parseFloat(v);

    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      let arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const lat = num(s.lat ?? s.latitude ?? s.latDeg);
        const lng = num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg);
        const radiusMeters = num(s.radiusMeters ?? s.radius ?? s.r) || 40;
        const title = s.title || s.name || '';
        const caption = s.caption || s.text || s.note || '';
        const image = s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo || s.img || '';
        return { ...s, lat, lng, radiusMeters, title, caption, image };
      }).filter(s => typeof s.lat === 'number' && typeof s.lng === 'number');
    }

    function setImage(img, stop){
      const src = stop.image || '';
      img.src = src || "data:image/svg+xml;utf8,"+encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='720'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#9ecbd6' font-size='24' text-anchor='middle'>No image</text></svg>"
      );
      img.onerror=()=>{ img.src="data:image/svg+xml;utf8,"+encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='720'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#9ecbd6' font-size='24' text-anchor='middle'>Image failed to load</text></svg>"
      ); };
    }

    // ---------- Firebase (modular first; compat fallback) ----------
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };

    let mode='modular', app, db, refFn, onValueFn, getFn;
    try{
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
      const { getDatabase, ref, onValue, get } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js');
      app = initializeApp(firebaseConfig); db = getDatabase(app); refFn = ref; onValueFn = onValue; getFn = get;
    }catch(e){
      mode='compat';
      app = window.firebase.initializeApp(firebaseConfig);
      db = window.firebase.database();
      refFn = (dbRefPath)=>db.ref(dbRefPath);
      onValueFn = (r, cb, err)=>r.on('value', s=>cb(s), err);
      getFn = (r)=>r.get();
    }
    log('Firebase mode: ' + mode);

    // Connection indicator
    try{
      const infoRef = (mode==='modular') ? refFn(db, '.info/connected') : refFn('.info/connected');
      onValueFn(infoRef, snap=>{
        const ok = snap.val() === true;
        connStatus.textContent = ok ? 'Connected' : 'Offline';
        connStatus.style.color = ok ? '#89ffb2' : '#ffdede';
      });
    }catch{}

    // ---------- Scenario loading ----------
    let scenarios=[], populated=false;
    function mapSnapshot(val){
      const obj = val || {};
      return Object.entries(obj).map(([id, s])=>({ id, ...(s||{}), stops: normalizeStops(s?.stops) }));
    }
    function populateDropdown(list){
      select.innerHTML = '<option value="">Select a scenario…</option>';
      list.forEach(sc=>{
        const o=document.createElement('option');
        o.value=sc.id;
        o.textContent=sc.title || sc.name || sc.notes || '(untitled)';
        select.appendChild(o);
      });
      status.textContent = list.length ? `${list.length} scenario(s) found` : 'No scenarios yet.';
      populated = list.length>0;
    }

    // Prefer geophoto/scenarios; fallback to scenarios
    try{
      const a = (mode==='modular') ? refFn(db,'geophoto/scenarios') : refFn('geophoto/scenarios');
      onValueFn(a, snap=>{
        const list=mapSnapshot(snap.val());
        if(list.length){ scenarios=list; populateDropdown(scenarios); log('SDK: geophoto/scenarios '+list.length); }
      }, err=>log('SDK geophoto error: '+(err?.message||err)));
    }catch(e){ log('attach geophoto failed: '+e.message); }
    try{
      const b = (mode==='modular') ? refFn(db,'scenarios') : refFn('scenarios');
      onValueFn(b, snap=>{
        const list=mapSnapshot(snap.val());
        if(!scenarios.length && list.length){ scenarios=list; populateDropdown(scenarios); log('SDK: scenarios '+list.length); }
      }, err=>log('SDK scenarios error: '+(err?.message||err)));
    }catch(e){ log('attach scenarios failed: '+e.message); }

    setTimeout(async ()=>{
      if(!populated){
        try{ const s1 = await getFn((mode==='modular') ? refFn(db,'geophoto/scenarios') : refFn('geophoto/scenarios'));
             const list=mapSnapshot(s1?.val?.() ?? s1.val()); if(list.length){ scenarios=list; populateDropdown(list); log('GET geophoto '+list.length); } }
        catch(e){ log('GET geophoto error: '+e.message); }
      }
      if(!populated){
        try{ const s2 = await getFn((mode==='modular') ? refFn(db,'scenarios') : refFn('scenarios'));
             const list=mapSnapshot(s2?.val?.() ?? s2.val()); if(list.length){ scenarios=list; populateDropdown(list); log('GET scenarios '+list.length); } }
        catch(e){ log('GET scenarios error: '+e.message); }
      }
      if(!populated){
        try{
          const url = 'https://dailyquiz-d5279-default-rtdb.firebaseio.com/scenarios.json';
          const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
          const json = await r.json(); const list = mapSnapshot(json);
          if(list.length){ scenarios=list; populateDropdown(list); log('REST scenarios '+list.length); }
        }catch(e){ log('REST error: '+e.message); }
      }
      if(!populated){ status.textContent='No scenarios found.'; }
    }, 1200);

    // ---------- iOS-safe TTS (OpenAI MP3/M4A via one shared <audio>) ----------
    let audioEnabled=false, muted=false, volume=1.0, runInterval=null, startMs=0;
    let sharedAudio=null, audioUnlocked=false, speaking=false;
    const speakQueue=[];

    // Truly silent WAV for unlock (no clicks)
    const SILENT_WAV = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAAAABAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=";

    function setAudioVolume(v){
      volume = v;
      if (sharedAudio) sharedAudio.volume = muted ? 0 : volume;
    }

    async function primeAudio(){
      if (audioUnlocked) return true;
      sharedAudio = new Audio();
      sharedAudio.setAttribute('playsinline','');
      sharedAudio.preload = 'auto';
      sharedAudio.volume = 0;          // force silent during unlock
      sharedAudio.src = SILENT_WAV;

      sharedAudio.onended = () => {
        // After any clip, advance the queue
        speaking = false;
        playNextFromQueue();
      };

      try{
        await sharedAudio.play();      // MUST run on Start tap
        sharedAudio.pause();
        sharedAudio.currentTime = 0;
        audioUnlocked = true;
        // restore to user volume
        sharedAudio.volume = muted ? 0 : volume;
        return true;
      }catch(e){
        log('Audio unlock failed: ' + e.message);
        return false;
      }
    }

    // Replace this with your backend that returns an MP3/M4A blob
    async function fetchOpenAITTS(text){
      // Example:
      // const resp = await fetch('/api/tts', {
      //   method: 'POST',
      //   headers: {'Content-Type':'application/json'},
      //   body: JSON.stringify({ text })
      // });
      // if (!resp.ok) throw new Error('TTS HTTP ' + resp.status);
      // const blob = await resp.blob(); // audio/mpeg or audio/mp4
      // return URL.createObjectURL(blob);

      // TEMP: silence placeholder so flow runs without noise until you wire backend.
      return SILENT_WAV;
    }

    function enqueueSpeak(text){
      const clean = (text||'').trim();
      if (!audioEnabled || !audioUnlocked || !clean) return;
      speakQueue.push(clean);
      if (!speaking) playNextFromQueue();
    }

    async function playNextFromQueue(){
      if (speaking || !speakQueue.length || !audioUnlocked || !audioEnabled) return;
      speaking = true;
      const text = speakQueue.shift();
      try{
        const url = await fetchOpenAITTS(text);
        sharedAudio.src = url;
        // volume already set via setAudioVolume
        await sharedAudio.play();
      }catch(e){
        log('Playback error: ' + e.message);
        speaking = false;
        playNextFromQueue(); // try next
      }
    }

    function stopAllAudio(){
      try{
        if (sharedAudio){
          sharedAudio.pause();
          sharedAudio.currentTime = 0;
        }
      }catch{}
      speaking = false;
      speakQueue.length = 0;
    }

    // ---------- Geofence + display ----------
    function within(hitDist, stopRadius, accuracy){
      const r = (Number(stopRadius)||0) + Math.max(Number(accuracy)||0, 10);
      return hitDist <= r;
    }
    function findHit(stops, la, ln, acc){
      let best=null; (stops||[]).forEach((s,i)=>{
        const d=hav(la,ln,Number(s.lat),Number(s.lng));
        if(within(d, s.radiusMeters, acc)){ if(!best || d<best.dist) best={s,index:i,dist:d}; }
      }); return best;
    }
    function showDispatchIntro(sc){
      const txt=(sc.dispatch||sc.notes||'').trim();
      dispatchBlock.textContent = txt ? `Dispatch: ${txt}` : 'Dispatch: (none)';
      // Speak the dispatch once the scenario opens
      if (txt) setTimeout(()=>enqueueSpeak(txt), 120);
      else setTimeout(()=>enqueueSpeak(`${sc.title || 'Scenario'} started.`), 120);
    }

    let current=null, watchId=null, lastStopIndex=-1;
    function openScenarioById(id){
      const sc=scenarios.find(s=>s.id===id);
      if(!sc){ status.textContent='Scenario not found.'; return; }
      current=sc;
      viewer.style.display=''; scTitle.textContent=sc.title||sc.name||sc.notes||'(scenario)';

      result.style.display='none'; stopTitle.textContent=''; caption.textContent=''; detail.textContent='';
      lastStopIndex=-1;

      showDispatchIntro(sc);

      if(watchId) navigator.geolocation.clearWatch(watchId);
      geoStatus.textContent='Watching your location…';
      try{
        watchId=navigator.geolocation.watchPosition(p=>{
          const { latitude:la, longitude:ln, accuracy:acc }=p.coords;
          geoStatus.textContent=`Lat ${la.toFixed(5)}, Lng ${ln.toFixed(5)} (±${Math.round(acc)}m)`;
          const hit=findHit(normalizeStops(sc.stops), la, ln, acc);
          if(hit && hit.index!==lastStopIndex){
            lastStopIndex=hit.index;
            result.style.display='';
            stopTitle.textContent=hit.s.title||'Stop';
            setImage(photo, hit.s);
            caption.textContent=hit.s.caption||'';
            detail.textContent=`Distance: ${Math.round(hit.dist)} m (radius ${hit.s.radiusMeters} m)`;
            // NO BEEP. Speak title + caption.
            const speech = `${hit.s.title ? (hit.s.title+'. ') : ''}${hit.s.caption || ''}`;
            setTimeout(()=>enqueueSpeak(speech), 120);
            viewer.scrollIntoView({behavior:'smooth', block:'start'});
          }
        }, err=>{ geoStatus.textContent='Location error: '+err.message; }, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
      }catch(e){ geoStatus.textContent='Location error: '+e.message; }
    }

    // ---------- UI: mute/volume, timer, start/back ----------
    muteToggle.onclick=()=>{ muted=!muted; muteToggle.textContent=muted?'Unmute':'Mute'; setAudioVolume(volume); };
    vol.oninput=e=>{ setAudioVolume(parseFloat(e.target.value||'1')||1); };

    function formatTime(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60), sec=s%60; return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); }
    function startTimer(){ startMs=Date.now(); clearInterval(runInterval); runInterval=setInterval(()=>{ runTimer.textContent=formatTime(Date.now()-startMs); },500); }
    function stopTimer(){ clearInterval(runInterval); runInterval=null; runTimer.textContent='00:00'; }

    startBtn.onclick=async()=>{
      const id=select.value;
      if(!id){ status.textContent='Choose a scenario first.'; return; }
      // Unlock audio on same tap
      const ok = await primeAudio();
      if (!ok){ alert('Tap Start again to enable audio.'); return; }

      audioEnabled=true;
      startTimer();
      startBtn.textContent='Scenario Running';
      startBtn.disabled=true;

      openScenarioById(id);
    };

    backBtn.onclick=()=>{ 
      viewer.style.display='none';
      try{ navigator.geolocation.clearWatch(watchId); }catch{} 
      status.textContent='Choose a scenario and press Start Scenario.';
      stopAllAudio();
      startBtn.disabled=false; startBtn.textContent='Start Scenario';
      audioEnabled=false; stopTimer();
    };

    (function(){ const pre=new URLSearchParams(location.search).get('id'); if(!pre) return; const iv=setInterval(()=>{ if(select.options.length>1){ clearInterval(iv); select.value=pre; } },200); })();
    document.getElementById('year').textContent = new Date().getFullYear();
    window.addEventListener('error', e => log('Error: ' + (e.message||e)));
    window.addEventListener('unhandledrejection', e => log('Promise error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));
  })();
  </script>
</body>
</html>
