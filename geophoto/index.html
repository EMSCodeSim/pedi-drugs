<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Geo Scenarios Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#0b0f14; --bg2:#101726; --card:#121823; --muted:#8ea0b3; --text:#eaf2ff;
      --blue:#0a84ff; --shadow:0 12px 34px rgba(0,0,0,.38); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%);
      -webkit-text-size-adjust:100%; scroll-behavior:smooth;
    }
    a{color:inherit; text-decoration:none} img{max-width:100%; height:auto; display:block}

    /* Top bar */
    .topbar{position:sticky; top:0; z-index:20; background:rgba(12,15,22,.75);
      backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid rgba(255,255,255,.07)}
    .topnav{max-width:1100px; margin:0 auto; padding:10px 20px; display:flex; align-items:center; gap:14px}
    .brandmini{display:flex; align-items:center; gap:12px; font-weight:800}
    .logo img{width:40px; height:40px; border-radius:10px; box-shadow:var(--shadow); object-fit:cover; background:#0f1624}

    .wrap{max-width:1100px; margin:0 auto; padding:18px 20px 100px}

    /* Cards */
    .grid{display:grid; gap:14px; grid-template-columns:1fr}
    .card{border-radius:var(--radius); background:var(--card); border:1px solid rgba(255,255,255,.07);
      box-shadow:var(--shadow); overflow:hidden; transition:transform .15s ease, border-color .2s ease}
    .card:hover{transform:translateY(-2px); border-color:rgba(10,132,255,.35)}
    .card-inner{padding:18px}
    .eyebrow{font-size:12px; color:var(--muted); margin-bottom:8px}
    h1,h2,h3{margin:0} h2{font-size:20px} p,.status{color:var(--muted); font-size:14px; margin:6px 0 0}

    .btn{appearance:none; border:0; border-radius:12px; cursor:pointer; padding:14px 16px; font-weight:800; font-size:16px;
      color:#03131b; background:linear-gradient(180deg,#54a6ff,var(--blue)); box-shadow:var(--shadow); text-align:center}
    .btn[disabled]{opacity:.65; cursor:not-allowed}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14)}
    select{width:100%; padding:14px 12px; font-size:16px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
      background:#0f1624; color:var(--text); outline:none}
    input[type="range"]{accent-color:#54a6ff}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* Big photo “lightbox” */
    #viewer .card-inner{padding:12px}
    #photoWrap{
      margin-top:10px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:#000; overflow:hidden;
    }
    #photo{
      width:100%;
      height:min(78vh, calc(100vh - 220px)); /* fills most of the screen */
      object-fit:contain; background:#000;
    }
    #caption{font-size:15px; color:#e9f1ff}

    footer{max-width:1100px; margin:34px auto; padding:0 20px; color:#a9b6c9; font-size:13px;
      border-top:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap}

    #runTimer{font-size:13px; color:#cfe1ff}
    #debug{font-size:12px; color:#ffdede; margin-top:6px; white-space:pre-wrap}
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="topnav">
      <div class="brandmini">
        <div class="logo" aria-hidden="true">
          <img src="/assets/logo/fire-ops-sim.png" alt="FireOps SIM logo" />
        </div>
        <div style="line-height:1.1; font-size:15px; font-weight:900">FireOps SIM</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Scenario picker -->
      <article class="card">
        <div class="card-inner">
          <div class="eyebrow">Scenario</div>
          <h2>Select & Start</h2>
          <p>Choose a scenario below, then start it to enable audio/voice prompts.</p>
          <div class="row" style="margin-top:10px; width:100%">
            <select id="scenarioSelect" aria-label="Choose a scenario"><option value="">Loading…</option></select>
          </div>
          <div class="status" id="status" aria-live="polite" style="margin-top:8px">Connecting…</div>
          <div id="debug" aria-live="polite"></div>
        </div>
      </article>

      <!-- Viewer -->
      <article class="card" id="viewer" style="display:none">
        <div class="card-inner">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 id="scTitle" style="margin:0; font-size:18px">(scenario)</h3>
            <button id="backBtn" class="btn secondary" type="button">Back</button>
          </div>

          <div class="status" id="dispatchBlock" style="white-space:pre-wrap; margin-top:8px"></div>
          <div class="status" id="geoStatus" style="margin-top:4px">Waiting for location…</div>

          <div id="result" style="display:none">
            <h3 id="stopTitle" style="margin:12px 2px 6px 2px"></h3>
            <div id="photoWrap"><img id="photo" alt="Photo for this stop"></div>
            <div class="status" id="caption" style="white-space:pre-wrap; margin-top:10px"></div>
            <div class="status" id="detail"></div>
          </div>
        </div>
      </article>

      <!-- Audio / TTS Controls -->
      <article class="card">
        <div class="card-inner">
          <div class="eyebrow">Audio & TTS</div>
          <h2>Scenario Controls</h2>
          <p>This enables audio, reads the dispatch, beeps on each geofence, and reads each caption.</p>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <button id="startScenario" class="btn" type="button">Start Scenario</button>
            <button id="muteToggle" class="btn secondary" type="button">Mute</button>
            <label style="margin-left:auto; color:var(--muted)">Volume
              <input id="vol" type="range" min="0" max="1" step="0.05" value="1" />
            </label>
          </div>
          <div id="runTimer" aria-live="polite" style="margin-top:8px">00:00</div>
        </div>
      </article>
    </div>
  </div>

  <footer>
    <div>© <span id="year"></span> FireOps SIM</div>
    <div id="connStatus"></div>
  </footer>

  <!-- Firebase compat (iOS-friendly) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const viewer = $('viewer'), backBtn = $('backBtn');
    const select = $('scenarioSelect'), status = $('status'), debug = $('debug'), connStatus = $('connStatus');
    const dispatchBlock = $('dispatchBlock'), geoStatus = $('geoStatus');
    const result = $('result'), stopTitle = $('stopTitle'), photo = $('photo'), caption = $('caption'), detail = $('detail');
    const scTitle = $('scTitle');
    const startBtn = $('startScenario'), muteToggle = $('muteToggle'), vol = $('vol'), runTimer = $('runTimer');

    /* ---------- Helpers ---------- */
    const toRad = x => x*Math.PI/180;
    const hav=(a,b,c,d)=>{
      const R=6371000, dA=toRad(c-a), dB=toRad(d-b);
      return 2*R*Math.asin(Math.sqrt(Math.sin(dA/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dB/2)**2));
    };
    const num = v => (v===0||v===null)?v:parseFloat(v);
    function log(msg){ console.log(msg); debug.textContent = String(msg); }

    function normalizeStops(stopsLike){
      if(!stopsLike) return [];
      let arr = Array.isArray(stopsLike) ? stopsLike : Object.values(stopsLike);
      return arr.map(s=>{
        const lat = num(s.lat ?? s.latitude ?? s.latDeg);
        const lng = num(s.lng ?? s.lon ?? s.long ?? s.longitude ?? s.lngDeg);
        const radiusMeters = num(s.radiusMeters ?? s.radius ?? s.r) || 40;
        const title = s.title || s.name || '';
        const cap = s.caption || s.text || s.note || '';
        const image =
          s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo || s.img || s.image || '';
        return { ...s, lat, lng, radiusMeters, title, caption: cap, image };
      }).filter(s => typeof s.lat === 'number' && typeof s.lng === 'number');
    }

    function setImage(img, stop){
      const src =
        stop.imageData || stop.imageURL || stop.imageUrl ||
        stop.url || stop.photoURL || stop.photo || stop.image || '';
      img.src = src || "data:image/svg+xml;utf8,"+encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='720'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#9ecbd6' font-size='24' text-anchor='middle'>No image</text></svg>"
      );
      img.onerror = () => {
        img.src = "data:image/svg+xml;utf8,"+encodeURIComponent(
          "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='720'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#9ecbd6' font-size='24' text-anchor='middle'>Image failed to load</text></svg>"
        );
      };
    }

    /* ---------- Firebase init ---------- */
    const firebaseConfig = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){ /* already initialized */ }
    const db = firebase.database();

    // Connection indicator
    db.ref(".info/connected").on("value", snap=>{
      const ok = snap.val() === true;
      connStatus.textContent = ok ? "Connected" : "Offline";
      connStatus.style.color = ok ? "#89ffb2" : "#ffdede";
    });

    /* ---------- Audio / TTS ---------- */
    let audioEnabled=false, muted=false, volume=1.0, audioCtx=null;
    let wakeLock=null, wakeFallbackInterval=null, runInterval=null, startMs=0;
    const synth = window.speechSynthesis;
    let speaking=false; const q=[];

    function formatTime(ms){
      const s = Math.floor(ms/1000), m = Math.floor(s/60), sec = s%60;
      return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
    }
    function startTimer(){ startMs = Date.now(); clearInterval(runInterval);
      runInterval = setInterval(()=>{ runTimer.textContent = formatTime(Date.now()-startMs); }, 500);
    }
    function stopTimer(){ clearInterval(runInterval); runInterval=null; runTimer.textContent = '00:00'; }

    async function lockWake(){
      try{
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=>{});
        } else {
          if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
          wakeFallbackInterval = setInterval(()=>{
            try{ const src = audioCtx.createBufferSource();
              src.buffer = audioCtx.createBuffer(1,1,audioCtx.sampleRate);
              src.connect(audioCtx.destination); src.start(0);
            }catch(e){}
          }, 30000);
        }
      }catch(e){}
    }
    function releaseWake(){ try{ if(wakeLock){ wakeLock.release(); wakeLock=null; } }catch(e){}
    document.addEventListener('visibilitychange', () => {
      if(document.visibilityState === 'visible' && audioEnabled) lockWake();
    });

    function beep(){
      if(!audioEnabled || muted) return;
      try{
        if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.value=880; g.gain.value=0.001;
        o.connect(g).connect(audioCtx.destination);
        const now=audioCtx.currentTime;
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.2*volume, now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now+0.25);
        o.start(now); o.stop(now+0.3);
      }catch(e){}
    }

    function say(text){ if(!audioEnabled || muted || !text) return; q.push(text); if(!speaking) playNext(); }
    function playNext(){
      if(!audioEnabled || muted || !q.length) { speaking=false; return; }
      speaking=true;
      const u=new SpeechSynthesisUtterance(q.shift());
      u.lang = navigator.language || 'en-US';
      u.rate = 1.0; u.volume = volume;
      u.onend = ()=>{ speaking=false; playNext(); };
      u.onerror = ()=>{ speaking=false; };
      try{ synth.speak(u); }catch(e){ speaking=false; }
    }
    function primeTTS(){
      return new Promise(resolve=>{
        try{
          const u=new SpeechSynthesisUtterance(' ');
          u.volume = 0.01; u.rate=1.0; u.lang=navigator.language||'en-US';
          u.onend = ()=>resolve();
          synth.speak(u);
          setTimeout(resolve, 700); // fallback
        }catch(e){ resolve(); }
      });
    }

    muteToggle.onclick=()=>{ muted=!muted; muteToggle.textContent=muted?'Unmute':'Mute'; };
    vol.oninput=e=>{ volume=parseFloat(e.target.value||'1')||1; };

    /* ---------- Scenario Loading (requires or ignores auth) ---------- */
    let scenariosArr = [];
    function populate(list){
      scenariosArr = (list||[])
        .map(([id, s]) => ({ id, ...(s||{}) }))
        .filter(s => s && (s.active === undefined || s.active))   // active only
        .sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));  // newest first

      // dropdown label: title | name | notes | (untitled)
      select.innerHTML = '<option value="">Select a scenario…</option>';
      scenariosArr.forEach(sc => {
        const label = sc.title || sc.name || sc.notes || '(untitled)';
        const o = document.createElement('option');
        o.value = sc.id; o.textContent = label;
        select.appendChild(o);
      });
      status.textContent = scenariosArr.length
        ? `${scenariosArr.length} active scenario(s)`
        : 'No scenarios yet.';
      log(`Loaded ${scenariosArr.length} from /scenarios`);
    }

    function startScenarioListener(){
      db.ref('scenarios').on('value', function(snap){
        const v = snap.val() || {};
        populate(Object.entries(v));
      }, function(err){
        log('DB error: ' + err.message);
        status.textContent = 'Could not load scenarios.';
      });
    }

    // If rules need auth, sign in anonymously first; if not, we still proceed.
    function begin(){
      // connection indicator
      db.ref(".info/connected").on("value", snap=>{
        const ok = snap.val() === true;
        connStatus.textContent = ok ? "Connected" : "Offline";
        connStatus.style.color = ok ? "#89ffb2" : "#ffdede";
      });
      startScenarioListener();
    }

    if (firebase.auth) {
      firebase.auth().onAuthStateChanged(function(user){
        if(user){ log('Auth: signed in anonymously'); begin(); }
      });
      firebase.auth().signInAnonymously().catch(function(err){
        log('Anon auth error: ' + err.message + ' (continuing without auth)');
        begin(); // try anyway if rules are public
      });
    } else {
      begin(); // no auth lib? just try reading
    }

    /* ---------- Image Preload Cache ---------- */
    const imgCache = new Map();
    function preloadImages(stops){
      Promise.all((stops||[]).map(s=>new Promise(res=>{
        const src =
          s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo || s.image || '';
        if(!src || imgCache.has(src)) return res();
        const im=new Image();
        im.onload=()=>{ if(im.decode) im.decode().catch(()=>{}).finally(res); else res(); };
        im.onerror=()=>res();
        im.src=src;
      }))).then(()=>{
        (stops||[]).forEach(s=>{
          const src =
            s.imageData || s.imageURL || s.imageUrl || s.url || s.photoURL || s.photo || s.image || '';
          if(src) imgCache.set(src,true);
        });
      });
    }

    /* ---------- Geofence + Display ---------- */
    function within(hitDist, stopRadius, accuracy){
      const r = (Number(stopRadius)||0) + Math.max(Number(accuracy)||0, 10);
      return hitDist <= r;
    }
    function findHit(stops, la, ln, acc){
      let best=null;
      (stops||[]).forEach((s,i)=>{
        const d=hav(la,ln,Number(s.lat),Number(s.lng));
        if(within(d, s.radiusMeters, acc)){
          if(!best || d<best.dist) best={s,index:i,dist:d};
        }
      });
      return best;
    }

    function showDispatchIntro(sc){
      const txt = (sc.dispatch || sc.notes || '').trim(); // fall back to notes
      dispatchBlock.textContent = txt ? `Dispatch: ${txt}` : 'Dispatch: (none)';
      setTimeout(()=> say(txt || `${sc.title || sc.notes || 'scenario'} started.`), 120);
    }

    let current=null, currentStops=[], watchId=null, lastStopIndex=-1;

    function openScenarioById(id){
      const sc = scenariosArr.find(s => s.id === id);
      if(!sc){ status.textContent='Scenario not found.'; return; }
      current=sc;
      currentStops = normalizeStops(sc.stops);

      viewer.style.display='';
      scTitle.textContent=sc.title || sc.name || sc.notes || '(scenario)';
      result.style.display='none';
      stopTitle.textContent=''; caption.textContent=''; detail.textContent='';
      lastStopIndex = -1;

      // Preload images
      preloadImages(currentStops);

      // Speak/Show dispatch now
      showDispatchIntro(sc);

      // Start GPS watch
      if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      geoStatus.textContent='Watching your location…';
      try{
        watchId=navigator.geolocation.watchPosition(function(p){
          const { latitude:la, longitude:ln, accuracy:acc }=p.coords;
          geoStatus.textContent=`Lat ${la.toFixed(5)}, Lng ${ln.toFixed(5)} (±${Math.round(acc)}m)`;
          const hit=findHit(currentStops, la, ln, acc);
          if(hit && hit.index!==lastStopIndex){
            lastStopIndex = hit.index;
            result.style.display='';
            stopTitle.textContent=hit.s.title||'Stop';
            setImage(photo, hit.s);
            caption.textContent=hit.s.caption||'';
            detail.textContent=`Distance: ${Math.round(hit.dist)} m (radius ${hit.s.radiusMeters} m)`;

            // Beep + TTS caption
            beep();
            const spoken = `${hit.s.title ? hit.s.title + '. ' : ''}${hit.s.caption || ''}`;
            setTimeout(()=> say(spoken), 120);

            viewer.scrollIntoView({behavior:'smooth', block:'start'});
          }
        }, function(err){
          geoStatus.textContent='Location error: '+err.message;
        }, {
          enableHighAccuracy:true, maximumAge:1000, timeout:10000
        });
      }catch(e){ geoStatus.textContent='Location error: '+e.message; }
    }

    /* ---------- Controls ---------- */
    const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent) ||
                  (navigator.userAgent.includes('Mac') && navigator.maxTouchPoints>2);

    startBtn.onclick = function(){
      (async function(){
        try{
          audioEnabled=true;
          if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
          await audioCtx.resume();
          await lockWake();
          if(isIOS) await primeTTS();   // iOS needs the prime on user gesture
          startTimer();
          beep();
          startBtn.textContent='Scenario Running';
          startBtn.disabled=true;
        }catch(e){ alert('Could not enable audio: '+e.message); return; }

        const id=select.value;
        if(!id){
          status.textContent='Choose a scenario first.';
          startBtn.disabled=false; startBtn.textContent='Start Scenario'; audioEnabled=false; releaseWake(); stopTimer();
          return;
        }
        openScenarioById(id);
      })();
    };

    backBtn.onclick=function(){
      viewer.style.display='none';
      if(watchId) navigator.geolocation.clearWatch(watchId);
      status.textContent='Choose a scenario and press Start Scenario.';
      window.speechSynthesis.cancel();
      startBtn.disabled=false; startBtn.textContent='Start Scenario'; audioEnabled=false;
      releaseWake(); stopTimer();
    };

    // Preselect ?id=
    (function(){
      const pre=new URLSearchParams(location.search).get('id');
      if(!pre) return;
      const iv=setInterval(()=>{
        if(select.options.length>1){
          clearInterval(iv); select.value=pre;
        }
      }, 200);
    })();

    // Footer year
    $('year').textContent = new Date().getFullYear();

    // Basic global error -> show in UI for quick diagnosis
    window.addEventListener('error', e => log('Error: ' + (e.message||e)));
    window.addEventListener('unhandledrejection', e => log('Promise error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));
  })();
  </script>
</body>
</html>
