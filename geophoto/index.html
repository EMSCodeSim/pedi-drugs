<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geo-Photo Viewer (RTDB)</title>
<style>
  :root{--bg:#0b1e27;--card:#102b36;--border:#1c3a47;--accent:#2aa3b5;--text:#ffffff}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
  .wrap{margin:auto;max-width:560px;padding:16px;width:100%}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  .status{opacity:.85}
  img{max-width:100%;border-radius:12px;display:block;margin:.5rem 0}
  .hidden{display:none}
  .btn{width:100%;padding:.8rem;font-size:1rem;border:0;border-radius:10px;background:var(--accent);color:#00151b}
  #error{white-space:pre-wrap;background:#2b1b1b;border:1px solid #4b2a2a;padding:.75rem;border-radius:.5rem;color:#ffd6d6;margin-top:.75rem;display:none}
</style>
<noscript><strong>This page requires JavaScript.</strong></noscript>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Nearby Photo</h2>
    <p class="status" id="status">Booting…</p>
    <div id="result" class="hidden">
      <h3 id="title"></h3>
      <img id="photo" alt="Location photo">
      <p class="status" id="detail"></p>
    </div>
    <button id="enable" class="btn hidden">Enable Location</button>
    <div id="error"></div>
  </div>
</div>

<script type="module">
(async () => {
  const showErr = (e) => {
    const box = document.getElementById('error');
    box.style.display = 'block';
    box.textContent = String(e && e.stack ? e.stack : e);
    console.error(e);
  };
  const setStatus = (t) => document.getElementById('status').textContent = t;

  try {
    // Firebase (RTDB)
    const [{ initializeApp }] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"),
    ]);
    const [{ getDatabase, ref, onValue }] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js"),
    ]);

    // Your config
    const firebaseConfig = {
      apiKey: "AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain: "dailyquiz-d5279.firebaseapp.com",
      databaseURL: "https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId: "dailyquiz-d5279",
      appId: "1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId: "G-19DVN7NNH7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Live spots
    let spots = [];
    onValue(ref(db, "spots"), snap => {
      const val = snap.val() || {};
      spots = Object.values(val).filter(s => s && s.active);
      if (!spots.length) setStatus("No active spots yet.");
    }, err => showErr(err));

    // Helpers
    function haversineMeters(lat1, lon1, lat2, lon2) {
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function findMatch(userLat, userLng){
      let best = null;
      for (const s of spots){
        if (typeof s.lat !== 'number' || typeof s.lng !== 'number' || typeof s.radiusMeters !== 'number') continue;
        const dist = haversineMeters(userLat, userLng, s.lat, s.lng);
        if (dist <= s.radiusMeters){
          if (!best || dist < best.dist) best = { spot: s, dist };
        }
      }
      return best;
    }

    // UI
    const result = document.getElementById('result');
    const title = document.getElementById('title');
    const photo = document.getElementById('photo');
    const detail = document.getElementById('detail');
    const enableBtn = document.getElementById('enable');

    function show(spot, dist){
      result.classList.remove('hidden');
      title.textContent = spot.title || "Nearby spot";
      // Prefer embedded data; fallback to URL
      photo.src = spot.imageData || spot.imageURL || "";
      detail.textContent = `You are ${Math.round(dist)} m from "${spot.title}" (radius ${spot.radiusMeters} m).`;
    }

    // Location
    let lastUpdate = 0;
    const MIN_MS = 4000;
    function onPosition(pos){
      const now = Date.now();
      if (now - lastUpdate < MIN_MS) return;
      lastUpdate = now;

      const { latitude, longitude, accuracy } = pos.coords;
      setStatus(`Lat ${latitude.toFixed(5)}, Lng ${longitude.toFixed(5)} (±${Math.round(accuracy)}m)`);
      const match = findMatch(latitude, longitude);
      if (match) show(match.spot, match.dist);
    }

    function onError(err){
      setStatus(`Location error: ${err.message}`);
      enableBtn.classList.remove('hidden');
    }

    if (!('geolocation' in navigator)){
      setStatus("Geolocation not supported.");
    } else {
      try {
        navigator.geolocation.watchPosition(onPosition, onError, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
        setStatus("Watching your location…");
      } catch (e){ onError(e); }
    }

    enableBtn.onclick = () => {
      enableBtn.classList.add('hidden');
      try {
        navigator.geolocation.watchPosition(onPosition, onError, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
      } catch (e){ showErr(e); }
    };

  } catch (e) {
    showErr(e);
  }
})();
</script>
</body>
</html>
