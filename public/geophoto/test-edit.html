<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Edit — Upload & View (Firebase with Camera)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #0b1220; color: #e8eefc; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    .card { background: #111a2e; border: 1px solid #1b2b50; border-radius: 14px; padding: 12px; }
    .muted { color: #b8c4e2; opacity: 0.9; font-size: 12px; }
    input, button, select { background: #091125; color: #e8eefc; border: 1px solid #20407a; border-radius: 10px; padding: 8px 10px; }
    input.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button { cursor: pointer; }
    button.primary { background: #1a3fbb; border-color: #2c5cff; }
    #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .thumb { background: #0b1429; border: 1px solid #1a2b50; border-radius: 12px; overflow: hidden; }
    .thumb img { width: 100%; height: 160px; object-fit: cover; display: block; }
    .thumb .meta { padding: 8px; font-size: 12px; color: #c9d6f5; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 0 0 auto; }
    .row .grow { flex: 1 1 240px; }
    a { color: #9ec5ff; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Test Edit — Upload & View (Firebase with Camera)</h1>

  <div class="card">
    <div class="bar">
      <label class="muted">Bucket (gs://)</label>
      <input id="bucket" class="mono" placeholder="e.g. gs://fireopssim.appspot.com" />
      <label class="muted">Folder</label>
      <select id="folderMode">
        <option value="scenari">scenarios (flat root)</option>
        <option value="scenarios">scenarios/&lt;scenarioId&gt;</option>
      </select>
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="only for scenarios/&lt;id&gt;" />
      <input id="fileInput" type="file" accept="image/*" capture="environment" />
      <button id="btnUpload" class="primary">Upload Photo</button>
      <button id="btnRefresh">Refresh Gallery</button>
    </div>
    <div class="muted">
      Take a photo using your phone camera or select an existing image. Lists from and uploads to the selected prefix.
      For root files under <span class="mono">scenarios/</span>, keep Folder = "scenarios (flat root)". For per-scenario paths, choose "scenarios/&lt;scenarioId&gt;" and fill the ID.
    </div>
  </div>

  <div id="gallery" style="margin-top:12px"></div>

  <template id="thumbTpl">
    <div class="thumb">
      <a class="full" target="_blank" rel="noopener">
        <img />
      </a>
      <div class="meta mono">
        <div class="path"></div>
      </div>
    </div>
  </template>

  <script type="module">
    // --- Firebase v10 modular SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, listAll
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // --- FireOpsSim project config (from your details) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBzwc75u8pG73OKcHN8ti2ADbucjKMHme8",
      authDomain: "fireopssim.firebaseapp.com",
      projectId: "fireopssim",
      storageBucket: "fireopssim.firebasestorage.app" // HTTPS domain; gs:// set below
    };

    // Init app + anonymous auth (so rules can require request.auth != null)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await signInAnonymously(auth);

    // --- UI elements ---
    const elBucket = document.getElementById('bucket');
    const elScenarioId = document.getElementById('scenarioId');
    const elFolderMode = document.getElementById('folderMode');
    const elFile = document.getElementById('fileInput');
    const elUpload = document.getElementById('btnUpload');
    const elRefresh = document.getElementById('btnRefresh');
    const elGallery = document.getElementById('gallery');
    const tpl = document.getElementById('thumbTpl').content;

    // Default to your project's default bucket
    elBucket.value = 'gs://fireopssim.appspot.com';

    // Build a Storage instance pinned to whichever bucket the user typed
    function getStorageForBucket() {
      const gs = (elBucket.value || '').trim();
      if (!gs.startsWith('gs://')) throw new Error('Enter a valid gs:// bucket name');
      return getStorage(app, gs);
    }

    function getPrefix() {
      const mode = (elFolderMode?.value || 'scenari');
      const sid  = (elScenarioId?.value || '').trim();
      if (mode === 'scenari') return 'scenarios'; // map "scenari" to scenarios root
      if (!sid) throw new Error('Scenario ID is required for scenarios/<sid>');
      return `scenarios/${sid}`;
    }

    function clampSize(file, maxMB=10){
      const max = maxMB * 1024 * 1024;
      if (file.size > max) throw new Error(`File too large (${(file.size/1024/1024).toFixed(1)} MB). Max ${maxMB} MB.`);
    }

    async function uploadPhoto() {
      try {
        const storage = getStorageForBucket();
        const mode = (elFolderMode?.value || 'scenari');
        const sid = (elScenarioId.value || '').trim();

        if (mode === 'scenarios' && !sid) throw new Error('Scenario ID is required');
        const file = elFile.files?.[0];
        if (!file) throw new Error('Please take or select a photo first');

        clampSize(file, 10);

        const safeName = (file.name || 'photo').replace(/[^\w.\-]+/g, '_');
        const prefix = getPrefix();
        const path = `${prefix}/${Date.now()}_${safeName}`;
        const r = ref(storage, path);
        await uploadBytes(r, file, { contentType: file.type || 'image/jpeg' });

        alert('Upload successful!');
        await loadGallery();
      } catch (err) {
        console.error(err);
        alert('Upload failed: ' + (err.message || err));
      }
    }

    async function listFiles(storage, prefix) {
      const folderRef = ref(storage, prefix);
      const res = await listAll(folderRef);
      // Return absolute refs for each item
      return res.items || [];
    }

    async function loadGallery() {
      try {
        const storage = getStorageForBucket();
        const mode = (elFolderMode?.value || 'scenari');
        const sid  = (elScenarioId.value || '').trim();
        if (mode === 'scenarios' && !sid) throw new Error('Scenario ID is required');

        elGallery.innerHTML = '<div class="muted">Loading…</div>';
        const prefix = getPrefix();
        const items = await listFiles(storage, prefix);

        elGallery.innerHTML = '';
        if (!items.length) {
          elGallery.innerHTML = '<div class="muted">No photos uploaded yet.</div>';
          return;
        }

        for (const itemRef of items) {
          const url = await getDownloadURL(itemRef);
          const node = document.importNode(tpl, true);
          node.querySelector('img').src = url;
          node.querySelector('.full').href = url;
          node.querySelector('.path').textContent = itemRef.fullPath || itemRef.name || '(unknown)';
          elGallery.appendChild(node);
        }
      } catch (err) {
        console.error(err);
        elGallery.innerHTML = `<div class="muted">Error: ${err.message}</div>`;
      }
    }

    elUpload.addEventListener('click', uploadPhoto);
    elRefresh.addEventListener('click', loadGallery);
    // Auto-load on open
    loadGallery();
  </script>
</body>
</html>
