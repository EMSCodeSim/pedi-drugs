<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FireOpsSim — Failsafe Uploader</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2e; --muted:#b8c4e2; --line:#1b2b50; --ink:#e8eefc; --accent:#2c5cff; }
    body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Arial}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    input, button, select{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:8px 10px}
    input.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    button{cursor:pointer}
    button.primary{background:#1a3fbb;border-color:var(--accent)}
    .card{background:var(--card);border:1px solid #1b2b50;border-radius:14px;padding:12px;margin:12px 0}
    .muted{color:var(--muted);opacity:.95}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .thumb{background:#0b1429;border:1px solid #1a2b50;border-radius:12px;overflow:hidden}
    .thumb img{width:100%;height:160px;object-fit:cover;display:block}
    .thumb .meta{padding:8px;font-size:12px}
    pre{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:8px;overflow:auto;max-height:240px}
    a{color:#9ec5ff}
  </style>
</head>
<body>
  <h1>FireOpsSim — Failsafe Uploader</h1>

  <div class="card">
    <div class="row">
      <label class="muted">Bucket (gs://)</label>
      <input id="bucket" class="mono" placeholder="gs://fireopssim.appspot.com" />
      <label class="muted">Folder</label>
      <select id="folderMode">
        <option value="scenari">scenarios (flat root)</option>
        <option value="scenarios">scenarios/&lt;scenarioId&gt;</option>
      </select>
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="only for scenarios/&lt;id&gt;" />
    </div>
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" capture="environment" />
      <!-- inline onclick (fallback) -->
      <button id="btnUpload" class="primary" onclick="window.handleUpload && window.handleUpload()">Upload Photo</button>
      <button id="btnRefresh">Refresh Gallery</button>
      <button id="btnDiag">Diag</button>
    </div>
    <div class="muted">
      Use the <span class="mono">gs://</span> bucket name (e.g., <span class="mono">gs://fireopssim.appspot.com</span>), not the HTTPS domain.
    </div>
  </div>

  <div class="card">
    <strong>Status</strong>
    <pre id="log">Booting…</pre>
  </div>

  <div id="grid" class="card">
    <div class="muted">No photos yet. Click “Refresh Gallery”.</div>
  </div>

  <template id="thumbTpl">
    <div class="thumb">
      <a class="full" target="_blank" rel="noopener">
        <img />
      </a>
      <div class="meta mono">
        <div class="path"></div>
      </div>
    </div>
  </template>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, listAll,
      setMaxOperationRetryTime, setMaxUploadRetryTime
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // ---- DOM ----
    const $ = (id)=>document.getElementById(id);
    const elBucket = $('bucket');
    const elScenarioId = $('scenarioId');
    const elFolderMode = $('folderMode');
    const elFile = $('fileInput');
    const elUpload = $('btnUpload');
    const elRefresh = $('btnRefresh');
    const elDiag = $('btnDiag');
    const elLog = $('log');
    const elGrid = $('grid');
    const tpl = document.getElementById('thumbTpl').content;

    function log(msg){
      const t = `[${new Date().toLocaleTimeString()}] ${msg}`;
      elLog.textContent += (elLog.textContent ? '\n' : '') + t;
      elLog.scrollTop = elLog.scrollHeight;
      console.debug(t);
    }

    // ---- Config (client-safe) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBzwc75u8pG73OKcHN8ti2ADbucjKMHme8",
      authDomain: "fireopssim.firebaseapp.com",
      projectId: "fireopssim",
      storageBucket: "fireopssim.firebasestorage.app"
    };

    // ---- State ----
    let app = null, auth = null, storage = null, uid = null;

    function getPrefix(){
      const mode = elFolderMode.value || 'scenari';
      const sid = (elScenarioId.value || '').trim();
      if (mode === 'scenari') return 'scenarios';
      if (!sid) throw new Error('Scenario ID is required for scenarios/<id>');
      return `scenarios/${sid}`;
    }
    const safeName = s => (s||'photo').replace(/[^\w.\-]+/g,'_');

    async function ensureInit(){
      if (app && auth && storage) return;
      log('Initializing Firebase…');

      // If a previous app exists (hot reload), reuse it
      if (!getApps().length) app = initializeApp(firebaseConfig);
      else app = getApps()[0];

      auth = getAuth(app);
      try {
        await signInAnonymously(auth);
        uid = (auth.currentUser && auth.currentUser.uid) || null;
        log(`Auth OK (anon uid=${uid||'unknown'})`);
      } catch (e) {
        log(`Auth error: ${e?.message||e}`);
        throw e;
      }

      const gs = (elBucket.value || '').trim();
      if (!gs.startsWith('gs://')) throw new Error('Bucket must start with gs:// (e.g., gs://fireopssim.appspot.com)');
      storage = getStorage(app, gs);
      setMaxOperationRetryTime(storage, 60_000);
      setMaxUploadRetryTime(storage, 120_000);
      log(`Storage bound to ${gs}`);
    }

    async function refreshGallery(){
      await ensureInit();
      const prefix = getPrefix();
      log(`Listing ${prefix}…`);
      const folder = ref(storage, prefix);
      const res = await listAll(folder);
      const items = res.items || [];
      elGrid.innerHTML = '';
      if (!items.length){
        elGrid.innerHTML = '<div class="muted">No photos found.</div>';
        log('No photos found.');
        return;
      }
      const urls = [];
      for (const it of items){
        try { urls.push(await getDownloadURL(it)); }
        catch(e){ urls.push(null); log(`getDownloadURL failed for ${it.fullPath}: ${e?.message||e}`); }
      }
      urls.forEach((u,i)=>{
        const it = items[i];
        const node = document.importNode(tpl, true);
        if (u){ node.querySelector('img').src = u; node.querySelector('.full').href = u; }
        node.querySelector('.path').textContent = it.fullPath || it.name;
        elGrid.appendChild(node);
      });
      log(`Listed ${items.length} item(s).`);
    }

    // Expose handleUpload globally for inline onclick fallback
    window.handleUpload = async function(){
      try{
        log('Upload button clicked.');
        await ensureInit();

        const f = elFile.files && elFile.files[0];
        if (!f){ alert('Pick or take a photo first'); log('No file selected.'); return; }

        const prefix = getPrefix();
        const path = `${prefix}/${Date.now()}_${safeName(f.name)}`;
        log(`Uploading to ${path} (${(f.size/1048576).toFixed(2)} MB)…`);

        const r = ref(storage, path);
        await uploadBytes(r, f, { contentType: f.type || 'image/jpeg' });
        log('Upload OK.');
        alert('Upload successful!');
        await refreshGallery();
      }catch(e){
        console.error(e);
        log(`Upload error: ${e?.code||''} ${e?.message||e}`);
        alert('Upload failed: ' + (e?.message || e));
      }
    };

    // Also bind via addEventListener (primary path)
    elUpload.addEventListener('click', ()=>window.handleUpload());
    elRefresh.addEventListener('click', ()=>{ refreshGallery().catch(e=>{ log('Refresh error: '+(e?.message||e)); alert(e?.message||e); }); });
    elDiag.addEventListener('click', async ()=>{
      try {
        await ensureInit();
        log('Diag: small test upload…');
        const blob = new Blob([Uint8Array.from([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,8,2,0,0,0,144,119,83,222,0,0,0,12,73,68,65,84,8,215,99,248,15,4,0,9,251,3,253,167,6,227,151,0,0,0,0,73,69,78,68,174,66,96,130])], {type:'image/png'});
        const path = `${getPrefix()}/diag_${Date.now()}.png`;
        await uploadBytes(ref(storage, path), blob, {contentType:'image/png'});
        log('Diag upload OK: '+path);
        alert('Diag upload OK: ' + path);
      } catch (e) {
        log('Diag error: ' + (e?.message||e));
        alert('Diag error: ' + (e?.message||e));
      }
    });

    // Defaults
    elBucket.value = 'gs://fireopssim.appspot.com';
    elFolderMode.value = 'scenari';
    log('UI ready. Click Upload to test.');
  </script>
</body>
</html>
