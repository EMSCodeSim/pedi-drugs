<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Edit — Upload & View (Supabase with Camera)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #0b1220; color: #e8eefc; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    .card { background: #111a2e; border: 1px solid #1b2b50; border-radius: 14px; padding: 12px; }
    .muted { color: #b8c4e2; opacity: 0.9; font-size: 12px; }
    input, button, select { background: #091125; color: #e8eefc; border: 1px solid #20407a; border-radius: 10px; padding: 8px 10px; }
    input.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button { cursor: pointer; }
    button.primary { background: #1a3fbb; border-color: #2c5cff; }
    #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .thumb { background: #0b1429; border: 1px solid #1a2b50; border-radius: 12px; overflow: hidden; }
    .thumb img { width: 100%; height: 160px; object-fit: cover; display: block; }
    .thumb .meta { padding: 8px; font-size: 12px; color: #c9d6f5; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 0 0 auto; }
    .row .grow { flex: 1 1 240px; }
    a { color: #9ec5ff; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Test Edit — Upload & View (Supabase with Camera)</h1>

  <div class="card">
    <div class="bar">
      <label class="muted">Bucket</label>
      <input id="bucket" class="mono" placeholder="e.g. geophoto" />
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="e.g. -OZKwtRwHXxsM7tLQcnV" />
      <input id="fileInput" type="file" accept="image/*" capture="environment" />
      <button id="btnUpload" class="primary">Upload Photo</button>
      <button id="btnRefresh">Refresh Gallery</button>
    </div>
    <div class="muted">Take a photo using your phone camera or select an existing image. Uploaded to <span class="mono">{bucket}/scenarios/&lt;scenarioId&gt;/&lt;timestamp&gt;_filename</span>.</div>
  </div>

  <div id="gallery" style="margin-top:12px"></div>

  <template id="thumbTpl">
    <div class="thumb">
      <a class="full" target="_blank" rel="noopener">
        <img />
      </a>
      <div class="meta mono">
        <div class="path"></div>
      </div>
    </div>
  </template>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";

    const SUPABASE_URL = "https://qwhuciodtyotgrbeakdu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3aHVjaW9kdHlvdGdyYmVha2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTcwNTcsImV4cCI6MjA3Mzg5MzA1N30.4TOChR01-9s0o7zus140ImUF6slesCLuEpa6JY-LSBQ";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const elBucket = document.getElementById('bucket');
    const elScenarioId = document.getElementById('scenarioId');
    const elFile = document.getElementById('fileInput');
    const elUpload = document.getElementById('btnUpload');
    const elRefresh = document.getElementById('btnRefresh');
    const elGallery = document.getElementById('gallery');
    const tpl = document.getElementById('thumbTpl').content;

    elBucket.value = 'geophoto'; // default bucket

    async function uploadPhoto() {
      try {
        const bucket = (elBucket.value || '').trim();
        const sid = (elScenarioId.value || '').trim();
        if (!bucket || !sid) throw new Error('Bucket and Scenario ID are required');

        const file = elFile.files?.[0];
        if (!file) throw new Error('Please take or select a photo first');

        const safeName = file.name.replace(/\s+/g, '_');
        const path = `scenarios/${sid}/${Date.now()}_${safeName}`;
        const { error } = await supabase.storage.from(bucket).upload(path, file, {
          contentType: file.type || 'application/octet-stream',
          upsert: true
        });
        if (error) throw error;

        alert('Upload successful!');
        await loadGallery();
      } catch (err) {
        alert('Upload failed: ' + err.message);
        console.error(err);
      }
    }

    async function getSignedUrl(bucket, path) {
      const { data, error } = await supabase.storage.from(bucket).createSignedUrl(path, 60 * 60 * 6);
      if (error) throw error;
      return data.signedUrl;
    }

    async function listFiles(bucket, prefix) {
      const { data, error } = await supabase.storage.from(bucket).list(prefix, {
        limit: 100,
        sortBy: { column: 'name', order: 'desc' }
      });
      if (error) {
        if ((error.message || '').toLowerCase().includes('not found')) return [];
        throw error;
      }
      return (data || []).filter(e => e && e.metadata).map(e => ({ path: `${prefix}/${e.name}` }));
    }

    async function loadGallery() {
      try {
        const bucket = (elBucket.value || '').trim();
        const sid = (elScenarioId.value || '').trim();
        if (!bucket || !sid) throw new Error('Bucket and Scenario ID are required');

        elGallery.innerHTML = '<div class="muted">Loading…</div>';
        const files = await listFiles(bucket, `scenarios/${sid}`);
        elGallery.innerHTML = '';
        if (!files.length) {
          elGallery.innerHTML = '<div class="muted">No photos uploaded yet.</div>';
          return;
        }

        for (const f of files) {
          const url = await getSignedUrl(bucket, f.path);
          const node = document.importNode(tpl, true);
          node.querySelector('img').src = url;
          node.querySelector('.full').href = url;
          node.querySelector('.path').textContent = f.path;
          elGallery.appendChild(node);
        }
      } catch (err) {
        elGallery.innerHTML = `<div class=muted>Error: ${err.message}</div>`;
        console.error(err);
      }
    }

    elUpload.addEventListener('click', uploadPhoto);
    elRefresh.addEventListener('click', loadGallery);
  </script>
</body>
</html>
