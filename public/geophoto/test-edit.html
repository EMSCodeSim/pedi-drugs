<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Edit — Upload & View (Supabase)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #0b1220; color: #e8eefc; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    .card { background: #111a2e; border: 1px solid #1b2b50; border-radius: 14px; padding: 12px; }
    .muted { color: #b8c4e2; opacity: 0.9; font-size: 12px; }
    input, button, select { background: #091125; color: #e8eefc; border: 1px solid #20407a; border-radius: 10px; padding: 8px 10px; }
    input.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button { cursor: pointer; }
    button.primary { background: #1a3fbb; border-color: #2c5cff; }
    #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .thumb { background: #0b1429; border: 1px solid #1a2b50; border-radius: 12px; overflow: hidden; }
    .thumb img { width: 100%; height: 160px; object-fit: cover; display: block; }
    .thumb .meta { padding: 8px; font-size: 12px; color: #c9d6f5; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 0 0 auto; }
    .row .grow { flex: 1 1 240px; }
    a { color: #9ec5ff; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Test Edit — Upload & View (Supabase)</h1>

  <div class="card" id="sbCard">
    <div class="bar">
      <label class="muted">Supabase URL</label>
      <input id="sbUrl" class="mono grow" placeholder="https://YOUR-PROJECT.supabase.co" />
      <label class="muted">Anon/Public Key</label>
      <input id="sbKey" class="mono grow" placeholder="Paste SUPABASE_ANON_KEY" />
      <button id="btnSaveSb" class="primary">Save & Init</button>
      <div class="muted" id="sbState">Not initialized</div>
    </div>
    <div class="muted">Keys are stored locally (localStorage) only in your browser.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="bar">
      <label class="muted">Bucket</label>
      <input id="bucket" class="mono" placeholder="e.g. scenarios" />
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="e.g. -OZKwtRwHXxsM7tLQcnV" />
      <input id="fileInput" type="file" accept="image/*" />
      <button id="btnUpload" class="primary">Upload Photo</button>
      <button id="btnRefresh">Refresh Gallery</button>
    </div>
    <div class="muted">Uploads to <span class="mono">{bucket}/scenarios/&lt;scenarioId&gt;/&lt;timestamp&gt;_filename</span>.</div>
  </div>

  <div id="gallery" style="margin-top:12px"></div>

  <template id="thumbTpl">
    <div class="thumb">
      <a class="full" target="_blank" rel="noopener">
        <img />
      </a>
      <div class="meta mono">
        <div class="path"></div>
      </div>
    </div>
  </template>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";

    // ---- Elements ----
    const elSbUrl = document.getElementById('sbUrl');
    const elSbKey = document.getElementById('sbKey');
    const elSaveSb = document.getElementById('btnSaveSb');
    const elSbState = document.getElementById('sbState');

    const elBucket = document.getElementById('bucket');
    const elScenarioId = document.getElementById('scenarioId');
    const elFile = document.getElementById('fileInput');
    const elUpload = document.getElementById('btnUpload');
    const elRefresh = document.getElementById('btnRefresh');
    const elGallery = document.getElementById('gallery');
    const tpl = document.getElementById('thumbTpl').content;

    // ---- Defaults (your provided URL & key prefilled) ----
    const DEFAULT_URL = "https://qwhuciodtyotgrbeakdu.supabase.co";
    const DEFAULT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3aHVjaW9kdHlvdGdyYmVha2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTcwNTcsImV4cCI6MjA3Mzg5MzA1N30.4TOChR01-9s0o7zus140ImUF6slesCLuEpa6JY-LSBQ";
    elSbUrl.value  = localStorage.getItem('SB_URL')    || DEFAULT_URL;
    elSbKey.value  = localStorage.getItem('SB_KEY')    || DEFAULT_KEY;
    elBucket.value = localStorage.getItem('SB_BUCKET') || 'scenarios';

    // ---- Supabase client ----
    let supabase = null;
    function setSbState(txt) { elSbState.textContent = txt; }
    function initSupabase() {
      const url = (elSbUrl.value || '').trim();
      const key = (elSbKey.value || '').trim();
      if (!url || !key) { setSbState('Missing URL or Key'); return null; }
      supabase = createClient(url, key, { auth: { persistSession: false } });
      setSbState('Initialized');
      return supabase;
    }
    if (elSbUrl.value && elSbKey.value) initSupabase();

    elSaveSb.addEventListener('click', () => {
      localStorage.setItem('SB_URL', (elSbUrl.value || '').trim());
      localStorage.setItem('SB_KEY', (elSbKey.value || '').trim());
      localStorage.setItem('SB_BUCKET', (elBucket.value || '').trim());
      initSupabase();
      alert('Supabase settings saved.');
    });

    // ---- Helpers ----
    function requireReady() {
      if (!supabase) throw new Error('Supabase not initialized');
      const bucket = (elBucket.value || '').trim();
      if (!bucket) throw new Error('Enter a bucket name');
      const sid = (elScenarioId.value || '').trim();
      if (!sid) throw new Error('Enter a Scenario ID');
      return { bucket, sid };
    }

    async function uploadPhoto() {
      try {
        const { bucket, sid } = requireReady();
        const f = elFile.files?.[0];
        if (!f) throw new Error('Choose a file to upload');
        const safeName = f.name.replace(/\s+/g, '_');
        const path = `scenarios/${sid}/${Date.now()}_${safeName}`;
        const { error } = await supabase.storage.from(bucket).upload(path, f, {
          contentType: f.type || 'application/octet-stream',
          upsert: true,
        });
        if (error) throw error;
        alert('Uploaded! Refreshing gallery…');
        await loadGallery();
      } catch (e) {
        console.error(e);
        alert('Upload failed: ' + (e.message || e));
      }
    }

    async function getSignedUrl(bucket, path) {
      // Works for both public & private buckets
      const { data, error } = await supabase.storage.from(bucket).createSignedUrl(path, 60 * 60 * 6); // 6h
      if (error) throw error;
      return data.signedUrl;
    }

    async function listFilesOneLevel(bucket, prefix) {
      // Lists only one level (no recursion). Good for scenarios/<sid>/ files.
      const { data, error } = await supabase.storage.from(bucket).list(prefix, {
        limit: 100,
        sortBy: { column: 'name', order: 'desc' }
      });
      if (error) throw error;
      // Keep only entries that look like files (have metadata)
      return (data || [])
        .filter(e => e && e.metadata)
        .map(e => ({ path: prefix ? `${prefix}/${e.name}` : e.name }));
    }

    async function loadGallery() {
      try {
        const { bucket, sid } = requireReady();
        const prefix = `scenarios/${sid}`;
        elGallery.innerHTML = '<div class="muted">Loading…</div>';
        const files = await listFilesOneLevel(bucket, prefix);
        elGallery.innerHTML = '';
        if (!files.length) {
          elGallery.innerHTML = '<div class="muted">No files yet. Upload above.</div>';
          return;
        }
        for (const f of files) {
          const url = await getSignedUrl(bucket, f.path);
          const node = document.importNode(tpl, true);
          node.querySelector('img').src = url;
          node.querySelector('.full').href = url;
          node.querySelector('.path').textContent = f.path;
          elGallery.appendChild(node);
        }
      } catch (e) {
        console.error(e);
        elGallery.innerHTML = `<div class=muted>Error: ${e.message || e}</div>`;
      }
    }

    elUpload.addEventListener('click', uploadPhoto);
    elRefresh.addEventListener('click', loadGallery);

    // URL params support: ?sid=…&bucket=…
    const params = new URLSearchParams(location.search);
    if (params.get('sid')) elScenarioId.value = params.get('sid');
    if (params.get('bucket')) elBucket.value = params.get('bucket');
  </script>
</body>
</html>
