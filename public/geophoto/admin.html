<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FireOpsSim — Admin (Create Scenario + Uploader/Viewer)</title>
<style>
  :root{--bg:#0b1220;--card:#111a2e;--muted:#b8c4e2;--line:#1b2b50;--ink:#e8eefc;--accent:#2c5cff;--ok:#7CFF7C;--bad:#FF7C7C}
  body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Arial}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button,textarea{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:8px 10px}
  input.mono, .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  textarea{min-height:70px;width:100%}
  button{cursor:pointer}
  button.primary{background:#1a3fbb;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid :var(--line);border-color:var(--line);border-radius:14px;padding:12px;margin:12px 0}
  .muted{color:var(--muted);opacity:.95}
  #status{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:10px;max-height:220px;overflow:auto}
  #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .thumb{background:#0b1429;border:1px solid #1a2b50;border-radius:12px;overflow:hidden}
  .thumb img{width:100%;height:160px;object-fit:cover;display:block}
  .thumb .meta{padding:8px;font-size:12px}
  a{color:#9ec5ff}
  #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9999}
  #lightbox img{max-width:95vw;max-height:90vh}
  #lightbox .close{position:absolute;top:12px;right:12px;background:#222;color:#fff;border:0;border-radius:10px;padding:8px 10px;cursor:pointer}
  #preview img{max-width:100%;height:auto;border-radius:10px;border:1px solid #1a2b50}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
</style>
</head>
<body>
  <h1>FireOpsSim — Admin</h1>

  <div class="card">
    <div class="row">
      <div class="muted">DB:</div><div class="mono">dailyquiz-d5279 (Realtime DB)</div>
      <div class="muted">Photos:</div><div class="mono">gs://fireopssim.appspot.com</div>
    </div>

    <div class="row">
      <label class="muted">Scenario Name</label>
      <input id="title" placeholder="e.g., House Fire — Elm St." style="min-width:260px">
      <label class="muted">Dispatch</label>
      <input id="dispatch" placeholder="Engine 1, Engine 2…" style="min-width:260px">
      <button id="btnCreate" class="primary">Create Scenario</button>
      <span id="createStatus" class="muted">idle</span>
    </div>

    <div class="row">
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="-Oabc123 (or create above)" style="min-width:260px">
      <button id="btnUse" title="Use this ID for uploads">Use ID</button>
      <span id="useStatus" class="muted"></span>
    </div>
    <div class="muted">Files upload to <span class="mono">scenarios/&lt;scenarioId&gt;/</span> in the FireOpsSim bucket.</div>
  </div>

  <div class="card">
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" capture="environment" />
      <button id="btnUpload" class="primary">Upload Photo</button>
      <button id="btnRefresh">Refresh Gallery</button>
      <button id="btnLatest">View Latest</button>
    </div>
    <div id="preview" style="display:none;margin-top:6px">
      <strong>Uploaded Preview</strong>
      <div class="muted">The file you just uploaded.</div>
      <div id="previewImgWrap" style="margin-top:8px"></div>
      <div class="actions">
        <a id="previewOpen" target="_blank" rel="noopener">Open in new tab</a>
        <button id="copyUrl">Copy URL</button>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Status</strong>
    <div id="status">Booting…</div>
  </div>

  <div id="grid" class="card">
    <div class="muted">No photos yet. Click “Refresh Gallery”.</div>
  </div>

  <div id="lightbox">
    <button class="close" id="lbClose">✕ Close</button>
    <img id="lbImg" alt="Preview" />
  </div>

  <template id="thumbTpl">
    <div class="thumb">
      <a class="full" href="#" target="_blank" rel="noopener">
        <img />
      </a>
      <div class="meta mono"><div class="path"></div></div>
    </div>
  </template>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const logBox = $('status');
    const log = (m, cls) => {
      const t = `[${new Date().toLocaleTimeString()}] ${m}`;
      const line = document.createElement('div');
      if (cls) line.style.color = cls === 'ok' ? '#7CFF7C' : (cls === 'bad' ? '#FF7C7C' : '#FFD37C');
      line.textContent = t;
      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
      console.debug(t);
    };
    const ok = m=>log(m,'ok'), bad = m=>log(m,'bad');

    // --- Configs (DB old, Storage new) ---
    const cfgDB = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const cfgFO = {
      apiKey: "AIzaSyBzwc75u8pG73OKcHN8ti2ADbucjKMHme8",
      authDomain: "fireopssim.firebaseapp.com",
      projectId: "fireopssim",
      storageBucket: "fireopssim.appspot.com" // bind gs:// below
    };

    // --- Init apps ---
    const appDB = firebase.initializeApp(cfgDB);               // [DEFAULT] DB
    const appFO = firebase.initializeApp(cfgFO, "fireops");    // secondary app for Storage

    const db     = firebase.database(appDB);
    const authDB = firebase.auth(appDB);
    const authFO = firebase.auth(appFO);
    // *** THIS mirrors test-edit logic ***
    const storage = firebase.storage(appFO, "gs://fireopssim.appspot.com");
    storage.setMaxOperationRetryTime(60000);
    storage.setMaxUploadRetryTime(120000);

    // --- State ---
    let currentScenarioId = '';
    let userFO = null;

    function safeName(s){ return (s||'photo').replace(/[^\w.\-]+/g,'_'); }
    function needScenario(){
      const sid = ($('scenarioId').value || '').trim();
      if(!sid) throw new Error('Enter a Scenario ID first (or create one).');
      return sid;
    }

    async function signIn(){
      try{
        await authDB.signInAnonymously().catch(()=>{});
        const cred = await authFO.signInAnonymously();
        userFO = cred && cred.user;
        ok('Auth OK (FO anon uid='+(userFO && userFO.uid || 'unknown')+')');
      }catch(e){
        bad('Auth error: '+(e.code?e.code+' ':'')+(e.message||e));
      }
    }

    // --- Scenario creation in OLD DB ---
    async function createScenario(){
      try{
        const title = ($('title').value||'').trim();
        const dispatch = ($('dispatch').value||'').trim();
        if(!title){ $('createStatus').textContent='enter a name'; return; }
        $('createStatus').textContent='creating…';
        const id = db.ref('scenarios').push().key;
        const base = { id, title, dispatch, description:dispatch, createdAt:Date.now(), active:true, stops:[] };
        const multi={}; multi[`scenarios/${id}`]=base; multi[`geophoto/scenarios/${id}`]=base;
        await db.ref().update(multi);
        $('scenarioId').value = id;
        currentScenarioId = id;
        $('createStatus').textContent='created ✓';
        ok('Scenario created: '+id);
      }catch(e){
        $('createStatus').textContent='error';
        bad('Create scenario error: '+(e.message||e));
      }
    }

    // --- Uploader (mirrors test-edit) ---
    async function upload(){
      try{
        if (!userFO) await signIn();
        const sid = needScenario();
        currentScenarioId = sid;

        const f = $('fileInput').files && $('fileInput').files[0];
        if (!f){ alert('Pick or take a photo first'); log('No file selected.'); return; }
        if (f.size > 10*1024*1024){ alert('Max 10 MB'); return; }

        const path = `scenarios/${sid}/${Date.now()}_${safeName(f.name)}`;
        log('Uploading → '+path);
        const r = storage.ref().child(path);
        await r.put(f, { contentType: f.type || 'image/jpeg' });
        ok('Upload OK.');

        const url = await r.getDownloadURL();
        ok('URL ready.');
        showPreview(url);

        await appendStopToDB({ imageURL:url, thumbURL:url, storagePath:r.fullPath, gsUri:`gs://fireopssim.appspot.com/${r.fullPath}`, backend:'fireops', at: Date.now(), type:'photo', radiusMeters:5, overlays:[] });
        await refresh(); // update gallery
      }catch(e){
        bad('Upload error: '+(e.code?e.code+' ':'')+(e.message||e));
        alert('Upload failed: ' + (e.message||e));
      }
    }

    async function appendStopToDB(stop){
      try{
        const sid = currentScenarioId || needScenario();
        const snap = await db.ref(`scenarios/${sid}/stops`).get();
        const arr = snap.exists()? (snap.val()||[]) : [];
        arr.push(stop);
        const multi={};
        multi[`scenarios/${sid}/stops`] = arr;
        multi[`geophoto/scenarios/${sid}/stops`] = arr;
        await db.ref().update(multi);
        ok('Stop metadata saved to DB.');
      }catch(e){
        bad('DB write error: '+(e.message||e));
      }
    }

    function showPreview(url){
      $('preview').style.display = '';
      const wrap = $('previewImgWrap');
      wrap.innerHTML = '';
      const img = document.createElement('img');
      img.src = url;
      wrap.appendChild(img);
      $('previewOpen').href = url;
      $('copyUrl').onclick = async () => {
        try{ await navigator.clipboard.writeText(url); ok('URL copied.'); }
        catch(e){ bad('Copy failed: '+(e.message||e)); }
      };
    }

    async function refresh(){
      try{
        if (!userFO) await signIn();
        const sid = needScenario();
        const folderRef = storage.ref().child(`scenarios/${sid}`);
        log('Listing scenarios/'+sid+' …');
        const { items } = await folderRef.listAll();
        const urls = await Promise.all(items.map(async it=>{
          try { return await it.getDownloadURL(); } catch(e){ return null; }
        }));
        const entries = items.map((it,i)=>({it,url:urls[i]}))
                             .sort((a,b)=>(b.name||'').localeCompare(a.name||''));
        renderGrid(entries);
        ok(`Listed ${entries.length} item(s).`);
      }catch(e){
        bad('Refresh error: '+(e.code?e.code+' ':'')+(e.message||e));
      }
    }

    async function viewLatest(){
      try{
        if (!userFO) await signIn();
        const sid = needScenario();
        const { items } = await storage.ref().child(`scenarios/${sid}`).listAll();
        if (!items.length){ alert('No files in this scenario yet.'); return; }
        const latest = items.sort((a,b)=>(b.name||'').localeCompare(a.name||''))[0];
        const url = await latest.getDownloadURL();
        openLightbox(url);
      }catch(e){
        bad('View Latest error: '+(e.code?e.code+' ':'')+(e.message||e));
      }
    }

    function renderGrid(entries){
      const grid = $('grid');
      grid.innerHTML = '';
      if (!entries.length){
        grid.innerHTML = '<div class="muted">No photos found.</div>';
        return;
      }
      const tpl = $('thumbTpl').content;
      entries.forEach(({it,url})=>{
        const node = document.importNode(tpl, true);
        node.querySelector('.path').textContent = it.fullPath || it.name;
        if (url){
          node.querySelector('img').src = url;
          node.querySelector('.full').href = url;
          node.querySelector('a.full').addEventListener('click', (ev)=>{
            ev.preventDefault(); openLightbox(url);
          });
        }
        grid.appendChild(node);
      });
    }

    function openLightbox(url){
      $('lbImg').src = url;
      $('lightbox').style.display = 'flex';
    }
    $('lbClose').onclick = ()=>{ $('lightbox').style.display = 'none'; $('lbImg').src=''; };

    // Wire buttons
    $('btnCreate').addEventListener('click', createScenario);
    $('btnUse').addEventListener('click', ()=>{
      try{ currentScenarioId = needScenario(); $('useStatus').textContent='using ✓'; }
      catch(e){ $('useStatus').textContent=e.message; }
    });
    $('btnUpload').addEventListener('click', upload);
    $('btnRefresh').addEventListener('click', refresh);
    $('btnLatest').addEventListener('click', viewLatest);

    // Warmup
    (async function boot(){
      log('Booting…');
      await signIn();
      log('Ready. Create or enter a Scenario ID, pick a photo, then Upload.');
    })();
  })();
  </script>
</body>
</html>
