<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FireOps SIM — Scenario Builder (Cloud-write required)</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root{--bg:#0b0f14;--bg2:#0d121c;--panel:#0f1624;--text:#eaf2ff;--muted:#9fb2d6;--edge:rgba(255,255,255,.14)}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:radial-gradient(1200px 600px at 12% -8%, rgba(10,132,255,.22), transparent 60%),
               radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.16), transparent 60%),
               linear-gradient(165deg,var(--bg2),var(--bg) 55%)}
  header{position:sticky;top:0;z-index:10;background:#0b0f14;border-bottom:1px solid var(--edge);isolation:isolate}
  .bar{max-width:1100px;margin:0 auto;padding:12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .brand{font-weight:900}
  .tag{font-size:12px;color:#a6c4ff;background:#0b1a35;border:1px solid #214987;border-radius:10px;padding:6px 10px}
  main{max-width:1100px;margin:14px auto 30px;padding:0 12px;display:grid;gap:12px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 26%),
               linear-gradient(180deg,#0f1624,#0e1420);border:1px solid var(--edge);border-radius:16px;padding:14px}
  .hidden{display:none!important}
  label{display:block;font-weight:700;margin-top:8px}
  input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;background:#0b1322;color:#eaf2ff;border:1px solid var(--edge)}
  textarea{min-height:90px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--edge);background:#132136;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:#9fb2d6}
  .barWrap{height:10px;border:1px solid var(--edge);border-radius:8px;background:#0c1322;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#2484ff,#63dbff)}
  .preview{width:100%;max-height:70vh;display:grid;place-items:center;background:#050e19;border:1px solid var(--edge);border-radius:14px;overflow:hidden}
  .preview img{max-width:100%;max-height:70vh;object-fit:contain;display:block}
  #gallery{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  .gItem{border:1px solid var(--edge);border-radius:12px;overflow:hidden;background:#0b1322}
  .gItem img{width:100%;height:100%;object-fit:cover;display:block;aspect-ratio:1/1}
  .gCap{padding:6px 8px;font-size:12px;color:#9fb2d6}
  #errbar{position:fixed;left:12px;bottom:12px;z-index:99;display:none;padding:10px 12px;border-radius:12px;border:1px solid #7a2b2b;background:#2b0d0d;color:#ffd7d7;max-width:92vw}
  #loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,12,20,.55);backdrop-filter:blur(2px);z-index:98}
  .spinner{width:42px;height:42px;border-radius:999px;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #log{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:8px;max-height:260px;overflow:auto}
</style>
</head>
<body>
  <div id="errbar"></div>
  <div id="loader"><div class="spinner"></div></div>

  <header>
    <div class="bar">
      <div class="brand">FireOps SIM — Scenario Builder</div>
      <div class="tag">DB: dailyquiz-d5279 • Photos: <strong>gs://fireopssim.appspot.com</strong></div>
    </div>
  </header>

  <main>
    <!-- STEP 1 -->
    <section id="step1" class="card">
      <h3 style="margin:0">Step 1 — Scenario details</h3>
      <div class="hint">Enter a name and (optional) dispatch. Create the scenario to continue.</div>
      <label>Scenario Name</label>
      <input id="sTitle" placeholder="e.g., House Fire — Elm St.">
      <label>Dispatch (optional)</label>
      <textarea id="sDispatch" placeholder="Engine 1, Engine 2, Medic 1…"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="createBtn" class="btn" onclick="window._onCreateScenario && window._onCreateScenario()">Create Scenario</button>
        <span id="s1Status" class="hint">idle</span>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card hidden">
      <h3 style="margin:0 0 6px">Step 2 — Add a photo stop</h3>
      <div class="hint">Take a photo, choose from your photo library, or upload a file. GPS is added automatically.</div>

      <div class="row" style="margin:8px 0 6px">
        <button id="btnCamera" class="btn">Take Photo</button>
        <button id="btnLibrary" class="btn">Choose from Library</button>
        <button id="btnUpload" class="btn">Upload File</button>
      </div>
      <input id="inCamera"  type="file" accept="image/*" capture="environment" class="hidden">
      <input id="inLibrary" type="file" accept="image/*" class="hidden">
      <input id="inUpload"  type="file" accept="image/*" class="hidden">

      <div id="workArea" class="hidden">
        <div class="preview" style="margin:10px 0">
          <img id="previewImg" alt="preview">
        </div>

        <div class="row">
          <div class="hint" id="imgInfo">Image: —</div>
          <div class="row" style="margin-left:auto">
            <label for="radius" class="hint">Radius (m)</label>
            <input id="radius" type="number" min="1" max="1000" value="5" style="width:110px">
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div id="gpsLine" class="hint">GPS: acquiring…</div>
        </div>

        <div style="margin-top:10px">
          <div class="row" style="justify-content:space-between">
            <span class="hint">Full upload</span><span id="pctFull" class="hint">0%</span>
          </div>
          <div class="barWrap"><div id="barFull" class="bar"></div></div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <span class="hint">Thumbnail</span><span id="pctThumb" class="hint">0%</span>
          </div>
          <div class="barWrap"><div id="barThumb" class="bar"></div></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="saveBtn" class="btn">Save Photo</button>
          <button id="diagBtn" class="btn ghost" title="Write tiny file to Storage">Test Storage</button>
          <button id="resetBtn" class="btn ghost">Choose another</button>
          <span id="saveStatus" class="hint">waiting</span>
        </div>

        <div id="afterSave" class="hidden" style="margin-top:8px">
          <button id="addAnotherBtn" class="btn">Add another photo</button>
          <span class="hint">Repeat to add more stops.</span>
        </div>
      </div>
    </section>

    <!-- GALLERY + LOG -->
    <section id="galleryCard" class="card hidden">
      <h3 style="margin:0 0 6px">Photos in this scenario (from <code>gs://fireopssim.appspot.com</code>)</h3>
      <div id="gallery"></div>
      <div id="galleryEmpty" class="hint">No photos yet.</div>
      <div style="margin-top:10px">
        <strong>Status Log</strong>
        <div id="log">Booting…</div>
      </div>
    </section>
  </main>

  <!-- Firebase COMPAT SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
  (function(){
    // ===== UI helpers =====
    const $ = id => document.getElementById(id);
    const log = (t)=>{ const L=$('log'); L.textContent = (L.textContent ? L.textContent+'\\n' : '') + t; console.log('[LOG]',t); };
    const show = (id, on)=> $(id).classList.toggle('hidden', !on);
    const sayErr = (m)=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; setTimeout(()=>b.style.display='none', 6000); };

    window.addEventListener('error', e => log('window.error: ' + (e.message||e)));
    window.addEventListener('unhandledrejection', e => log('unhandledrejection: ' + (e.reason && (e.reason.message||e.reason))));

    // ===== Configs =====
    const cfgDB = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const cfgFO = {
      apiKey: "AIzaSyBzwc75u8pG73OKcHN8ti2ADbucjKMHme8",
      authDomain: "fireopssim.firebaseapp.com",
      projectId: "fireopssim",
      storageBucket: "fireopssim.appspot.com"
    };

    // ===== Init apps =====
    const appDB = firebase.initializeApp(cfgDB);                  // [DEFAULT] old DB
    const appFO = firebase.initializeApp(cfgFO, "fireops");       // secondary photos
    const db     = firebase.database(appDB);
    const authDB = firebase.auth(appDB);
    const authFO = firebase.auth(appFO);
    const store  = firebase.storage(appFO);                       // binds to fireopssim.appspot.com

    // Pin to exact bucket + build a root ref
    const GS_BUCKET = 'gs://fireopssim.appspot.com';
    const rootRef = store.refFromURL(GS_BUCKET); // ensures refs always under this bucket

    // Upload behavior
    const REQUIRE_CLOUD_SUCCESS = true; // <— no DB write unless file is in Storage

    // Anonymous auth best-effort (don’t block UI)
    (async function warmupAuth(){
      try{ await authDB.signInAnonymously(); }catch(e){ log('DB anon auth failed: '+(e.code||'')+' '+(e.message||e)); }
      try{ await authFO.signInAnonymously(); }catch(e){ log('FO anon auth failed: '+(e.code||'')+' '+(e.message||e)); }
      log('Auth warmup attempted.');
    })();

    // ===== State =====
    let scenarioId=null, localStops=[];
    let pendingImg=null, pendingFullDataURL=null, pendingThumbDataURL=null, pendingGeo=null;

    function renderGallery(){
      const host=$('gallery'); const empty=$('galleryEmpty');
      host.innerHTML='';
      if(!localStops.length){ empty.textContent='No photos yet.'; show('galleryEmpty', true); return; }
      show('galleryEmpty', false);
      localStops.forEach((s,i)=>{
        const card=document.createElement('div'); card.className='gItem';
        const img=document.createElement('img'); img.src=s.thumbURL||s.imageURL||''; img.alt=s.caption||('Stop '+(i+1));
        const cap=document.createElement('div'); cap.className='gCap';
        cap.textContent=(s.caption||('Stop '+(i+1))) + (s.gsUri?` • ${s.gsUri}`:'');
        card.appendChild(img); card.appendChild(cap); host.appendChild(card);
      });
    }
    function gate(){ show('step2', !!scenarioId); show('galleryCard', !!scenarioId); renderGallery(); }

    // ===== Imaging =====
    const FULL_EDGE=1280, FULL_Q=0.75, THUMB_EDGE=480, THUMB_Q=0.8;
    const readAsDataURL = f => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    const loadImage = src => new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; });
    function downscale(img, maxEdge, q){
      const s = Math.min(1, maxEdge/Math.max(img.width, img.height));
      const c = document.createElement('canvas'); c.width=Math.round(img.width*s); c.height=Math.round(img.height*s);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      return c.toDataURL('image/jpeg', q);
    }
    function dataURLtoBlob(u){ const [h,b64]=u.split(','); const mime=(/data:(.*?);base64/).exec(h)[1]; const bin=atob(b64), a=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) a[i]=bin.charCodeAt(i); return new Blob([a],{type:mime}); }

    // ===== Diagnostics / guards =====
    function withTimeout(promise, ms, label){
      return Promise.race([
        promise,
        new Promise((_,rej)=> setTimeout(()=>rej(new Error(label+' timeout '+ms+'ms')), ms))
      ]);
    }
    function watchUpload(task, which){
      return new Promise((res,rej)=>{
        let lastBytes = -1;
        let stallTimer = setTimeout(()=>{ try{task.cancel();}catch{} rej(new Error('Upload stalled (no progress 12s)')); }, 12000);
        const killer = setTimeout(()=>{ try{task.cancel();}catch{} rej(new Error('Upload hard timeout 240s')); }, 240000);
        task.on('state_changed',
          s=>{
            const pct=Math.round(100*s.bytesTransferred/s.totalBytes);
            if(which==='full'){ $('pctFull').textContent=pct+'%'; $('barFull').style.width=pct+'%'; }
            else { $('pctThumb').textContent=pct+'%'; $('barThumb').style.width=pct+'%'; }
            if (s.bytesTransferred !== lastBytes){
              lastBytes = s.bytesTransferred;
              clearTimeout(stallTimer);
              stallTimer = setTimeout(()=>{ try{task.cancel();}catch{} rej(new Error('Upload stalled (no progress 12s)')); }, 12000);
            }
          },
          e=>{ clearTimeout(stallTimer); clearTimeout(killer); rej(e); },
          ()=>{ clearTimeout(stallTimer); clearTimeout(killer); res(); }
        );
      });
    }

    async function preflightWrite(prefix){
      const diag = rootRef.child(`${prefix}/_diag_${Date.now()}.txt`);
      await withTimeout(diag.putString('ok','raw',{contentType:'text/plain',cacheControl:'public,max-age=60'}), 5000, 'preflight');
      return diag.fullPath;
    }

    // ===== Create Scenario (OLD DB) =====
    async function onCreateScenario(){
      log('Create button clicked.');
      try{
        const title=($('sTitle').value||'').trim();
        if(!title){ $('s1Status').textContent='enter a name'; return; }
        $('s1Status').textContent='creating…';

        const id = db.ref('scenarios').push().key;
        const dispatch=($('sDispatch').value||'').trim();
        const base = { id, title, dispatch, description:dispatch, createdAt: Date.now(), active:true, stops:[] };

        const multi={}; multi[`scenarios/${id}`]=base; multi[`geophoto/scenarios/${id}`]=base;
        await db.ref().update(multi);

        scenarioId=id; localStops=[];
        $('s1Status').textContent='created ✓';
        log('Scenario created: '+id);
        gate();
      }catch(e){
        $('s1Status').textContent='error';
        sayErr(e.message||String(e));
        log('Create scenario error: ' + (e?.message||e));
      }
    }
    window._onCreateScenario = onCreateScenario;

    // ===== Pickers =====
    const open = id => $(id).click();
    function bindPickers(){
      $('btnCamera').addEventListener('click', ()=> open('inCamera'));
      $('btnLibrary').addEventListener('click',()=> open('inLibrary'));
      $('btnUpload').addEventListener('click', ()=> open('inUpload'));
      $('inCamera').addEventListener('change', e=> onPick(e.target.files?.[0]));
      $('inLibrary').addEventListener('change',e=> onPick(e.target.files?.[0]));
      $('inUpload').addEventListener('change', e=> onPick(e.target.files?.[0]));
      $('saveBtn').addEventListener('click', onSavePhoto);
      $('diagBtn').addEventListener('click', diagStorage);
      $('addAnotherBtn').addEventListener('click', resetWork);
      $('resetBtn').addEventListener('click', resetWork);
    }

    async function onPick(file){
      if(!file || !scenarioId) return;
      try{
        const dataURL = await readAsDataURL(file);
        const img = await loadImage(dataURL);
        pendingImg=img;
        pendingFullDataURL  = downscale(img, FULL_EDGE,  FULL_Q);
        pendingThumbDataURL = downscale(img, THUMB_EDGE, THUMB_Q);

        $('previewImg').src = pendingFullDataURL;
        $('imgInfo').textContent = `Original: ${img.width}×${img.height} → Saving ~${Math.round(Math.min(FULL_EDGE, Math.max(img.width,img.height)))} px`;
        show('workArea', true);
        $('saveStatus').textContent='ready';
        $('pctFull').textContent='0%'; $('barFull').style.width='0%';
        $('pctThumb').textContent='0%'; $('barThumb').style.width='0%';

        $('gpsLine').textContent='GPS: acquiring…'; pendingGeo=null;
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            p=>{ pendingGeo={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:Math.round(p.coords.accuracy||0)}; $('gpsLine').textContent=`GPS: ${pendingGeo.lat.toFixed(6)}, ${pendingGeo.lng.toFixed(6)} ±${pendingGeo.accuracy||'–'} m`; },
            _=>{ $('gpsLine').textContent='GPS: unavailable'; },
            {enableHighAccuracy:true,timeout:8000,maximumAge:0}
          );
        }else{$('gpsLine').textContent='GPS: not supported';}
      }catch(e){ sayErr('Could not read image: '+(e.message||e)); }
    }
    function resetWork(){
      pendingImg=pendingFullDataURL=pendingThumbDataURL=null;
      $('previewImg').src=''; show('workArea',false); show('afterSave',false);
      $('pctFull').textContent='0%'; $('barFull').style.width='0%';
      $('pctThumb').textContent='0%'; $('barThumb').style.width='0%';
      $('radius').value='5';
    }

    // ===== Storage upload (NEW bucket, pinned) =====
    async function uploadToFireOps(ts, fullDataURL, thumbDataURL){
      const scenarioPath = `scenarios/${scenarioId}`;
      const fullRef = rootRef.child(`${scenarioPath}/${ts}.jpg`);
      const thmbRef = rootRef.child(`${scenarioPath}/thumbs/${ts}.jpg`);
      const meta    = { contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' };

      log(`→ FireOps upload start
  bucket: fireopssim.appspot.com
  full:   ${fullRef.fullPath}
  thumb:  ${thmbRef.fullPath}`);

      try{
        const pf = await preflightWrite(scenarioPath);
        log('preflight OK ('+pf+')');
      }catch(e){
        log('preflight FAILED → '+(e.code||'')+' '+(e.message||e));
        throw e;
      }

      const t1 = fullRef.put(dataURLtoBlob(fullDataURL), meta);
      await watchUpload(t1,'full');

      const t2 = thmbRef.put(dataURLtoBlob(thumbDataURL), meta);
      await watchUpload(t2,'thumb');

      const imageURL = await withTimeout(fullRef.getDownloadURL(), 10000, 'getDownloadURL(full)');
      const thumbURL = await withTimeout(thmbRef.getDownloadURL().catch(()=>imageURL), 8000, 'getDownloadURL(thumb)');
      log('✓ FireOps upload OK');

      return {
        backend:'fireops',
        imageURL, thumbURL,
        storagePath: fullRef.fullPath,
        gsUri:`gs://fireopssim.appspot.com/${fullRef.fullPath}`
      };
    }

    async function diagStorage(){
      try{
        const id = scenarioId || 'diag';
        const path = `scenarios/${id}/_diag_${Date.now()}.txt`;
        const ref = rootRef.child(path);
        await ref.putString('ok','raw',{contentType:'text/plain',cacheControl:'public,max-age=60'});
        const url = await ref.getDownloadURL();
        log('Diagnostics: preflight/write OK → ' + url);
      }catch(e){
        log('Diagnostics FAILED: ' + (e.code || '') + ' ' + (e.message || e));
        sayErr(e.message||String(e));
      }
    }

    // ===== Append to DB only if cloud succeeded (REQUIRE_CLOUD_SUCCESS) =====
    async function onSavePhoto(){
      if(!(scenarioId && pendingFullDataURL)) return;
      $('saveStatus').textContent='uploading…'; show('afterSave',false);

      const ts = Date.now();
      try{
        const cloud = await uploadToFireOps(ts, pendingFullDataURL, pendingThumbDataURL);

        const r = Math.max(1, Math.min(1000, parseInt(($('radius').value||'5'),10) || 5));
        const stop = {
          type:'photo', title:'', caption:'',
          imageURL: cloud.imageURL || '',
          thumbURL: cloud.thumbURL || '',
          storagePath: cloud.storagePath || '',
          gsUri: cloud.gsUri || '',
          backend: cloud.backend || '',
          lat: pendingGeo?.lat ?? null, lng: pendingGeo?.lng ?? null, accuracy: pendingGeo?.accuracy ?? null,
          radiusMeters:r, overlays:[], at: ts
        };

        await appendStopToDB(stop);
        log(`Stop saved (backend=${stop.backend}) ${stop.gsUri||''}`);
        $('saveStatus').textContent='saved ✓';
        show('afterSave', true);
      }catch(e){
        $('saveStatus').textContent='error';
        log('Cloud write FAILED: ' + (e.code || '') + ' ' + (e.message || e));
        if (REQUIRE_CLOUD_SUCCESS) {
          sayErr('Cloud write failed — nothing was saved. Use "Test Storage" for details (Rules/App Check/Anon Auth).');
        } else {
          sayErr('Cloud write failed — saving inline fallback (not in Storage).');
          // inline fallback (disabled by default; enable by setting REQUIRE_CLOUD_SUCCESS=false)
          const stop = {
            type:'photo', title:'', caption:'',
            imageURL: pendingFullDataURL, thumbURL: pendingThumbDataURL,
            storagePath:'', gsUri:'', backend:'inline-base64',
            lat: pendingGeo?.lat ?? null, lng: pendingGeo?.lng ?? null, accuracy: pendingGeo?.accuracy ?? null,
            radiusMeters: Math.max(1, Math.min(1000, parseInt(($('radius').value||'5'),10) || 5)),
            overlays:[], at: ts
          };
          await appendStopToDB(stop);
          $('saveStatus').textContent='saved (inline)';
          show('afterSave', true);
        }
      }
    }

    async function appendStopToDB(stop){
      let stops=[]; try{ const snap=await db.ref(`scenarios/${scenarioId}/stops`).get(); stops = snap.exists() ? (snap.val()||[]) : []; }catch{}
      stops.push(stop);
      const multi={};
      multi[`scenarios/${scenarioId}/stops`] = stops;
      multi[`geophoto/scenarios/${scenarioId}/stops`] = stops;
      await db.ref().update(multi);
      localStops = stops;
      renderGallery();
    }

    // ===== Bind =====
    document.addEventListener('DOMContentLoaded', ()=>{
      $('createBtn').addEventListener('click', onCreateScenario);
      bindPickers();
      log('Ready. Click "Create Scenario".');
    });

  })();
  </script>
</body>
</html>
