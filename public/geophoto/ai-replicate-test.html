<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI Diagnostic Test</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;background:#0f1115;color:#e5e9f0;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#1a1f2b;border:1px solid #293248;border-radius:12px;padding:16px;margin:12px 0}
  label{display:block;font-size:12px;color:#a7b0c0;margin:0 0 6px}
  input,textarea{width:100%;background:#111827;color:#eef3ff;border:1px solid #2c344a;padding:8px 10px;border-radius:8px}
  textarea{min-height:70px}
  .row{display:flex;gap:10px}
  .row>*{flex:1 1 0}
  .btn{display:inline-flex;background:#22314e;border:1px solid #314266;color:#eaf1ff;padding:10px 14px;border-radius:10px;cursor:pointer;margin-right:8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .imgbox{background:#0b0f18;border:1px solid #25304a;border-radius:10px;padding:10px}
  img{width:100%;height:auto;border-radius:8px}
  pre{white-space:pre-wrap;word-break:break-word;background:#0d1320;border:1px solid #263355;border-radius:8px;padding:10px;max-height:360px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Diagnostic Test</h1>
  <div class="card">
    <div class="row">
      <div>
        <label for="endpoint">Endpoint</label>
        <input id="endpoint" value="/.netlify/functions/ai-image">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label for="imageUrl">Image URL</label>
        <input id="imageUrl" value="https://ff0c942b9653... (paste your full URL here)">
      </div>
      <div>
        <label for="modelVersion">Model Version (optional override)</label>
        <input id="modelVersion" placeholder="leave blank to use env">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label for="prompt">Prompt</label>
        <textarea id="prompt">Make the scene look like it is on fire: realistic flames, smoke, embers, heat haze; keep main structure recognizable.</textarea>
      </div>
      <div>
        <label for="strength">Strength (0â€“1)</label>
        <input id="strength" value="0.45">
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="btn" id="btnPing">Ping</button>
      <button class="btn" id="btnSend">Send</button>
    </div>
  </div>

  <div class="card grid">
    <div class="imgbox">
      <div style="font-size:12px;color:#a7b0c0;margin-bottom:6px">Source</div>
      <img id="src">
    </div>
    <div class="imgbox">
      <div style="font-size:12px;color:#a7b0c0;margin-bottom:6px">Result</div>
      <img id="out">
    </div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#a7b0c0;margin-bottom:6px">Raw JSON</div>
    <pre id="jsonBox"></pre>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  $("src").src = $("imageUrl").value;

  function showJSON(obj){
    $("jsonBox").textContent = JSON.stringify(obj, null, 2);
    // also try to show provider if present
  }

  function normalizeOut(json){
    if (!json) return null;
    if (json.image && typeof json.image.url === "string") return json.image.url;
    if (typeof json.image === "string") return json.image;
    if (typeof json.url === "string") return json.url;
    if (Array.isArray(json.output)) {
      const s = json.output.find(x => typeof x === "string" && /^https?:\/\//i.test(x));
      if (s) return s;
    }
    return null;
  }

  $("btnPing").onclick = async () => {
    const ep = $("endpoint").value.trim();
    const r = await fetch(ep + (ep.includes("?")?"&":"?") + "ping=1");
    const j = await r.json().catch(()=>({status:r.status}));
    showJSON(j);
  };

  $("btnSend").onclick = async () => {
    const ep = $("endpoint").value.trim();
    const payload = {
      image: $("imageUrl").value.trim(),
      prompt: $("prompt").value,
      strength: parseFloat($("strength").value || "0.45") || 0.45
    };
    const mv = $("modelVersion").value.trim();
    if (mv) payload.modelVersion = mv;

    $("src").src = payload.image;

    const r = await fetch(ep, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(payload) });
    let j = null;
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    if (ct.includes("application/json")) j = await r.json().catch(()=>null);
    else j = { status:r.status, text: await r.text().catch(()=>"(no text)") };

    showJSON(j);
    const out = normalizeOut(j);
    if (out) $("out").src = out;
  };
})();
</script>
</body>
</html>
