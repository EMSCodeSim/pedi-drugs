<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM — Advanced Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14;--bg2:#0e1421;--card:#0f1624;--edge:rgba(255,255,255,.05);--edge2:rgba(255,255,255,.08);--glow:rgba(10,132,255,.35);--mutedglow:rgba(10,132,255,.20);--pill:#121a2b;--ok:#1eb980;--warn:#ff9f0a;--bad:#ff453a;--white:#fff;--shadow:rgba(0,0,0,.28);--text:#eaf2ff;--muted:#93a0b5;--blue:#0a84ff; }
    *{box-sizing:border-box}
    html,body{
      margin:0;height:100%;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%)
    }

    .topbar{position:sticky;top:0;z-index:40;background:rgba(12,16,24,.6);backdrop-filter: blur(10px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
    .toprow{display:flex;gap:12px;align-items:center;padding:12px 14px;max-width:1280px;margin:0 auto}
    .title{font-weight:700;letter-spacing:.2px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:var(--pill);border:1px solid var(--edge2);border-radius:999px;padding:6px 10px}
    .pill.small{font-size:12px;padding:4px 8px}
    .btn{background:#132033;border:1px solid var(--edge2);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:var(--mutedglow);box-shadow:0 0 0 3px var(--mutedglow) inset}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;box-shadow:0 8px 30px var(--shadow)}
    .sectionTitle{font-size:14px;letter-spacing:.4px;text-transform:uppercase;color:var(--muted);padding:12px 14px}

    #app{display:grid;grid-template-columns:340px 1fr;gap:16px;max-width:1280px;margin:16px auto;padding:0 14px}
    #app.toolsCollapsed{grid-template-columns:1fr}
    aside{display:flex;flex-direction:column;gap:16px}
    aside .box{padding:12px}

    .input{width:100%;background:#0c1422;border:1px solid var(--edge2);color:var(--text);border-radius:8px;padding:9px 10px}
    .select{appearance:none;background:#0c1422;border:1px solid var(--edge2);color:var(--text);border-radius:8px;padding:9px 10px}

    .canvasWrap{position:relative;overflow:auto;padding:10px}
    canvas{background:#0a0f18;border:1px solid var(--edge2);border-radius:12px;display:block;max-width:100%;box-shadow:0 20px 60px var(--shadow)}

    .thumb{width:110px;height:78px;border-radius:8px;border:1px solid var(--edge2);object-fit:cover}
    .list{display:flex;flex-wrap:wrap;gap:10px;padding:10px}
    .list button{all:unset}
    .list button:focus-visible{outline:2px solid var(--blue);outline-offset:2px;border-radius:10px}

    #loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(3,6,10,.44);backdrop-filter: blur(6px)}
    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.08);border-top-color:var(--blue);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    #errbar{display:none;position:fixed;left:0;right:0;bottom:0;background:#230e10;color:#ffd1d6;border-top:1px solid rgba(255,84,94,.45);padding:12px 14px;font-weight:600}
    a{color:#9cc7ff}
    details{border:1px solid var(--edge2);border-radius:12px;background:#0c1322}
    details>summary{cursor:pointer;font-weight:600;padding:10px 12px}
    details .box{padding:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="toprow">
      <div class="title">FireOps SIM — Advanced Editor</div>
      <div class="row" style="margin-left:auto">
        <button id="toggleTools" class="btn">Hide Tools</button>
        <div class="pill small" id="statusPill">Idle</div>
        <div class="pill small" id="authPill">Auth: …</div>
      </div>
    </div>
  </div>

  <div id="app">
    <aside>
      <details open class="card">
        <summary>Scenario</summary>
        <div class="box col">
          <label>Scenario ID</label>
          <input class="input" id="scenarioId" placeholder="enter or load…" />
          <div class="row">
            <button id="loadBtn" class="btn">Load</button>
            <button id="newBtn" class="btn">New</button>
            <button id="saveBtn" class="btn">Save</button>
            <button id="refreshBtn" class="btn">Refresh</button>
          </div>
        </div>
      </details>

      <details open class="card">
        <summary>AI</summary>
        <div class="box col">
          <label>Return</label>
          <select id="aiReturn" class="select">
            <option value="photo">Composite Photo</option>
          </select>

          <label>Style</label>
          <select id="aiStyle" class="select">
            <option value="realistic">Photo-realistic</option>
            <option value="dramatic">Dramatic</option>
            <option value="training">Training Drill</option>
          </select>

          <label>Scene Notes (optional)</label>
          <textarea id="aiNotes" class="input" placeholder="e.g., light wind from north, 2 occupants, late evening lighting"></textarea>
          <div class="row" style="margin-top:6px">
            <button class="btn" id="aiPreview">Preview Payload</button>
            <button class="btn" id="aiSend">Send to AI</button>
            <button class="btn" id="aiOpen" disabled>Open Result</button>
            <button class="btn" id="aiAdd" disabled>Add as New Stop</button>
          </div>
            <div id="aiMsg" class="pill small" style="margin-top:6px">Idle</div>
          </div>
      </details>
    </aside>

    <section class="col">
      <div class="sectionTitle">Photos in Scenario (click to load in viewer)</div>
      <div class="list" id="photoList"></div>

      <div class="sectionTitle">Canvas</div>
      <div class="card canvasWrap">
        <canvas id="canvas" width="1280" height="720"></canvas>
      </div>
    </section>
  </div>

  <div id="loader"><div class="spinner"></div></div>
  <div id="errbar"></div>

  <script type="module">
    /* ---------- helpers ---------- */
    const $ = (id)=>document.getElementById(id);
    const showErr = (m)=>{ const b=$('errbar'); b.textContent=m; b.style.display='block'; };
    const hideErr = ()=>{ $('errbar').style.display='none'; };
    const showLoad = (on)=>{ $('loader').style.display = on ? 'grid' : 'none'; };
    const status = (msg)=>{ $('statusPill').textContent=msg; };
    const setAuthPill = (t)=>{ $('authPill').textContent = `Auth: ${t}`; };

    $('toggleTools').onclick = ()=>{
      const app = $('app');
      const collapse = !app.classList.contains('toolsCollapsed');
      app.classList.toggle('toolsCollapsed', collapse);
      $('toggleTools').textContent = collapse ? 'Show Tools' : 'Hide Tools';
      fitCanvas();
    };

    // Netlify AI function proxy (see netlify.toml redirects)
    const AI_FN = "/api/ai-image";

    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref as dbRef, get, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getStorage, ref as stRef, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID",
      databaseURL: "YOUR_DB_URL"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    /* ---------- state ---------- */
    let current = null;        // scenario object
    let stopIndex = -1;        // selected stop index
    let baseImage = null;      // fabric base
    let f = null;              // fabric canvas

    /* ---------- fabric setup ---------- */
    import { fabric } from "https://cdn.jsdelivr.net/npm/fabric@6.0.2/dist/fabric.esm.js";
    const EDIT_MAX_EDGE = 1600;
    const EDIT_THUMB_EDGE = 480;
    const EDIT_JPEG_QUALITY = 0.95;

    function fitCanvas(){
      // (your existing sizing code)
    }

    function bboxForObject(o){
      const b = o.getBoundingRect(true, true);
      return { x: Math.round(b.left), y: Math.round(b.top), w: Math.round(b.width), h: Math.round(b.height) };
    }
    function inferCatFromSrc(src){
      const s = src.toLowerCase();
      if (s.includes('fire')) return 'fire';
      if (s.includes('smoke')) return 'smoke';
      if (s.includes('hazard')) return 'hazard';
      if (s.includes('car')) return 'cars';
      if (s.includes('people')||s.includes('person')||s.includes('human')) return 'people';
      return 'generic';
    }

    function serializeOverlaysForAI(){
      return f.getObjects().filter(o => o!==baseImage && !o.isBaseText).map(o=>{
        if (o.type === 'image'){
          const src = o.getSrc ? o.getSrc() : (o._originalElement?.src || o.src || '');
          return {
            kind: 'image',
            category: inferCatFromSrc(src),
            src,
            bbox: bboxForObject(o),
            angle: o.angle||0,
            opacity: o.opacity??1,
            flipX: !!o.flipX,
            flipY: !!o.flipY,
            z: f.getObjects().indexOf(o)
          };
        } else if (o.type === 'textbox'){
          return {
            kind: 'text',
            text: o.text || '',
            bbox: bboxForObject(o),
            angle: o.angle||0,
            opacity: o.opacity??1,
            fontSize: o.fontSize||24,
            color: o.fill||'#fff',
            bg: o.backgroundColor||'rgba(0,0,0,0.6)',
            z: f.getObjects().indexOf(o)
          };
        }
        return null;
      }).filter(Boolean);
    }

    function buildMaskDataURL(){
      const W = Math.round(baseImage?.width  || 0);
      const H = Math.round(baseImage?.height || 0);
      if (!W || !H) throw new Error('No base image loaded.');
      const c = document.createElement('canvas'); c.width = W; c.height = H;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = '#ffffff';
      // Slightly inflate masks (feather) to improve blending
      const feather = 6;
      const overlays = serializeOverlaysForAI();
      for (const o of overlays){
        const { x, y, w, h } = o.bbox;
        ctx.fillRect(Math.max(0,x-feather), Math.max(0,y-feather),
                     Math.min(W-x+feather, w+2*feather), Math.min(H-y+feather, h+2*feather));
      }
      return { dataUrl: c.toDataURL('image/png'), overlays };
    }
    function summarizeOverlayCounts(list){
      const counts = { fire:0, smoke:0, people:0, cars:0, hazard:0, generic:0, text:0 };
      for (const o of list){
        if (o.kind === 'text') counts.text++;
        else counts[o.category || 'generic'] = (counts[o.category || 'generic'] || 0) + 1;
      }
      return counts;
    }
    async function getBaseImageURLForStop(){
      const s = current._stops[stopIndex];
      if (s?.imageURL && /^https?:\/\//i.test(s.imageURL)) return s.imageURL;
      const refStr = s?.storagePath || s?.gsUri;
      if (refStr){
        const ref = stRef(storage, refStr);
        return await getDownloadURL(ref);
      }
      if (s?.imageData?.data){
        return `data:image/${s.imageData.format||'jpeg'};base64,${s.imageData.data}`;
      }
      throw new Error('This stop has no accessible base image.');
    }

    function dataURLFromCanvasScaled(fabricCanvas, maxEdge=EDIT_MAX_EDGE, quality=EDIT_JPEG_QUALITY){
      const raw = fabricCanvas.toDataURL({ format:'jpeg', quality:1 });
      const img = new Image(); img.decoding = 'async'; img.src = raw; await img.decode();
      const w = img.naturalWidth, h = img.naturalHeight;
      const s = Math.min(1, maxEdge / Math.max(w, h));
      const outW = Math.round(w*s), outH = Math.round(h*s);
      const c = document.createElement('canvas'); c.width = outW; c.height = outH;
      const ctx = c.getContext('2d');
      ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, outW, outH);
      return c.toDataURL('image/jpeg', quality);
    }

    async function thumbFromDataURL(dataURL, maxEdge=EDIT_THUMB_EDGE, q=0.8){
      const img = new Image(); img.decoding='async'; img.src = dataURL; await img.decode();
      const s = Math.min(1, maxEdge / Math.max(img.naturalWidth, img.naturalHeight));
      const c = document.createElement('canvas'); c.width = Math.round(img.naturalWidth*s); c.height = Math.round(img.naturalHeight*s);
      const ctx = c.getContext('2d');
      ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, c.width, c.height);
      return c.toDataURL('image/jpeg', q);
    }

    // ====== UPDATED SAVE HELPERS ======
    async function saveAIResultDataUrlToStorage(dataUrl){
      const blob = await (await fetch(dataUrl)).blob();
      const ts = Date.now();
      const path = `scenarios/${current.id}/ai/results/${ts}_stop${stopIndex}.png`;
      const ref = stRef(storage, path);
      await uploadBytes(ref, blob, { contentType: blob.type || 'image/png', cacheControl: 'public,max-age=31536000,immutable' });
      const url = await getDownloadURL(ref);
      $('aiOpen').disabled = false;
      $('aiAdd').disabled  = false;
      $('aiOpen').onclick = ()=> window.open(url, '_blank');
      $('aiAdd').onclick  = ()=> addResultAsNewStop(url);
      $('aiMsg').textContent = 'Result uploaded ✓';
      return url;
    }
    async function saveAIResultUrlToStorage(imageUrl){
      const blob = await (await fetch(imageUrl, { mode:'cors', credentials:'omit', cache:'no-store' })).blob();
      const ts = Date.now();
      const path = `scenarios/${current.id}/ai/results/${ts}_stop${stopIndex}.png`;
      const ref = stRef(storage, path);
      await uploadBytes(ref, blob, { contentType: blob.type || 'image/png', cacheControl: 'public,max-age=31536000,immutable' });
      const url = await getDownloadURL(ref);
      $('aiOpen').disabled = false;
      $('aiAdd').disabled  = false;
      $('aiOpen').onclick = ()=> window.open(url, '_blank');
      $('aiAdd').onclick  = ()=> addResultAsNewStop(url);
      $('aiMsg').textContent = 'Result uploaded ✓';
      return url;
    }

    async function addResultAsNewStop(url){
      if (!current || stopIndex<0) return;
      const base = current._stops[stopIndex];
      const ts = Date.now();
      const newStop = {
        type:'photo',
        title: (base.title||'') + ' (AI)',
        caption: 'AI composite',
        imageURL: url,
        thumbURL: url,
        createdAt: ts
      };
      current._stops.splice(stopIndex+1, 0, newStop);
      stopIndex = stopIndex + 1;
      renderStops();
      await saveScenario();
      $('aiMsg').textContent = 'Added as new stop ✓';
    }

    // ---- your existing scenario load/save/render code remains unchanged ----
    async function saveScenario(){ /* ... your existing function ... */ }
    function renderStops(){ /* ... your existing function ... */ }

    $('aiPreview').onclick = ()=>{
      try{
        const { dataUrl, overlays } = buildMaskDataURL();
        console.log('[AI] mask preview (dataUrl length):', dataUrl.length, 'overlays:', overlays);
        $('aiMsg').textContent = 'Mask + overlay payload logged to console.';
      }catch(e){
        $('aiMsg').textContent = e.message || String(e);
      }
    };

    // ====== UPDATED AI SEND HANDLER ======
    $('aiSend').onclick = async ()=>{
      try{
        if(!current || stopIndex<0) throw new Error('Select a stop first.');

        $('aiMsg').textContent = 'Preparing…';

        const style = $('aiStyle').value;
        const notes = ($('aiNotes').value||'').trim();

        // Build prompt
        const prompt =
          (style === 'dramatic') ? `dramatic emergency scene; ${notes}` :
          (style === 'training') ? `training drill realism; ${notes}` :
                                   `photo-realistic; ${notes || 'make the scene photorealistic; keep layout'}`;

        const strength = 0.35;

        // Check overlays
        const overlays = serializeOverlaysForAI();
        const hasOverlays = overlays && overlays.length > 0;

        let payload;
        if (hasOverlays) {
          $('aiMsg').textContent = 'Compositing…';
          const dataUrl = await dataURLFromCanvasScaled(f, 1600, 0.95);
          payload = { dataUrl, prompt, strength };
        } else {
          $('aiMsg').textContent = 'Preparing guide image…';
          const guideUrl = await getBaseImageURLForStop();
          payload = { guideUrl, prompt, strength };
        }

        $('aiMsg').textContent = 'Contacting AI…';
        const r = await fetch(AI_FN, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const text = await r.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, error:text || `HTTP ${r.status}` }; }

        if (!json?.ok || !json?.image?.url) { $('aiMsg').textContent = `AI error: ${json?.error || 'No image returned.'}`; return; }

        $('aiMsg').textContent = 'Uploading result…';
        await saveAIResultUrlToStorage(json.image.url);
      }catch(e){
        $('aiMsg').textContent = e.message || String(e);
      }
    };

    $('aiAdd').onclick = ()=> $('aiMsg').textContent = 'Open a result first.';

    /* ---------- Refresh / init ---------- */
    $('refreshBtn').onclick = async ()=>{
      // ... your existing refresh logic ...
    };

    // ... rest of your existing script (auth, loading, canvas setup, etc.) ...
  </script>
</body>
</html>
