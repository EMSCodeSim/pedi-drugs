<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FireOps SIM ‚Äî Advanced Editor (modular)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14;--bg2:#0e1421;--card:#0f1624;--edge:rgba(255,255,255,.10); --text:#eaf2ff;--muted:#93a0b5;--blue:#0a84ff; }
    *{box-sizing:border-box}
    html,body{
      margin:0;height:100%;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 15% -15%, rgba(10,132,255,.28), transparent 60%),
        radial-gradient(1200px 600px at 110% 0%, rgba(255,59,48,.22), transparent 60%),
        linear-gradient(165deg, var(--bg2), var(--bg) 55%)
    }

    .topbar{position:sticky;top:0;z-index:40;background:rgba(12,15,22,.78);backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,.08)}
    .topnav{max-width:1300px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
    .brand{font-weight:900}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg,#142238,#0f1930);color:#fff;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    main{max-width:1300px;margin:16px auto 40px;padding:0 16px}
    .app{display:grid;grid-template-columns:360px 1fr;gap:12px;align-items:start}
    .app.toolsCollapsed{grid-template-columns:0 1fr}
    .app.toolsCollapsed #tools{display:none}
    .col{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:12px;min-height:140px}
    #tools{overflow:auto;max-height:calc(100vh - 160px)}
    .hidden{display:none!important}

    label{display:block;margin:8px 0 6px 2px;font-size:12px;color:var(--muted)}
    .input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1322;color:#eaf2ff}
    textarea{min-height:80px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);white-space:nowrap}

    .thumb{width:72px;height:72px;border-radius:8px;border:1px solid rgba(255,255,255,.14);object-fit:cover;background:#0a1a2a;cursor:pointer}
    .thumb.active{outline:3px solid #2dd4bf}
    #thumbRow{display:flex;gap:8px;overflow:auto;padding:8px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:#0a1a2a}

    .canvasWrap{position:relative;border:1px solid rgba(255,255,255,.12);border-radius:12px;overflow:hidden;background:#061621}
    #c{width:100%;height:calc(100vh - 280px);display:block}

    .sectionTitle{font-weight:900;margin:6px 0}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .small{font-size:12px;opacity:.85}
    #errbar{position:fixed;left:10px;bottom:10px;background:#2b0d0d;color:#ffd7d7;border:1px solid #7a2b2b;border-radius:12px;padding:8px 12px;display:none;z-index:9999;white-space:pre-wrap;max-width:92vw}

    #drawer summary{cursor:pointer;list-style:none;padding:8px 10px;border:1px solid rgba(255,255,255,.14);border-radius:10px;background:#0c1528;font-weight:800}
    #drawer[open] summary{background:#0e1a30}

    #loader{ position:fixed; inset:0; display:none; place-items:center; z-index:99; background:rgba(6,12,20,.55); backdrop-filter:blur(2px) }
    .spinner{ width:42px; height:42px; border-radius:999px; border:4px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <div id="errbar"></div>
  <div id="loader"><div class="spinner"></div></div>

  <div class="topbar">
    <div class="topnav">
      <div class="brand">FireOps SIM ‚Äî Advanced Editor</div>
      <div class="spacer"></div>
      <span id="authPill" class="pill">Auth: connecting‚Ä¶</span>
      <button id="toggleTools" class="btn">Hide Tools</button>
    </div>
  </div>

  <main>
    <div class="app" id="app">
      <aside class="col" id="tools">
        <details id="drawer" open>
          <summary>Editing Tools (collapse/expand)</summary>
          <div style="margin-top:10px">
            <div class="sectionTitle">Scenario</div>
            <label>Choose scenario</label>
            <select id="scenarioSel"><option value="">Select scenario‚Ä¶</option></select>
            <div class="row" style="margin-top:6px">
              <button class="btn" id="refreshBtn">Refresh</button>
              <button class="btn" id="deleteScenario" style="background:#2a0f14;border-color:#7a2b2b">Delete Scenario</button>
              <span id="statusPill" class="pill">Loading‚Ä¶</span>
              <span id="rootPill" class="pill small">root: ‚Ä¶</span>
            </div>

            <div class="divider"></div>
            <div class="sectionTitle">Stop meta</div>
            <label>Title</label><input class="input" id="stopTitle" />
            <label>Caption</label><textarea id="stopCaption"></textarea>
            <div class="row">
              <div style="flex:1"><label>Latitude</label><input class="input" id="stopLat" /></div>
              <div style="flex:1"><label>Longitude</label><input class="input" id="stopLng" /></div>
            </div>
            <label>Radius (meters)</label><input class="input" id="stopRadius" value="50" />
            <div class="row" style="margin-top:6px">
              <button class="btn" id="useGPS">Use my location</button>
              <button class="btn" id="saveMeta">Save Meta</button>
            </div>
            <div id="metaMsg" class="pill small" style="margin-top:6px">Ready</div>

            <div class="divider"></div>
            <div class="sectionTitle">Overlays</div>
            <div class="row" style="gap:6px; flex-wrap:nowrap; overflow:auto">
              <button class="btn" id="brushFire" data-cat="fire">üî• Fire</button>
              <button class="btn" id="brushSmoke" data-cat="smoke">üå´Ô∏è Smoke</button>
              <button class="btn" data-cat="people">üßç People</button>
              <button class="btn" data-cat="cars">üöó Cars</button>
              <button class="btn" data-cat="hazard">‚ö†Ô∏è Hazard</button>
            </div>
            <div id="overlayShelf" style="margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>

            <div class="divider"></div>
            <div class="sectionTitle">Brush / Stamps</div>
            <div class="row">
              <button class="btn" id="brushErase">üßΩ Erase Stamps</button>
              <button class="btn" id="brushOff">‚úñ Off</button>
            </div>
            <label>Brush Size <span id="brushSizeReadout" class="pill" style="margin-left:6px">120 px</span></label>
            <input id="brushSize" type="range" min="24" max="320" step="4" value="120" />

            <div class="divider"></div>
            <div class="sectionTitle">Text on Photo</div>
            <div class="row"><button class="btn" id="addTextbox">+ Add Text Box</button></div>
            <label>Selected Text</label><textarea id="tbContent" placeholder="Type notes‚Ä¶"></textarea>
            <label>Font Size</label><input id="tbFont" type="range" min="12" max="72" step="1" value="24" />
            <label>Background Opacity</label><input id="tbBgOpacity" type="range" min="0" max="1" step="0.05" value="0.6" />
            <div class="row" style="margin-top:6px">
              <button class="btn" id="tbApply">Apply</button>
              <button class="btn" id="tbDelete" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
            </div>

            <div class="divider"></div>
            <div class="sectionTitle">Selected Overlay</div>
            <div class="row">
              <button class="btn" id="flipSelH">Flip H</button>
              <button class="btn" id="flipSelV">Flip V</button>
              <button class="btn" id="bringFront">Bring Front</button>
              <button class="btn" id="sendBack">Send Back</button>
              <button class="btn" id="deleteObj" style="background:#2a0f14;border-color:#7a2b2b">Delete</button>
            </div>

            <div class="divider"></div>
            <div class="sectionTitle">Export / Save</div>
            <div class="row">
              <button class="btn" id="exportPNG">Export PNG/JPEG</button>
              <button class="btn" id="saveImage">Save Image to Cloud</button>
            </div>

            <!-- AI Generate (beta) -->
            <div class="divider"></div>
            <div class="sectionTitle">AI Generate (beta)</div>
            <label>Return</label>
            <select id="aiReturn" class="input">
              <option value="photo">Composite Photo</option>
              <option value="overlays">Overlays Only (PNG)</option>
            </select>
            <label>Style</label>
            <select id="aiStyle" class="input">
              <option value="realistic">Photo-realistic</option>
              <option value="dramatic">Dramatic Incident</option>
              <option value="training">Training Drill</option>
            </select>
            <label>Scene Notes (optional)</label>
            <textarea id="aiNotes" class="input" placeholder="e.g., light wind from north, 2 occupants, late evening lighting"></textarea>
            <div class="row" style="margin-top:6px">
              <button class="btn" id="aiPreview">Preview Payload</button>
              <button class="btn" id="aiSend">Send to AI</button>
              <button class="btn" id="aiOpen" disabled>Open Result</button>
              <button class="btn" id="aiAdd" disabled>Add as New Stop</button>
            </div>
            <div id="aiMsg" class="pill small" style="margin-top:6px">Idle</div>
          </div>
        </details>
      </aside>

      <section class="col">
        <div class="sectionTitle">Photos in Scenario (click to load in viewer)</div>
        <div id="thumbRow"></div>

        <div class="row" style="margin:10px 0">
          <button class="btn" id="fit">Fit</button>
          <button class="btn" id="zoomIn">Zoom +</button>
          <button class="btn" id="zoomOut">Zoom ‚àí</button>
          <button class="btn" id="rotateL">Rotate ‚ü≥</button>
          <button class="btn" id="rotateR">Rotate ‚ü≤</button>
          <span class="pill" id="canvasInfo">Canvas</span>
        </div>

        <div class="canvasWrap"><canvas id="c"></canvas></div>
      </section>
    </div>
  </main>

  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous"></script>

  <!-- App modules -->
  <script type="module">
    import { initFirebase, getStorageInfo } from "./firebase-core.js";
    import { wireScenarioUI, bootScenarios } from "./scenarios.js";
    import { wireAI } from "./ai-upload.js";

    // Init Firebase core (locked bucket) and wire everything
    initFirebase("dailyquiz-d5279.appspot.com");
    wireScenarioUI();
    wireAI();
    bootScenarios();
  </script>
</body>
</html>
