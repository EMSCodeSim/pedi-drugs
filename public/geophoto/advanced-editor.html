<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Advanced Photo Editor — FireOps SIM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --panel:#171923; --text:#e6e6e6; --muted:#a4a8b3; --accent:#6aa3ff; --edge:#232634; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .app { display:grid; grid-template-columns: 320px 1fr 380px; height:100%; }

    /* Left: Scenario panel */
    .left { background:var(--panel); border-right:1px solid var(--edge); padding:14px; overflow:auto; }
    h1,h2 { margin:0 0 10px; font-size:16px; color:#fff; }
    h2 { font-size:14px; color:#dfe7ff; margin-top:14px; }
    label { display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    select,input[type="text"],textarea {
      width:100%; background:#131621; color:#e8e8e8; border:1px solid #272b3a;
      padding:8px 10px; border-radius:8px; outline:none;
    }
    textarea { min-height:72px; resize:vertical; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:6px;
      background:#1f2534; color:#e8f0ff; border:1px solid #2b3246; padding:8px 10px;
      border-radius:10px; cursor:pointer; margin:3px 2px; }
    .btn:hover { background:#252c40; }
    .btn[disabled] { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:6px; margin-bottom:8px; }
    .row > * { flex:1 1 0; }

    .thumbs { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
    .thumb { border:1px solid #2b3246; background:#0c0f16; border-radius:8px; overflow:hidden;
      cursor:pointer; position:relative; }
    .thumb img { width:100%; height:100%; display:block; object-fit:cover; aspect-ratio: 4/3; }
    .thumb .cap { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,.7));
      color:#dfe7ff; font-size:11px; padding:24px 6px 6px; }
    .thumb.active { outline:2px solid var(--accent); }

    /* Center: Canvas/viewer */
    .center { display:flex; align-items:center; justify-content:center; background:#0b0e14; position:relative; }
    #mainCanvas { width: min(98%, 1400px); height: auto; max-height: 96%; background:#0a0d13; border-radius:12px; border:1px solid var(--edge); }

    /* Right: AI panel */
    .right { background:var(--panel); border-left:1px solid var(--edge); padding:14px; overflow:auto; }
    .status { margin-top:8px; font-size:12px; color:#b9c3d9; min-height:1.4em; }
    .sep { height:1px; background:#262a38; margin:14px 0; }

    .pill { font-size:11px; color:#9fb0ff; opacity:.95; border:1px solid #2b3246; padding:4px 8px; border-radius:999px; display:inline-block; margin-left:6px; }
  </style>
</head>
<body>
  <div class="app">

    <!-- SCENARIOS PANEL -->
    <aside class="left">
      <h1>
        Scenarios
        <span id="authPill" class="pill">auth: …</span>
        <span id="fbPill" class="pill">bucket: …</span>
      </h1>

      <div class="row">
        <select id="scenarioSelect" title="Pick a scenario"></select>
        <button class="btn" id="scenarioRefresh" title="Refresh scenario list">⟳</button>
      </div>

      <div class="row">
        <button class="btn" id="scenarioLoadImgs">Load Images</button>
        <button class="btn" id="scenarioPrev">◀ Prev</button>
        <button class="btn" id="scenarioNext">Next ▶</button>
      </div>

      <label for="scenarioName">Scenario name</label>
      <input id="scenarioName" type="text" placeholder="Untitled scenario" />

      <h2>Storage Settings</h2>
      <label for="basePath">Base path in Storage (folders under this are scenarios)</label>
      <input id="basePath" type="text" value="geophoto/" />
      <div class="row">
        <button class="btn" id="btnSetBase">Use Path</button>
        <button class="btn" id="btnSetupFirebase">Override Config</button>
      </div>

      <h2>Slides / Photos</h2>
      <div id="thumbs" class="thumbs"></div>

      <!-- hidden file inputs -->
      <input type="file" id="fileImages" accept="image/*" multiple style="display:none" />
      <input type="file" id="fileJson" accept="application/json" style="display:none" />
    </aside>

    <!-- VIEWER -->
    <main class="center">
      <canvas id="mainCanvas" width="1600" height="900"></canvas>
    </main>

    <!-- AI PANEL (unchanged placeholder) -->
    <aside class="right">
      <h1>AI Controls</h1>
      <div class="status" id="aiMsg">Ready</div>
      <div class="sep"></div>
      <label>Endpoint (optional override)</label>
      <input id="aiEndpoint" type="text" placeholder="/.netlify/functions/ai-image" />
      <div class="row">
        <button class="btn" type="button" id="btnUseEndpoint">Use Endpoint</button>
        <button class="btn" type="button" id="btnResetEndpoint">Reset</button>
      </div>
    </aside>

  </div>

  <!-- Firebase compat SDKs (match Viewer) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
  <!-- App Check (enable if Enforcement is ON) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>

  <script>
  (function(){
    // ---------- Elements ----------
    const $ = id => document.getElementById(id);
    const sel = $('scenarioSelect'), thumbsEl = $('thumbs'), canvas = $('mainCanvas');
    const ctx = canvas.getContext('2d');
    const aiMsg = $('aiMsg'), authPill = $('authPill'), fbPill = $('fbPill');

    // ---------- Firebase Config (mirrors Viewer) ----------
    // You can override by defining window.FIREBASE_CONFIG before this script or via the "Override Config" button.
    const DEFAULT_CONFIG = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.firebasestorage.app",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    // Always talk to the real bucket when building gs:// refs:
    const FORCE_BUCKET = "dailyquiz-d5279.appspot.com";

    // In-page override saved per-origin:
    const saved = localStorage.getItem('fbConfig');
    const cfg = window.FIREBASE_CONFIG || (saved ? JSON.parse(saved) : DEFAULT_CONFIG);
    firebase.initializeApp(cfg);
    // self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; // DEV only if needed
    // firebase.appCheck().activate('YOUR_RECAPTCHA_V3_SITE_KEY', true);

    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // ---------- Auth (same flow as Viewer) ----------
    async function ensureAuthed(){
      return new Promise((resolve,reject)=>{
        const unsub = auth.onAuthStateChanged(u=>{
          if(u){
            authPill.textContent = `auth: anon ✓ ${u.uid.slice(0,8)}`;
            unsub(); resolve(u);
          }else{
            auth.signInAnonymously().catch(e=>{
              authPill.textContent = `auth: failed (${e.code||e.message})`;
              unsub(); reject(e);
            });
          }
        });
      });
    }

    // ---------- Helpers copied/adapted from Viewer ----------
    // Normalize any storage URL/path into a gs:// ref string
    function toStorageRefString(v){
      if(!v) return ''; let s=(v+'').trim(); try{s=decodeURIComponent(s);}catch{}
      if(s.startsWith('gs://')) return s;
      let m=s.match(/^https?:\/\/firebasestorage\.googleapis\.com\/v0\/b\/([^/]+)\/o\/([^?]+)/i); if(m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      m=s.match(/^https?:\/\/([^/]+)\.firebasestorage\.app\/o\/([^?]+)/i); if(m) return `gs://${m[1]}/${m[2].replace(/\+/g,' ')}`;
      if(!/^https?:\/\//i.test(s)) return `gs://${FORCE_BUCKET}/${s}`;
      return '';
    }
    function storageRefAt(path){
      const p = (path||'').replace(/^\/+/,'');
      return storage.refFromURL(`gs://${FORCE_BUCKET}/${p}`);
    }
    async function getDownloadURLSafe(itemRef) {
      try { return await itemRef.getDownloadURL(); }
      catch(e){ console.warn('getDownloadURL failed for', itemRef.fullPath, e); return null; }
    }
    async function listAllImagesRecursive(ref, acc = []) {
      const res = await ref.listAll();
      for (const item of res.items) {
        const nameLc = item.name.toLowerCase();
        if (/\.(png|jpg|jpeg|webp|gif)$/i.test(nameLc)) acc.push(item);
      }
      for (const p of res.prefixes) await listAllImagesRecursive(p, acc);
      return acc;
    }

    // ---------- Scenario listing ----------
    const basePathInput = $('basePath');
    function ensureSlash(p){ return p ? (p.endsWith('/') ? p : p + '/') : ''; }

    async function listStorageScenarioFolders(basePath){
      const baseRef = storageRefAt(ensureSlash(basePath));
      const res = await baseRef.listAll();
      return res.prefixes || [];
    }

    async function refreshScenarioList(){
      $('scenarioSelect').innerHTML = '<option disabled>Loading…</option>';
      const base = ensureSlash(basePathInput.value.trim() || 'geophoto/');
      localStorage.setItem('geophoto_basePath', base);

      try{
        // Prefer Storage folders (the editor works on images)
        const prefixes = await listStorageScenarioFolders(base);
        sel.innerHTML = '';
        if (!prefixes.length){
          const o=document.createElement('option'); o.value=''; o.textContent='(no scenario folders found)'; sel.appendChild(o);
        }else{
          for (const pref of prefixes){
            const full = pref.fullPath;
            const name = full.replace(/\/$/,'').split('/').pop();
            const o=document.createElement('option'); o.value=full; o.textContent=name; sel.appendChild(o);
          }
          sel.selectedIndex = 0;
          $('scenarioName').value = sel.options[0].textContent || '';
        }
      }catch(e){
        console.error('Scenario list error:', e);
        sel.innerHTML = '';
        const o=document.createElement('option'); o.value=''; o.textContent='(error listing folders)'; sel.appendChild(o);
      }
    }

    // ---------- Load images for the selected scenario ----------
    let images=[], currentIndex=-1;
    function clearThumbs(){ thumbsEl.innerHTML = ''; }
    function setActiveThumb(idx){ [...thumbsEl.children].forEach((c,i)=>c.classList.toggle('active', i===idx)); }

    async function loadScenarioImages(){
      const path = sel.value;
      if(!path){ aiMsg.textContent='No scenario selected.'; return; }

      aiMsg.textContent = 'Loading images…';
      clearThumbs(); images=[]; currentIndex=-1;

      try{
        const scenRef = storageRefAt(ensureSlash(path));
        const items = await listAllImagesRecursive(scenRef);
        if (!items.length){ aiMsg.textContent='No images found in scenario.'; return; }

        let i=0;
        for (const item of items){
          const url = await getDownloadURLSafe(item); if(!url) continue;
          const obj = { name:item.name, path:item.fullPath, url };
          images.push(obj);

          const div = document.createElement('div'); div.className='thumb'; div.title=item.fullPath;
          div.addEventListener('click', ()=>selectImage(i));
          const img = document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.src=url;
          const cap = document.createElement('div'); cap.className='cap'; cap.textContent=item.name;
          div.appendChild(img); div.appendChild(cap); thumbsEl.appendChild(div);
          i++;
        }
        if (images.length) selectImage(0);
        aiMsg.textContent = `Loaded ${images.length} image(s).`;
      }catch(e){
        console.error('Load images error:', e);
        aiMsg.textContent = `Failed to list images: ${e.code||e.message}`;
      }
    }

    function selectImage(idx){
      if (idx<0 || idx>=images.length) return;
      currentIndex = idx; setActiveThumb(idx);
      drawToCanvas(images[idx].url);
    }
    function drawToCanvas(url){
      const img = new Image();
      img.onload = () => {
        ctx.fillStyle = '#0a0d13'; ctx.fillRect(0,0,canvas.width,canvas.height);
        const cw=canvas.width, ch=canvas.height, iw=img.naturalWidth, ih=img.naturalHeight;
        const s = Math.min(cw/iw, ch/ih), dw=Math.round(iw*s), dh=Math.round(ih*s);
        const dx=Math.round((cw-dw)/2), dy=Math.round((ch-dh)/2);
        ctx.drawImage(img, dx, dy, dw, dh);
      };
      img.onerror = () => console.warn('Failed to load image', url);
      img.crossOrigin = 'anonymous';
      img.src = url;
    }

    // ---------- UI wiring ----------
    $('scenarioRefresh').addEventListener('click', refreshScenarioList);
    $('scenarioLoadImgs').addEventListener('click', loadScenarioImages);
    $('scenarioPrev').addEventListener('click', ()=>{ if (images.length) selectImage((currentIndex-1+images.length)%images.length); });
    $('scenarioNext').addEventListener('click', ()=>{ if (images.length) selectImage((currentIndex+1)%images.length); });
    $('btnSetBase').addEventListener('click', refreshScenarioList);
    sel.addEventListener('change', (e)=>{ $('scenarioName').value = e.target.selectedOptions[0]?.textContent || ''; });

    // Endpoint toggles (kept)
    $('btnUseEndpoint').addEventListener('click', ()=>{
      const v = $('aiEndpoint').value.trim();
      if(!v){ delete window.__AI_ENDPOINTS__; aiMsg.textContent='Cleared custom endpoint'; return; }
      window.__AI_ENDPOINTS__=[v]; aiMsg.textContent='Using custom endpoint: '+v;
    });
    $('btnResetEndpoint').addEventListener('click', ()=>{
      delete window.__AI_ENDPOINTS__;
      aiMsg.textContent='Using default endpoints';
    });

    // Allow overriding Firebase config at runtime (saved per-origin)
    $('btnSetupFirebase').addEventListener('click', ()=>{
      const example = JSON.stringify(DEFAULT_CONFIG, null, 2);
      const txt = prompt('Paste Firebase Web Config JSON to override (saved for this domain):', example);
      if (!txt) return;
      try{
        const newCfg = JSON.parse(txt);
        localStorage.setItem('fbConfig', JSON.stringify(newCfg));
        alert('Saved. Reloading to apply…');
        location.reload();
      }catch(e){ alert('Invalid JSON, not saved.'); }
    });

    // ---------- Boot ----------
    (async ()=>{
      try{
        await ensureAuthed();
        authPill.title = `db: ${cfg.databaseURL||'(none)'}`;
        fbPill.textContent = `bucket: ${FORCE_BUCKET}`;
        // Load saved base path
        const savedBase = localStorage.getItem('geophoto_basePath');
        if (savedBase) $('basePath').value = savedBase;
        await refreshScenarioList();
      }catch(e){
        authPill.textContent = 'auth: failed';
        aiMsg.textContent = `Auth failed: ${e.code||e.message}`;
      }
    })();

  })();
  </script>
</body>
</html>
