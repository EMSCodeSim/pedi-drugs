<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Advanced Photo Editor (Scenarios)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #07131c; --panel: #0b2130; --muted: #a9bac6; --accent: #2da3ff;
      --text: #e8f2f9; --border: rgba(255,255,255,0.12); --pill: rgba(255,255,255,0.12);
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .app{padding:12px}
    .topbar{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:var(--pill);padding:6px 10px;border-radius:999px}
    .pill.small{font-size:12px;padding:4px 8px}
    .btn,button{background:#123044;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:340px 1fr;gap:12px}
    .toolsCollapsed .grid{grid-template-columns:1fr}
    .col{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;min-height:200px;position:relative}
    .block{border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{display:block;margin:2px 0 6px;font-weight:600}
    input[type="text"],input[type="number"],select,textarea{
      width:100%;background:#0f2738;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px}
    textarea{min-height:70px}
    .thumb-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;border:2px solid transparent;background:#092033}
    .thumb.active{border-color:var(--accent)}
    .shelf{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .btn-row{display:flex;gap:6px;flex-wrap:wrap}
    #errbar{display:none;background:#2b0a0a;border:1px solid #4a1515;color:#ffdede;padding:8px 10px;border-radius:8px;margin-bottom:10px}
    #loader{display:none;position:absolute;inset:0;background:rgba(3,8,12,0.55);place-items:center;border-radius:12px}
    .viewer-wrap{position:relative}
    .spinner{width:36px;height:36px;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #c{width:100%;height:640px;display:block;background:#061621;border-radius:8px;border:1px solid var(--border)}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
</head>
<body>
  <div id="app" class="app">
    <div class="topbar">
      <span id="authPill" class="pill">Auth: ‚Ä¶</span>
      <span id="statusPill" class="pill">Idle</span>
      <span id="rootPill" class="pill">root: ‚Ä¶</span>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="toggleTools" class="btn">Hide Tools</button>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="col">
        <div class="block">
          <label for="scenarioSel">Scenario</label>
          <div class="row">
            <select id="scenarioSel" style="flex:1 1 auto"></select>
            <button id="deleteScenario" class="btn" style="background:#331616;border-color:#5b2424;">Delete</button>
          </div>
        </div>

        <div id="thumbRow" class="thumb-row"></div>

        <div id="tools" class="block">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">Overlays</h3>
            <div class="btn-row">
              <button class="btn" data-cat="fire">Fire</button>
              <button class="btn" data-cat="smoke">Smoke</button>
              <button class="btn" data-cat="people">People</button>
              <button class="btn" data-cat="cars">Cars</button>
              <button class="btn" data-cat="hazard">Hazard</button>
            </div>
          </div>
          <div id="overlayShelf" class="shelf"></div>

          <hr style="border:none;border-top:1px solid var(--border);margin:10px 0;"/>

          <h3 style="margin:0 0 6px;">Brush</h3>
          <div class="btn-row">
            <button id="brushFire" class="btn">üî• Fire</button>
            <button id="brushSmoke" class="btn">üí® Smoke</button>
            <button id="brushErase" class="btn">‚ùå Erase</button>
            <button id="brushOff" class="btn">‚úã Off</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <label for="brushSize" style="margin:0;">Size</label>
            <input type="range" id="brushSize" min="40" max="300" value="120" style="flex:1 1 auto;">
            <span id="brushSizeReadout" class="pill small">120 px</span>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:10px 0;"/>

          <h3 style="margin:0 0 6px;">Text</h3>
          <div class="btn-row">
            <button id="addTextbox" class="btn">+ Text Box</button>
            <button id="tbApply" class="btn">Apply</button>
            <button id="tbDelete" class="btn" style="background:#331616;border-color:#5b2424;">Delete</button>
          </div>
          <div class="two-col" style="margin-top:6px;">
            <textarea id="tbContent" placeholder="Text‚Ä¶"></textarea>
            <div>
              <label>Font size</label>
              <input id="tbFont" type="number" value="24" />
              <label>BG opacity (0‚Äì1)</label>
              <input id="tbBgOpacity" type="text" value="0.6" />
            </div>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:10px 0;"/>

          <h3 style="margin:0 0 6px;">Selection</h3>
          <div class="btn-row">
            <button id="bringFront" class="btn">Bring Front</button>
            <button id="sendBack" class="btn">Send Back</button>
            <button id="flipSelH" class="btn">Flip H</button>
            <button id="flipSelV" class="btn">Flip V</button>
            <button id="deleteObj" class="btn" style="background:#331616;border-color:#5b2424;">Delete</button>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:10px 0;"/>

          <h3 style="margin:0 0 6px;">Export & Save</h3>
          <div class="btn-row">
            <button id="exportPNG" class="btn">Export JPEG</button>
            <button id="saveImage" class="btn">Save to Cloud</button>
          </div>
        </div>

        <div class="block">
          <h3 style="margin:0 0 6px;">Meta</h3>
          <label>Title</label>
          <input id="stopTitle" type="text" placeholder="Title‚Ä¶" />
          <label>Caption</label>
          <input id="stopCaption" type="text" placeholder="Caption‚Ä¶" />
          <div class="two-col">
            <div>
              <label>Lat</label>
              <input id="stopLat" type="text" />
            </div>
            <div>
              <label>Lng</label>
              <input id="stopLng" type="text" />
            </div>
          </div>
          <label>Radius (m)</label>
          <input id="stopRadius" type="number" min="5" max="1000" value="50" />
          <div class="btn-row" style="margin-top:6px;">
            <button id="useGPS" class="btn">Use GPS</button>
            <button id="saveMeta" class="btn">Save Meta</button>
            <span id="metaMsg" class="muted"></span>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="col viewer">
        <div id="errbar"></div>
        <div class="viewer-wrap">
          <div id="loader"><div class="spinner"></div></div>
          <canvas id="c" width="1600" height="900"></canvas>
        </div>
        <div class="row" style="margin-top:6px;">
          <span class="pill small">Canvas:</span>
          <span id="canvasInfo" class="muted">‚Äî</span>
          <span style="flex:1 1 auto;"></span>
          <div class="btn-row">
            <button id="fit" class="btn">Fit</button>
            <button id="zoomIn" class="btn">Ôºã</button>
            <button id="zoomOut" class="btn">Ôºç</button>
            <button id="rotateL" class="btn">‚ü≤</button>
            <button id="rotateR" class="btn">‚ü≥</button>
          </div>
        </div>

        <div class="block">
          <h3 style="margin:0 0 6px;">AI</h3>
          <div class="two-col">
            <div>
              <label>Return</label>
              <select id="aiReturn">
                <option value="photo">Photo</option>
                <option value="overlays">Overlays PNG</option>
              </select>
            </div>
            <div>
              <label>Style</label>
              <select id="aiStyle">
                <option value="realistic">Realistic</option>
                <option value="dramatic">Dramatic</option>
                <option value="training">Training</option>
              </select>
            </div>
          </div>
          <label>Notes</label>
          <textarea id="aiNotes" placeholder="Describe changes, emphasis, constraints‚Ä¶"></textarea>
          <div class="btn-row" style="margin-top:6px;">
            <button id="aiPreview" class="btn">Preview</button>
            <button id="aiSend" class="btn" style="background:#123c59;">Send to AI</button>
            <button id="aiOpen" class="btn" disabled>Open Result</button>
            <button id="aiAdd" class="btn" disabled>Add as Stop</button>
          </div>
          <div id="aiMsg" class="muted" style="margin-top:6px;">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fabric.js -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <!-- Robust module boot -->
  <script type="module">
    (async () => {
      const showErr = (msg) => {
        const b = document.getElementById('errbar');
        if (b) { b.style.display = 'block'; b.textContent = msg; }
        console.error(msg);
      };

      // Generate path candidates from current location
      const here = new URL('.', location.href);          // same dir
      const parent = new URL('..', location.href);       // parent dir
      const root = new URL('/', location.href);          // site root
      // Common subfolder on your domain based on your error path:
      const geo = new URL('/geophoto/', location.href);  // /geophoto/

      const bases = [here, parent, root, geo];
      const names = [
        'scenarios.js',
        'scenarios%20(1).js',
        'scenarios (1).js'
      ];

      async function tryImport(paths) {
        let lastErr = null;
        for (const p of paths) {
          try {
            // quick preflight to catch 404/HTML
            const res = await fetch(p + (p.includes('?') ? '' : `?v=${Date.now()}`), { cache: 'no-store' });
            if (!res.ok) { console.warn('[boot] 404', p); continue; }
            const ct = res.headers.get('content-type') || '';
            if (!/javascript|ecmascript|text\/plain/i.test(ct)) {
              console.warn('[boot] wrong MIME', ct, 'for', p);
              // still attempt to import; some hosts mislabel as text/plain
            }
            const mod = await import(p + (p.includes('?') ? '' : `?v=${Date.now()}`));
            console.log('[boot] imported', p);
            return { mod, path: p };
          } catch (e) {
            lastErr = e;
            console.warn('[boot] import failed', p, e);
          }
        }
        throw lastErr || new Error('No module found');
      }

      // Build all candidate paths
      const scenarioPaths = [];
      for (const b of bases) {
        for (const n of names) {
          scenarioPaths.push(new URL(n, b).href);
        }
        // Also try a js/ subfolder under each base
        for (const n of names) {
          scenarioPaths.push(new URL('js/' + n, b).href);
        }
      }

      let scenariosMod, usedScenarioPath;
      try {
        const res = await tryImport(scenarioPaths);
        scenariosMod = res.mod;
        usedScenarioPath = res.path;
      } catch (e) {
        showErr('Could not import scenarios module. Last error: ' + (e?.message || String(e)));
        return;
      }

      const { wireScenarioUI, bootScenarios } = scenariosMod;
      if (typeof wireScenarioUI !== 'function' || typeof bootScenarios !== 'function') {
        showErr(`Module loaded from "${usedScenarioPath}" but missing exports wireScenarioUI/bootScenarios.`);
        return;
      }

      // ai-upload
      const aiNames = ['ai-upload.js', 'js/ai-upload.js'];
      const aiPaths = [].concat(
        ...[here, parent, root, geo].map(base => aiNames.map(n => new URL(n, base).href))
      );
      let aiMod;
      try {
        aiMod = (await tryImport(aiPaths)).mod;
      } catch (e) {
        showErr('Failed to import ai-upload.js: ' + (e?.message || String(e)));
        return;
      }
      if (typeof aiMod.wireAI !== 'function') {
        showErr('ai-upload.js loaded but missing wireAI() export.');
        return;
      }

      // firebase-core (optional preflight to surface path errors early)
      const fbNames = ['firebase-core.js', 'js/firebase-core.js'];
      const fbPaths = [].concat(
        ...[here, parent, root, geo].map(base => fbNames.map(n => new URL(n, base).href))
      );
      try {
        await tryImport(fbPaths);
      } catch (e) {
        showErr('Failed to import firebase-core.js: ' + (e?.message || String(e)));
        return;
      }

      // Boot
      try {
        await bootScenarios();
        wireScenarioUI();
        aiMod.wireAI();
      } catch (e) {
        showErr('Boot failed: ' + (e?.message || String(e)));
      }
    })();
  </script>
</body>
</html>
