<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Advanced Photo Editor — FireOps SIM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --panel:#171923; --text:#e6e6e6; --muted:#a4a8b3; --accent:#6aa3ff; --edge:#232634; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .app { display:grid; grid-template-columns: 320px 1fr 380px; height:100%; }

    /* Left: Scenario panel */
    .left { background:var(--panel); border-right:1px solid var(--edge); padding:14px; overflow:auto; }
    h1,h2 { margin:0 0 10px; font-size:16px; color:#fff; }
    h2 { font-size:14px; color:#dfe7ff; margin-top:14px; }
    label { display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    select,input[type="text"],textarea {
      width:100%; background:#131621; color:#e8e8e8; border:1px solid #272b3a;
      padding:8px 10px; border-radius:8px; outline:none;
    }
    textarea { min-height:72px; resize:vertical; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:6px;
      background:#1f2534; color:#e8f0ff; border:1px solid #2b3246; padding:8px 10px;
      border-radius:10px; cursor:pointer; margin:3px 2px; }
    .btn:hover { background:#252c40; }
    .btn[disabled] { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:6px; margin-bottom:8px; }
    .row > * { flex:1 1 0; }

    .thumbs { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
    .thumb { border:1px solid #2b3246; background:#0c0f16; border-radius:8px; overflow:hidden;
      cursor:pointer; position:relative; }
    .thumb img { width:100%; height:100%; display:block; object-fit:cover; aspect-ratio: 4/3; }
    .thumb .cap { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,.7));
      color:#dfe7ff; font-size:11px; padding:24px 6px 6px; }
    .thumb.active { outline:2px solid var(--accent); }

    /* Center: Canvas/viewer */
    .center { display:flex; align-items:center; justify-content:center; background:#0b0e14; position:relative; }
    #mainCanvas { width: min(98%, 1400px); height: auto; max-height: 96%; background:#0a0d13; border-radius:12px; border:1px solid var(--edge); }

    /* Right: placeholder panel (AI controls area if you want later) */
    .right { background:var(--panel); border-left:1px solid var(--edge); padding:14px; overflow:auto; }
    .status { margin-top:8px; font-size:12px; color:#b9c3d9; min-height:1.4em; }
    .sep { height:1px; background:#262a38; margin:14px 0; }
    .pill { font-size:11px; color:#9fb0ff; opacity:.95; border:1px solid #2b3246; padding:4px 8px; border-radius:999px; display:inline-block; margin-left:6px; }
  </style>
</head>
<body>
  <div class="app">

    <!-- SCENARIOS PANEL -->
    <aside class="left">
      <h1>
        Scenarios
        <span id="authPill" class="pill">auth: …</span>
        <span id="fbPill" class="pill">bucket: …</span>
      </h1>

      <div class="row">
        <select id="scenarioSelect" title="Pick a scenario"></select>
        <button class="btn" id="scenarioRefresh" title="Refresh scenario list">⟳</button>
      </div>

      <div class="row">
        <button class="btn" id="scenarioLoadImgs">Load Images</button>
        <button class="btn" id="scenarioPrev">◀ Prev</button>
        <button class="btn" id="scenarioNext">Next ▶</button>
      </div>

      <label for="scenarioName">Scenario name</label>
      <input id="scenarioName" type="text" placeholder="Untitled scenario" />

      <h2>Storage Settings</h2>
      <label for="basePath">Base path in Storage (folders under this are scenarios)</label>
      <input id="basePath" type="text" value="geophoto/" />
      <div class="row">
        <button class="btn" id="btnSetBase">Use Path</button>
        <button class="btn" id="btnSetupFirebase">Override Config</button>
      </div>

      <h2>Slides / Photos</h2>
      <div id="thumbs" class="thumbs"></div>

      <!-- hidden file inputs (kept for future use) -->
      <input type="file" id="fileImages" accept="image/*" multiple style="display:none" />
      <input type="file" id="fileJson" accept="application/json" style="display:none" />
    </aside>

    <!-- VIEWER -->
    <main class="center">
      <canvas id="mainCanvas" width="1600" height="900"></canvas>
    </main>

    <!-- RIGHT PANEL (placeholder for AI controls) -->
    <aside class="right">
      <h1>Panel</h1>
      <div class="status" id="aiMsg">Ready</div>
      <div class="sep"></div>
      <p>If you need the AI endpoints back in here later, we can add them. For now this is focused on loading photos from Firebase.</p>
    </aside>

  </div>

  <!-- Firebase (module SDK) -->
  <script type="module">
    // --- Firebase SDK (v10 modular) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getStorage, ref as stRef, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // ---------- DOM ----------
    const $ = (id) => document.getElementById(id);
    const sel = $("scenarioSelect"), thumbsEl = $("thumbs"), canvas = $("mainCanvas");
    const ctx = canvas.getContext("2d");
    const aiMsg = $("aiMsg"), authPill = $("authPill"), fbPill = $("fbPill");
    const basePathInput = $("basePath");

    // ---------- Config ----------
    // If window.FIREBASE_CONFIG is defined earlier on the page, it will override.
    const DEFAULT_CONFIG = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      projectId:"dailyquiz-d5279",
      // IMPORTANT: Storage must target the .appspot.com bucket (not .firebasestorage.app)
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db"
    };
    // Allow local override (saved per-domain if you click "Override Config")
    const savedCfg = (() => { try { return JSON.parse(localStorage.getItem("fbConfig") || "null"); } catch { return null; } })();
    const cfg = window.FIREBASE_CONFIG || savedCfg || DEFAULT_CONFIG;

    // Force using the correct bucket (some consoles show .firebasestorage.app)
    const FORCE_BUCKET_GS = "gs://dailyquiz-d5279.appspot.com";

    // ---------- Firebase init + auth ----------
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const storage = getStorage(app, FORCE_BUCKET_GS); // explicitly bind to the appspot bucket

    function setMsg(t){ aiMsg && (aiMsg.textContent = t); }

    async function ensureAuthed(){
      return new Promise((resolve,reject)=>{
        const unsub = onAuthStateChanged(auth, (u)=>{
          if(u){ authPill.textContent = "auth: anon ✓ " + u.uid.slice(0,8); unsub(); resolve(u); }
          else { signInAnonymously(auth).catch(err=>{ authPill.textContent="auth: failed"; unsub(); reject(err); }); }
        });
      });
    }

    // ---------- Helpers ----------
    const ensureSlash = (p) => p ? (p.endsWith("/") ? p : p + "/") : "";

    async function listStorageScenarioFolders(basePath){
      const baseRef = stRef(storage, ensureSlash(basePath));
      const res = await listAll(baseRef);   // { prefixes, items }
      return res.prefixes || [];
    }

    async function refreshScenarioList(){
      sel.innerHTML = '<option disabled>Loading…</option>';
      const base = ensureSlash((basePathInput?.value || localStorage.getItem("geophoto_basePath") || "geophoto/").trim());
      basePathInput.value = base;
      localStorage.setItem("geophoto_basePath", base);

      try{
        const prefixes = await listStorageScenarioFolders(base);
        sel.innerHTML = "";
        if (!prefixes.length){
          const o=document.createElement('option'); o.value=''; o.textContent='(no scenario folders found)'; sel.appendChild(o);
          setMsg("No scenario folders under "+base);
          return;
        }
        for (const pref of prefixes){
          const o=document.createElement('option');
          o.value = pref.fullPath;                 // e.g. "geophoto/house_01/"
          o.textContent = pref.name || pref.fullPath.replace(/\/$/,'').split('/').pop();
          sel.appendChild(o);
        }
        sel.selectedIndex = 0;
        $("scenarioName").value = sel.options[0]?.textContent || "";
        setMsg("Connected ✓ scenarios listed.");
      }catch(e){
        console.warn("Scenario list error:", e);
        sel.innerHTML = "";
        const o=document.createElement('option'); o.value=''; o.textContent='(error listing folders)'; sel.appendChild(o);
        setMsg("Listing error: " + (e.code || e.message));
      }
    }

    let images=[], currentIndex=-1;
    function clearThumbs(){ thumbsEl.innerHTML = ''; }
    function setActiveThumb(idx){ [...thumbsEl.children].forEach((c,i)=>c.classList.toggle('active', i===idx)); }

    async function listAllImagesRecursive(dirRef, acc = []) {
      const { prefixes, items } = await listAll(dirRef);
      for (const it of items) {
        const name = it.name.toLowerCase();
        if (/\.(png|jpe?g|webp|gif)$/i.test(name)) acc.push(it);
      }
      for (const sub of prefixes) await listAllImagesRecursive(sub, acc);
      return acc;
    }

    async function loadScenarioImages(){
      const path = sel.value;
      if(!path){ setMsg('No scenario selected.'); return; }

      setMsg('Loading images…');
      clearThumbs(); images=[]; currentIndex=-1;

      try{
        const scenRef = stRef(storage, ensureSlash(path));
        const items = await listAllImagesRecursive(scenRef);
        if (!items.length){ setMsg('No images found in scenario.'); return; }

        let i=0;
        for (const it of items){
          const url = await getDownloadURL(it);
          const obj = { name: it.name, path: it.fullPath, url };
          images.push(obj);

          const div = document.createElement('div'); div.className = 'thumb'; div.title = it.fullPath;
          div.addEventListener('click', ()=>selectImage(i));
          const img = document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.src=url;
          const cap = document.createElement('div'); cap.className='cap'; cap.textContent=it.name;
          div.appendChild(img); div.appendChild(cap); thumbsEl.appendChild(div);
          i++;
        }
        if (images.length) selectImage(0);
        setMsg(`Loaded ${images.length} image(s).`);
      }catch(e){
        console.warn('Load images error:', e);
        setMsg(`Failed to list images: ${e.code||e.message}`);
      }
    }

    function selectImage(idx){
      if (idx<0 || idx>=images.length) return;
      currentIndex = idx; setActiveThumb(idx);
      drawToCanvas(images[idx].url);
    }
    function drawToCanvas(url){
      const img = new Image();
      img.onload = () => {
        ctx.fillStyle = '#0a0d13'; ctx.fillRect(0,0,canvas.width,canvas.height);
        const cw=canvas.width, ch=canvas.height, iw=img.naturalWidth, ih=img.naturalHeight;
        const s = Math.min(cw/iw, ch/ih), dw=Math.round(iw*s), dh=Math.round(ih*s);
        const dx=Math.round((cw-dw)/2), dy=Math.round((ch-dh)/2);
        ctx.drawImage(img, dx, dy, dw, dh);
      };
      img.onerror = () => console.warn('Failed to load image', url);
      img.crossOrigin = 'anonymous';
      img.src = url;
    }

    // ---------- UI wiring ----------
    $("scenarioRefresh").addEventListener('click', refreshScenarioList);
    $("scenarioLoadImgs").addEventListener('click', loadScenarioImages);
    $("scenarioPrev").addEventListener('click', ()=>{ if (images.length) selectImage((currentIndex-1+images.length)%images.length); });
    $("scenarioNext").addEventListener('click', ()=>{ if (images.length) selectImage((currentIndex+1)%images.length); });
    $("btnSetBase").addEventListener('click', refreshScenarioList);
    sel.addEventListener('change', (e)=>{ $("scenarioName").value = e.target.selectedOptions[0]?.textContent || ''; });

    // Allow overriding Firebase config at runtime (saved per-origin)
    $("btnSetupFirebase").addEventListener('click', ()=>{
      const example = JSON.stringify(DEFAULT_CONFIG, null, 2);
      const txt = prompt('Paste Firebase Web Config JSON to override (saved for this domain):', example);
      if (!txt) return;
      try{
        const newCfg = JSON.parse(txt);
        localStorage.setItem('fbConfig', JSON.stringify(newCfg));
        alert('Saved. Reloading to apply…');
        location.reload();
      }catch(e){ alert('Invalid JSON, not saved.'); }
    });

    // ---------- Boot ----------
    (async ()=>{
      try{
        await ensureAuthed();
        if (fbPill) fbPill.textContent = 'bucket: dailyquiz-d5279.appspot.com';
        // Load saved base path
        const savedBase = localStorage.getItem('geophoto_basePath');
        if (savedBase) $("basePath").value = savedBase;
        await refreshScenarioList();
      }catch(e){
        authPill.textContent = 'auth: failed';
        setMsg(`Auth failed: ${e.code||e.message}`);
      }
    })();
  </script>
</body>
</html>
