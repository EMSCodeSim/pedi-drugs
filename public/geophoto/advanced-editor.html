<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Advanced Editor — Storage-only Scenarios + AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0a0f14; --panel:#0f1720; --ink:#e6edf3; --muted:#9fb0c0; --pill:#1b2836; --accent:#2e7dd7; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--ink); font:14px/1.4 system-ui, sans-serif; }
    #app { display:grid; grid-template-columns: 280px 1fr 320px; grid-template-rows:auto 1fr auto; gap:10px; height:100vh; padding:10px; }
    header, aside, main, section, footer { background:var(--panel); border-radius:12px; }
    header, footer { padding:8px 12px; display:flex; align-items:center; gap:8px; }
    header .pill, footer .pill { background:var(--pill); border-radius:999px; padding:4px 10px; color:var(--muted); }
    #left { padding:10px; display:flex; flex-direction:column; gap:10px; min-width:0; }
    #right { padding:10px; display:flex; flex-direction:column; gap:12px; min-width:0; }
    #center { display:grid; grid-template-rows: 1fr auto; min-width:0; }
    #stageWrap { position:relative; display:grid; place-items:center; padding:8px; overflow:hidden; }
    #stage { width:100%; height:100%; display:grid; place-items:center; overflow:hidden; }
    canvas { background:#061621; border-radius:10px; width:100%; height:100%; }
    #canvasInfo { color:var(--muted); padding:8px; text-align:center; }
    h3 { margin:0 0 8px 0; font-size:13px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase; }
    label { display:block; margin:6px 0 3px; color:var(--muted); font-size:12px; }
    input[type="text"], input[type="number"], select, textarea {
      width:100%; box-sizing:border-box; border:1px solid #1e2a36; background:#0c121a; color:#dfe7ee;
      padding:8px; border-radius:8px; outline:none;
    }
    textarea { min-height:90px; resize:vertical; }
    button { background:#153055; color:#eaf2fb; border:none; border-radius:10px; padding:10px 12px; cursor:pointer; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:8px; align-items:center; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .pill.small { font-size:12px; padding:3px 8px; }
    #thumbRow { display:grid; grid-template-columns: repeat(auto-fill, 84px); gap:8px; overflow:auto; max-height:40vh; }
    #thumbRow img.thumb { width:84px; height:84px; object-fit:cover; border-radius:8px; opacity:.85; border:2px solid transparent; background:#000; }
    #thumbRow img.thumb.active { border-color: var(--accent); opacity:1; }
    #errbar { display:none; background:#3a1010; color:#ffd7d7; padding:8px 10px; border-radius:8px; margin:6px 0; }
    #loader { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:10; }
    #loader .box { background:#0f1720; padding:14px 18px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.4); }
    #app.toolsCollapsed #left, #app.toolsCollapsed #right { display:none; }
    #app.toolsCollapsed { grid-template-columns: 1fr; }
    .muted { color:var(--muted); }
    .toolRow { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #debug { background:#0b1218; border:1px solid #1b2633; border-radius:8px; padding:8px; max-height:160px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    #debug b { color:#a7d3ff; }
    #debug .fail { color:#ffb3b3; }
    #debug .ok { color:#a7ffb3; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <button id="toggleTools" title="Hide/Show side panels">Hide Tools</button>
    <div class="pill" id="authPill">Auth: …</div>
    <div class="pill" id="statusPill">Booting…</div>
    <div class="pill" id="rootPill">root: —</div>
  </header>

  <!-- Left: Scenario list & thumbs -->
  <aside id="left">
    <div id="errbar"></div>

    <div class="row">
      <h3 style="flex:1">Scenarios (Storage)</h3>
      <button id="refreshBtn" title="Reload Storage">Refresh</button>
    </div>
    <select id="scenarioSel"></select>

    <div class="stack">
      <h3>Photos / Slides</h3>
      <div id="thumbRow"></div>
    </div>

    <div class="stack">
      <h3>Stop Meta</h3>
      <label>Title</label>
      <input id="stopTitle" type="text" placeholder="e.g., Front approach" />
      <label>Caption</label>
      <input id="stopCaption" type="text" placeholder="optional" />
      <div class="row">
        <div style="flex:1">
          <label>Lat</label>
          <input id="stopLat" type="text" inputmode="decimal" />
        </div>
        <div style="flex:1">
          <label>Lng</label>
          <input id="stopLng" type="text" inputmode="decimal" />
        </div>
      </div>
      <label>Radius (m)</label>
      <input id="stopRadius" type="number" min="5" max="1000" step="5" value="50" />
      <div class="row">
        <button id="useGPS">Use GPS</button>
        <button id="saveMeta">Save Meta</button>
        <button id="deleteScenario" style="margin-left:auto;background:#4a1a1a">Delete Scenario</button>
      </div>
      <div id="metaMsg" class="muted"></div>
    </div>
  </aside>

  <!-- Center: Canvas -->
  <main id="center">
    <div id="stageWrap">
      <div id="stage">
        <canvas id="c" width="1580" height="900"></canvas>
      </div>
      <div id="loader"><div class="box">Loading…</div></div>
    </div>
    <div id="canvasInfo">Canvas ready.</div>
  </main>

  <!-- Right: AI + simple tools -->
  <section id="right">
    <div class="stack">
      <h3>AI (img→img)</h3>
      <label for="aiReturn">Return</label>
      <select id="aiReturn">
        <option value="photo" selected>Photo (composited)</option>
        <option value="overlays">Overlays Only (transparent)</option>
      </select>

      <label for="aiStyle">Style</label>
      <select id="aiStyle">
        <option value="realistic" selected>Realistic</option>
        <option value="cinematic">Cinematic</option>
        <option value="dramatic">Dramatic</option>
        <option value="documentation">Documentation</option>
      </select>

      <label for="aiStrength">Strength (0.0–1.0)</label>
      <input id="aiStrength" type="number" step="0.05" min="0" max="1" value="0.35" />

      <label for="aiNotes">Notes / prompt (optional)</label>
      <textarea id="aiNotes" placeholder="Describe smoke, fire, people, vehicles, time of day, etc."></textarea>

      <div class="row">
        <button id="aiPreview" title="Show payload summary">Preview</button>
        <button id="aiSend">Send to AI</button>
        <button id="aiOpen" disabled>Open Result</button>
        <button id="aiAdd" disabled>Add as New Stop</button>
      </div>
      <div id="aiMsg" class="muted">AI idle.</div>
    </div>

    <div class="stack">
      <h3>Overlays</h3>
      <div id="overlayShelf"></div>
    </div>

    <div class="stack">
      <h3>Brush / Select</h3>
      <div class="toolRow">
        <label>Brush</label><input id="brushSize" type="range" min="1" max="60" value="10" />
        <label>Eraser</label><input id="eraserSize" type="range" min="4" max="80" value="24" />
        <button id="panMode">Pan/Select</button>
        <button id="addText">Add Text</button>
        <button id="deleteSel">Delete Selected</button>
      </div>
    </div>

    <div class="stack">
      <h3>Export</h3>
      <div class="row">
        <button id="exportPNG" disabled>Export PNG</button>
        <button id="saveImage" disabled>Save to Cloud</button>
      </div>
      <div class="muted">Export/save are disabled if the base image is cross-origin tainted; AI still works via guide URL.</div>
    </div>

    <div class="stack">
      <h3>Debug</h3>
      <div id="debug">Booting…</div>
    </div>
  </section>

  <footer>
    <div class="pill small">Tip: Click a thumbnail to load the photo/slide.</div>
    <div class="pill small">Storage-only: use Refresh after you add/remove folders.</div>
  </footer>
</div>

<!-- Fabric -->
<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<!-- Robust module boot -->
<script type="module">
  const errbar = document.getElementById("errbar");
  const statusPill = document.getElementById("statusPill");
  const debug = document.getElementById("debug");
  const setStatus = (t) => { if (statusPill) statusPill.textContent = t; console.log("[boot]", t); };
  const logDbg = (html) => { if (!debug) return; debug.insertAdjacentHTML("beforeend", "<div>"+html+"</div>"); };

  function showError(e) {
    if (!errbar) return;
    errbar.style.display = "block";
    errbar.textContent = (e && (e.message || e)) || String(e);
    console.error(e);
  }

  // Try direct dynamic import (some hosts reject HEAD or lie about status)
  async function tryImport(url) {
    try {
      const mod = await import(url);
      logDbg(`<span class="ok">✓ import</span> <b>${url}</b>`);
      return mod;
    } catch (e) {
      logDbg(`<span class="fail">✗ import</span> <b>${url}</b> — ${e?.message || e}`);
      return null;
    }
  }

  async function importFirst(candidateUrls) {
    for (const u of candidateUrls) {
      const mod = await tryImport(u);
      if (mod) return mod;
    }
    throw new Error("Could not import any of:\n" + candidateUrls.join("\n"));
  }

  // Build a broad set of candidates for both modules
  function buildCandidates(baseNames) {
    const dirs = [
      "./",                 // same folder
      "../",                // parent
      "./geophoto/",        // common folder name used
      "../geophoto/",       // parent/geophoto
      "/",                  // site root (if hosted at root)
      "/geophoto/"          // site root/geophoto
    ];
    const names = [];
    for (const b of baseNames) {
      names.push(`${b}.js`);
      names.push(`${b} (3).js`);
      names.push(`${b} (2).js`);
      names.push(`${b} (1).js`);
      names.push(`${b}.legacy.js`);
    }
    // Add URL-encoded versions for space variants
    const namesEncoded = names.map(n => n.replaceAll(" ", "%20"));
    const allNames = [...new Set([...names, ...namesEncoded])];

    const out = [];
    for (const d of dirs) for (const n of allNames) out.push(d + n);
    // Add cache-busters
    const ts = Date.now();
    return out.map(u => u + `?v=${ts}`);
  }

  window.addEventListener("DOMContentLoaded", async () => {
    try {
      debug.textContent = "Resolving modules…";
      setStatus("Resolving modules…");

      // 1) firebase-core.js must exist somewhere
      const coreCandidates = buildCandidates(["firebase-core"]);
      logDbg("<b>firebase-core candidates:</b>");
      coreCandidates.forEach(u => logDbg(u));

      const core = await importFirst(coreCandidates);
      if (!core || typeof core.initFirebase !== "function") {
        throw new Error("firebase-core loaded but initFirebase() is missing.");
      }
      await core.initFirebase();
      setStatus("Firebase ready");

      // 2) scenarios.js — your loader
      const scnCandidates = buildCandidates(["scenarios", "scenarios-ui"]);
      logDbg("<b>scenarios candidates:</b>");
      scnCandidates.forEach(u => logDbg(u));

      const SCNmod = await importFirst(scnCandidates);
      const SCN = SCNmod.default || SCNmod;

      if (!SCN || !SCN.bootScenarios || !SCN.wireScenarioUI) {
        throw new Error("scenarios module loaded but expected exports are missing (bootScenarios/wireScenarioUI).");
      }

      SCN.wireScenarioUI();
      setStatus("Booting scenarios…");
      await SCN.bootScenarios();
      setStatus("Ready");
      logDbg("<b class='ok'>✓ scenarios booted</b>");
    } catch (e) {
      showError(e);
      setStatus("Failed to boot");
      logDbg(`<span class="fail"><b>BOOT FAILED:</b> ${e?.message || e}</span>`);
      logDbg("<div class='muted'>Fix: place <b>firebase-core.js</b> and <b>scenarios.js</b> next to this HTML or rename your existing files to those names.</div>");
    }

    // 3) AI uploader (optional)
    const aiCandidates = buildCandidates(["ai-upload"]);
    logDbg("<b>ai-upload candidates:</b>");
    aiCandidates.forEach(u => logDbg(u));
    for (const ai of aiCandidates) {
      const ok = await tryImport(ai);
      if (ok) break;
    }
  });

  // UI chrome
  document.getElementById("toggleTools").onclick = function(){
    const app = document.getElementById("app");
    const collapse = !app.classList.contains("toolsCollapsed");
    app.classList.toggle("toolsCollapsed", collapse);
    this.textContent = collapse ? "Show Tools" : "Hide Tools";
  };
</script>
</body>
</html>
