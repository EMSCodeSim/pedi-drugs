<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="/" />
<title>FireOpsSim — Scenario Builder</title>
<style>
  :root{--bg:#0b1220;--card:#111a2e;--muted:#b8c4e2;--line:#1b2b50;--ink:#e8eefc;--accent:#2c5cff;--ok:#7CFF7C;--bad:#FF7C7C}
  *{box-sizing:border-box}
  body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Arial}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:8px 10px}
  input.mono,.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  button{cursor:pointer}
  button.primary{background:#1a3fbb;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
  .muted{color:var(--muted);opacity:.95}
  #status{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:10px;max-height:320px;overflow:auto}
  #stops{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
  .stop{background:#0b1429;border:1px solid #1a2b50;border-radius:12px;overflow:hidden}
  .stop img{width:100%;height:160px;object-fit:cover;display:block}
  .stop .meta{padding:8px;font-size:12px}
  a{color:#9ec5ff}
  iframe#uploaderFrame{width:100%;height:520px;border:0;background:#0b1220;border-radius:12px}
</style>
</head>
<body>
  <h1>FireOpsSim — Scenario Builder</h1>

  <div class="card">
    <div class="row">
      <div class="muted">DB:</div><div class="mono">dailyquiz-d5279 (Realtime DB)</div>
      <div class="muted">Uploader:</div><div class="mono">test-edit-uploader.html (FireOpsSim Storage)</div>
    </div>

    <!-- Create a Scenario -->
    <div class="row">
      <label class="muted">Title</label>
      <input id="title" placeholder="e.g., House Fire — Elm St." style="min-width:280px">
      <label class="muted">Dispatch</label>
      <input id="dispatch" placeholder="Engine 1, Engine 2…" style="min-width:280px">
      <button id="btnCreate" class="primary">Create Scenario</button>
      <span id="createStatus" class="muted">idle</span>
    </div>

    <div class="row">
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="(auto-generated)" style="min-width:360px" readonly>
      <button id="btnCopyId">Copy ID</button>
      <button id="btnUpload" class="primary">Upload Photo</button>
    </div>

    <div class="muted">
      After the uploader saves a photo to <span class="mono">gs://fireopssim.appspot.com</span>, this page records the
      <span class="mono">storagePath</span>, URL, and GPS in Realtime DB under
      <span class="mono">/scenarios/&lt;id&gt;/stops</span> and <span class="mono">/geophoto/scenarios/&lt;id&gt;/stops</span>.
    </div>
  </div>

  <!-- Embedded uploader iframe -->
  <div class="card">
    <strong>Camera Uploader</strong>
    <div class="muted">This iframe hosts your working <span class="mono">test-edit-uploader.html</span>.</div>
    <iframe id="uploaderFrame" src="test-edit-uploader.html"></iframe>
  </div>

  <div class="card">
    <strong>Status</strong>
    <div id="status">Booting…</div>
  </div>

  <div class="card">
    <strong>Stops (live from Realtime DB)</strong>
    <div id="stops"><div class="muted">None yet.</div></div>
  </div>

  <!-- Firebase compat (Realtime DB only here) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const logEl = $('status');
    const log = (m,c)=>{const d=document.createElement('div'); if(c)d.style.color=c; d.textContent='['+new Date().toLocaleTimeString()+'] '+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; console.log(m);};
    const ok  = m=>log(m,'#7CFF7C');
    const bad = m=>log(m,'#FF7C7C');

    // ---------- Realtime DB Config ----------
    const cfgDB = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const app = firebase.initializeApp(cfgDB);            
    const db  = firebase.database(app);
    const auth= firebase.auth(app);

    auth.onAuthStateChanged(u=>log('[DB AUTH] '+(u?('uid='+u.uid):'no user')));

    async function signInDB(){
      if (!auth.currentUser){
        const cred = await auth.signInAnonymously();
        ok('DB auth OK (uid='+(cred.user && cred.user.uid || 'unknown')+')');
      }
    }

    let scenarioId = null;

    async function createScenario(){
      try{
        await signInDB();
        $('createStatus').textContent='creating…';
        const title = ($('title').value||'').trim();
        const dispatch = ($('dispatch').value||'').trim();

        const id = db.ref('scenarios').push().key;
        const base = { id, title: title||id, dispatch, description:dispatch, createdAt: Date.now(), active:true, stops:[] };

        const multi = {};
        multi[`scenarios/${id}`] = base;
        multi[`geophoto/scenarios/${id}`] = base;
        await db.ref().update(multi);

        scenarioId = id;
        $('scenarioId').value = id;
        $('createStatus').textContent='created ✓';
        ok('Scenario created: ' + id);

        if (uploaderReady) postToUploader({ type:"fo-set-scenario", scenarioId: id });
        subscribeStops();
      }catch(e){
        $('createStatus').textContent='error';
        bad('Create scenario error: ' + (e.code||'') + ' ' + (e.message||e));
      }
    }

    function subscribeStops(){
      if (!scenarioId) return;
      db.ref(`scenarios/${scenarioId}/stops`).on('value', snap=>{
        const stops = snap.val() || [];
        renderStops(stops);
      });
    }

    function renderStops(stops){
      const box = $('stops');
      box.innerHTML='';
      if (!stops.length){ box.innerHTML='<div class="muted">None yet.</div>'; return; }
      stops.forEach(s=>{
        const div=document.createElement('div'); div.className='stop';
        if (s.imageURL){ const img=new Image(); img.src=s.imageURL; div.appendChild(img); }
        const meta=document.createElement('div'); meta.className='meta mono';
        const gps = s.gps ? `GPS: ${Number(s.gps.lat).toFixed(5)}, ${Number(s.gps.lng).toFixed(5)}${s.gps.acc?` (±${s.gps.acc}m)`:''}` : 'GPS: n/a';
        meta.innerHTML = `
          <div>${s.storagePath || '(no storagePath)'} </div>
          <div>${gps}</div>
          <div>${new Date(s.at||Date.now()).toLocaleString()}</div>`;
        div.appendChild(meta);
        box.appendChild(div);
      });
    }

    // ---------- Embedded uploader logic ----------
    const TRUSTED_ORIGIN = location.origin;            
    const frame = $('uploaderFrame');
    let uploaderReady = false;
    const reqs = new Map();
    const uuid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

    function postToUploader(payload){
      if (!frame.contentWindow) throw new Error("uploader not available");
      frame.contentWindow.postMessage(payload, TRUSTED_ORIGIN);
    }

    window.addEventListener('message', async (ev)=>{
      if (ev.origin !== TRUSTED_ORIGIN) return;
      const msg = ev.data || {};

      if (msg.type === 'fo-ready'){
        uploaderReady = true;
        ok('Uploader ready.');
        if (scenarioId) postToUploader({ type:'fo-set-scenario', scenarioId });
        return;
      }

      if (msg.type === 'fo-upload-complete'){
        try{
          if (!scenarioId || msg.scenarioId !== scenarioId){
            bad('Upload for different scenario ('+msg.scenarioId+')'); return;
          }
          await saveStopToDB(msg);
          ok('Photo recorded in DB.');
        }catch(e){
          bad('Save error: ' + (e.code||'') + ' ' + (e.message||e));
        }
        return;
      }

      if (msg.type === 'fo-rpc-res' || msg.type === 'fo-rpc-err'){
        const entry = reqs.get(msg.correlationId);
        if (!entry) return;
        clearTimeout(entry.timeout);
        reqs.delete(msg.correlationId);
        if (msg.type === 'fo-rpc-res') entry.resolve(msg.result);
        else entry.reject(new Error(msg.error || 'uploader error'));
      }
    });

    function callUploader(method, params, { timeoutMs=120000 }={}){
      return new Promise((resolve, reject)=>{
        const correlationId = uuid();
        const timeout = setTimeout(()=>{
          reqs.delete(correlationId);
          reject(new Error('uploader-timeout: '+method));
        }, timeoutMs);
        reqs.set(correlationId, {resolve, reject, timeout});
        postToUploader({ type:'fo-rpc', method, params, correlationId });
      });
    }

    async function saveStopToDB(payload){
      const sid = payload.scenarioId;
      const snap = await db.ref(`scenarios/${sid}/stops`).get();
      const arr  = snap.exists()? (snap.val()||[]) : [];
      arr.push({
        type:'photo',
        imageURL: payload.url,
        thumbURL: payload.url,
        storagePath: payload.fullPath,
        gsUri: payload.gsUri,
        gps: payload.gps || null,
        backend:'fireops',
        at: Date.now(),
        radiusMeters:5,
        overlays:[]
      });
      const multi={};
      multi[`scenarios/${sid}/stops`] = arr;
      multi[`geophoto/scenarios/${sid}/stops`] = arr;
      await db.ref().update(multi);
    }

    async function startUpload(){
      try{
        if (!uploaderReady) throw new Error('Uploader not ready yet');
        if (!scenarioId) throw new Error('Create a scenario first');

        postToUploader({ type:'fo-set-scenario', scenarioId });

        const res = await callUploader('captureAndUpload', { scenarioId });
        await saveStopToDB(res);
        ok('Upload saved.');
      }catch(e){
        bad('Upload sequence failed: ' + (e.message||e));
        alert((e && e.message) || String(e));
      }
    }

    // ---------- Wire up ----------
    $('btnCreate').addEventListener('click', createScenario);
    $('btnCopyId').addEventListener('click', async ()=>{
      if(!$('scenarioId').value) return;
      try{ await navigator.clipboard.writeText($('scenarioId').value); ok('Scenario ID copied.'); }catch{}
    });
    $('btnUpload').addEventListener('click', startUpload);

    (async function(){
      log('Booting…');
      try{ await signInDB(); }catch(e){ bad('DB auth failed: '+(e.message||e)); }
      ok('Ready. Create a scenario, then click “Upload Photo”.');
    })();
  })();
  </script>
</body>
</html>
