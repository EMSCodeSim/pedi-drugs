<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FireOpsSim — Scenario Builder (Step 1)</title>
<style>
  :root{--bg:#0b1220;--card:#111a2e;--muted:#b8c4e2;--line:#1b2b50;--ink:#e8eefc;--accent:#2c5cff;--ok:#7CFF7C;--bad:#FF7C7C}
  *{box-sizing:border-box}
  body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Arial}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:10px 12px}
  input.mono,.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  input{min-width:280px}
  button{cursor:pointer}
  button.primary{background:#1a3fbb;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
  .muted{color:var(--muted);opacity:.95}
  #status{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:10px;max-height:320px;overflow:auto}
  a{color:#9ec5ff}
  /* Phone-friendly */
  @media (max-width:560px){
    .row{flex-direction:column;align-items:stretch}
    input,button{width:100%}
  }
</style>
</head>
<body>
  <h1>FireOpsSim — Scenario Builder</h1>

  <div class="card">
    <div class="row">
      <div class="muted">DB:</div><div class="mono">dailyquiz-d5279 (Realtime DB)</div>
      <div class="muted">Next step:</div><div class="mono">test-edit-uploader (photo capture/upload)</div>
    </div>

    <!-- Step 1: Create Scenario (name + dispatch only) -->
    <div class="row">
      <label class="muted" for="title">Scenario Name</label>
      <input id="title" placeholder="e.g., House Fire — Elm St.">
    </div>
    <div class="row">
      <label class="muted" for="dispatch">Dispatch Notes</label>
      <input id="dispatch" placeholder="Units, complaint, brief neutral description (no diagnosis)">
    </div>
    <div class="row">
      <button id="btnCreate" class="primary">Create & Continue to Photos</button>
      <span id="createStatus" class="muted">idle</span>
    </div>

    <div class="row">
      <label class="muted">Scenario ID</label>
      <input id="scenarioId" class="mono" placeholder="(auto-generated)" readonly>
      <button id="btnCopyId">Copy ID</button>
    </div>

    <div class="muted">
      This page only creates the scenario shell. After creation, you'll be sent to the dedicated photo uploader.
    </div>
  </div>

  <div class="card">
    <strong>Status</strong>
    <div id="status">Booting…</div>
  </div>

  <!-- Firebase compat SDKs (match your working setup) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
  (function(){
    // ---------- UI/Log ----------
    const $ = id => document.getElementById(id);
    const logEl = $('status');
    const log = (m,c)=>{const d=document.createElement('div'); if(c)d.style.color=c; d.textContent='['+new Date().toLocaleTimeString()+'] '+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; console.log(m);};
    const ok  = m=>log(m,'#7CFF7C');
    const bad = m=>log(m,'#FF7C7C');

    // ---------- Config ----------
    // Prefer a global window.firebaseConfig if present; else use known-good DB project config.
    const defaultCfg = {
      apiKey:"AIzaSyDM6DpRSeZueVKRpbyJyDmhf8WY66KyCDk",
      authDomain:"dailyquiz-d5279.firebaseapp.com",
      databaseURL:"https://dailyquiz-d5279-default-rtdb.firebaseio.com",
      projectId:"dailyquiz-d5279",
      storageBucket:"dailyquiz-d5279.appspot.com",
      appId:"1:94577748034:web:c032d3a1d72db1313de5db",
      measurementId:"G-19DVN7NNH7"
    };
    const raw = window.firebaseConfig || defaultCfg;

    // Guard against storage URL accidentally set as databaseURL
    (function normalizeDbUrl(cfg){
      const pid = cfg && cfg.projectId;
      const url = (cfg && cfg.databaseURL) || "";
      const okHost = /^(https:\/\/)[-a-z0-9]+(-default-rtdb)?\.(firebaseio|firebasedatabase)\.com\/?$/i;
      const looksStorage = /(firebasestorage|storage\.googleapis)\./i.test(url);
      if (!okHost.test(url) || looksStorage) {
        if (pid) cfg.databaseURL = `https://${pid}-default-rtdb.firebaseio.com`;
      }
    })(raw);

    // ---------- App / DB / Auth ----------
    const app = firebase.initializeApp(raw);
    const db  = firebase.database(app);
    const auth= firebase.auth(app);

    auth.onAuthStateChanged(u=>log('[DB AUTH] '+(u?('uid='+u.uid):'no user')));

    async function signInDB(){
      if (!auth.currentUser){
        const cred = await auth.signInAnonymously();
        ok('DB auth OK (uid='+(cred.user && cred.user.uid || 'unknown')+')');
      }
    }

    // ---------- Create Scenario then redirect ----------
    let scenarioId = null;
    const UPLOADER_URL = 'https://fireopssim.com/geophoto/test-edit-uploader';

    async function createScenario(){
      try{
        await signInDB();
        $('createStatus').textContent='creating…';

        const title = ($('title').value||'').trim();
        const dispatch = ($('dispatch').value||'').trim();
        if (!title){
          $('createStatus').textContent='name required';
          bad('Please enter a scenario name.');
          $('title').focus();
          return;
        }

        // Working compat logic: auto-generate ID and multi-path write
        const id = db.ref('scenarios').push().key;
        const base = {
          id,
          title: title || id,
          dispatch,
          description: dispatch,    // keep legacy field for compatibility
          createdAt: Date.now(),
          active: true,
          stops: []
        };

        const multi = {};
        multi[`scenarios/${id}`] = base;
        multi[`geophoto/scenarios/${id}`] = base;
        await db.ref().update(multi);

        scenarioId = id;
        $('scenarioId').value = id;
        $('createStatus').textContent='created ✓';
        ok('Scenario created: ' + id);

        // Hand off to uploader (no photo UI on this page)
        const url = new URL(UPLOADER_URL);
        url.searchParams.set('scenarioId', id);
        location.assign(url.toString());
      }catch(e){
        $('createStatus').textContent='error';
        bad('Create scenario error: ' + (e.code||'') + ' ' + (e.message||e));
        alert('Failed to create scenario. Check console and Firebase rules.');
      }
    }

    // ---------- Wire up ----------
    $('btnCreate').addEventListener('click', (ev)=>{ ev.preventDefault(); createScenario(); });
    $('btnCopyId').addEventListener('click', async ()=>{
      if(!$('scenarioId').value) return;
      try{ await navigator.clipboard.writeText($('scenarioId').value); ok('Scenario ID copied.'); }catch{}
    });

    // Boot
    (async function(){
      log('Booting…');
      try{ await signInDB(); }catch(e){ bad('DB auth failed: '+(e.message||e)); }
      ok('Ready. Enter name + dispatch, then press “Create & Continue to Photos”.');
    })();
  })();
  </script>
</body>
</html>
