<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FireOpsSim — Camera Uploader</title>
<style>
  :root{--bg:#0b1220;--card:#111a2e;--muted:#b8c4e2;--line:#1b2b50;--ink:#e8eefc;--accent:#2c5cff;--ok:#7CFF7C;--bad:#FF7C7C}
  body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Arial}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:8px 10px}
  button{cursor:pointer}
  button.primary{background:#1a3fbb;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
  .muted{color:var(--muted)}
  #status{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:10px;max-height:240px;overflow:auto}
  #preview img{max-width:100%;height:auto;border-radius:10px;border:1px solid #1a2b50}
</style>
</head>
<body>
  <h2>Camera Uploader</h2>

  <div class="card">
    <div class="row">
      <label class="muted">Bucket</label>
      <input id="bucketField" value="(detecting…)" readonly/>
    </div>
    <div class="row">
      <label class="muted">Scenario</label>
      <input id="scenarioId" class="mono" placeholder="(filled from builder)" readonly/>
    </div>
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" capture="environment"/>
      <button id="btnInit" class="primary" type="button">Init</button>
      <button id="btnUpload" class="primary" type="button">Upload Photo</button>
    </div>
    <div class="muted">Tip: allow camera + location permissions for best results.</div>
  </div>

  <div id="preview" class="card" style="display:none">
    <strong>Preview</strong>
    <div id="previewImg"></div>
    <div class="muted">Uploaded URL will open in a new tab on click.</div>
  </div>

  <div class="card">
    <strong>Status</strong>
    <div id="status">Booting…</div>
  </div>

  <!-- Firebase compat (App/Auth/Storage/Database) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const logEl = $('status');
    const log = (m,c)=>{const d=document.createElement('div'); if(c)d.style.color=c; d.textContent='['+new Date().toLocaleTimeString()+'] '+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; console.log(m);};
    const ok = (m)=>log(m,'#7CFF7C'), bad = (m)=>log(m,'#FF7C7C');

    // ---- Scenario from ?scenarioId or #hash (old behavior) ----
    const qsp = new URLSearchParams(location.search);
    function scenarioFromUrl(){
      const fromQ = qsp.get('scenarioId');
      if (fromQ) return decodeURIComponent(fromQ);
      const fromHash = (location.hash||'').replace(/^#/, '');
      return decodeURIComponent(fromHash||'');
    }

    function safeName(s){ return (s||'photo').replace(/[^\w.\-]+/g,'_'); }

    // ---- Reverse geocoding (best effort) ----
    function getGPS(){
      return new Promise((resolve)=>{
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          p=>resolve({
            lat:p.coords.latitude, lng:p.coords.longitude,
            acc:p.coords.accuracy, heading:p.coords.heading, speed:p.coords.speed, ts:Date.now()
          }),
          _=>resolve(null),
          { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
        );
      });
    }
    async function reverseGeocode(lat,lng){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`, { headers: { 'Accept':'application/json' }});
        if (r.ok){ const j = await r.json(); return j.display_name || null; }
      }catch(_){}
      if (window.GMAPS_API_KEY){
        try{
          const g = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${window.GMAPS_API_KEY}`);
          const jj = await g.json();
          return jj?.results?.[0]?.formatted_address || null;
        }catch(_){}
      }
      return null;
    }

    // ---- Firebase config (uses window.firebaseConfig if present) ----
    // Old file hard-coded fireopssim; we now prefer page config so it works with your builder.
    const cfg = Object.assign({
      apiKey:"", authDomain:"", projectId:"", storageBucket:"", databaseURL:"", appId:""
    }, (window.firebaseConfig || {}));

    // Auto-heal common mistake where databaseURL was set to a Storage host
    (function normalizeDbUrl(c){
      const pid = c && c.projectId;
      const url = (c && c.databaseURL) || "";
      const okHost = /^(https:\/\/)[-a-z0-9]+(-default-rtdb)?\.(firebaseio|firebasedatabase)\.com\/?$/i;
      const looksStorage = /(firebasestorage|storage\.googleapis)\./i.test(url);
      if ((!okHost.test(url) || looksStorage) && pid){
        c.databaseURL = `https://${pid}-default-rtdb.firebaseio.com`;
      }
    })(cfg);

    // If storageBucket missing, infer from projectId (matches Firebase default)
    if (!cfg.storageBucket && cfg.projectId){
      cfg.storageBucket = `${cfg.projectId}.appspot.com`;
    }

    // ---- App/Auth/Storage/Database (compat) ----
    let app=null, auth=null, storage=null, db=null, user=null;

    async function init(){
      if (!firebase.apps.length) app=firebase.initializeApp(cfg);
      else app=firebase.app();
      auth = firebase.auth(app);
      db   = firebase.database(app);

      // Storage: in compat, either rely on cfg.storageBucket or explicitly bind gs://
      if (cfg.storageBucket){
        storage = firebase.storage(app); // uses cfg.storageBucket
      }else{
        storage = firebase.app().storage("gs://fireopssim.appspot.com"); // fallback to old bucket
      }

      $('bucketField').value = cfg.storageBucket ? `gs://${cfg.storageBucket}` : 'gs://fireopssim.appspot.com';

      const cred = await auth.signInAnonymously();
      user = cred.user;
      ok('Auth OK (anon uid='+(user && user.uid || 'unknown')+')');
      ok('Storage ready.');
    }

    async function upload(){
      try{
        if (!storage || !auth) await init();
        const sid = ($('scenarioId').value||'').trim();
        if (!sid){ alert('No scenario ID'); return; }
        const f = $('fileInput').files && $('fileInput').files[0];
        if (!f){ alert('Pick/take a photo first'); return; }
        if (f.size > 20*1024*1024){ alert('Max 20 MB'); return; }

        const path = `scenarios/${sid}/${Date.now()}_${safeName(f.name)}`;
        log('Uploading → '+path);
        const ref = storage.ref().child(path);
        await ref.put(f, { contentType:f.type||'image/jpeg' });
        ok('Upload OK.');

        const url = await ref.getDownloadURL();
        $('preview').style.display='';
        $('previewImg').innerHTML = `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="preview"></a>`;

        // GPS + address; write to Realtime DB under current scenario
        const gps = await getGPS();
        let address = null;
        if (gps && gps.lat && gps.lng){
          try{ address = await reverseGeocode(gps.lat, gps.lng); }catch(_){}
        }

        // Two-path write for compatibility
        const photoKey = db.ref('photos').push().key;
        const record = {
          id: photoKey,
          url,
          storagePath: ref.fullPath,
          gsUri: `${$('bucketField').value}/${ref.fullPath}`,
          contentType: f.type || 'image/jpeg',
          scenarioId: sid,
          createdAt: Date.now(),
          gps: gps || null,
          address: address || null
        };
        const updates = {};
        updates[`/scenarios/${sid}/photos/${photoKey}`] = record;
        updates[`/geophoto/scenarios/${sid}/photos/${photoKey}`] = record;
        await db.ref().update(updates);
        ok('DB updated with photo record.');

        // Also postMessage back to opener/parent (keeps old behavior)
        const payload = { type:'fo-upload-complete', scenarioId:sid, ...record };
        if (window.opener) window.opener.postMessage(payload, "*");
        else if (window.parent) window.parent.postMessage(payload, "*");
        ok('Posted upload to parent/builder.');

        // reset input so you can take/upload the next photo
        $('fileInput').value = "";
      }catch(e){
        bad('Upload error: '+(e.code||'')+' '+(e.message||e));
        if (String(e).includes('storage/unauthorized')){
          bad('Storage rules blocked the upload. Ensure anonymous writes are allowed during testing.');
        }
        alert('Upload failed:\n'+(e && e.message || e));
      }
    }

    // ---- Wire up (preserve old buttons/flow) ----
    $('btnInit').addEventListener('click', init);
    $('btnUpload').addEventListener('click', upload);
    $('fileInput').addEventListener('change', ()=>{
      const f = $('fileInput').files && $('fileInput').files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = (e)=>{ $('preview').style.display=''; $('previewImg').innerHTML = `<img src="${e.target.result}" alt="preview">`; };
      r.readAsDataURL(f);
    });

    // ---- Boot: fill scenarioId from URL ----
    (function boot(){
      $('scenarioId').value = scenarioFromUrl();
      log('Booting…');
      ok('Ready. Init → pick/take photo → Upload.');
    })();
  })();
  </script>
</body>
</html>
