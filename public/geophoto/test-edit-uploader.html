<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>FireOpsSim — Camera Uploader</title>
<style>
  :root{--bg:#0b1220;--card:#111a2e;--muted:#b8c4e2;--line:#1b2b50;--ink:#e8eefc;--accent:#2c5cff;--ok:#7CFF7C;--bad:#FF7C7C}
  body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Arial}
  h2{margin:0 0 10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  button.primary{background:#1a3fbb;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
  .muted{color:var(--muted)}
  #status{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:10px;max-height:260px;overflow:auto}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  #thumbs{display:flex;flex-wrap:wrap;gap:8px}
  #thumbs a{display:block}
  #thumbs img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #1a2b50}
  #preview img{max-width:100%;height:auto;border-radius:10px;border:1px solid #1a2b50}
  .hidden{display:none}
  video{max-width:100%;border-radius:10px;border:1px solid #1a2b50}
  canvas{display:none}
  @media (max-width:560px){ .row{flex-direction:column;align-items:stretch} input,button{width:100%} }
</style>
</head>
<body>
  <h2>Camera Uploader</h2>

  <div class="card">
    <div class="row">
      <label class="muted">Bucket</label>
      <input id="bucketName" class="mono" value="(detecting…)" readonly/>
    </div>
    <div class="row">
      <label class="muted">Scenario</label>
      <input id="scenarioId" class="mono" placeholder="(from ?scenarioId or #hash)" readonly/>
    </div>
    <div class="row">
      <!-- System picker: many devices will show Camera when capture is present -->
      <input id="fileInput" type="file" accept="image/*" capture="environment" multiple/>
      <button id="btnPick" class="primary">Pick / Take (System)</button>

      <!-- Direct camera: fallback when the picker won't open camera -->
      <button id="btnCamera" class="primary">Use Camera (Beta)</button>
      <button id="btnSnap" class="" disabled>Snap Frame</button>
      <button id="btnUpload" class="primary" disabled>Upload Photo</button>
    </div>
    <div class="muted">Tip: If the system picker won’t open your camera, tap <b>Use Camera (Beta)</b>, then <b>Snap Frame</b>, then <b>Upload</b>.</div>
  </div>

  <div id="live" class="card hidden">
    <strong>Live Camera</strong>
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="preview" class="card hidden">
    <strong>Preview (last selected)</strong>
    <div id="previewImg"></div>
  </div>

  <div class="card">
    <strong>Uploaded Photos</strong>
    <div id="thumbs"></div>
  </div>

  <div class="card">
    <strong>Status</strong>
    <div id="status">Booting…</div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
  (function(){
    // ===== Logger =====
    const $ = sel => document.querySelector(sel);
    const logEl = $('#status');
    const log = (m,c)=>{const d=document.createElement('div'); if(c)d.style.color=c; d.textContent='['+new Date().toLocaleTimeString()+'] '+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; console.log(m);};
    const ok  = m=>log(m,'#7CFF7C');
    const bad = m=>log(m,'#FF7C7C');

    // ===== URL & helpers =====
    const qsp = new URLSearchParams(location.search);
    function scenarioFromUrl(){
      const fromQ = qsp.get('scenarioId');
      if (fromQ) return decodeURIComponent(fromQ);
      const fromHash = (location.hash||'').replace(/^#/, '');
      return decodeURIComponent(fromHash||'');
    }
    function safeName(s){ return (s||'photo.jpg').replace(/[^\w.\-]+/g,'_'); }

    async function getGPS(){
      return new Promise((resolve)=>{
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          p=>resolve({lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy, ts:Date.now()}),
          _=>resolve(null),
          { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
        );
      });
    }
    async function reverseGeocode(lat,lng){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`, { headers: { 'Accept':'application/json' }});
        if (r.ok){ const j = await r.json(); return j.display_name || null; }
      }catch(_){}
      if (window.GMAPS_API_KEY){
        try{
          const g = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${window.GMAPS_API_KEY}`);
          const jj = await g.json();
          return jj?.results?.[0]?.formatted_address || null;
        }catch(_){}
      }
      return null;
    }

    // ===== Firebase (compat) =====
    const defaults = { apiKey:"", authDomain:"", projectId:"", storageBucket:"", databaseURL:"", appId:"" };
    const cfg = Object.assign({}, defaults, (window.firebaseConfig || {}));
    (function normalizeDbUrl(c){
      const pid = c && c.projectId;
      const url = (c && c.databaseURL) || "";
      const okHost = /^(https:\/\/)[-a-z0-9]+(-default-rtdb)?\.(firebaseio|firebasedatabase)\.com\/?$/i;
      const looksStorage = /(firebasestorage|storage\.googleapis)\./i.test(url);
      if ((!okHost.test(url) || looksStorage) && pid){
        c.databaseURL = `https://${pid}-default-rtdb.firebaseio.com`;
      }
    })(cfg);
    if (!cfg.storageBucket && cfg.projectId){
      cfg.storageBucket = `${cfg.projectId}.appspot.com`;
    }

    const app = firebase.initializeApp(cfg);
    const auth = firebase.auth(app);
    const db   = firebase.database(app);
    const storage = firebase.storage(app); // uses cfg.storageBucket
    const bucketStr = cfg.storageBucket ? `gs://${cfg.storageBucket}` : '(missing storageBucket)';
    $('#bucketName').value = bucketStr;

    // ===== State =====
    let currentScenarioId = "";
    let lastFile = null;
    let stream = null;

    // ===== UI wiring =====
    $('#btnPick').addEventListener('click', ()=> $('#fileInput').click());
    $('#fileInput').addEventListener('change', onFilesChosen);
    $('#btnUpload').addEventListener('click', uploadCurrentFile);
    $('#btnCamera').addEventListener('click', startCamera);
    $('#btnSnap').addEventListener('click', snapFrame);

    // ===== Boot =====
    (async function boot(){
      try{
        const cred = await auth.signInAnonymously();
        ok('Auth OK (uid='+(cred.user?.uid||'unknown')+')');
      }catch(e){
        bad('Auth failed: '+(e.message||e)); return;
      }
      currentScenarioId = scenarioFromUrl();
      $('#scenarioId').value = currentScenarioId || '(missing)';
      if (!currentScenarioId) bad('No scenarioId provided; add ?scenarioId=...');

      ok('Ready. Use system picker, or try camera mode if the picker won’t open camera.');
    })();

    // ===== System picker path =====
    function onFilesChosen(evt){
      const files = Array.from(evt.target.files||[]);
      if (!files.length) return;
      // We queue the first one for Upload button; you can change to auto-upload if you prefer.
      lastFile = files[0];
      showPreviewFromFile(lastFile);
      $('#btnUpload').disabled = false;
    }

    function showPreviewFromFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        $('#preview').classList.remove('hidden');
        $('#previewImg').innerHTML = `<img src="${e.target.result}" alt="preview">`;
      };
      reader.readAsDataURL(file);
    }

    // ===== Direct camera path (getUserMedia) =====
    async function startCamera(){
      try{
        if (stream) stopCamera();
        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 }, height: { ideal: 1080 }
          },
          audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = $('#video');
        video.srcObject = stream;
        $('#live').classList.remove('hidden');
        $('#btnSnap').disabled = false;
        ok('Camera started');
      }catch(e){
        bad('Camera error: '+(e.message||e));
        alert('Camera could not be started. Try the system picker instead.');
      }
    }
    function stopCamera(){
      try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){}
      stream = null;
      $('#btnSnap').disabled = true;
      $('#live').classList.add('hidden');
    }
    function snapFrame(){
      if (!stream){ bad('No live stream'); return; }
      const video = $('#video');
      const canvas = $('#canvas');
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      canvas.toBlob((blob)=>{
        if (!blob){ bad('Failed to capture frame'); return; }
        // Make a File-like object for upload
        const fname = `camera_${Date.now()}.jpg`;
        const f = new File([blob], fname, { type: 'image/jpeg' });
        lastFile = f;
        showPreviewFromFile(f);
        $('#btnUpload').disabled = false;
        ok('Frame captured — ready to upload');
      }, 'image/jpeg', 0.92);
    }

    // ===== Upload =====
    async function uploadToStorageCompat(sid, file){
      const path = `scenarios/${sid}/${Date.now()}_${safeName(file.name)}`;
      const ref  = storage.ref().child(path);
      log(`Uploading to ${bucketStr}/${path}`);
      const snap = await ref.put(file, { contentType: file.type || 'image/jpeg' });
      const url  = await snap.ref.getDownloadURL();
      return { url, fullPath: ref.fullPath, gsUri: `${bucketStr}/${ref.fullPath}` };
    }

    async function uploadCurrentFile(){
      if (!currentScenarioId) { alert('No scenarioId. Open this page via the builder redirect.'); return; }
      if (!lastFile)          { alert('No photo selected.'); return; }

      try{
        const { url, fullPath, gsUri } = await uploadToStorageCompat(currentScenarioId, lastFile);
        ok('Upload OK');

        const gps = await getGPS();
        let address = null;
        if (gps && gps.lat && gps.lng) { try { address = await reverseGeocode(gps.lat, gps.lng); } catch(_){} }

        const photoKey = db.ref('photos').push().key;
        const photoRec = {
          id: photoKey,
          url, storagePath: fullPath, gsUri,
          contentType: lastFile.type || 'image/jpeg',
          scenarioId: currentScenarioId, createdAt: Date.now(),
          gps: gps || null, address: address || null
        };
        const updates = {};
        updates[`/scenarios/${currentScenarioId}/photos/${photoKey}`] = photoRec;
        updates[`/geophoto/scenarios/${currentScenarioId}/photos/${photoKey}`] = photoRec;
        await db.ref().update(updates);
        ok('DB updated with photo record');

        // Add thumb & reset selection (keep camera live if it was on)
        addThumb(url);
        $('#fileInput').value = "";
        lastFile = null;
        $('#btnUpload').disabled = true;
      }catch(e){
        bad(`Upload FAILED: ${e.code||''} ${e.message||e}`);
        if (String(e).includes('storage/unauthorized')) {
          bad('Storage rules blocked the upload (storage/unauthorized). Ensure anonymous writes are allowed during testing.');
        }
        alert('Upload failed:\n'+(e && e.message || e));
      }
    }

    function addThumb(url){
      const a = document.createElement('a');
      a.href = url; a.target = '_blank'; a.rel = 'noopener';
      a.innerHTML = `<img src="${url}" alt="thumb">`;
      $('#thumbs').prepend(a);
      $('#preview').classList.add('hidden'); // optional: hide large preview after upload
    }

  })();
  </script>
</body>
</html>
