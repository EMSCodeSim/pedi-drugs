<script>
// --- Minimal RPC server in the uploader (child) ---
(function(){
  const TRUSTED_ORIGIN = location.origin; // same-origin recommended
  let currentScenarioId = "";             // gets set by parent

  // Handshake: tell parent we're ready
  window.addEventListener("load", ()=>{
    window.parent?.postMessage({ type:"fo-ready" }, TRUSTED_ORIGIN);
  });

  // Implement the method the parent wants to call
  async function captureAndUpload({ scenarioId }){
    // 1) Make sure your current code selects/reads the file input or camera
    //    If you already have a visible "Choose/Take Photo" button, you can:
    //    - programmatically click it (if UX allows), OR
    //    - show instructions/modal to the user and wait for selection
    // Here we'll expect the user already picked a file:
    const input = document.getElementById('fileInput');
    const file  = input?.files?.[0];
    if (!file) throw new Error("No file selected");

    // 2) Call your existing working Storage upload code (FireOpsSim)
    //    Return: { url, fullPath, gsUri }
    const { url, fullPath, gsUri } = await yourWorkingStorageUpload(scenarioId, file);

    // 3) Optional GPS collection (your existing helper)
    const gps = await maybeGetGPS();

    return { url, fullPath, gsUri, gps, scenarioId };
  }

  // RPC dispatcher
  window.addEventListener("message", async (ev)=>{
    if (ev.origin !== TRUSTED_ORIGIN) return; // security check
    const msg = ev.data || {};
    if (msg.type === "fo-set-scenario"){
      currentScenarioId = msg.scenarioId || "";
      // display it if you like
      const sidEl = document.getElementById('scenarioId');
      if (sidEl) sidEl.value = currentScenarioId;
      return;
    }
    if (msg.type === "fo-rpc"){
      const { method, params, correlationId } = msg;
      try{
        if (method === "captureAndUpload"){
          const result = await captureAndUpload({ ...(params||{}), scenarioId: currentScenarioId || params?.scenarioId });
          window.parent?.postMessage({ type:"fo-rpc-res", correlationId, result }, TRUSTED_ORIGIN);
        }else{
          throw new Error("unknown method: "+method);
        }
      }catch(err){
        window.parent?.postMessage({ type:"fo-rpc-err", correlationId, error: (err && err.message) || String(err) }, TRUSTED_ORIGIN);
      }
    }
  });

  // ---- Plug your existing functions below ----
  async function yourWorkingStorageUpload(sid, file){
    // This should be exactly the upload logic that works in test-edit:
    // - Same named Firebase app (FireOpsSim)
    // - Explicit gs://fireopssim.appspot.com binding
    // - Direct put(file, meta)
    const app = /* your existing storage app init */;
    const storage = /* firebase.storage(app, "gs://fireopssim.appspot.com") */;
    const safe = (s)=> (s||"file").replace(/[^\w.\-]+/g,"_");
    const path = `scenarios/${sid}/${Date.now()}_${safe(file.name)}`;
    const ref  = storage.ref().child(path);
    await ref.put(file, { contentType: file.type || "image/jpeg" });
    const url = await ref.getDownloadURL();
    return { url, fullPath: ref.fullPath, gsUri: `gs://fireopssim.appspot.com/${ref.fullPath}` };
  }

  async function maybeGetGPS(){
    return new Promise(res=>{
      if (!navigator.geolocation) return res(null);
      navigator.geolocation.getCurrentPosition(
        p=>res({ lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy }),
        _=>res(null),
        { enableHighAccuracy:true, timeout:7000, maximumAge:0 }
      );
    });
  }
})();
</script>
