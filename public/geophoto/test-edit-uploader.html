<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>FireOpsSim — Photo Uploader (Storage-only)</title>

<!-- If you already define window.firebaseConfig in the parent page, you can remove this sample.
<script>
  window.firebaseConfig = {
    apiKey: "AIzaSyBzwc75u8pG73OKcHN8ti2ADbucjKMHme8",
    authDomain: "fireopssim.firebaseapp.com",
    projectId: "fireopssim",
    storageBucket: "fireopssim.appspot.com",
    // databaseURL not needed here
    appId: "1:396140888722:web:demo"
  };
</script>
-->

<style>
  :root{--bg:#0b1220;--card:#111a2e;--muted:#b8c4e2;--line:#1b2b50;--ink:#e8eefc;--accent:#2c5cff;--ok:#7CFF7C;--bad:#FF7C7C}
  *{box-sizing:border-box}
  body{margin:0;padding:16px;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Arial}
  h2{margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input,button{background:#091125;color:var(--ink);border:1px solid #20407a;border-radius:10px;padding:10px 12px}
  input[readonly]{opacity:.85}
  button{cursor:pointer}
  button.primary{background:#1a3fbb;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  #status{white-space:pre-wrap;background:#0c1530;border:1px solid #1b2b50;border-radius:10px;padding:10px;max-height:260px;overflow:auto}
  #preview img{max-width:100%;height:auto;border-radius:10px;border:1px solid #1a2b50}
  #thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  #thumbs a{display:block}
  #thumbs img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #1a2b50}
  @media (max-width:560px){ .row{flex-direction:column;align-items:stretch} input,button{width:100%} }
</style>
</head>
<body>
  <h2>Photo Uploader</h2>

  <div class="card">
    <div class="row">
      <label class="muted">Bucket</label>
      <input id="bucketName" class="mono" value="(detecting…)" readonly/>
    </div>
    <div class="row">
      <label class="muted">Scenario</label>
      <input id="scenarioId" class="mono" placeholder="(from ?scenarioId or #hash)" readonly/>
    </div>
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" capture="environment"/>
      <button id="btnPick" class="primary" type="button">Pick / Take Photo</button>
      <button id="btnUpload" class="primary" type="button" disabled>Upload Photo</button>
    </div>
    <div class="muted">This page uploads to Cloud Storage only (no Realtime DB). Open from Scenario Builder so <b>?scenarioId=...</b> is present.</div>
  </div>

  <div id="preview" class="card" style="display:none">
    <strong>Preview (last selected)</strong>
    <div id="previewImg"></div>
  </div>

  <div class="card">
    <strong>Uploaded Photos</strong>
    <div id="thumbs"></div>
  </div>

  <div class="card">
    <strong>Status</strong>
    <div id="status">Booting…</div>
  </div>

  <!-- Firebase compat SDKs (Storage-only flow) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
  (function(){
    // ---------- Logger ----------
    const $ = s=>document.querySelector(s);
    const logEl = $('#status');
    const log = (m,c)=>{const d=document.createElement('div'); if(c)d.style.color=c; d.textContent='['+new Date().toLocaleTimeString()+'] '+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; console.log(m);};
    const ok  = m=>log(m,'#7CFF7C'), bad = m=>log(m,'#FF7C7C');

    // ---------- Scenario from URL ----------
    const qsp = new URLSearchParams(location.search);
    function scenarioFromUrl(){
      const q = qsp.get('scenarioId'); if (q) return decodeURIComponent(q);
      const hash = (location.hash||'').replace(/^#/, ''); return decodeURIComponent(hash||'');
    }

    // ---------- Firebase config (Storage-only) ----------
    const fallback = {
      apiKey:"AIzaSyBzwc75u8pG73OKcHN8ti2ADbucjKMHme8",
      authDomain:"fireopssim.firebaseapp.com",
      projectId:"fireopssim",
      storageBucket:"fireopssim.appspot.com",
      appId:"1:396140888722:web:demo"
    };
    const cfg = Object.assign({}, fallback, (window.firebaseConfig||{}));
    if (!cfg.storageBucket && cfg.projectId){ cfg.storageBucket = `${cfg.projectId}.appspot.com`; }

    const app = firebase.initializeApp(cfg);
    const auth = firebase.auth(app);
    const storage = firebase.storage(app); // compat uses cfg.storageBucket
    const bucketStr = cfg.storageBucket ? `gs://${cfg.storageBucket}` : '(missing storageBucket)';
    $('#bucketName').value = bucketStr;

    // ---------- State ----------
    let sid = "";
    let lastFile = null;

    // ---------- Helpers ----------
    function safeName(s){ return (s||'photo.jpg').replace(/[^\w.\-]+/g,'_'); }
    async function uploadToStorage(sid, file){
      // organize by scenario if provided; else put under /uploads/
      const base = sid ? `scenarios/${sid}` : 'uploads';
      const path = `${base}/${Date.now()}_${safeName(file.name)}`;
      const ref  = storage.ref().child(path);
      log(`Uploading to ${bucketStr}/${path}`);
      const snap = await ref.put(file, { contentType: file.type || 'image/jpeg' });
      const url  = await snap.ref.getDownloadURL();
      return { url, fullPath: ref.fullPath };
    }

    // ---------- UI wiring ----------
    $('#btnPick').addEventListener('click', ()=> $('#fileInput').click());
    $('#fileInput').addEventListener('change', ()=>{
      const f = $('#fileInput').files && $('#fileInput').files[0];
      if (!f) return;
      lastFile = f;
      const r = new FileReader();
      r.onload = (e)=>{ $('#preview').style.display=''; $('#previewImg').innerHTML = `<img src="${e.target.result}" alt="preview">`; };
      r.readAsDataURL(f);
      $('#btnUpload').disabled = false;
      ok('Photo selected — ready to upload');
    });

    $('#btnUpload').addEventListener('click', async ()=>{
      if (!lastFile){ alert('Pick/take a photo first.'); return; }
      try{
        if (!auth.currentUser) await auth.signInAnonymously();
        const { url } = await uploadToStorage(sid, lastFile);
        ok('Upload OK');

        // Add thumbnail
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel='noopener';
        a.innerHTML = `<img src="${url}" alt="thumb">`;
        $('#thumbs').prepend(a);

        // Reset for next photo
        $('#fileInput').value = "";
        lastFile = null;
        $('#btnUpload').disabled = true;

        // Optional: inform opener/parent that one upload finished
        const msg = { type:'fo-upload-complete', scenarioId: sid, url };
        if (window.opener) window.opener.postMessage(msg, "*");
        else if (window.parent) window.parent.postMessage(msg, "*");
      }catch(e){
        bad(`Upload FAILED: ${e.code||''} ${e.message||e}`);
        if (String(e).includes('auth/invalid-api-key')) {
          bad('Invalid API key — ensure window.firebaseConfig.apiKey matches your project’s Web API key.');
        }
        if (String(e).includes('storage/unauthorized')) {
          bad('Storage rules blocked the upload (storage/unauthorized). Make sure anonymous writes are allowed while testing.');
        }
        alert('Upload failed:\n'+(e && e.message || e));
      }
    });

    // ---------- Boot ----------
    (async function boot(){
      try{
        const cred = await auth.signInAnonymously();
        ok('Auth OK (uid='+(cred.user?.uid||'unknown')+')');
      }catch(e){
        bad('Auth failed: '+(e.message||e));
      }
      sid = scenarioFromUrl();
      $('#scenarioId').value = sid || '(none)';
      ok('Ready. Pick or take a photo, then Upload.');
    })();
  })();
  </script>
</body>
</html>
