<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pump Pressure — Visual Builder (ENGINE 181)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8;
    --edge:rgba(255,255,255,.12); --accent:#49a3ff;
    --hose5:#ecd464; --hose25:#f2994a; --hose175:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  header{
    position:sticky;top:0;z-index:3;
    padding:10px 12px;background:linear-gradient(180deg,#0c1320 0%,#0b0f14 100%);
    border-bottom:1px solid var(--edge);
  }
  h1{font-size:16px;margin:0 0 4px}
  .controls-top{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .controls-top .group{display:flex;gap:6px}
  select,button{
    background:#0b1320;border:1px solid var(--edge);color:var(--ink);
    border-radius:10px;padding:8px 10px;font-size:14px
  }
  button{cursor:pointer}
  button:active{transform:translateY(1px)}

  /* Stage: engine IMG + overlay SVG stacked */
  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge)}
  .scroll{height:65vh;overflow:auto;overscroll-behavior:contain;background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative; width:100%; min-height:500px;}
  #engine{display:block; width:100%; height:auto; position:absolute; bottom:0; left:0;}
  /* SVG overlay covers the whole stage */
  #overlay{position:absolute; inset:0; display:block; width:100%; height:100%}
  .hint{position:absolute; top:8px; left:10px; font-size:12px; color:#f7e39a}

  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input{background:#0b1320;color:var(--ink);border:1px solid var(--edge);border-radius:10px;padding:8px 10px}

  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
  .kpi b{font-size:20px}
  .note{font-size:12px;color:#9fb0c8}

  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320}
  .item small{color:var(--muted)}
  .actions{display:flex;gap:6px;align-items:center}
</style>
</head>
<body>
<div class="app">

  <header>
    <h1>Pump Pressure — Visual Builder</h1>
    <div class="controls-top">
      <!-- Hose -->
      <div class="group">
        <select id="hosePick" aria-label="Hose preset">
          <option value='{"size":"5","lengthFt":100}'>5″ 100′</option>
          <option value='{"size":"2.5","lengthFt":50}'>2½″ 50′</option>
          <option value='{"size":"1.75","lengthFt":100}'>1¾″ 100′</option>
          <option value='{"size":"1.75","lengthFt":50}'>1¾″ 50′</option>
        </select>
        <button id="addHose">Add Hose</button>
      </div>
      <!-- Accessory -->
      <div class="group">
        <select id="accPick" aria-label="Accessory preset">
          <option value='{"name":"Wye/Siamese","loss":10}'>Wye/Siamese (+10 psi)</option>
          <option value='{"name":"In-line eductor","loss":25}'>In-line eductor (+25 psi)</option>
          <option value='{"name":"Master monitor","loss":25}'>Master monitor (+25 psi)</option>
          <option value='{"name":"Standpipe/PRV","loss":25}'>Standpipe/PRV (+25 psi)</option>
          <option value='{"name":"Custom","loss":0}'>Custom…</option>
        </select>
        <button id="addAcc">Add Accessory</button>
      </div>
      <!-- Nozzle -->
      <div class="group">
        <select id="nozPick" aria-label="Nozzle">
          <!-- options filled by JS -->
        </select>
        <button id="applyNoz">Apply Nozzle</button>
      </div>
    </div>
  </header>

  <!-- Stage -->
  <div class="wrapper">
    <div id="scroll" class="scroll">
      <div id="stage" class="stage">
        <img id="engine" alt="ENGINE 181" src="https://fireopssim.com/pump/engine181.png" />
        <svg id="overlay" viewBox="0 0 390 800" preserveAspectRatio="none">
          <g id="hoseGroup"></g>
          <g id="accGroup"></g>
          <g id="nozzleGroup"></g>
          <text class="hint" id="hint">Add hose to begin…</text>
        </svg>
      </div>
    </div>
  </div>

  <!-- Lower panels -->
  <div class="panel">
    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Environment</h3>
      <div class="grid2">
        <div>
          <label>Elevation (ft)</label>
          <input id="elevFt" type="number" step="5" value="0" />
        </div>
        <div>
          <label>Elevation factor (psi/ft)</label>
          <input id="elevPsi" type="number" step="0.001" value="0.434" />
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Build List</h3>
      <div class="list" id="builderList"></div>
    </div>

    <div class="card">
      <div class="eq" id="equation">PDP = NP + ΣFL(hose @ GPM) + ΣAccessory ± Elev</div>
      <div class="kpis" style="margin-top:8px">
        <div class="kpi"><div>Flow</div><b id="GPM">— gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">— psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </div>

</div>

<script>
  // ---------- Visual constants ----------
  const STAGE_W = 390;             // overlay viewBox width
  const PX_PER_50FT = 80;          // vertical pixels per 50′ segment
  const HOSE_X_RATIO = 0.78;       // hose column X (fraction of width)
  const HOSE_WIDTH = { "5": 12, "2.5": 9, "1.75": 6 };  // thinner per your request
  const HOSE_COLOR = { "5": "var(--hose5)", "2.5": "var(--hose25)", "1.75": "var(--hose175)" };

  // Friction loss: FL = C * (Q/100)^2 * (L/100)
  const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };

  // Nozzles (incl. Chief XD)
  const NOZZLES = [
    {name:"None (closed)", gpm:0, NP:0},
    {name:"Fog 95", gpm:95, NP:100},
    {name:"Fog 125", gpm:125, NP:100},
    {name:"Fog 150", gpm:150, NP:100},
    {name:'SB 7/8″', gpm:160, NP:50},
    {name:'SB 15/16″', gpm:185, NP:50},
    {name:'SB 1″', gpm:210, NP:50},
    {name:"ChiefXD 100 @50", gpm:100, NP:50},
    {name:"ChiefXD 150 @50", gpm:150, NP:50},
    {name:"ChiefXD 150 @75", gpm:150, NP:75},
    {name:"ChiefXD 185 @75", gpm:185, NP:75}
  ];

  // ---------- State ----------
  // Items stacked from engine top upward: hose or accessory
  let items = []; // {type:'hose', size, lengthFt} | {type:'acc', name, loss}
  let nozzle = NOZZLES[3]; // Fog 150 default
  let elevFt = 0, elevPsiPerFt = 0.434;

  // ---------- Elements ----------
  const engineImg = document.getElementById('engine');
  const stage = document.getElementById('stage');
  const scrollEl = document.getElementById('scroll');
  const overlay = document.getElementById('overlay');
  const hoseGroup = document.getElementById('hoseGroup');
  const accGroup = document.getElementById('accGroup');
  const nozzleGroup = document.getElementById('nozzleGroup');
  const hint = document.getElementById('hint');
  const builderList = document.getElementById('builderList');

  // Populate nozzle dropdown
  const nozPick = document.getElementById('nozPick');
  NOZZLES.forEach(n=>{
    const opt = document.createElement('option');
    opt.value = n.name; opt.textContent = `${n.name} (${n.gpm} gpm, NP ${n.NP})`;
    nozPick.appendChild(opt);
  });
  nozPick.value = nozzle.name;

  // Top buttons (no popups; just select + add/apply)
  document.getElementById('addHose').onclick = ()=>{
    const data = JSON.parse(document.getElementById('hosePick').value);
    items.push({type:'hose', size:data.size, lengthFt:data.lengthFt});
    render(true);
  };
  document.getElementById('addAcc').onclick = ()=>{
    const data = JSON.parse(document.getElementById('accPick').value);
    if(data.name === 'Custom'){
      const name = prompt('Accessory name?','Appliance');
      if(name===null) return;
      const loss = parseFloat(prompt('Pressure loss (psi)?','10')||'0');
      items.push({type:'acc', name:name||'Custom', loss:isNaN(loss)?0:loss});
    } else {
      items.push({type:'acc', name:data.name, loss:Number(data.loss)||0});
    }
    render(true);
  };
  document.getElementById('applyNoz').onclick = ()=>{
    const found = NOZZLES.find(n=>n.name===nozPick.value);
    if(found){ nozzle = found; render(false); }
  };

  // Env inputs
  document.getElementById('elevFt').oninput = e=>{ elevFt = parseFloat(e.target.value||0); render(); };
  document.getElementById('elevPsi').oninput = e=>{ elevPsiPerFt = parseFloat(e.target.value||0); render(); };

  // Handle engine load & window resize to keep geometry correct
  engineImg.onload = ()=> render(true);
  window.addEventListener('resize', ()=> render(false));

  // ---------- Math ----------
  function fl(C, Q, L){ return (C||0) * Math.pow(Q/100, 2) * (L/100); }
  function calc(){
    const Q = nozzle.gpm || 0;
    const NP = nozzle.NP || 0;

    let totalFL = 0, totalAcc = 0;
    const hoses = [], accs = [];
    items.forEach((it, idx)=>{
      if(it.type==='hose'){
        const C = COEFF[it.size] || 0;
        const segFL = fl(C, Q, it.lengthFt);
        totalFL += segFL; hoses.push({i:idx+1, ...it, C, segFL});
      } else {
        totalAcc += Number(it.loss)||0; accs.push({i:idx+1, ...it});
      }
    });

    const elevPsi = elevFt * elevPsiPerFt;
    const PDP = NP + totalFL + totalAcc + elevPsi;
    return {Q, NP, totalFL, totalAcc, elevPsi, PDP, hoses, accs};
  }

  // ---------- Geometry helpers ----------
  function engineHeightPx(){ return engineImg.clientHeight || 180; }
  function stageWidthPx(){ return stage.clientWidth || window.innerWidth || 390; }
  function hoseXpx(){
    return Math.round(stageWidthPx() * HOSE_X_RATIO);
  }

  // ---------- Drawing ----------
  function renderDiagram(){
    const eH = engineHeightPx();

    // total hose pixels + accessory space
    const hoseFeet = items.filter(x=>x.type==='hose').reduce((s,h)=>s+h.lengthFt,0);
    const hosePx = (hoseFeet/50) * PX_PER_50FT;
    const accCount = items.filter(x=>x.type==='acc').length;
    const accPx = accCount * 22;
    const topPad = 120; // room for nozzle & label

    // stage height: engine at bottom, stack above it
    const stageH = Math.max(500, eH + hosePx + accPx + topPad);
    stage.style.height = stageH + 'px';

    // overlay viewBox updates to match px height (keep width fixed at 390 units)
    overlay.setAttribute('viewBox', `0 0 ${STAGE_W} ${Math.round(stageH)}`);

    // engine is CSS-positioned at bottom; hose starts exactly at engine top
    let currentTop = stageH - eH; // y coordinate where engine top sits (in px)
    const x = hoseXpx();

    // clear layers
    hoseGroup.innerHTML = '';
    accGroup.innerHTML = '';
    nozzleGroup.innerHTML = '';

    if(items.length===0){
      hint.textContent = 'Add hose to begin…';
      return;
    } else {
      hint.textContent = '';
    }

    // Draw stack in order
    for(const it of items){
      if(it.type==='hose'){
        const w = HOSE_WIDTH[it.size] || 6;
        const h = (it.lengthFt===50 ? PX_PER_50FT : 2*PX_PER_50FT);
        const y = currentTop - h;

        // Because SVG viewBox units map to 390 width, we convert px->vb units
        const vbX = x / stageWidthPx() * STAGE_W;
        const vbY = y / stageH * overlay.viewBox.baseVal.height;
        const vbW = w / stageWidthPx() * STAGE_W;
        const vbH = h / stageH * overlay.viewBox.baseVal.height;

        const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
        r.setAttribute('x', vbX - vbW/2);
        r.setAttribute('y', vbY);
        r.setAttribute('width', vbW);
        r.setAttribute('height', vbH);
        r.setAttribute('fill', HOSE_COLOR[it.size] || 'goldenrod');
        r.setAttribute('stroke', 'rgba(255,255,255,.10)');
        r.setAttribute('stroke-width', '1');
        hoseGroup.appendChild(r);

        // coupling line
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', vbX - vbW/2);
        line.setAttribute('x2', vbX + vbW/2);
        line.setAttribute('y1', vbY);
        line.setAttribute('y2', vbY);
        line.setAttribute('stroke', '#2b3242');
        line.setAttribute('stroke-width', '2');
        hoseGroup.appendChild(line);

        currentTop -= h;
      } else if(it.type==='acc'){
        const vbX = (x + 10) / stageWidthPx() * STAGE_W;
        const boxYpx = currentTop - 18;
        const vbY = boxYpx / stageH * overlay.viewBox.baseVal.height;

        const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
        bg.setAttribute('x', vbX);
        bg.setAttribute('y', vbY);
        bg.setAttribute('width', 120);
        bg.setAttribute('height', 18);
        bg.setAttribute('rx', 6); bg.setAttribute('ry', 6);
        bg.setAttribute('fill', '#172134');
        bg.setAttribute('stroke', 'rgba(255,255,255,.15)');
        accGroup.appendChild(bg);

        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', vbX + 6);
        txt.setAttribute('y', vbY + 12);
        txt.setAttribute('fill', '#cfe4ff');
        txt.setAttribute('font-size', '10');
        txt.textContent = `${it.name} (+${it.loss} psi)`;
        accGroup.appendChild(txt);

        currentTop -= 22;
      }
    }

    // Nozzle glyph at the very top
    const lastHose = items.filter(i=>i.type==='hose').slice(-1)[0];
    const wTopPx = lastHose ? (HOSE_WIDTH[lastHose.size] || 6) : 8;
    const vbX = x / stageWidthPx() * STAGE_W;
    const bodyYpx = currentTop - 22;
    const tipYpx = currentTop - 30;
    const vbBodyY = bodyYpx / stageH * overlay.viewBox.baseVal.height;
    const vbTipY  = tipYpx  / stageH * overlay.viewBox.baseVal.height;
    const vbWTop  = wTopPx / stageWidthPx() * STAGE_W;

    const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', vbX - vbWTop/2 - 4);
    body.setAttribute('y', vbBodyY);
    body.setAttribute('width', vbWTop + 8);
    body.setAttribute('height', 18);
    body.setAttribute('fill', '#394357');
    nozzleGroup.appendChild(body);

    const tip = document.createElementNS('http://www.w3.org/2000/svg','rect');
    tip.setAttribute('x', vbX - (vbWTop*0.4));
    tip.setAttribute('y', vbTipY);
    tip.setAttribute('width', vbWTop*0.8);
    tip.setAttribute('height', 8);
    tip.setAttribute('fill', '#9aa7bd');
    nozzleGroup.appendChild(tip);
  }

  // ---------- Builder list ----------
  function row(it, idx){
    const div = document.createElement('div');
    div.className = 'item';
    if(it.type==='hose'){
      div.innerHTML = `
        <div><div>🧯 Hose <small>#${idx+1}</small></div><div class="note">${it.size}″ • ${it.lengthFt}′</div></div>
        <div class="actions">
          <select data-k="size">
            <option value="5" ${it.size==='5'?'selected':''}>5″</option>
            <option value="2.5" ${it.size==='2.5'?'selected':''}>2½″</option>
            <option value="1.75" ${it.size==='1.75'?'selected':''}>1¾″</option>
          </select>
          <select data-k="lengthFt">
            <option value="50" ${it.lengthFt===50?'selected':''}>50′</option>
            <option value="100" ${it.lengthFt===100?'selected':''}>100′</option>
          </select>
          <button data-act="dup">＋</button>
          <button data-act="up">↑</button>
          <button data-act="down">↓</button>
          <button data-act="del">✕</button>
        </div>`;
    } else {
      div.innerHTML = `
        <div><div>⚙️ Accessory <small>#${idx+1}</small></div><div class="note">${it.name} • +${it.loss} psi</div></div>
        <div class="actions">
          <button data-act="loss">Loss</button>
          <button data-act="rename">Name</button>
          <button data-act="up">↑</button>
          <button data-act="down">↓</button>
          <button data-act="del">✕</button>
        </div>`;
    }

    div.querySelectorAll('select').forEach(s=>{
      s.onchange = ()=>{
        const k = s.dataset.k;
        if(k==='size') it.size = s.value;
        if(k==='lengthFt') it.lengthFt = parseInt(s.value,10);
        render();
      };
    });
    div.querySelectorAll('button[data-act]').forEach(b=>{
      b.onclick = ()=>{
        const act = b.dataset.act;
        if(act==='dup'){ items.splice(idx+1,0, structuredClone(it)); }
        if(act==='del'){ items.splice(idx,1); }
        if(act==='up' && idx>0){ [items[idx-1],items[idx]] = [items[idx],items[idx-1]]; }
        if(act==='down' && idx<items.length-1){ [items[idx+1],items[idx]] = [items[idx],items[idx+1]]; }
        if(act==='loss' && it.type==='acc'){
          const v = parseFloat(prompt('Accessory loss (psi):', String(it.loss))||String(it.loss));
          if(!isNaN(v)) it.loss = v;
        }
        if(act==='rename' && it.type==='acc'){
          const v = prompt('Accessory name:', it.name); if(v!==null) it.name = v||it.name;
        }
        render(true);
      };
    });
    return div;
  }

  function renderBuilder(){
    builderList.innerHTML = '';
    if(items.length===0){
      const e = document.createElement('div');
      e.className = 'item';
      e.innerHTML = `<div>Use the top controls to add **Hose**, **Accessory**, and apply a **Nozzle**.</div>`;
      builderList.appendChild(e);
    } else {
      items.forEach((it,i)=> builderList.appendChild(row(it,i)));
    }
  }

  // ---------- Math ----------
  function calcAndRenderMath(){
    const out = calc();
    document.getElementById('GPM').textContent = `${out.Q} gpm`;
    document.getElementById('PDP').textContent = `${Math.round(out.PDP)} psi`;

    const partsH = out.hoses.map(h=>`H${h.i}: ${h.size}″ ${h.lengthFt}′ → FL=${h.segFL.toFixed(1)} psi`).join(' • ');
    const partsA = out.accs.length ? (' • Acc: '+out.accs.map(a=>`${a.name}+${a.loss}`).join(', ')) : '';
    const elev = `Elev=${out.elevPsi.toFixed(1)} psi`;
    const np = `NP=${out.NP} psi`;
    const totalFL = `Total FL=${out.totalFL.toFixed(1)} psi`;
    const totalAcc = `Accessories=${out.totalAcc.toFixed(1)} psi`;
    document.getElementById('breakdown').textContent = `${np} • ${totalFL} • ${totalAcc} • ${elev}${partsH?(' • '+partsH):''}${partsA}`;
    document.getElementById('equation').textContent =
      `PDP = NP(${out.NP}) + FL(${out.totalFL.toFixed(1)}) + ACC(${out.totalAcc.toFixed(1)}) ${out.elevPsi>=0?'+':'-'} Elev(${Math.abs(out.elevPsi).toFixed(1)})`;
  }

  // ---------- Render all ----------
  function render(autoScroll=false){
    renderDiagram();
    renderBuilder();
    calcAndRenderMath();
    if(autoScroll){
      setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 0);
    }
  }

  // Initial render (if image cached, onload may not fire)
  if(engineImg.complete) render(true);
</script>
</body>
</html>
