<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pump Pressure — Visual Builder (ENGINE 181)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8;
    --edge:rgba(255,255,255,.14);
    --hose5:#ecd464; --hose25:#f2994a; --hose175:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  header{position:sticky;top:0;z-index:3;padding:8px 12px;background:linear-gradient(180deg,#0c1320 0%,#0b0f14 100%);border-bottom:1px solid var(--edge)}
  h1{font-size:15px;margin:0}
  .sub{font-size:11px;color:#9fb0c8}

  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge)}
  .scroll{height:65vh;overflow:auto;background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative;width:100%;min-height:520px}
  #engine{display:block;width:100%;height:auto;position:absolute;bottom:0;left:0}
  #overlay{position:absolute;inset:0;display:block;width:100%;height:100%}
  .hint{position:absolute;top:8px;left:10px;font-size:12px;color:#f7e39a}

  /* Left tools */
  .side{position:fixed;left:8px;top:72px;z-index:4;display:flex;flex-direction:column;gap:8px}
  .fab{width:44px;height:44px;border-radius:12px;border:1px solid var(--edge);background:#0b1320;color:#eaf2ff;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .fab:active{transform:translateY(1px)}
  .drawer{position:fixed;left:60px;top:72px;z-index:5;background:#0b1320;border:1px solid var(--edge);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.35);width:min(78vw,360px);max-width:360px;display:none}
  .drawer.open{display:block}
  .drawer h3{margin:10px 12px 6px;font-size:13px;color:#cfe4ff}
  .row{display:flex;flex-wrap:wrap;gap:8px;padding:8px 10px}
  .row button{background:#12203a;border:1px solid var(--edge);color:#eaf2ff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}

  /* Panels */
  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#9fb0c8;display:block;margin-bottom:4px}
  input{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
  .kpi b{font-size:20px}
  .note{font-size:12px;color:#9fb0c8}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{
    display:flex;justify-content:space-between;gap:10px;align-items:center;
    padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320;flex-wrap:wrap
  }
  .stats{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .actions select,.actions button{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:8px;padding:6px 8px;font-size:13px}

  /* Two responsive columns for branches */
  .col2{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:8px}
  @media (max-width:420px){ .col2{grid-template-columns:1fr;} }

  /* Build list color coding by hose size */
  .hose-5   { border-left:6px solid var(--hose5); }
  .hose-25  { border-left:6px solid var(--hose25); }
  .hose-175 { border-left:6px solid var(--hose175); }
</style>
</head>
<body>
<div class="app">

  <header>
    <h1>Pump Pressure — Visual Builder</h1>
    <div class="sub">Smart labels • Wye split • Phone-safe</div>
  </header>

  <div class="side">
    <button class="fab" id="openHose">Hose</button>
    <button class="fab" id="openAcc">Acc</button>
    <button class="fab" id="openNoz">Noz</button>
  </div>

  <!-- Hose drawer -->
  <div class="drawer" id="drawerHose" role="dialog" aria-label="Hose options">
    <h3>Hose segments</h3>
    <div class="row" id="hoseButtonsMain">
      <button data-hose='{"size":"5","lengthFt":100}'>5″ 100′</button>
      <button data-hose='{"size":"2.5","lengthFt":50}'>2½″ 50′</button>
      <button data-hose='{"size":"1.75","lengthFt":100}'>1¾″ 100′</button>
      <button data-hose='{"size":"1.75","lengthFt":50}'>1¾″ 50′</button>
      <button data-act="clearHose">Clear main hoses</button>
    </div>

    <!-- After Wye: 5" REMOVED; left choices shown first, right choices after -->
    <div class="row" id="hoseButtonsSplit" style="display:none;border-top:1px solid var(--edge);margin-top:6px;padding-top:12px">
      <div style="width:100%;color:#cfe4ff;font-size:12px;margin-bottom:2px">After Wye:</div>
      <!-- LEFT -->
      <button data-side="L" data-hose='{"size":"2.5","lengthFt":50}'>Left 2½″ 50′</button>
      <button data-side="L" data-hose='{"size":"1.75","lengthFt":100}'>Left 1¾″ 100′</button>
      <button data-side="L" data-hose='{"size":"1.75","lengthFt":50}'>Left 1¾″ 50′</button>
      <!-- RIGHT -->
      <button data-side="R" data-hose='{"size":"2.5","lengthFt":50}'>Right 2½″ 50′</button>
      <button data-side="R" data-hose='{"size":"1.75","lengthFt":100}'>Right 1¾″ 100′</button>
      <button data-side="R" data-hose='{"size":"1.75","lengthFt":50}'>Right 1¾″ 50′</button>
      <button data-act="clearBranches">Clear left/right</button>
    </div>
  </div>

  <!-- Accessory drawer -->
  <div class="drawer" id="drawerAcc" role="dialog" aria-label="Accessory options">
    <h3>Accessories</h3>
    <div class="row">
      <button data-acc='{"name":"In-line eductor","loss":25}'>In-line eductor (+25)</button>
      <button data-acc='{"name":"Master monitor","loss":25}'>Master monitor (+25)</button>
      <button data-acc='{"name":"Standpipe/PRV","loss":25}'>Standpipe/PRV (+25)</button>
      <button data-act="accCustom">Custom…</button>
      <button data-act="clearAcc">Clear accessories</button>
    </div>
    <h3 style="margin-top:4px">Split</h3>
    <div class="row">
      <button id="addWyeBtn">Wye/Siamese (split) +10 psi</button>
      <button id="removeWyeBtn">Remove Wye</button>
    </div>
  </div>

  <!-- Nozzle drawer -->
  <div class="drawer" id="drawerNoz" role="dialog" aria-label="Nozzle options">
    <h3>Left Nozzle</h3>
    <div class="row" id="nozRowLeft"></div>
    <h3>Right / Single Nozzle</h3>
    <div class="row" id="nozRowRight"></div>
  </div>

  <!-- Stage -->
  <div class="wrapper">
    <div id="scroll" class="scroll">
      <div id="stage" class="stage">
        <img id="engine" alt="ENGINE 181" src="https://fireopssim.com/pump/engine181.png" />
        <svg id="overlay" viewBox="0 0 390 800" preserveAspectRatio="none" aria-label="Diagram overlay">
          <g id="hoseGroup"></g>
          <g id="accGroup"></g>
          <g id="nozzleGroup"></g>
          <g id="portGroup"></g>
          <g id="labelGroup"></g>
          <text class="hint" id="hint">Tap Hose and add a segment…</text>
        </svg>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div class="panel">
    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Environment</h3>
      <div class="grid2">
        <div><label>Elevation (ft)</label><input id="elevFt" type="number" step="5" value="0" /></div>
        <div><label>Elevation factor (psi/ft)</label><input id="elevPsi" type="number" step="0.001" value="0.434" /></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Build List</h3>
      <div class="list" id="builderList"></div>
    </div>

    <div class="card">
      <div class="eq" id="equation">PDP = max(Left, Right) + Main FL + Main Acc ± Elev</div>
      <div class="kpis" style="margin-top:8px">
        <div class="kpi"><div>Flow</div><b id="GPM">— gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">— psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </div>

</div>

<script>
  // ===== CONFIG =====
  const STAGE_W = 390;
  const PX_PER_50FT = 80;
  const HOSE_X_RATIO = 0.49;   // anchor
  const ROOF_RATIO   = 0.71;   // anchor
  const HOSE_TOUCH_OFFSET = -6;
  const BRANCH_OFFSET = 34;    // px left/right spacing

  const HOSE_WIDTH = { "5": 12, "2.5": 9, "1.75": 6 };
  const HOSE_COLOR = { "5": "var(--hose5)", "2.5": "var(--hose25)", "1.75": "var(--hose175)" };
  const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };

  // Nozzles set
  const NOZZLES = [
    {name:"None (closed)", gpm:0, NP:0},
    {name:"Fog 150 gpm @100 psi", gpm:150, NP:100},
    {name:"ChiefXD 185 gpm @50 psi", gpm:185, NP:50},   // default
    {name:"ChiefXD 265 gpm @50 psi", gpm:265, NP:50},
    {name:"SB 7/8″ @50 psi",   gpm:161, NP:50},
    {name:"SB 15/16″ @50 psi", gpm:185, NP:50},
    {name:"SB 1″ @50 psi",     gpm:210, NP:50},
    {name:"SB 1 1/8″ @50 psi", gpm:265, NP:50},
    {name:"SB 1 1/4″ @50 psi", gpm:325, NP:50}
  ];

  // ===== STATE =====
  let itemsMain = [];   // up to the wye (hoses + accessories before split)
  let hasWye = false;
  let wyeLoss = 10;
  let itemsLeft = [];   // hoses after wye (left)
  let itemsRight = [];  // hoses after wye (right)

  // Default nozzles: ChiefXD 185@50
  let nozzleLeft = NOZZLES[2];
  let nozzleRight = NOZZLES[2];

  let elevFt = 0, elevPsiPerFt = 0.434;

  // ===== ELEMENTS =====
  const engineImg = document.getElementById('engine');
  const stage = document.getElementById('stage');
  const scrollEl = document.getElementById('scroll');
  const overlay = document.getElementById('overlay');
  const hoseGroup = document.getElementById('hoseGroup');
  const accGroup = document.getElementById('accGroup');
  const nozzleGroup = document.getElementById('nozzleGroup');
  const portGroup = document.getElementById('portGroup');
  const labelGroup = document.getElementById('labelGroup');
  const hint = document.getElementById('hint');
  const builderList = document.getElementById('builderList');

  // ===== DRAWERS =====
  const drawerHose = document.getElementById('drawerHose');
  const drawerAcc  = document.getElementById('drawerAcc');
  const drawerNoz  = document.getElementById('drawerNoz');
  function closeDrawers(){ drawerHose.classList.remove('open'); drawerAcc.classList.remove('open'); drawerNoz.classList.remove('open'); }
  document.getElementById('openHose').onclick = (e)=>{ e.stopPropagation(); toggleDrawer(drawerHose); };
  document.getElementById('openAcc').onclick  = (e)=>{ e.stopPropagation(); toggleDrawer(drawerAcc); };
  document.getElementById('openNoz').onclick  = (e)=>{ e.stopPropagation(); toggleDrawer(drawerNoz); };
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.drawer') && !e.target.closest('.fab')) closeDrawers(); });
  function toggleDrawer(el){ const was = el.classList.contains('open'); closeDrawers(); if(!was) el.classList.add('open'); }

  // Hose drawer behavior
  const hoseButtonsMain = document.getElementById('hoseButtonsMain');
  const hoseButtonsSplit = document.getElementById('hoseButtonsSplit');
  function refreshHoseDrawer(){ hoseButtonsSplit.style.display = hasWye ? 'flex' : 'none'; }
  hoseButtonsMain.querySelectorAll('button[data-hose]').forEach(btn=>{
    btn.onclick = ()=>{ itemsMain.push({type:'hose', ...JSON.parse(btn.dataset.hose)}); closeDrawers(); render(true); };
  });
  hoseButtonsMain.querySelector('[data-act="clearHose"]').onclick = ()=>{ itemsMain = itemsMain.filter(x=>x.type!=='hose'); closeDrawers(); render(true); };

  // After-wye: only 2.5 and 1.75 (no 5")
  hoseButtonsSplit.querySelectorAll('button[data-hose]').forEach(btn=>{
    btn.onclick = ()=>{
      const hose = {type:'hose', ...JSON.parse(btn.dataset.hose)};
      (btn.dataset.side==='L' ? itemsLeft : itemsRight).push(hose);
      closeDrawers(); render(true);
    };
  });
  hoseButtonsSplit.querySelector('[data-act="clearBranches"]').onclick = ()=>{ itemsLeft=[]; itemsRight=[]; closeDrawers(); render(true); };

  // Accessory drawer
  drawerAcc.querySelectorAll('button[data-acc]').forEach(btn=>{
    btn.onclick = ()=>{ const d=JSON.parse(btn.dataset.acc); itemsMain.push({type:'acc',name:d.name,loss:+d.loss||0}); closeDrawers(); render(true); };
  });
  drawerAcc.querySelector('[data-act="accCustom"]').onclick = ()=>{
    const name = prompt('Accessory name?','Appliance'); if(name===null) return;
    const loss = parseFloat(prompt('Pressure loss (psi)?','10')||'0');
    itemsMain.push({type:'acc', name:name||'Custom', loss:isNaN(loss)?0:loss});
    closeDrawers(); render(true);
  };
  drawerAcc.querySelector('[data-act="clearAcc"]').onclick = ()=>{ itemsMain = itemsMain.filter(x=>x.type!=='acc'); closeDrawers(); render(true); };
  document.getElementById('addWyeBtn').onclick = ()=>{ hasWye = true; wyeLoss = 10; refreshHoseDrawer(); closeDrawers(); render(true); };
  document.getElementById('removeWyeBtn').onclick = ()=>{ hasWye = false; itemsLeft=[]; itemsRight=[]; refreshHoseDrawer(); closeDrawers(); render(true); };

  // Nozzle drawer
  const nozRowLeft = document.getElementById('nozRowLeft');
  const nozRowRight = document.getElementById('nozRowRight');
  NOZZLES.forEach(n=>{
    const bL=document.createElement('button'); bL.textContent=`${n.name}`; bL.onclick=()=>{ nozzleLeft=n; closeDrawers(); render(false); }; nozRowLeft.appendChild(bL);
    const bR=document.createElement('button'); bR.textContent=`${n.name}`; bR.onclick=()=>{ nozzleRight=n; closeDrawers(); render(false); }; nozRowRight.appendChild(bR);
  });

  // Env inputs
  document.getElementById('elevFt').oninput = e=>{ elevFt = parseFloat(e.target.value||0); render(); };
  document.getElementById('elevPsi').oninput = e=>{ elevPsiPerFt = parseFloat(e.target.value||0); render(); };

  // ===== MATH =====
  function fl(C, Q, L){ return (C||0) * Math.pow(Q/100, 2) * (L/100); }
  function flForStack(hoses, Q){ return hoses.reduce((s,h)=> s + fl(COEFF[h.size]||0, Q, h.lengthFt||0), 0); }

  function calc(){
    const QL = nozzleLeft.gpm || 0;
    const QR = nozzleRight.gpm || 0;
    const Qtotal = hasWye ? (QL + QR) : QR;

    const FL_main = flForStack(itemsMain.filter(x=>x.type==='hose'), Qtotal);
    const ACC_main = itemsMain.filter(x=>x.type==='acc').reduce((s,a)=>s+(+a.loss||0),0) + (hasWye ? wyeLoss : 0);

    const FL_left  = hasWye ? flForStack(itemsLeft, QL) : 0;
    const FL_right = flForStack(hasWye ? itemsRight : [], QR);

    const NP_left  = hasWye ? (nozzleLeft.NP||0)  : 0;
    const NP_right = nozzleRight.NP||0;

    const elevPsi = elevFt * elevPsiPerFt;

    const PDP_left  = hasWye ? (NP_left  + FL_left  + elevPsi) : -Infinity;
    const PDP_right = NP_right + FL_right + elevPsi;

    const branchMax = hasWye ? Math.max(PDP_left, PDP_right) : PDP_right;
    const PDP_total = branchMax + FL_main + ACC_main;

    return {QL, QR, Qtotal, elevPsi, FL_main, ACC_main, FL_left, FL_right, NP_left, NP_right, PDP_left, PDP_right, PDP_total};
  }

  // ===== Helpers =====
  function stageWidthPx(){ return stage.clientWidth || window.innerWidth || 390; }
  function hoseXpx(){ return Math.round(stageWidthPx() * HOSE_X_RATIO); }
  function toVBX(px){ return px / stageWidthPx() * STAGE_W; }
  function toVBY(px){ return px; }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  // ===== Label helper with side-aware placement =====
  // side = 'right' (default) or 'left'
  function labelConsecutiveWithStats(list, x, yStart, Q, side='right'){
    let yCursor = yStart;
    let cur = null, totalFt=0, startY=yCursor, totalFL=0;

    const commit = ()=>{
      if(!cur || totalFt<=0) return;
      const mid = yCursor + (startY - yCursor)/2;
      const sizePretty = (cur==='2.5'?'2½':cur==='1.75'?'1¾':cur) + '″';
      const text = `${sizePretty} • ${Q} gpm • ${totalFt}′ • FL ${totalFL.toFixed(1)} psi`;

      // rough width estimate for bubble
      const estW = Math.max(100, text.length * 6.0);
      const pad = 6;
      const margin = 6;
      let bxPx;
      if(side==='left'){
        // place bubble to the LEFT of stack
        bxPx = (x - 16) - estW - pad*2; // 16px gap left of hose
        bxPx = clamp(bxPx, margin, stageWidthPx() - estW - pad*2 - margin);
      }else{
        // place bubble to the RIGHT of stack
        bxPx = (x + 16);
        bxPx = clamp(bxPx, margin, stageWidthPx() - estW - pad*2 - margin);
      }

      const byPx = mid - 10 - pad;

      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', toVBX(bxPx));
      rect.setAttribute('y', toVBY(byPx));
      rect.setAttribute('width', estW + pad*2);
      rect.setAttribute('height', 16 + pad*2);
      rect.setAttribute('rx', 6);
      rect.setAttribute('fill', '#172134');
      rect.setAttribute('stroke', 'rgba(255,255,255,.15)');
      labelGroup.appendChild(rect);

      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x', toVBX(bxPx + pad));
      tx.setAttribute('y', toVBY(byPx + pad + 13));
      tx.setAttribute('fill','#cfe4ff'); tx.setAttribute('font-size','10'); tx.textContent=text;
      labelGroup.appendChild(tx);

      cur=null; totalFt=0; totalFL=0; startY=yCursor;
    };

    for(const it of list){
      const hPx=(it.lengthFt===50?PX_PER_50FT:2*PX_PER_50FT);
      if(cur===null){ cur=it.size; totalFt=0; totalFL=0; startY=yCursor; }
      if(it.size!==cur){ commit(); cur=it.size; totalFt=0; totalFL=0; startY=yCursor; }
      yCursor -= hPx;
      totalFt += it.lengthFt;
      totalFL += fl(COEFF[it.size]||0, Q, it.lengthFt);
    }
    commit();
  }

  // ===== Draw diagram (with side-aware labels) =====
  function renderDiagram(){
    const nW = engineImg.naturalWidth || 0;
    const nH = engineImg.naturalHeight || 0;
    const eH = (nW && nH) ? (stageWidthPx() * (nH / nW)) : (engineImg.clientHeight || 180);

    const hoseFeetMain = itemsMain.filter(x=>x.type==='hose').reduce((s,h)=>s+h.lengthFt,0);
    const hoseFeetLeft = itemsLeft.reduce((s,h)=>s+h.lengthFt,0);
    const hoseFeetRight= itemsRight.reduce((s,h)=>s+h.lengthFt,0);
    const hosePx = ((hoseFeetMain+hoseFeetLeft+hoseFeetRight)/50)*PX_PER_50FT;
    const topPad = 160;

    const stageH = Math.max(520, eH + hosePx + topPad);
    stage.style.height = stageH + 'px';
    overlay.setAttribute('viewBox', `0 0 ${STAGE_W} ${Math.round(stageH)}`);

    const imageTopPx = stageH - eH;
    const roofY = imageTopPx + (eH * ROOF_RATIO);
    const xMain = hoseXpx();
    const xLeft = xMain - BRANCH_OFFSET;
    const xRight= xMain + BRANCH_OFFSET;

    let y = roofY + HOSE_TOUCH_OFFSET;

    hoseGroup.innerHTML=''; accGroup.innerHTML=''; nozzleGroup.innerHTML=''; portGroup.innerHTML=''; labelGroup.innerHTML='';

    // port ring
    const port=document.createElementNS('http://www.w3.org/2000/svg','circle');
    port.setAttribute('cx', toVBX(xMain)); port.setAttribute('cy', toVBY(roofY)); port.setAttribute('r', toVBX(6));
    port.setAttribute('fill','#2b3142'); port.setAttribute('stroke','#111622'); port.setAttribute('stroke-width','1.5'); portGroup.appendChild(port);

    // MAIN up to Wye
    for(const it of itemsMain){
      if(it.type==='hose'){
        const hPx = (it.lengthFt===50?PX_PER_50FT:2*PX_PER_50FT), wPx=HOSE_WIDTH[it.size]||6;
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', toVBX(xMain-wPx/2)); rect.setAttribute('y', toVBY(y-hPx));
        rect.setAttribute('width', toVBX(wPx)); rect.setAttribute('height', toVBY(hPx));
        rect.setAttribute('fill', HOSE_COLOR[it.size]); rect.setAttribute('stroke','rgba(255,255,255,.1)'); rect.setAttribute('stroke-width','1'); hoseGroup.appendChild(rect);
        y -= hPx;
      } else {
        const bg=document.createElementNS('http://www.w3.org/2000/svg','rect');
        bg.setAttribute('x', toVBX(xMain+10)); bg.setAttribute('y', toVBY(y-18)); bg.setAttribute('width', 120); bg.setAttribute('height', 18);
        bg.setAttribute('rx',6); bg.setAttribute('fill','#172134'); bg.setAttribute('stroke','rgba(255,255,255,.15)'); accGroup.appendChild(bg);
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', toVBX(xMain+16)); t.setAttribute('y', toVBY(y-6)); t.setAttribute('fill','#cfe4ff'); t.setAttribute('font-size','10');
        t.textContent=`${it.name} (+${it.loss} psi)`; accGroup.appendChild(t);
        y -= 22;
      }
    }

    // Labels for MAIN (use total flow, placed to RIGHT)
    const flows = calc();
    labelConsecutiveWithStats(itemsMain.filter(x=>x.type==='hose'), xMain, roofY + HOSE_TOUCH_OFFSET, flows.Qtotal, 'right');

    // WYE + branches
    if(hasWye){
      const wy=document.createElementNS('http://www.w3.org/2000/svg','path');
      wy.setAttribute('d', `M ${toVBX(xMain)} ${toVBY(y-8)} L ${toVBX(xLeft)} ${toVBY(y-28)} M ${toVBX(xMain)} ${toVBY(y-8)} L ${toVBX(xRight)} ${toVBY(y-28)}`);
      wy.setAttribute('stroke','#8aa0c4'); wy.setAttribute('stroke-width','3'); wy.setAttribute('fill','none'); hoseGroup.appendChild(wy);
      const wlabel=document.createElementNS('http://www.w3.org/2000/svg','text');
      wlabel.setAttribute('x', toVBX(xMain+16)); wlabel.setAttribute('y', toVBY(y-14)); wlabel.setAttribute('fill','#cfe4ff'); wlabel.setAttribute('font-size','10');
      wlabel.textContent=`Wye (+${wyeLoss} psi)`; accGroup.appendChild(wlabel);

      const yStart = y-30;
      drawBranch(itemsLeft,  xLeft,  yStart, flows.QL,  'left');
      drawBranch(itemsRight, xRight, yStart, flows.QR, 'right');
    } else {
      // single branch nozzle only (use right)
      drawBranch([], xMain, y, flows.QR, 'right');
    }

    // Branch drawer
    function drawBranch(list, x, yStart, Qbranch, side){
      let yB = yStart;
      for(const it of list){
        const hPx=(it.lengthFt===50?PX_PER_50FT:2*PX_PER_50FT), wPx=HOSE_WIDTH[it.size]||6;
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', toVBX(x-wPx/2)); rect.setAttribute('y', toVBY(yB-hPx));
        rect.setAttribute('width', toVBX(wPx)); rect.setAttribute('height', toVBY(hPx));
        rect.setAttribute('fill', HOSE_COLOR[it.size]); rect.setAttribute('stroke','rgba(255,255,255,.1)'); rect.setAttribute('stroke-width','1'); hoseGroup.appendChild(rect);
        yB -= hPx;
      }

      // Labels for this branch (side-aware)
      labelConsecutiveWithStats(list, x, yStart, Qbranch, side);

      // nozzle stub  (SVG namespace fixed below)
      const last = list.slice(-1)[0];
      const wTopPx = last ? (HOSE_WIDTH[last.size]||6) : 8;
      const body=document.createElementNS('http://www.w3.org/2000/svg','rect');
      body.setAttribute('x', toVBX(x - wTopPx/2 - 4)); body.setAttribute('y', toVBY(yB - 22));
      body.setAttribute('width', toVBX(wTopPx + 8)); body.setAttribute('height', toVBY(18));
      body.setAttribute('fill','#394357'); nozzleGroup.appendChild(body);

      const tip=document.createElementNS('http://www.w3.org/2000/svg','rect');
      tip.setAttribute('x', toVBX(x - (wTopPx*0.4))); tip.setAttribute('y', toVBY(yB - 30));
      tip.setAttribute('width', toVBX(wTopPx*0.8)); tip.setAttribute('height', toVBY(8));
      tip.setAttribute('fill','#9aa7bd'); nozzleGroup.appendChild(tip);

      // nozzle label (GPM @ NP), side-aware placement & clamped  (SVG namespace fixed below)
      const NPtxt = (hasWye && side==='left') ? (nozzleLeft.NP||0)
                  : (hasWye && side==='right') ? (nozzleRight.NP||0)
                  : (nozzleRight.NP||0);
      const text = `${Qbranch} gpm @ ${NPtxt} psi`;
      const estW = Math.max(90, text.length*6.0);
      const pad=6, margin=6;
      let nx;
      if(side==='left'){
        nx = clamp((x - 16) - estW - pad*2, margin, stageWidthPx() - estW - pad*2 - margin);
      }else{
        nx = clamp((x + 16), margin, stageWidthPx() - estW - pad*2 - margin);
      }
      const ny = (yB - 28) - pad;

      const nzb=document.createElementNS('http://www.w3.org/2000/svg','rect');
      nzb.setAttribute('x', toVBX(nx)); nzb.setAttribute('y', toVBY(ny));
      nzb.setAttribute('width', estW+pad*2); nzb.setAttribute('height', 16+pad*2);
      nzb.setAttribute('rx',6); nzb.setAttribute('fill','#172134'); nzb.setAttribute('stroke','rgba(255,255,255,.15)');
      labelGroup.appendChild(nzb);

      const nz=document.createElementNS('http://www.w3.org/2000/svg','text');
      nz.setAttribute('x', toVBX(nx + pad)); nz.setAttribute('y', toVBY(ny + pad + 13));
      nz.setAttribute('fill','#cfe4ff'); nz.setAttribute('font-size','10'); nz.textContent = text;
      labelGroup.appendChild(nz);
    }

    // Footer total PDP & GPM centered near bottom of stage
    const footer=document.createElementNS('http://www.w3.org/2000/svg','text');
    footer.setAttribute('x', toVBX(STAGE_W/2)); footer.setAttribute('y', toVBY(stageH - 8));
    footer.setAttribute('text-anchor','middle'); footer.setAttribute('fill','#d7e7ff'); footer.setAttribute('font-size','12');
    footer.textContent = `Total: ${Math.round(flows.PDP_total)} psi PDP • ${hasWye ? (flows.QL + flows.QR) : flows.QR} gpm`;
    labelGroup.appendChild(footer);
  }

  // ===== Build list (left in left column, right in right column) =====
  function rowClassForSize(size){
    if(size==='5') return 'hose-5';
    if(size==='2.5') return 'hose-25';
    if(size==='1.75') return 'hose-175';
    return '';
  }
  function builderRowHose(h, idx, where, Q_for_this_row){
    const div=document.createElement('div'); div.className='item ' + rowClassForSize(h.size);
    const segFL = fl(COEFF[h.size]||0, Q_for_this_row, h.lengthFt);
    div.innerHTML = `
      <div><div>🧯 ${where} Hose <small>#${idx+1}</small></div>
      <div class="note">${h.size}″ • ${h.lengthFt}′</div></div>
      <div class="actions">
        <span class="note">FL ${segFL.toFixed(1)} psi</span>
        <span class="note">GPM ${Q_for_this_row}</span>
        <select data-k="size">
          <option value="5" ${h.size==='5'?'selected':''}>5″</option>
          <option value="2.5" ${h.size==='2.5'?'selected':''}>2½″</option>
          <option value="1.75" ${h.size==='1.75'?'selected':''}>1¾″</option>
        </select>
        <select data-k="lengthFt">
          <option value="50" ${h.lengthFt===50?'selected':''}>50′</option>
          <option value="100" ${h.lengthFt===100?'selected':''}>100′</option>
        </select>
        <button data-act="del">✕</button>
      </div>`;
    // Prevent 5" from being selected on branches
    if(where==='Left' || where==='Right'){
      const sizeSel = div.querySelector('select[data-k="size"]');
      [...sizeSel.options].forEach(opt=>{
        if(opt.value==='5') opt.disabled = true;
      });
    }
    div.querySelectorAll('select').forEach(s=>{
      s.onchange=()=>{ const k=s.dataset.k; if(k==='size') h.size=s.value; if(k==='lengthFt') h.lengthFt=parseInt(s.value,10); render(); };
    });
    div.querySelector('[data-act="del"]').onclick=()=>{ const arr=(where==='Left'?itemsLeft:(where==='Right'?itemsRight:itemsMain)); arr.splice(idx,1); render(true); };
    return div;
  }
  function builderRowAcc(a, idx){
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div><div>⚙️ Main Accessory <small>#${idx+1}</small></div><div class="note">${a.name} • +${a.loss} psi</div></div>
      <div class="actions"><button data-act="loss">Loss</button><button data-act="rename">Name</button><button data-act="del">✕</button></div>`;
    div.querySelector('[data-act="del"]').onclick=()=>{ itemsMain.splice(idx,1); render(true); };
    div.querySelector('[data-act="loss"]').onclick=()=>{ const v=parseFloat(prompt('Accessory loss (psi):', String(a.loss))||String(a.loss)); if(!isNaN(v)) a.loss=v; render(); };
    div.querySelector('[data-act="rename"]').onclick=()=>{ const v=prompt('Accessory name:', a.name); if(v!==null) a.name=v||a.name; render(); };
    return div;
  }
  function renderBuilder(){
    builderList.innerHTML='';
    const R = calc();

    if(itemsMain.length===0 && !hasWye && itemsLeft.length===0 && itemsRight.length===0){
      const e=document.createElement('div'); e.className='item';
      e.innerHTML='<div>Use the left tools: add <b>Hose</b>, add <b>Accessory</b> or <b>Wye</b>, then pick <b>Nozzles</b>.</div>';
      builderList.appendChild(e); return;
    }

    // Main (uses total flow)
    const mainHead=document.createElement('div'); mainHead.className='item';
    mainHead.innerHTML=`<div><b>Main line (to Wye)</b> <span class="note">GPM ${R.Qtotal}</span></div>`;
    builderList.appendChild(mainHead);
    itemsMain.forEach((it,i)=>{
      if(it.type==='hose') builderList.appendChild(builderRowHose(it,i,'Main', R.Qtotal));
      else builderList.appendChild(builderRowAcc(it,i));
    });

    if(hasWye){
      const splitHead=document.createElement('div'); splitHead.className='item';
      splitHead.innerHTML=`<div><b>Wye/Siamese</b> <span class="note">+${wyeLoss} psi • Left ${R.QL} gpm • Right ${R.QR} gpm</span></div>`;
      builderList.appendChild(splitHead);

      // Left column strictly left, Right strictly right (responsive)
      const cols=document.createElement('div'); cols.className='col2';
      const leftCol=document.createElement('div'); const rightCol=document.createElement('div');
      leftCol.innerHTML=`<div class="note">Left branch (GPM ${R.QL})</div>`;
      rightCol.innerHTML=`<div class="note">Right branch (GPM ${R.QR})</div>`;
      itemsLeft.forEach((h,i)=> leftCol.appendChild(builderRowHose(h,i,'Left', R.QL)));
      itemsRight.forEach((h,i)=> rightCol.appendChild(builderRowHose(h,i,'Right', R.QR)));
      cols.appendChild(leftCol); cols.appendChild(rightCol); builderList.appendChild(cols);
    }
  }

  // ===== KPIs =====
  function calcAndRenderMath(){
    const R = calc();
    const flowLabel = hasWye ? `${R.QL}+${R.QR} = ${R.Qtotal} gpm` : `${R.QR} gpm`;
    document.getElementById('GPM').textContent = flowLabel;
    document.getElementById('PDP').textContent = `${Math.round(R.PDP_total)} psi`;
    const parts = [
      `Main FL=${R.FL_main.toFixed(1)}`,
      `Main Acc=${R.ACC_main.toFixed(1)}`,
      hasWye?`Left PDP=${Math.round(R.PDP_left)}`:null,
      `Right PDP=${Math.round(R.PDP_right)}`,
      `Elev=${R.elevPsi.toFixed(1)}`
    ].filter(Boolean).join(' • ');
    document.getElementById('breakdown').textContent = parts;
    document.getElementById('equation').textContent =
      `PDP = max(Left:${hasWye?Math.round(R.PDP_left):'—'}, Right:${Math.round(R.PDP_right)}) + Main FL(${R.FL_main.toFixed(1)}) + Main Acc(${R.ACC_main.toFixed(1)})`;
  }

  // ===== Master render =====
  function render(autoScroll=false){
    refreshHoseDrawer();
    renderDiagram();
    renderBuilder();
    calcAndRenderMath();
    if(autoScroll){ setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 0); }
  }

  if(engineImg.complete) render(true);
  engineImg.onload = ()=> render(true);
  window.addEventListener('resize', ()=> render(false));
</script>
</body>
</html>
