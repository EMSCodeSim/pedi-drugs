<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pump Pressure â€” Visual Builder (ENGINE 181)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8;
    --edge:rgba(255,255,255,.10); --accent:#49a3ff;
    --hose5:#f1d76a; --hose25:#f7a25a; --hose175:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}
  header{padding:14px 16px 10px;background:linear-gradient(180deg,#0c1320 0%,#0b0f14 100%);border-bottom:1px solid var(--edge);position:sticky;top:0;z-index:3;display:flex;justify-content:space-between;gap:10px;align-items:center}
  h1{margin:4px 0 2px;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .btn{background:#0b1320;border:1px solid var(--edge);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .menu{position:relative}
  .menu-panel{position:absolute;top:44px;right:0;background:#0b1320;border:1px solid var(--edge);border-radius:10px;overflow:hidden;display:none;min-width:200px;z-index:5}
  .menu.open .menu-panel{display:block}
  .menu-panel button{display:block;width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;color:var(--ink);font-size:14px}
  .menu-panel button:hover{background:#101c30}

  .canvas{position:relative;background:linear-gradient(180deg,#0b0f14,#0e1726);border-bottom:1px solid var(--edge)}
  .scroll{height:60vh; overflow-y:auto; overscroll-behavior:contain; border-top:1px solid var(--edge)}
  svg{width:100%; display:block}

  .controls{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320}
  .item small{color:var(--muted)}
  .actions{display:flex;gap:6px;align-items:center}
  input,select{background:#0b1320;color:var(--ink);border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .eq{font-family:ui-monospace,Menlo,monospace;color:#cfe4ff;font-size:13px;line-height:1.35}
  .kpis{display:flex;flex-wrap:wrap;gap:10px}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
  .kpi b{font-size:20px}
  .note{font-size:12px;color:#9fb0c8}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Pump Pressure â€” Visual Builder</h1>
      <div class="sub">ENGINE 181 image from fireopssim.com â€¢ Straight-up hose segments</div>
    </div>
    <div class="menu" id="addMenu">
      <button class="btn" id="addBtn">âž• Add</button>
      <div class="menu-panel" id="addPanel">
        <button data-add="hose">Hose segment (5â€³ / 2Â½â€³ / 1Â¾â€³ â€¢ 50â€² or 100â€²)</button>
        <button data-add="nozzle">Nozzleâ€¦ (incl. Chief XD)</button>
        <button data-add="clear">Clear all</button>
      </div>
    </div>
  </header>

  <!-- Visual diagram -->
  <div class="canvas">
    <div id="scroll" class="scroll">
      <!-- Height of this SVG grows with hose length; engine stays at bottom -->
      <svg id="stage" viewBox="0 0 390 800" height="800" preserveAspectRatio="xMidYMid slice" aria-label="Pump diagram">
        <!-- Engine 181 (bottom) -->
        <image id="truckImg" href="https://fireopssim.com/pump/engine181.png" x="10" y="700" width="260" height="120" />

        <!-- Hose column right above the engine (straight up) -->
        <g id="hoseGroup"></g>

        <!-- Nozzle marker at top of the stack -->
        <g id="nozzleGroup"></g>

        <!-- Labels -->
        <text x="12" y="18" fill="#f7e39a" font-size="10" id="infoLabel">Add a hose segment to beginâ€¦</text>
      </svg>
    </div>
  </div>

  <!-- Builder + Math -->
  <div class="controls">
    <div class="card">
      <div class="note">Order: Engine (bottom) âžœ Hose segments stacked upward âžœ Nozzle at the very top</div>
      <div class="list" id="builderList"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Environment & Nozzle</h3>
      <div class="grid2">
        <div>
          <label>Elevation (ft)</label>
          <input id="elevFt" type="number" step="5" value="0" />
        </div>
        <div>
          <label>Elevation factor (psi/ft)</label>
          <input id="elevPsi" type="number" step="0.001" value="0.434" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Nozzle (sets GPM & NP)</label>
        <select id="nozzleSelect"></select>
      </div>
    </div>

    <div class="card">
      <div class="eq" id="equation">PDP = NP + Î£FL(hose @ GPM) Â± Elev</div>
      <div class="kpis" style="margin-top:8px">
        <div class="kpi"><div>Flow</div><b id="GPM">â€” gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">â€” psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
  // ---------- Config ----------
  // pixels per 50â€² segment (visual scale)
  const PX_PER_50FT = 90;

  // Hose widths (in pixels)
  const HOSE_WIDTH = { "5": 26, "2.5": 16, "1.75": 12 };
  const HOSE_COLOR = { "5": "var(--hose5)", "2.5": "var(--hose25)", "1.75": "var(--hose175)" };

  // Friction loss: FL = C * (Q/100)^2 * (L/100)
  const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };

  // Nozzles (incl. Chief XD)
  const NOZZLES = [
    {name:"None (closed)", gpm:0, NP:0},
    {name:"Fog 95", gpm:95, NP:100},
    {name:"Fog 125", gpm:125, NP:100},
    {name:"Fog 150", gpm:150, NP:100},
    {name:'SB 7/8â€³', gpm:160, NP:50},
    {name:'SB 15/16â€³', gpm:185, NP:50},
    {name:'SB 1â€³', gpm:210, NP:50},
    {name:"ChiefXD 100 @50", gpm:100, NP:50},
    {name:"ChiefXD 150 @50", gpm:150, NP:50},
    {name:"ChiefXD 150 @75", gpm:150, NP:75},
    {name:"ChiefXD 185 @75", gpm:185, NP:75}
  ];

  // ---------- State ----------
  // Hose segments: {size: '5'|'2.5'|'1.75', lengthFt: 50|100}
  let segments = [];
  let nozzle = NOZZLES[3]; // Fog 150 default
  let elevFt = 0, elevPsiPerFt = 0.434;

  // ---------- Init ----------
  const addMenu = document.getElementById('addMenu');
  const addPanel = document.getElementById('addPanel');
  const scrollEl = document.getElementById('scroll');
  const stage = document.getElementById('stage');
  const hoseGroup = document.getElementById('hoseGroup');
  const nozzleGroup = document.getElementById('nozzleGroup');
  const infoLabel = document.getElementById('infoLabel');

  document.getElementById('addBtn').onclick = ()=> addMenu.classList.toggle('open');
  document.addEventListener('click', (e)=>{ if(!addMenu.contains(e.target)) addMenu.classList.remove('open'); });

  addPanel.querySelectorAll('button').forEach(b=>{
    b.onclick = ()=>{
      const what = b.dataset.add;
      if(what==='hose'){
        // default: 1Â¾â€³ @ 100â€²
        segments.push({size:'1.75', lengthFt:100});
        render(true); // auto-scroll after add
      } else if(what==='nozzle'){
        pickNozzle();
      } else if(what==='clear'){
        segments = [];
        render(true);
      }
      addMenu.classList.remove('open');
    };
  });

  // Populate nozzle select
  const nozSel = document.getElementById('nozzleSelect');
  NOZZLES.forEach(n=>{
    const o = document.createElement('option');
    o.value = n.name; o.textContent = `${n.name} (${n.gpm} gpm, NP ${n.NP})`;
    nozSel.appendChild(o);
  });
  nozSel.value = nozzle.name;
  nozSel.onchange = ()=>{
    const found = NOZZLES.find(n=>n.name===nozSel.value);
    if(found){ nozzle = found; render(); }
  };

  // Environment inputs
  document.getElementById('elevFt').oninput = e=>{ elevFt = parseFloat(e.target.value||0); render(); };
  document.getElementById('elevPsi').oninput = e=>{ elevPsiPerFt = parseFloat(e.target.value||0); render(); };

  // ---------- Math ----------
  function fl(C, Q, L){ return (C||0) * Math.pow(Q/100, 2) * (L/100); } // psi
  function calc(){
    const Q = nozzle.gpm || 0;
    const NP = nozzle.NP || 0;

    let totalFL = 0;
    const parts = [];
    segments.forEach((s, idx)=>{
      const C = COEFF[s.size] || 0;
      const segFL = fl(C, Q, s.lengthFt);
      totalFL += segFL;
      parts.push({i:idx+1, size:s.size, lengthFt:s.lengthFt, C, segFL});
    });

    const elevPsi = elevFt * elevPsiPerFt;
    const PDP = NP + totalFL + elevPsi;

    return {Q, NP, elevPsi, PDP, parts};
  }

  // ---------- Diagram ----------
  // Engine geometry (positioned at bottom)
  const engine = { x:10, width:260, height:120, bottomPad: -10 };
  function engineTopY(svgHeight){
    const y = svgHeight - engine.height + engine.bottomPad - 5; // engine <image> y
    return y; // top of engine image (hose exits above this)
  }
  function hoseX(){
    // Straight up from somewhere near pump panel; tweak as needed
    return engine.x + 210; // right side of the truck image
  }

  function renderDiagram(){
    // Determine stage height: base + total hose pixels
    const totalFeet = segments.reduce((s,seg)=> s + seg.lengthFt, 0);
    const hosePx = (totalFeet/50) * PX_PER_50FT;
    const base = 180 + engine.height; // space above engine
    const svgH = Math.max( engine.height + 220, engine.height + hosePx + base );
    stage.setAttribute('height', svgH);
    stage.setAttribute('viewBox', `0 0 390 ${svgH}`);

    // Place engine at bottom
    const engY = svgH - engine.height + engine.bottomPad - 5;
    const truckImg = document.getElementById('truckImg');
    truckImg.setAttribute('x', engine.x);
    truckImg.setAttribute('y', engY);
    truckImg.setAttribute('width', engine.width);
    truckImg.setAttribute('height', engine.height);

    // Draw hose segments straight up
    hoseGroup.innerHTML = '';
    nozzleGroup.innerHTML = '';

    if(segments.length===0){
      infoLabel.textContent = 'Add a hose segment to beginâ€¦';
      return;
    }

    const x = hoseX();
    // Center hose by width
    let currentTop = engY; // start at engine top
    const couplingStroke = '#2b3242';

    segments.forEach((s, idx)=>{
      const w = HOSE_WIDTH[s.size] || 12;
      const h = (s.lengthFt===50 ? PX_PER_50FT : 2*PX_PER_50FT);
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x - w/2);
      rect.setAttribute('y', currentTop - h);
      rect.setAttribute('width', w);
      rect.setAttribute('height', h);
      rect.setAttribute('fill', HOSE_COLOR[s.size] || 'goldenrod');
      rect.setAttribute('stroke', 'rgba(255,255,255,.08)');
      rect.setAttribute('stroke-width', '1');
      hoseGroup.appendChild(rect);

      // Coupling line at the top of each segment
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x - w/2); line.setAttribute('x2', x + w/2);
      line.setAttribute('y1', currentTop - h); line.setAttribute('y2', currentTop - h);
      line.setAttribute('stroke', couplingStroke);
      line.setAttribute('stroke-width', '2');
      hoseGroup.appendChild(line);

      currentTop -= h;
    });

    // Nozzle at very top
    const noz = document.createElementNS('http://www.w3.org/2000/svg','g');
    const topY = currentTop - 10;
    const wTop = HOSE_WIDTH[segments[segments.length-1].size] || 12;

    // simple nozzle glyph
    const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', x - wTop/2 - 4);
    body.setAttribute('y', topY - 18);
    body.setAttribute('width', wTop + 8);
    body.setAttribute('height', 18);
    body.setAttribute('fill', '#394357');
    nozzleGroup.appendChild(body);

    const tip = document.createElementNS('http://www.w3.org/2000/svg','rect');
    tip.setAttribute('x', x - (wTop*0.4));
    tip.setAttribute('y', topY - 28);
    tip.setAttribute('width', wTop*0.8);
    tip.setAttribute('height', 10);
    tip.setAttribute('fill', '#9aa7bd');
    nozzleGroup.appendChild(tip);

    infoLabel.textContent = `Total hose: ${totalFeet}â€² â€¢ Segments: ${segments.length}`;
  }

  // ---------- Builder UI ----------
  function builderRow(s, idx){
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>
        <div>ðŸ§¯ Segment <small>#${idx+1}</small></div>
        <div class="note">Straight up from engine</div>
      </div>
      <div class="actions">
        <label style="display:flex;flex-direction:column">
          <span style="font-size:12px;color:#9fb0c8">Size</span>
          <select data-k="size">
            <option value="5"   ${s.size==='5'?'selected':''}>5â€³ LDH</option>
            <option value="2.5" ${s.size==='2.5'?'selected':''}>2Â½â€³</option>
            <option value="1.75" ${s.size==='1.75'?'selected':''}>1Â¾â€³</option>
          </select>
        </label>
        <label style="display:flex;flex-direction:column">
          <span style="font-size:12px;color:#9fb0c8">Length</span>
          <select data-k="lengthFt">
            <option value="50"  ${s.lengthFt===50?'selected':''}>50â€²</option>
            <option value="100" ${s.lengthFt===100?'selected':''}>100â€²</option>
          </select>
        </label>
        <button class="btn" data-act="dup">ï¼‹</button>
        <button class="btn" data-act="up">â†‘</button>
        <button class="btn" data-act="down">â†“</button>
        <button class="btn" data-act="del">âœ•</button>
      </div>
    `;
    // field handlers
    row.querySelectorAll('select').forEach(el=>{
      el.onchange = ()=>{
        const k = el.dataset.k;
        if(k==='size') s.size = el.value;
        if(k==='lengthFt') s.lengthFt = parseInt(el.value,10);
        render();
      };
    });
    // row actions
    row.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.onclick = ()=>{
        const act = btn.dataset.act;
        if(act==='del'){ segments.splice(idx,1); }
        if(act==='dup'){ segments.splice(idx+1,0,{...segments[idx]}); }
        if(act==='up' && idx>0){ [segments[idx-1],segments[idx]] = [segments[idx],segments[idx-1]]; }
        if(act==='down' && idx<segments.length-1){ [segments[idx+1],segments[idx]] = [segments[idx],segments[idx+1]]; }
        render(true);
      };
    });
    return row;
  }

  function renderBuilder(){
    const list = document.getElementById('builderList');
    list.innerHTML = '';
    if(segments.length===0){
      const empty = document.createElement('div');
      empty.className = 'item';
      empty.innerHTML = `<div>Add hose segments from the âž• Add menu to start building the line.</div>`;
      list.appendChild(empty);
    } else {
      segments.forEach((s,i)=> list.appendChild(builderRow(s,i)));
    }
  }

  // ---------- Math panel ----------
  function renderMath(){
    const out = calc();
    document.getElementById('GPM').textContent = `${out.Q} gpm`;
    document.getElementById('PDP').textContent = `${Math.round(out.PDP)} psi`;

    const parts = out.parts.map(p=>`S${p.i}: ${p.size}â€³, ${p.lengthFt}â€² â†’ FL=${p.segFL.toFixed(1)} psi`).join(' â€¢ ');
    const np = `NP=${out.NP} psi`;
    const elev = `Elev=${out.elevPsi.toFixed(1)} psi`;
    const totalFL = `Total FL=${out.parts.reduce((s,a)=>s+a.segFL,0).toFixed(1)} psi`;
    document.getElementById('breakdown').textContent =
      `${np} â€¢ ${totalFL} â€¢ ${elev}${parts?(' â€¢ '+parts):''}`;
  }

  // ---------- Nozzle quick picker (fallback prompt) ----------
  function pickNozzle(){
    const list = NOZZLES.map(n=>n.name).join(', ');
    const sel = prompt(`Pick nozzle:\n${list}\n(current: ${nozzle.name})`, nozzle.name);
    const found = NOZZLES.find(n=> n.name.toLowerCase() === String(sel||'').toLowerCase());
    if(found){ nozzle = found; document.getElementById('nozzleSelect').value = nozzle.name; render(); }
  }

  // ---------- Render all ----------
  function render(autoScroll=false){
    renderBuilder();
    renderDiagram();
    renderMath();
    if(autoScroll){
      // keep engine in view when adding/duplicating/removing
      setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 0);
    }
  }

  // initial draw
  render(true);
</script>
</body>
</html>
