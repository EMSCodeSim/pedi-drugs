<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pump Pressure ‚Äî Visual Builder (ENGINE 181)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8;
    --edge:rgba(255,255,255,.14);
    --hose5:#ecd464; --hose25:#f2994a; --hose175:#ff6b6b;
    --bubble:#172134; --bubble-edge:rgba(255,255,255,.15);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  header{position:sticky;top:0;z-index:3;padding:8px 12px;background:linear-gradient(180deg,#0c1320 0%,#0b0f14 100%);border-bottom:1px solid var(--edge)}
  h1{font-size:15px;margin:0}
  .sub{font-size:11px;color:#9fb0c8}

  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge)}
  .scroll{height:65vh;overflow:auto;background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative;width:100%;min-height:520px}
  #engine{display:block;width:100%;height:auto;position:absolute;bottom:0;left:0}
  #overlay{position:absolute;inset:0;display:block;width:100%;height:100%}
  .hint{position:absolute;top:8px;left:10px;font-size:12px;color:#f7e39a}

  /* Line selector bar UNDER the truck */
  .linebar{
    position:absolute;left:0;right:0;bottom:8px;
    display:flex;justify-content:center;gap:8px;z-index:6;
    pointer-events:none;
  }
  .linebtn{
    pointer-events:auto;
    background:#0b1320;border:1px solid var(--edge);color:#eaf2ff;
    border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.35)
  }
  .linebtn.active{outline:2px solid #4fa3ff}

  .side{position:fixed;left:8px;top:72px;z-index:4;display:flex;flex-direction:column;gap:8px}
  .fab{width:44px;height:44px;border-radius:12px;border:1px solid var(--edge);background:#0b1320;color:#eaf2ff;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .fab:active{transform:translateY(1px)}
  .drawer{position:fixed;left:60px;top:72px;z-index:5;background:#0b1320;border:1px solid var(--edge);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.35);width:min(78vw,360px);max-width:360px;display:none}
  .drawer.open{display:block}
  .drawer h3{margin:10px 12px 6px;font-size:13px;color:#cfe4ff}
  .row{display:flex;flex-wrap:wrap;gap:8px;padding:8px 10px}
  .row button{background:#12203a;border:1px solid var(--edge);color:#eaf2ff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}

  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#9fb0c8;display:block;margin-bottom:4px}
  input{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
  .kpi b{font-size:20px}
  .note{font-size:12px;color:#9fb0c8}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{
    display:flex;justify-content:space-between;gap:10px;align-items:center;
    padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320;flex-wrap:wrap
  }
  .actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .actions select,.actions button{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:8px;padding:6px 8px;font-size:13px}

  .col2{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:8px}
  @media (max-width:420px){ .col2{grid-template-columns:1fr;} }

  .hose-5   { border-left:6px solid var(--hose5); }
  .hose-25  { border-left:6px solid var(--hose25); }
  .hose-175 { border-left:6px solid var(--hose175); }

  /* Discharge visuals */
  .hose-end{pointer-events:all; cursor:pointer}
  .plus-circle{fill:#fff; stroke:#111; stroke-width:1.5; filter:drop-shadow(0 2px 4px rgba(0,0,0,.45))}
  .plus-sign{stroke:#111; stroke-width:3; stroke-linecap:round}

  .picker{position:absolute; background:#0b1320; border:1px solid var(--bubble-edge); border-radius:12px; min-width:230px; padding:8px; z-index:7; box-shadow:0 18px 40px rgba(0,0,0,.45); display:none}
  .picker h3{font-size:12px; color:#cfe4ff; margin:4px 8px 8px}
  .picker-grid{display:grid; grid-template-columns:1fr 1fr; gap:6px; padding:4px 6px 8px}
  .pick{display:flex; align-items:center; gap:8px; background:#0b1a29; border:1px solid #1f3a57; border-radius:10px; padding:10px; cursor:pointer}
  .pick:hover{background:#0e2337}
  .section-title{font-size:11px;color:#9fb0c8;margin:4px 8px 6px}
  .picker-actions{display:flex;gap:6px;flex-wrap:wrap;padding:6px 8px 10px}
  .pick-small{font-size:12px;padding:8px 10px;border-radius:10px;background:#0b1a29;border:1px solid #1f3a57;cursor:pointer}
  .pick-small:hover{background:#0e2337}
</style>
</head>
<body>
<div class="app">

  <header>
    <h1>Pump Pressure ‚Äî Visual Builder</h1>
    <div class="sub">Three fixed lines ‚Ä¢ Tap ‚Äú+‚Äù at the tip to edit</div>
  </header>

  <div class="side">
    <button class="fab" id="openHose">Hose</button>
    <button class="fab" id="openAcc">Acc</button>
    <button class="fab" id="openNoz">Noz</button>
  </div>

  <!-- Hose drawer -->
  <div class="drawer" id="drawerHose" role="dialog" aria-label="Hose options">
    <h3>Hose segments</h3>
    <div class="row" id="hoseButtonsMain">
      <button data-hose='{"size":"5","lengthFt":100}'>5‚Ä≥ 100‚Ä≤</button>
      <button data-hose='{"size":"2.5","lengthFt":50}'>2¬Ω‚Ä≥ 50‚Ä≤</button>
      <button data-hose='{"size":"1.75","lengthFt":100}'>1¬æ‚Ä≥ 100‚Ä≤</button>
      <button data-hose='{"size":"1.75","lengthFt":50}'>1¬æ‚Ä≥ 50‚Ä≤</button>
      <button data-act="clearHose">Clear main hoses</button>
    </div>

    <div class="row" id="hoseButtonsSplit" style="display:none;border-top:1px solid var(--edge);margin-top:6px;padding-top:12px">
      <div style="width:100%;color:#cfe4ff;font-size:12px;margin-bottom:2px">After Wye:</div>
      <button data-side="L" data-hose='{"size":"2.5","lengthFt":50}'>Left 2¬Ω‚Ä≥ 50‚Ä≤</button>
      <button data-side="L" data-hose='{"size":"1.75","lengthFt":100}'>Left 1¬æ‚Ä≥ 100‚Ä≤</button>
      <button data-side="L" data-hose='{"size":"1.75","lengthFt":50}'>Left 1¬æ‚Ä≥ 50‚Ä≤</button>
      <button data-side="R" data-hose='{"size":"2.5","lengthFt":50}'>Right 2¬Ω‚Ä≥ 50‚Ä≤</button>
      <button data-side="R" data-hose='{"size":"1.75","lengthFt":100}'>Right 1¬æ‚Ä≥ 100‚Ä≤</button>
      <button data-side="R" data-hose='{"size":"1.75","lengthFt":50}'>Right 1¬æ‚Ä≥ 50‚Ä≤</button>
      <button data-act="clearBranches">Clear left/right</button>
    </div>
  </div>

  <!-- Accessory drawer -->
  <div class="drawer" id="drawerAcc" role="dialog" aria-label="Accessory options">
    <h3>Accessories</h3>
    <div class="row">
      <button data-acc='{"name":"In-line eductor","loss":25}'>In-line eductor (+25)</button>
      <button data-acc='{"name":"Master monitor","loss":25}'>Master monitor (+25)</button>
      <button data-acc='{"name":"Standpipe/PRV","loss":25}'>Standpipe/PRV (+25)</button>
      <button data-act="accCustom">Custom‚Ä¶</button>
      <button data-act="clearAcc">Clear accessories</button>
    </div>
    <h3 style="margin-top:4px">Split</h3>
    <div class="row">
      <button id="addWyeBtn">Wye/Siamese (split) +10 psi</button>
      <button id="removeWyeBtn">Remove Wye</button>
    </div>
  </div>

  <!-- Nozzle drawer -->
  <div class="drawer" id="drawerNoz" role="dialog" aria-label="Nozzle options">
    <h3>Left Nozzle</h3>
    <div class="row" id="nozRowLeft"></div>
    <h3>Right / Single Nozzle</h3>
    <div class="row" id="nozRowRight"></div>
  </div>

  <!-- Stage -->
  <div class="wrapper">
    <div id="scroll" class="scroll">
      <div id="stage" class="stage">
        <img id="engine" alt="ENGINE 181" src="https://fireopssim.com/pump/engine181.png" />
        <svg id="overlay" viewBox="0 0 390 800" preserveAspectRatio="none" aria-label="Diagram overlay">
          <defs>
            <filter id="hoseGlowT" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="blur"/>
              <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <clipPath id="roofClip">
              <rect id="roofClipRect" x="0" y="0" width="390" height="0"></rect>
            </clipPath>
          </defs>

          <g id="hoseGroup"></g>
          <g id="accGroup"></g>
          <g id="nozzleGroup"></g>
          <g id="portGroup"></g>
          <g id="labelGroup"></g>

          <!-- Discharge (visual) -->
          <g id="dischargeGroup" clip-path="url(#roofClip)"></g>
          <g id="dischargeLabels"></g>

          <text class="hint" id="hint">Tap a Line button or press ‚Äú+‚Äù at the tip‚Ä¶</text>
        </svg>

        <!-- Line selector under the truck -->
        <div class="linebar" id="linebar">
          <button class="linebtn" data-line="left">Line 1</button>
          <button class="linebtn" data-line="right">Line 2</button>
          <button class="linebtn" data-line="back">Line 3</button>
        </div>

        <!-- Discharge picker -->
        <div id="dischargePicker" class="picker" role="dialog" aria-modal="true" aria-hidden="true">
          <h3 id="pickerTitle">Line</h3>

          <div id="pickerHome">
            <div class="section-title">Choose an action</div>
            <div class="picker-grid">
              <div class="pick" data-view="addhose">‚ûï Add Hose</div>
              <div class="pick" data-view="nozzle">üß© Nozzle</div>
              <div class="pick" data-view="accessory">‚öôÔ∏è Accessory</div>
              <div class="pick" data-view="config">üõ†Ô∏è Change Config</div>
            </div>
          </div>

          <div id="pickerAddHose" style="display:none">
            <div class="section-title">Add hose length</div>
            <div class="picker-actions">
              <button class="pick-small" data-addlen="50" data-size="1.75">+50‚Ä≤ 1¬æ‚Ä≥</button>
              <button class="pick-small" data-addlen="50" data-size="2.5">+50‚Ä≤ 2¬Ω‚Ä≥</button>
            </div>
            <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
          </div>

          <div id="pickerNozzle" style="display:none">
            <div class="section-title">Set nozzle</div>
            <div class="picker-grid">
              <div class="pick" data-type="nozzle" data-id="smoothbore">Smooth Bore (SB)</div>
              <div class="pick" data-type="nozzle" data-id="fog50">Fog Nozzle 50 PSI</div>
              <div class="pick" data-type="nozzle" data-id="chief185">ChiefXD 185 @50</div>
              <div class="pick" data-type="nozzle" data-id="chief265">ChiefXD 265 @50</div>
            </div>
            <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
          </div>

          <div id="pickerAcc" style="display:none">
            <div class="section-title">Attach accessory</div>
            <div class="picker-grid">
              <div class="pick" data-type="accessory" data-id="wye">Wye</div>
              <div class="pick" data-type="accessory" data-id="gated_wye">Gated Wye</div>
              <div class="pick" data-type="accessory" data-id="siamese">Siamese</div>
              <div class="pick" data-type="accessory" data-id="standpipe">Standpipe</div>
              <div class="pick" data-type="accessory" data-id="flowmeter">Inline Flowmeter</div>
              <div class="pick" data-type="accessory" data-id="cap">Cap</div>
            </div>
            <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
          </div>

          <div id="pickerConfig" style="display:none">
            <div class="section-title">Size</div>
            <div class="picker-actions">
              <button class="pick-small" data-size-set="1.75">1¬æ‚Ä≥</button>
              <button class="pick-small" data-size-set="2.5">2¬Ω‚Ä≥</button>
            </div>
            <div class="section-title">Total Length</div>
            <div class="picker-actions">
              <button class="pick-small" data-len-set="50">50‚Ä≤</button>
              <button class="pick-small" data-len-set="100">100‚Ä≤</button>
              <button class="pick-small" data-len-set="150">150‚Ä≤</button>
              <button class="pick-small" data-len-set="200">200‚Ä≤</button>
              <button class="pick-small" data-len-set="250">250‚Ä≤</button>
              <button class="pick-small" data-len-set="300">300‚Ä≤</button>
            </div>
            <div class="section-title">Quick</div>
            <div class="picker-actions">
              <button class="pick-small" data-reset-default>Reset to defaults</button>
              <button class="pick-small" data-back>‚¨Ö Back</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div class="panel">
    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Environment</h3>
      <div class="grid2">
        <div><label>Elevation (ft)</label><input id="elevFt" type="number" step="5" value="0" /></div>
        <div><label>Elevation factor (psi/ft)</label><input id="elevPsi" type="number" step="0.001" value="0.434" /></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Build List</h3>
      <div class="list" id="builderList"></div>
    </div>

    <div class="card">
      <div class="eq" id="equation">PDP = max(Left, Right) + Main FL + Main Acc ¬± Elev</div>
      <div class="kpis" style="margin-top:8px">
        <div class="kpi"><div>Flow</div><b id="GPM">‚Äî gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">‚Äî psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </div>

</div>

<script>
  /* =========================
     Calculator + drawing
     ========================= */

  const STAGE_W = 390;
  const PX_PER_50FT = 80;
  const HOSE_X_RATIO = 0.49;
  const ROOF_RATIO   = 0.71;
  const HOSE_TOUCH_OFFSET = -6;
  const BRANCH_OFFSET = 34;

  const HOSE_WIDTH = { "5": 12, "2.5": 9, "1.75": 6 };
  const HOSE_COLOR = { "5": "var(--hose5)", "2.5": "var(--hose25)", "1.75": "var(--hose175)" };
  const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };

  const NOZZLES = [
    {name:"None (closed)", gpm:0, NP:0},
    {name:"Fog 150 gpm @100 psi", gpm:150, NP:100},
    {name:"ChiefXD 185 gpm @50 psi", gpm:185, NP:50},
    {name:"ChiefXD 265 gpm @50 psi", gpm:265, NP:50},
    {name:"SB 7/8‚Ä≥ @50 psi",   gpm:161, NP:50},
    {name:"SB 15/16‚Ä≥ @50 psi", gpm:185, NP:50},
    {name:"SB 1‚Ä≥ @50 psi",     gpm:210, NP:50},
    {name:"SB 1 1/8‚Ä≥ @50 psi", gpm:265, NP:50},
    {name:"SB 1 1/4‚Ä≥ @50 psi", gpm:325, NP:50}
  ];

  let itemsMain = [];
  let hasWye = false;
  let wyeLoss = 10;
  let itemsLeft = [];
  let itemsRight = [];

  let nozzleLeft = NOZZLES[2];
  let nozzleRight = NOZZLES[2];

  let elevFt = 0, elevPsiPerFt = 0.434;

  const engineImg = document.getElementById('engine');
  const stage = document.getElementById('stage');
  const scrollEl = document.getElementById('scroll');
  const overlay = document.getElementById('overlay');
  const hoseGroup = document.getElementById('hoseGroup');
  const accGroup = document.getElementById('accGroup');
  const nozzleGroup = document.getElementById('nozzleGroup');
  const portGroup = document.getElementById('portGroup');
  const labelGroup = document.getElementById('labelGroup');
  const dischargeGroup = document.getElementById('dischargeGroup');
  const dischargeLabels = document.getElementById('dischargeLabels');
  const roofClipRect = document.getElementById('roofClipRect');
  const dischargePicker = document.getElementById('dischargePicker');
  const pickerTitle = document.getElementById('pickerTitle');
  const pickerHome = document.getElementById('pickerHome');
  const pickerAddHose = document.getElementById('pickerAddHose');
  const pickerNozzle = document.getElementById('pickerNozzle');
  const pickerAcc = document.getElementById('pickerAcc');
  const pickerConfig = document.getElementById('pickerConfig');
  const builderList = document.getElementById('builderList');

  const drawerHose = document.getElementById('drawerHose');
  const drawerAcc  = document.getElementById('drawerAcc');
  const drawerNoz  = document.getElementById('drawerNoz');
  function closeDrawers(){ drawerHose.classList.remove('open'); drawerAcc.classList.remove('open'); drawerNoz.classList.remove('open'); }
  document.getElementById('openHose').onclick = (e)=>{ e.stopPropagation(); toggleDrawer(drawerHose); };
  document.getElementById('openAcc').onclick  = (e)=>{ e.stopPropagation(); toggleDrawer(drawerAcc); };
  document.getElementById('openNoz').onclick  = (e)=>{ e.stopPropagation(); toggleDrawer(drawerNoz); };
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.drawer') && !e.target.closest('.fab')) closeDrawers(); });
  function toggleDrawer(el){ const was = el.classList.contains('open'); closeDrawers(); if(!was) el.classList.add('open'); }

  const hoseButtonsMain = document.getElementById('hoseButtonsMain');
  const hoseButtonsSplit = document.getElementById('hoseButtonsSplit');
  function refreshHoseDrawer(){ hoseButtonsSplit.style.display = hasWye ? 'flex' : 'none'; }
  hoseButtonsMain.querySelectorAll('button[data-hose]').forEach(btn=>{
    btn.onclick = ()=>{ itemsMain.push({type:'hose', ...JSON.parse(btn.dataset.hose)}); closeDrawers(); render(true); };
  });
  hoseButtonsMain.querySelector('[data-act="clearHose"]').onclick = ()=>{ itemsMain = itemsMain.filter(x=>x.type!=='hose'); closeDrawers(); render(true); };

  hoseButtonsSplit.querySelectorAll('button[data-hose]').forEach(btn=>{
    btn.onclick = ()=>{
      const hose = {type:'hose', ...JSON.parse(btn.dataset.hose)};
      (btn.dataset.side==='L' ? itemsLeft : itemsRight).push(hose);
      closeDrawers(); render(true);
    };
  });
  hoseButtonsSplit.querySelector('[data-act="clearBranches"]').onclick = ()=>{ itemsLeft=[]; itemsRight=[]; closeDrawers(); render(true); };

  drawerAcc.querySelectorAll('button[data-acc]').forEach(btn=>{
    btn.onclick = ()=>{ const d=JSON.parse(btn.dataset.acc); itemsMain.push({type:'acc',name:d.name,loss:+d.loss||0}); closeDrawers(); render(true); };
  });
  drawerAcc.querySelector('[data-act="accCustom"]').onclick = ()=>{
    const name = prompt('Accessory name?','Appliance'); if(name===null) return;
    const loss = parseFloat(prompt('Pressure loss (psi)?','10')||'0');
    itemsMain.push({type:'acc', name:name||'Custom', loss:isNaN(loss)?0:loss});
    closeDrawers(); render(true);
  };
  drawerAcc.querySelector('[data-act="clearAcc"]').onclick = ()=>{ itemsMain = itemsMain.filter(x=>x.type!=='acc'); closeDrawers(); render(true); };
  document.getElementById('addWyeBtn').onclick = ()=>{ hasWye = true; wyeLoss = 10; refreshHoseDrawer(); closeDrawers(); render(true); };
  document.getElementById('removeWyeBtn').onclick = ()=>{ hasWye = false; itemsLeft=[]; itemsRight=[]; refreshHoseDrawer(); closeDrawers(); render(true); };

  const nozRowLeft = document.getElementById('nozRowLeft');
  const nozRowRight = document.getElementById('nozRowRight');
  NOZZLES.forEach(n=>{
    const bL=document.createElement('button'); bL.textContent=`${n.name}`; bL.onclick=()=>{ nozzleLeft=n; closeDrawers(); render(false); }; nozRowLeft.appendChild(bL);
    const bR=document.createElement('button'); bR.textContent=`${n.name}`; bR.onclick=()=>{ nozzleRight=n; closeDrawers(); render(false); }; nozRowRight.appendChild(bR);
  });

  document.getElementById('elevFt').oninput = e=>{ elevFt = parseFloat(e.target.value||0); render(); };
  document.getElementById('elevPsi').oninput = e=>{ elevPsiPerFt = parseFloat(e.target.value||0); render(); };

  function fl(C, Q, L){ return (C||0) * Math.pow(Q/100, 2) * (L/100); }
  function flForStack(hoses, Q){ return hoses.reduce((s,h)=> s + fl(COEFF[h.size]||0, Q, h.lengthFt||0), 0); }

  function calc(){
    const QL = nozzleLeft.gpm || 0;
    const QR = nozzleRight.gpm || 0;
    const Qtotal = hasWye ? (QL + QR) : QR;

    const FL_main = flForStack(itemsMain.filter(x=>x.type==='hose'), Qtotal);
    const ACC_main = itemsMain.filter(x=>x.type==='acc').reduce((s,a)=>s+(+a.loss||0),0) + (hasWye ? wyeLoss : 0);

    const FL_left  = hasWye ? flForStack(itemsLeft, QL) : 0;
    const FL_right = flForStack(hasWye ? itemsRight : [], QR);

    const NP_left  = hasWye ? (nozzleLeft.NP||0)  : 0;
    const NP_right = nozzleRight.NP||0;

    const elevPsi = elevFt * elevPsiPerFt;

    const PDP_left  = hasWye ? (NP_left  + FL_left  + elevPsi) : -Infinity;
    const PDP_right = NP_right + FL_right + elevPsi;

    const branchMax = hasWye ? Math.max(PDP_left, PDP_right) : PDP_right;
    const PDP_total = branchMax + FL_main + ACC_main;

    return {QL, QR, Qtotal, elevPsi, FL_main, ACC_main, FL_left, FL_right, NP_left, NP_right, PDP_left, PDP_right, PDP_total};
  }

  function stageWidthPx(){ return stage.clientWidth || window.innerWidth || 390; }
  function hoseXpx(){ return Math.round(stageWidthPx() * HOSE_X_RATIO); }
  function toVBX(px){ return px / stageWidthPx() * STAGE_W; }
  function toVBY(px){ return px; }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  const prettySize = s => s==='2.5' ? '2¬Ω' : (s==='1.75' ? '1¬æ' : s);

  function labelConsecutiveWithStats(list, x, yStart, Q, side='right'){
    let yCursor = yStart;
    let cur = null, totalFt=0, startY=yCursor, totalFL=0;

    const commit = ()=>{
      if(!cur || totalFt<=0) return;
      const mid = yCursor + (startY - yCursor)/2;
      const sizePretty = prettySize(cur) + '‚Ä≥';
      const text = `${sizePretty} ‚Ä¢ ${Q} gpm ‚Ä¢ ${totalFt}‚Ä≤ ‚Ä¢ FL ${totalFL.toFixed(1)} psi`;
      const estW = Math.max(100, text.length * 6.0);
      const pad = 6;
      const margin = 6;
      let bxPx = (side==='left')
        ? clamp((x - 16) - estW - pad*2, margin, stageWidthPx() - estW - pad*2 - margin)
        : clamp((x + 16), margin, stageWidthPx() - estW - pad*2 - margin);
      const byPx = mid - 10 - pad;

      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', toVBX(bxPx));
      rect.setAttribute('y', toVBY(byPx));
      rect.setAttribute('width', estW + pad*2);
      rect.setAttribute('height', 16 + pad*2);
      rect.setAttribute('rx', 6);
      rect.setAttribute('fill', '#172134');
      rect.setAttribute('stroke', 'rgba(255,255,255,.15)');
      labelGroup.appendChild(rect);

      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x', toVBX(bxPx + pad));
      tx.setAttribute('y', toVBY(byPx + pad + 13));
      tx.setAttribute('fill','#cfe4ff'); tx.setAttribute('font-size','10'); tx.textContent=text;
      labelGroup.appendChild(tx);

      cur=null; totalFt=0; totalFL=0; startY=yCursor;
    };

    for(const it of list){
      const hPx=(it.lengthFt===50?PX_PER_50FT:2*PX_PER_50FT);
      if(cur===null){ cur=it.size; totalFt=0; totalFL=0; startY=yCursor; }
      if(it.size!==cur){ commit(); cur=it.size; totalFt=0; totalFL=0; startY=yCursor; }
      yCursor -= hPx;
      totalFt += it.lengthFt;
      totalFL += fl(COEFF[it.size]||0, Q, it.lengthFt);
    }
    commit();
  }

  function renderDiagram(){
    const nW = engineImg.naturalWidth || 0;
    const nH = engineImg.naturalHeight || 0;
    const eH = (nW && nH) ? (stageWidthPx() * (nH / nW)) : (engineImg.clientHeight || 180);

    const hoseFeetMain = itemsMain.filter(x=>x.type==='hose').reduce((s,h)=>s+h.lengthFt,0);
    const hoseFeetLeft = itemsLeft.reduce((s,h)=>s+h.lengthFt,0);
    const hoseFeetRight= itemsRight.reduce((s,h)=>s+h.lengthFt,0);
    const hosePx = ((hoseFeetMain+hoseFeetLeft+hoseFeetRight)/50)*PX_PER_50FT;
    const topPad = 160;

    const stageH = Math.max(520, eH + hosePx + topPad);
    stage.style.height = stageH + 'px';
    overlay.setAttribute('viewBox', `0 0 ${STAGE_W} ${Math.round(stageH)}`);

    const imageTopPx = stageH - eH;
    const roofY = imageTopPx + (eH * ROOF_RATIO);
    const xMain = hoseXpx();

    roofClipRect.setAttribute('y', 0);
    roofClipRect.setAttribute('height', roofY - 2);
    roofClipRect.setAttribute('width', STAGE_W);
    roofClipRect.setAttribute('x', 0);

    // Clear groups
    hoseGroup.innerHTML=''; accGroup.innerHTML=''; nozzleGroup.innerHTML=''; portGroup.innerHTML=''; labelGroup.innerHTML='';
    dischargeGroup.innerHTML=''; dischargeLabels.innerHTML='';

    // Pump discharge port
    const port=document.createElementNS('http://www.w3.org/2000/svg','circle');
    port.setAttribute('cx', toVBX(xMain)); port.setAttribute('cy', toVBY(roofY)); port.setAttribute('r', toVBX(6));
    port.setAttribute('fill','#2b3142'); port.setAttribute('stroke','#111622'); port.setAttribute('stroke-width','1.5'); portGroup.appendChild(port);

    // Draw the deck hose stack + labels (existing builder flow)
    let y = roofY + HOSE_TOUCH_OFFSET;
    for(const it of itemsMain){
      if(it.type==='hose'){
        const hPx = (it.lengthFt===50?PX_PER_50FT:2*PX_PER_50FT), wPx=HOSE_WIDTH[it.size]||6;
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', toVBX(xMain-wPx/2)); rect.setAttribute('y', toVBY(y-hPx));
        rect.setAttribute('width', toVBX(wPx)); rect.setAttribute('height', toVBY(hPx));
        rect.setAttribute('fill', HOSE_COLOR[it.size]); rect.setAttribute('stroke','rgba(255,255,255,.1)'); rect.setAttribute('stroke-width','1'); hoseGroup.appendChild(rect);
        y -= hPx;
      } else {
        const bg=document.createElementNS('http://www.w3.org/2000/svg','rect');
        bg.setAttribute('x', toVBX(xMain+10)); bg.setAttribute('y', toVBY(y-18)); bg.setAttribute('width', 120); bg.setAttribute('height', 18);
        bg.setAttribute('rx',6); bg.setAttribute('fill','#172134'); bg.setAttribute('stroke','rgba(255,255,255,.15)'); accGroup.appendChild(bg);
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', toVBX(xMain+16)); t.setAttribute('y', toVBY(y-6)); t.setAttribute('fill','#cfe4ff'); t.setAttribute('font-size','10');
        t.textContent=`${it.name} (+${it.loss} psi)`; accGroup.appendChild(t);
        y -= 22;
      }
    }

    const flows = calc();
    labelConsecutiveWithStats(itemsMain.filter(x=>x.type==='hose'), xMain, roofY + HOSE_TOUCH_OFFSET, flows.Qtotal, 'right');

    // Discharge lines (filter by active line)
    renderDischargeHoses(roofY, xMain);
  }

  function rowClassForSize(size){
    if(size==='5') return 'hose-5';
    if(size==='2.5') return 'hose-25';
    if(size==='1.75') return 'hose-175';
    return '';
  }
  function builderRowHose(h, idx, where, Q_for_this_row){
    const div=document.createElement('div'); div.className='item ' + rowClassForSize(h.size);
    const segFL = fl(COEFF[h.size]||0, Q_for_this_row, h.lengthFt);
    div.innerHTML = `
      <div><div>üßØ ${where} Hose <small>#${idx+1}</small></div>
      <div class="note">${prettySize(h.size)}‚Ä≥ ‚Ä¢ ${h.lengthFt}‚Ä≤</div></div>
      <div class="actions">
        <span class="note">FL ${segFL.toFixed(1)} psi</span>
        <span class="note">GPM ${Q_for_this_row}</span>
        <select data-k="size">
          <option value="5" ${h.size==='5'?'selected':''}>5‚Ä≥</option>
          <option value="2.5" ${h.size==='2.5'?'selected':''}>2¬Ω‚Ä≥</option>
          <option value="1.75" ${h.size==='1.75'?'selected':''}>1¬æ‚Ä≥</option>
        </select>
        <select data-k="lengthFt">
          <option value="50" ${h.lengthFt===50?'selected':''}>50‚Ä≤</option>
          <option value="100" ${h.lengthFt===100?'selected':''}>100‚Ä≤</option>
        </select>
        <button data-act="del">‚úï</button>
      </div>`;
    if(where==='Left' || where==='Right'){
      const sizeSel = div.querySelector('select[data-k="size"]');
      [...sizeSel.options].forEach(opt=>{ if(opt.value==='5') opt.disabled = true; });
    }
    div.querySelectorAll('select').forEach(s=>{
      s.onchange=()=>{ const k=s.dataset.k; if(k==='size') h.size=s.value; if(k==='lengthFt') h.lengthFt=parseInt(s.value,10); render(); };
    });
    div.querySelector('[data-act="del"]').onclick=()=>{ const arr=(where==='Left'?itemsLeft:(where==='Right'?itemsRight:itemsMain)); arr.splice(idx,1); render(true); };
    return div;
  }
  function builderRowAcc(a, idx){
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div><div>‚öôÔ∏è Main Accessory <small>#${idx+1}</small></div><div class="note">${a.name} ‚Ä¢ +${a.loss} psi</div></div>
      <div class="actions"><button data-act="loss">Loss</button><button data-act="rename">Name</button><button data-act="del">‚úï</button></div>`;
    div.querySelector('[data-act="del"]').onclick=()=>{ itemsMain.splice(idx,1); render(true); };
    div.querySelector('[data-act="loss"]').onclick=()=>{ const v=parseFloat(prompt('Accessory loss (psi):', String(a.loss))||String(a.loss)); if(!isNaN(v)) a.loss=v; render(); };
    div.querySelector('[data-act="rename"]').onclick=()=>{ const v=prompt('Accessory name:', a.name); if(v!==null) a.name=v||a.name; render(); };
    return div;
  }

  function calcAndRenderMath(){
    const R = calc();
    const flowLabel = hasWye ? `${R.QL}+${R.QR} = ${R.Qtotal} gpm` : `${R.QR} gpm`;
    document.getElementById('GPM').textContent = flowLabel;
    document.getElementById('PDP').textContent = `${Math.round(R.PDP_total)} psi`;
    const parts = [
      `Main FL=${R.FL_main.toFixed(1)}`,
      `Main Acc=${R.ACC_main.toFixed(1)}`,
      hasWye?`Left PDP=${Math.round(R.PDP_left)}`:null,
      `Right PDP=${Math.round(R.PDP_right)}`,
      `Elev=${R.elevPsi.toFixed(1)}`
    ].filter(Boolean).join(' ‚Ä¢ ');
    document.getElementById('breakdown').textContent = parts;
    document.getElementById('equation').textContent =
      `PDP = max(Left:${hasWye?Math.round(R.PDP_left):'‚Äî'}, Right:${Math.round(R.PDP_right)}) + Main FL(${R.FL_main.toFixed(1)}) + Main Acc(${R.ACC_main.toFixed(1)})`;
  }

  /* ========= Discharge hoses (3 fixed lines) ========= */
  const dischargeOrder = ['left','right','back']; // mapping to Line 1/2/3
  const dischargeDefaults = {
    left:  { label:'Line 1', size:'1.75', lengthFt:200, nozzle:{id:'chief185', name:'ChiefXD 185 @50', gpm:185, NP:50}, accessories:[] },
    right: { label:'Line 2', size:'1.75', lengthFt:200, nozzle:{id:'chief185', name:'ChiefXD 185 @50', gpm:185, NP:50}, accessories:[] },
    back:  { label:'Line 3', size:'2.5',  lengthFt:250, nozzle:{id:'chief265', name:'ChiefXD 265 @50', gpm:265, NP:50}, accessories:[] },
  };

  const nozzleCatalog = {
    smoothbore:{name:'Smooth Bore', gpm:185, NP:50},
    fog50:{name:'Fog @50', gpm:150, NP:50},
    chief185:{name:'ChiefXD 185 @50', gpm:185, NP:50},
    chief265:{name:'ChiefXD 265 @50', gpm:265, NP:50},
  };

  const sizeStroke = s => (s==='1.75'?getComputedStyle(document.documentElement).getPropertyValue('--hose175')
                           : s==='2.5'?getComputedStyle(document.documentElement).getPropertyValue('--hose25')
                           : getComputedStyle(document.documentElement).getPropertyValue('--hose5'));

  const dischargeState = { hoses: [] };
  let activeLine = null; // 'left' | 'right' | 'back' | null (null = show all)

  function vbToScreen(x_vb, y_vb){
    const ov = overlay.getBoundingClientRect();
    return { x: ov.left + (x_vb / STAGE_W) * ov.width, y: ov.top + y_vb };
  }

  function dischargeGeom(pos, roofY, xMain){
    const start = { x: toVBX(xMain), y: toVBY(roofY) };
    const topY = 30;
    const spread = 120;
    let endX = xMain;
    if(pos==='left')  endX = xMain - spread;
    if(pos==='right') endX = xMain + spread;
    if(pos==='back')  endX = xMain;
    const end = { x: toVBX(endX), y: toVBY(topY) };
    const ctrl = { x: toVBX((xMain + endX)/2 + (pos==='left'?-40:pos==='right'?40:0)),
                   y: toVBY(roofY - (roofY - topY) * 0.5) };
    const d = `M ${start.x},${start.y} Q ${ctrl.x},${ctrl.y} ${end.x},${end.y}`;
    return { d, start, end };
  }

  function endLabelText(h){
    const sizePretty = h.size==='2.5' ? '2¬Ω‚Ä≥' : (h.size==='1.75' ? '1¬æ‚Ä≥' : `${h.size}‚Ä≥`);
    const nz = h.nozzle ? `${h.nozzle.name}` : 'Nozzle ‚Äî';
    const gpm = h.nozzle ? `${h.nozzle.gpm} gpm` : '0 gpm';
    return `${sizePretty} ‚Ä¢ ${h.lengthFt}‚Ä≤ ‚Ä¢ ${gpm} ‚Ä¢ ${nz}`;
  }

  function drawEndLabel(h, endX, endY){
    const text = endLabelText(h);
    const estW = Math.max(120, text.length*6.2);
    const pad = 6;
    const x = endX - estW/2 - pad;
    const y = endY - 38;

    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x); rect.setAttribute('y', y);
    rect.setAttribute('width', estW + pad*2); rect.setAttribute('height', 18 + pad*2);
    rect.setAttribute('rx', 8); rect.setAttribute('fill', '#172134'); rect.setAttribute('stroke','rgba(255,255,255,.15)');
    const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('x', x + pad); tx.setAttribute('y', y + pad + 13);
    tx.setAttribute('fill','#cfe4ff'); tx.setAttribute('font-size','10'); tx.textContent = text;
    dischargeLabels.appendChild(rect); dischargeLabels.appendChild(tx);
  }

  function renderDischargeHoses(roofY, xMain){
    dischargeGroup.innerHTML = '';
    dischargeLabels.innerHTML = '';

    const hosesToDraw = dischargeState.hoses.filter(h=>!activeLine || h.pos===activeLine);

    hosesToDraw.forEach(h=>{
      const geom = dischargeGeom(h.pos, roofY, xMain);
      h.endVB = geom.end;

      // shadow
      const sh = document.createElementNS('http://www.w3.org/2000/svg','path');
      sh.setAttribute('d', geom.d);
      sh.setAttribute('stroke', 'rgba(0,0,0,.35)');
      sh.setAttribute('stroke-width', '12');
      sh.setAttribute('opacity', '.35');
      sh.setAttribute('fill','none');

      // hose path
      const p  = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', geom.d);
      p.setAttribute('stroke', sizeStroke(h.size));
      p.setAttribute('stroke-width', '10');
      p.setAttribute('fill','none');
      p.setAttribute('filter','url(#hoseGlowT)');

      // plus button at tip
      const gEnd = document.createElementNS('http://www.w3.org/2000/svg','g');
      gEnd.setAttribute('class','hose-end'); gEnd.setAttribute('data-hose', h.id);
      const cx = geom.end.x, cy = geom.end.y;
      const c  = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('class','plus-circle'); c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 14);
      const v  = document.createElementNS('http://www.w3.org/2000/svg','line');
      v.setAttribute('class','plus-sign'); v.setAttribute('x1', cx); v.setAttribute('y1', cy-6); v.setAttribute('x2', cx); v.setAttribute('y2', cy+6);
      const hln= document.createElementNS('http://www.w3.org/2000/svg','line');
      hln.setAttribute('class','plus-sign'); hln.setAttribute('x1', cx-6); hln.setAttribute('y1', cy); hln.setAttribute('x2', cx+6); hln.setAttribute('y2', cy);
      gEnd.appendChild(c); gEnd.appendChild(v); gEnd.appendChild(hln);

      dischargeGroup.appendChild(sh);
      dischargeGroup.appendChild(p);
      dischargeGroup.appendChild(gEnd);

      h.nodes = {shadow:sh, path:p, endGroup:gEnd};

      // line tag near roof (Line 1/2/3)
      const labelY = roofY - 8;
      let labelX = xMain;
      if(h.pos==='left') labelX = xMain - 78;
      if(h.pos==='right') labelX = xMain + 78;
      const lblRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      const lblText = document.createElementNS('http://www.w3.org/2000/svg','text');
      const textStr = `${h.label}`;
      const estW = Math.max(60, textStr.length*6.2);
      const pad = 4;
      lblRect.setAttribute('x', toVBX(labelX - (estW/2) - pad));
      lblRect.setAttribute('y', toVBY(labelY - 16 - pad));
      lblRect.setAttribute('width', estW + pad*2);
      lblRect.setAttribute('height', 16 + pad*2);
      lblRect.setAttribute('rx', 6);
      lblRect.setAttribute('fill', '#172134');
      lblRect.setAttribute('stroke', 'rgba(255,255,255,.15)');
      lblText.setAttribute('x', toVBX(labelX - (estW/2)));
      lblText.setAttribute('y', toVBY(labelY - 4));
      lblText.setAttribute('fill', '#cfe4ff');
      lblText.setAttribute('font-size','10');
      lblText.textContent = textStr;
      dischargeLabels.appendChild(lblRect);
      dischargeLabels.appendChild(lblText);

      // end info label (size ‚Ä¢ length ‚Ä¢ gpm ‚Ä¢ nozzle)
      drawEndLabel(h, cx, cy);
    });
  }

  function showPickerView(which){
    pickerHome.style.display = (which==='home') ? 'block' : 'none';
    pickerAddHose.style.display = (which==='addhose') ? 'block' : 'none';
    pickerNozzle.style.display = (which==='nozzle') ? 'block' : 'none';
    pickerAcc.style.display = (which==='accessory') ? 'block' : 'none';
    pickerConfig.style.display = (which==='config') ? 'block' : 'none';
  }

  let pickerForHoseId = null;
  function showDischargePicker(hose, clientX, clientY){
    pickerForHoseId = hose.id;
    pickerTitle.textContent = `${hose.label}`;
    const stg = stage.getBoundingClientRect();
    dischargePicker.style.display='block';
    dischargePicker.setAttribute('aria-hidden','false');
    showPickerView('home');
    const pw = dischargePicker.offsetWidth || 260;
    const ph = dischargePicker.offsetHeight || 220;
    let x = clientX - stg.left + 8;
    let y = clientY - stg.top - ph - 8;
    if(y < 8) y = clientY - stg.top + 8;
    x = Math.max(8, Math.min(x, stg.width - pw - 8));
    y = Math.max(8, Math.min(y, stg.height - ph - 8));
    dischargePicker.style.left = `${x}px`; dischargePicker.style.top = `${y}px`;
  }
  function hideDischargePicker(){
    dischargePicker.style.display='none';
    dischargePicker.setAttribute('aria-hidden','true');
    pickerForHoseId = null;
  }

  // Picker nav
  dischargePicker.addEventListener('click', (e)=>{
    const toView = e.target.getAttribute('data-view');
    if(toView){ showPickerView(toView); return; }
    if(e.target.hasAttribute('data-back')){ showPickerView('home'); return; }
  });
  document.addEventListener('click', (e)=>{
    if(dischargePicker.contains(e.target)) return;
    if(e.target.closest('.hose-end')) return;
    if(e.target.closest('.linebtn')) return;
    hideDischargePicker();
  });

  // Picker actions
  document.getElementById('pickerAddHose').addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-addlen]'); if(!btn) return;
    const len = parseInt(btn.getAttribute('data-addlen'),10);
    const size = btn.getAttribute('data-size');
    const hose = dischargeState.hoses.find(h=>h.id===pickerForHoseId); if(!hose) return;
    hose.lengthFt = (hose.lengthFt||0) + len;
    if(size) hose.size = size;
    render(false);
    hideDischargePicker();
  });
  document.getElementById('pickerNozzle').addEventListener('click', (e)=>{
    const pick = e.target.closest('.pick[data-type="nozzle"]'); if(!pick) return;
    const id = pick.getAttribute('data-id');
    const hose = dischargeState.hoses.find(h=>h.id===pickerForHoseId); if(!hose) return;
    const nz = nozzleCatalog[id] || {name:'Nozzle', gpm:0, NP:0};
    hose.nozzle = {id, gpm:nz.gpm, NP:nz.NP, name:nz.name};
    render(false);
    hideDischargePicker();
  });
  document.getElementById('pickerAcc').addEventListener('click', (e)=>{
    const pick = e.target.closest('.pick[data-type="accessory"]'); if(!pick) return;
    const id = pick.getAttribute('data-id');
    const hose = dischargeState.hoses.find(h=>h.id===pickerForHoseId); if(!hose) return;
    const map = {wye:'Wye', gated_wye:'Gated Wye', siamese:'Siamese', standpipe:'Standpipe', flowmeter:'Inline Flowmeter', cap:'Cap'};
    hose.accessories.push(map[id]||id);
    render(false);
    hideDischargePicker();
  });
  document.getElementById('pickerConfig').addEventListener('click', (e)=>{
    const sizeSet = e.target.getAttribute('data-size-set');
    const lenSet  = e.target.getAttribute('data-len-set');
    const reset   = e.target.hasAttribute('data-reset-default');
    const hose = dischargeState.hoses.find(h=>h.id===pickerForHoseId); if(!hose) return;
    if(sizeSet){ hose.size = sizeSet; render(false); hideDischargePicker(); return; }
    if(lenSet){ hose.lengthFt = parseInt(lenSet,10); render(false); hideDischargePicker(); return; }
    if(reset){
      const def = dischargeDefaults[hose.pos];
      hose.size = def.size; hose.lengthFt = def.lengthFt; hose.nozzle = {...def.nozzle}; hose.accessories = [];
      render(false); hideDischargePicker(); return;
    }
  });

  // Open picker by tapping +
  overlay.addEventListener('click', (e)=>{
    const end = e.target.closest('.hose-end'); if(!end) return;
    const id = end.getAttribute('data-hose');
    const hose = dischargeState.hoses.find(h=>h.id===id); if(!hose) return;
    const ov = overlay.getBoundingClientRect();
    const circ = end.querySelector('.plus-circle');
    const cx = parseFloat(circ.getAttribute('cx'));
    const cy = parseFloat(circ.getAttribute('cy'));
    const clientX = ov.left + (cx/STAGE_W)*ov.width;
    const clientY = ov.top  + cy;
    showDischargePicker(hose, clientX, clientY);
  });

  // Line buttons: show only that hose (toggle to all)
  const linebar = document.getElementById('linebar');
  linebar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.linebtn'); if(!btn) return;
    const pos = btn.getAttribute('data-line'); // left/right/back
    activeLine = (activeLine===pos) ? null : pos;
    [...linebar.querySelectorAll('.linebtn')].forEach(b=>b.classList.toggle('active', b.getAttribute('data-line')===activeLine));
    // Jump view so the tip is visible near top
    scrollEl.scrollTop = 0;
    render(false);
  });

  // Init 3 fixed lines
  function initFixedLines(){
    dischargeState.hoses = [];
    for(const pos of dischargeOrder){
      const base = dischargeDefaults[pos];
      dischargeState.hoses.push({
        id: crypto.randomUUID(),
        pos,
        label: base.label,
        size: base.size,
        lengthFt: base.lengthFt,
        nozzle: {...base.nozzle},
        accessories: [],
        nodes:{}
      });
    }
  }

  function render(autoScroll=false){
    refreshHoseDrawer();
    renderDiagram();
    renderBuilder();
    calcAndRenderMath();
    if(autoScroll){ setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 0); }
  }

  // Boot
  initFixedLines();
  if(engineImg.complete) render(true);
  engineImg.onload = ()=> render(true);
  window.addEventListener('resize', ()=> render(false));
</script>
</body>
</html>
