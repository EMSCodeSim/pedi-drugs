<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pump Pressure — Visual Builder (ENGINE 181)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8;
    --edge:rgba(255,255,255,.10); --accent:#49a3ff;
    --hose:#f3ce6a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}
  header{padding:14px 16px 10px;background:linear-gradient(180deg,#0c1320 0%,#0b0f14 100%);border-bottom:1px solid var(--edge);position:sticky;top:0;z-index:3;display:flex;justify-content:space-between;gap:10px;align-items:center}
  h1{margin:4px 0 2px;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .btn{background:#0b1320;border:1px solid var(--edge);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .menu{position:relative}
  .menu-panel{position:absolute;top:44px;right:0;background:#0b1320;border:1px solid var(--edge);border-radius:10px;overflow:hidden;display:none;min-width:200px;z-index:5}
  .menu.open .menu-panel{display:block}
  .menu-panel button{display:block;width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;color:var(--ink);font-size:14px}
  .menu-panel button:hover{background:#101c30}
  .canvas{position:relative;overflow:hidden;background:linear-gradient(180deg,#0b0f14,#0e1726)}
  svg{width:100%;height:50vh;display:block}
  .controls{padding:10px 12px;background:var(--panel);border-top:1px solid var(--edge)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320}
  .item small{color:var(--muted)}
  .actions{display:flex;gap:6px;align-items:center}
  input,select{background:#0b1320;color:var(--ink);border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .eq{font-family:ui-monospace,Menlo,monospace;color:#cfe4ff;font-size:13px;line-height:1.35}
  .kpis{display:flex;flex-wrap:wrap;gap:10px}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
  .kpi b{font-size:20px}
  .note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Pump Pressure — Visual Builder</h1>
      <div class="sub">Start with ENGINE 181 • Add hose/appliance/nozzle • Live math</div>
    </div>
    <div class="menu" id="addMenu">
      <button class="btn" id="addBtn">➕ Add</button>
      <div class="menu-panel" id="addPanel">
        <button data-add="hose">Hose segment</button>
        <button data-add="appliance">Appliance (Wye, Eductor, etc.)</button>
        <button data-add="nozzle">Nozzle… (incl. Chief XD)</button>
      </div>
    </div>
  </header>

  <!-- Visual diagram -->
  <div class="canvas">
    <svg id="scene" viewBox="0 0 390 360" preserveAspectRatio="xMidYMid slice" aria-label="Pump diagram">
      <defs>
        <filter id="glow"><feGaussianBlur stdDeviation="1.2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <!-- optional hose texture (will use solid if image not found) -->
        <pattern id="hoseStripes" width="6" height="6" patternUnits="userSpaceOnUse" patternTransform="rotate(35)">
          <image id="hoseTileImg" href="./assets/overlay_hose_tile_64.png" x="0" y="0" width="6" height="6" />
        </pattern>
      </defs>

      <!-- ENGINE 181 image (bottom) -->
      <image id="truckImg" href="./assets/engine181.png" x="6" y="250" width="200" height="95" />

      <!-- Hose path + texture overlay -->
      <path id="hosePath" d="" stroke="var(--hose)" fill="none" stroke-linecap="round" filter="url(#glow)" stroke-width="12"/>
      <path id="hoseStripePath" d="" stroke="url(#hoseStripes)" fill="none" stroke-linecap="round" stroke-width="9" opacity="0.5"/>

      <!-- Couplings, wye, nozzle -->
      <image id="cplStart" href="./assets/overlay_coupling_96.png" x="-100" y="-100" width="18" height="18"/>
      <image id="cplEnd"   href="./assets/overlay_coupling_96.png" x="-100" y="-100" width="18" height="18"/>
      <image id="wyeImg"   href="./assets/overlay_wye_200.png"     x="-100" y="-100" width="26" height="26"/>
      <image id="nozImg"   href="./assets/overlay_nozzle_fog_160.png" x="-100" y="-100" width="26" height="26"/>

      <!-- Labels -->
      <text x="200" y="36" fill="#f7e39a" font-size="10" id="pathLabel">Add components to begin…</text>
    </svg>
  </div>

  <!-- Builder list & math -->
  <div class="controls">
    <div class="card">
      <div class="note">Order matters: Engine ➜ Hose(s) ➜ Appliance(s) ➜ Nozzle</div>
      <div class="list" id="builderList"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Environment</h3>
      <div class="grid2">
        <div>
          <label>Elevation (ft)</label>
          <input id="elevFt" type="number" step="5" value="0" />
        </div>
        <div>
          <label>Elevation factor (psi/ft)</label>
          <input id="elevPsi" type="number" step="0.001" value="0.434" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="eq" id="equation">PDP = NP + ΣFL(hose @ GPM) + ΣAppliance ± Elev</div>
      <div class="kpis" style="margin-top:8px">
        <div class="kpi"><div>Flow</div><b id="GPM">— gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">— psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
  // ---------- Presets ----------
  // FL = C * (Q/100)^2 * (L/100)
  const COEFF = {"1.5":24,"1.75":15.5,"2":8,"2.5":2,"3":0.8,"4":0.2,"5":0.08};
  const STROKE = {"1.5":10,"1.75":12,"2":14,"2.5":16,"3":18,"4":22,"5":26};

  const NOZZLES = [
    {name:"Fog 95", gpm:95, NP:100},
    {name:"Fog 125", gpm:125, NP:100},
    {name:"Fog 150", gpm:150, NP:100},
    {name:'SB 7/8\"', gpm:160, NP:50},
    {name:'SB 15/16\"', gpm:185, NP:50},
    {name:'SB 1\"', gpm:210, NP:50},
    {name:"ChiefXD 100 @50", gpm:100, NP:50},
    {name:"ChiefXD 150 @50", gpm:150, NP:50},
    {name:"ChiefXD 150 @75", gpm:150, NP:75},
    {name:"ChiefXD 185 @75", gpm:185, NP:75}
  ];

  const APPLIANCE_PRESETS = [
    {name:"Wye/Siamese", loss:10},
    {name:"In-line eductor", loss:25},
    {name:"Master monitor", loss:25},
    {name:"Standpipe/PRV", loss:25},
    {name:"Custom", loss:0}
  ];

  // ---------- State ----------
  let items = []; // user adds hose/appliances
  let nozzle = null;
  let elevFt = 0, elevPsiPerFt = 0.434;

  // ---------- Add menu ----------
  const addMenu = document.getElementById('addMenu');
  const addPanel = document.getElementById('addPanel');
  document.getElementById('addBtn').onclick = ()=> addMenu.classList.toggle('open');
  document.addEventListener('click', (e)=>{ if(!addMenu.contains(e.target)) addMenu.classList.remove('open'); });
  addPanel.querySelectorAll('button').forEach(b=>{
    b.onclick = ()=>{
      const what = b.dataset.add;
      if(what==='hose'){ items.push({type:'hose', dia:'1.75', length:200}); }
      else if(what==='appliance'){ items.push({type:'appliance', name:'Wye/Siamese', loss:10}); }
      else if(what==='nozzle'){ pickNozzle(); }
      addMenu.classList.remove('open'); render();
    };
  });

  // ---------- Math ----------
  function fl(C, Q, L){ return (C||0) * Math.pow(Q/100, 2) * (L/100); }
  function calc(){
    const Q = nozzle?.gpm || 0;
    const NP = nozzle?.NP || 0;
    let totalFL = 0, totalApp = 0, hoses = [], apps = [];
    items.forEach((it, idx)=>{
      if(it.type==='hose'){
        const C = COEFF[it.dia] || 0;
        const segFL = fl(C, Q, it.length);
        totalFL += segFL; hoses.push({i:idx+1, ...it, C, segFL});
      } else { totalApp += Number(it.loss)||0; apps.push({i:idx+1, ...it}); }
    });
    const elevPsi = elevFt * elevPsiPerFt;
    const PDP = NP + totalFL + totalApp + elevPsi;
    return {Q, NP, totalFL, totalApp, elevPsi, PDP, hoses, apps};
  }

  // ---------- Geometry (cubic Bézier) ----------
  function cubicPoint(p0,p1,p2,p3,t){
    const u=1-t, tt=t*t, uu=u*u, uuu=uu*u, ttt=tt*t;
    return { x: uuu*p0.x + 3*uu*t*p1.x + 3*u*tt*p2.x + ttt*p3.x,
             y: uuu*p0.y + 3*uu*t*p1.y + 3*u*tt*p2.y + ttt*p3.y };
  }
  function cubicTangent(p0,p1,p2,p3,t){
    const u=1-t;
    return { x: 3*u*u*(p1.x-p0.x) + 6*u*t*(p2.x-p1.x) + 3*t*t*(p3.x-p2.x),
             y: 3*u*u*(p1.y-p0.y) + 6*u*t*(p2.y-p1.y) + 3*t*t*(p3.y-p2.y) };
  }

  // Visual path depends on total hose length
  function pathForChain(){
    // pump port near ENGINE 181 image: (x≈113,y≈283) works well for x=6,y=250,width=200,height=95
    const pump = {x:113, y:283};
    const totalLen = items.filter(i=>i.type==='hose').reduce((s,h)=>s+h.length,0) || 80;
    const t = Math.max(0, Math.min(1, (totalLen-80)/(600-80)));
    const end = {x: 322 + 18*t, y: 90 + 6*t};
    const c1 = {x: 160, y: 230 - 60*t};
    const c2 = {x: 240, y: 180 - 90*t};
    return {p0:pump, p1:c1, p2:c2, p3:end,
            d:`M ${pump.x} ${pump.y} C ${c1.x} ${c1.y}, ${c2.x} ${c2.y}, ${end.x} ${end.y}`};
  }

  // ---------- Builder rows ----------
  function builderRow(item, idx){
    const row = document.createElement('div');
    row.className = 'item';
    if(item.type==='hose'){
      row.innerHTML = `
        <div><div>🧯 Hose <small>#${idx+1}</small></div>
             <div class="note">FL uses nozzle GPM</div></div>
        <div class="actions">
          <label style="display:flex;flex-direction:column">
            <span style="font-size:12px;color:#9fb0c8">Size</span>
            <select data-k="dia">${Object.keys(COEFF).map(d=>`<option value="${d}" ${d===item.dia?'selected':''}>${d}″</option>`).join('')}</select>
          </label>
          <label style="display:flex;flex-direction:column">
            <span style="font-size:12px;color:#9fb0c8">Length</span>
            <input data-k="length" type="number" step="25" min="0" value="${item.length}" style="width:90px"/>
          </label>
          <button class="btn" data-act="up">↑</button>
          <button class="btn" data-act="down">↓</button>
          <button class="btn" data-act="del">✕</button>
        </div>`;
    } else {
      row.innerHTML = `
        <div><div>⚙️ Appliance <small>#${idx+1}</small></div>
             <div class="note">Loss in psi added inline</div></div>
        <div class="actions">
          <label style="display:flex;flex-direction:column">
            <span style="font-size:12px;color:#9fb0c8">Type</span>
            <select data-k="name">
              ${APPLIANCE_PRESETS.map(a=>`<option value="${a.name}" ${a.name===item.name?'selected':''}>${a.name}</option>`).join('')}
            </select>
          </label>
          <label style="display:flex;flex-direction:column">
            <span style="font-size:12px;color:#9fb0c8">Loss (psi)</span>
            <input data-k="loss" type="number" step="1" min="0" value="${item.loss}" style="width:80px"/>
          </label>
          <button class="btn" data-act="up">↑</button>
          <button class="btn" data-act="down">↓</button>
          <button class="btn" data-act="del">✕</button>
        </div>`;
    }

    row.querySelectorAll('select,input').forEach(el=>{
      el.onchange = ()=>{
        const k = el.dataset.k;
        if(item.type==='hose'){
          if(k==='dia') item.dia = el.value;
          if(k==='length') item.length = Math.max(0, parseFloat(el.value||0));
        } else {
          if(k==='name'){
            item.name = el.value;
            const preset = APPLIANCE_PRESETS.find(a=>a.name===item.name);
            if(preset) item.loss = preset.loss;
          }
          if(k==='loss') item.loss = Math.max(0, parseFloat(el.value||0));
        }
        render();
      };
    });

    row.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.onclick = ()=>{
        const act = btn.dataset.act;
        if(act==='del'){ items.splice(idx,1); }
        if(act==='up' && idx>0){ [items[idx-1],items[idx]] = [items[idx],items[idx-1]]; }
        if(act==='down' && idx<items.length-1){ [items[idx+1],items[idx]] = [items[idx],items[idx+1]]; }
        render();
      };
    });
    return row;
  }

  function builderNozzleRow(){
    const row = document.createElement('div');
    row.className = 'item';
    const name = nozzle ? nozzle.name : 'None selected';
    row.innerHTML = `
      <div><div>🔫 Nozzle</div><div class="note">${name}</div></div>
      <div class="actions">
        <button class="btn" id="pickNozzleBtn">Choose…</button>
        ${nozzle?'<button class="btn" id="clearNozzleBtn">Clear</button>':''}
      </div>`;
    row.querySelector('#pickNozzleBtn').onclick = pickNozzle;
    if(nozzle){ row.querySelector('#clearNozzleBtn').onclick = ()=>{ nozzle=null; render(); }; }
    return row;
  }

  function pickNozzle(){
    const list = NOZZLES.map(n=>n.name).join(', ');
    const sel = prompt(`Pick nozzle:\n${list}\n${nozzle?`(current: ${nozzle.name})`:''}`, nozzle?.name || "Fog 150");
    const found = NOZZLES.find(n=>n.name.toLowerCase()===String(sel||'').toLowerCase());
    if(found){ nozzle = found; render(); }
  }

  // ---------- Renderers ----------
  function renderBuilder(){
    const list = document.getElementById('builderList');
    list.innerHTML = '';
    items.forEach((it,i)=> list.appendChild(builderRow(it,i)));
    list.appendChild(builderNozzleRow());
  }

  function renderMath(){
    const out = calc();
    document.getElementById('GPM').textContent = `${out.Q} gpm`;
    document.getElementById('PDP').textContent = `${Math.round(out.PDP)} psi`;
    const hoseLines = out.hoses.map(h=>`H${h.i}: C=${h.C}, ${h.length}ft × ${h.dia}″ @ ${out.Q}gpm → FL=${h.segFL.toFixed(1)}psi`).join(' • ');
    const appLines = out.apps.length ? (' • Apps: '+out.apps.map(a=>`${a.name} ${Number(a.loss||0)}psi`).join(', ')) : '';
    const elevLine = ` • Elev: ${elevFt}ft (${out.elevPsi.toFixed(1)}psi)`;
    const npLine = `NP=${out.NP}psi`;
    document.getElementById('breakdown').textContent =
      `${npLine} • Total FL=${out.totalFL.toFixed(1)}psi${appLines}${elevLine}` + (hoseLines?(' • '+hoseLines):'');
    document.getElementById('equation').textContent =
      `PDP = NP(${out.NP}) + FL(${out.totalFL.toFixed(1)}) + APP(${out.totalApp.toFixed(1)}) ${out.elevPsi>=0?'+':'-'} Elev(${Math.abs(out.elevPsi).toFixed(1)})`;
  }

  function renderDiagram(){
    const hosePath = document.getElementById('hosePath');
    const hoseStripePath = document.getElementById('hoseStripePath');
    const cplStart = document.getElementById('cplStart');
    const cplEnd   = document.getElementById('cplEnd');
    const wyeImg   = document.getElementById('wyeImg');
    const nozImg   = document.getElementById('nozImg');
    const label    = document.getElementById('pathLabel');

    if(items.length===0){
      hosePath.setAttribute('d',''); hoseStripePath.setAttribute('d','');
      [cplStart,cplEnd,wyeImg,nozImg].forEach(el=>{ el.setAttribute('x',-100); el.setAttribute('y',-100); });
      label.textContent = 'Add components to begin…';
      return;
    }

    // Build hose curve
    const {p0,p1,p2,p3,d} = pathForChain();
    hosePath.setAttribute('d', d);
    hoseStripePath.setAttribute('d', d);

    // Thickness by first hose dia
    const firstDia = (items.find(i=>i.type==='hose')?.dia) || '1.75';
    const sw = STROKE[firstDia] || 12;
    hosePath.setAttribute('stroke-width', sw);
    hoseStripePath.setAttribute('stroke-width', Math.max(6, sw-3));

    // Start & end couplings
    cplStart.setAttribute('x', p0.x - 9); cplStart.setAttribute('y', p0.y - 9);
    cplEnd.setAttribute('x', p3.x - 9);   cplEnd.setAttribute('y', p3.y - 9);

    // If a wye is present anywhere, drop icon mid-path
    const hasWye = items.some(i=>i.type==='appliance' && /wye/i.test(i.name));
    if(hasWye){
      const mid = cubicPoint(p0,p1,p2,p3,0.55);
      wyeImg.setAttribute('x', mid.x - 13); wyeImg.setAttribute('y', mid.y - 13);
    } else {
      wyeImg.setAttribute('x', -100); wyeImg.setAttribute('y', -100);
    }

    // Nozzle sprite + orientation
    if(nozzle){
      const tEnd = cubicTangent(p0,p1,p2,p3,0.99);
      const angle = Math.atan2(tEnd.y, tEnd.x) * 180/Math.PI;
      const isSB = /SB|ChiefXD .*@50|15\/16|7\/8|1\"/.test(nozzle.name);
      nozImg.setAttribute('href', isSB ? './assets/overlay_nozzle_sb_160.png'
                                       : './assets/overlay_nozzle_fog_160.png');
      nozImg.setAttribute('x', p3.x - 13);
      nozImg.setAttribute('y', p3.y - 13);
      nozImg.setAttribute('transform', `rotate(${angle}, ${p3.x}, ${p3.y})`);
      label.textContent = `${firstDia}″ • total ${items.filter(i=>i.type==='hose').reduce((s,h)=>s+h.length,0)} ft • ${nozzle.name}`;
    } else {
      nozImg.setAttribute('x', -100); nozImg.setAttribute('y', -100);
      nozImg.removeAttribute('transform');
      label.textContent = `${firstDia}″ • total ${items.filter(i=>i.type==='hose').reduce((s,h)=>s+h.length,0)} ft`;
    }
  }

  function render(){
    elevFt = parseFloat(document.getElementById('elevFt').value || 0);
    elevPsiPerFt = parseFloat(document.getElementById('elevPsi').value || 0.434);
    renderBuilder();
    renderDiagram();
    renderMath();
  }

  // Env listeners
  document.getElementById('elevFt').oninput = render;
  document.getElementById('elevPsi').oninput = render;

  // Initial render
  render();
</script>
</body>
</html>
