<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pump Pressure — Visual Builder (ENGINE 181)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8;
    --edge:rgba(255,255,255,.14);
    --hose5:#ecd464; --hose25:#f2994a; --hose175:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  header{position:sticky;top:0;z-index:3;padding:8px 12px;background:linear-gradient(180deg,#0c1320 0%,#0b0f14 100%);border-bottom:1px solid var(--edge)}
  h1{font-size:15px;margin:0}
  .sub{font-size:11px;color:var(--muted)}

  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge)}
  .scroll{height:65vh;overflow:auto;background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative;width:100%;min-height:520px}
  #engine{display:block;width:100%;height:auto;position:absolute;bottom:0;left:0}
  #overlay{position:absolute;inset:0;display:block;width:100%;height:100%}
  .hint{position:absolute;top:8px;left:10px;font-size:12px;color:#f7e39a}

  /* Left tools */
  .side{position:fixed;left:8px;top:72px;z-index:4;display:flex;flex-direction:column;gap:8px}
  .fab{width:44px;height:44px;border-radius:12px;border:1px solid var(--edge);background:#0b1320;color:#eaf2ff;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .fab:active{transform:translateY(1px)}
  .drawer{position:fixed;left:60px;top:72px;z-index:5;background:#0b1320;border:1px solid var(--edge);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.35);width:min(78vw,340px);max-width:340px;display:none}
  .drawer.open{display:block}
  .row{display:flex;flex-wrap:wrap;gap:8px;padding:8px 10px}
  .row button{background:#12203a;border:1px solid var(--edge);color:#eaf2ff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}

  /* Panels */
  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#9fb0c8;display:block;margin-bottom:4px}
  input{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
  .kpi b{font-size:20px}
  .note{font-size:12px;color:#9fb0c8}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320}
  .actions{display:flex;gap:6px;align-items:center}
  .actions select,.actions button{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:8px;padding:6px 8px;font-size:13px}
</style>
</head>
<body>
<div class="app">

  <header>
    <h1>Pump Pressure — Visual Builder</h1>
    <div class="sub">Left tools • Hose stack touches the truck</div>
  </header>

  <!-- Left buttons -->
  <div class="side">
    <button class="fab" id="openHose">Hose</button>
    <button class="fab" id="openAcc">Acc</button>
    <button class="fab" id="openNoz">Noz</button>
  </div>

  <!-- Hose drawer -->
  <div class="drawer" id="drawerHose" role="dialog" aria-label="Hose options">
    <div class="row">
      <button data-hose='{"type":"hose","size":"5","lengthFt":100}'>5″ 100′</button>
      <button data-hose='{"type":"hose","size":"2.5","lengthFt":50}'>2½″ 50′</button>
      <button data-hose='{"type":"hose","size":"1.75","lengthFt":100}'>1¾″ 100′</button>
      <button data-hose='{"type":"hose","size":"1.75","lengthFt":50}'>1¾″ 50′</button>
      <button data-act="clearHose">Clear hoses</button>
    </div>
  </div>

  <!-- Accessory drawer -->
  <div class="drawer" id="drawerAcc" role="dialog" aria-label="Accessory options">
    <div class="row">
      <button data-acc='{"type":"acc","name":"Wye/Siamese","loss":10}'>Wye/Siamese (+10)</button>
      <button data-acc='{"type":"acc","name":"In-line eductor","loss":25}'>In-line eductor (+25)</button>
      <button data-acc='{"type":"acc","name":"Master monitor","loss":25}'>Master monitor (+25)</button>
      <button data-acc='{"type":"acc","name":"Standpipe/PRV","loss":25}'>Standpipe/PRV (+25)</button>
      <button data-act="accCustom">Custom…</button>
      <button data-act="clearAcc">Clear accessories</button>
    </div>
  </div>

  <!-- Nozzle drawer -->
  <div class="drawer" id="drawerNoz" role="dialog" aria-label="Nozzle options">
    <div class="row" id="nozRow"></div>
  </div>

  <!-- Stage -->
  <div class="wrapper">
    <div id="scroll" class="scroll">
      <div id="stage" class="stage">
        <img id="engine" alt="ENGINE 181" src="https://fireopssim.com/pump/engine181.png" />
        <svg id="overlay" viewBox="0 0 390 800" preserveAspectRatio="none" aria-label="Diagram overlay">
          <g id="hoseGroup"></g>
          <g id="accGroup"></g>
          <g id="nozzleGroup"></g>
          <g id="portGroup"></g>
          <text class="hint" id="hint">Tap Hose and add a segment…</text>
        </svg>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div class="panel">
    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Environment</h3>
      <div class="grid2">
        <div><label>Elevation (ft)</label><input id="elevFt" type="number" step="5" value="0" /></div>
        <div><label>Elevation factor (psi/ft)</label><input id="elevPsi" type="number" step="0.001" value="0.434" /></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Build List</h3>
      <div class="list" id="builderList"></div>
    </div>

    <div class="card">
      <div class="eq" id="equation">PDP = NP + ΣFL(hose @ GPM) + ΣAccessory ± Elev</div>
      <div class="kpis" style="margin-top:8px">
        <div class="kpi"><div>Flow</div><b id="GPM">— gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">— psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </div>

</div>

<script>
  // ===== CONFIG =====
  const STAGE_W = 390;
  const PX_PER_50FT = 80;
  const HOSE_X_RATIO = 0.77;     // move attach point left/right
  const ROOF_RATIO   = 0.76;     // <— % down inside the image where the truck roof sits
  const HOSE_TOUCH_OFFSET = -6;  // push hose slightly into the roof

  const HOSE_WIDTH = { "5": 12, "2.5": 9, "1.75": 6 };
  const HOSE_COLOR = { "5": "var(--hose5)", "2.5": "var(--hose25)", "1.75": "var(--hose175)" };
  const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };

  const NOZZLES = [
    {name:"None (closed)", gpm:0, NP:0},
    {name:"Fog 95", gpm:95, NP:100},
    {name:"Fog 125", gpm:125, NP:100},
    {name:"Fog 150", gpm:150, NP:100},
    {name:'SB 7/8″', gpm:160, NP:50},
    {name:'SB 15/16″', gpm:185, NP:50},
    {name:'SB 1″', gpm:210, NP:50},
    {name:"ChiefXD 100 @50", gpm:100, NP:50},
    {name:"ChiefXD 150 @50", gpm:150, NP:50},
    {name:"ChiefXD 150 @75", gpm:150, NP:75},
    {name:"ChiefXD 185 @75", gpm:185, NP:75}
  ];

  // ===== STATE =====
  let items = []; // {type:'hose', size, lengthFt} | {type:'acc', name, loss}
  let nozzle = NOZZLES[3];
  let elevFt = 0, elevPsiPerFt = 0.434;

  // ===== ELEMENTS =====
  const engineImg = document.getElementById('engine');
  const stage = document.getElementById('stage');
  const scrollEl = document.getElementById('scroll');
  const overlay = document.getElementById('overlay');
  const hoseGroup = document.getElementById('hoseGroup');
  const accGroup = document.getElementById('accGroup');
  const nozzleGroup = document.getElementById('nozzleGroup');
  const portGroup = document.getElementById('portGroup');
  const hint = document.getElementById('hint');
  const builderList = document.getElementById('builderList');

  // ===== UI (drawers) =====
  const drawerHose = document.getElementById('drawerHose');
  const drawerAcc  = document.getElementById('drawerAcc');
  const drawerNoz  = document.getElementById('drawerNoz');

  function closeDrawers(){ drawerHose.classList.remove('open'); drawerAcc.classList.remove('open'); drawerNoz.classList.remove('open'); }
  document.getElementById('openHose').onclick = (e)=>{ e.stopPropagation(); toggleDrawer(drawerHose); };
  document.getElementById('openAcc').onclick  = (e)=>{ e.stopPropagation(); toggleDrawer(drawerAcc); };
  document.getElementById('openNoz').onclick  = (e)=>{ e.stopPropagation(); toggleDrawer(drawerNoz); };
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.drawer') && !e.target.closest('.fab')) closeDrawers(); });
  function toggleDrawer(el){ const was = el.classList.contains('open'); closeDrawers(); if(!was) el.classList.add('open'); }

  drawerHose.querySelectorAll('button[data-hose]').forEach(btn=>{
    btn.onclick = ()=>{ items.push(JSON.parse(btn.dataset.hose)); closeDrawers(); render(true); };
  });
  drawerHose.querySelector('[data-act="clearHose"]').onclick = ()=>{ items = items.filter(x=>x.type!=='hose'); closeDrawers(); render(true); };

  drawerAcc.querySelectorAll('button[data-acc]').forEach(btn=>{
    btn.onclick = ()=>{ const d=JSON.parse(btn.dataset.acc); items.push({type:'acc',name:d.name,loss:+d.loss||0}); closeDrawers(); render(true); };
  });
  drawerAcc.querySelector('[data-act="accCustom"]').onclick = ()=>{
    const name = prompt('Accessory name?','Appliance'); if(name===null) return;
    const loss = parseFloat(prompt('Pressure loss (psi)?','10')||'0');
    items.push({type:'acc', name:name||'Custom', loss:isNaN(loss)?0:loss});
    closeDrawers(); render(true);
  };
  drawerAcc.querySelector('[data-act="clearAcc"]').onclick = ()=>{ items = items.filter(x=>x.type!=='acc'); closeDrawers(); render(true); };

  const nozRow = document.getElementById('nozRow');
  NOZZLES.forEach(n=>{ const b=document.createElement('button'); b.textContent=`${n.name} (${n.gpm} gpm, NP ${n.NP})`; b.onclick=()=>{ nozzle=n; closeDrawers(); render(false); }; nozRow.appendChild(b); });

  // ===== MATH =====
  function fl(C, Q, L){ return (C||0) * Math.pow(Q/100, 2) * (L/100); }
  function calc(){
    const Q = nozzle.gpm || 0, NP = nozzle.NP || 0;
    let totalFL=0, totalAcc=0; const hoses=[], accs=[];
    items.forEach((it, idx)=>{
      if(it.type==='hose'){
        const C = COEFF[it.size]||0, segFL=fl(C,Q,it.lengthFt);
        totalFL += segFL; hoses.push({i:idx+1, ...it, C, segFL});
      } else { totalAcc += +it.loss||0; accs.push({i:idx+1, ...it}); }
    });
    const elevPsi = elevFt * elevPsiPerFt;
    return {Q, NP, totalFL, totalAcc, elevPsi, PDP: NP + totalFL + totalAcc + elevPsi, hoses, accs};
  }

  // ===== GEO HELPERS =====
  function stageWidthPx(){ return stage.clientWidth || window.innerWidth || 390; }
  function hoseXpx(){ return Math.round(stageWidthPx() * HOSE_X_RATIO); }
  function toVBX(px){ return px / stageWidthPx() * STAGE_W; }
  function toVBY(px){ return px; } // y is 1:1 after we set viewBox height to stageH

  // ===== DRAW =====
  function renderDiagram(){
    // Real rendered image height by aspect ratio
    const nW = engineImg.naturalWidth || 0;
    const nH = engineImg.naturalHeight || 0;
    const eH = (nW && nH) ? (stageWidthPx() * (nH / nW)) : (engineImg.clientHeight || 180);

    // Stack sizing
    const hoseFeet = items.filter(x=>x.type==='hose').reduce((s,h)=>s+h.lengthFt,0);
    const hosePx   = (hoseFeet/50) * PX_PER_50FT;
    const accPx    = items.filter(x=>x.type==='acc').length * 22;
    const topPad   = 120;

    // Stage height and viewBox
    const stageH = Math.max(520, eH + hosePx + accPx + topPad);
    stage.style.height = stageH + 'px';
    overlay.setAttribute('viewBox', `0 0 ${STAGE_W} ${Math.round(stageH)}`);

    // True top of the PNG image within the stage
    const imageTopPx = stageH - eH;

    // *** Roof is lower than image top due to padding inside the PNG ***
    // Use a ratio of the image height to land on the cab roof.
    const roofY = imageTopPx + (eH * ROOF_RATIO);

    // Start hose with slight overlap
    let currentTopPx = roofY + HOSE_TOUCH_OFFSET;
    const xPx = hoseXpx();

    // Clear SVG layers
    hoseGroup.innerHTML = '';
    accGroup.innerHTML = '';
    nozzleGroup.innerHTML = '';
    portGroup.innerHTML = '';

    // Visual discharge port at the attach point
    const port = document.createElementNS('http://www.w3.org/2000/svg','circle');
    port.setAttribute('cx', toVBX(xPx));
    port.setAttribute('cy', toVBY(roofY));
    port.setAttribute('r', toVBX(6));
    port.setAttribute('fill', '#2b3142');
    port.setAttribute('stroke', '#111622');
    port.setAttribute('stroke-width', '1.5');
    portGroup.appendChild(port);

    if(items.length===0){ hint.textContent='Tap Hose and add a segment…'; return; }
    hint.textContent='';

    // Draw hoses & accessories upward
    for(const it of items){
      if(it.type==='hose'){
        const wPx = HOSE_WIDTH[it.size]||6;
        const hPx = (it.lengthFt===50 ? PX_PER_50FT : 2*PX_PER_50FT);
        const yPx = currentTopPx - hPx;

        const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
        r.setAttribute('x', toVBX(xPx - wPx/2));
        r.setAttribute('y', toVBY(yPx));
        r.setAttribute('width', toVBX(wPx));
        r.setAttribute('height', toVBY(hPx));
        r.setAttribute('fill', HOSE_COLOR[it.size]);
        r.setAttribute('stroke','rgba(255,255,255,.10)');
        r.setAttribute('stroke-width','1');
        hoseGroup.appendChild(r);

        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', toVBX(xPx - wPx/2));
        line.setAttribute('x2', toVBX(xPx + wPx/2));
        line.setAttribute('y1', toVBY(yPx));
        line.setAttribute('y2', toVBY(yPx));
        line.setAttribute('stroke','#2b3242'); line.setAttribute('stroke-width','2');
        hoseGroup.appendChild(line);

        currentTopPx -= hPx;
      } else {
        const boxYpx = currentTopPx - 18;

        const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
        bg.setAttribute('x', toVBX(xPx + 10));
        bg.setAttribute('y', toVBY(boxYpx));
        bg.setAttribute('width', 120);
        bg.setAttribute('height', 18);
        bg.setAttribute('rx', 6); bg.setAttribute('ry', 6);
        bg.setAttribute('fill', '#172134'); bg.setAttribute('stroke','rgba(255,255,255,.15)');
        accGroup.appendChild(bg);

        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', toVBX(xPx + 16));
        txt.setAttribute('y', toVBY(boxYpx + 12));
        txt.setAttribute('fill', '#cfe4ff'); txt.setAttribute('font-size', '10');
        txt.textContent = `${it.name} (+${it.loss} psi)`;
        accGroup.appendChild(txt);

        currentTopPx -= 22;
      }
    }

    // Nozzle glyph on top
    const lastHose = items.filter(i=>i.type==='hose').slice(-1)[0];
    const wTopPx = lastHose ? (HOSE_WIDTH[lastHose.size] || 6) : 8;

    const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', toVBX(xPx - wTopPx/2 - 4));
    body.setAttribute('y', toVBY(currentTopPx - 22));
    body.setAttribute('width', toVBX(wTopPx + 8));
    body.setAttribute('height', toVBY(18));
    body.setAttribute('fill', '#394357');
    nozzleGroup.appendChild(body);

    const tip = document.createElementNS('http://www.w3.org/2000/svg','rect');
    tip.setAttribute('x', toVBX(xPx - (wTopPx*0.4)));
    tip.setAttribute('y', toVBY(currentTopPx - 30));
    tip.setAttribute('width', toVBX(wTopPx*0.8));
    tip.setAttribute('height', toVBY(8));
    tip.setAttribute('fill', '#9aa7bd');
    nozzleGroup.appendChild(tip);

    // Info
    const totalFeet = items.filter(i=>i.type==='hose').reduce((s,h)=>s+h.lengthFt,0);
    hint.textContent = `Total hose: ${totalFeet}′ • Items: ${items.length}`;
  }

  // ===== Builder List & Math =====
  function row(it, idx){
    const div = document.createElement('div'); div.className='item';
    if(it.type==='hose'){
      div.innerHTML = `
        <div><div>🧯 Hose <small>#${idx+1}</small></div>
             <div class="note">${it.size}″ • ${it.lengthFt}′</div></div>
        <div class="actions">
          <select data-k="size">
            <option value="5" ${it.size==='5'?'selected':''}>5″</option>
            <option value="2.5" ${it.size==='2.5'?'selected':''}>2½″</option>
            <option value="1.75" ${it.size==='1.75'?'selected':''}>1¾″</option>
          </select>
          <select data-k="lengthFt">
            <option value="50" ${it.lengthFt===50?'selected':''}>50′</option>
            <option value="100" ${it.lengthFt===100?'selected':''}>100′</option>
          </select>
          <button data-act="dup">＋</button><button data-act="up">↑</button><button data-act="down">↓</button><button data-act="del">✕</button>
        </div>`;
    } else {
      div.innerHTML = `
        <div><div>⚙️ Accessory <small>#${idx+1}</small></div>
             <div class="note">${it.name} • +${it.loss} psi</div></div>
        <div class="actions">
          <button data-act="loss">Loss</button><button data-act="rename">Name</button>
          <button data-act="up">↑</button><button data-act="down">↓</button><button data-act="del">✕</button>
        </div>`;
    }
    div.querySelectorAll('select').forEach(s=>{
      s.onchange = ()=>{ const k=s.dataset.k; if(k==='size') it.size=s.value; if(k==='lengthFt') it.lengthFt=parseInt(s.value,10); render(); };
    });
    div.querySelectorAll('button[data-act]').forEach(b=>{
      b.onclick = ()=>{
        const act=b.dataset.act;
        if(act==='dup'){ items.splice(idx+1,0, structuredClone(it)); }
        if(act==='del'){ items.splice(idx,1); }
        if(act==='up' && idx>0){ [items[idx-1],items[idx]]=[items[idx],items[idx-1]]; }
        if(act==='down' && idx<items.length-1){ [items[idx+1],items[idx]]=[items[idx],items[idx+1]]; }
        if(act==='loss' && it.type!=='hose'){ const v=parseFloat(prompt('Accessory loss (psi):', String(it.loss))||String(it.loss)); if(!isNaN(v)) it.loss=v; }
        if(act==='rename' && it.type!=='hose'){ const v=prompt('Accessory name:', it.name); if(v!==null) it.name=v||it.name; }
        render(true);
      };
    });
    return div;
  }
  function renderBuilder(){
    builderList.innerHTML=''; if(items.length===0){
      const e=document.createElement('div'); e.className='item'; e.innerHTML='<div>Use the left tools: add <b>Hose</b>, <b>Accessory</b>, then pick a <b>Nozzle</b>.</div>'; builderList.appendChild(e);
    } else { items.forEach((it,i)=> builderList.appendChild(row(it,i))); }
  }
  function calcAndRenderMath(){
    const {Q, NP, totalFL, totalAcc, elevPsi, PDP, hoses, accs} = calc();
    document.getElementById('GPM').textContent = `${Q} gpm`;
    document.getElementById('PDP').textContent = `${Math.round(PDP)} psi`;
    const partsH = hoses.map(h=>`H${h.i}: ${h.size}″ ${h.lengthFt}′ → FL=${h.segFL.toFixed(1)} psi`).join(' • ');
    const partsA = accs.length ? (' • Acc: '+accs.map(a=>`${a.name}+${a.loss}`).join(', ')) : '';
    const elev = `Elev=${elevPsi.toFixed(1)} psi`;
    const np = `NP=${NP} psi`;
    const tFL = `Total FL=${totalFL.toFixed(1)} psi`;
    const tAcc = `Accessories=${totalAcc.toFixed(1)} psi`;
    document.getElementById('breakdown').textContent = `${np} • ${tFL} • ${tAcc} • ${elev}${partsH?(' • '+partsH):''}${partsA}`;
    document.getElementById('equation').textContent = `PDP = NP(${NP}) + FL(${totalFL.toFixed(1)}) + ACC(${totalAcc.toFixed(1)}) ${elevPsi>=0?'+':'-'} Elev(${Math.abs(elevPsi).toFixed(1)})`;
  }

  // ===== RENDER =====
  function render(autoScroll=false){
    renderDiagram();
    renderBuilder();
    calcAndRenderMath();
    if(autoScroll){ setTimeout(()=>{ scrollEl.scrollTop = scrollEl.scrollHeight; }, 0); }
  }

  if(engineImg.complete) render(true);
  engineImg.onload = ()=> render(true);
  window.addEventListener('resize', ()=> render(false));
</script>
</body>
</html>
