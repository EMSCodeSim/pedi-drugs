<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>FireOps SIM ‚Äî Visual Pump Builder</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8; --edge:rgba(255,255,255,.14);
    --hose5:#ecd464;       /* 5" */
    --hose25:#6ecbff;      /* 2¬Ω" (blue) */
    --hose175:#ff6b6b;     /* 1¬æ" (red) */
    --bubble:#172134; --bubble-edge:rgba(255,255,255,.15);
    --btn:#0b1320; --btnEdge:#20324f;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  header{position:sticky;top:0;z-index:100;padding:10px 14px;background:linear-gradient(180deg,#0c1320,#0b0f14);border-bottom:1px solid var(--edge)}
  .title{font-weight:700}
  .sub{font-size:12px;color:#9fb0c8}

  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge);background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative;width:100%;max-width:900px;margin:0 auto;min-height:260px}
  #overlay{position:absolute;inset:0;width:100%;height:100%;display:block;pointer-events:auto}
  .info{position:absolute;left:50%;top:8px;transform:translateX(-50%);background:var(--bubble);border:1px solid var(--bubble-edge);border-radius:999px;padding:6px 10px;font-size:12px;z-index:15}

  .linebar{
    position:absolute;left:0;right:0;bottom:8px;
    display:flex;justify-content:center;align-items:center;gap:6px;z-index:16;flex-wrap:nowrap;padding:0 8px;
  }
  .linebtn,.supplybtn{
    background:var(--btn);border:1px solid var(--btnEdge);color:#eaf2ff;border-radius:10px;
    padding:10px 12px;font-size:14px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.35);white-space:nowrap
  }
  .linebtn.active{outline:2px solid #3aa7ff}
  @media (max-width:390px){ .linebtn,.supplybtn{padding:9px 10px;font-size:13px} .linebar{gap:4px} }

  .hoseBase{fill:none;stroke-linecap:round;stroke-linejoin:round}
  .hose5{stroke:var(--hose5);stroke-width:12}
  .hose25{stroke:var(--hose25);stroke-width:9}
  .hose175{stroke:var(--hose175);stroke-width:6}
  .shadow{stroke:rgba(0,0,0,.35);stroke-width:12}

  .hose-end{cursor:pointer;pointer-events:all}
  .plus-hit{fill:transparent;stroke:transparent;rx:12;ry:12}
  .plus-circle{fill:#fff;stroke:#111;stroke-width:1.5;filter:drop-shadow(0 2px 4px rgba(0,0,0,.45))}
  .plus-sign{stroke:#111;stroke-width:3;stroke-linecap:round}

  .picker{
    position:absolute; background:#0b1320;border:1px solid var(--bubble-edge);border-radius:12px;
    min-width:300px;padding:8px; z-index:50; box-shadow:0 18px 40px rgba(0,0,0,.55); display:none;
  }
  .picker h3{font-size:12px;color:#cfe4ff;margin:4px 8px 8px}
  .section-title{font-size:11px;color:#9fb0c8;margin:4px 8px 6px}
  .picker-actions{display:flex;gap:6px;flex-wrap:wrap;padding:6px 8px 10px}
  .pick-small{font-size:12px;padding:8px 10px;border-radius:10px;background:#0b1a29;border:1px solid #1f3a57;cursor:pointer}
  .pick-small:hover{background:#0e2337}
  .picker-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:4px 6px 8px}
  .pick{display:flex;align-items:center;gap:8px;background:#0b1a29;border:1px solid #1f3a57;border-radius:10px;padding:10px;cursor:pointer}
  .pick:hover{background:#0e2337}
  .row{display:flex;gap:8px;align-items:center;padding:6px 8px}
  .row input, .row select{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:8px 10px;font-size:14px}

  .dropdown{
    position:absolute; z-index:40; display:none; pointer-events:auto;
    background:#0b1320;border:1px solid var(--edge);border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.45);overflow:hidden;
  }
  .dropdown button{
    display:block;width:100%;text-align:left;background:none;border:0;color:#eaf2ff;padding:10px 12px;font-size:14px;cursor:pointer
  }
  .dropdown button:hover{background:#0e2337}

  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px;font-size:13px;color:#cfe4ff}
  .kpi b{font-size:18px}
  .linesTable{margin-top:8px;border-top:1px solid var(--edge);padding-top:8px;display:grid;gap:10px}

  .lineRow{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:8px 10px}
  .lineRow .title{font-weight:700;margin-right:8px}
  .lineRow .break{font-size:12px;color:#cfe4ff;min-width:260px}

  .lbl{font-size:10px;fill:#0b0f14}

  /* Visual math breakdown */
  details.math{background:#0b1a29;border:1px solid #1f3a57;border-radius:12px;padding:8px 10px;margin-top:8px}
  details.math summary{cursor:pointer;color:#cfe4ff;font-weight:700}
  .hoseviz{margin-top:8px}
  .hoseLegend{display:flex;gap:10px;align-items:center;font-size:11px;color:#cfe4ff;margin:4px 0 8px}
  .legSwatch{width:14px;height:8px;border-radius:3px;display:inline-block;border:1px solid rgba(0,0,0,.35)}
  .sw175{background:var(--hose175)}
  .sw25{background:var(--hose25)}
  .sw5{background:var(--hose5)}
  .barWrap{background:#0b1320;border:1px solid #1f3a57;border-radius:10px;padding:8px;margin:6px 0}
  .barTitle{font-size:12px;color:#9fb0c8;margin-bottom:6px}
  .ppEq{font-size:14px;color:#eaf2ff;margin-top:6px;font-weight:700}
  .ctrls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
  .ctrls select,.ctrls input{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:8px 10px;font-size:13px}
  .ctrls .miniBtn{background:#0b1a29;border:1px solid #1f3a57;border-radius:10px;padding:8px 10px;font-size:12px;cursor:pointer}
  .ctrls .miniBtn:hover{background:#0e2337}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="title">FireOps SIM ‚Äî Visual Pump Builder</div>
    <div class="sub">Deploy a line to show it on the rig and see the math. Use the + bubbles on the rig to add hose/nozzle/wye/elevation.</div>
  </header>

  <section class="wrapper">
    <div class="stage" id="stage">
      <svg id="overlay" viewBox="0 0 390 260" preserveAspectRatio="xMidYMax meet" aria-label="Visual stage">
        <image id="truckImg" href="https://fireopssim.com/pump/engine181.png" x="0" y="0" width="390" height="260" preserveAspectRatio="xMidYMax meet"></image>
        <g id="hoses"></g><g id="branches"></g><g id="labels"></g><g id="tips"></g>
        <g id="supplyG"></g>
      </svg>

      <div class="info" id="topInfo">No lines deployed</div>

      <div class="linebar" id="linebar">
        <button class="linebtn" data-line="left">Line 1</button>
        <button class="linebtn" data-line="back">Line 2</button>
        <button class="linebtn" data-line="right">Line 3</button>
        <button class="supplybtn" id="supplyBtn">Supply ‚ñæ</button>
        <div id="supplyMenu" class="dropdown" role="menu" aria-hidden="true">
          <button data-supply="drafting">Drafting</button>
          <button data-supply="pressurized">Pressurized</button>
          <button data-supply="relay">Relay</button>
          <button data-supply="none">Clear</button>
        </div>
      </div>

      <!-- + Picker -->
      <div id="picker" class="picker" role="dialog" aria-modal="true" aria-hidden="true">
        <h3 id="pickerTitle">Hose</h3>
        <div id="pickHome">
          <div class="picker-grid">
            <div class="pick" data-view="addhose">‚ûï Add Hose</div>
            <div class="pick" data-view="nozzle">üß© Change Nozzle</div>
            <div class="pick" data-view="accessory">‚öôÔ∏è Add/Remove Wye</div>
            <div class="pick" data-view="elevation">‚õ∞Ô∏è Elevation</div>
            <div class="pick" data-view="setup">üõ†Ô∏è Change Setup</div>
          </div>
        </div>

        <div id="pickAdd" style="display:none">
          <div class="section-title">Add hose (same or smaller)</div>
          <div class="picker-actions" id="addBtns"></div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickNoz" style="display:none">
          <div class="section-title">Set nozzle for this side</div>
          <div class="picker-grid">
            <div class="pick" data-noz="chiefXD">ChiefXD 50 psi 185 gpm</div>
            <div class="pick" data-noz="smooth185">Smooth 185 @50</div>
            <div class="pick" data-noz="fog150_75">Fog 150 @75</div>
            <div class="pick" data-noz="sb265">SB 1 1/8‚Ä≥ 265 @50</div>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickAcc" style="display:none">
          <div class="section-title">Wye</div>
          <div class="picker-actions">
            <button class="pick-small" data-acc="wye">Add Wye (+10)</button>
            <button class="pick-small" data-acc="removeWye">Remove Wye</button>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickElev" style="display:none">
          <div class="section-title">Elevation (feet, ¬±)</div>
          <div class="row">
            <input id="elevInput" type="number" step="1" value="0">
            <small>√ó 0.434 psi/ft</small>
          </div>
          <div class="picker-actions">
            <button class="pick-small" data-save-elev>Save</button>
            <button class="pick-small" data-back>Cancel</button>
          </div>
        </div>

        <div id="pickSetup" style="display:none">
          <div class="section-title">Change main setup</div>
          <div class="row">
            <label>Size</label>
            <select id="setupSize">
              <option value="1.75">1¬æ‚Ä≥</option>
              <option value="2.5">2¬Ω‚Ä≥</option>
            </select>
            <label>Length</label>
            <select id="setupLen">
              <option>50</option><option>100</option><option>150</option>
              <option>200</option><option>250</option><option>300</option>
            </select>
          </div>
          <div class="row">
            <label>Nozzle</label>
            <select id="setupNoz">
              <option value="chiefXD">ChiefXD 50/185</option>
              <option value="smooth185">Smooth 185 @50</option>
              <option value="fog150_75">Fog 150 @75</option>
              <option value="sb265">SB 1 1/8‚Ä≥ 265 @50</option>
            </select>
          </div>
          <div class="picker-actions">
            <button class="pick-small" id="setupApply">Apply</button>
            <button class="pick-small" data-back>Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPIs + per-line editor -->
  <section class="panel">
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div>Total Flow (deployed)</div><b id="GPM">‚Äî gpm</b></div>
        <div class="kpi"><div>Max PP (deployed)</div><b id="PDP">‚Äî psi</b></div>
      </div>
      <div class="linesTable" id="linesTable"></div>
    </div>
  </section>

</div>

<script>
/* ===== Constants ===== */
const TRUCK_W = 390, TRUCK_H = 260;
const PX_PER_50FT = 45;
const PUMP_REL = { x:0.515, y:0.74 };
const CURVE_PULL = 36;
const BRANCH_LIFT = 10;
const PSI_PER_FT = 0.434;

const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };
const NOZ = {
  chiefXD:   {name:'ChiefXD', gpm:185, NP:50},
  smooth185: {name:'Smooth 185', gpm:185, NP:50},
  fog150_75: {name:'Fog 150', gpm:150, NP:75},
  sb265:     {name:'SB 1 1/8‚Ä≥', gpm:265, NP:50}
};
const COLORS = {"1.75":"#ff6b6b","2.5":"#6ecbff","5":"#ecd464"};

/* ===== State ===== */
function emptyHose(label, size, len, noz){
  return {
    label,
    itemsMain:[{size, lengthFt:len}],
    hasWye:false, wyeLoss:10,
    itemsLeft:[], itemsRight:[],
    nozLeft:noz, nozRight:noz,
    elevFt:0,
    visible:false
  };
}
const lines = {
  left:  emptyHose('Line 1','1.75',200, NOZ.chiefXD),
  back:  emptyHose('Line 2','1.75',200, NOZ.chiefXD),
  right: emptyHose('Line 3','2.5', 250, NOZ.sb265)
};
let plusContext = { key:null, where:'main' };
let currentSupply = 'none';

/* ===== DOM ===== */
const overlay   = document.getElementById('overlay');
const truckImg  = document.getElementById('truckImg');
const stage     = document.getElementById('stage');
const G_hoses   = document.getElementById('hoses');
const G_branches= document.getElementById('branches');
const G_labels  = document.getElementById('labels');
const G_tips    = document.getElementById('tips');
const topInfo   = document.getElementById('topInfo');

const picker    = document.getElementById('picker');
const pickerTitle = document.getElementById('pickerTitle');
const pickHome  = document.getElementById('pickHome');
const pickAdd   = document.getElementById('pickAdd');
const pickNoz   = document.getElementById('pickNoz');
const pickAcc   = document.getElementById('pickAcc');
const pickElev  = document.getElementById('pickElev');
const pickSetup = document.getElementById('pickSetup');
const elevInput = document.getElementById('elevInput');
const addBtns   = document.getElementById('addBtns');
const setupSize = document.getElementById('setupSize');
const setupLen  = document.getElementById('setupLen');
const setupNoz  = document.getElementById('setupNoz');

const linesTable= document.getElementById('linesTable');
const supplyBtn = document.getElementById('supplyBtn');
const supplyMenu= document.getElementById('supplyMenu');
const linebar   = document.getElementById('linebar');

/* ===== Helpers ===== */
function clsFor(size){ return size==='5'?'hose5':(size==='2.5'?'hose25':'hose175'); }
function sumFt(items){ return items.reduce((s,h)=>s + (h.lengthFt||0), 0); }
function FL(gpm, size, ft){ const C=COEFF[size]||0, Q=gpm/100; return C*(Q*Q)*(ft/100); }
function FLper100(gpm, size){ const C=COEFF[size]||0, Q=gpm/100; return C*(Q*Q); }
function clearGroup(g){ while(g.firstChild) g.removeChild(g.firstChild); }
function supplyHeight(){ return currentSupply==='drafting'?150: currentSupply==='pressurized'?150: currentSupply==='relay'?170: 0; }
function Cfor(size){ return COEFF[size]||0; }
function sizeLabel(sz){ return sz==='2.5'?'2¬Ω‚Ä≥':(sz==='1.75'?'1¬æ‚Ä≥':sz+'"'); }
function round(n){ return Math.round(n); }

/* Sections (<=100‚Ä≤ chunks) */
function splitIntoSections(segments){
  const out=[];
  segments.forEach(seg=>{
    let remain = seg.lengthFt||0;
    while(remain>0){
      const take = Math.min(100, remain);
      out.push({size:seg.size, lengthFt:take});
      remain -= take;
    }
  });
  return out;
}

function computeNeededHeightPx(){
  const needs = Object.values(lines).filter(l=>l.visible);
  let maxUp = 0;
  needs.forEach(L=>{
    const mainPx = (sumFt(L.itemsMain)/50)*PX_PER_50FT;
    let branchPx = 0;
    if(L.hasWye){
      const lpx = (sumFt(L.itemsLeft)/50)*PX_PER_50FT;
      const rpx = (sumFt(L.itemsRight)/50)*PX_PER_50FT;
      branchPx = Math.max(lpx, rpx) + BRANCH_LIFT;
    }
    maxUp = Math.max(maxUp, mainPx + branchPx);
  });
  return Math.max(TRUCK_H + supplyHeight() + 10, TRUCK_H + maxUp + 40 + supplyHeight());
}
function truckTopY(viewH){ return viewH - TRUCK_H - supplyHeight(); }
function pumpXY(viewH){
  const top = truckTopY(viewH);
  return { x: TRUCK_W * PUMP_REL.x, y: top + TRUCK_H * PUMP_REL.y };
}

/* Geometry for rig */
function mainCurve(dir, totalPx, viewH){
  const {x:sx,y:sy} = pumpXY(viewH);
  const ex = dir===-1 ? sx - 110 : dir===1 ? sx + 110 : sx;
  const ey = Math.max(10, sy - totalPx);
  const cx = (sx+ex)/2 + (dir===-1?-CURVE_PULL:dir===1?CURVE_PULL:0);
  const cy = sy - (sy-ey)*0.48;
  return { d:`M ${sx},${sy} Q ${cx},${cy} ${ex},${ey}`, startX:sx, startY:sy, endX:ex, endY:ey };
}
function straightBranch(side, startX, startY, totalPx){
  const dir = side==='L'?-1:1;
  const x = startX + dir*20;
  const y1 = startY - BRANCH_LIFT;
  const y2 = Math.max(8, y1 - totalPx);
  return { d:`M ${startX},${startY} L ${startX},${y1} L ${x},${y1} L ${x},${y2}`, endX:x, endY:y2 };
}

/* Draw segmented path on rig */
function drawSegmentedPath(group, basePath, segs, sizeToClass){
  const sh = document.createElementNS('http://www.w3.org/2000/svg','path');
  sh.setAttribute('class','hoseBase shadow');
  sh.setAttribute('d', basePath.getAttribute('d'));
  group.appendChild(sh);

  const total = basePath.getTotalLength();
  let offset = 0;
  const totalPx = (sumFt(segs)/50)*PX_PER_50FT || 1;
  segs.forEach(seg=>{
    const px = (seg.lengthFt/50)*PX_PER_50FT;
    const portion = Math.min(total, (px/totalPx)*total);
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('class', `hoseBase ${sizeToClass(seg.size)}`);
    p.setAttribute('d', basePath.getAttribute('d'));
    p.setAttribute('stroke-dasharray', `${portion} ${total}`);
    p.setAttribute('stroke-dashoffset', `${-offset}`);
    group.appendChild(p);
    offset += portion;
  });
}

/* Labels on rig */
function addLabel(text, x, y, dy=0){
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  const pad = 4;
  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('class','lbl'); t.setAttribute('x', x); t.setAttribute('y', y+dy); t.setAttribute('text-anchor','middle');
  t.textContent = text;
  g.appendChild(t); G_labels.appendChild(g);
  const bb = t.getBBox();
  const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
  bg.setAttribute('x', bb.x - pad); bg.setAttribute('y', bb.y - pad);
  bg.setAttribute('width', bb.width + pad*2); bg.setAttribute('height', bb.height + pad*2);
  bg.setAttribute('fill', '#eaf2ff'); bg.setAttribute('opacity', '0.92'); bg.setAttribute('stroke', '#111'); bg.setAttribute('stroke-width', '.5'); bg.setAttribute('rx','4'); bg.setAttribute('ry','4');
  g.insertBefore(bg, t);
}
function labelDyForLine(key){ return key==='left' ? -10 : key==='back' ? -22 : -34; }

/* ===== Draw complete rig ===== */
function drawAll(){
  const viewH = Math.ceil(computeNeededHeightPx());
  overlay.setAttribute('viewBox', `0 0 ${TRUCK_W} ${viewH}`);
  stage.style.height = viewH + 'px';
  truckImg.setAttribute('y', String(truckTopY(viewH)));

  clearGroup(G_hoses); clearGroup(G_branches); clearGroup(G_tips); clearGroup(G_labels);

  const visibleKeys = ['left','back','right'].filter(k=>lines[k].visible);
  topInfo.textContent = visibleKeys.length ? `Deployed: ${visibleKeys.map(k=>lines[k].label).join(' ‚Ä¢ ')}` : 'No lines deployed';

  ['left','back','right'].filter(k=>lines[k].visible).forEach(key=>{
    const L = lines[key];
    const dir = key==='left'?-1:key==='right'?1:0;
    const mainFt = sumFt(L.itemsMain);
    const geom = mainCurve(dir, (mainFt/50)*PX_PER_50FT, Math.ceil(computeNeededHeightPx()));

    const base = document.createElementNS('http://www.w3.org/2000/svg','path');
    base.setAttribute('d', geom.d);
    G_hoses.appendChild(base);

    drawSegmentedPath(G_hoses, base, L.itemsMain, clsFor);
    addTip(key,'main',geom.endX,geom.endY);

    // nozzle info label(s)
    if(L.hasWye){
      addLabel(`Nozzles ${L.nozLeft.gpm}/${L.nozRight.gpm} gpm @ ${L.nozRight.NP} psi`, geom.endX, geom.endY-6, labelDyForLine(key)-10);
    }else{
      addLabel(`${L.nozRight.name} ${L.nozRight.NP} psi ${L.nozRight.gpm} gpm`, geom.endX, geom.endY-6, labelDyForLine(key)-10);
    }

    // Wye branches
    if(L.hasWye){
      if(sumFt(L.itemsLeft)>0){
        const gL = straightBranch('L', geom.endX, geom.endY, (sumFt(L.itemsLeft)/50)*PX_PER_50FT);
        const pathL = document.createElementNS('http://www.w3.org/2000/svg','path');
        pathL.setAttribute('d', gL.d); G_branches.appendChild(pathL);
        drawSegmentedPath(G_branches, pathL, L.itemsLeft, clsFor);
        addTip(key,'L',gL.endX,gL.endY);
        const mid = pathL.getTotalLength()/2, pt = pathL.getPointAtLength(mid);
        addLabel(`${sumFt(L.itemsLeft)}‚Ä≤ ${L.itemsLeft[0]?.size==='2.5'?'2¬Ω‚Ä≥':'1¬æ‚Ä≥'} ${L.nozLeft.gpm} gpm`, pt.x, pt.y, labelDyForLine(key)-8);
      } else {
        addTip(key,'L',geom.endX-20,geom.endY-20);
      }

      if(sumFt(L.itemsRight)>0){
        const gR = straightBranch('R', geom.endX, geom.endY, (sumFt(L.itemsRight)/50)*PX_PER_50FT);
        const pathR = document.createElementNS('http://www.w3.org/2000/svg','path');
        pathR.setAttribute('d', gR.d); G_branches.appendChild(pathR);
        drawSegmentedPath(G_branches, pathR, L.itemsRight, clsFor);
        addTip(key,'R',gR.endX,gR.endY);
        const mid = pathR.getTotalLength()/2, pt = pathR.getPointAtLength(mid);
        addLabel(`${sumFt(L.itemsRight)}‚Ä≤ ${L.itemsRight[0]?.size==='2.5'?'2¬Ω‚Ä≥':'1¬æ‚Ä≥'} ${L.nozRight.gpm} gpm`, pt.x, pt.y, labelDyForLine(key)-8);
      } else {
        addTip(key,'R',geom.endX+20,geom.endY-20);
      }
    }

    base.remove();
  });

  drawSupply(Math.ceil(computeNeededHeightPx()));
  refreshTotals();
  renderLinesPanel();
}

/* Supply */
function drawSupply(viewH){
  const G = document.getElementById('supplyG'); clearGroup(G);
  const h = supplyHeight(); if(!h) return;
  const baseY = truckTopY(viewH) + TRUCK_H + 6; const ns=G.namespaceURI;
  if(currentSupply==='pressurized'){
    let hyd=document.createElementNS(ns,'rect'); hyd.setAttribute('x','10'); hyd.setAttribute('y', String(baseY+20)); hyd.setAttribute('width','80'); hyd.setAttribute('height','60');
    hyd.setAttribute('fill','#243614'); hyd.setAttribute('stroke','#7aa35e'); G.appendChild(hyd);
    let t=document.createElementNS(ns,'text'); t.setAttribute('x','50'); t.setAttribute('y', String(baseY+55)); t.setAttribute('fill','#cfe4ff'); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','12'); t.textContent='Hydrant'; G.appendChild(t);
    const pump = pumpXY(viewH);
    let hose=document.createElementNS(ns,'path');
    hose.setAttribute('d',`M 90 ${baseY+50} C 160 ${baseY+50} 240 ${baseY+50} ${pump.x} ${pump.y-20}`);
    hose.setAttribute('stroke','#ecd464'); hose.setAttribute('stroke-width','12'); hose.setAttribute('fill','none'); hose.setAttribute('stroke-linecap','round'); G.appendChild(hose);
  } else if(currentSupply==='drafting'){
    let r=document.createElementNS(ns,'rect'); r.setAttribute('x','10'); r.setAttribute('y', String(baseY+60)); r.setAttribute('width','120'); r.setAttribute('height','70');
    r.setAttribute('fill','#10233b'); r.setAttribute('stroke','#4a6a9b'); G.appendChild(r);
    let t=document.createElementNS(ns,'text'); t.setAttribute('x','70'); t.setAttribute('y', String(baseY+100)); t.setAttribute('fill','#cfe4ff'); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','12'); t.textContent='Static Source'; G.appendChild(t);
    const pump = pumpXY(viewH);
    let path=document.createElementNS(ns,'path');
    path.setAttribute('d',`M ${pump.x},${pump.y} C 240 ${baseY+40}, 190 ${baseY+65}, 130 ${baseY+95}`);
    path.setAttribute('stroke','#6ecbff'); path.setAttribute('stroke-width','8'); path.setAttribute('fill','none'); path.setAttribute('stroke-linecap','round'); G.appendChild(path);
  } else if(currentSupply==='relay'){
    let img=document.createElementNS(ns,'rect'); img.setAttribute('x','10'); img.setAttribute('y', String(baseY)); img.setAttribute('width','120'); img.setAttribute('height','80'); img.setAttribute('fill','#162032'); img.setAttribute('stroke','#2b3c5a'); G.appendChild(img);
    let tt=document.createElementNS(ns,'text'); tt.setAttribute('x','70'); tt.setAttribute('y', String(baseY+45)); tt.setAttribute('fill','#cfe4ff'); tt.setAttribute('text-anchor','middle'); tt.setAttribute('font-size','12'); tt.textContent='Engine 2'; G.appendChild(tt);
    const pump = pumpXY(viewH);
    let hose=document.createElementNS(ns,'path');
    hose.setAttribute('d',`M 130 ${baseY+40} C 190 ${baseY+36} 250 ${baseY+36} ${pump.x} ${pump.y-20}`);
    hose.setAttribute('stroke','#ecd464'); hose.setAttribute('stroke-width','12'); hose.setAttribute('fill','none'); hose.setAttribute('stroke-linecap','round'); G.appendChild(hose);
  }
}

/* Totals */
function refreshTotals(){
  const vis = Object.values(lines).filter(l=>l.visible);
  let totalGPM = 0, maxPDP = 0;
  vis.forEach(L=>{
    const gpm = L.hasWye ? (L.nozLeft?.gpm||0) + (L.nozRight?.gpm||0) : (L.nozRight?.gpm||0);
    const mainFL = sumFt(L.itemsMain) ? FL(gpm, L.itemsMain[0].size, sumFt(L.itemsMain)) : 0;
    const leftNeed = L.hasWye ? FL(L.nozLeft?.gpm||0, L.itemsLeft[0]?.size||'1.75', sumFt(L.itemsLeft)) + (L.nozLeft?.NP||0) : 0;
    const rightNeed= FL(L.nozRight?.gpm||0, L.itemsRight[0]?.size||L.itemsMain[0]?.size||'1.75', sumFt(L.itemsRight)) + (L.nozRight?.NP||0);
    const branchMax = L.hasWye ? Math.max(leftNeed, rightNeed) : rightNeed;
    const PDP = branchMax + mainFL + (L.hasWye ? L.wyeLoss:0) + (L.elevFt * PSI_PER_FT);
    totalGPM += gpm; maxPDP = Math.max(maxPDP, PDP);
  });
  document.getElementById('GPM').textContent = vis.length? `${totalGPM} gpm` : '‚Äî gpm';
  document.getElementById('PDP').textContent = vis.length? `${Math.round(maxPDP)} psi` : '‚Äî psi';
}

/* ===== Visual math breakdown & equation ===== */
function breakdown(L){
  const mainSize = L.itemsMain[0]?.size || '1.75';
  const mainLen  = sumFt(L.itemsMain) || 0;
  const flow     = L.hasWye ? (L.nozLeft?.gpm||0)+(L.nozRight?.gpm||0) : (L.nozRight?.gpm||0);

  const mainFL   = flow ? FL(flow, mainSize, mainLen) : 0;

  const lSize = L.itemsLeft[0]?.size || mainSize;
  const rSize = L.itemsRight[0]?.size || mainSize;
  const lLen  = sumFt(L.itemsLeft)||0;
  const rLen  = sumFt(L.itemsRight)||0;
  const lFL   = L.hasWye ? FL(L.nozLeft?.gpm||0, lSize, lLen) : 0;
  const rFL   = L.hasWye ? FL(L.nozRight?.gpm||0, rSize, rLen) : 0;
  const leftNeed  = L.hasWye ? (lFL + (L.nozLeft?.NP||0)) : 0;
  const rightNeed = L.hasWye ? (rFL + (L.nozRight?.NP||0)) : (L.nozRight?.NP||0);

  const branchMax = L.hasWye ? Math.max(leftNeed, rightNeed) : rightNeed;
  const wye = L.hasWye ? L.wyeLoss : 0;
  const elevPsi = (L.elevFt||0) * PSI_PER_FT;
  const PDP = branchMax + mainFL + wye + elevPsi;

  return {
    mainSize, mainLen, flow, mainFL,
    lSize, lLen, lFL, leftNeed,
    rSize, rLen, rFL, rightNeed,
    branchMax, wye, elevPsi, PDP
  };
}
function eqStringNoWye(L){
  const b = breakdown(L);
  const sections = splitIntoSections(L.itemsMain);
  const fls = sections.map(s => round(FL(b.flow, s.size, s.lengthFt)));
  const elev = round(b.elevPsi);
  const np = round(L.nozRight?.NP||0);
  const elevPart = elev===0 ? '' : (elev>0 ? ` + ${elev}` : ` - ${Math.abs(elev)}`);
  return `PP = NP + FL ¬± Elev = ${np} + ${fls.join(' + ')}${elevPart}`;
}
function eqStringsWye(L){
  const b = breakdown(L);
  const aSections = splitIntoSections(L.itemsLeft);
  const bSections = splitIntoSections(L.itemsRight);
  const aFls = aSections.map(s => round(FL(L.nozLeft?.gpm||0, s.size, s.lengthFt)));
  const bFls = bSections.map(s => round(FL(L.nozRight?.gpm||0, s.size, s.lengthFt)));
  const aEq = `A = NP + FL = ${round(L.nozLeft?.NP||0)} + ${aFls.join(' + ')||0}`;
  const bEq = `B = NP + FL = ${round(L.nozRight?.NP||0)} + ${bFls.join(' + ')||0}`;
  const mainSections = splitIntoSections(L.itemsMain);
  const mainFls = mainSections.map(s => round(FL((L.nozLeft?.gpm||0)+(L.nozRight?.gpm||0), s.size, s.lengthFt)));
  const elev = round(b.elevPsi);
  const elevPart = elev===0 ? '' : (elev>0 ? ` + ${elev}` : ` - ${Math.abs(elev)}`);
  const wye = L.wyeLoss? ` + ${round(L.wyeLoss)}` : '';
  const final = `PP = max(A,B) + Main FL${wye} ¬± Elev = max(A,B) + ${mainFls.join(' + ')||0}${wye}${elevPart}`;
  return { aEq, bEq, final };
}

/* Horizontal hose bar with NP tag at the end */
function drawHoseBar(container, sections, gpm, npPsi, nozzleText){
  const totalLen = sumFt(sections);
  container.innerHTML = '';
  if(!totalLen || !gpm){
    const msg = document.createElement('div');
    msg.style.color = '#9fb0c8'; msg.style.fontSize='12px';
    msg.textContent = 'No hose yet';
    container.appendChild(msg);
    return;
  }

  const W = Math.max(300, Math.min(container.clientWidth || 560, 640));
  const NP_W = npPsi ? 58 : 0;
  const H = 56;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('width', '100%');
  svg.setAttribute('height', H);
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  const innerW = W - 16 - NP_W;

  // Title line above bar (nozzle info included)
  if(nozzleText){
    const t = document.createElementNS(svgNS,'text');
    t.setAttribute('x', 8);
    t.setAttribute('y', 12);
    t.setAttribute('fill', '#cfe4ff');
    t.setAttribute('font-size','12');
    t.textContent = nozzleText;
    svg.appendChild(t);
  }

  // Track
  const track = document.createElementNS(svgNS,'rect');
  track.setAttribute('x', 8); track.setAttribute('y', 20);
  track.setAttribute('width', innerW); track.setAttribute('height', 20);
  track.setAttribute('fill', '#0c1726');
  track.setAttribute('stroke', '#20324f');
  track.setAttribute('rx', 6); track.setAttribute('ry', 6);
  svg.appendChild(track);

  // Sections
  let x = 8;
  sections.forEach(seg=>{
    const segW = (seg.lengthFt/totalLen) * innerW;
    const r = document.createElementNS(svgNS,'rect');
    r.setAttribute('x', x); r.setAttribute('y', 20);
    r.setAttribute('width', Math.max(segW,1)); r.setAttribute('height', 20);
    r.setAttribute('fill', COLORS[seg.size] || '#888');
    r.setAttribute('stroke', 'rgba(0,0,0,.35)');
    r.setAttribute('rx', 5); r.setAttribute('ry', 5);
    svg.appendChild(r);

    const fl = FL(gpm, seg.size, seg.lengthFt);
    const t = document.createElementNS(svgNS,'text');
    t.setAttribute('fill', '#0b0f14');
    t.setAttribute('font-size','11');
    t.setAttribute('font-family','ui-monospace, Menlo, Consolas, monospace');
    t.setAttribute('text-anchor','middle');
    t.setAttribute('x', x + segW/2);
    t.setAttribute('y', 35);
    t.textContent = `${seg.lengthFt}‚Ä≤ ‚Ä¢ ${Math.round(fl)} psi`;
    svg.appendChild(t);

    x += segW;
  });

  // NP pill at the end
  if(npPsi){
    const npX = 8 + innerW + 8;
    const pill = document.createElementNS(svgNS,'rect');
    pill.setAttribute('x', innerW + 8 + 4);
    pill.setAttribute('y', 20);
    pill.setAttribute('width', NP_W-12);
    pill.setAttribute('height', 20);
    pill.setAttribute('fill', '#eaf2ff');
    pill.setAttribute('stroke', '#20324f');
    pill.setAttribute('rx', 6); pill.setAttribute('ry', 6);
    svg.appendChild(pill);

    const npT = document.createElementNS(svgNS,'text');
    npT.setAttribute('x', innerW + 8 + (NP_W-12)/2);
    npT.setAttribute('y', 34);
    npT.setAttribute('text-anchor','middle');
    npT.setAttribute('fill', '#0b0f14');
    npT.setAttribute('font-size','11');
    npT.setAttribute('font-family','ui-monospace, Menlo, Consolas, monospace');
    npT.textContent = `NP ${npPsi}`;
    svg.appendChild(npT);
  }

  container.appendChild(svg);
}

/* ===== Render line panels =====
   Only show math/builder for DEPLOYED lines.
   For non-deployed: compact row with a Deploy button only.
*/
function renderLinesPanel(){
  linesTable.innerHTML = '';
  ['left','back','right'].forEach(key=>{
    const L = lines[key];
    const row = document.createElement('div');
    row.className='lineRow';

    if(!L.visible){
      // Compact: title + Deploy
      row.innerHTML = `
        <div class="title">${L.label} ‚Äî not deployed</div>
        <div class="break"><i>Deploy to show math and the horizontal breakdown.</i></div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button class="pick-small" data-key="${key}" data-bld="deploy">Deploy</button>
        </div>
      `;
      linesTable.appendChild(row);
      return;
    }

    // Deployed: show horizontal and math + builder
    const b = breakdown(L);
    const flowTxt = L.hasWye ? `${b.flow} gpm (sum)` : `${b.flow} gpm`;
    const mainTitle = L.hasWye
      ? `Main line ${b.mainLen}‚Ä≤ @ ${b.flow} gpm ‚Äî nozzles ${L.nozLeft.gpm}/${L.nozRight.gpm} gpm @ ${L.nozRight.NP} psi`
      : `Main line ${b.mainLen}‚Ä≤ @ ${b.flow||0} gpm ‚Äî nozzle ${L.nozRight.gpm} gpm ${L.nozRight.NP} psi`;

    row.innerHTML = `
      <div class="title">${L.label} ‚Äî DEPLOYED</div>
      <div class="break" style="flex:1 1 100%">
        <details class="math" open>
          <summary>Line math & builder</summary>
          <div class="hoseviz">
            <div class="hoseLegend">
              <span class="legSwatch sw175"></span> 1¬æ‚Ä≥
              <span class="legSwatch sw25"></span> 2¬Ω‚Ä≥
              <span class="legSwatch sw5"></span> 5‚Ä≥
            </div>

            <!-- Main bar -->
            <div class="barWrap">
              <div class="barTitle">${mainTitle}</div>
              <div class="hosebar" id="viz_main_${key}"></div>
              ${L.hasWye ? `` : `<div class="ppEq" id="eq_main_${key}"></div>`}
            </div>

            <!-- Branch bars when wye -->
            ${L.hasWye ? `
              <div class="barWrap">
                <div class="barTitle">Branch A ${b.lLen||0}‚Ä≤ @ ${L.nozLeft.gpm} gpm ‚Äî nozzle ${L.nozLeft.gpm} gpm ${L.nozLeft.NP} psi</div>
                <div class="hosebar" id="viz_L_${key}"></div>
                <div class="ppEq" id="eq_L_${key}"></div>
              </div>
              <div class="barWrap">
                <div class="barTitle">Branch B ${b.rLen||0}‚Ä≤ @ ${L.nozRight.gpm} gpm ‚Äî nozzle ${L.nozRight.gpm} gpm ${L.nozRight.NP} psi</div>
                <div class="hosebar" id="viz_R_${key}"></div>
                <div class="ppEq" id="eq_R_${key}"></div>
              </div>
              <div class="ppEq" id="eq_final_${key}"></div>
            `: ``}

            <!-- Simple builder INSIDE the math section -->
            <div class="ctrls">
              <strong>Main:</strong>
              <select data-key="${key}" data-ctx="main" data-bldm="size">
                <option value="1.75" ${L.itemsMain[0]?.size==='1.75'?'selected':''}>1¬æ‚Ä≥</option>
                <option value="2.5"  ${L.itemsMain[0]?.size==='2.5'?'selected':''}>2¬Ω‚Ä≥</option>
              </select>
              <select data-key="${key}" data-ctx="main" data-bldm="len">
                ${[50,100,150,200,250,300,350,400].map(v=>`<option value="${v}" ${sumFt(L.itemsMain)===v?'selected':''}>${v}‚Ä≤</option>`).join('')}
              </select>
              <select data-key="${key}" data-ctx="noz" data-bldm="noz">
                ${Object.entries(NOZ).map(([id,n])=>`<option value="${id}" ${L.nozRight===n?'selected':''}>${n.name} ${n.NP}psi/${n.gpm}</option>`).join('')}
              </select>
              <button class="miniBtn" data-key="${key}" data-ctx="main" data-bldm="add50">+50‚Ä≤</button>
              <button class="miniBtn" data-key="${key}" data-ctx="main" data-bldm="add100">+100‚Ä≤</button>

              <span style="width:1px;height:18px;background:#1f3a57;margin:0 6px"></span>

              <strong>Wye:</strong>
              ${L.hasWye ? `<button class="miniBtn" data-key="${key}" data-bldm="removeWye">Remove Wye</button>` :
                            `<button class="miniBtn" data-key="${key}" data-bldm="addWye">Add Wye (+10 psi)</button>`}

              ${L.hasWye ? `
                <strong> A: </strong>
                <select data-key="${key}" data-ctx="L" data-bldm="bsize">
                  <option value="1.75" ${L.itemsLeft[0]?.size!=='2.5'?'selected':''}>1¬æ‚Ä≥</option>
                  <option value="2.5"  ${L.itemsLeft[0]?.size==='2.5'?'selected':''}>2¬Ω‚Ä≥</option>
                </select>
                <select data-key="${key}" data-ctx="L" data-bldm="blen">
                  ${[0,50,100,150,200,250,300].map(v=>`<option value="${v}" ${sumFt(L.itemsLeft)===v?'selected':''}>${v}‚Ä≤</option>`).join('')}
                </select>

                <strong> B: </strong>
                <select data-key="${key}" data-ctx="R" data-bldm="bsize">
                  <option value="1.75" ${L.itemsRight[0]?.size!=='2.5'?'selected':''}>1¬æ‚Ä≥</option>
                  <option value="2.5"  ${L.itemsRight[0]?.size==='2.5'?'selected':''}>2¬Ω‚Ä≥</option>
                </select>
                <select data-key="${key}" data-ctx="R" data-bldm="blen">
                  ${[0,50,100,150,200,250,300].map(v=>`<option value="${v}" ${sumFt(L.itemsRight)===v?'selected':''}>${v}‚Ä≤</option>`).join('')}
                </select>
              `:``}

              <span style="width:1px;height:18px;background:#1f3a57;margin:0 6px"></span>
              <strong>Elevation:</strong>
              <input type="number" step="1" value="${L.elevFt||0}" style="width:90px" data-key="${key}" data-bldm="elevInput" />
              <button class="miniBtn" data-key="${key}" data-bldm="saveElev">Apply</button>

              <span style="width:1px;height:18px;background:#1f3a57;margin:0 6px"></span>
              <button class="miniBtn" data-key="${key}" data-bld="retract">Retract</button>
            </div>
          </div>
        </details>
      </div>
    `;
    linesTable.appendChild(row);

    // Render bars
    const gpmMain = L.hasWye ? (L.nozLeft?.gpm||0)+(L.nozRight?.gpm||0) : (L.nozRight?.gpm||0);
    const mainCont = document.getElementById(`viz_main_${key}`);
    if(mainCont){
      const mainSecs = splitIntoSections(L.itemsMain);
      const nozzleText = L.hasWye
        ? `Main ${sumFt(L.itemsMain)}‚Ä≤ @ ${gpmMain} gpm ‚Äî nozzles ${L.nozLeft.gpm}/${L.nozRight.gpm} @ ${L.nozRight.NP} psi`
        : `Main ${sumFt(L.itemsMain)}‚Ä≤ @ ${gpmMain} gpm ‚Äî nozzle ${L.nozRight.gpm} @ ${L.nozRight.NP} psi`;
      // NP shown on main only when there is no wye (PP = NP + FL ¬± elev)
      drawHoseBar(mainCont, mainSecs, gpmMain, L.hasWye?0:(L.nozRight?.NP||0), nozzleText);
    }
    if(!L.hasWye){
      const eq = document.getElementById(`eq_main_${key}`);
      if(eq) eq.textContent = eqStringNoWye(L);
    }else{
      const lCont = document.getElementById(`viz_L_${key}`);
      const rCont = document.getElementById(`viz_R_${key}`);
      if(lCont) drawHoseBar(lCont, splitIntoSections(L.itemsLeft), L.nozLeft?.gpm||0, L.nozLeft?.NP||0,
        `Branch A ${sumFt(L.itemsLeft)||0}‚Ä≤ @ ${L.nozLeft.gpm} gpm ‚Äî nozzle ${L.nozLeft.gpm} @ ${L.nozLeft.NP} psi`);
      if(rCont) drawHoseBar(rCont, splitIntoSections(L.itemsRight), L.nozRight?.gpm||0, L.nozRight?.NP||0,
        `Branch B ${sumFt(L.itemsRight)||0}‚Ä≤ @ ${L.nozRight.gpm} gpm ‚Äî nozzle ${L.nozRight.gpm} @ ${L.nozRight.NP} psi`);
      const {aEq, bEq, final} = eqStringsWye(L);
      const aDiv = document.getElementById(`eq_L_${key}`);
      const bDiv = document.getElementById(`eq_R_${key}`);
      const fDiv = document.getElementById(`eq_final_${key}`);
      if(aDiv) aDiv.textContent = aEq;
      if(bDiv) bDiv.textContent = bEq;
      if(fDiv) fDiv.textContent = final;
    }
  });

  // === Handlers: deploy / retract
  linesTable.querySelectorAll('[data-bld="deploy"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      L.visible = true; toggleLineBtn(key,true); drawAll();
    });
  });
  linesTable.querySelectorAll('[data-bld="retract"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      L.visible = false; toggleLineBtn(key,false); drawAll();
    });
  });

  // === Builder inside math
  // Main size/len/nozzle
  linesTable.querySelectorAll('[data-bldm="size"]').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      const size=e.target.value;
      const lenSel = linesTable.querySelector(`[data-key="${key}"][data-bldm="len"]`);
      const len = parseInt(lenSel.value,10);
      L.itemsMain=[{size,lengthFt:len}];
      drawAll();
    });
  });
  linesTable.querySelectorAll('[data-bldm="len"]').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      const sizeSel = linesTable.querySelector(`[data-key="${key}"][data-bldm="size"]`);
      const size = sizeSel.value;
      const len = parseInt(e.target.value,10);
      L.itemsMain=[{size,lengthFt:len}];
      drawAll();
    });
  });
  linesTable.querySelectorAll('[data-bldm="noz"]').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      const noz = NOZ[e.target.value];
      L.nozLeft = L.nozRight = noz;
      drawAll();
    });
  });
  // Quick add +50/+100 (same size as last main segment)
  linesTable.querySelectorAll('[data-bldm="add50"],[data-bldm="add100"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      const add = e.target.dataset.bldm==='add50'?50:100;
      const lastSize = L.itemsMain[L.itemsMain.length-1]?.size || '1.75';
      L.itemsMain.push({size:lastSize,lengthFt:add});
      drawAll();
    });
  });
  // Wye add/remove
  linesTable.querySelectorAll('[data-bldm="addWye"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      L.hasWye = true; drawAll();
    });
  });
  linesTable.querySelectorAll('[data-bldm="removeWye"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      L.hasWye = false; L.itemsLeft=[]; L.itemsRight=[]; drawAll();
    });
  });
  // Branch editors
  linesTable.querySelectorAll('[data-bldm="bsize"],[data-bldm="blen"]').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      const ctx=e.target.dataset.ctx; // L or R
      const sizeSel = linesTable.querySelector(`[data-key="${key}"][data-ctx="${ctx}"][data-bldm="bsize"]`);
      const lenSel  = linesTable.querySelector(`[data-key="${key}"][data-ctx="${ctx}"][data-bldm="blen"]`);
      let size=sizeSel.value, len=parseInt(lenSel.value,10);
      const mainLast = L.itemsMain[L.itemsMain.length-1]?.size || '1.75';
      if(mainLast==='1.75' && size==='2.5'){ size='1.75'; sizeSel.value='1.75'; }
      if(len<=0){
        if(ctx==='L') L.itemsLeft=[]; else L.itemsRight=[];
      } else {
        if(ctx==='L') L.itemsLeft=[{size,lengthFt:len}]; else L.itemsRight=[{size,lengthFt:len}];
      }
      drawAll();
    });
  });
  // Elevation
  linesTable.querySelectorAll('[data-bldm="saveElev"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const key=e.target.dataset.key; const L=lines[key];
      const inp = linesTable.querySelector(`[data-key="${key}"][data-bldm="elevInput"]`);
      L.elevFt = Number(inp.value||0);
      drawAll();
    });
  });
}

function toggleLineBtn(key,on){
  const btn = document.querySelector(`.linebtn[data-line="${key}"]`);
  if(btn){ btn.classList.toggle('active', on); }
}

function allowedAddOptions(curr){
  if(curr==='2.5'){ return [{len:50,size:'2.5'},{len:50,size:'1.75'},{len:100,size:'1.75'}]; }
  return [{len:50,size:'1.75'},{len:100,size:'1.75'}];
}

/* ===== + Tips on rig ===== */
function addTip(key, where, x, y){
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','hose-end'); g.setAttribute('data-line',key); g.setAttribute('data-where',where);
  const hit = document.createElementNS('http://www.w3.org/2000/svg','rect');
  hit.setAttribute('class','plus-hit'); hit.setAttribute('x', x-20); hit.setAttribute('y', y-20); hit.setAttribute('width', 40); hit.setAttribute('height', 40);
  const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
  c.setAttribute('class','plus-circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',14);
  const v = document.createElementNS('http://www.w3.org/2000/svg','line');
  v.setAttribute('class','plus-sign'); v.setAttribute('x1',x); v.setAttribute('y1',y-6); v.setAttribute('x2',x); v.setAttribute('y2',y+6);
  const h = document.createElementNS('http://www.w3.org/2000/svg','line');
  h.setAttribute('class','plus-sign'); h.setAttribute('x1',x-6); h.setAttribute('y1',y); h.setAttribute('x2',x+6); h.setAttribute('y2',y);
  g.appendChild(hit); g.appendChild(c); g.appendChild(v); g.appendChild(h);
  G_tips.appendChild(g);
}

/* Picker open/close */
overlay.addEventListener('click', (e)=>{
  const tip = e.target.closest('.hose-end'); if(!tip) return;
  const key = tip.getAttribute('data-line'); const where = tip.getAttribute('data-where');
  const circ = tip.querySelector('.plus-circle'); const ov = overlay.getBoundingClientRect();
  const vb = overlay.getAttribute('viewBox').split(' '); const viewH = Number(vb[3]);
  const px = parseFloat(circ.getAttribute('cx')), py = parseFloat(circ.getAttribute('cy'));
  const clientX = ov.left + (px/TRUCK_W)*ov.width, clientY = ov.top + (py/viewH)*ov.height;
  showPicker(key, where, clientX, clientY);
});
document.addEventListener('click', (e)=>{
  const inPick = picker.contains(e.target);
  const inSupply = supplyMenu.contains(e.target) || e.target===supplyBtn;
  if(inPick || inSupply) return;
  if(e.target.closest('.hose-end')) return;
  hidePicker(); hideSupplyMenu();
});

function showPicker(key, where, cx, cy){
  plusContext = { key, where };
  const L = lines[key];
  pickerTitle.textContent = where==='main' ? `${L.label} ‚Äî Main` : `${L.label} ‚Äî ${where==='L'?'Left':'Right'}`;

  setupSize.value = L.itemsMain[0]?.size || '1.75';
  setupLen.value  = String(sumFt(L.itemsMain) || 200);
  setupNoz.value  = Object.entries(NOZ).find(([id,n])=>n===L.nozRight)?.[0] || 'chiefXD';

  const currentSize = currentSegmentSize(L, where);
  addBtns.innerHTML = '';
  allowedAddOptions(currentSize).forEach(o=>{
    const b = document.createElement('button');
    b.className='pick-small';
    b.textContent = `+${o.len}‚Ä≤ ${o.size==='2.5'?'2¬Ω‚Ä≥':'1¬æ‚Ä≥'}`;
    b.dataset.addlen=o.len; b.dataset.size=o.size;
    addBtns.appendChild(b);
  });

  picker.style.display='block'; picker.setAttribute('aria-hidden','false');
  showPane('pickHome');

  const stg = stage.getBoundingClientRect();
  const pw = 320, ph = 270;
  let x = cx - stg.left + 8, y = cy - stg.top - ph - 8;
  if(y < 8) y = cy - stg.top + 8;
  x = Math.max(8, Math.min(x, stg.width - pw - 8));
  y = Math.max(8, Math.min(y, stg.height - ph - 8));
  picker.style.left = `${x}px`; picker.style.top = `${y}px`;
}
function hidePicker(){ picker.style.display='none'; picker.setAttribute('aria-hidden','true'); }
function showPane(id){ ['pickHome','pickAdd','pickNoz','pickAcc','pickElev','pickSetup'].forEach(pid=>{ document.getElementById(pid).style.display = (pid===id)?'block':'none'; }); }
function currentSegmentSize(L, where){
  if(where==='L')  return L.itemsLeft[0]?.size || '1.75';
  if(where==='R')  return L.itemsRight[0]?.size || L.itemsMain[0]?.size || '1.75';
  return L.itemsMain[L.itemsMain.length-1]?.size || '1.75';
}

/* Picker actions */
picker.addEventListener('click', (e)=>{
  const view = e.target.closest('.pick')?.dataset.view;
  if(view==='addhose') showPane('pickAdd');
  if(view==='nozzle')  showPane('pickNoz');
  if(view==='accessory') showPane('pickAcc');
  if(view==='elevation') showPane('pickElev');
  if(view==='setup')   showPane('pickSetup');
  if(e.target.hasAttribute('data-back')) showPane('pickHome');
});
document.getElementById('setupApply').addEventListener('click', ()=>{
  const key=plusContext.key; const L=lines[key];
  const size=setupSize.value; const len=parseInt(setupLen.value,10); const noz=NOZ[setupNoz.value];
  L.itemsMain=[{size,lengthFt:len}]; L.nozLeft=L.nozRight=noz;
  if(!L.visible){ L.visible=true; toggleLineBtn(key,true); }
  hidePicker(); drawAll();
});
document.getElementById('pickAdd').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-addlen]'); if(!btn) return;
  const len = parseInt(btn.dataset.addlen,10);
  const size = btn.dataset.size;
  const L = lines[plusContext.key];
  const curr = currentSegmentSize(L, plusContext.where);
  if(curr==='1.75' && size==='2.5'){ hidePicker(); return; } // enforce
  if(plusContext.where==='L'){ L.itemsLeft.push({size,lengthFt:len}); }
  else if(plusContext.where==='R'){ L.itemsRight.push({size,lengthFt:len}); }
  else { L.itemsMain.push({size,lengthFt:len}); }
  if(!L.visible){ L.visible=true; toggleLineBtn(plusContext.key,true); }
  hidePicker(); drawAll();
});
document.getElementById('pickNoz').addEventListener('click', (e)=>{
  const id = e.target.closest('.pick')?.dataset.noz; if(!id) return;
  const L = lines[plusContext.key];
  if(plusContext.where==='L'){ L.nozLeft = NOZ[id]; } else { L.nozRight = NOZ[id]; }
  if(!L.visible){ L.visible=true; toggleLineBtn(plusContext.key,true); }
  hidePicker(); drawAll();
});
document.getElementById('pickAcc').addEventListener('click', (e)=>{
  const acc = e.target.closest('button')?.dataset.acc; if(!acc) return;
  const L = lines[plusContext.key];
  if(acc==='wye'){ L.hasWye = true; }
  if(acc==='removeWye'){ L.hasWye = false; L.itemsLeft=[]; L.itemsRight=[]; }
  if(!L.visible){ L.visible=true; toggleLineBtn(plusContext.key,true); }
  hidePicker(); drawAll();
});
document.getElementById('pickElev').addEventListener('click', (e)=>{
  if(!e.target.hasAttribute('data-save-elev')) return;
  const L=lines[plusContext.key]; L.elevFt = Number(elevInput.value||0);
  if(!L.visible){ L.visible=true; toggleLineBtn(plusContext.key,true); }
  hidePicker(); drawAll();
});

/* Top line buttons: toggle deploy/retract */
document.querySelectorAll('.linebtn').forEach(b=>{
  b.addEventListener('click', ()=>{
    const key=b.dataset.line;
    lines[key].visible = !lines[key].visible;
    b.classList.toggle('active', lines[key].visible);
    drawAll();
  });
});

/* Supply dropdown */
function showSupplyMenu(){
  const rect = supplyBtn.getBoundingClientRect();
  const lbRect = linebar.getBoundingClientRect();
  supplyMenu.style.left = (rect.left - lbRect.left) + 'px';
  supplyMenu.style.top  = (rect.bottom - lbRect.top + 6) + 'px';
  supplyMenu.style.display='block';
  supplyMenu.setAttribute('aria-hidden','false');
}
function hideSupplyMenu(){
  supplyMenu.style.display='none';
  supplyMenu.setAttribute('aria-hidden','true');
}
supplyBtn.addEventListener('click', ()=>{
  if(supplyMenu.style.display==='block') hideSupplyMenu(); else showSupplyMenu();
});
supplyMenu.addEventListener('click', (e)=>{
  const src = e.target.closest('button')?.dataset.supply; if(!src) return;
  currentSupply = src; hideSupplyMenu(); drawAll();
});

/* Boot */
drawAll();
</script>
</body>
</html>
