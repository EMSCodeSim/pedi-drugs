<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>FireOps SIM ‚Äî Visual Pump Builder</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8; --edge:rgba(255,255,255,.14);
    --hose5:#ecd464;       /* 5" */
    --hose25:#6ecbff;      /* 2¬Ω" (blue) */
    --hose175:#ff6b6b;     /* 1¬æ" (red) */
    --bubble:#172134; --bubble-edge:rgba(255,255,255,.15);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  /* Header */
  header{position:sticky;top:0;z-index:5;padding:10px 14px;background:linear-gradient(180deg,#0c1320,#0b0f14);border-bottom:1px solid var(--edge)}
  .title{font-weight:700}
  .sub{font-size:12px;color:#9fb0c8}

  /* Stage: phone-first */
  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge);background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative;width:100%;height:clamp(260px,50vh,420px);max-width:820px;margin:0 auto}
  #overlay{position:absolute;inset:0;width:100%;height:100%;display:block}
  .info{position:absolute;left:50%;top:8px;transform:translateX(-50%);background:var(--bubble);border:1px solid var(--bubble-edge);border-radius:999px;padding:6px 10px;font-size:12px}

  /* Buttons directly under truck */
  .linebar{position:absolute;left:0;right:0;bottom:8px;display:flex;justify-content:center;gap:10px;z-index:6}
  .linebtn{background:#0b1320;border:1px solid var(--edge);color:#eaf2ff;border-radius:12px;padding:12px 16px;font-size:16px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .linebtn.active{outline:2px solid #3aa7ff}

  /* Hose drawings */
  .hoseMain{fill:none;stroke-linecap:round;stroke-linejoin:round}
  .hose5{stroke:var(--hose5);stroke-width:12}
  .hose25{stroke:var(--hose25);stroke-width:9}
  .hose175{stroke:var(--hose175);stroke-width:6}
  .shadow{stroke:rgba(0,0,0,.35)}

  /* ‚Äú+‚Äù tips */
  .hose-end{cursor:pointer}
  .plus-circle{fill:#fff;stroke:#111;stroke-width:1.5;filter:drop-shadow(0 2px 4px rgba(0,0,0,.45))}
  .plus-sign{stroke:#111;stroke-width:3;stroke-linecap:round}

  /* Tip menu */
  .picker{position:absolute;background:#0b1320;border:1px solid var(--bubble-edge);border-radius:12px;min-width:250px;padding:8px;z-index:7;box-shadow:0 18px 40px rgba(0,0,0,.45);display:none}
  .picker h3{font-size:12px;color:#cfe4ff;margin:4px 8px 8px}
  .section-title{font-size:11px;color:#9fb0c8;margin:4px 8px 6px}
  .picker-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:4px 6px 8px}
  .pick{display:flex;align-items:center;gap:8px;background:#0b1a29;border:1px solid #1f3a57;border-radius:10px;padding:10px;cursor:pointer}
  .pick:hover{background:#0e2337}
  .picker-actions{display:flex;gap:6px;flex-wrap:wrap;padding:6px 8px 10px}
  .pick-small{font-size:12px;padding:8px 10px;border-radius:10px;background:#0b1a29;border:1px solid #1f3a57;cursor:pointer}
  .pick-small:hover{background:#0e2337}

  /* KPIs */
  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
  input{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:10px 12px;font-size:16px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px;font-size:13px;color:#cfe4ff}
  .kpi b{font-size:18px}
  .note{font-size:13px;color:#cfe4ff}
  @media (max-width:480px){ .grid2{grid-template-columns:1fr 1fr} .linebtn{padding:14px 18px;font-size:17px} }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="title">FireOps SIM ‚Äî Visual Pump Builder</div>
    <div class="sub">Tap a hose button to show it. Use the <b>+</b> at the hose tip to add hose, change nozzle, add a wye, or edit config.</div>
  </header>

  <!-- Stage: truck + hoses inside one responsive SVG -->
  <section class="wrapper">
    <div class="stage" id="stage">
      <svg id="overlay" viewBox="0 0 390 260" preserveAspectRatio="xMidYMax meet" aria-label="Visual stage">
        <image href="https://fireopssim.com/pump/engine181.png" x="0" y="0" width="390" height="260" preserveAspectRatio="xMidYMax meet"></image>
        <g id="hoses"></g><g id="branches"></g><g id="tips"></g><g id="labels"></g>
      </svg>

      <div class="info" id="topInfo">Tap a Hose button below</div>

      <!-- Hose buttons directly under truck -->
      <div class="linebar">
        <button class="linebtn" data-line="left">Hose 1</button>
        <button class="linebtn" data-line="right">Hose 2</button>
        <button class="linebtn" data-line="back">Hose 3</button>
      </div>

      <!-- Context menu opened from + at hose end -->
      <div id="picker" class="picker" role="dialog" aria-modal="true" aria-hidden="true">
        <h3 id="pickerTitle">Hose</h3>

        <div id="pickHome">
          <div class="section-title">Choose an action</div>
          <div class="picker-grid">
            <div class="pick" data-view="addhose">‚ûï Add Hose</div>
            <div class="pick" data-view="nozzle">üß© Change Nozzle</div>
            <div class="pick" data-view="accessory">‚öôÔ∏è Add Accessory</div>
            <div class="pick" data-view="config">üõ†Ô∏è Change Config</div>
          </div>
        </div>

        <div id="pickAdd" style="display:none">
          <div class="section-title">Add hose to this segment</div>
          <div class="picker-actions">
            <button class="pick-small" data-addlen="50" data-size="1.75">+50‚Ä≤ 1¬æ‚Ä≥</button>
            <button class="pick-small" data-addlen="100" data-size="1.75">+100‚Ä≤ 1¬æ‚Ä≥</button>
            <button class="pick-small" data-addlen="50" data-size="2.5">+50‚Ä≤ 2¬Ω‚Ä≥</button>
            <button class="pick-small" data-addlen="100" data-size="2.5">+100‚Ä≤ 2¬Ω‚Ä≥</button>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickNoz" style="display:none">
          <div class="section-title">Set nozzle for this side</div>
          <div class="picker-grid">
            <div class="pick" data-noz="smooth185">Smooth 185 @50</div>
            <div class="pick" data-noz="fog150_75">Fog 150 @75</div>
            <div class="pick" data-noz="fog150_100">Fog 150 @100</div>
            <div class="pick" data-noz="sb265">SB 1 1/8‚Ä≥ 265 @50</div>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickAcc" style="display:none">
          <div class="section-title">Accessories</div>
          <div class="picker-grid">
            <div class="pick" data-acc="wye">Add Wye (+10)</div>
            <div class="pick" data-acc="removeWye">Remove Wye</div>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickCfg" style="display:none">
          <div class="section-title">Quick set</div>
          <div class="picker-actions">
            <button class="pick-small" data-size-set="1.75">1¬æ‚Ä≥</button>
            <button class="pick-small" data-size-set="2.5">2¬Ω‚Ä≥</button>
            <button class="pick-small" data-len-set="200">200‚Ä≤</button>
            <button class="pick-small" data-len-set="250">250‚Ä≤</button>
          </div>
          <div class="picker-actions"><button class="pick-small" data-reset>Reset defaults</button><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="panel">
    <div class="card">
      <div class="grid2">
        <div><label>Elevation (ft)</label><input id="elevFt" type="number" value="0"></div>
        <div><label>Elevation PSI/ft</label><input id="elevPsi" type="number" step="0.001" value="0.434"></div>
      </div>
    </div>
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div>Flow</div><b id="GPM">‚Äî gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">‚Äî psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
  </section>

</div>

<script>
/* ========================
   Visual + logic (phone-first)
   ======================== */

const VIEW_W = 390, VIEW_H = 260;           // SVG viewBox
const PX_PER_50FT = 45;                      // length scale
const PUMP_ANCHOR = { x:0.515, y:0.74 };     // % of viewBox at pump panel
const MAIN_FAN = 110;                         // left/right fan
const CURVE_PULL = 36;                        // bezier bow
const BRANCH_PULL = 44, BRANCH_LIFT = 26;

const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };
const NOZ = {
  smooth185:{name:'Smooth 185 @50', gpm:185, NP:50},
  fog150_75:{name:'Fog 150 @75', gpm:150, NP:75},
  fog150_100:{name:'Fog 150 @100', gpm:150, NP:100},
  sb265:{name:'SB 1 1/8‚Ä≥ 265 @50', gpm:265, NP:50}
};

function emptyHose(label, size, len, noz){
  return {
    label,
    itemsMain:[{size, lengthFt:len}],   // array so adds extend visually
    hasWye:false, wyeLoss:10,
    itemsLeft:[], itemsRight:[],
    nozLeft:noz, nozRight:noz
  };
}
const lines = {
  left:  emptyHose('Hose 1','1.75',200, NOZ.smooth185),
  right: emptyHose('Hose 2','1.75',200, NOZ.smooth185),
  back:  emptyHose('Hose 3','2.5', 250, NOZ.sb265)
};

let activeKey = null;   // which hose is shown (null = none)
let plusContext = { key:null, where:'main' }; // where to add hose from picker
let elevFt=0, elevPsiPerFt=0.434;

/* DOM */
const overlay = document.getElementById('overlay');
const G_hoses   = document.getElementById('hoses');
const G_branches= document.getElementById('branches');
const G_tips    = document.getElementById('tips');
const G_labels  = document.getElementById('labels');
const topInfo   = document.getElementById('topInfo');
const picker    = document.getElementById('picker');
const pickerTitle = document.getElementById('pickerTitle');
const pickHome  = document.getElementById('pickHome');
const pickAdd   = document.getElementById('pickAdd');
const pickNoz   = document.getElementById('pickNoz');
const pickAcc   = document.getElementById('pickAcc');
const pickCfg   = document.getElementById('pickCfg');
const lineBtns  = [...document.querySelectorAll('.linebtn')];

/* Helpers */
function clsFor(size){ return size==='5'?'hose5':(size==='2.5'?'hose25':'hose175'); }
function sumFt(items){ return items.reduce((s,h)=>s + (h.lengthFt||0), 0); }
function hoseClassFromItems(items){ return clsFor(items[0]?.size || '1.75'); }
function FL(gpm, size, ft){ const C=COEFF[size]||0, Q=gpm/100; return C*(Q*Q)*(ft/100); }

function clearGroup(g){ while(g.firstChild) g.removeChild(g.firstChild); }

/* Geometry */
function pumpXY(){ return { x:VIEW_W*PUMP_ANCHOR.x, y:VIEW_H*PUMP_ANCHOR.y }; }
function mainGeom(dir, totalPx){
  const {x:sx,y:sy} = pumpXY();
  const ex = dir===-1 ? sx - MAIN_FAN : dir===1 ? sx + MAIN_FAN : sx;
  const ey = Math.max(10, sy - totalPx);
  const cx = (sx+ex)/2 + (dir===-1?-CURVE_PULL:dir===1?CURVE_PULL:0);
  const cy = sy - (sy-ey)*0.48;
  return { d:`M ${sx},${sy} Q ${cx},${cy} ${ex},${ey}`, endX:ex, endY:ey };
}
function branchGeom(side, startX, startY, totalPx){
  const dir = side==='L'?-1:1;
  const rise = Math.max(20, totalPx*0.55), run=Math.max(28, totalPx*0.45);
  const midY = startY - BRANCH_LIFT;
  const ex = startX + dir*run, ey = Math.max(8, startY - rise);
  const c1x = startX + dir*BRANCH_PULL*0.6, c1y = startY - rise*0.35;
  const c2x = startX + dir*BRANCH_PULL,     c2y = startY - rise*0.75;
  return { d:`M ${startX},${startY} L ${startX},${midY} C ${c1x},${c1y} ${c2x},${c2y} ${ex},${ey}`, endX:ex, endY:ey };
}

/* Draw a single active line */
function drawActive(){
  clearGroup(G_hoses); clearGroup(G_branches); clearGroup(G_tips); clearGroup(G_labels);
  if(!activeKey){ topInfo.textContent='Tap a Hose button below'; return; }
  const L = lines[activeKey];

  const dir = activeKey==='left'?-1:activeKey==='right'?1:0;
  const mainFt = sumFt(L.itemsMain);
  const mainPx = (mainFt/50)*PX_PER_50FT;
  const mainClass = hoseClassFromItems(L.itemsMain);

  const m = mainGeom(dir, mainPx);
  // shadow + hose
  const sh = document.createElementNS('http://www.w3.org/2000/svg','path');
  sh.setAttribute('class','hoseMain shadow'); sh.setAttribute('stroke-width','12'); sh.setAttribute('d', m.d);
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('class', `hoseMain ${mainClass}`); p.setAttribute('d', m.d);
  G_hoses.appendChild(sh); G_hoses.appendChild(p);

  // + tip for MAIN
  addTip(activeKey,'main',m.endX,m.endY);

  // If Wye, render branches with their own +
  if(L.hasWye){
    if(L.itemsLeft.length){
      const leftFt = sumFt(L.itemsLeft), leftPx = (leftFt/50)*PX_PER_50FT;
      const gL = branchGeom('L', m.endX, m.endY, leftPx);
      const shL = document.createElementNS('http://www.w3.org/2000/svg','path');
      shL.setAttribute('class','hoseMain shadow'); shL.setAttribute('stroke-width','9'); shL.setAttribute('d', gL.d);
      const pL = document.createElementNS('http://www.w3.org/2000/svg','path');
      pL.setAttribute('class', `hoseMain ${hoseClassFromItems(L.itemsLeft)}`); pL.setAttribute('d', gL.d);
      G_branches.appendChild(shL); G_branches.appendChild(pL);
      addTip(activeKey,'L',gL.endX,gL.endY);
    }else{
      // show a starter tip for empty left branch
      addTip(activeKey,'L',m.endX-20,m.endY-20);
    }
    if(L.itemsRight.length){
      const rightFt = sumFt(L.itemsRight), rightPx = (rightFt/50)*PX_PER_50FT;
      const gR = branchGeom('R', m.endX, m.endY, rightPx);
      const shR = document.createElementNS('http://www.w3.org/2000/svg','path');
      shR.setAttribute('class','hoseMain shadow'); shR.setAttribute('stroke-width','9'); shR.setAttribute('d', gR.d);
      const pR = document.createElementNS('http://www.w3.org/2000/svg','path');
      pR.setAttribute('class', `hoseMain ${hoseClassFromItems(L.itemsRight)}`); pR.setAttribute('d', gR.d);
      G_branches.appendChild(shR); G_branches.appendChild(pR);
      addTip(activeKey,'R',gR.endX,gR.endY);
    }else{
      addTip(activeKey,'R',m.endX+20,m.endY-20);
    }
  }

  // info banner
  topInfo.textContent = L.hasWye ? `${L.label}: Split (L/R tips adjustable)` : `${L.label}: Single line`;
}

/* Add a + tip button at x,y */
function addTip(key, where, x, y){
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','hose-end'); g.setAttribute('data-line',key); g.setAttribute('data-where',where);
  const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
  c.setAttribute('class','plus-circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',14);
  const v = document.createElementNS('http://www.w3.org/2000/svg','line');
  v.setAttribute('class','plus-sign'); v.setAttribute('x1',x); v.setAttribute('y1',y-6); v.setAttribute('x2',x); v.setAttribute('y2',y+6);
  const h = document.createElementNS('http://www.w3.org/2000/svg','line');
  h.setAttribute('class','plus-sign'); h.setAttribute('x1',x-6); h.setAttribute('y1',y); h.setAttribute('x2',x+6); h.setAttribute('y2',y);
  g.appendChild(c); g.appendChild(v); g.appendChild(h);
  G_tips.appendChild(g);
}

/* Picker positioning + flow */
function showPicker(key, where, cx, cy){
  plusContext = { key, where };
  const L = lines[key];
  pickerTitle.textContent = where==='main' ? `${L.label} ‚Äî Main` : `${L.label} ‚Äî ${where==='L'?'Left':'Right'}`;

  picker.style.display='block'; picker.setAttribute('aria-hidden','false');
  pickHome.style.display='block'; pickAdd.style.display='none'; pickNoz.style.display='none'; pickAcc.style.display='none'; pickCfg.style.display='none';

  const stg = document.getElementById('stage').getBoundingClientRect();
  const pw = 260, ph = 230;
  let x = cx - stg.left + 8, y = cy - stg.top - ph - 8;
  if(y < 8) y = cy - stg.top + 8;
  x = Math.max(8, Math.min(x, stg.width - pw - 8));
  y = Math.max(8, Math.min(y, stg.height - ph - 8));
  picker.style.left = `${x}px`; picker.style.top = `${y}px`;
}
function hidePicker(){ picker.style.display='none'; picker.setAttribute('aria-hidden','true'); }

/* Click on tip to open menu */
overlay.addEventListener('click', (e)=>{
  const tip = e.target.closest('.hose-end'); if(!tip || !activeKey) return;
  const key = tip.getAttribute('data-line'); const where = tip.getAttribute('data-where');
  const circ = tip.querySelector('.plus-circle'); const ov = overlay.getBoundingClientRect();
  const px = parseFloat(circ.getAttribute('cx')), py = parseFloat(circ.getAttribute('cy'));
  const clientX = ov.left + (px/VIEW_W)*ov.width, clientY = ov.top + py; // good enough for meet
  showPicker(key, where, clientX, clientY);
});
document.addEventListener('click', (e)=>{
  if(picker.contains(e.target)) return;
  if(e.target.closest('.hose-end')) return;
  hidePicker();
});

/* Picker nav */
picker.addEventListener('click', (e)=>{
  if(e.target.dataset.view==='addhose'){ pickHome.style.display='none'; pickAdd.style.display='block'; }
  if(e.target.dataset.view==='nozzle'){ pickHome.style.display='none'; pickNoz.style.display='block'; }
  if(e.target.dataset.view==='accessory'){ pickHome.style.display='none'; pickAcc.style.display='block'; }
  if(e.target.dataset.view==='config'){ pickHome.style.display='none'; pickCfg.style.display='block'; }
  if(e.target.hasAttribute('data-back')){ pickHome.style.display='block'; pickAdd.style.display='none'; pickNoz.style.display='none'; pickAcc.style.display='none'; pickCfg.style.display='none'; }
});

/* Picker actions */
document.getElementById('pickAdd').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-addlen]'); if(!btn) return;
  const len = parseInt(btn.dataset.addlen,10);
  const size = btn.dataset.size;
  const L = lines[plusContext.key];
  if(plusContext.where==='L'){ L.itemsLeft.push({size:size || (L.itemsLeft[0]?.size||'1.75'), lengthFt:len}); }
  else if(plusContext.where==='R'){ L.itemsRight.push({size:size || (L.itemsRight[0]?.size||'1.75'), lengthFt:len}); }
  else { L.itemsMain.push({size:size || (L.itemsMain[0]?.size||'1.75'), lengthFt:len}); }
  drawActive(); hidePicker();
});

document.getElementById('pickNoz').addEventListener('click', (e)=>{
  const id = e.target.closest('.pick')?.dataset.noz; if(!id) return;
  const L = lines[plusContext.key];
  if(plusContext.where==='L'){ L.nozLeft = NOZ[id]; }
  else { L.nozRight = NOZ[id]; } // right for single-line as well
  drawActive(); hidePicker();
});

document.getElementById('pickAcc').addEventListener('click', (e)=>{
  const acc = e.target.closest('.pick')?.dataset.acc; if(!acc) return;
  const L = lines[plusContext.key];
  if(acc==='wye'){ L.hasWye = true; }
  if(acc==='removeWye'){ L.hasWye = false; L.itemsLeft=[]; L.itemsRight=[]; }
  drawActive(); hidePicker();
});

document.getElementById('pickCfg').addEventListener('click', (e)=>{
  const L = lines[plusContext.key];
  if(e.target.hasAttribute('data-size-set')){
    const sz=e.target.getAttribute('data-size-set');
    if(plusContext.where==='L' && L.itemsLeft.length) L.itemsLeft[0].size=sz;
    else if(plusContext.where==='R' && L.itemsRight.length) L.itemsRight[0].size=sz;
    else if(L.itemsMain.length) L.itemsMain[0].size=sz;
  }
  if(e.target.hasAttribute('data-len-set')){
    const ft=parseInt(e.target.getAttribute('data-len-set'),10);
    if(plusContext.where==='L'){ L.itemsLeft=[{size:L.itemsLeft[0]?.size||'1.75', lengthFt:ft}]; }
    else if(plusContext.where==='R'){ L.itemsRight=[{size:L.itemsRight[0]?.size||'1.75', lengthFt:ft}]; }
    else { L.itemsMain=[{size:L.itemsMain[0]?.size||'1.75', lengthFt:ft}]; }
  }
  if(e.target.hasAttribute('data-reset')){
    const def = plusContext.key==='back'
      ? {size:'2.5', len:250, noz:NOZ.sb265}
      : {size:'1.75', len:200, noz:NOZ.smooth185};
    L.itemsMain=[{size:def.size,lengthFt:def.len}];
    L.hasWye=false; L.itemsLeft=[]; L.itemsRight=[]; L.nozLeft=def.noz; L.nozRight=def.noz;
  }
  drawActive(); hidePicker();
});

/* Hose buttons: show/hide one at a time */
lineBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    const key=b.dataset.line;
    if(activeKey===key){ activeKey=null; b.classList.remove('active'); drawActive(); return; }
    activeKey=key;
    lineBtns.forEach(x=>x.classList.toggle('active', x===b));
    drawActive();
  });
});

/* KPIs (simple overall readout for active hose) */
function refreshKPI(){
  if(!activeKey){
    document.getElementById('GPM').textContent='‚Äî gpm';
    document.getElementById('PDP').textContent='‚Äî psi';
    document.getElementById('breakdown').textContent='';
    return;
  }
  const L = lines[activeKey];
  const gpm = L.hasWye ? (L.nozLeft?.gpm||0) + (L.nozRight?.gpm||0) : (L.nozRight?.gpm||0);
  const mainFL = sumFt(L.itemsMain) ? FL(gpm, L.itemsMain[0].size, sumFt(L.itemsMain)) : 0;
  const leftFL = L.hasWye ? FL(L.nozLeft?.gpm||0, L.itemsLeft[0]?.size||'1.75', sumFt(L.itemsLeft)) : 0;
  const rightFL= FL(L.nozRight?.gpm||0, L.itemsRight[0]?.size||L.itemsMain[0]?.size||'1.75', sumFt(L.itemsRight));
  const branchMax = L.hasWye ? Math.max(leftFL + (L.nozLeft?.NP||0), rightFL + (L.nozRight?.NP||0)) : (L.nozRight?.NP||0);
  const PDP = branchMax + mainFL + (L.hasWye ? L.wyeLoss:0) + elevFt*elevPsiPerFt;

  document.getElementById('GPM').textContent = `${gpm} gpm`;
  document.getElementById('PDP').textContent = `${PDP.toFixed(1)} psi`;
  document.getElementById('breakdown').textContent =
    (L.hasWye
      ? `max(L/R) ${branchMax.toFixed(1)} + Main ${mainFL.toFixed(1)} + Wye ${L.wyeLoss} + Elev ${(elevFt*elevPsiPerFt).toFixed(1)}`
      : `Nozzle ${(L.nozRight?.NP||0)} + Main ${mainFL.toFixed(1)} + Elev ${(elevFt*elevPsiPerFt).toFixed(1)}`);
}
setInterval(refreshKPI, 250);

/* Inputs */
document.getElementById('elevFt').addEventListener('input', e=>{ elevFt=Number(e.target.value||0); });
document.getElementById('elevPsi').addEventListener('input', e=>{ elevPsiPerFt=Number(e.target.value||0.434); });

/* Init */
drawActive();
</script>
</body>
</html>
