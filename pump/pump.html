<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>FireOps SIM ‚Äî Visual Pump Builder</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1624; --ink:#eaf2ff; --muted:#9fb0c8; --edge:rgba(255,255,255,.14);
    --hose5:#ecd464;      /* 5" */
    --hose25:#6ecbff;     /* 2¬Ω" = blue */
    --hose175:#ff6b6b;    /* 1¬æ" */
    --bubble:#172134; --bubble-edge:rgba(255,255,255,.15);
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;min-height:100vh}

  /* Header */
  header{position:sticky;top:0;z-index:5;padding:10px 14px;background:linear-gradient(180deg,#0c1320,#0b0f14);border-bottom:1px solid var(--edge)}
  .title{font-weight:700}
  .sub{font-size:12px;color:#9fb0c8}

  /* Stage (phone-first) */
  .wrapper{border-top:1px solid var(--edge);border-bottom:1px solid var(--edge);background:linear-gradient(180deg,#0b0f14,#0e1726)}
  .stage{position:relative;width:100%;height:clamp(240px, 50vh, 380px);max-width:820px;margin:0 auto}
  /* keep the truck and hoses inside one SVG coordinate space for perfect alignment on phones */
  #overlay{position:absolute;inset:0;width:100%;height:100%;display:block}
  .info{position:absolute;left:50%;top:8px;transform:translateX(-50%);background:var(--bubble);border:1px solid var(--bubble-edge);border-radius:999px;padding:8px 12px;font-size:12px}

  /* KPI panel */
  .panel{padding:10px 12px;background:var(--panel)}
  .card{background:#0e1726;border:1px solid var(--edge);border-radius:14px;padding:12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;color:#9fb0c8;display:block;margin-bottom:4px}
  input{background:#0b1320;color:#eaf2ff;border:1px solid var(--edge);border-radius:10px;padding:10px 12px;font-size:16px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:#0b1320;border:1px solid var(--edge);border-radius:12px;padding:10px 12px;font-size:13px;color:#cfe4ff}
  .kpi b{font-size:18px}

  /* Hoses (SVG) */
  .hoseMain{fill:none;stroke-linecap:round;stroke-linejoin:round}
  .hose5{stroke:var(--hose5);stroke-width:12}
  .hose25{stroke:var(--hose25);stroke-width:9}
  .hose175{stroke:var(--hose175);stroke-width:6}

  /* ‚Äú+‚Äù at hose tips */
  .hose-end{cursor:pointer}
  .plus-circle{fill:#fff; stroke:#111; stroke-width:1.5; filter:drop-shadow(0 2px 4px rgba(0,0,0,.45))}
  .plus-sign{stroke:#111; stroke-width:3; stroke-linecap:round}

  /* Tip menu */
  .picker{position:absolute;background:#0b1320;border:1px solid var(--bubble-edge);border-radius:12px;min-width:240px;padding:8px;z-index:7;
          box-shadow:0 18px 40px rgba(0,0,0,.45);display:none}
  .picker h3{font-size:12px;color:#cfe4ff;margin:4px 8px 8px}
  .section-title{font-size:11px;color:#9fb0c8;margin:4px 8px 6px}
  .picker-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:4px 6px 8px}
  .pick{display:flex;align-items:center;gap:8px;background:#0b1a29;border:1px solid #1f3a57;border-radius:10px;padding:10px;cursor:pointer}
  .pick:hover{background:#0e2337}
  .picker-actions{display:flex;gap:6px;flex-wrap:wrap;padding:6px 8px 10px}
  .pick-small{font-size:12px;padding:8px 10px;border-radius:10px;background:#0b1a29;border:1px solid #1f3a57;cursor:pointer}
  .pick-small:hover{background:#0e2337}

  /* Builder list (quick readout) */
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid var(--edge);border-radius:12px;background:#0c1320;flex-wrap:wrap}
  .note{font-size:12px;color:#9fb0c8}
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="title">FireOps SIM ‚Äî Visual Pump Builder</div>
    <div class="sub">Tap the <b>+</b> at the end of any hose to add hose, change nozzle, add an accessory, or change config.</div>
  </header>

  <!-- Stage: truck + hoses inside one responsive SVG -->
  <section class="wrapper">
    <div class="stage" id="stage">
      <svg id="overlay" viewBox="0 0 390 260" preserveAspectRatio="xMidYMax meet" aria-label="Visual stage">
        <!-- Truck bitmap placed inside same coordinate space -->
        <image href="https://fireopssim.com/pump/engine181.png" x="0" y="0" width="390" height="260" preserveAspectRatio="xMidYMax meet"></image>

        <!-- Hose groups -->
        <g id="hoses"></g>
        <g id="labels"></g>
      </svg>

      <div class="info" id="topInfo">Line details appear here</div>

      <!-- Tip action menu -->
      <div id="picker" class="picker" role="dialog" aria-modal="true" aria-hidden="true">
        <h3 id="pickerTitle">Line</h3>

        <div id="pickHome">
          <div class="section-title">Choose an action</div>
          <div class="picker-grid">
            <div class="pick" data-view="addhose">‚ûï Add Hose</div>
            <div class="pick" data-view="nozzle">üß© Nozzle</div>
            <div class="pick" data-view="accessory">‚öôÔ∏è Accessory</div>
            <div class="pick" data-view="config">üõ†Ô∏è Change Config</div>
          </div>
        </div>

        <div id="pickAdd" style="display:none">
          <div class="section-title">Add hose</div>
          <div class="picker-actions">
            <button class="pick-small" data-addlen="50" data-size="1.75">+50‚Ä≤ 1¬æ‚Ä≥</button>
            <button class="pick-small" data-addlen="50" data-size="2.5">+50‚Ä≤ 2¬Ω‚Ä≥</button>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickNoz" style="display:none">
          <div class="section-title">Set nozzle</div>
          <div class="picker-grid">
            <div class="pick" data-noz="smooth185">Smooth Bore 185 @50</div>
            <div class="pick" data-noz="fog150_75">Fog 150 @75</div>
            <div class="pick" data-noz="fog150_100">Fog 150 @100</div>
            <div class="pick" data-noz="sb265">SB 1 1/8‚Ä≥ 265 @50</div>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickAcc" style="display:none">
          <div class="section-title">Accessory</div>
          <div class="picker-grid">
            <div class="pick" data-acc="wye">Wye (+10)</div>
            <div class="pick" data-acc="standpipe">Standpipe (+25)</div>
            <div class="pick" data-acc="flowmeter">Inline Flowmeter (+0)</div>
            <div class="pick" data-acc="cap">Cap</div>
          </div>
          <div class="picker-actions"><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>

        <div id="pickCfg" style="display:none">
          <div class="section-title">Quick set</div>
          <div class="picker-actions">
            <button class="pick-small" data-size-set="1.75">1¬æ‚Ä≥</button>
            <button class="pick-small" data-size-set="2.5">2¬Ω‚Ä≥</button>
            <button class="pick-small" data-len-set="200">200‚Ä≤</button>
            <button class="pick-small" data-len-set="250">250‚Ä≤</button>
          </div>
          <div class="picker-actions"><button class="pick-small" data-reset>Reset defaults</button><button class="pick-small" data-back>‚¨Ö Back</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Readout -->
  <section class="panel">
    <div class="card">
      <div class="grid2">
        <div><label>Elevation (ft)</label><input id="elevFt" type="number" value="0"></div>
        <div><label>Elevation PSI/ft</label><input id="elevPsi" type="number" step="0.001" value="0.434"></div>
      </div>
    </div>
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div>Flow</div><b id="GPM">‚Äî gpm</b></div>
        <div class="kpi"><div>PDP</div><b id="PDP">‚Äî psi</b></div>
      </div>
      <div class="note" id="breakdown" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px;font-size:14px;color:#cfe4ff">Build List</h3>
      <div class="list" id="buildList"></div>
    </div>
  </section>

</div>

<script>
/* ========================
   Visual/Calc core
   (based on your one-file version, simplified)
   ======================== */

const VIEW_W = 390, VIEW_H = 260;
const PX_PER_50FT = 45;
const PUMP_ANCHOR = { x: 0.515, y: 0.74 }; // percent inside SVG (mid pump panel)

const COEFF = { "1.75":15.5, "2.5":2, "5":0.08 };
const NOZ = {
  smooth185:{name:'Smooth 185 @50', gpm:185, NP:50},
  fog150_75:{name:'Fog 150 @75', gpm:150, NP:75},
  fog150_100:{name:'Fog 150 @100', gpm:150, NP:100},
  sb265:{name:'SB 1 1/8‚Ä≥ 265 @50', gpm:265, NP:50}
};
const DEFAULTS = {
  left:  { label:'Line 1', size:'1.75', lengthFt:200, nozzle: NOZ.smooth185, accessories:[] },
  right: { label:'Line 2', size:'1.75', lengthFt:200, nozzle: NOZ.smooth185, accessories:[] },
  back:  { label:'Line 3', size:'2.5',  lengthFt:250, nozzle: NOZ.sb265,    accessories:[] }
};

const hosesG = document.getElementById('hoses');
const labelsG = document.getElementById('labels');
const overlay = document.getElementById('overlay');
const topInfo = document.getElementById('topInfo');
const picker  = document.getElementById('picker');
const pickerTitle = document.getElementById('pickerTitle');
const pickHome = document.getElementById('pickHome');
const pickAdd  = document.getElementById('pickAdd');
const pickNoz  = document.getElementById('pickNoz');
const pickAcc  = document.getElementById('pickAcc');
const pickCfg  = document.getElementById('pickCfg');
const buildList = document.getElementById('buildList');

let elevFt = 0, elevPsiPerFt = 0.434;

const state = {
  hoses: [
    { id: crypto.randomUUID(), pos:'left',  ...structuredClone(DEFAULTS.left)  },
    { id: crypto.randomUUID(), pos:'right', ...structuredClone(DEFAULTS.right) },
    { id: crypto.randomUUID(), pos:'back',  ...structuredClone(DEFAULTS.back)  }
  ]
};
let pickerFor = null;

function clsFor(size){ return size==='5'?'hose5':(size==='2.5'?'hose25':'hose175'); }
function FL(gpm, size, ft){ const C=COEFF[size]||0, Q=gpm/100; return C*(Q*Q)*(ft/100); }

/* Geometry: start at pump, run up with a soft curve, fan left/right/back */
function geomFor(h){
  const startX = VIEW_W * PUMP_ANCHOR.x;
  const startY = VIEW_H * PUMP_ANCHOR.y;
  const totalPx = (h.lengthFt/50)*PX_PER_50FT;
  let endX = startX, f = 110;
  if(h.pos==='left')  endX = startX - f;
  if(h.pos==='right') endX = startX + f;
  if(h.pos==='back')  endX = startX;
  const endY = Math.max(12, startY - totalPx);
  const cx = (startX + endX)/2 + (h.pos==='left'?-36:h.pos==='right'?36:0);
  const cy = startY - (startY - endY)*0.48;
  return {
    d:`M ${startX},${startY} Q ${cx},${cy} ${endX},${endY}`,
    end:{x:endX, y:endY}
  };
}

/* Draw */
function clear(g){ while(g.firstChild) g.removeChild(g.firstChild); }
function draw(){
  clear(hosesG); clear(labelsG);

  state.hoses.forEach(h=>{
    const g = geomFor(h);

    const sh = document.createElementNS('http://www.w3.org/2000/svg','path');
    sh.setAttribute('d', g.d); sh.setAttribute('stroke','rgba(0,0,0,.35)'); sh.setAttribute('stroke-width','12'); sh.setAttribute('fill','none');

    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d', g.d); p.setAttribute('class', `hoseMain ${clsFor(h.size)}`);

    const end = document.createElementNS('http://www.w3.org/2000/svg','g');
    end.setAttribute('class','hose-end'); end.setAttribute('data-hid', h.id);
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('class','plus-circle'); c.setAttribute('cx', g.end.x); c.setAttribute('cy', g.end.y); c.setAttribute('r', 14);
    const v = document.createElementNS('http://www.w3.org/2000/svg','line');
    v.setAttribute('class','plus-sign'); v.setAttribute('x1', g.end.x); v.setAttribute('y1', g.end.y-6); v.setAttribute('x2', g.end.x); v.setAttribute('y2', g.end.y+6);
    const hl = document.createElementNS('http://www.w3.org/2000/svg','line');
    hl.setAttribute('class','plus-sign'); hl.setAttribute('x1', g.end.x-6); hl.setAttribute('y1', g.end.y); hl.setAttribute('x2', g.end.x+6); hl.setAttribute('y2', g.end.y);
    end.appendChild(c); end.appendChild(v); end.appendChild(hl);

    hosesG.appendChild(sh); hosesG.appendChild(p); hosesG.appendChild(end);

    // tip label
    const sizePretty = h.size==='2.5'?'2¬Ω‚Ä≥':(h.size==='1.75'?'1¬æ‚Ä≥':`${h.size}‚Ä≥`);
    const tipTxt = `${h.label} ‚Ä¢ ${sizePretty} ‚Ä¢ ${h.lengthFt}‚Ä≤ ‚Ä¢ ${h.nozzle.gpm} gpm`;
    const pad=6, estW=Math.max(120, tipTxt.length*6.2), x=g.end.x - estW/2 - pad, y=g.end.y - 36;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', estW+pad*2); rect.setAttribute('height', 18+pad*2);
    rect.setAttribute('rx', 8); rect.setAttribute('fill','#172134'); rect.setAttribute('stroke','rgba(255,255,255,.15)');
    const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('x', x+pad); tx.setAttribute('y', y+pad+13); tx.setAttribute('fill','#cfe4ff'); tx.setAttribute('font-size','10'); tx.textContent = tipTxt;
    labelsG.appendChild(rect); labelsG.appendChild(tx);
  });
}

/* Info + math */
function refreshInfo(){
  const Q = state.hoses.reduce((s,h)=>s + (h.nozzle.gpm||0), 0);
  const mainFL = state.hoses.reduce((s,h)=> s + FL(h.nozzle.gpm||0, h.size, h.lengthFt||0), 0);
  const elev = elevFt * elevPsiPerFt;
  const PDP = mainFL + elev + state.hoses.reduce((s,h)=>s + (h.nozzle.NP||0), 0);

  document.getElementById('GPM').textContent = `${Q} gpm`;
  document.getElementById('PDP').textContent = `${Math.round(PDP)} psi`;
  document.getElementById('breakdown').textContent = `Œ£ Nozzle NP + Œ£ FL + Elev (${elev.toFixed(1)}) = ${Math.round(PDP)} psi`;

  // Banner shows selected hose info (if any)
  if(pickerFor){
    const h = state.hoses.find(x=>x.id===pickerFor);
    if(h){
      const sizePretty = h.size==='2.5'?'2¬Ω‚Ä≥':(h.size==='1.75'?'1¬æ‚Ä≥':`${h.size}‚Ä≥`);
      const fl = FL(h.nozzle.gpm||0, h.size, h.lengthFt||0).toFixed(1);
      topInfo.textContent = `${h.label}: ${sizePretty} ‚Ä¢ ${h.lengthFt}‚Ä≤ ‚Ä¢ ${h.nozzle.gpm} gpm ‚Ä¢ NP ${h.nozzle.NP} ‚Ä¢ FL ${fl}`;
    }
  } else {
    topInfo.textContent = `All lines active ‚Ä¢ Tap ‚Äú+‚Äù at any hose tip`;
  }
}

/* Builder list */
function renderBuildList(){
  buildList.innerHTML = '';
  state.hoses.forEach(h=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div><b>${h.label}</b> <span class="note">${h.size==='2.5'?'2¬Ω‚Ä≥':(h.size==='1.75'?'1¬æ‚Ä≥':h.size+'‚Ä≥')} ‚Ä¢ ${h.lengthFt}‚Ä≤ ‚Ä¢ ${h.nozzle.name}</span></div>
                     <div class="note">${(FL(h.nozzle.gpm||0,h.size,h.lengthFt||0)).toFixed(1)} psi FL</div>`;
    buildList.appendChild(div);
  });
}

/* Picker helpers */
function showPicker(forId, clientX, clientY){
  pickerFor = forId;
  const h = state.hoses.find(x=>x.id===forId);
  if(!h) return;
  pickerTitle.textContent = h.label;
  picker.style.display='block'; picker.setAttribute('aria-hidden','false');
  pickHome.style.display='block'; pickAdd.style.display='none'; pickNoz.style.display='none'; pickAcc.style.display='none'; pickCfg.style.display='none';

  const stg = document.getElementById('stage').getBoundingClientRect();
  const pw = picker.offsetWidth || 260, ph = picker.offsetHeight || 220;
  let x = clientX - stg.left + 8, y = clientY - stg.top - ph - 8;
  if(y < 8) y = clientY - stg.top + 8;
  x = Math.max(8, Math.min(x, stg.width - pw - 8));
  y = Math.max(8, Math.min(y, stg.height - ph - 8));
  picker.style.left = `${x}px`; picker.style.top = `${y}px`;

  refreshInfo();
}
function hidePicker(){ picker.style.display='none'; picker.setAttribute('aria-hidden','true'); pickerFor=null; refreshInfo(); }

picker.addEventListener('click', e=>{
  if(e.target.dataset.view==='addhose'){ pickHome.style.display='none'; pickAdd.style.display='block'; }
  if(e.target.dataset.view==='nozzle'){ pickHome.style.display='none'; pickNoz.style.display='block'; }
  if(e.target.dataset.view==='accessory'){ pickHome.style.display='none'; pickAcc.style.display='block'; }
  if(e.target.dataset.view==='config'){ pickHome.style.display='none'; pickCfg.style.display='block'; }
  if(e.target.hasAttribute('data-back')){ pickHome.style.display='block'; pickAdd.style.display='none'; pickNoz.style.display='none'; pickAcc.style.display='none'; pickCfg.style.display='none'; }
});

/* Picker actions */
document.getElementById('pickAdd').addEventListener('click', e=>{
  const b = e.target.closest('[data-addlen]'); if(!b) return;
  const len = parseInt(b.dataset.addlen,10); const sz = b.dataset.size;
  const h = state.hoses.find(x=>x.id===pickerFor); if(!h) return;
  h.lengthFt += len; if(sz) h.size = sz;
  redraw(); hidePicker();
});
document.getElementById('pickNoz').addEventListener('click', e=>{
  const id = e.target.closest('.pick')?.dataset.noz; if(!id) return;
  const h = state.hoses.find(x=>x.id===pickerFor); if(!h) return;
  h.nozzle = NOZ[id] || h.nozzle;
  redraw(); hidePicker();
});
document.getElementById('pickAcc').addEventListener('click', e=>{
  const id = e.target.closest('.pick')?.dataset.acc; if(!id) return;
  const h = state.hoses.find(x=>x.id===pickerFor); if(!h) return;
  // accessories stored but not drawn (placeholder for future visuals)
  h.accessories = h.accessories || []; h.accessories.push(id);
  redraw(); hidePicker();
});
document.getElementById('pickCfg').addEventListener('click', e=>{
  const sizeSet = e.target.getAttribute('data-size-set');
  const lenSet  = e.target.getAttribute('data-len-set');
  const reset   = e.target.hasAttribute('data-reset');
  const h = state.hoses.find(x=>x.id===pickerFor); if(!h) return;
  if(sizeSet){ h.size=sizeSet; redraw(); hidePicker(); return; }
  if(lenSet){ h.lengthFt=parseInt(lenSet,10); redraw(); hidePicker(); return; }
  if(reset){
    const def = DEFAULTS[h.pos]; Object.assign(h, structuredClone(def));
    redraw(); hidePicker(); return;
  }
});

/* Click on + (hose tip) */
overlay.addEventListener('click', e=>{
  const tip = e.target.closest('.hose-end'); if(!tip) return;
  const id = tip.getAttribute('data-hid');
  const circ = tip.querySelector('.plus-circle'); const ov = overlay.getBoundingClientRect();
  const cx = parseFloat(circ.getAttribute('cx')), cy = parseFloat(circ.getAttribute('cy'));
  const clientX = ov.left + (cx/VIEW_W)*ov.width, clientY = ov.top + cy;
  showPicker(id, clientX, clientY);
});
document.addEventListener('click', e=>{
  if(picker.contains(e.target)) return;
  if(e.target.closest('.hose-end')) return;
  hidePicker();
});

/* Inputs */
document.getElementById('elevFt').addEventListener('input', e=>{ elevFt = Number(e.target.value||0); refreshInfo(); });
document.getElementById('elevPsi').addEventListener('input', e=>{ elevPsiPerFt = Number(e.target.value||0.434); refreshInfo(); });

/* Redraw pipeline */
function redraw(){ draw(); renderBuildList(); refreshInfo(); }

/* Init */
function init(){ redraw(); }
init();
</script>
</body>
</html>
