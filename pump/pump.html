<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pump Pressure â€” Visual Builder</title>
  <meta name="theme-color" content="#0b0f14" />

  <!-- Primary CSS (same-folder) with cache-bust -->
  <link rel="preload" as="style" href="pump-style.css?v=4">
  <link rel="stylesheet" href="pump-style.css?v=4" id="pumpCSS">

  <script>
    // Ensure CSS is loaded, try alternates, or inject inline fallback
    (function(){
      const loadedOk = () => {
        try {
          const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg');
          return !!bg && bg.trim().length > 0;
        } catch(e){ return false; }
      };

      function tryLoad(href){
        return new Promise((resolve, reject)=>{
          const l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = href;
          l.onload = () => resolve(true);
          l.onerror = () => reject();
          document.head.appendChild(l);
        });
      }

      async function ensureCSS(){
        setTimeout(async () => {
          if (loadedOk()) return;

          const candidates = [
            './pump-style.css?v=4',
            '/pump/pump-style.css?v=4',
            '/assets/css/pump-style.css?v=4'
          ];

          for (const href of candidates) {
            try { await tryLoad(href); if (loadedOk()) return; } catch(e){}
          }

          // Inline fallback
          const style = document.createElement('style');
          style.textContent = `
            :root{--bg:#0b0f14;--ink:#eaf2ff;--edge:rgba(255,255,255,.14);}
            html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
            .linebar{position:absolute;left:0;right:0;bottom:8px;display:flex;justify-content:center;gap:10px;z-index:6}
            .linebtn{background:#0b1320;border:1px solid var(--edge);color:#eaf2ff;border-radius:12px;padding:12px 16px;font-size:16px}
            .hose5,.hose25,.hose175{fill:none;stroke-linecap:round;stroke-linejoin:round}
            .hose5{stroke:#ecd464;stroke-width:12}
            .hose25{stroke:#6ecbff;stroke-width:9}
            .hose175{stroke:#ff6b6b;stroke-width:6}
          `;
          document.head.appendChild(style);
          console.warn('pump-style.css not found via normal paths. Using inline fallback.');
        }, 0);
      }
      ensureCSS();
    })();
  </script>
</head>
<body>
  <div class="app">

    <!-- ===== Branded Header ===== -->
    <header class="brandbar">
      <div class="brand-left">
        <img class="brand-logo" src="https://fireopssim.com/pump/fireops-badge.svg" alt=""
          onerror="this.outerHTML='<div class=&quot;brand-logo-fallback&quot;>ðŸ”¥</div>'">
        <div class="brand-text">
          <div class="brand-title">FireOps SIM</div>
          <div class="brand-sub">Pump Pressure â€” Visual Builder</div>
        </div>
      </div>
      <nav class="brand-right">
        <a class="brand-link" href="/" aria-label="Home">Home</a>
        <a class="brand-link" href="/visual-pump" aria-label="Visual Pump Calculator">Visual Pump</a>
      </nav>
    </header>

    <!-- ===== Floating action buttons (drawer toggles) ===== -->
    <div class="side">
      <button class="fab" id="openHose" title="Hose">H</button>
      <button class="fab" id="openAcc" title="Accessories">A</button>
      <button class="fab" id="openNoz" title="Nozzles">N</button>
    </div>

    <!-- ===== Drawer ===== -->
    <aside class="drawer" id="drawer" aria-hidden="true">
      <h3 id="drawerTitle">Hose</h3>

      <div class="row" id="hoseButtonsMain">
        <button data-hose='{"size":"5","lengthFt":100}'>5â€³ 100â€²</button>
        <button data-hose='{"size":"2.5","lengthFt":50}'>2Â½â€³ 50â€²</button>
        <button data-hose='{"size":"1.75","lengthFt":100}'>1Â¾â€³ 100â€²</button>
        <button data-hose='{"size":"1.75","lengthFt":50}'>1Â¾â€³ 50â€²</button>
        <button data-act="clearHose">Clear main hoses</button>
      </div>

      <div class="row" id="hoseButtonsSplit" style="display:none;border-top:1px solid var(--edge);margin-top:6px;padding-top:12px">
        <div class="drawer-note">After Wye (active line):</div>
        <button data-side="L" data-hose='{"size":"2.5","lengthFt":50}'>Left 2Â½â€³ 50â€²</button>
        <button data-side="L" data-hose='{"size":"1.75","lengthFt":100}'>Left 1Â¾â€³ 100â€²</button>
        <button data-side="L" data-hose='{"size":"1.75","lengthFt":50}'>Left 1Â¾â€³ 50â€²</button>
        <button data-side="R" data-hose='{"size":"2.5","lengthFt":50}'>Right 2Â½â€³ 50â€²</button>
        <button data-side="R" data-hose='{"size":"1.75","lengthFt":100}'>Right 1Â¾â€³ 100â€²</button>
        <button data-side="R" data-hose='{"size":"1.75","lengthFt":50}'>Right 1Â¾â€³ 50â€²</button>
        <button data-act="clearSplit">Clear after-wye</button>
      </div>

      <div class="row" id="accButtons" style="display:none">
        <button data-acc='{"name":"Wye","loss":10}'>Add Wye</button>
        <button data-acc='{"name":"Appliance","loss":10}'>+10 Appliance</button>
        <button data-acc='{"name":"Master Stream","loss":25}'>+25 Master</button>
        <button data-acc='{"name":"Siamesed","loss":10}'>+10 Siamese</button>
        <button data-act="clearAcc">Clear accessories</button>
      </div>

      <div class="row" id="nozButtons" style="display:none">
        <div class="row" id="nozRowLeft"><h3>Left Branch Nozzle</h3></div>
        <div class="row" id="nozRowRight" style="border-top:1px solid var(--edge);padding-top:10px"><h3>Right/Single Nozzle</h3></div>
      </div>
    </aside>

    <!-- ===== Stage ===== -->
    <div class="wrapper">
      <div id="scroll" class="scroll">
        <div id="stage" class="stage">
          <img id="engine" alt="ENGINE 181" src="https://fireopssim.com/pump/engine181.png" />

          <svg id="overlay" viewBox="0 0 390 800" preserveAspectRatio="none" aria-label="Diagram overlay">
            <defs>
              <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                <path d="M0,0 L6,3 L0,6 z" fill="#cfe4ff"></path>
              </marker>
            </defs>
            <g id="hoses"></g>
            <g id="branches"></g>
            <text id="hint" x="12" y="24" class="hint">Tap a line below to deployâ€¦</text>
          </svg>

          <div id="lineinfo" class="lineinfo"></div>

          <!-- Line buttons directly under truck -->
          <div class="linebar" id="linebar">
            <button class="linebtn" data-line="left">Line 1</button>
            <button class="linebtn" data-line="right">Line 2</button>
            <button class="linebtn" data-line="back">Line 3</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== KPI Panel ===== -->
    <section class="panel">
      <div class="card">
        <div class="grid2">
          <div>
            <label>Elevation (ft)</label>
            <input id="elevFt" type="number" min="-300" max="300" value="0" />
          </div>
          <div>
            <label>Elevation PSI/ft</label>
            <input id="elevPsiPerFt" type="number" step="0.001" value="0.434" />
          </div>
        </div>

        <div class="kpis">
          <div class="kpi"><div>Total FL (Main)</div><b id="FLmain">â€” psi</b></div>
          <div class="kpi"><div>Left FL</div><b id="FLleft">â€” psi</b></div>
          <div class="kpi"><div>Right FL</div><b id="FLright">â€” psi</b></div>
          <div class="kpi"><div>Accessories</div><b id="ACC">â€” psi</b></div>
          <div class="kpi"><div>Nozzle</div><b id="NP">â€” psi</b></div>
        </div>

        <div class="eq" id="equation">PDP (active line) = max(Left, Right) + Main FL + Acc Â± Elev</div>
        <div class="kpis" style="margin-top:8px">
          <div class="kpi"><div>Flow</div><b id="GPM">â€” gpm</b></div>
          <div class="kpi"><div>PDP</div><b id="PDP">â€” psi</b></div>
        </div>
        <div class="note" id="breakdown" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ===== Footer ===== -->
    <footer class="brandfoot">
      <div class="foot-wrap">
        <div class="foot-badge">Part of the <a href="https://emscodesim.com" target="_blank" rel="noopener">EMSCodeSim</a> ecosystem.</div>
        <div class="foot-links">
          <a href="https://fireopssim.com" target="_blank" rel="noopener">FireOps SIM</a>
          <span>â€¢</span>
          <a href="https://dailyemsquiz.com" target="_blank" rel="noopener">DailyEMSQuiz</a>
        </div>
      </div>
    </footer>

  </div>

  <script src="pump-logic.js"></script>
</body>
</html>
